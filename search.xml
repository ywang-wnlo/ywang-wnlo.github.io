<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Hexo æ’ä»¶æ¨èä»¥åŠä½¿ç”¨å°æŠ€å·§</title>
    <url>/posts/4143201a.html</url>
    <content><![CDATA[<p><span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlvL3poLWNuLw==">Hexo<i class="fa fa-external-link-alt"></i></span>
æ˜¯ä¸€ä¸ªå¿«é€Ÿã€ç®€æ´ä¸”é«˜æ•ˆçš„åšå®¢æ¡†æ¶ï¼Œä¸ªäººåªéœ€ç”¨ Markdown
æ¥å†™æ–‡æ¡£ï¼Œå¹¶ä¸”æ‹¥æœ‰ä¸°å¯Œçš„æ’ä»¶å’Œä¸»é¢˜ã€‚å½“å‰åšå®¢å°±æ˜¯ä½¿ç”¨ Hexo é…åˆ NexT
ä¸»é¢˜æ­å»ºçš„ <span id="more"></span></p>
<p>å› ä¸ºç¬”è€…ä¸ªäººåœ¨ Windows ç¯å¢ƒä¸‹å†™åšå®¢ï¼Œåç»­å‘½ä»¤å‡ä»¥ <span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vcG93ZXJzaGVsbC9zY3JpcHRpbmcvaW5zdGFsbC9pbnN0YWxsaW5nLXBvd2Vyc2hlbGw/dmlldz1wb3dlcnNoZWxsLTcuMg==">PowerShell<i class="fa fa-external-link-alt"></i></span>
ä¸ºä¾‹</p>
<h2 id="æ’ä»¶æ¨è">æ’ä»¶æ¨è</h2>
<h3 id="hexo-deployer-git"><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2hleG9qcy9oZXhvLWRlcGxveWVyLWdpdA==">hexo-deployer-git<i class="fa fa-external-link-alt"></i></span></h3>
<p>Hexo æ”¯æŒä¸€é”®éƒ¨ç½²ç½‘ç«™åˆ° git ä»“åº“ä¸Šï¼Œå…¶ä»–çš„ä¸€é”®éƒ¨ç½²æ–¹å¼å‚è€ƒ <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlvL3poLWNuL2RvY3Mvb25lLWNvbW1hbmQtZGVwbG95bWVudA==">å®˜ç½‘ä»‹ç»<i class="fa fa-external-link-alt"></i></span></p>
<ul>
<li>å®‰è£… </li>
</ul>
<figure class="highlight ps"><table><tbody><tr><td class="code"><pre><span class="line">npm install hexo<span class="literal">-deployer-git</span> <span class="literal">--save</span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>é…ç½® </li>
</ul>
<figure class="highlight yml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">deploy:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">git</span></span><br><span class="line">  <span class="attr">repo:</span> <span class="string">&lt;ä»“åº“é“¾æ¥&gt;</span> <span class="comment"># å¯ä»¥æ˜¯ https é“¾æ¥ä¹Ÿå¯ä»¥æ˜¯ git é“¾æ¥</span></span><br><span class="line">  <span class="attr">branch:</span> [<span class="string">åˆ†æ”¯</span>] <span class="comment"># GitHub çš„ç½‘ç«™åˆ†æ”¯ä¸º gh-pagesï¼Œå…¶ä»–ç½‘ç«™å¯èƒ½æœ‰æ‰€ä¸åŒ</span></span><br><span class="line">  <span class="attr">message:</span> [<span class="string">message</span>] <span class="comment"># é»˜è®¤æ˜¯ Site updated: {{ now('YYYY-MM-DD HH:mm:ss') }}</span></span><br></pre></td></tr></tbody></table></figure>
<p>é»˜è®¤çš„æäº¤ä¿¡æ¯åªæœ‰æ—¶é—´ä¿¡æ¯ï¼Œæ²¡æœ‰è¿‡å¤šçš„å‚è€ƒä»·å€¼æ¨èä½¿ç”¨è‡ªå®šä¹‰æäº¤ä¿¡æ¯ï¼Œå…·ä½“å‚è€ƒ
<a href="#è‡ªå®šä¹‰æäº¤ä¿¡æ¯">åç»­å°èŠ‚</a></p>
<h3 id="hexo-word-counter"><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL25leHQtdGhlbWUvaGV4by13b3JkLWNvdW50ZXI=">hexo-word-counter<i class="fa fa-external-link-alt"></i></span></h3>
<p>æ˜¾ç¤ºæ¯ç¯‡æ–‡ç« çš„å­—æ•°ç»Ÿè®¡ä»¥åŠå¤§è‡´é˜…è¯»æ—¶é•¿ï¼Œéœ€è¦ä¸»é¢˜æ”¯æŒ</p>
<ul>
<li>å®‰è£… </li>
</ul>
<figure class="highlight ps"><table><tbody><tr><td class="code"><pre><span class="line">npm install hexo<span class="literal">-word-counter</span> <span class="literal">--save</span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>é…ç½® </li>
</ul>
<figure class="highlight yml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># hexo-word-counter</span></span><br><span class="line"><span class="comment">## https://github.com/next-theme/hexo-word-counter</span></span><br><span class="line"><span class="attr">symbols_count_time:</span></span><br><span class="line">  <span class="attr">symbols:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">time:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">total_symbols:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">total_time:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">exclude_codeblock:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">awl:</span> <span class="number">4</span></span><br><span class="line">  <span class="attr">wpm:</span> <span class="number">275</span></span><br><span class="line">  <span class="attr">suffix:</span> <span class="string">"mins."</span></span><br></pre></td></tr></tbody></table></figure>
<p>å…·ä½“é…ç½®å¯ä»¥å‚è€ƒå®˜æ–¹ç»™å‡ºçš„è¯´æ˜ï¼š</p>
<blockquote>
<p>Note for Chinese users: because in Chinese language average word
length about ~1.5 and if you at most cases write posts in Chinese
(without mixed English), recommended to set awl to 2 and wpm to 300. But
if you usualy mix your posts with English, awl to 4 and wpm to 275 will
be nice.</p>
</blockquote>
<p>ä¹Ÿå°±æ˜¯è¯´çº¯ä¸­æ–‡æ—¶æ¨è <code>awl</code> è®¾ä¸º 2ï¼Œ<code>wpm</code> è®¾ä¸º
300ï¼›è€Œä¸­è‹±æ–‡æ··åˆæ—¶æ¨è <code>awl</code> è®¾ä¸º 4ï¼Œ<code>wpm</code> è®¾ä¸º
275</p>
<h3 id="hexo-abbrlink"><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3JvemJvL2hleG8tYWJicmxpbms=">hexo-abbrlink<i class="fa fa-external-link-alt"></i></span></h3>
<p>Hexo
é»˜è®¤çš„æ–‡ç« é“¾æ¥æ˜¯ä»¥æ—¶é—´ä»¥åŠæ–‡ä»¶åå‘½åçš„ï¼Œå¦‚æœæ–‡ä»¶åä¸ºä¸­æ–‡æ—¶è½¬è¯‘ä¹‹åä¼šå¾ˆé•¿ï¼Œå¹¶ä¸”ä¸ç¾è§‚ã€‚è€Œè¯¥æ’ä»¶å¯ä»¥åˆ©ç”¨
hash å€¼æ›¿æ¢åŸæœ‰çš„æ–‡ç« é“¾æ¥</p>
<ul>
<li>å®‰è£… </li>
</ul>
<figure class="highlight ps"><table><tbody><tr><td class="code"><pre><span class="line">npm install hexo<span class="literal">-abbrlink</span> <span class="literal">--save</span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>é…ç½®</li>
</ul>
<p>é¦–å…ˆä¿®æ”¹ <code>_config.yml</code> æ–‡ä»¶ä¸­çš„ <code>permalink</code>
çš„é…ç½®</p>
<figure class="highlight yml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">permalink:</span> <span class="string">posts/:abbrlink.html</span></span><br></pre></td></tr></tbody></table></figure>
<p>å†å¢åŠ ä»¥ä¸‹é…ç½®</p>
<figure class="highlight yml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># abbrlink config</span></span><br><span class="line"><span class="comment">## https://github.com/rozbo/hexo-abbrlink</span></span><br><span class="line"><span class="attr">abbrlink:</span></span><br><span class="line">  <span class="attr">alg:</span> <span class="string">crc32</span> <span class="comment"># support crc16(default) and crc32</span></span><br><span class="line">  <span class="attr">rep:</span> <span class="string">hex</span> <span class="comment"># support dec(default) and hex</span></span><br><span class="line">  <span class="attr">drafts:</span> <span class="literal">true</span> <span class="comment"># (true)Process draft,(false)Do not process draft. false(default)</span></span><br><span class="line">  <span class="comment"># Generate categories from directory-tree</span></span><br><span class="line">  <span class="comment"># depth: the max_depth of directory-tree you want to generate, should &gt; 0</span></span><br><span class="line">  <span class="attr">auto_category:</span></span><br><span class="line">     <span class="attr">enable:</span> <span class="literal">true</span> <span class="comment"># true(default)</span></span><br><span class="line">     <span class="attr">depth:</span> <span class="number">3</span> <span class="comment"># 3(default)</span></span><br><span class="line">     <span class="attr">over_write:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">auto_title:</span> <span class="literal">false</span> <span class="comment"># enable auto title, it can auto fill the title by path</span></span><br><span class="line">  <span class="attr">auto_date:</span> <span class="literal">false</span> <span class="comment"># enable auto date, it can auto fill the date by time today</span></span><br><span class="line">  <span class="attr">force:</span> <span class="literal">false</span> <span class="comment"># enable force mode, in this mode, the plugin will ignore the cache, and calc the abbrlink for every post even it already had abbrlink.</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="hexo-generator-sitemap"><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2hleG9qcy9oZXhvLWdlbmVyYXRvci1zaXRlbWFw">hexo-generator-sitemap<i class="fa fa-external-link-alt"></i></span></h3>
<p>ä¸ºäº†ä½¿åšå®¢èƒ½è¢«è°·æ­Œã€bingã€ç™¾åº¦æ”¶å½•ï¼Œæœ€å¥½ç”Ÿæˆ <code>sitemap</code>
æ–¹ä¾¿çˆ¬å–ï¼Œæ•´ä½“æµç¨‹å¯ä»¥å‚è€ƒ <a href="/posts/abac0c46">è¿™ç¯‡åšæ–‡</a></p>
<ul>
<li>å®‰è£… </li>
</ul>
<figure class="highlight ps"><table><tbody><tr><td class="code"><pre><span class="line">npm install hexo<span class="literal">-generator-sitemap</span> <span class="literal">--save</span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>é…ç½® </li>
</ul>
<figure class="highlight yml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># hexo-generator-sitemap</span></span><br><span class="line"><span class="comment">## https://github.com/hexojs/hexo-generator-sitemap</span></span><br><span class="line"><span class="attr">sitemap:</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">sitemap.xml</span></span><br><span class="line">  <span class="comment"># template: ./sitemap_template.xml</span></span><br><span class="line">  <span class="attr">rel:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">tags:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">categories:</span> <span class="literal">false</span></span><br></pre></td></tr></tbody></table></figure>
<h2 id="å°æŠ€å·§">å°æŠ€å·§</h2>
<h3 id="è‡ªå®šä¹‰æäº¤ä¿¡æ¯">è‡ªå®šä¹‰æäº¤ä¿¡æ¯</h3>
<figure class="highlight ps"><table><tbody><tr><td class="code"><pre><span class="line">hexo deploy <span class="literal">-m</span> <span class="string">"è‡ªå®šä¹‰æäº¤ä¿¡æ¯"</span></span><br></pre></td></tr></tbody></table></figure>
<p>ä¾‹å¦‚ä½¿ç”¨ <code>hexo</code> ä»“åº“çš„æäº¤ä¿¡æ¯æ¥æäº¤åˆ° <code>deploy</code>
ä»“åº“</p>
<figure class="highlight ps"><table><tbody><tr><td class="code"><pre><span class="line">hexo deploy <span class="literal">-m</span> (git log <span class="literal">-1</span> <span class="literal">--pretty</span>=format:%s)</span><br></pre></td></tr></tbody></table></figure>
<p>å¦‚æœä¸­æ–‡ä¹±ç ï¼Œå¯ä»¥å‚è€ƒ <span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MzQyNjg2MC9hcnRpY2xlL2RldGFpbHMvODMzNDgyODQ=">è¿™ç¯‡åšå®¢<i class="fa fa-external-link-alt"></i></span>
ä¿®æ”¹ UTF-8 ç¼–ç </p>
<h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h2>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlvL3poLWNuL2RvY3Mvb25lLWNvbW1hbmQtZGVwbG95bWVudA==">ã€Hexoã€‘ä¸€é”®éƒ¨ç½²<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2hleG9qcy9oZXhvLWRlcGxveWVyLWdpdA==">ã€GitHubã€‘hexo-deployer-git<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL25leHQtdGhlbWUvaGV4by13b3JkLWNvdW50ZXI=">ã€GitHubã€‘hexo-word-counter<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3JvemJvL2hleG8tYWJicmxpbms=">ã€GitHubã€‘hexo-abbrlink<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2hleG9qcy9oZXhvLWdlbmVyYXRvci1zaXRlbWFw">ã€GitHubã€‘hexo-generator-sitemap<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9naXQtc2NtLmNvbS9kb2NzL2dpdC1sb2cjX3ByZXR0eV9mb3JtYXRz">ã€Gitã€‘git log
è‡ªå®šä¹‰è¾“å‡ºæ ¼å¼<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MzQyNjg2MC9hcnRpY2xlL2RldGFpbHMvODMzNDgyODQ=">ã€CSDNã€‘è§£å†³
Windows PowerShell ä¹±ç <i class="fa fa-external-link-alt"></i></span></li>
</ul>
]]></content>
      <categories>
        <category>Hexo</category>
      </categories>
      <tags>
        <tag>Hexo</tag>
        <tag>NexT</tag>
      </tags>
  </entry>
  <entry>
    <title>NexT ä¸»é¢˜çš„é…ç½®ä½¿ç”¨è®°å½•</title>
    <url>/posts/9a0b7c3b.html</url>
    <content><![CDATA[<h2 id="ç®€ä»‹">ç®€ä»‹</h2>
<p>NexT ä¸»é¢˜æ˜¯ Hexo ä¸Šä½¿ç”¨æœ€å¹¿ï¼ŒåŒæ—¶åœ¨ GitHub ä¸Šä¹Ÿæ˜¯ Star
æœ€å¤šçš„ä¸»é¢˜ï¼Œbug ä¿®å¤å’ŒåŠŸèƒ½æ›´æ–°ä¹Ÿæ¯”è¾ƒå¿«ã€‚å½“å‰åšå®¢å°±æ˜¯ä½¿ç”¨ Hexo é…åˆ NexT
ä¸»é¢˜æ­å»ºçš„ <span id="more"></span></p>
<h3 id="ç‰ˆæœ¬">ç‰ˆæœ¬</h3>
<p>åœ¨ <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL25leHQtdGhlbWUvaGV4by10aGVtZS1uZXh0L2lzc3Vlcy80">ã€å¿…è¯»ã€‘æ›´æ–°è¯´æ˜åŠå¸¸è§é—®é¢˜<i class="fa fa-external-link-alt"></i></span>
ä¸­æœ‰ç›¸å…³è¯´æ˜ï¼ŒNexT ä¸€å…±æœ‰ä¸‰ä¸ªä¸åŒçš„ä»“åº“ï¼š</p>
<table>
<colgroup>
<col style="width: 33%">
<col style="width: 33%">
<col style="width: 33%">
</colgroup>
<thead>
<tr class="header">
<th>ç‰ˆæœ¬</th>
<th>å¹´ä»½</th>
<th>ä»“åº“</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td> v5.1.4 æˆ–æ›´ä½</td>
<td> 2014 ~ 2017</td>
<td><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2lpc3NuYW4vaGV4by10aGVtZS1uZXh0">iissnan/hexo-theme-next<i class="fa fa-external-link-alt"></i></span></td>
</tr>
<tr class="even">
<td>v6.0.0 ~ v7.8.0</td>
<td>2018 ~ 2019</td>
<td><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3RoZW1lLW5leHQvaGV4by10aGVtZS1uZXh0">theme-next/hexo-theme-next<i class="fa fa-external-link-alt"></i></span></td>
</tr>
<tr class="odd">
<td>v8.0.0 æˆ–æ›´é«˜</td>
<td> 2020</td>
<td><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL25leHQtdGhlbWUvaGV4by10aGVtZS1uZXh0">next-theme/hexo-theme-next<i class="fa fa-external-link-alt"></i></span></td>
</tr>
</tbody>
</table>
<p>æ—§çš„ä»“åº“åŸºæœ¬ä¸Šå·²ç»ä¸å†æ›´æ–°ï¼Œå› æ­¤æ¨èé€‰æ‹©æœ€æ–°çš„ <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL25leHQtdGhlbWUvaGV4by10aGVtZS1uZXh0">next-theme/hexo-theme-next<i class="fa fa-external-link-alt"></i></span>
ä»“åº“çš„ NexT ä¸»é¢˜</p>
<h2 id="å®‰è£…">å®‰è£…</h2>
<p>æ¨èä½¿ç”¨ GitHub è¿›è¡Œå®‰è£…ï¼Œå¯ä»¥éšæ—¶æ›´æ–°</p>
<p>å› ä¸ºç¬”è€…ä¸ªäººåœ¨ Windows ç¯å¢ƒä¸‹å†™åšå®¢ï¼Œåç»­å‘½ä»¤å‡ä»¥ <span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vcG93ZXJzaGVsbC9zY3JpcHRpbmcvaW5zdGFsbC9pbnN0YWxsaW5nLXBvd2Vyc2hlbGw/dmlldz1wb3dlcnNoZWxsLTcuMg==">PowerShell<i class="fa fa-external-link-alt"></i></span>
ä¸ºä¾‹</p>
<figure class="highlight ps"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> &lt;hexo<span class="literal">-dir</span>&gt;</span><br><span class="line"><span class="comment"># git clone https://github.com/next-theme/hexo-theme-next.git .\themes\next\</span></span><br><span class="line">git clone git@github.com:next<span class="literal">-theme</span>/hexo<span class="literal">-theme-next</span>.git</span><br><span class="line"></span><br><span class="line"><span class="built_in">cp</span> .\themes\next\_config.yml .\_config.next.yml</span><br></pre></td></tr></tbody></table></figure>
<h2 id="é…ç½®è®°å½•">é…ç½®è®°å½•</h2>
<p>å¯¹ NexT ä¸»é¢˜çš„é…ç½®å¯ä»¥ç›´æ¥åœ¨ <code>hexo</code> ä»“åº“ä¸‹çš„é…ç½®æ–‡ä»¶
<code>_config.next.yml</code>
ä¸­è¿›è¡Œä¿®æ”¹å³å¯ï¼Œè¯¥æ–‡ä»¶çš„ä¿®æ”¹ä¼šåœ¨ç”Ÿæˆé¡µé¢æ—¶è¦†ç›–ä¸»é¢˜ç›®å½•ä¸‹çš„é…ç½®æ–‡ä»¶
<code>.\themes\next\_config.yml</code></p>
<p>è¡ç”Ÿæ‹“å±•ï¼š<span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlvL3poLWNuL2RvY3MvY29uZmlndXJhdGlvbiMlRTQlQkQlQkYlRTclOTQlQTglRTQlQkIlQTMlRTYlOUIlQkYlRTQlQjglQkIlRTklQTIlOTglRTklODUlOEQlRTclQkQlQUUlRTYlOTYlODclRTQlQkIlQjY=">ã€Hexoã€‘é…ç½®æ–‡ä»¶ä¼˜å…ˆçº§<i class="fa fa-external-link-alt"></i></span></p>
<h3 id="é£æ ¼ä¸»é¢˜">é£æ ¼ / ä¸»é¢˜</h3>
<p>NexT ä¸»é¢˜åŒ…å«äº† 4 ä¸ªé£æ ¼ï¼Œä¸ªäººå–œæ¬¢
Geminiï¼Œç±»ä¼¼å¡ç‰‡çš„é£æ ¼ï¼Œè¾¹ç•Œæ¯”è¾ƒæ˜æ˜¾</p>
<figure>
<img data-src="/posts/9a0b7c3b/NexT_Schemes.png" alt="NexT_Schemes">
<figcaption aria-hidden="true">NexT_Schemes</figcaption>
</figure>
<p>ä¿®æ”¹ <code>_config.next.yml</code> ä¹‹åï¼Œç”¨
<code>hexo clean; hexo g; hexo s</code> é‡æ–°ç”Ÿæˆä¸€ä¸‹ï¼Œå°±å¯ä»¥åœ¨ <span class="exturl" data-url="aHR0cDovL2xvY2FsaG9zdDo0MDAw">æœ¬åœ°<i class="fa fa-external-link-alt"></i></span>
é¢„è§ˆäº†ï¼ˆåç»­æµç¨‹å¦‚æœæ²¡æœ‰ç‰¹æ®Šè¯´æ˜åˆ™åŸºæœ¬ä¸€è‡´ï¼‰</p>
<figure class="highlight yml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># Schemes</span></span><br><span class="line"><span class="comment"># scheme: Muse</span></span><br><span class="line"><span class="comment"># scheme: Mist</span></span><br><span class="line"><span class="comment"># scheme: Pisces</span></span><br><span class="line"><span class="attr">scheme:</span> <span class="string">Gemini</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="ç½‘é¡µå›¾æ ‡">ç½‘é¡µå›¾æ ‡</h3>
<p>åœ¨å„ç±»ç½‘ç«™ä¸Šä¸‹è½½åˆé€‚å›¾æ ‡ï¼ŒæŒ‰ç…§é…ç½®æ–‡ä»¶ä¸­çš„æ–‡ä»¶åå‘½åï¼Œå¹¶æ”¾åœ¨
<code>images</code> ä¸‹å³å¯</p>
<p>è¡ç”Ÿé˜…è¯»ï¼š<span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIuYXBwbGUuY29tL2xpYnJhcnkvYXJjaGl2ZS9kb2N1bWVudGF0aW9uL0FwcGxlQXBwbGljYXRpb25zL1JlZmVyZW5jZS9TYWZhcmlXZWJDb250ZW50L0NvbmZpZ3VyaW5nV2ViQXBwbGljYXRpb25zL0NvbmZpZ3VyaW5nV2ViQXBwbGljYXRpb25zLmh0bWw=">ã€Appleã€‘Configuring
Web Applications<i class="fa fa-external-link-alt"></i></span></p>
<figure class="highlight yml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">favicon:</span></span><br><span class="line">  <span class="attr">small:</span> <span class="string">/images/favicon-16x16-next.png</span></span><br><span class="line">  <span class="attr">medium:</span> <span class="string">/images/favicon-32x32-next.png</span></span><br><span class="line">  <span class="attr">apple_touch_icon:</span> <span class="string">/images/apple-touch-icon-next.png</span></span><br><span class="line">  <span class="attr">safari_pinned_tab:</span> <span class="string">/images/logo.svg</span></span><br><span class="line">  <span class="comment">#android_manifest: /manifest.json</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="èœå•æ ">èœå•æ </h3>
<p>èœå•æ é…ç½®é»˜è®¤æ²¡æœ‰å¼€å¯ï¼Œä¸ªäººå¼€å¯äº†
<code>é¦–é¡µ</code>ã€<code>æ ‡ç­¾</code>ã€<code>åˆ†ç±»</code>ã€<code>å½’æ¡£</code>
å››ä¸ªå­é¡¹ç›®ï¼Œå¹¶å¼€å¯äº†å›¾æ ‡å’Œæ•°é‡çš„æ°”æ³¡æ˜¾ç¤º</p>
<figure class="highlight yml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># Usage: `Key: /link/ || icon`</span></span><br><span class="line"><span class="comment"># Key is the name of menu item. If the translation for this item is available, the translated text will be loaded, otherwise the Key name will be used. Key is case-sensitive.</span></span><br><span class="line"><span class="comment"># Value before `||` delimiter is the target link, value after `||` delimiter is the name of Font Awesome icon.</span></span><br><span class="line"><span class="comment"># External url should start with http:// or https://</span></span><br><span class="line"><span class="attr">menu:</span></span><br><span class="line">  <span class="attr">home:</span> <span class="string">/</span> <span class="string">||</span> <span class="string">fa</span> <span class="string">fa-home</span></span><br><span class="line">  <span class="comment">#about: /about/ || fa fa-user</span></span><br><span class="line">  <span class="attr">tags:</span> <span class="string">/tags/</span> <span class="string">||</span> <span class="string">fa</span> <span class="string">fa-tags</span></span><br><span class="line">  <span class="attr">categories:</span> <span class="string">/categories/</span> <span class="string">||</span> <span class="string">fa</span> <span class="string">fa-th</span></span><br><span class="line">  <span class="attr">archives:</span> <span class="string">/archives/</span> <span class="string">||</span> <span class="string">fa</span> <span class="string">fa-archive</span></span><br><span class="line">  <span class="comment">#schedule: /schedule/ || fa fa-calendar</span></span><br><span class="line">  <span class="comment">#sitemap: /sitemap.xml || fa fa-sitemap</span></span><br><span class="line">  <span class="comment">#commonweal: /404/ || fa fa-heartbeat</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Enable / Disable menu icons / item badges.</span></span><br><span class="line"><span class="attr">menu_settings:</span></span><br><span class="line">  <span class="attr">icons:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">badges:</span> <span class="literal">true</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="ä¾§è¾¹æ ">ä¾§è¾¹æ </h3>
<p>é»˜è®¤å¤´åƒä¼šå¼€å¯æ—‹è½¬åŠŸèƒ½ï¼ŒèŠ±é‡Œèƒ¡å“¨çš„è€Œä¸”æ—‹è½¬æœ‰ç‚¹å¿«ï¼Œä¸ªäººé€‰æ‹©äº†å…³é—­</p>
<figure class="highlight yml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># Sidebar Avatar</span></span><br><span class="line"><span class="attr">avatar:</span></span><br><span class="line">  <span class="comment"># Replace the default image and set the url here.</span></span><br><span class="line">  <span class="attr">url:</span> <span class="string">/images/avatar.gif</span></span><br><span class="line">  <span class="comment"># If true, the avatar will be displayed in circle.</span></span><br><span class="line">  <span class="attr">rounded:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># If true, the avatar will be rotated with the cursor.</span></span><br><span class="line">  <span class="attr">rotated:</span> <span class="literal">false</span></span><br></pre></td></tr></tbody></table></figure>
<p>åœ¨å•ç‹¬çš„æ–‡ç« é¡µé¢æ—¶ä¾§è¾¹æ ä¼šé»˜è®¤æ˜¾ç¤ºä¸ºç›®å½•ï¼Œå¹¶ä¸”
<code>æ ‡ç­¾</code>ã€<code>åˆ†ç±»</code>ã€<code>å½’æ¡£</code>
å·²ç»åœ¨èœå•æ å¼€å¯äº†ï¼Œæ‰€ä»¥ä¸ªäººé€‰æ‹©äº†å…³é—­</p>
<figure class="highlight yml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># Posts / Categories / Tags in sidebar.</span></span><br><span class="line"><span class="attr">site_state:</span> <span class="literal">false</span></span><br></pre></td></tr></tbody></table></figure>
<p>å…¶ä»–ç¤¾äº¤ç½‘ç«™çš„ä¸»é¡µçš„é…ç½®èµ·æ¥ä¹Ÿå¾ˆç®€å•ï¼Œç®€å•æ›¿æ¢ä¸€ä¸‹é“¾æ¥ï¼Œå¹¶ä¸”å–æ¶ˆæ³¨é‡Šå³å¯</p>
<figure class="highlight yml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># Social Links</span></span><br><span class="line"><span class="comment"># Usage: `Key: permalink || icon`</span></span><br><span class="line"><span class="comment"># Key is the link label showing to end users.</span></span><br><span class="line"><span class="comment"># Value before `||` delimiter is the target permalink, value after `||` delimiter is the name of Font Awesome icon.</span></span><br><span class="line"><span class="attr">social:</span></span><br><span class="line">  <span class="attr">GitHub:</span> <span class="string">https://github.com/ywang-wnlo</span> <span class="string">||</span> <span class="string">fab</span> <span class="string">fa-github</span></span><br><span class="line">  <span class="attr">E-Mail:</span> <span class="string">mailto:ywang_wnlo@qq.com</span> <span class="string">||</span> <span class="string">fa</span> <span class="string">fa-envelope</span></span><br><span class="line">  <span class="comment">#Weibo: https://weibo.com/yourname || fab fa-weibo</span></span><br><span class="line">  <span class="comment">#Google: https://plus.google.com/yourname || fab fa-google</span></span><br><span class="line">  <span class="comment">#Twitter: https://twitter.com/yourname || fab fa-twitter</span></span><br><span class="line">  <span class="comment">#FB Page: https://www.facebook.com/yourname || fab fa-facebook</span></span><br><span class="line">  <span class="comment">#StackOverflow: https://stackoverflow.com/yourname || fab fa-stack-overflow</span></span><br><span class="line">  <span class="comment">#YouTube: https://youtube.com/yourname || fab fa-youtube</span></span><br><span class="line">  <span class="comment">#Instagram: https://instagram.com/yourname || fab fa-instagram</span></span><br><span class="line">  <span class="comment">#Skype: skype:yourname?call|chat || fab fa-skype</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="æœ¬åœ°æœç´¢">æœ¬åœ°æœç´¢</h3>
<p>æœ¬åœ°æœç´¢å¯ä»¥å¿«é€Ÿçš„æ£€ç´¢æ‰€æœ‰çš„æ–‡ç« ï¼Œæœ‰æ—¶å€™è¿˜æ˜¯å¾ˆæœ‰ç”¨çš„</p>
<p>é…ç½®æœ¬åœ°æœç´¢ä¹‹å‰ï¼Œé¦–å…ˆè¦åœ¨ <code>hexo</code> ä¸‹å®‰è£…æ’ä»¶</p>
<figure class="highlight ps"><table><tbody><tr><td class="code"><pre><span class="line">npm install hexo<span class="literal">-generator-searchdb</span> <span class="literal">--save</span></span><br></pre></td></tr></tbody></table></figure>
<p>ç„¶ååœ¨é…ç½®ä¸­å¼€å¯å³å¯</p>
<figure class="highlight yml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># Local Search</span></span><br><span class="line"><span class="comment"># Dependencies: https://github.com/next-theme/hexo-generator-searchdb</span></span><br><span class="line"><span class="attr">local_search:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># If auto, trigger search by changing input.</span></span><br><span class="line">  <span class="comment"># If manual, trigger search by pressing enter key or search button.</span></span><br><span class="line">  <span class="attr">trigger:</span> <span class="string">auto</span></span><br><span class="line">  <span class="comment"># Show top n results per article, show all results by setting to -1</span></span><br><span class="line">  <span class="attr">top_n_per_article:</span> <span class="number">-1</span></span><br><span class="line">  <span class="comment"># Unescape html strings to the readable one.</span></span><br><span class="line">  <span class="attr">unescape:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># Preload the search data when the page loads.</span></span><br><span class="line">  <span class="attr">preload:</span> <span class="literal">false</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="ä»£ç å—">ä»£ç å—</h3>
<p>ä»£ç å—çš„é«˜äº®æœ‰å¾ˆå¤šç§é…è‰²å¯ä»¥é€‰ï¼Œå¹¶ä¸”å¯ä»¥å¼€å¯ä¸€é”®å¤åˆ¶åŠŸèƒ½</p>
<figure class="highlight yml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">codeblock:</span></span><br><span class="line">  <span class="comment"># Code Highlight theme</span></span><br><span class="line">  <span class="comment"># All available themes: https://theme-next.js.org/highlight/</span></span><br><span class="line">  <span class="attr">theme:</span></span><br><span class="line">    <span class="attr">light:</span> <span class="string">vs</span></span><br><span class="line">    <span class="attr">dark:</span> <span class="string">vs2015</span></span><br><span class="line">  <span class="attr">prism:</span></span><br><span class="line">    <span class="attr">light:</span> <span class="string">prism</span></span><br><span class="line">    <span class="attr">dark:</span> <span class="string">prism-dark</span></span><br><span class="line">  <span class="comment"># Add copy button on codeblock</span></span><br><span class="line">  <span class="attr">copy_button:</span></span><br><span class="line">    <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># Available values: default | flat | mac</span></span><br><span class="line">    <span class="attr">style:</span> <span class="string">default</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="åŠ¨ç”»æ•ˆæœ">åŠ¨ç”»æ•ˆæœ</h3>
<p>NexT é»˜è®¤å¼€å¯äº†åŠ¨ç”»æ•ˆæœï¼Œä½†æ˜¯æ„Ÿè§‰æ¯”è¾ƒæ…¢ï¼Œæ„Ÿè§‰æœ‰äº›å½±å“é˜…è¯»ï¼Œæ¨èå¼€å¯
<code>async</code>ï¼Œå¹¶ä¸”é€‚å½“çš„ä¿®æ”¹åŠ¨ç”»æ•ˆæœ</p>
<p>P.S. èœå•æ çš„åŠ¨ç”»ä¸å¯ä»¥å…³é—­å’Œè°ƒæ•´ï¼Œåº”è¯¥æ˜¯ä¸ª <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL25leHQtdGhlbWUvaGV4by10aGVtZS1uZXh0L2lzc3Vlcy80MTI=">bug<i class="fa fa-external-link-alt"></i></span></p>
<figure class="highlight yml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># Use Animate.css to animate everything.</span></span><br><span class="line"><span class="comment"># For more information: https://animate.style</span></span><br><span class="line"><span class="attr">motion:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">async:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">transition:</span></span><br><span class="line">    <span class="comment"># All available transition variants: https://theme-next.js.org/animate/</span></span><br><span class="line">    <span class="attr">post_block:</span> <span class="string">fadeIn</span></span><br><span class="line">    <span class="attr">post_header:</span></span><br><span class="line">    <span class="attr">post_body:</span></span><br><span class="line">    <span class="attr">coll_header:</span></span><br><span class="line">    <span class="comment"># Only for Pisces | Gemini.</span></span><br><span class="line">    <span class="attr">sidebar:</span> <span class="string">fadeInDown</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="é˜…è¯»è¿›åº¦">é˜…è¯»è¿›åº¦</h3>
<p>é˜…è¯»è¿›åº¦æœ‰ä¸¤ç§å±•ç¤ºæ–¹å¼ï¼Œä¸€ä¸ªåœ¨å›åˆ°é¦–é¡µçš„æŒ‰é’®ä¸Šç›´æ¥æ˜¾ç¤ºç™¾åˆ†æ¯”ï¼Œå¦ä¸€ä¸ªå¯ä»¥é…ç½®åœ¨é¦–ä½éƒ¨å¢åŠ è¿›åº¦æ¡ï¼Œä¸ªäººä¸¤ä¸ªéƒ½å¼€å¯äº†</p>
<figure class="highlight yml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">back2top:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># Back to top in sidebar.</span></span><br><span class="line">  <span class="attr">sidebar:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># Scroll percent label in b2t button.</span></span><br><span class="line">  <span class="attr">scrollpercent:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Reading progress bar</span></span><br><span class="line"><span class="attr">reading_progress:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># Available values: left | right</span></span><br><span class="line">  <span class="attr">start_at:</span> <span class="string">left</span></span><br><span class="line">  <span class="comment"># Available values: top | bottom</span></span><br><span class="line">  <span class="attr">position:</span> <span class="string">bottom</span></span><br><span class="line">  <span class="attr">reversed:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">color:</span> <span class="string">"#37c6c0"</span></span><br><span class="line">  <span class="attr">height:</span> <span class="string">5px</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="ä¹¦ç­¾">ä¹¦ç­¾</h3>
<p>NexT çš„ä¹¦ç­¾åŠŸèƒ½å¯ä»¥ä¿å­˜å½“å‰çš„é˜…è¯»è¿›åº¦ï¼Œä¸‹æ¬¡æ‰“å¼€æ˜¯ä¼šåœ¨ç»­æ¥è¯¥è¿›åº¦</p>
<figure class="highlight yml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># Bookmark Support</span></span><br><span class="line"><span class="attr">bookmark:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># Customize the color of the bookmark.</span></span><br><span class="line">  <span class="attr">color:</span> <span class="string">"#222"</span></span><br><span class="line">  <span class="comment"># If auto, save the reading progress when closing the page or clicking the bookmark-icon.</span></span><br><span class="line">  <span class="comment"># If manual, only save it by clicking the bookmark-icon.</span></span><br><span class="line">  <span class="attr">save:</span> <span class="string">auto</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="mermaid">Mermaid</h3>
<p><span class="exturl" data-url="aHR0cHM6Ly9tZXJtYWlkLWpzLmdpdGh1Yi5pby9tZXJtYWlkLyMv">Mermaid<i class="fa fa-external-link-alt"></i></span>
å¯ä»¥å¿«é€Ÿçš„ç”¨ä»£ç ç”Ÿæˆç®€å•çš„æµç¨‹å›¾ã€æ—¶åºå›¾ã€ç”˜ç‰¹å›¾ç­‰</p>
<p>NexT ä¸­å¼€å¯ Mermaid æ”¯æŒå¾ˆæ–¹ä¾¿ï¼ŒåŒæ—¶è¿˜æœ‰ä¸åŒçš„é£æ ¼å¯ä»¥é€‰</p>
<figure class="highlight yml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># Mermaid tag</span></span><br><span class="line"><span class="attr">mermaid:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># Available themes: default | dark | forest | neutral</span></span><br><span class="line">  <span class="attr">theme:</span></span><br><span class="line">    <span class="attr">light:</span> <span class="string">neutral</span></span><br><span class="line">    <span class="attr">dark:</span> <span class="string">dark</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="lazyload">lazyload</h3>
<p>lazyload
æ˜¯ç½‘ç«™å¸¸ç”¨çš„æŠ€æœ¯ï¼Œé€šè¿‡æŒ‰éœ€åŠ è½½ï¼Œé¿å…ä¸€æ¬¡æ€§åŠ è½½è¿‡å¤šå†…å®¹å¯¼è‡´çš„æ‰“å¼€ç¼“æ…¢</p>
<figure class="highlight yml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># Vanilla JavaScript plugin for lazyloading images.</span></span><br><span class="line"><span class="comment"># For more information: https://apoorv.pro/lozad.js/demo/</span></span><br><span class="line"><span class="attr">lazyload:</span> <span class="literal">true</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="fancybox">fancybox</h3>
<p>fancybox
å¯ä»¥åœ¨ç‚¹å‡»å›¾ç‰‡æ—¶æ”¾å¤§è¯¥å›¾ç‰‡ï¼Œå¹¶ä¸”å¯ä»¥å¿«é€Ÿæµè§ˆå½“å‰æ–‡ç« çš„æ‰€æœ‰å›¾ç‰‡</p>
<figure class="highlight yml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># FancyBox is a tool that offers a nice and elegant way to add zooming functionality for images.</span></span><br><span class="line"><span class="comment"># For more information: https://fancyapps.com/fancybox/</span></span><br><span class="line"><span class="attr">fancybox:</span> <span class="literal">true</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="pangu">pangu</h3>
<p>å¯¹äºå¼ºè¿«ç—‡æ¥è¯´ï¼Œä¸­è‹±æ–‡æ··æ’æ—¶åŠ ä¸Šç©ºæ ¼èƒ½å¾ˆå¤§ç¨‹åº¦æ”¹å–„é˜…è¯»ä½“éªŒï¼Œä½†æ˜¯æœ‰æ—¶å€™ä¼šä¸å°å¿ƒæ‰“æ¼éƒ¨åˆ†ç©ºæ ¼ï¼Œè€Œ
<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3ZpbnRhL3Bhbmd1Lmpz">pangu<i class="fa fa-external-link-alt"></i></span>
è¿™ä¸ªé¡¹ç›®å°±å¯ä»¥å¸®ä½ åœ¨å±•ç¤ºæ—¶è‡ªåŠ¨åŠ ä¸Šç©ºæ ¼</p>
<figure class="highlight yml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># Pangu Support</span></span><br><span class="line"><span class="comment"># For more information: https://github.com/vinta/pangu.js</span></span><br><span class="line"><span class="comment"># Server-side plugin: https://github.com/next-theme/hexo-pangu</span></span><br><span class="line"><span class="attr">pangu:</span> <span class="literal">true</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="æèµ ">æèµ </h3>
<p>æ–‡ç« æœ«å°¾è¿˜å¯ä»¥æ±‚æ‰“èµï¼Œéœ€è¦é…ç½®å¥½ç›¸åº”çš„äºŒç»´ç å›¾ç‰‡ï¼Œå¹¶ä¸”å¯ä»¥ä¿®æ”¹æç¤ºè¯­å¥</p>
<figure class="highlight yml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># Donate (Sponsor) settings</span></span><br><span class="line"><span class="comment"># Front-matter variable (nonsupport animation).</span></span><br><span class="line"><span class="attr">reward_settings:</span></span><br><span class="line">  <span class="comment"># If true, a donate button will be displayed in every article by default.</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">animation:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">comment:</span> <span class="string">èµä¸ªé¸¡è…¿ğŸ—</span></span><br><span class="line"></span><br><span class="line"><span class="attr">reward:</span></span><br><span class="line">  <span class="attr">wechatpay:</span> <span class="string">/images/wechatpay.png</span></span><br><span class="line">  <span class="attr">alipay:</span> <span class="string">/images/alipay.jpg</span></span><br><span class="line">  <span class="comment">#paypal: /images/paypal.png</span></span><br><span class="line">  <span class="comment">#bitcoin: /images/bitcoin.png</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="ç‰ˆæƒå£°æ˜">ç‰ˆæƒå£°æ˜</h3>
<p>NexT å†…ç½®äº†æ–‡ç« æœ«å°¾å¢åŠ ç‰ˆæƒå£°æ˜ï¼Œåªéœ€æ‰‹åŠ¨å¼€å¯å³å¯</p>
<figure class="highlight yml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># Creative Commons 4.0 International License.</span></span><br><span class="line"><span class="comment"># See: https://creativecommons.org/about/cclicenses/</span></span><br><span class="line"><span class="attr">creative_commons:</span></span><br><span class="line">  <span class="comment"># Available values: by | by-nc | by-nc-nd | by-nc-sa | by-nd | by-sa | cc-zero</span></span><br><span class="line">  <span class="attr">license:</span> <span class="string">by-nc-sa</span></span><br><span class="line">  <span class="comment"># Available values: big | small</span></span><br><span class="line">  <span class="attr">size:</span> <span class="string">small</span></span><br><span class="line">  <span class="attr">sidebar:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">post:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># You can set a language value if you prefer a translated version of CC license, e.g. deed.zh</span></span><br><span class="line">  <span class="comment"># CC licenses are available in 39 languages, you can find the specific and correct abbreviation you need on https://creativecommons.org</span></span><br><span class="line">  <span class="attr">language:</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="ä¸è’œå­">ä¸è’œå­</h3>
<p><span class="exturl" data-url="aHR0cHM6Ly9idXN1YW56aS5pYnJ1Y2UuaW5mby8=">ä¸è’œå­<i class="fa fa-external-link-alt"></i></span>
æ˜¯ä¸€ä¸ªæç®€çš„ç½‘é¡µè®¡æ•°å™¨ï¼ŒNexT å·²ç»å†…ç½®ï¼Œåªéœ€æ‰“å¼€å³å¯</p>
<figure class="highlight yml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># Show Views / Visitors of the website / page with busuanzi.</span></span><br><span class="line"><span class="comment"># For more information: http://ibruce.info/2015/04/04/busuanzi/</span></span><br><span class="line"><span class="attr">busuanzi_count:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">total_visitors:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">total_visitors_icon:</span> <span class="string">fa</span> <span class="string">fa-user</span></span><br><span class="line">  <span class="attr">total_views:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">total_views_icon:</span> <span class="string">fa</span> <span class="string">fa-eye</span></span><br><span class="line">  <span class="attr">post_views:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">post_views_icon:</span> <span class="string">far</span> <span class="string">fa-eye</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="gitalk">gitalk</h3>
<p>è¯„è®ºç³»ç»Ÿä¹Ÿæ˜¯ä¸€ä¸ªåšå®¢å¿…ä¸å¯å°‘çš„ï¼Œç”±äºæœ¬åšå®¢æ­åœ¨ GitHub Pages
ä¸Šï¼Œæ‰€ä»¥è¯„è®ºç³»ç»Ÿå°±é‡‡ç”¨åˆ©ç”¨ GitHub Issues å®ç°çš„ <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2dpdGFsay9naXRhbGs=">gitalk<i class="fa fa-external-link-alt"></i></span></p>
<p>NexT å·²ç»å†…ç½®çš„ gitalk çš„ <code>js</code> å’Œ
<code>css</code>ï¼Œåœ¨é…ç½®æ–‡ä»¶ä¸­å¼€å¯å¹¶è¿›è¡Œé…ç½®å³å¯</p>
<p>åœ¨ä¿®æ”¹é…ç½®æ–‡ä»¶ä¹‹å‰éœ€è¦å…ˆåœ¨ GitHub ä¸Šç”³è¯·ä¸€ä¸ª OAuth
Applicationï¼Œå…¥å£åœ¨ <code>ã€Settingsã€‘</code> -&gt;
<code>ã€Developer settingsã€‘</code> -&gt; <code>ã€OAuth Appsã€‘</code>
-&gt; <code>ã€New OAuth Appã€‘</code>ï¼Œæˆ–è€…ç›´æ¥ä½¿ç”¨è¿™ä¸ª <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3NldHRpbmdzL2FwcGxpY2F0aW9ucy9uZXc=">é“¾æ¥<i class="fa fa-external-link-alt"></i></span></p>
<figure>
<img data-src="/posts/9a0b7c3b/OAuth_APP_Register.png" alt="OAuth_APP_Register">
<figcaption aria-hidden="true">OAuth_APP_Register</figcaption>
</figure>
<p>å¡«å†™å¥½ä¹‹åï¼Œè®°å½•ä¸‹åº”ç”¨ id
ä»¥åŠå¯†é’¥ï¼Œå¦‚æœæ²¡æœ‰æ˜¾ç¤ºå¯†é’¥éœ€è¦æ‰‹åŠ¨ç”Ÿæˆä¸€ä¸‹</p>
<figure>
<img data-src="/posts/9a0b7c3b/OAuth_APP_ID_Secrets.png" alt="OAuth_APP_ID_Secrets">
<figcaption aria-hidden="true">OAuth_APP_ID_Secrets</figcaption>
</figure>
<p>ç„¶åé¦–å…ˆé€‰ç”¨ gitalk ä½œä¸ºè¯„è®ºç³»ç»Ÿ</p>
<figure class="highlight yml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># Multiple Comment System Support</span></span><br><span class="line"><span class="attr">comments:</span></span><br><span class="line">  <span class="comment"># Available values: tabs | buttons</span></span><br><span class="line">  <span class="attr">style:</span> <span class="string">tabs</span></span><br><span class="line">  <span class="comment"># Choose a comment system to be displayed by default.</span></span><br><span class="line">  <span class="comment"># Available values: disqus | disqusjs | changyan | livere | gitalk | utterances</span></span><br><span class="line">  <span class="attr">active:</span> <span class="string">gitalk</span></span><br><span class="line">  <span class="comment"># Setting `true` means remembering the comment system selected by the visitor.</span></span><br><span class="line">  <span class="attr">storage:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># Lazyload all comment systems.</span></span><br><span class="line">  <span class="attr">lazyload:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># Modify texts or order for any naves, here are some examples.</span></span><br><span class="line">  <span class="attr">nav:</span></span><br><span class="line">    <span class="comment">#disqus:</span></span><br><span class="line">    <span class="comment">#  text: Load Disqus</span></span><br><span class="line">    <span class="comment">#  order: -1</span></span><br><span class="line">    <span class="comment">#gitalk:</span></span><br><span class="line">    <span class="comment">#  order: -2</span></span><br></pre></td></tr></tbody></table></figure>
<p>åœ¨ gitalk é…ç½®ä¸­å¡«ä¸Šç›¸åº”çš„å†…å®¹</p>
<figure class="highlight yml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># Gitalk</span></span><br><span class="line"><span class="comment"># For more information: https://gitalk.github.io</span></span><br><span class="line"><span class="attr">gitalk:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">github_id:</span> <span class="string">&lt;GitHub</span> <span class="string">id&gt;</span> <span class="comment"># GitHub repo owner</span></span><br><span class="line">  <span class="attr">repo:</span> <span class="string">&lt;GitHub</span> <span class="string">id&gt;.github.io</span> <span class="comment"># Repository name to store issues</span></span><br><span class="line">  <span class="attr">client_id:</span> <span class="string">&lt;åº”ç”¨</span> <span class="string">id&gt;</span> <span class="comment"># GitHub Application Client ID</span></span><br><span class="line">  <span class="attr">client_secret:</span> <span class="string">&lt;åº”ç”¨å¯†é’¥&gt;</span> <span class="comment"># GitHub Application Client Secret</span></span><br><span class="line">  <span class="attr">admin_user:</span> <span class="string">&lt;GitHub</span> <span class="string">id&gt;</span> <span class="comment"># GitHub repo owner and collaborators, only these guys can initialize gitHub issues</span></span><br><span class="line">  <span class="attr">distraction_free_mode:</span> <span class="literal">true</span> <span class="comment"># Facebook-like distraction free mode</span></span><br><span class="line">  <span class="comment"># When the official proxy is not available, you can change it to your own proxy address</span></span><br><span class="line">  <span class="attr">proxy:</span> <span class="string">https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token</span> <span class="comment"># This is official proxy address</span></span><br><span class="line">  <span class="comment"># Gitalk's display language depends on user's browser or system environment</span></span><br><span class="line">  <span class="comment"># If you want everyone visiting your site to see a uniform language, you can set a force language value</span></span><br><span class="line">  <span class="comment"># Available values: en | es-ES | fr | ru | zh-CN | zh-TW</span></span><br><span class="line">  <span class="attr">language:</span></span><br></pre></td></tr></tbody></table></figure>
<h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h2>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly90aGVtZS1uZXh0LmpzLm9yZw==">ã€NexTã€‘v8.0.0+ å®˜ç½‘<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL25leHQtdGhlbWUvaGV4by10aGVtZS1uZXh0L2lzc3Vlcy80">ã€å¿…è¯»ã€‘æ›´æ–°è¯´æ˜åŠå¸¸è§é—®é¢˜<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlvL3poLWNuL2RvY3MvY29uZmlndXJhdGlvbiMlRTQlQkQlQkYlRTclOTQlQTglRTQlQkIlQTMlRTYlOUIlQkYlRTQlQjglQkIlRTklQTIlOTglRTklODUlOEQlRTclQkQlQUUlRTYlOTYlODclRTQlQkIlQjY=">ã€Hexoã€‘é…ç½®æ–‡ä»¶ä¼˜å…ˆçº§<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIuYXBwbGUuY29tL2xpYnJhcnkvYXJjaGl2ZS9kb2N1bWVudGF0aW9uL0FwcGxlQXBwbGljYXRpb25zL1JlZmVyZW5jZS9TYWZhcmlXZWJDb250ZW50L0NvbmZpZ3VyaW5nV2ViQXBwbGljYXRpb25zL0NvbmZpZ3VyaW5nV2ViQXBwbGljYXRpb25zLmh0bWw=">ã€Appleã€‘Configuring
Web Applications<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9tZXJtYWlkLWpzLmdpdGh1Yi5pby9tZXJtYWlkLyMv">ã€Mermaidã€‘å®˜ç½‘<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3ZpbnRhL3Bhbmd1Lmpz">ã€GitHubã€‘pangu<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9idXN1YW56aS5pYnJ1Y2UuaW5mbw==">ã€ä¸è’œå­ã€‘å®˜ç½‘<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2dpdGFsay9naXRhbGs=">ã€GitHubã€‘Gitalk<i class="fa fa-external-link-alt"></i></span></li>
</ul>
]]></content>
      <categories>
        <category>Hexo</category>
      </categories>
      <tags>
        <tag>Hexo</tag>
        <tag>NexT</tag>
      </tags>
  </entry>
  <entry>
    <title>Hexo é…ç½®ä¸»æµæœç´¢å¼•æ“æ”¶å½•æµç¨‹è®°å½•</title>
    <url>/posts/abac0c46.html</url>
    <content><![CDATA[<p>æƒ³è®©ç½‘ç«™èƒ½å¤Ÿè¢«æ›´å¤šçš„äººé˜…è¯»ï¼Œæœç´¢å¼•æ“å¸¦æ¥çš„æµé‡å¿…ä¸å¯å°‘ã€‚æœ¬æ–‡ä¸»è¦ä»‹ç»å¦‚ä½•é…ç½®
Hexo å¹¶è¢«ä¸»æµçš„æœç´¢å¼•æ“ï¼ˆGoogleã€Bingï¼‰æ”¶å½• <span id="more"></span></p>
<p>æœç´¢å¼•æ“èƒ½æœç´¢åˆ°ç½‘ç«™çš„å‰ææ˜¯å®ƒæŠ“å–äº†ç½‘ç«™çš„å†…å®¹ï¼Œå¹¶å¯¹å…¶å»ºç«‹äº†ç´¢å¼•ï¼Œå…¶å®ä¹Ÿå°±æ˜¯çˆ¬è™«çˆ¬å–
+
æ’å…¥æ•°æ®åº“ã€‚è™½ç„¶å¤§éƒ¨åˆ†æœç´¢å¼•æ“éƒ½æ˜¯è‡ªåŠ¨æŠ“å–ç½‘ç»œä¸Šçš„æ‰€æœ‰é“¾æ¥ï¼Œå¹¶å°è¯•çˆ¬å–ä»¥åŠå…¥åº“ï¼Œä½†é€šå¸¸ä¼šæ¯”è¾ƒç¼“æ…¢ï¼ˆæ¯•ç«Ÿå®ƒå¹¶ä¸ä¸€å®šçŸ¥é“æˆ‘ä»¬ç½‘ç«™çš„åœ°å€ hhhï¼‰ã€‚æ‰€ä»¥æ›´åŠ æ¨èç”±æˆ‘ä»¬ç«™é•¿ä¸»åŠ¨å‡ºå‡»ï¼Œç›´æ¥å‘Šè¯‰å®ƒæˆ‘ä»¬çš„ç½‘ç«™åœ°å€</p>
<p>å»¶ä¼¸é˜…è¯»ï¼š<span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXJzLmdvb2dsZS5jb20vc2VhcmNoL2RvY3MvYmFzaWNzL2hvdy1zZWFyY2gtd29ya3M/aGw9emgtQ04=">Google
æœç´¢è¿ä½œæ–¹å¼çš„åŸºç¡€çŸ¥è¯†<i class="fa fa-external-link-alt"></i></span></p>
<h2 id="æ˜¯å¦å·²ç»è¢«æ”¶å½•">æ˜¯å¦å·²ç»è¢«æ”¶å½•</h2>
<p>ä¸ºäº†æŸ¥çœ‹ç½‘ç«™æ˜¯å¦å·²ç»è¢«æ”¶å½•ï¼Œå¯ä»¥åœ¨ Google æˆ–è€… Bing
ä»¥ä¸‹æŸ¥è¯¢æ ¼å¼æœç´¢ï¼Œæ ¹æ®è‡ªå·±ç½‘ç«™çš„åœ°å€å¯¹åé¢çš„ <code>http(s)</code>
é“¾æ¥è¿›è¡Œæ›¿æ¢å³å¯</p>
<figure class="highlight txt"><table><tbody><tr><td class="code"><pre><span class="line">site:https://ywang-wnlo.github.io/</span><br></pre></td></tr></tbody></table></figure>
<figure>
<img data-src="/posts/abac0c46/google_site.png" alt="google_site">
<figcaption aria-hidden="true">google_site</figcaption>
</figure>
<p>å¦‚æœèƒ½æœç´¢åˆ°å†…å®¹ï¼Œé‚£ä¹ˆæ­å–œç½‘ç«™å·²ç»è¢«æœç´¢å¼•æ“æ”¶å½•ã€‚ä¸è¿‡ä¸ºäº†æ›´å¥½çš„è¢«æ”¶å½•ç½‘ç«™ä¸­çš„å†…å®¹ï¼Œè¿˜æ˜¯æ¨èç”Ÿæˆç«™ç‚¹åœ°å›¾å¹¶æäº¤ï¼Œæ¥å‘Šè¯‰æœç´¢å¼•æ“ç½‘ç«™ä¸­æœ‰å“ªäº›é“¾æ¥éœ€è¦è¢«çˆ¬å–</p>
<h2 id="ç”Ÿæˆç«™ç‚¹åœ°å›¾">ç”Ÿæˆç«™ç‚¹åœ°å›¾</h2>
<p>ç«™ç‚¹åœ°å›¾æ˜¯ä¸€ç§æ–‡ä»¶ï¼Œæ‚¨ä»¥åœ¨å…¶ä¸­æä¾›ä¸ç½‘ç«™ä¸­çš„ç½‘é¡µã€è§†é¢‘æˆ–å…¶ä»–æ–‡ä»¶æœ‰å…³çš„ä¿¡æ¯ï¼Œè¿˜å¯ä»¥è¯´æ˜è¿™äº›å†…å®¹ä¹‹é—´çš„å…³ç³»ã€‚æœç´¢å¼•æ“ä¼šè¯»å–æ­¤æ–‡ä»¶ï¼Œä»¥ä¾¿æ›´é«˜æ•ˆåœ°æŠ“å–æ‚¨çš„ç½‘ç«™ã€‚ç«™ç‚¹åœ°å›¾ä¼šå‘Šè¯‰æœç´¢å¼•æ“æ‚¨è®¤ä¸ºç½‘ç«™ä¸­çš„å“ªäº›ç½‘é¡µå’Œæ–‡ä»¶æ¯”è¾ƒé‡è¦ï¼Œè¿˜ä¼šæä¾›ä¸è¿™äº›æ–‡ä»¶æœ‰å…³çš„é‡è¦ä¿¡æ¯ã€‚ä¾‹å¦‚ï¼Œç½‘é¡µä¸Šæ¬¡æ›´æ–°çš„æ—¶é—´å’Œç½‘é¡µæ˜¯å¦æœ‰ä»»ä½•å¤‡ç”¨çš„è¯­è¨€ç‰ˆæœ¬</p>
<p>Hexo é…ç½®ç«™ç‚¹åœ°å›¾ <code>sitemap</code> å¯ä»¥åˆ©ç”¨
<code>hexo-generator-sitemap</code> æ’ä»¶ï¼Œå…·ä½“çš„é…ç½®è¿‡ç¨‹å‚è§ <a href="/posts/4143201a.html#hexo-generator-sitemap">è¿™é‡Œ</a></p>
<p>ä»…ä»…ç”Ÿæˆç«™ç‚¹åœ°å›¾è¿˜ä¸å¤Ÿï¼Œä¸ºäº†æ›´æ—©è¢«æ”¶å½•ç«™ç‚¹åœ°å›¾ä¸­çš„é“¾æ¥ï¼Œè¿˜éœ€è¦ä¸»åŠ¨å°†ç«™ç‚¹åœ°å›¾æäº¤ç»™æœç´¢å¼•æ“</p>
<h2 id="æäº¤ç«™ç‚¹åœ°å›¾">æäº¤ç«™ç‚¹åœ°å›¾</h2>
<p>ä¸‹é¢æ‰‹æŠŠæ‰‹æ•™ä½ å¦‚ä½•ç»™ Google å’Œ Bing æäº¤ç«™ç‚¹åœ°å›¾</p>
<p>ï¼ˆç”±äº GitHub
å±è”½äº†ç™¾åº¦çš„çˆ¬è™«ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œä¸åšç™¾åº¦æœç´¢å¼•æ“çš„æµç¨‹ä»‹ç»ï¼Œä¸è¿‡ä»¥ä¸‹å†…å®¹å¯ä»¥å‚è€ƒï¼‰</p>
<h3 id="google">Google</h3>
<p>Google å®˜ç½‘ç»™äº†è¯¦ç»†çš„æ–‡æ¡£ï¼Œå¯ä»¥çœ‹è¿™ç¯‡ <span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXJzLmdvb2dsZS5jb20vc2VhcmNoL2RvY3MvYmVnaW5uZXIvZ2V0LXN0YXJ0ZWQ/aGw9emgtQ04=">æ–°æ‰‹å…¥é—¨æŒ‡å—<i class="fa fa-external-link-alt"></i></span></p>
<p>è€Œå¯¹æˆ‘ä»¬æ¥è¯´ï¼Œä¸»è¦åˆ†ä¸‰ä¸ªæ­¥éª¤ï¼šæ³¨å†Œ Search
Consoleï¼ŒéªŒè¯ç½‘ç«™æ‰€æœ‰æƒï¼Œæäº¤ç«™ç‚¹åœ°å›¾</p>
<h4 id="æ³¨å†Œ-search-console">æ³¨å†Œ Search Console</h4>
<p>æ³¨å†Œçš„è¿‡ç¨‹éå¸¸ç®€å•ï¼Œè¿›å…¥ <span class="exturl" data-url="aHR0cHM6Ly9zZWFyY2guZ29vZ2xlLmNvbS9zZWFyY2gtY29uc29sZQ==">GSC
å®˜ç½‘<i class="fa fa-external-link-alt"></i></span>ï¼Œç”¨è°·æ­Œè´¦å·ç™»å½•å³å¯</p>
<h4 id="éªŒè¯ç½‘ç«™æ‰€æœ‰æƒ">éªŒè¯ç½‘ç«™æ‰€æœ‰æƒ</h4>
<p>ç™»å½•ä¹‹åï¼Œå°±éœ€è¦æ·»åŠ æˆ‘ä»¬çš„ç½‘ç«™äº†</p>
<figure>
<img data-src="/posts/abac0c46/google_add_website.png" alt="google_add_website">
<figcaption aria-hidden="true">google_add_website</figcaption>
</figure>
<p>ç”±äºè¯¥åšå®¢æ˜¯åˆ©ç”¨ GitHub Pages æ­å»ºï¼Œå¹¶æ²¡æœ‰ DNS
é…ç½®çš„ç›¸å…³æƒé™ï¼Œå› æ­¤æˆ‘ä»¬ä½¿ç”¨ç¬¬äºŒç§æ–¹å¼è¿›è¡Œé…ç½®ï¼Œç‚¹å‡» <code>ç»§ç»­</code>
åä¼šæœ‰äº”ç§æ–¹å¼ä¾›æˆ‘ä»¬é€‰æ‹©</p>
<figure>
<img data-src="/posts/abac0c46/google_verify_ownership_1.png" alt="google_verify_ownership">
<figcaption aria-hidden="true">google_verify_ownership</figcaption>
</figure>
<p>ä¸ªäººæ¨èä½¿ç”¨ç¬¬äºŒç§ï¼Œä¹Ÿå°±æ˜¯ HTML æ ‡è®°çš„æ–¹å¼ï¼Œå› ä¸º NexT
ä¸»é¢˜çš„é…ç½®ä¸­å¯¹å…¶è¿›è¡Œæ”¯æŒï¼Œé…ç½®èµ·æ¥æ¯”è¾ƒç®€å•</p>
<figure>
<img data-src="/posts/abac0c46/google_verify_ownership_2.png" alt="google_verify_ownership">
<figcaption aria-hidden="true">google_verify_ownership</figcaption>
</figure>
<p>ç‚¹å‡»å¤åˆ¶ï¼Œè®°å½•ä¸‹å…¶ä¸­çš„æ ‡è®°ä¿¡æ¯ï¼Œä¾‹å¦‚æˆ‘ä»¬è¿™é‡Œå¤åˆ¶çš„åŸå§‹å†…å®¹æ˜¯</p>
<figure class="highlight html"><table><tbody><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"google-site-verification"</span> <span class="attr">content</span>=<span class="string">"F3QOKaQRQaSAxN-JLDLGD21CCU5CkZRssZYwX-Mn-Zc"</span> /&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<p>æ‰€ä»¥åœ¨ Next çš„é…ç½®æ–‡ä»¶ä¸­ <code>_config.next.yml</code>
é…ç½®å¦‚ä¸‹å†…å®¹</p>
<figure class="highlight yml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># Google Webmaster tools verification.</span></span><br><span class="line"><span class="comment"># See: https://developers.google.com/search</span></span><br><span class="line"><span class="attr">google_site_verification:</span> <span class="string">F3QOKaQRQaSAxN-JLDLGD21CCU5CkZRssZYwX-Mn-Zc</span></span><br></pre></td></tr></tbody></table></figure>
<p>ä¹‹åé‡æ–°ç”Ÿæˆç½‘ç«™ï¼Œå¹¶æ¨é€åˆ° GitHubï¼Œç­‰å¾… GitHub Pages ç”Ÿæˆå®Œæ¯•åï¼Œç‚¹å‡»
<code>éªŒè¯</code> å³å¯</p>
<h4 id="æäº¤ç«™ç‚¹åœ°å›¾-1">æäº¤ç«™ç‚¹åœ°å›¾</h4>
<p>ä¹‹å‰ <code>hexo-generator-sitemap</code>
æ’ä»¶ç”Ÿæˆçš„ç«™ç‚¹åœ°å›¾ï¼Œä¼šé»˜è®¤æ”¾åœ¨åœ¨æ ¹ç›®å½•ä¸‹ï¼Œåªéœ€åœ¨ <span class="exturl" data-url="aHR0cHM6Ly9zZWFyY2guZ29vZ2xlLmNvbS9zZWFyY2gtY29uc29sZS9zaXRlbWFwcw==">GSC
çš„ç«™ç‚¹åœ°å›¾é¡µé¢<i class="fa fa-external-link-alt"></i></span> å¡«å¥½ç«™ç‚¹åœ°å›¾çš„ä½ç½®ï¼Œç„¶åç‚¹å‡»æäº¤å³å¯</p>
<figure>
<img data-src="/posts/abac0c46/google_add_sitemap.png" alt="google_add_sitemap">
<figcaption aria-hidden="true">google_add_sitemap</figcaption>
</figure>
<p>ä¸è¿‡å’Œ Bing ä¸åŒï¼ŒGoogle çš„ç«™ç‚¹åœ°å›¾çˆ¬å–éœ€è¦ä¸€å®šçš„æ—¶é—´ï¼Œå¹¶ä¸”ç”±äº <span class="exturl" data-url="aHR0cHM6Ly9zdXBwb3J0Lmdvb2dsZS5jb20vd2VibWFzdGVycy90aHJlYWQvMzEwNTkxNi9zaXRlbWFwLWNvdWxkLW5vdC1iZS1yZWFkLWluLW5ldy1nc2M=">GSC
çš„ bug<i class="fa fa-external-link-alt"></i></span>ï¼Œä¼šå°† <code>ç­‰å¾…ä¸­</code> é”™è¯¯çš„æ˜¾ç¤ºä¸º
<code>æ— æ³•è·å–</code>ï¼Œä¸€èˆ¬éœ€è¦å‡ å¤©çš„æ—¶é—´ï¼Œæ­¤æ—¶åªèƒ½è€å¿ƒç­‰å¾…</p>
<h3 id="bing">Bing</h3>
<h4 id="ä»-gsc-å¯¼å…¥">ä» GSC å¯¼å…¥</h4>
<figure>
<img data-src="/posts/abac0c46/bing_add_website.png" alt="bing_add_website">
<figcaption aria-hidden="true">bing_add_website</figcaption>
</figure>
<p>Bing çš„æµç¨‹å’Œå‰é¢ç±»ä¼¼ï¼Œä¸è¿‡ç”±äºå·²ç»é…ç½®å¥½äº† GSCï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©ç›´æ¥ä»
GSC è¿›è¡Œå¯¼å…¥å³å¯</p>
<h4 id="æ‰‹åŠ¨æ·»åŠ ç½‘ç«™">æ‰‹åŠ¨æ·»åŠ ç½‘ç«™</h4>
<p>å¦‚æœéœ€è¦æ‰‹åŠ¨æ·»åŠ çš„è¯ï¼Œå…¶å®æ­¥éª¤å’Œ Google ä¹Ÿå¾ˆç±»ä¼¼</p>
<figure>
<img data-src="/posts/abac0c46/bing_verify_ownership.png" alt="bing_verify_ownership">
<figcaption aria-hidden="true">bing_verify_ownership</figcaption>
</figure>
<p>è¿™é‡Œä¸€æ ·æ¨èä½¿ç”¨ç¬¬äºŒç§ï¼Œä¹Ÿå°±æ˜¯ HTML Meta æ ‡è®°çš„æ–¹å¼ï¼Œå› ä¸º NexT
ä¸»é¢˜çš„é…ç½®ä¸­å¯¹å…¶è¿›è¡Œæ”¯æŒï¼Œé…ç½®èµ·æ¥æ¯”è¾ƒç®€å•</p>
<p>ç‚¹å‡»å¤åˆ¶ï¼Œè®°å½•ä¸‹å…¶ä¸­çš„æ ‡è®°ä¿¡æ¯ï¼Œä¾‹å¦‚æˆ‘ä»¬è¿™é‡Œå¤åˆ¶çš„åŸå§‹å†…å®¹æ˜¯</p>
<figure class="highlight html"><table><tbody><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"msvalidate.01"</span> <span class="attr">content</span>=<span class="string">"65AB321A829DD5542989CC078C3ABD9E"</span> /&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<p>æ‰€ä»¥åœ¨ Next çš„é…ç½®æ–‡ä»¶ä¸­ <code>_config.next.yml</code>
é…ç½®å¦‚ä¸‹å†…å®¹</p>
<figure class="highlight yml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># Bing Webmaster tools verification.</span></span><br><span class="line"><span class="comment"># See: https://www.bing.com/webmasters</span></span><br><span class="line"><span class="attr">bing_site_verification:</span> <span class="string">65AB321A829DD5542989CC078C3ABD9E</span></span><br></pre></td></tr></tbody></table></figure>
<p>ä¹‹åé‡æ–°ç”Ÿæˆç½‘ç«™ï¼Œå¹¶æ¨é€åˆ° GitHubï¼Œç­‰å¾… GitHub Pages ç”Ÿæˆå®Œæ¯•åï¼Œç‚¹å‡»
<code>éªŒè¯</code> å³å¯</p>
<p>æäº¤ç«™ç‚¹åœ°å›¾ä¹Ÿï¼Œåªéœ€åœ¨ <span class="exturl" data-url="aHR0cHM6Ly93d3cuYmluZy5jb20vd2VibWFzdGVycy9zaXRlbWFwcw==">Bing Webmasters tools
çš„ç«™ç‚¹åœ°å›¾é¡µé¢<i class="fa fa-external-link-alt"></i></span> å¡«å¥½ç«™ç‚¹åœ°å›¾çš„ä½ç½®ï¼Œç„¶åç‚¹å‡» <code>æäº¤</code>
å³å¯</p>
<figure>
<img data-src="/posts/abac0c46/bing_add_sitemap.png" alt="bing_add_sitemap">
<figcaption aria-hidden="true">bing_add_sitemap</figcaption>
</figure>
<p>Bing çš„ç«™ç‚¹åœ°å›¾çˆ¬å–ä¸€èˆ¬å‡ åˆ†é’Ÿå°±ä¼šå®Œæˆï¼Œä¹‹ååªéœ€é™é™ç­‰å¾… Bing
ç»™æˆ‘ä»¬ç½‘ç«™å»ºç«‹ç´¢å¼•å³å¯ï¼Œä¸€èˆ¬æ¥è¯´ä¸€ä¸¤å¤©å°±å¯ä»¥å®Œæˆæ•´ä¸ªç½‘ç«™çš„çˆ¬å–ï¼Œè¿™ç‚¹è¦æ¯”
Google å¿«ä¸å°‘</p>
<h2 id="æ‰‹åŠ¨è¯·æ±‚ç¼–å…¥ç´¢å¼•">æ‰‹åŠ¨è¯·æ±‚ç¼–å…¥ç´¢å¼•</h2>
<p>æ ¹æ®ä¸ªäººè§‚å¯Ÿï¼ŒGoogle
åŠæ—¶è·å–åˆ°ç«™ç‚¹åœ°å›¾åä¼¼ä¹ä¸ä¼šç«‹åˆ»æ ¹æ®ç«™ç‚¹åœ°å›¾çˆ¬å–ç½‘ç«™ï¼Œå› æ­¤æ¨èå†è‡ªè¡Œè¿›è¡Œä¸€æ¬¡æ‰‹åŠ¨è¯·æ±‚ç¼–å…¥ç´¢å¼•</p>
<p>å…·ä½“æµç¨‹ä¸ºï¼š</p>
<ol type="1">
<li><p>ç‚¹å‡» GSC
çš„ã€ç½‘å€æ£€æŸ¥ã€‘æˆ–è€…ç›´æ¥åœ¨é¡¶éƒ¨è¾“å…¥æ è¾“å…¥ç½‘ç«™çš„æ ¹åœ°å€ï¼ˆä¹Ÿå¯ä»¥æ˜¯å…¶ä»–å­é¡µé¢åœ°å€ï¼‰</p>
<figure>
<img data-src="/posts/abac0c46/google_check_website.png" alt="google_check_website">
<figcaption aria-hidden="true">google_check_website</figcaption>
</figure></li>
<li><p> ç­‰å¾…ç»“æœè¿”å›åï¼Œç‚¹å‡»ã€è¯·æ±‚ç¼–å…¥ç´¢å¼•ã€‘å³å¯</p>
<figure>
<img data-src="/posts/abac0c46/google_manual_submit.png" alt="google_manual_submit">
<figcaption aria-hidden="true">google_manual_submit</figcaption>
</figure></li>
</ol>
<p>ä¸ªäººå®æµ‹ï¼Œå¤§æ¦‚éœ€è¦ä¸€ä¸ªæœˆå·¦å³ï¼ŒGoogle
ä¸Šå°±èƒ½æœç´¢åˆ°ç½‘ç«™ä¸Šçš„å¤§å¤šæ•°é¡µé¢äº†</p>
<h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h2>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXJzLmdvb2dsZS5jb20vc2VhcmNoL2RvY3MvYmFzaWNzL2hvdy1zZWFyY2gtd29ya3M/aGw9emgtQ04=">ã€Googleã€‘Google
æœç´¢è¿ä½œæ–¹å¼çš„åŸºç¡€çŸ¥è¯†<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXJzLmdvb2dsZS5jb20vc2VhcmNoL2RvY3M/aGw9emgtQ04=">ã€Googleã€‘æµè§ˆ
Google æœç´¢æ–‡æ¡£ï¼Œæ”¹å–„ç½‘ç«™çš„ SEO è¿‡ç¨‹<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXJzLmdvb2dsZS5jb20vc2VhcmNoL2RvY3MvYWR2YW5jZWQvc2l0ZW1hcHMvb3ZlcnZpZXc/aGw9emgtQ04=">ã€Googleã€‘äº†è§£ç«™ç‚¹åœ°å›¾<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXJzLmdvb2dsZS5jb20vc2VhcmNoL2RvY3MvYmVnaW5uZXIvZ2V0LXN0YXJ0ZWQ/aGw9emgtQ04=">ã€Googleã€‘æ–°æ‰‹å…¥é—¨æŒ‡å—<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9taXplcmkuZ2l0aHViLmlvLzIwMjEvMDQvMTgvaGV4by1zaXRlbWFwLWdvb2dsZS8=">ã€ä¸ªäººåšå®¢ã€‘Hexo
åšå®¢ç«™ç‚¹åœ°å›¾é…ç½®ï¼ˆGoogleï¼‰<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9hc3VyYWRhLnpvbmUvcG9zdC9CbG9nLVNlYXJjaC1FbmdpbmUtSW5kZXgv">ã€ä¸ªäººåšå®¢ã€‘Hexo
åšå®¢ä¸»æµæœç´¢å¼•æ“æ”¶å½•è¯¦ç»†æŒ‡å—<i class="fa fa-external-link-alt"></i></span></li>
</ul>
]]></content>
      <categories>
        <category>Hexo</category>
      </categories>
      <tags>
        <tag>Hexo</tag>
        <tag>NexT</tag>
      </tags>
  </entry>
  <entry>
    <title>Ubuntu ç¯å¢ƒé…ç½®å¤§åˆé›†</title>
    <url>/posts/72a4cdfd.html</url>
    <content><![CDATA[<p>æœ¬æ–‡ä¸»è¦è®°å½•ä¸ªäººä½¿ç”¨ Ubuntu
ä¸­é‡åˆ°çš„å„ç§çç¢é—®é¢˜çš„è§£å†³æ–¹æ³•ï¼Œä»¥åŠç¯å¢ƒé…ç½® <span id="more"></span></p>
<h2 id="ä¿®æ”¹é»˜è®¤ç¼–è¾‘å™¨ä¸º-vim">ä¿®æ”¹é»˜è®¤ç¼–è¾‘å™¨ä¸º vim</h2>
<p>ä¸€èˆ¬ Ubuntu çš„é»˜è®¤ç¼–è¾‘å™¨æ˜¯
nanoï¼Œç”¨èµ·æ¥éå¸¸ä¸é¡ºæ‰‹ï¼Œå¯ä»¥é€šè¿‡ä¸‹é¢å‘½ä»¤ä¿®æ”¹</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">sudo update-alternatives --config editor</span><br><span class="line"><span class="comment"># ç„¶åé€‰æ‹©ä¸º vim.basic å³å¯</span></span><br></pre></td></tr></tbody></table></figure>
<h2 id="è§£å†³æŠ¥é”™-perl-warning-setting-locale-failed">è§£å†³æŠ¥é”™ perl:
warning: Setting locale failed</h2>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">vim .bashrc</span><br><span class="line"><span class="comment"># vim .zshrc</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ–°å¢ä»¥ä¸‹å†…å®¹</span></span><br><span class="line"><span class="built_in">export</span> LC_ALL=<span class="string">"en_US.UTF-8"</span></span><br></pre></td></tr></tbody></table></figure>
<p>ç„¶åé‡æ–°ç™»å½• shell æˆ–è€…æ‰‹åŠ¨æ‰§è¡Œä¸€ä¸‹
<code>export LC_ALL="en_US.UTF-8"</code></p>
<p>ç„¶åå†æ‰§è¡Œ</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">sudo locale-gen en_US.UTF-8</span><br><span class="line">sudo dpkg-reconfigure locales</span><br><span class="line"><span class="comment"># é…ç½®è¿‡ç¨‹ä¸­é€‰æ‹© en_US.UTF-8 ä¸€è·¯ç¡®å®šå³å¯</span></span><br></pre></td></tr></tbody></table></figure>
<h2 id="é…ç½®æ—¶åŒº">é…ç½®æ—¶åŒº</h2>
<p>Ubuntu é»˜è®¤æ—¶é—´æ˜¯ UTC æ—¶é—´ï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹æ—¶åŒºæ¥æ˜¾ç¤ºæœ¬åœ°çš„æ—¶é—´</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹å½“å‰æ—¶åŒº</span></span><br><span class="line">timedatectl</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸çŸ¥é“æ—¶åŒºåå¯ä»¥é€šè¿‡ tzselect è·å–</span></span><br><span class="line">tzselect</span><br><span class="line"></span><br><span class="line"><span class="comment"># é…ç½®å½“å‰æ—¶åŒºä¸º Asia/Shanghai</span></span><br><span class="line">sudo timedatectl set-timezone Asia/Shanghai</span><br></pre></td></tr></tbody></table></figure>
<h2 id="è¿œç¨‹-vnc">è¿œç¨‹ VNC</h2>
<ul>
<li>æœåŠ¡å™¨ </li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># Ubuntu 22.04</span></span><br><span class="line">sudo apt install tigervnc-standalone-server tigervnc-common</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆæ¬¡å¯åŠ¨å¹¶é…ç½®</span></span><br><span class="line">vncserver</span><br><span class="line"></span><br><span class="line"><span class="comment"># å…³é—­å·²å¼€å¯çš„ç¬¬ä¸€ä¸ªå®ä¾‹</span></span><br><span class="line">vncserver -<span class="built_in">kill</span> :1</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯èƒ½éœ€è¦å¼€å¯ç›¸åº”ç«¯å£</span></span><br><span class="line">sudo ufw allow 5901</span><br><span class="line"></span><br><span class="line"><span class="comment"># å–æ¶ˆåªèƒ½æœ¬åœ°è¿æ¥çš„é™åˆ¶</span></span><br><span class="line">vncserver -localhost no</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å®¢æˆ·ç«¯</li>
</ul>
<p>åœ¨ Windows ç›´æ¥ä¸‹è½½ <span class="exturl" data-url="aHR0cHM6Ly93d3cucmVhbHZuYy5jb20vZW4vY29ubmVjdC9kb3dubG9hZC92aWV3ZXIv">VNC
Viewer<i class="fa fa-external-link-alt"></i></span> é…ç½®å¥½ç›¸åº”çš„ IP ä»¥åŠç«¯å£å³å¯</p>
<h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h2>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9tYW43Lm9yZy9saW51eC9tYW4tcGFnZXMvbWFuMS91cGRhdGUtYWx0ZXJuYXRpdmVzLjEuaHRtbA==">ã€manã€‘update-alternatives<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvMjQ5OTc5NC9ob3ctdG8tZml4LWEtbG9jYWxlLXNldHRpbmctd2FybmluZy1mcm9tLXBlcmw=">ã€stackoverflowã€‘How
to fix a locale setting warning from Perl<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9saW51eGhpbnQuY29tL2hvdy10by11c2UtdGltZWRhdGVjdGwtdWJ1bnR1Lw==">ã€linuxhintã€‘timedatectl<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly93d3cubXlmcmVheC5jb20vaG93LXRvLWluc3RhbGwtYW5kLWNvbmZpZ3VyZS12bmMtb24tdWJ1bnR1LTIyLTA0Lw==">ã€myfreaxã€‘å¦‚ä½•åœ¨
Ubuntu 22.04 å®‰è£… VNC<i class="fa fa-external-link-alt"></i></span></li>
</ul>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>nano</tag>
        <tag>vim</tag>
        <tag>perl</tag>
        <tag>timedatectl</tag>
        <tag>VNC</tag>
      </tags>
  </entry>
  <entry>
    <title>LaTeX PPT</title>
    <url>/posts/499c5a19.html</url>
    <content><![CDATA[<h2 id="beamer-æ¨¡æ¿">Beamer æ¨¡æ¿</h2>
<p>PPT æ¨èç”¨ Beamer æ¨¡æ¿æ¥åšï¼Œå¯ä»¥å‚è€ƒ <span class="exturl" data-url="aHR0cHM6Ly93d3cub3ZlcmxlYWYuY29tL2xlYXJuL2xhdGV4L0JlYW1lcg==">Overleaf
ä¸Šç›¸å…³ä»‹ç»<i class="fa fa-external-link-alt"></i></span> æ¥ä½¿ç”¨ <span id="more"></span></p>
<figure>
<img data-src="/posts/499c5a19/Beamer-overview.png" alt="Beamer">
<figcaption aria-hidden="true">Beamer</figcaption>
</figure>
<!-- TODO: Beamer ä»‹ç»å’Œé¢å¤–çš„ç‰¹æ€§ -->
<h2 id="ç‰¹æ€§">ç‰¹æ€§</h2>
<h3 id="frame-ä¸-slide"><code>frame</code> ä¸ <code>slide</code></h3>
<p>Beamer ä¸­é€šå¸¸ä¼šç”¨ä¸€å¯¹
<code>\begin{frame}</code>ã€<code>\end{frame}</code>
æ¥åˆ¶ä½œä¸€é¡µå¹»ç¯ç‰‡ï¼ˆslideï¼‰ï¼Œä¾‹å¦‚</p>
<figure class="highlight tex"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">\begin</span>{frame}</span><br><span class="line">	<span class="keyword">\frametitle</span>{æ ‡é¢˜åç§°}</span><br><span class="line">	ä¸»ä½“å†…å®¹</span><br><span class="line"><span class="keyword">\end</span>{frame}</span><br></pre></td></tr></tbody></table></figure>
<figure>
<img data-src="/posts/499c5a19/Beamer-frame.png" alt="frame">
<figcaption aria-hidden="true">frame</figcaption>
</figure>
<p>ç„¶è€Œå…¶å® frame å¹¶ä¸ç­‰åŒäº slideï¼Œå…¶å® frame å¯¹åº”çš„æ˜¯ä¸€ç»„ slides</p>
<h4 id="pause"><code>\pause</code></h4>
<p>æ·»åŠ  <code>\pause</code> ä¼šå°† <code>\pause</code>
è¯­å¥å‰é¢å†…å®¹å•ç‹¬åœ¨æ–°çš„ä¸€é¡µ slide ä¸Šæ˜¾ç¤ºï¼Œå®ç°äº†ç±»ä¼¼ PPT
åŠ¨ç”»ä¸­çš„ç‚¹å‡»é¡µé¢å‡ºç°ä¸‹ä¸€æ®µæ–‡å­—çš„æ•ˆæœï¼Œä¸‹é¢ç»™å‡ºä»£ç å’Œç”Ÿæˆçš„ PDF
å¸®åŠ©ç†è§£</p>
<figure class="highlight tex"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">\begin</span>{frame}</span><br><span class="line">	<span class="keyword">\frametitle</span>{<span class="keyword">\textbackslash</span> pause ä½¿ç”¨}</span><br><span class="line"></span><br><span class="line">	åœ¨è¿™ç»„å¹»ç¯ç‰‡ä¸­ <span class="keyword">\pause</span></span><br><span class="line">	</span><br><span class="line">	è¿™æ®µæ–‡ä»¶å°†éƒ¨åˆ†å¯è§ <span class="keyword">\pause</span></span><br><span class="line">	</span><br><span class="line">	ç°åœ¨æ‰€æœ‰æ–‡å­—éƒ½å¯ä»¥çœ‹è§äº†</span><br><span class="line"><span class="keyword">\end</span>{frame}</span><br></pre></td></tr></tbody></table></figure>
<figure>
<img data-src="/posts/499c5a19/Beamer-pause.jpg" alt="pause">
<figcaption aria-hidden="true">pause</figcaption>
</figure>
<h4 id="itemize-ä¸­çš„å°–æ‹¬å·-strat-end"><code>itemize</code> ä¸­çš„å°–æ‹¬å·
&lt;strat-end&gt;</h4>
<figure class="highlight tex"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">\begin</span>{frame}</span><br><span class="line"><span class="keyword">\frametitle</span>{item ä¸­çš„å°–æ‹¬å·}</span><br><span class="line"></span><br><span class="line"><span class="keyword">\begin</span>{itemize}</span><br><span class="line">	<span class="keyword">\item</span>&lt;1-&gt; è¯¥æ–‡å­—åœ¨ 1+ é¡µå‡å¯è§</span><br><span class="line">	<span class="keyword">\item</span>&lt;2-3&gt; è¯¥æ–‡å­—åœ¨ 2-3 é¡µå‡å¯è§</span><br><span class="line">	<span class="keyword">\item</span>&lt;3&gt; è¯¥æ–‡å­—ä»…åœ¨ç¬¬ 3 é¡µå‡å¯è§</span><br><span class="line">	<span class="keyword">\item</span>&lt;4-&gt; è¯¥æ–‡å­—åœ¨ 4+ é¡µå‡å¯è§</span><br><span class="line"><span class="keyword">\end</span>{itemize}</span><br><span class="line"><span class="keyword">\end</span>{frame}</span><br></pre></td></tr></tbody></table></figure>
<figure>
<img data-src="/posts/499c5a19/Beamer-item.jpg" alt="item">
<figcaption aria-hidden="true">item</figcaption>
</figure>
<h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h2>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly93d3cub3ZlcmxlYWYuY29tL2xlYXJuL2xhdGV4L0JlYW1lcg==">ã€Overleafã€‘Beamer<i class="fa fa-external-link-alt"></i></span></li>
</ul>
]]></content>
      <categories>
        <category>LaTeX</category>
      </categories>
      <tags>
        <tag>Beamer</tag>
        <tag>LaTeX</tag>
        <tag>todo</tag>
      </tags>
  </entry>
  <entry>
    <title>LaTeX åŸºç¡€ä»‹ç»</title>
    <url>/posts/a4752f87.html</url>
    <content><![CDATA[<h2 id="tex-å’Œ-latex">TeX å’Œ LaTeX</h2>
<p>Tex æ˜¯ä¸€ä¸ªæ’ç‰ˆè½¯ä»¶ï¼Œè€Œ LaTeX æ˜¯åŸºäº TeX å¼€å‘çš„æ’ç‰ˆç³»ç»Ÿï¼Œå¯ä»¥ç†è§£æˆ
LaTeX é€šè¿‡å¯¹ TeX è¿›è¡Œå°è£…ï¼Œä½¿ç”¨ TeX
ä½œä¸ºå®ƒçš„æ ¼å¼åŒ–å¼•æ“ï¼Œä½¿å¾—æ’ç‰ˆæ–‡å­—å˜å¾—æ›´åŠ æ–¹ä¾¿ã€‚</p>
<p>LaTeX åˆ©ç”¨ TeX å¯¹ <code>.tex</code> åç¼€çš„æ–‡ä»¶è¿›è¡Œç¼–è¯‘ï¼Œç”Ÿæˆ
<code>.dvi</code> æ–‡ä»¶ <span id="more"></span></p>
<h2 id="pdftexxetex-å’Œ-luatex">pdfTeXã€XeTeX å’Œ LuaTeX</h2>
<h3 id="ä¸‰è€…çš„ä»‹ç»">ä¸‰è€…çš„ä»‹ç»</h3>
<p>pdfTeXã€XeTeX å’Œ LuaTeX éƒ½æ˜¯åœ¨åŸæœ‰çš„ TeX åœæ­¢æ›´æ–°åè¿›è¡Œä¿®æ”¹å¢å¼ºçš„ TeX
å¼•æ“ï¼Œæä¾›ä¸€äº›é¢å¤–çš„é™„åŠ åŠŸèƒ½ï¼Œä¾‹å¦‚å¯ä»¥ç›´æ¥è¾“å‡ºæˆ pdf æ–‡ä»¶ç­‰ã€‚</p>
<ul>
<li>pdfLaTeX è¡¨ç¤ºå°† LaTeX å®åŒ…ä¸ pdfTeX å¼•æ“ä¸€èµ·ä½¿ç”¨</li>
<li> XeLaTeX è¡¨ç¤ºå°† LaTeX å®åŒ…ä¸ XeTeX å¼•æ“ä¸€èµ·ä½¿ç”¨</li>
<li> LuaLaTeX è¡¨ç¤ºå°† LaTeX å®åŒ…ä¸ LuaTeX å¼•æ“ä¸€èµ·ä½¿ç”¨</li>
</ul>
<h3 id="å„è‡ªçš„ç‰¹æ€§">å„è‡ªçš„ç‰¹æ€§</h3>
<ul>
<li>pdfTeX çš„ä¸»è¦ç‰¹æ€§æ˜¯èƒ½ç›´æ¥ç”Ÿæˆ pdf</li>
<li>XeLaTeX çš„ä¸»è¦ç‰¹æ€§æ˜¯æ”¯æŒ UTF-8 ç¼–ç ï¼Œå› æ­¤ç†è®ºä¸ŠåŸç”Ÿæ”¯æŒä¸­æ–‡å­—ç¬¦</li>
<li> LuaLaTeX çš„ä¸»è¦ç‰¹æ€§é™¤äº†æ”¯æŒ UTF-8 ç¼–å¤–ä¹‹å¤–ï¼Œä¸»è¦æ˜¯å¢åŠ äº† Lua
è„šæœ¬</li>
</ul>
<h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h2>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly93d3cub3ZlcmxlYWYuY29tL2xlYXJuL2xhdGV4L0FydGljbGVzL1doYXQlMjdzX2luX2FfTmFtZSUzQV9BX0d1aWRlX3RvX3RoZV9NYW55X0ZsYXZvdXJzX29mX1RlWCNBbmRfZmluYWxseTpfZnJvbV9UZVhfdG9fcGRmVGVYLjJDX1hlVGVYX2FuZF9MdWFUZVg=">ã€Overleafã€‘pdfTeX,
XeTeX and LuaTeX<i class="fa fa-external-link-alt"></i></span></li>
</ul>
]]></content>
      <categories>
        <category>LaTeX</category>
      </categories>
      <tags>
        <tag>LaTeX</tag>
      </tags>
  </entry>
  <entry>
    <title>LaTeX ç¯å¢ƒé…ç½®</title>
    <url>/posts/4f94956.html</url>
    <content><![CDATA[<h2 id="ç½‘é¡µç¯å¢ƒ">ç½‘é¡µç¯å¢ƒ</h2>
<h3 id="overleaf">Overleaf</h3>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cub3ZlcmxlYWYuY29t">Overleaf<i class="fa fa-external-link-alt"></i></span> æ˜¯ä¸€ä¸ªåœ¨çº¿çš„ LaTeX
ç¼–è¾‘ç¯å¢ƒï¼Œå¯ä»¥é¿å…åœ¨æœ¬åœ°å®‰è£…å’Œé…ç½®çš„è¿‡ç¨‹ï¼ŒåŒæ—¶è¿˜èƒ½å’Œä»–äººå…±äº«ç¼–è¾‘
<span id="more"></span></p>
<h2 id="æœ¬åœ°ç¯å¢ƒ">æœ¬åœ°ç¯å¢ƒ</h2>
<h3 id="tex-live">TeX Live</h3>
<p>TeX Live å¯ä»¥åˆ©ç”¨é•œåƒå®‰è£…èŠ‚çœä¸‹è½½æ—¶é—´</p>
<ul>
<li>ä» <span class="exturl" data-url="aHR0cHM6Ly9taXJyb3JzLnR1bmEudHNpbmdodWEuZWR1LmNuL0NUQU4vc3lzdGVtcy90ZXhsaXZlL0ltYWdlcy8=">æ¸…åé•œåƒç«™<i class="fa fa-external-link-alt"></i></span>
ç›´æ¥ä¸‹è½½</li>
<li>æˆ–è€…åˆ©ç”¨ <span class="exturl" data-url="aHR0cDovL3d3dy50dWcub3JnL3RleGxpdmUvYWNxdWlyZS1pc28uaHRtbCN0b3JyZW50">ç§å­æ–‡ä»¶<i class="fa fa-external-link-alt"></i></span>
BT ä¸‹è½½é•œåƒ</li>
</ul>
<p>å¯ä»¥åœ¨å®‰è£… TeX Live æ—¶åŒæ—¶å‹¾é€‰ä¸Šå®‰è£… TeXworks å‰ç«¯ï¼Œç„¶åå°±å¯ä»¥ä½¿ç”¨
TeXworks ä½œä¸º IDE æ¥ä½¿ç”¨äº†</p>
<h3 id="texstudio">TeXstudio</h3>
<p>TeXstudio ä¹Ÿæ˜¯ä¸€ä¸ªå¾ˆå¥½çš„ LaTeX ç¼–è¾‘è½¯ä»¶ï¼Œå¯ä»¥ç›´æ¥å» <span class="exturl" data-url="aHR0cHM6Ly93d3cudGV4c3R1ZGlvLm9yZy8=">å®˜ç½‘<i class="fa fa-external-link-alt"></i></span> ä¸‹è½½å®‰è£…ï¼Œå¹¶ä¸”æœ‰ä¸­æ–‡ç•Œé¢</p>
<h3 id="vscode">VSCode</h3>
<p>ä¸ªäººæ›´å–œæ¬¢ VSCodeï¼Œé€šè¿‡å®‰è£…æ‰©å±•å¹¶è¿›è¡Œç›¸åº”çš„é…ç½®å³å¯è¾ƒå¥½çš„æ”¯æŒ
LaTeXï¼ŒåŒæ—¶è¿˜æœ‰æ ¼å¼åŒ–å’Œè‡ªåŠ¨è¡¥å…¨ç­‰åŠŸèƒ½ï¼Œéå¸¸æ–¹ä¾¿</p>
<h4 id="å®‰è£…-latex-workshop-æ‰©å±•">å®‰è£… LaTeX Workshop æ‰©å±•</h4>
<p>ç›´æ¥åœ¨ <span class="exturl" data-url="aHR0cHM6Ly9tYXJrZXRwbGFjZS52aXN1YWxzdHVkaW8uY29tL2l0ZW1zP2l0ZW1OYW1lPUphbWVzLVl1LmxhdGV4LXdvcmtzaG9w">VSCode
çš„æ‰©å±•å•†åº—<i class="fa fa-external-link-alt"></i></span> ä¸­æœç´¢ <code>LaTeX Workshop</code> å®‰è£…å³å¯</p>
<h4 id="ç¼–è¯‘é“¾é…ç½®">ç¼–è¯‘é“¾é…ç½®</h4>
<ol type="1">
<li><p>é»˜è®¤é…ç½®</p>
<p>TeX Live å®‰è£…æ—¶ä¼šåŒæ—¶å®‰è£… <code>latexmk</code>, LaTeX Workshop
ä¼šé»˜è®¤ä½¿ç”¨ <code>latexmk</code> æ¥ç¼–è¯‘
<code>.tex</code>ï¼Œæ— éœ€æ‰‹åŠ¨å†é…ç½®</p></li>
<li><p>æ‰‹åŠ¨é…ç½® (å¯é€‰)</p>
<p>æ‰‹åŠ¨é…ç½® LaTeX Workshopï¼Œåœ¨ VSCode çš„é…ç½®æ–‡ä»¶
<code>settings.json</code> ä¸­ç›´æ¥æ‰‹åŠ¨æ·»åŠ å¦‚ä¸‹ä»£ç :</p>
<p>ä¸»è¦å‚è€ƒæ’ä»¶çš„ <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0phbWVzLVl1L0xhVGVYLVdvcmtzaG9wL3dpa2kvQ29tcGlsZSNsYXRleC1yZWNpcGVz">å®˜æ–¹
recipes é…ç½®<i class="fa fa-external-link-alt"></i></span> ä¿®æ”¹</p>
<p></p><figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// é…ç½®ç¼–è¯‘é“¾ï¼Œå¯ä»¥æ ¹æ®éœ€è¦åšä¿®æ”¹</span></span><br><span class="line"><span class="attr">"latex-workshop.latex.recipes"</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">{</span></span><br><span class="line">        <span class="attr">"name"</span><span class="punctuation">:</span> <span class="string">"xelatex ğŸ”ƒ"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"tools"</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">"xelatex"</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">{</span></span><br><span class="line">        <span class="attr">"name"</span><span class="punctuation">:</span> <span class="string">"pdflatex ğŸ”ƒ"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"tools"</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">"pdflatex"</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">{</span></span><br><span class="line">        <span class="attr">"name"</span><span class="punctuation">:</span> <span class="string">"latexmk ğŸ”ƒ"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"tools"</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">"latexmk"</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">{</span></span><br><span class="line">        <span class="attr">"name"</span><span class="punctuation">:</span> <span class="string">"xelatex â bibtex â xelatex`Ã—2"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"tools"</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">"xelatex"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">"bibtex"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">"xelatex"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">"xelatex"</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">{</span></span><br><span class="line">        <span class="attr">"name"</span><span class="punctuation">:</span> <span class="string">"pdflatex â bibtex â pdflatex`Ã—2"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"tools"</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">"pdflatex"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">"bibtex"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">"pdflatex"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">"pdflatex"</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">}</span></span><br><span class="line"><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line"><span class="comment">// å…·ä½“çš„ç¼–è¯‘å‘½ä»¤é…ç½®</span></span><br><span class="line"><span class="attr">"latex-workshop.latex.tools"</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">{</span></span><br><span class="line">        <span class="attr">"name"</span><span class="punctuation">:</span> <span class="string">"latexmk"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"command"</span><span class="punctuation">:</span> <span class="string">"latexmk"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"args"</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">"-synctex=1"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">"-interaction=nonstopmode"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">"-file-line-error"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">"-pdf"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">"-outdir=%OUTDIR%"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">"%DOC%"</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">{</span></span><br><span class="line">        <span class="attr">"name"</span><span class="punctuation">:</span> <span class="string">"xelatex"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"command"</span><span class="punctuation">:</span> <span class="string">"xelatex"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"args"</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">"-synctex=1"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">"-interaction=nonstopmode"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">"-file-line-error"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">"%DOC%"</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">{</span></span><br><span class="line">        <span class="attr">"name"</span><span class="punctuation">:</span> <span class="string">"pdflatex"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"command"</span><span class="punctuation">:</span> <span class="string">"pdflatex"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"args"</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">"-synctex=1"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">"-interaction=nonstopmode"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">"-file-line-error"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">"%DOC%"</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">{</span></span><br><span class="line">        <span class="attr">"name"</span><span class="punctuation">:</span> <span class="string">"bibtex"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"command"</span><span class="punctuation">:</span> <span class="string">"bibtex"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"args"</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">"%DOCFILE%"</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">}</span></span><br><span class="line"><span class="punctuation">]</span><span class="punctuation">,</span></span><br></pre></td></tr></tbody></table></figure><p></p>
<p><!-- TODO: å¼„æ¸…ç¼–è¯‘å‘½ä»¤å’Œç¼–è¯‘é“¾å½“å‰é…ç½®çš„å…·ä½“å«ä¹‰ï¼Œä¸»è¦æ˜¯ bibtex --></p></li>
</ol>
<h4 id="æ­£å‘åŒæ­¥">æ­£å‘åŒæ­¥</h4>
<p>æ­£å‘åŒæ­¥æŒ‡çš„æ˜¯ç¼–è¯‘å®Œæˆåï¼Œåœ¨ <code>.tex</code>
æ–‡ä»¶å†…é€šè¿‡å¿«æ·é”®ï¼Œå¿«é€Ÿå®šä½åˆ°å…‰æ ‡ä½ç½®åœ¨ <code>.tex</code>
çš„å¯¹åº”ä½ç½®ï¼Œæ–¹ä¾¿æŸ¥çœ‹ PDF æ–‡ä»¶</p>
<p>æ¨èæ‰“å¼€æ–‡ä»¶ä¿®æ”¹åï¼Œç¼–è¯‘å®Œæˆåè‡ªåŠ¨æ­£å‘åŒæ­¥ã€‚è¯¥åŠŸèƒ½é€šè¿‡
<code>latex-workshop.synctex.afterBuild.enabled</code> æ¥æ§åˆ¶</p>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">"latex-workshop.synctex.afterBuild.enabled"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="åå‘åŒæ­¥">åå‘åŒæ­¥</h4>
<p>åå‘åŒæ­¥æŒ‡çš„æ˜¯ç¼–è¯‘å®Œæˆåï¼Œåœ¨ PDF æ–‡ä»¶å†…é€šè¿‡å¿«æ·é”®ï¼Œå¿«é€Ÿå®šä½ç‚¹å‡»éƒ¨åˆ†åœ¨
<code>.tex</code> çš„ä½ç½®ï¼Œæ–¹ä¾¿ä¿®æ”¹ <code>.tex</code> æºç </p>
<p>ä¸»è¦å‚è€ƒæ’ä»¶çš„ <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0phbWVzLVl1L0xhVGVYLVdvcmtzaG9wL3dpa2kvVmlldyNzeW5jdGV4">å®˜æ–¹
synctex é…ç½®<i class="fa fa-external-link-alt"></i></span> ä¿®æ”¹</p>
<ol type="1">
<li><p>VSCode å†…éƒ¨ PDF æµè§ˆå™¨</p>
<p>å¦‚æœç›´æ¥ä½¿ç”¨ VSCode æ¥æµè§ˆ PDFï¼Œä¸éœ€è¦é¢å¤–è®¾ç½®ï¼Œå¯ä»¥æ ¹æ®éœ€è¦ä¿®æ”¹
<code>latex-workshop.view.pdf.internal.synctex.keybinding</code>
æ¥ä¿®æ”¹åå‘åŒæ­¥çš„å¿«æ·é”®å³å¯ï¼Œé»˜è®¤ Ctrl åŠ é¼ æ ‡å·¦é”®</p>
<p></p><figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// é»˜è®¤ Ctrl åŠ é¼ æ ‡å·¦é”®</span></span><br><span class="line"><span class="attr">"latex-workshop.view.pdf.internal.synctex.keybinding"</span><span class="punctuation">:</span> <span class="string">"ctrl-click"</span><span class="punctuation">,</span></span><br></pre></td></tr></tbody></table></figure><p></p></li>
<li><p>å¤–éƒ¨ PDF æµè§ˆå™¨</p>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cuc3VtYXRyYXBkZnJlYWRlci5vcmcvZnJlZS1wZGYtcmVhZGVy">SumatraPDF<i class="fa fa-external-link-alt"></i></span>
æ˜¯ä¸€æ¬¾æµè¡Œçš„å°å·§æ–¹ä¾¿çš„å…è´¹ PDF æµè§ˆè½¯ä»¶ã€‚VSCode æ”¯æŒä½¿ç”¨å¤–éƒ¨çš„ PDF
æµè§ˆå™¨æ¥æŸ¥çœ‹ç¼–è¯‘åçš„ PDF æ–‡ä»¶ï¼Œä»¥åŠåå‘æœç´¢åŠŸèƒ½ã€‚ä¸»è¦éœ€è¦å¦‚ä¸‹é…ç½®ï¼š</p>
<p></p><figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// é…ç½®ä¸ºä½¿ç”¨å¤–éƒ¨ PDF æµè§ˆè½¯ä»¶æ¥æµè§ˆ PDF</span></span><br><span class="line"><span class="attr">"latex-workshop.view.pdf.viewer"</span><span class="punctuation">:</span> <span class="string">"external"</span><span class="punctuation">,</span></span><br><span class="line"><span class="comment">// é…ç½®å¤–éƒ¨ PDF æµè§ˆè½¯ä»¶çš„å‘½ä»¤è¡Œä»¥åŠå‚æ•°</span></span><br><span class="line"><span class="attr">"latex-workshop.view.pdf.external.viewer.command"</span><span class="punctuation">:</span> <span class="string">"D:/Program/SumatraPDF/SumatraPDF-3.2-64.exe"</span><span class="punctuation">,</span> <span class="comment">// è‡ªè¡Œä¿®æ”¹è·¯å¾„</span></span><br><span class="line"><span class="attr">"latex-workshop.view.pdf.external.viewer.args"</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="string">"%PDF%"</span></span><br><span class="line"><span class="punctuation">]</span><span class="punctuation">,</span></span><br></pre></td></tr></tbody></table></figure><p></p>
<p>åœ¨ SumatraPDF çš„è®¾ç½® - é€‰é¡¹ä¸­è®¾ç½®åå‘æœç´¢å‘½ä»¤è¡Œ
<code>C:\Users\&lt;user&gt;\AppData\Local\Programs\Microsoft VS Code\Code.exe -g "%f:%l"</code>ï¼ŒCode
çš„è·¯å¾„åº”è¯¥ä¸ºå®Œæ•´çš„ç»å¯¹è·¯å¾„</p></li>
</ol>
<h4 id="å…¶ä»–å¯é€‰é…ç½®">å…¶ä»–å¯é€‰é…ç½®</h4>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// å…³é—­è‡ªåŠ¨ç¼–è¯‘</span></span><br><span class="line"><span class="attr">"latex-workshop.latex.autoBuild.run"</span><span class="punctuation">:</span> <span class="string">"never"</span><span class="punctuation">,</span></span><br><span class="line"><span class="comment">// é»˜è®¤é€‰æ‹©ä¸Šæ¬¡ç¼–è¯‘é“¾</span></span><br><span class="line"><span class="attr">"latex-workshop.latex.recipe.default"</span><span class="punctuation">:</span> <span class="string">"lastUsed"</span></span><br><span class="line"><span class="comment">// å³é”®èœå•</span></span><br><span class="line"><span class="attr">"latex-workshop.showContextMenu"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line"><span class="comment">// å…³é—­ç¼–è¯‘å‡ºé”™çš„å¼¹çª—</span></span><br><span class="line"><span class="attr">"latex-workshop.message.error.show"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">"latex-workshop.message.warning.show"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br></pre></td></tr></tbody></table></figure>
<h2 id="ä¸­æ–‡æ”¯æŒ">ä¸­æ–‡æ”¯æŒ</h2>
<p>è¯¥èŠ‚ä¸»è¦å‚è€ƒ <span class="exturl" data-url="aHR0cHM6Ly9jbi5vdmVybGVhZi5jb20vbGVhcm4vbGF0ZXgvQ2hpbmVzZQ==">Overleaf Chinese<i class="fa fa-external-link-alt"></i></span>
æ–‡æ¡£</p>
<p><strong>æ¨èä½¿ç”¨ XeLaTeX å’Œ LuaLaTeX æ¥ç¼–è¯‘å«æœ‰ä¸­æ–‡å­—ç¬¦çš„
<code>.tex</code> æ–‡ä»¶</strong></p>
<h3 id="xelatex-å’Œ-lualatex">XeLaTeX å’Œ LuaLaTeX</h3>
<ol type="1">
<li>ç›´æ¥ä½¿ç”¨ <code>ctexart</code> æ–‡æ¡£ç±»å³å¯æ”¯æŒä¸­æ–‡</li>
<li>æˆ–è€…ä½¿ç”¨ <code>ctex</code> åŒ…æ¥æ”¯æŒä¸­æ–‡</li>
</ol>
<p>å‚è€ƒä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight tex"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">\documentclass</span>{ctexart}</span><br><span class="line"></span><br><span class="line"><span class="keyword">\begin</span>{document}</span><br><span class="line"></span><br><span class="line"><span class="keyword">\tableofcontents</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">\begin</span>{abstract}</span><br><span class="line">è¿™æ˜¯ç®€ä»‹åŠæ‘˜è¦ã€‚</span><br><span class="line"><span class="keyword">\end</span>{abstract}</span><br><span class="line"></span><br><span class="line"><span class="keyword">\section</span>{å‰è¨€}</span><br><span class="line"></span><br><span class="line"><span class="keyword">\section</span>{å…³äºæ•°å­¦éƒ¨åˆ†}</span><br><span class="line">æ•°å­¦ã€ä¸­è‹±æ–‡çš†å¯ä»¥æ··æ’ã€‚You can intersperse math, Chinese and English (Latin script) without adding extra environments.</span><br><span class="line"></span><br><span class="line">é€™æ˜¯ç¹é«”ä¸­æ–‡ã€‚</span><br><span class="line"></span><br><span class="line"><span class="keyword">\end</span>{document}</span><br></pre></td></tr></tbody></table></figure>
<p>æˆ–è€…</p>
<figure class="highlight tex"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">\documentclass</span>{xxx}</span><br><span class="line"><span class="keyword">\usepackage</span>{ctex}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="xelatex">XeLaTeX</h3>
<p>XeLaTeX è¿˜å¯ä»¥ä½¿ç”¨ <code>xeCJK</code> åŒ…æ¥æ”¯æŒä¸­æ–‡</p>
<p>å‚è€ƒä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight tex"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">\documentclass</span>{article}</span><br><span class="line"><span class="keyword">\usepackage</span>{xeCJK}</span><br><span class="line"><span class="keyword">\begin</span>{document}</span><br><span class="line"></span><br><span class="line"><span class="keyword">\section</span>{å‰è¨€}</span><br><span class="line"></span><br><span class="line"><span class="keyword">\section</span>{å…³äºæ•°å­¦éƒ¨åˆ†}</span><br><span class="line">æ•°å­¦ã€ä¸­è‹±æ–‡çš†å¯ä»¥æ··æ’ã€‚You can intersperse math, Chinese and English (Latin script) without adding extra environments.</span><br><span class="line"></span><br><span class="line">é€™æ˜¯ç¹é«”ä¸­æ–‡ã€‚</span><br><span class="line"><span class="keyword">\end</span>{document}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="pdflatex">pdfLaTeX</h3>
<p>pdfLaTeX å¯¹ä¸­æ–‡æ”¯æŒä¸æ˜¯å¾ˆå¥½ï¼Œåªç”¨ pdaLaTeX çš„è¯éœ€è¦å¼•å…¥
<code>CJKutf8</code> åŒ…ï¼Œå¹¶ä¸”ç”¨ <code>\begin{CJK*}{UTF8}{gbsn}</code> å’Œ
<code>\end{CJK*}</code> åŒ…ä½æ‰€æœ‰çš„ä¸­æ–‡ã€‚</p>
<ul>
<li><code>gbsn</code> å’Œ <code>gkai</code> æ˜¯ç®€ä½“çš„å­—ä½“</li>
<li><code>bsmi</code> å’Œ <code>bkai</code> æ˜¯ç¹ä½“çš„å­—ä½“</li>
</ul>
<p>å‚è€ƒä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight tex"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">\documentclass</span>{article}</span><br><span class="line"><span class="keyword">\usepackage</span>{CJKutf8}</span><br><span class="line"></span><br><span class="line"><span class="keyword">\begin</span>{document}</span><br><span class="line"></span><br><span class="line"><span class="keyword">\begin</span>{CJK*}{UTF8}{gbsn}</span><br><span class="line"></span><br><span class="line"><span class="keyword">\section</span>{å‰è¨€}</span><br><span class="line"></span><br><span class="line"><span class="keyword">\section</span>{å…³äºæ•°å­¦éƒ¨åˆ†}</span><br><span class="line">æ•°å­¦ã€ä¸­è‹±æ–‡çš†å¯ä»¥æ··æ’ã€‚You can intersperse math, Chinese and English (Latin script) without adding extra environments.</span><br><span class="line"></span><br><span class="line"><span class="keyword">\end</span>{CJK*}</span><br><span class="line"></span><br><span class="line"><span class="keyword">\bigskip</span>  <span class="comment">%% Just some white space</span></span><br><span class="line"></span><br><span class="line">You can also insert Latin text in your document</span><br><span class="line"></span><br><span class="line"><span class="keyword">\bigskip</span>  <span class="comment">%% Just some white space</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">\begin</span>{CJK*}{UTF8}{bsmi}</span><br><span class="line">é€™æ˜¯ç¹é«”ä¸­æ–‡ã€‚</span><br><span class="line"><span class="keyword">\end</span>{CJK*}</span><br><span class="line"></span><br><span class="line"><span class="keyword">\end</span>{document}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="ç¼–è¯‘">ç¼–è¯‘</h3>
<ol type="1">
<li><p>é¦–å…ˆ <code>.tex</code>
æ–‡ä»¶åä»¥åŠè·¯å¾„å°½é‡ä¸è¦å«æœ‰ç©ºæ ¼ä»¥åŠä¸­æ–‡å­—ç¬¦</p></li>
<li><p>åœ¨ä½¿ç”¨ <code>latexmk</code> å’Œ VSCode çš„ LaTeX Workshop
æ—¶ï¼Œæ¨èä½¿ç”¨ç¬¬ä¸‰ä¸ªç¼–è¯‘é“¾ <code>Recipe: latexmk (lualatex)</code></p>
<figure>
<img data-src="/posts/4f94956/build-chinese-latex.png" alt="ç¼–è¯‘ä¸­æ–‡ LaTeX">
<figcaption aria-hidden="true">ç¼–è¯‘ä¸­æ–‡ LaTeX</figcaption>
</figure></li>
</ol>
<h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h2>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0phbWVzLVl1L0xhVGVYLVdvcmtzaG9wL3dpa2kvSW5zdGFsbCNyZXF1aXJlbWVudHM=">ã€LaTeX
Workshopã€‘ä¾èµ–<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0phbWVzLVl1L0xhVGVYLVdvcmtzaG9wL3dpa2kvQ29tcGlsZSNsYXRleC1yZWNpcGVz">ã€LaTeX
Workshopã€‘recipes é…ç½®<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0phbWVzLVl1L0xhVGVYLVdvcmtzaG9wL3dpa2kvVmlldyNzeW5jdGV4">ã€LaTeX
Workshopã€‘synctex é…ç½®<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8zODE3ODAxNQ==">ã€çŸ¥ä¹ã€‘ä½¿ç”¨ VSCode
ç¼–å†™ LaTeX<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8xNjY1MjMwNjQ=">ã€çŸ¥ä¹ã€‘Visual
Studio Code é…ç½® LaTeX<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9jbi5vdmVybGVhZi5jb20vbGVhcm4vbGF0ZXgvQ2hpbmVzZQ==">ã€Overleafã€‘Chinese<i class="fa fa-external-link-alt"></i></span></li>
</ul>
]]></content>
      <categories>
        <category>LaTeX</category>
      </categories>
      <tags>
        <tag>LaTeX</tag>
        <tag>todo</tag>
        <tag>VSCode</tag>
      </tags>
  </entry>
  <entry>
    <title>LaTeX è¯­æ³•</title>
    <url>/posts/2033aa70.html</url>
    <content><![CDATA[<p>ä¸­æ–‡æ”¯æŒå‚è€ƒç¯å¢ƒé…ç½®ä¸­çš„ <a href="/posts/4f94956.html#ä¸­æ–‡æ”¯æŒ">å†…å®¹</a>ï¼Œåœ¨è¿™é‡Œä¸åšé‡å¤
<span id="more"></span></p>
<h2 id="é•¿åº¦">é•¿åº¦</h2>
<p>å¸¸ç”¨çš„é•¿åº¦å•ä½</p>
<table>
<thead>
<tr class="header">
<th>å•ä½</th>
<th>å«ä¹‰</th>
<th>æ¢ç®—æˆ pt</th>
<th> æ¢æˆç®—æˆ mm</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>pt</td>
<td> åŸºæœ¬å•ä½</td>
<td> 1 pt</td>
<td>0.35146 mm</td>
</tr>
<tr class="even">
<td>mm</td>
<td> æ¯«ç±³</td>
<td> 2.84 pt</td>
<td>1 mm</td>
</tr>
<tr class="odd">
<td>cm</td>
<td> å˜ç±³</td>
<td> 28.4 pt</td>
<td>10 mm</td>
</tr>
<tr class="even">
<td>in</td>
<td> è‹±å¯¸</td>
<td> 72.27 pt</td>
<td>0.35146 mm</td>
</tr>
<tr class="odd">
<td>ex</td>
<td> å½“å‰å­—ä½“çš„ x å­—æ¯é«˜åº¦</td>
<td> -</td>
<td>-</td>
</tr>
<tr class="even">
<td>em</td>
<td> å½“å‰å­—ä½“çš„ m å­—æ¯å®½åº¦</td>
<td> -</td>
<td>-</td>
</tr>
</tbody>
</table>
<h2 id="ç©ºè¡Œ">ç©ºè¡Œ</h2>
<figure class="highlight tex"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">\vspace</span>{length}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="ç©ºæ ¼">ç©ºæ ¼</h2>
<figure class="highlight tex"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">\hspace</span>{length}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="è¶…é“¾æ¥">è¶…é“¾æ¥</h2>
<figure class="highlight tex"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">% å¼€å¯é“¾æ¥é¢œè‰²é…ç½®ï¼Œå¹¶é…ç½®ä¸ºè“è‰²</span></span><br><span class="line"><span class="keyword">\usepackage</span>[colorlinks=true, allcolors=blue]{hyperref}</span><br><span class="line"></span><br><span class="line"><span class="keyword">\url</span>{<span class="link">https://ywang-wnlo.github.io/posts/2033aa70.html</span>}</span><br><span class="line"><span class="keyword">\href</span>{<span class="link">https://ywang-wnlo.github.io/posts/2033aa70.html</span>}{LaTeX è¯­æ³•}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="æ•°å­¦å…¬å¼">æ•°å­¦å…¬å¼</h2>
<h3 id="æ®µè½ä¸­éšå¼">æ®µè½ä¸­ï¼ˆéšå¼ï¼‰</h3>
<p>ä¸‰ç§å‡å¯ï¼Œä»»æ„é€‰æ‹©ï¼Œä»¥ E=mc<sup>2</sup> ä¸ºä¾‹</p>
<figure class="highlight tex"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">\(</span>E=mc<span class="built_in">^</span>2<span class="keyword">\)</span></span><br><span class="line"><span class="built_in">$</span>E=mc<span class="built_in">^</span>2<span class="built_in">$</span></span><br><span class="line"><span class="keyword">\begin</span>{math}E=mc<span class="built_in">^</span>2<span class="keyword">\end</span>{math}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="å•ç‹¬æˆæ®µæ˜¾å¼">å•ç‹¬æˆæ®µï¼ˆæ˜¾å¼ï¼‰</h3>
<p>ä¸‰ç§å‡å¯ï¼Œä»»æ„é€‰æ‹©</p>
<figure class="highlight tex"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">\[</span>E=mc<span class="built_in">^</span>2<span class="keyword">\]</span></span><br><span class="line"><span class="keyword">\begin</span>{displaymath}E=mc<span class="built_in">^</span>2<span class="keyword">\end</span>{displaymath}</span><br><span class="line"><span class="keyword">\begin</span>{equation}E=mc<span class="built_in">^</span>2<span class="keyword">\end</span>{equation}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="å±…ä¸­å·¦å¯¹é½å³å¯¹é½">å±…ä¸­ï¼Œå·¦å¯¹é½ï¼Œå³å¯¹é½</h2>
<h3 id="å±…ä¸­">å±…ä¸­</h3>
<figure class="highlight tex"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">\begin</span>{center}</span><br><span class="line">  balabala</span><br><span class="line"><span class="keyword">\end</span>{center}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="å·¦å¯¹é½">å·¦å¯¹é½</h3>
<figure class="highlight tex"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">\begin</span>{flushleft}</span><br><span class="line">  balabala</span><br><span class="line"><span class="keyword">\end</span>{flushleft}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="å³å¯¹é½">å³å¯¹é½</h3>
<figure class="highlight tex"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">\begin</span>{flushright}</span><br><span class="line">  balabala</span><br><span class="line"><span class="keyword">\end</span>{flushright}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="å‚è€ƒæ–‡çŒ®é…ç½®">å‚è€ƒæ–‡çŒ®é…ç½®</h2>
<figure class="highlight tex"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">\bibliographystyle</span>{stylename}</span><br><span class="line"><span class="keyword">\bibliography</span>{bibfile}</span><br></pre></td></tr></tbody></table></figure>
<p>å…¶ä¸­ <code>bibfile</code> ä¸º <code>.bib</code> æ–‡ä»¶çš„åï¼Œè€Œ
<code>stylename</code> æ˜¯é£æ ¼åç§°ï¼Œä»¥ overleaf ä¸ºä¾‹ï¼Œæœ‰å¦‚ä¸‹é€‰é¡¹</p>
<table>
<colgroup>
<col style="width: 57%">
<col style="width: 42%">
</colgroup>
<thead>
<tr class="header">
<th>stylename</th>
<th>output</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>abbrc</td>
<td><img data-src="/posts/2033aa70/BibtexStylesAbbrc.png" alt="BibtexStylesAbbrc"></td>
</tr>
<tr class="even">
<td>acm</td>
<td><img data-src="/posts/2033aa70/BibtexStylesAcm.png" alt="BibtexStylesAcm"></td>
</tr>
<tr class="odd">
<td>alpha</td>
<td><img data-src="/posts/2033aa70/BibtexStylesAlpha.png" alt="BibtexStylesAlpha"></td>
</tr>
<tr class="even">
<td>apalike</td>
<td><img data-src="/posts/2033aa70/BibtexStylesApalike.png" alt="BibtexStylesApalike"></td>
</tr>
<tr class="odd">
<td>ieeetr</td>
<td><img data-src="/posts/2033aa70/BibtexStylesIeeetr.png" alt="BibtexStylesIeeetr"></td>
</tr>
<tr class="even">
<td>plain</td>
<td><img data-src="/posts/2033aa70/BibtexStylesPlain.png" alt="BibtexStylesPlain"></td>
</tr>
<tr class="odd">
<td>siam</td>
<td><img data-src="/posts/2033aa70/BibtexStylesSiam.png" alt="BibtexStylesSiam"></td>
</tr>
<tr class="even">
<td>unsrt</td>
<td><img data-src="/posts/2033aa70/BibtexStylesUnsrt.png" alt="BibtexStylesUnsrt"></td>
</tr>
</tbody>
</table>
<h2 id="todo">TODO</h2>
<h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h2>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9lbi53aWtpYm9va3Mub3JnL3dpa2kvTGFUZVgvTGVuZ3Rocw==">ã€ç»´åŸºç™¾ç§‘ã€‘LaTeX
Lengths<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9lbi53aWtpYm9va3Mub3JnL3dpa2kvTGFUZVgvSHlwZXJsaW5rcw==">ã€ç»´åŸºç™¾ç§‘ã€‘LaTeX
Hyperlinks<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly93d3cub3ZlcmxlYWYuY29tL2xlYXJuL2xhdGV4L01hdGhlbWF0aWNhbF9leHByZXNzaW9ucw==">ã€overleafã€‘Mathematical
expressions<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly93d3cub3ZlcmxlYWYuY29tL2xlYXJuL2xhdGV4L0JpYnRleF9iaWJsaW9ncmFwaHlfc3R5bGVz">ã€overleafã€‘Bibtex
bibliography styles<i class="fa fa-external-link-alt"></i></span></li>
</ul>
]]></content>
      <categories>
        <category>LaTeX</category>
      </categories>
      <tags>
        <tag>LaTeX</tag>
        <tag>todo</tag>
      </tags>
  </entry>
  <entry>
    <title>åˆ©ç”¨ RocksDB + ZenFS æµ‹è¯• ZNS çš„ç¯å¢ƒæ­å»ºå’Œä½¿ç”¨</title>
    <url>/posts/b8506868.html</url>
    <content><![CDATA[<p>æœ¬æ–‡ä¸»è¦è®°å½•è‡ªå·±åœ¨åˆ©ç”¨ <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2ZhY2Vib29rL3JvY2tzZGI=">RocksDB<i class="fa fa-external-link-alt"></i></span> + <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3dlc3Rlcm5kaWdpdGFsY29ycG9yYXRpb24vemVuZnM=">ZenFS<i class="fa fa-external-link-alt"></i></span> æµ‹è¯•
<span class="exturl" data-url="aHR0cHM6Ly96b25lZHN0b3JhZ2UuaW8vZG9jcy9pbnRyb2R1Y3Rpb24vem5z">ZNS<i class="fa fa-external-link-alt"></i></span>
è¿‡ç¨‹ä¸­é‡åˆ°çš„ä¸€äº›é—®é¢˜ä»¥åŠç›¸åº”çš„è§£å†³åŠæ³• <span id="more"></span></p>
<h2 id="é…ç½®-zns-ç¯å¢ƒ">é…ç½® ZNS ç¯å¢ƒ</h2>
<p>ZNS å…¨ç§° Zoned Namespacesï¼Œä¸­æ–‡ä¸€èˆ¬è¯‘ä¸ºåˆ†åŒºå‘½åç©ºé—´ï¼Œå½“ä»Šæœ€å¸¸è§çš„ ZNS
è®¾å¤‡ç±»å‹æ˜¯åŸºäºé—ªå­˜çš„ SSDã€‚ä½†æ˜¯ ZNS SSD
ç›®å‰è¿˜æ²¡æœ‰åœ¨æ¶ˆè´¹çº§å¸‚åœºå‡ºè´§ï¼Œåªèƒ½é€šè¿‡è½¯ä»¶æ¨¡æ‹Ÿæ¥æ­å»ºç¯å¢ƒ</p>
<h3 id="é…ç½®-femu">é…ç½® FEMU</h3>
<p>å®˜ç½‘ç»™äº† <span class="exturl" data-url="aHR0cHM6Ly96b25lZHN0b3JhZ2UuaW8vZG9jcy9nZXR0aW5nLXN0YXJ0ZWQvemJkLWVtdWxhdGlvbiN6b25lZC1ibG9jay1kZXZpY2UtZW11bGF0aW9uLXdpdGgtbnVsbF9ibGs=">null_blk<i class="fa fa-external-link-alt"></i></span>
ä»¥åŠ <span class="exturl" data-url="aHR0cHM6Ly96b25lZHN0b3JhZ2UuaW8vZG9jcy9nZXR0aW5nLXN0YXJ0ZWQvemJkLWVtdWxhdGlvbiNudm1lLXpvbmVkLW5hbWVzcGFjZS1kZXZpY2UtZW11bGF0aW9uLXdpdGgtcWVtdQ==">QEMU<i class="fa fa-external-link-alt"></i></span>
çš„é…ç½®æ–¹æ³•ï¼Œä½†æ˜¯ä¸ªäººå¯¹ <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3Z0ZXNzL0ZFTVU=">FEMU<i class="fa fa-external-link-alt"></i></span>
æ¯”è¾ƒç†Ÿæ‚‰ï¼Œå¯ä»¥ç†è§£æˆ QEMU çš„ forkï¼Œæ”¯æŒæ¨¡æ‹Ÿå›ºæ€ç›˜å†…éƒ¨å›ºä»¶é€»è¾‘ï¼Œäºæ˜¯é‡‡ç”¨
FEMU æ¨¡æ‹Ÿ ZNS æ­å»ºç¯å¢ƒ</p>
<p>FEMU çš„ç¯å¢ƒæ­å»ºæ¯”è¾ƒç®€å•ï¼Œå‚è€ƒå…¶ <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3Z0ZXNzL0ZFTVUjaW5zdGFsbGF0aW9u">å®˜æ–¹ä»“åº“ README<i class="fa fa-external-link-alt"></i></span>
æ“ä½œå³å¯</p>
<p><strong>å®¹æ˜“è¸©å‘ï¼š</strong>ä½†æ˜¯éœ€è¦æ³¨æ„ ZNS å¯¹ Linux
å†…æ ¸ç‰ˆæœ¬æœ‰è¦æ±‚ï¼Œ<strong>å¿…é¡»åœ¨ 5.10 ä»¥ä¸Š</strong>ï¼Œå› æ­¤æ¨èå®‰è£… Ubuntu
22.04 LTSã€‚
ä¸å»ºè®®æ‰‹åŠ¨æ›´æ–°å†…æ ¸ï¼Œè¿‡ç¨‹å¤æ‚è€—æ—¶ï¼Œè€Œä¸”ï¼ˆ<code>sudo make headers_install</code>
å®‰è£…å†…æ ¸ç”¨æˆ·å¤´æ–‡ä»¶è¿‡ç¨‹ä¸­ï¼‰å­˜åœ¨ä¸€å®šçš„é£é™©æ€§</p>
<h3 id="qemu-åˆ¶ä½œå’Œå®‰è£…ç³»ç»Ÿé•œåƒ">QEMU åˆ¶ä½œå’Œå®‰è£…ç³»ç»Ÿé•œåƒ</h3>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># ä¸‹è½½ Ubuntu é•œåƒ</span></span><br><span class="line">wget https://releases.ubuntu.com/22.04.1/ubuntu-22.04.1-live-server-amd64.iso</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ¶ä½œç£ç›˜é•œåƒ</span></span><br><span class="line">qemu-img create -f qcow2 u22s.qcow2 80G</span><br><span class="line"></span><br><span class="line"><span class="comment"># ubuntu é•œåƒæŒ‚åœ¨ cdrom ä¸Šå¯åŠ¨</span></span><br><span class="line"><span class="comment"># å®‰è£…è¿‡ç¨‹éœ€è¦é€šè¿‡ vnc è¿æ¥æ“ä½œï¼Œç«¯å£å· 5901</span></span><br><span class="line">qemu-system-x86_64 -m 2G -cdrom ubuntu-22.04.1-live-server-amd64.iso -hda u22s.qcow2 -boot d -vnc :1</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…å®Œæˆåé‡å¯ï¼Œå† vnc è¿æ¥ä¸€æ¬¡ï¼Œä¿®æ”¹å†…æ ¸å¯åŠ¨å‚æ•°</span></span><br><span class="line">qemu-system-x86_64 -m 2G -hda u22s.qcow2 -vnc :1</span><br></pre></td></tr></tbody></table></figure>
<p>ç„¶ååœ¨è™šæ‹Ÿå†…å°†å†…æ ¸å¯åŠ¨æ—¶è¾“å‡ºæ”¹ä¸ºæ‰“å°åˆ°ä¸²å£</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># åœ¨è™šæ‹Ÿæœºå†…</span></span><br><span class="line">sudo vim /etc/default/grub</span><br></pre></td></tr></tbody></table></figure>
<p>ä¿è¯æŒ‰ç…§ä¸‹é¢çš„é…ç½®</p>
<figure class="highlight ini"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># ç”¨äºä¿è¯ grub ç•Œé¢èƒ½è¾“å‡ºåˆ°å±å¹•</span></span><br><span class="line"><span class="comment">#GRUB_TIMEOUT_STYLE=hidden</span></span><br><span class="line"><span class="attr">GRUB_TIMEOUT</span>=<span class="number">3</span></span><br><span class="line"><span class="attr">GRUB_TERMINAL</span>=serial</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”¨äºä¿è¯å†…æ ¸å¯åŠ¨æ—¶èƒ½è¾“å‡ºåˆ°å±å¹•</span></span><br><span class="line"><span class="attr">GRUB_CMDLINE_LINUX</span>=<span class="string">"ip=dhcp console=ttyS0,115200"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (å¯é€‰)å±è”½å­èœå•å’Œ recovery å†…æ ¸ï¼Œæ–¹ä¾¿å¿«é€Ÿåˆ‡æ¢å†…æ ¸</span></span><br><span class="line"><span class="attr">GRUB_DISABLE_SUBMENU</span>=y</span><br><span class="line"><span class="attr">GRUB_DISABLE_RECOVERY</span>=<span class="string">"true"</span></span><br></pre></td></tr></tbody></table></figure>
<p>ç„¶åæ›´æ–°é‡å¯å³å¯</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># æ›´æ–° grub</span></span><br><span class="line">sudo update-grub</span><br><span class="line"><span class="comment"># sudo update-grub2</span></span><br><span class="line">sudo poweroff</span><br></pre></td></tr></tbody></table></figure>
<p>ä¹‹åå°±å¯ä»¥ä¸éœ€è¦ vnc è¿æ¥äº†ï¼Œå¯ä»¥åŠ ä¸Š <code>-nographic</code>
ä½¿ç”¨äº†ï¼Œä¾‹å¦‚</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># ä¸¾ä¾‹</span></span><br><span class="line">qemu-system-x86_64 -enable-kvm -cpu host -smp=16 -m 4G -hda u22s.qcow2 -nographic</span><br></pre></td></tr></tbody></table></figure>
<h2 id="é…ç½®-rocksdb-ç¯å¢ƒ">é…ç½® RocksDB ç¯å¢ƒ</h2>
<p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2ZhY2Vib29rL3JvY2tzZGIvYmxvYi9tYWluL0lOU1RBTEwubWQ=">RocksDB
å®˜æ–¹ä»“åº“çš„ Wiki<i class="fa fa-external-link-alt"></i></span> æœ‰è¾ƒä¸ºè¯¦ç»†çš„å®‰è£…æŒ‡å¯¼</p>
<h3 id="ç¯å¢ƒä»¥åŠä¾èµ–å®‰è£…">ç¯å¢ƒä»¥åŠä¾èµ–å®‰è£…</h3>
<p>ä»¥ Ubuntu ä¸ºä¾‹ï¼š</p>
<p><strong>å®¹æ˜“è¸©å‘ï¼š</strong>ä¸€å®šè¦è®°å¾—æŒ‰ç…§é¡ºåºæ¥ï¼Œå…ˆå®‰è£…å¥½æ‰€æœ‰ä¾èµ–å†ç¼–è¯‘</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># åŸºæœ¬çš„ç¼–è¯‘å·¥å…·ç­‰ä¸è¿‡å¤šä»‹ç»</span></span><br><span class="line"><span class="comment"># sudo apt install build-essential</span></span><br><span class="line"><span class="comment"># sudo apt install pkg-config</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># gflags</span></span><br><span class="line">sudo apt install libgflags-dev</span><br><span class="line"></span><br><span class="line"><span class="comment"># å‹ç¼©åº“ï¼Œé€‰ä¸€ä¸ªå°±è¡Œ</span></span><br><span class="line">sudo apt install libsnappy-dev</span><br><span class="line"><span class="comment"># sudo apt install zlib1g-dev</span></span><br><span class="line"><span class="comment"># sudo apt install libbz2-dev</span></span><br><span class="line"><span class="comment"># sudo apt install liblz4-dev</span></span><br><span class="line"><span class="comment"># sudo apt install libzstd-dev</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="ç¼–è¯‘-rocksdb-åº“ä»¥åŠæµ‹è¯•å·¥å…·">ç¼–è¯‘ RocksDB åº“ä»¥åŠæµ‹è¯•å·¥å…·</h3>
<p>å¦‚æœè¦åœ¨ ZNS ä¸Šæµ‹è¯•ï¼Œå¯ä»¥æš‚æ—¶è·³è¿‡è¯¥å°èŠ‚ï¼Œç­‰é…ç½®å¥½ ZenFS åå†è¿›è¡Œ</p>
<p>å¦‚æœè¦ç”¨ YCSB æ¥æµ‹è¯•ï¼Œå°±éœ€è¦ç¼–è¯‘ Java ç‰ˆæœ¬çš„ jar åŒ…ï¼Œå…·ä½“è¿‡ç¨‹å¯ä»¥å‚è€ƒ
<a href="/posts/4bc1e607.html">è¿™ç¯‡åšæ–‡</a></p>
<p>ç”¨ <code>db_bench</code> æµ‹è¯•å°±ç›´æ¥ <code>make db_bench</code>
å³å¯ï¼Œå¯ä»¥åŠ ä¸Š <code>DEBUG_LEVEL=0</code> ä¿è¯ç¼–è¯‘æˆ release ç‰ˆæœ¬</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># ç¼–è¯‘æµ‹è¯•å·¥å…·</span></span><br><span class="line">DEBUG_LEVEL=0 make -j db_bench</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…ç¼–è¯‘å¥½çš„ RocksDB åº“</span></span><br><span class="line">sudo make install</span><br></pre></td></tr></tbody></table></figure>
<p><strong>å®¹æ˜“è¸©å‘ï¼š</strong>å¦‚æœ <code>-j</code>
ä¼šå…¨æ ¸ä¸€èµ·ç¼–è¯‘ï¼Œåœ¨æ ¸å¤šå†…å­˜å°‘çš„æƒ…å†µä¸‹å¯èƒ½ä¼šæŠ¥å†…å­˜èµ„æºä¸è¶³çš„é”™è¯¯ï¼Œå¯ä»¥å‚è€ƒ
<span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDc5NjY3MC9hcnRpY2xlL2RldGFpbHMvMTIxMjM0NDQ2">è¿™ç¯‡åšå®¢<i class="fa fa-external-link-alt"></i></span>
åˆ©ç”¨ swap â€œå¢åŠ â€ å¯ç”¨å†…å­˜å¤§å°ï¼Œæˆ–è€…é™åˆ¶ä¸‹ç¼–è¯‘çš„å¹¶å‘åº¦ï¼Œä¾‹å¦‚
<code>-j8</code></p>
<p>åˆ©ç”¨ <code>db_bench</code> æµ‹è¯•å¯ä»¥å‚è€ƒ <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2ZhY2Vib29rL3JvY2tzZGIvd2lraS9QZXJmb3JtYW5jZS1CZW5jaG1hcmtz">å®˜æ–¹æµ‹è¯•<i class="fa fa-external-link-alt"></i></span>
çš„æ–¹å¼ï¼Œåˆ©ç”¨ <a href="https://github.com/facebook/rocksdb/blob/main/tools/benchmark.sh"><code>benchmark.sh</code></a>
æ¥æµ‹è¯•ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ç›´æ¥è¿è¡Œ <code>db_bench</code></p>
<h2 id="é…ç½®-zenfs-ç¯å¢ƒ">é…ç½® ZenFS ç¯å¢ƒ</h2>
<p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3dlc3Rlcm5kaWdpdGFsY29ycG9yYXRpb24vemVuZnMvYmxvYi9tYXN0ZXIvUkVBRE1FLm1k">ZenFS
å®˜æ–¹ä»“åº“<i class="fa fa-external-link-alt"></i></span>å…¶å®ç»™äº†ç›¸åº”çš„æŒ‡å¯¼ï¼Œè¿™é‡Œé‡æ–°æ¢³ç†ä¸‹</p>
<h3 id="å®‰è£…-libzbd">å®‰è£… libzbd</h3>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># å®‰è£…ç¼–è¯‘å·¥å…·</span></span><br><span class="line">sudo apt install m4</span><br><span class="line">sudo apt install autoconf</span><br><span class="line">sudo apt install automake</span><br><span class="line">sudo apt install libtool</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‹‰å–æºç </span></span><br><span class="line"><span class="comment"># git clone https://github.com/westerndigitalcorporation/libzbd.git</span></span><br><span class="line">git <span class="built_in">clone</span> git@github.com:westerndigitalcorporation/libzbd.git</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¼–è¯‘</span></span><br><span class="line"><span class="built_in">cd</span> libzbd</span><br><span class="line">sh ./autogen.sh</span><br><span class="line">./configure</span><br><span class="line">make</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…</span></span><br><span class="line">sudo make install</span><br></pre></td></tr></tbody></table></figure>
<h3 id="zenfs-æ’ä»¶ç¼–è¯‘">ZenFS æ’ä»¶ç¼–è¯‘</h3>
<p>ç„¶åéœ€è¦åˆ‡æ¢å› RocksDB çš„ç›®å½•ï¼Œå°† ZenFS åŠ å…¥å…¶ä¸­è¿›è¡Œç¼–è¯‘</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># æ‹‰å–æºç </span></span><br><span class="line"><span class="comment"># git clone https://github.com/facebook/rocksdb.git</span></span><br><span class="line"><span class="comment"># git clone git@github.com:facebook/rocksdb.git</span></span><br><span class="line"><span class="built_in">cd</span> rocksdb</span><br><span class="line"><span class="comment"># git clone https://github.com/westerndigitalcorporation/zenfs plugin/zenfs</span></span><br><span class="line">git <span class="built_in">clone</span> git@github.com:westerndigitalcorporation/zenfs plugin/zenfs</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¼–è¯‘æµ‹è¯•å·¥å…·</span></span><br><span class="line">DEBUG_LEVEL=0 ROCKSDB_PLUGINS=zenfs make -j db_bench</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…ç¼–è¯‘å¥½çš„ RocksDB åº“</span></span><br><span class="line">sudo DEBUG_LEVEL=0 ROCKSDB_PLUGINS=zenfs make install</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¼–è¯‘å¿…è¦çš„ ZenFS å·¥å…·</span></span><br><span class="line"><span class="built_in">cd</span> plugin/zenfs/util</span><br><span class="line">make -j</span><br></pre></td></tr></tbody></table></figure>
<p>è‡³æ­¤æ‰€æœ‰æµ‹è¯•éœ€è¦çš„ç¯å¢ƒå·²ç»åŸºæœ¬æ­å»ºå¥½äº†</p>
<h2 id="æµ‹è¯•">æµ‹è¯•</h2>
<p>æ¥ä¸‹æ¥ç®€å•ä»‹ç»ä¸‹æµ‹è¯•è¿‡ç¨‹ï¼Œå‡è®¾ ZNS å›ºæ€ç›˜çš„è®¾å¤‡åä¸º
<code>nvme1n1</code></p>
<h3 id="åˆ©ç”¨-zenfs-çš„æµ‹è¯•è„šæœ¬æµ‹è¯•">åˆ©ç”¨ zenfs çš„æµ‹è¯•è„šæœ¬æµ‹è¯•</h3>
<p>zenfs å†…ç½®äº†ä¸€ä¸ªæµ‹è¯•è„šæœ¬ï¼Œåªéœ€æŒ‡å®šè®¾å¤‡åã€‚è„šæœ¬ä¼šè®¾ç½® IO
è°ƒåº¦å™¨ï¼Œåˆ¶ä½œæ–‡ä»¶ç³»ç»Ÿä»¥åŠè‡ªåŠ¨é…ç½® RocksDB
å‚æ•°ï¼Œä½†æ˜¯å‚æ•°é…ç½®çš„ä¸å¤Ÿåˆç†ï¼Œéœ€è¦è‡ªè¡Œä¿®æ”¹</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> rocksdb</span><br><span class="line">sudo ./plugin/zenfs/tests/zenfs_base_performance.sh nvme1n1</span><br></pre></td></tr></tbody></table></figure>
<p>è¯¥è„šæœ¬ä¼šè¿è¡Œå¤šä¸ªæµ‹è¯•ï¼Œè€Œä¸”æ¯ä¸ªæµ‹è¯•ä¼šè¿è¡Œå¤šä¸ªä¸åŒçš„ value
å¤§å°ï¼Œè¿è¡Œæ—¶é—´è¾ƒé•¿ï¼Œæœ€åçš„æµ‹è¯•ç»“æœæ±‡æ€»åœ¨
<code>results/zenfs-nvme1n1-baseline_performance</code> ç›®å½•ä¸‹</p>
<h3 id="ç›´æ¥-db_bench-æµ‹è¯•">ç›´æ¥ db_bench æµ‹è¯•</h3>
<p>é¦–å…ˆé…ç½®åº•å±‚ IO è°ƒåº¦å™¨ä¸º <code>mq-deadline</code>
ç”¨æˆ·ä¿æŒæœ‰åºæ€§ï¼ˆå› ä¸º ZNS åªæ”¯æŒè¿½åŠ å†™</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> mq-deadline | sudo <span class="built_in">tee</span> /sys/block/nvme1n1/queue/scheduler</span><br></pre></td></tr></tbody></table></figure>
<p><strong>å®¹æ˜“è¸©å‘ï¼š</strong>åˆ©ç”¨ <code>zenfs</code> åˆ›å»º ZenFS
æ–‡ä»¶ç³»ç»Ÿï¼Œå…¶ä¸­ <strong><code>zbd</code>
åç›´æ¥ç»™å‡ºè®¾å¤‡å</strong>å³å¯ï¼Œä¸éœ€è¦ç»™å‡ºè®¾å¤‡è·¯å¾„ï¼›è€Œä¸”éœ€è¦æŒ‡å®š
<code>aux_path</code> ç”¨äºå­˜æ”¾ LOG å’Œ LOCK æ–‡ä»¶ï¼Œæ¨èæ”¾åœ¨é ZNS
è®¾å¤‡ä¸Šï¼Œå¹¶ä¸”ä½¿ç”¨<strong>ç»å¯¹è·¯å¾„</strong></p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~</span><br><span class="line"><span class="built_in">mkdir</span> zenfs-aux</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> rocksdb</span><br><span class="line">sudo ./plugin/zenfs/util/zenfs mkfs --zbd=nvme1n1 --aux-path=/home/femu/zenfs-aux</span><br></pre></td></tr></tbody></table></figure>
<p>åˆ¶ä½œå¥½æ–‡ä»¶ç³»ç»Ÿåï¼Œå°±å¯ä»¥ç”¨ <code>db_bench</code> è¿›è¡Œæµ‹è¯•äº†</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> rocksdb</span><br><span class="line">sudo ./db_bench --fs_uri=zenfs://dev:nvme1n1 --benchmarks=fillrandom --use_direct_io_for_flush_and_compaction</span><br></pre></td></tr></tbody></table></figure>
<h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h2>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2ZhY2Vib29rL3JvY2tzZGI=">ã€GitHubã€‘RocksDB<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3dlc3Rlcm5kaWdpdGFsY29ycG9yYXRpb24vemVuZnM=">ã€GitHubã€‘ZenFS<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly96b25lZHN0b3JhZ2UuaW8vZG9jcy9pbnRyb2R1Y3Rpb24vem5z">ã€zonedstorageã€‘ZNS<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3Z0ZXNzL0ZFTVU=">ã€GitHubã€‘FEMU<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly93d3cucWVtdS5vcmcvZG9jcy9tYXN0ZXIvc3lzdGVtL3FlbXUtbWFucGFnZS5odG1s">ã€QEMUã€‘QEMU
User Documentation<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9lbi53aWtpYm9va3Mub3JnL3dpa2kvUUVNVS9JbWFnZXMjQ3JlYXRpbmdfYW5faW1hZ2U=">ã€Wikibooksã€‘QEMU/Images<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly93d3cucWVtdS5vcmcvZG9jcy9tYXN0ZXIvc3lzdGVtL2xpbnV4Ym9vdC5odG1s">ã€QEMUã€‘Direct
Linux Boot<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9hc2t1YnVudHUuY29tL3F1ZXN0aW9ucy85MjQ5MTMvaG93LXRvLWdldC10by10aGUtZ3J1Yi1tZW51LWF0LWJvb3QtdGltZS11c2luZy1zZXJpYWwtY29uc29sZQ==">ã€ask
ubuntuã€‘How to get to the GRUB menu at boot-time using serial
console?<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDc5NjY3MC9hcnRpY2xlL2RldGFpbHMvMTIxMjM0NDQ2">ã€CSDNã€‘é—®é¢˜è§£å†³
C++: fatal error: Killed signal terminated program cc1plus<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3dlc3Rlcm5kaWdpdGFsY29ycG9yYXRpb24vbGliemJk">ã€GitHubã€‘libzbd<i class="fa fa-external-link-alt"></i></span></li>
</ul>
]]></content>
      <categories>
        <category>æµ‹è¯•</category>
      </categories>
      <tags>
        <tag>æ—¥å¸¸è¸©å‘</tag>
        <tag>RocksDB</tag>
        <tag>ZNS</tag>
        <tag>QEMU</tag>
        <tag>grub</tag>
      </tags>
  </entry>
  <entry>
    <title>è‡ªå®šä¹‰é…ç½® RocksDB è¿›è¡Œ YCSB æµ‹è¯•</title>
    <url>/posts/4bc1e607.html</url>
    <content><![CDATA[<p>æœ¬æ–‡ä¸»è¦è®°å½•åœ¨åˆ©ç”¨ <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2JyaWFuZnJhbmtjb29wZXIvWUNTQg==">YCSB<i class="fa fa-external-link-alt"></i></span>
ä½¿ç”¨é…ç½®æ–‡ä»¶æµ‹è¯• <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2ZhY2Vib29rL3JvY2tzZGI=">RocksDB<i class="fa fa-external-link-alt"></i></span>
çš„è¿‡ç¨‹ä¸­é‡åˆ°çš„ä¸€äº›é—®é¢˜ä»¥åŠç›¸åº”çš„è§£å†³åŠæ³• <span id="more"></span></p>
<h2 id="ç®€ä»‹">ç®€ä»‹</h2>
<p>YCSB çš„å…¨ç¨‹æ˜¯ Yahoo! Cloud Serving
Benchmarkï¼Œæ˜¯é›…è™å¼€å‘çš„ç”¨æ¥å¯¹äº‘æœåŠ¡è¿›è¡ŒåŸºç¡€æµ‹è¯•çš„å·¥å…·ï¼Œæ”¯æŒç›®å‰å¸¸è§çš„
NoSQL æ•°æ®åº“äº§å“ï¼Œå¦‚ HBaseã€MongoDBã€OrientDBã€Redis ç­‰ç­‰</p>
<p>RocksDB æ˜¯ä¸€ä¸ªå…·æœ‰é”® / å€¼æ¥å£çš„å­˜å‚¨å¼•æ“ï¼Œå…¶ä¸­é”®å’Œå€¼æ˜¯ä»»æ„å­—èŠ‚æµã€‚å®ƒæ˜¯åœ¨
Facebookï¼ˆMetaï¼‰ åŸºäº LevelDB å¼€å‘çš„ï¼Œå¹¶ä¸º LevelDB API
æä¾›å‘åå…¼å®¹çš„æ”¯æŒ</p>
<h2 id="ç¼–è¯‘-rocksdb">ç¼–è¯‘ RocksDB</h2>
<p>ç”±äº YCSB æ˜¯ç”¨ Java å®ç°çš„ï¼Œä¸€èˆ¬æµ‹è¯•çš„æ•°æ®åº“éƒ½éœ€è¦æä¾› Java ç‰ˆæœ¬çš„
<code>.jar</code> åŒ…</p>
<p>è™½ç„¶ RocksDB æœ€åˆæ˜¯ C++
çš„ä¸€ä¸ªåº“ï¼ˆå› ä¸ºæ˜¯åµŒå…¥å¼æ•°æ®åº“ï¼‰ï¼Œä½†æ˜¯åç»­ä¹Ÿæä¾›äº† Java çš„ API
ä»¥åŠå¯ä»¥é€šè¿‡æºç ç¼–è¯‘å‡º <code>.jar</code> åŒ…ï¼Œä¹Ÿå¯ä»¥ç›´æ¥é€šè¿‡
<code>Maven</code> è·å–</p>
<p>å®˜æ–¹åœ¨ GitHub ä¸Šç»™å‡ºäº† <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2ZhY2Vib29rL3JvY2tzZGIvd2lraS9Sb2Nrc0phdmEtQmFzaWNz">Java
ç‰ˆæœ¬çš„ä»‹ç»<i class="fa fa-external-link-alt"></i></span>ï¼Œç¼–è¯‘è¿‡ç¨‹ä¹Ÿå¾ˆç®€å•</p>
<p>é¦–å…ˆéœ€è¦ä¿è¯æœºå™¨ä¸Šå®‰è£…å¥½äº† Java çš„ç¯å¢ƒï¼Œå¿…é¡»åœ¨ 1.7+
ç‰ˆæœ¬ä»¥ä¸Šï¼Œä¾‹å¦‚ï¼Œå®‰è£… <code>openjdk-8-jdk</code> åŒ…å³å¯</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt install openjdk-8-jdk</span><br></pre></td></tr></tbody></table></figure>
<p>åŒæ—¶ RocksDB æœ¬èº«è¿˜æœ‰ä¸€äº›ç¯å¢ƒéœ€è¦å®‰è£…ï¼Œ<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2ZhY2Vib29rL3JvY2tzZGIvYmxvYi9tYWluL0lOU1RBTEwubWQ=">å®˜æ–¹<i class="fa fa-external-link-alt"></i></span>
ä¹Ÿç»™å‡ºæ¥äº†</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt-get install libgflags-dev libsnappy-dev zlib1g-dev libbz2-dev liblz4-dev libzstd-dev</span><br></pre></td></tr></tbody></table></figure>
<p>å®é™…ç¼–è¯‘ jar åŒ…æ—¶ï¼Œéœ€è¦æå‰é…ç½®å¥½ç¯å¢ƒå˜é‡</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">export</span> JAVA_HOME=<span class="string">"/usr/lib/jvm/java-8-openjdk-amd64"</span></span><br></pre></td></tr></tbody></table></figure>
<p>å®é™…ç¼–è¯‘æ—¶ï¼Œæœ‰ä¸¤ä¸ªä¸­ç‰ˆæœ¬å¯ä»¥é€‰æ‹©ï¼Œå…¶ä¸­ <code>rocksdbjava</code> æ˜¯
debug ç‰ˆæœ¬ï¼Œè€Œ <code>rocksdbjavastatic</code> è¿™æ˜¯ release
ç‰ˆæœ¬ï¼Œä¸è¿‡å®˜æ–¹åœ¨ Java ç‰ˆè¯´æ˜ä¸­æ²¡æœ‰æåŠï¼Œæˆ‘æ˜¯åœ¨ <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2ZhY2Vib29rL3JvY2tzZGIvYmxvYi9tYWluL01ha2VmaWxl">Makefile
æ–‡ä»¶<i class="fa fa-external-link-alt"></i></span> ä¸­æ‰¾åˆ°çš„</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">make -j$(<span class="built_in">nproc</span>) rocksdbjava</span><br><span class="line">make -j$(<span class="built_in">nproc</span>) rocksdbjavastatic</span><br></pre></td></tr></tbody></table></figure>
<h2 id="ç¼–è¯‘-ycsb">ç¼–è¯‘ YCSB</h2>
<p>YCSB åœ¨ 2019/10/17 çš„ <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2JyaWFuZnJhbmtjb29wZXIvWUNTQi9jb21taXQvNGE5OTAwOTlhNjY3YzkyMjZkNWMzM2RlNzk3MWY4YjdlZGU5ZmZjMA==">4a99009<i class="fa fa-external-link-alt"></i></span>
å¢åŠ äº†å¯¹ RocksDB é…ç½®æ–‡ä»¶çš„æ”¯æŒï¼Œç„¶è€Œç›®å‰å®˜æ–¹ç»™å‡ºçš„ release ç‰ˆæœ¬è¿˜æ˜¯
0.17.0ï¼Œå¹¶ä¸”å‘å¸ƒæ—¶é—´æ˜¯ 2019/10/6ï¼Œå› æ­¤æˆ‘ä»¬åªèƒ½é€‰æ‹©ä»æºç å¼€å§‹ç¼–è¯‘äº†</p>
<p>æ ¹æ® <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2JyaWFuZnJhbmtjb29wZXIvWUNTQi90cmVlL21hc3Rlci9yb2Nrc2Ri">å®˜æ–¹ç»™å‡ºçš„æµç¨‹<i class="fa fa-external-link-alt"></i></span></p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/brianfrankcooper/YCSB.git</span><br><span class="line"><span class="built_in">cd</span> YCSB</span><br><span class="line">mvn -pl site.ycsb:rocksdb-binding -am clean package</span><br></pre></td></tr></tbody></table></figure>
<p>æ­¤æ—¶ç¼–è¯‘å¥½çš„æ–‡ä»¶åœ¨ <code>./rocksdb/target/</code> ç›®å½•ä¸‹</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">~/YCSB$ <span class="built_in">ls</span> rocksdb/target/*.jar</span><br><span class="line">rocksdb/target/rocksdb-binding-0.18.0-SNAPSHOT.jar</span><br></pre></td></tr></tbody></table></figure>
<p>è¯¥ <code>.jar</code> åŒ…å…¶å®åªæ˜¯ YCSB å’Œ RocksDB
ä¹‹é—´çš„ä¸­é—´ä»¶ï¼Œå®é™…ä½¿ç”¨çš„ RocksDB çš„ <code>.jar</code>
åŒ…ä»¥åŠå…¶ä»–çš„ä¾èµ–åŒ…åˆ™æ˜¯åœ¨ <code>./rocksdb/target/dependency/</code>
ç›®å½•ä¸‹</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">~/YCSB$ tree rocksdb/target/dependency/</span><br><span class="line">rocksdb/target/dependency/</span><br><span class="line">â”œâ”€â”€ jcip-annotations-1.0.jar</span><br><span class="line">â”œâ”€â”€ rocksdbjni-6.2.2.jar</span><br><span class="line">â”œâ”€â”€ slf4j-api-1.7.25.jar</span><br><span class="line">â””â”€â”€ slf4j-simple-1.7.25.jar</span><br></pre></td></tr></tbody></table></figure>
<p>RocksDB çš„åŒ…å…¶å®æ˜¯ç”± YCSB é€šè¿‡ <code>Maven</code>
ä¸‹è½½çš„ï¼Œå…·ä½“çš„ç‰ˆæœ¬åœ¨ <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2JyaWFuZnJhbmtjb29wZXIvWUNTQi9jb21taXQvNGE5OTAwOTlhNjY3YzkyMjZkNWMzM2RlNzk3MWY4YjdlZGU5ZmZjMCNkaWZmLTljNWZiM2QxYjdlM2IwZjU0YmM1YzQxODI5NjVjNGZlMWY5MDIzZDQ0OTAxN2NlY2UzMDA1ZDNmOTBlOGU0ZDhMMTUw">pom.xml<i class="fa fa-external-link-alt"></i></span>
ä¸­å®šä¹‰äº†</p>
<ul>
<li>å¦‚æœä½¿ç”¨åŸæœ¬ RocksDB åˆ™å¯ä»¥ç®€å•çš„é€šè¿‡ä¿®æ”¹è¿™ä¸ªç‰ˆæœ¬ä¿¡æ¯ï¼Œé‡æ–°ç¼–è¯‘åˆ©ç”¨
<code>Maven</code> é‡æ–°ä¸‹è½½</li>
<li>å¦‚æœä½¿ç”¨çš„æ˜¯è‡ªå·±ä¿®æ”¹è¿‡æºç çš„ RocksDB åˆ™éœ€è¦å°†è‡ªè¡Œç¼–è¯‘çš„ RocksDB çš„
<code>.jar</code> åŒ…ç§»åˆ°è¯¥ç›®å½•ä¸‹ï¼Œå¹¶ä¸”åˆ é™¤æ—§çš„ <code>.jar</code> åŒ…</li>
</ul>
<h2 id="ä¿®å¤æŠ¥é”™">ä¿®å¤æŠ¥é”™</h2>
<p>ä½†æ­¤æ—¶å¦‚æœä½¿ç”¨ <code>./bin/ycsb.sh</code> æ¥è¿›è¡Œæµ‹è¯•ï¼Œä¼šæŠ¥é”™</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">~/YCSB$ ./bin/ycsb.sh load rocksdb -s -P workloads/workloada -p rocksdb.dir=tmp/</span><br><span class="line">/usr/lib/jvm/java-8-openjdk-amd64/bin/java  -classpath /home/ywang/YCSB/conf:/home/ywang/YCSB/core/target/core-0.18.0-SNAPSHOT.jar:/home/ywang/YCSB/rocksdb/target/rocksdb-binding-0.18.0-SNAPSHOT.jar:/home/ywang/YCSB/rocksdb/target/dependency/jcip-annotations-1.0.jar:/home/ywang/YCSB/rocksdb/target/dependency/rocksdbjni-6.2.2.jar:/home/ywang/YCSB/rocksdb/target/dependency/slf4j-api-1.7.25.jar:/home/ywang/YCSB/rocksdb/target/dependency/slf4j-simple-1.7.25.jar site.ycsb.Client -load -db site.ycsb.db.rocksdb.RocksDBClient -s -P workloads/workloada -p rocksdb.dir=tmp/</span><br><span class="line">Command line: -load -db site.ycsb.db.rocksdb.RocksDBClient -s -P workloads/workloada -p rocksdb.dir=tmp/</span><br><span class="line">YCSB Client 0.18.0-SNAPSHOT</span><br><span class="line"></span><br><span class="line">Loading workload...</span><br><span class="line">Exception <span class="keyword">in</span> thread <span class="string">"main"</span> java.lang.NoClassDefFoundError: org/apache/htrace/core/Tracer<span class="variable">$Builder</span></span><br><span class="line">        at site.ycsb.Client.getTracer(Client.java:458)</span><br><span class="line">        at site.ycsb.Client.main(Client.java:304)</span><br><span class="line">Caused by: java.lang.ClassNotFoundException: org.apache.htrace.core.Tracer<span class="variable">$Builder</span></span><br><span class="line">        at java.net.URLClassLoader.findClass(URLClassLoader.java:387)</span><br><span class="line">        at java.lang.ClassLoader.loadClass(ClassLoader.java:418)</span><br><span class="line">        at sun.misc.Launcher<span class="variable">$AppClassLoader</span>.loadClass(Launcher.java:352)</span><br><span class="line">        at java.lang.ClassLoader.loadClass(ClassLoader.java:351)</span><br><span class="line">        ... 2 more</span><br><span class="line"> (might take a few minutes <span class="keyword">for</span> large data sets)</span><br></pre></td></tr></tbody></table></figure>
<p>ä¸»è¦æ˜¯ä½¿ç”¨çš„ <code>./bin/ycsb.sh</code> è„šæœ¬æœ‰ bugï¼Œ<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2JyaWFuZnJhbmtjb29wZXIvWUNTQi9pc3N1ZXMvMTEwNQ==">å®˜æ–¹å·²ç»çŸ¥é“<i class="fa fa-external-link-alt"></i></span>ï¼Œ<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2JyaWFuZnJhbmtjb29wZXIvWUNTQi9wdWxsLzkwOA==">å¹¶å°è¯•ä¿®å¤<i class="fa fa-external-link-alt"></i></span>ï¼Œä¸è¿‡å¥½åƒä»ç„¶æ²¡æœ‰è§£å†³</p>
<p>ç›®å‰å¯ä»¥æ‰‹åŠ¨å°† <code>htrace</code> çš„åŒ…çš„ä¾èµ–åŠ å…¥ RocksDB
ä¸­ï¼Œå¹¶é‡æ–°ç¼–è¯‘ï¼Œåˆ©ç”¨ <code>Maven</code> ä¸‹è½½åˆ°
<code>./rocksdb/target/dependency/</code> ç›®å½•ä¸‹</p>
<p>å¯ä»¥æ‰‹åŠ¨å°† <code>./core/pom.xml</code> ä¸­ <code>htrace</code>
çš„ä¾èµ–ä¿¡æ¯å¤åˆ¶æ·»åŠ åˆ° <code>./rocksdb/pom.xml</code> ä¸­</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- ./rocksdb/pom.xml --&gt;</span></span><br><span class="line">	â€¦â€¦</span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.rocksdb<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rocksdbjni<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>${rocksdb.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.htrace<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>htrace-core4<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.1.0-incubating<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>site.ycsb<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>${project.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">	â€¦â€¦</span><br></pre></td></tr></tbody></table></figure>
<p>ç„¶ååˆ©ç”¨
<code>mvn -pl site.ycsb:rocksdb-binding -am clean package</code>
é‡æ–°ç¼–è¯‘</p>
<p>è¿™æ—¶å†æ¬¡åˆ©ç”¨ <code>./bin/ycsb.sh</code> æ¥è¿›è¡Œæµ‹è¯•ï¼Œè¿˜ä¼šæŠ¥é”™</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">~/YCSB$ ./bin/ycsb.sh load rocksdb -s -P workloads/workloada -p rocksdb.dir=tmp/</span><br><span class="line">/usr/lib/jvm/java-8-openjdk-amd64/bin/java  -classpath /home/ywang/YCSB/conf:/home/ywang/YCSB/core/target/core-0.18.0-SNAPSHOT.jar:/home/ywang/YCSB/rocksdb/target/rocksdb-binding-0.18.0-SNAPSHOT.jar:/home/ywang/YCSB/rocksdb/target/dependency/htrace-core4-4.1.0-incubating.jar:/home/ywang/YCSB/rocksdb/target/dependency/jcip-annotations-1.0.jar:/home/ywang/YCSB/rocksdb/target/dependency/rocksdbjni-6.2.2.jar:/home/ywang/YCSB/rocksdb/target/dependency/slf4j-api-1.7.25.jar:/home/ywang/YCSB/rocksdb/target/dependency/slf4j-simple-1.7.25.jar site.ycsb.Client -load -db site.ycsb.db.rocksdb.RocksDBClient -s -P workloads/workloada -p rocksdb.dir=tmp/</span><br><span class="line">Command line: -load -db site.ycsb.db.rocksdb.RocksDBClient -s -P workloads/workloada -p rocksdb.dir=tmp/</span><br><span class="line">YCSB Client 0.18.0-SNAPSHOT</span><br><span class="line"></span><br><span class="line">Loading workload...</span><br><span class="line">Starting <span class="built_in">test</span>.</span><br><span class="line">[Thread-3] INFO site.ycsb.db.rocksdb.RocksDBClient - RocksDB data <span class="built_in">dir</span>: tmp</span><br><span class="line">2021-12-25 16:10:30:807 0 sec: 0 operations; est completion <span class="keyword">in</span> 0 second</span><br><span class="line">DBWrapper: report latency <span class="keyword">for</span> each error is <span class="literal">false</span> and specific error codes to track <span class="keyword">for</span> latency are: []</span><br><span class="line">Exception <span class="keyword">in</span> thread <span class="string">"Thread-3"</span> java.lang.NoClassDefFoundError: org/HdrHistogram/EncodableHistogram</span><br><span class="line">        at site.ycsb.measurements.Measurements.constructOneMeasurement(Measurements.java:129)</span><br><span class="line">        at site.ycsb.measurements.Measurements.getOpMeasurement(Measurements.java:220)</span><br><span class="line">        at site.ycsb.measurements.Measurements.measure(Measurements.java:188)</span><br><span class="line">        at site.ycsb.DBWrapper.measure(DBWrapper.java:184)</span><br><span class="line">        at site.ycsb.DBWrapper.insert(DBWrapper.java:229)</span><br><span class="line">        at site.ycsb.workloads.CoreWorkload.doInsert(CoreWorkload.java:621)</span><br><span class="line">        at site.ycsb.ClientThread.run(ClientThread.java:135)</span><br><span class="line">        at java.lang.Thread.run(Thread.java:748)</span><br><span class="line">Caused by: java.lang.ClassNotFoundException: org.HdrHistogram.EncodableHistogram</span><br><span class="line">        at java.net.URLClassLoader.findClass(URLClassLoader.java:387)</span><br><span class="line">        at java.lang.ClassLoader.loadClass(ClassLoader.java:418)</span><br><span class="line">        at sun.misc.Launcher<span class="variable">$AppClassLoader</span>.loadClass(Launcher.java:352)</span><br><span class="line">        at java.lang.ClassLoader.loadClass(ClassLoader.java:351)</span><br><span class="line">        ... 8 more</span><br><span class="line">2021-12-25 16:10:30:954 0 sec: 0 operations; est completion <span class="keyword">in</span> 106751991167300 days 15 hours</span><br><span class="line">[OVERALL], RunTime(ms), 170</span><br><span class="line">[OVERALL], Throughput(ops/sec), 0.0</span><br><span class="line">[TOTAL_GCS_PS_Scavenge], Count, 0</span><br><span class="line">[TOTAL_GC_TIME_PS_Scavenge], Time(ms), 0</span><br><span class="line">[TOTAL_GC_TIME_%_PS_Scavenge], Time(%), 0.0</span><br><span class="line">[TOTAL_GCS_PS_MarkSweep], Count, 0</span><br><span class="line">[TOTAL_GC_TIME_PS_MarkSweep], Time(ms), 0</span><br><span class="line">[TOTAL_GC_TIME_%_PS_MarkSweep], Time(%), 0.0</span><br><span class="line">[TOTAL_GCs], Count, 0</span><br><span class="line">[TOTAL_GC_TIME], Time(ms), 0</span><br><span class="line">[TOTAL_GC_TIME_%], Time(%), 0.0</span><br></pre></td></tr></tbody></table></figure>
<p>åŸå› å’Œä¹‹å‰ä¸€æ ·ï¼Œå†æ¬¡å°† <code>HdrHistogram</code> ç›¸å…³çš„ä¾èµ–ï¼Œä»
<code>./core/pom.xml</code> å¤åˆ¶æ·»åŠ åˆ° <code>./rocksdb/pom.xml</code>
ä¸­</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- ./rocksdb/pom.xml --&gt;</span></span><br><span class="line">	â€¦â€¦</span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.rocksdb<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rocksdbjni<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>${rocksdb.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.htrace<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>htrace-core4<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.1.0-incubating<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.hdrhistogram<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>HdrHistogram<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>site.ycsb<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>${project.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">	â€¦â€¦</span><br></pre></td></tr></tbody></table></figure>
<p>ç„¶ååˆ©ç”¨
<code>mvn -pl site.ycsb:rocksdb-binding -am clean package</code>
é‡æ–°ç¼–è¯‘</p>
<p>è¿™æ—¶å†æ¬¡åˆ©ç”¨ <code>./bin/ycsb.sh</code> æ¥è¿›è¡Œæµ‹è¯•å°±å·²ç»æ­£å¸¸äº†</p>
<h2 id="è‡ªå®šä¹‰é…ç½®-rocksdb-è¿›è¡Œ-ycsb-æµ‹è¯•">è‡ªå®šä¹‰é…ç½® RocksDB è¿›è¡Œ YCSB
æµ‹è¯•</h2>
<p>è‡ªå®šä¹‰é…ç½® RocksDB çš„æ–¹å¼å°±å¾ˆç®€å•äº†ï¼Œåœ¨ YCSB æµ‹è¯•æ—¶å¢åŠ 
<code>rocksdb.optionsfile</code> å‚æ•°å¹¶ç»™å‡ºé…ç½®æ–‡ä»¶çš„è·¯å¾„å³å¯</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">./bin/ycsb.sh load rocksdb -s -P workloads/workloada -p rocksdb.dir=/tmp/ycsb-rocksdb-data -p workloads/ycsb-rocksdb-options.ini</span><br><span class="line">./bin/ycsb.sh run rocksdb -s -P workloads/workloada -p rocksdb.dir=/tmp/ycsb-rocksdb-data -p workloads/ycsb-rocksdb-options.ini</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>é…ç½®æ–‡ä»¶å¯ä»¥å‚è€ƒ <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2ZhY2Vib29rL3JvY2tzZGIvYmxvYi9tYWluL2V4YW1wbGVzL3JvY2tzZGJfb3B0aW9uX2ZpbGVfZXhhbXBsZS5pbmk=">RocksDB
å®˜æ–¹çš„ä¾‹å­<i class="fa fa-external-link-alt"></i></span> ä¿®æ”¹</li>
<li>ä¹Ÿå¯ä»¥å…ˆä¸åŠ æµ‹è¯•æ–‡ä»¶ï¼Œæ‰§è¡Œä¸€æ¬¡
<code>./bin/ycsb.sh load rocksdb -s -P workloads/workloada -p rocksdb.dir=/tmp/ycsb-rocksdb-data</code>ï¼Œè®©
YCSB è‡ªå·±ç”Ÿæˆï¼Œç„¶åæ ¹æ® RocksDB
æµ‹è¯•ç›®å½•ï¼ˆ<code>/tmp/ycsb-rocksdb-data</code>ï¼‰ä¸‹çš„
<code>OPTIONS-000009</code> çš„é…ç½®æ–‡ä»¶æ¥ä¿®æ”¹</li>
</ul>
<h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h2>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2ZhY2Vib29rL3JvY2tzZGIvd2lraS9Sb2Nrc0phdmEtQmFzaWNz">ã€GitHubã€‘RocksJava
Basics<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9tYW43Lm9yZy9saW51eC9tYW4tcGFnZXMvbWFuMS9ucHJvYy4xLmh0bWw=">ã€manã€‘nproc(1)
â€” Linux manual page<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2JyaWFuZnJhbmtjb29wZXIvWUNTQi9pc3N1ZXMvMTEwNQ==">ã€GitHubã€‘Cannot
execute YCSB #1105<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2JyaWFuZnJhbmtjb29wZXIvWUNTQi9pc3N1ZXMvMTEwNQ==">ã€GitHubã€‘[core]
Fix ycsb.sh and ycsb.bat missing core dependencies #908<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2E5OTMwOTYyODEvYXJ0aWNsZS9kZXRhaWxzLzg3ODY0MzQw">ã€CSDNã€‘rocksdb
åœ¨ YCSB ä¸­çš„è¿è¡Œæ•™ç¨‹<i class="fa fa-external-link-alt"></i></span></li>
</ul>
]]></content>
      <categories>
        <category>æµ‹è¯•</category>
      </categories>
      <tags>
        <tag>RocksDB</tag>
        <tag>Maven</tag>
        <tag>YCSB</tag>
      </tags>
  </entry>
  <entry>
    <title>ä¿®å¤ chrome æ‰“ä¸å¼€å¾®ä¿¡æˆ–è€…éƒ¨åˆ†ç¬¬ä¸‰æ–¹åº”ç”¨å†…é“¾æ¥</title>
    <url>/posts/29e0b18c.html</url>
    <content><![CDATA[<p>æœ€è¿‘ç”µè„‘æœ‰ä¸ªé—®é¢˜æŒç»­äº†å¥½ä¹…ï¼š<strong>å½“é»˜è®¤æµè§ˆå™¨è®¾ç½®ä¸º chrome
æ—¶ï¼Œå¹¶ä¸” chrome
å·²ç»æ‰“å¼€çš„æƒ…å†µä¸‹</strong>ï¼Œåœ¨å¾®ä¿¡å†…é€šè¿‡é»˜è®¤æµè§ˆå™¨æ‰“å¼€æ€»æ˜¯æ²¡æœ‰ååº”
<del>ï¼ˆå¦‚æœ chrome æ²¡æœ‰æ‰“å¼€æ—¶ï¼Œåˆ™ä¼šæ­£å¸¸è·³å‡º chrome
ä»¥åŠç›¸åº”çš„ç½‘é¡µï¼Œå¥½æ°”å“¦ï¼‰</del> <span id="more"></span></p>
<figure>
<img data-src="/posts/29e0b18c/wechat_default_browser.png" alt="wechat_default_browser">
<figcaption aria-hidden="true">wechat_default_browser</figcaption>
</figure>
<h2 id="ä¿®å¤é—®é¢˜å¸è½½-kgchromeplugin">ä¿®å¤é—®é¢˜ï¼šå¸è½½ KGChromePlugin</h2>
<p>ç»è¿‡å„ç§æŸ¥è¯¢èµ„æ–™ï¼Œæœ€åå‘ç°åŸå› æ˜¯ chrome çš„å¯åŠ¨å‚æ•°è¢« KGChromePlugin
é‡‘æ ¼æ’ä»¶ç¯¡æ”¹äº†ï¼Œä»è€Œå¯¼è‡´éƒ¨åˆ†ç¬¬ä¸‰æ–¹åº”ç”¨ï¼ˆå®æµ‹ï¼Œå¾®ä¿¡ã€vscodeã€cmd
éƒ½ä¸è¡Œï¼Œä½†æ˜¯ QQ å¯ä»¥ï¼‰æ— æ³•è°ƒç”¨ chrome æ‰“å¼€è¶…é“¾æ¥</p>
<ol type="1">
<li><p>å¯é€šè¿‡ chrome://version/ æŸ¥çœ‹å‘½ä»¤è¡Œä¸­æ˜¯å¦å«æœ‰
<code>--register-pepper-plugins=XXX</code></p>
<figure>
<img data-src="/posts/29e0b18c/chrome_version_before.png" alt="chrome_version_before">
<figcaption aria-hidden="true">chrome_version_before</figcaption>
</figure></li>
<li><p> æ ¹æ® XXX ä¸­çš„è·¯å¾„ä¿¡æ¯ï¼Œæ‰¾åˆ° KGChromePlugin æ‰€åœ¨çš„æ–‡ä»¶è·¯å¾„ï¼Œé€šå¸¸æ˜¯
<code>C:\Program Files (x86)\KGChromePlugin</code>ï¼Œç„¶ååœ¨æ–‡ä»¶å¤¹ä¸­æ‰¾åˆ°å¸è½½ç¨‹åº
<code>KGPMUninstall.exe</code>ï¼ŒåŒå‡»è¿›è¡Œå¸è½½å³å¯</p></li>
<li><p>å¸è½½ä¹‹åï¼Œé‡å¯ä¸€ä¸‹
chromeï¼Œå‘½ä»¤è¡Œåº”è¯¥å°±æ¢å¤æ­£å¸¸äº†ï¼Œæ­¤æ—¶ä¹Ÿèƒ½åœ¨å·²æ‰“å¼€ chrome
çš„æƒ…å†µä¸‹åœ¨ç¬¬ä¸‰æ–¹åº”ç”¨ä¸­é¡ºåˆ©æ‰“å¼€è¶…é“¾æ¥äº†</p>
<figure>
<img data-src="/posts/29e0b18c/chrome_version_after.png" alt="chrome_version_after">
<figcaption aria-hidden="true">chrome_version_after</figcaption>
</figure></li>
</ol>
<h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h2>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly93d3cuemhpaHUuY29tL3F1ZXN0aW9uLzM2Nzg0ODgwNA==">ã€çŸ¥ä¹ã€‘chrome
æµè§ˆå™¨ æ¯æ¬¡æ‰“å¼€æç¤ºï¼šâ€œ--no-sandbox.â€ æ€ä¹ˆå»é™¤ï¼Ÿ<i class="fa fa-external-link-alt"></i></span></li>
</ul>
]]></content>
      <categories>
        <category>æ—¥å¸¸è¸©å‘</category>
      </categories>
      <tags>
        <tag>æ—¥å¸¸è¸©å‘</tag>
        <tag>chrome</tag>
      </tags>
  </entry>
  <entry>
    <title>Debug ä»å…¥é—¨åˆ°å…¥åœŸ</title>
    <url>/posts/89f2ed7d.html</url>
    <content><![CDATA[<p>å†™ä»£ç éš¾å…é‡åˆ° bugï¼Œè°ƒè¯•è§£å†³ bug
çš„å¿«æ…¢å¾ˆå½±å“å¼€å‘çš„æ•ˆç‡ã€‚æœ¬æ–‡ä¸»è¦æ˜¯æ¢³ç†å¹¶è®°å½•ä¸‹ä¸ªäººç»å¸¸ç”¨çš„è°ƒè¯•æ–¹æ³•ï¼ˆä¸»è¦ä»¥
C/C++ çš„ segment fault ä¸ºä¾‹ï¼‰ <span id="more"></span></p>
<h2 id="åˆ†ç±»">åˆ†ç±»</h2>
<p>æ ¹æ®è°ƒè¯•æ—¶æœºä¸ bug
äº§ç”Ÿçš„æ—¶é—´çš„å‰åå…³ç³»ï¼Œä¸»è¦åˆ†ä¸º â€œäº‹åâ€ã€â€œäº‹ä¸­â€ã€â€œäº‹å…ˆâ€ ä¸‰ç±»ï¼š</p>
<ul>
<li>â€œäº‹åâ€ ä¸»è¦æ˜¯é€šè¿‡ addr2line æˆ–è€… objdump
ç­‰å·¥å…·ï¼Œå®šä½æŠ¥é”™æ—¶çš„ç¨‹åºè¿è¡Œä½ç½®</li>
<li> â€œäº‹ä¸­â€ ä¸»è¦æ˜¯é€šè¿‡ GDB æ¥è§‚å¯Ÿç¨‹åºè¿è¡Œæ—¶çš„çŠ¶æ€ï¼Œå®æ—¶çš„æ•æ‰ bug</li>
<li>â€œäº‹å…ˆâ€
ä¸»è¦æ˜¯é€šè¿‡åœ¨æºä»£ç ä¸­æ’å…¥æ‰“å°è¯­å¥ï¼Œæ¥è§‚å¯Ÿç¨‹åºè¿è¡Œæ—¶å„ä¸ªå˜é‡çš„çŠ¶æ€</li>
</ul>
<h2 id="äº‹å">äº‹å</h2>
<p>é€šå¸¸ä¸ºäº†å¿«é€Ÿçš„å®šä½
bugï¼Œä¼šæ ¹æ®å‡ºé”™æ—¶çš„ç¨‹åºè¾“å‡ºï¼Œæ¥åˆ¤æ–­é‡æ–°å‡ºé”™çš„ä½ç½®</p>
<p>ç„¶è€Œä¸€èˆ¬çš„ç¨‹åºè¾“å‡ºå¯èƒ½ä¸è¶³ä»¥æä¾›è¶³å¤Ÿä¿¡æ¯çš„æƒ…å†µï¼Œæ­¤æ—¶å¯ä»¥æ ¹æ®
<code>segmentation fault (core dumped)</code>
ä¿¡æ¯å¹¶ä¸”å€ŸåŠ©ä¸€äº›å·¥å…·æ¥å®šä½å‡ºé”™çš„ä½ç½®</p>
<h3 id="addr2line"><code>addr2line</code></h3>
<p><code>addr2line</code> åœ¨ç¨‹åº<strong>å«æœ‰ debug
ä¿¡æ¯</strong>æ—¶å¯ä»¥å¿«é€Ÿçš„å°†åœ°å€è½¬æ¢ä¸ºæ–‡ä»¶åå’Œè¡Œå·</p>
<p>å…·ä½“çš„ä½¿ç”¨æ–¹æ³•å¯ä»¥é€šè¿‡ <code>man addr2line</code>
æŸ¥çœ‹ï¼Œè¿™é‡Œç®€å•ä»‹ç»ä¸€ä¸‹å¸¸ç”¨çš„ç”¨æ³•</p>
<p>ä»¥ä¸‹é¢çš„ä»£ç ä¸ºä¾‹ï¼š</p>
<figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> {</span><br><span class="line">    <span class="type">int</span> *p = <span class="literal">NULL</span>;</span><br><span class="line">    *p = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># ç¼–è¯‘æ—¶åŠ ä¸Š -g é€‰é¡¹ï¼Œç”Ÿæˆ debug ä¿¡æ¯</span></span><br><span class="line"><span class="comment"># -no-pie é€‰é¡¹æ˜¯ä¸ºäº†é¿å… ASLR çš„å½±å“ï¼ˆé«˜ç‰ˆæœ¬çš„ gcc é»˜è®¤å¼€å¯ ASLRï¼‰</span></span><br><span class="line">$ gcc -g -no-pie test.c -o <span class="built_in">test</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿è¡Œç¨‹åºï¼Œä¼šå‡ºç° segmentation fault</span></span><br><span class="line">$ ./test</span><br><span class="line">[1]    7533 segmentation fault (core dumped)  ./test</span><br><span class="line"></span><br><span class="line"><span class="comment"># dmesg æŸ¥çœ‹å†…æ ¸æ—¥å¿—ï¼Œå¯ä»¥çœ‹åˆ° segmentation fault çš„è¯¦ç»†ä¿¡æ¯</span></span><br><span class="line">$ dmesg | <span class="built_in">tail</span> -n 2</span><br><span class="line">[46592.916853] <span class="built_in">test</span>[7533]: segfault at 0 ip 000000000040111a sp 00007ffce6095a70 error 6 <span class="keyword">in</span> <span class="built_in">test</span>[401000+1000]</span><br><span class="line">[46592.916875] Code: c3 66 66 2e 0f 1f 84 00 00 00 00 00 0f 1f 40 00 f3 0f 1e fa eb 8a f3 0f 1e fa 55 48 89 e5 48 c7 45 f8 00 00 00 00 48 8b 45 f8 &lt;c7&gt; 00 02 00 00 00 b8 00 00 00 00 5d c3 66 0f 1f 84 00 00 00 00 00</span><br></pre></td></tr></tbody></table></figure>
<p>æ­¤æ—¶å¯ä»¥æ ¹æ® <code>ip 000000000040111a</code>
æ¥å®šä½å‡ºé”™çš„ä½ç½®ï¼Œ<code>ip</code> åé¢è·Ÿç€çš„æ•°å­—å°±æ˜¯ IP
å¯„å­˜å™¨çš„å€¼ï¼Œä¹Ÿå°±æ˜¯å‡ºé”™æ—¶çš„ç¨‹åºè¿è¡Œä½ç½®ï¼Œå¯ä»¥é€šè¿‡ <code>addr2line</code>
æ¥å°†å…¶è½¬æ¢ä¸ºæ–‡ä»¶åå’Œè¡Œå·</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># å°†åœ°å€è½¬æ¢ä¸ºæ–‡ä»¶åå’Œè¡Œå·</span></span><br><span class="line"><span class="comment"># -f é€‰é¡¹è¡¨ç¤ºè¾“å‡ºå‡½æ•°å</span></span><br><span class="line"><span class="comment"># -e é€‰é¡¹è¡¨ç¤ºæŒ‡å®šå¯æ‰§è¡Œæ–‡ä»¶</span></span><br><span class="line">$ addr2line -f -e ./test 0x000000000040111a</span><br><span class="line">main</span><br><span class="line">/home/ywang/test.c:5</span><br></pre></td></tr></tbody></table></figure>
<p>ç„¶è€Œ <code>addr2line</code> ä¹Ÿæœ‰ä¸¤ä¸ªè¾ƒä¸ºæ˜æ˜¾çš„å±€é™ï¼š</p>
<ul>
<li>éœ€è¦æå‰åœ¨ç¼–è¯‘æ—¶åŠ ä¸Š <code>-g</code> é€‰é¡¹ï¼Œç”Ÿæˆ debug ä¿¡æ¯</li>
<li>å¯¹äºé«˜ç‰ˆæœ¬çš„ gccï¼Œéœ€è¦åŠ ä¸Š <code>-no-pie</code> é€‰é¡¹ï¼Œé¿å… ASLR
çš„å½±å“</li>
</ul>
<h3 id="objdump-åæ±‡ç¼–"><code>objdump</code> åæ±‡ç¼–</h3>
<p>é€šè¿‡ <code>objdump</code> è¿›è¡Œåæ±‡ç¼–ä¹Ÿæ˜¯ä¸€ç§æ¯”è¾ƒå¸¸ç”¨çš„å®šä½
segmentation fault
çš„æ–¹æ³•ï¼Œè¿™ç§æ–¹æ³•èƒ½å¤Ÿç²¾ç¡®çš„å®šä½åˆ°æ‰§è¡Œçš„æ±‡ç¼–æŒ‡ä»¤ï¼Œå¹¶ä¸”æ²¡æœ‰
<code>addr2line</code>
çš„ä¸Šè¿°é™åˆ¶ï¼Œä½†æ˜¯éœ€è¦ä¸€å®šçš„æ±‡ç¼–åŸºç¡€ï¼Œå¦åˆ™çœ‹ä¸æ‡‚æ±‡ç¼–æŒ‡ä»¤ä¹Ÿæ˜¯æ²¡ç”¨çš„</p>
<p>æ±‡ç¼–æŒ‡ä»¤çš„å¿«é€ŸæŸ¥è¯¢å¯ä»¥ç›´æ¥ Google æˆ–è€…åœ¨<a href="/TODO">ä¸€äº›å·¥å…·ç«™</a>ä¸Šè¿›è¡Œé€ŸæŸ¥</p>
<p>ä»¥ä¸‹é¢çš„ä»£ç ä¸ºä¾‹ï¼š</p>
<figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">func_bug</span><span class="params">()</span> {</span><br><span class="line">    <span class="type">int</span> *p = <span class="literal">NULL</span>;</span><br><span class="line">    *p = <span class="number">2</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> {</span><br><span class="line">    <span class="type">int</span> a = <span class="number">1</span>;</span><br><span class="line">    func_bug();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># æ— éœ€ä»»ä½•é€‰é¡¹ï¼Œç›´æ¥ç¼–è¯‘</span></span><br><span class="line">$ gcc test.c -o <span class="built_in">test</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿è¡Œç¨‹åºï¼Œä¼šå‡ºç° segmentation fault</span></span><br><span class="line">$ ./test</span><br><span class="line">[1]    8173 segmentation fault (core dumped)  ./test</span><br><span class="line"></span><br><span class="line"><span class="comment"># dmesg æŸ¥çœ‹å†…æ ¸æ—¥å¿—ï¼Œå¯ä»¥çœ‹åˆ° segmentation fault çš„è¯¦ç»†ä¿¡æ¯</span></span><br><span class="line">$ dmesg | <span class="built_in">tail</span> -n 2</span><br><span class="line">[49630.541707] <span class="built_in">test</span>[8173]: segfault at 0 ip 000055bce6f6c13d sp 00007fffad5149b0 error 6 <span class="keyword">in</span> <span class="built_in">test</span>[55bce6f6c000+1000]</span><br><span class="line">[49630.541732] Code: 5d c3 0f 1f 00 c3 0f 1f 80 00 00 00 00 f3 0f 1e fa e9 77 ff ff ff f3 0f 1e fa 55 48 89 e5 48 c7 45 f8 00 00 00 00 48 8b 45 f8 &lt;c7&gt; 00 02 00 00 00 90 5d c3 f3 0f 1e fa 55 48 89 e5 48 83 ec 10 c7 </span><br></pre></td></tr></tbody></table></figure>
<p>ç”±äºæ²¡æœ‰å…³é—­ ASLRï¼Œæ‰€ä»¥æ¯æ¬¡è¿è¡Œç¨‹åºæ—¶ï¼Œ<code>ip</code>
çš„å€¼éƒ½ä¼šä¸ä¸€æ ·ï¼Œä½†æ˜¯å¯ä»¥ç®€å•çš„æ¢ç®—è·å–åˆ°å®é™…åç§»é‡</p>
<p>ä¾‹å¦‚ä¸Šé¢çš„
<code>ip 000055bce6f6c13d â€¦â€¦ in test[55bce6f6c000+1000]</code>ï¼Œå¯ä»¥é€šè¿‡
<code>0x55bce6f6c13d - 0x55bce6f6c000 + 0x1000= 0x113d</code>
æ¥è·å–å®é™…åç§»é‡ <code>0x113d</code></p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># åæ±‡ç¼–åŸç¨‹åº</span></span><br><span class="line">$ objdump -d ./test</span><br><span class="line"></span><br><span class="line">./test:     file format elf64-x86-64</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Disassembly of section .init:</span><br><span class="line"></span><br><span class="line">0000000000001000 &lt;_init&gt;:</span><br><span class="line">    1000:       f3 0f 1e fa             endbr64</span><br><span class="line">    1004:       48 83 ec 08             sub    <span class="variable">$0x8</span>,%rsp</span><br><span class="line">    1008:       48 8b 05 d9 2f 00 00    mov    0x2fd9(%rip),%rax        <span class="comment"># 3fe8 &lt;__gmon_start__&gt;</span></span><br><span class="line">    100f:       48 85 c0                <span class="built_in">test</span>   %rax,%rax</span><br><span class="line">    1012:       74 02                   je     1016 &lt;_init+0x16&gt;</span><br><span class="line">    1014:       ff d0                   callq  *%rax</span><br><span class="line">    1016:       48 83 c4 08             add    <span class="variable">$0x8</span>,%rsp</span><br><span class="line">    101a:       c3                      retq</span><br><span class="line"></span><br><span class="line">Disassembly of section .plt:</span><br><span class="line"></span><br><span class="line">0000000000001020 &lt;.plt&gt;:</span><br><span class="line">    1020:       ff 35 a2 2f 00 00       pushq  0x2fa2(%rip)        <span class="comment"># 3fc8 &lt;_GLOBAL_OFFSET_TABLE_+0x8&gt;</span></span><br><span class="line">    1026:       f2 ff 25 a3 2f 00 00    bnd jmpq *0x2fa3(%rip)        <span class="comment"># 3fd0 &lt;_GLOBAL_OFFSET_TABLE_+0x10&gt;</span></span><br><span class="line">    102d:       0f 1f 00                nopl   (%rax)</span><br><span class="line"></span><br><span class="line">Disassembly of section .plt.got:</span><br><span class="line"></span><br><span class="line">0000000000001030 &lt;__cxa_finalize@plt&gt;:</span><br><span class="line">    1030:       f3 0f 1e fa             endbr64</span><br><span class="line">    1034:       f2 ff 25 bd 2f 00 00    bnd jmpq *0x2fbd(%rip)        <span class="comment"># 3ff8 &lt;__cxa_finalize@GLIBC_2.2.5&gt;</span></span><br><span class="line">    103b:       0f 1f 44 00 00          nopl   0x0(%rax,%rax,1)</span><br><span class="line"></span><br><span class="line">Disassembly of section .text:</span><br><span class="line"></span><br><span class="line">0000000000001040 &lt;_start&gt;:</span><br><span class="line">    1040:       f3 0f 1e fa             endbr64</span><br><span class="line">    1044:       31 ed                   xor    %ebp,%ebp</span><br><span class="line">    1046:       49 89 d1                mov    %rdx,%r9</span><br><span class="line">    1049:       5e                      pop    %rsi</span><br><span class="line">    104a:       48 89 e2                mov    %rsp,%rdx</span><br><span class="line">    104d:       48 83 e4 f0             and    <span class="variable">$0xfffffffffffffff0</span>,%rsp</span><br><span class="line">    1051:       50                      push   %rax</span><br><span class="line">    1052:       54                      push   %rsp</span><br><span class="line">    1053:       4c 8d 05 86 01 00 00    lea    0x186(%rip),%r8        <span class="comment"># 11e0 &lt;__libc_csu_fini&gt;</span></span><br><span class="line">    105a:       48 8d 0d 0f 01 00 00    lea    0x10f(%rip),%rcx        <span class="comment"># 1170 &lt;__libc_csu_init&gt;</span></span><br><span class="line">    1061:       48 8d 3d de 00 00 00    lea    0xde(%rip),%rdi        <span class="comment"># 1146 &lt;main&gt;</span></span><br><span class="line">    1068:       ff 15 72 2f 00 00       callq  *0x2f72(%rip)        <span class="comment"># 3fe0 &lt;__libc_start_main@GLIBC_2.2.5&gt;</span></span><br><span class="line">    106e:       f4                      hlt</span><br><span class="line">    106f:       90                      nop</span><br><span class="line"></span><br><span class="line">0000000000001070 &lt;deregister_tm_clones&gt;:</span><br><span class="line">    1070:       48 8d 3d 99 2f 00 00    lea    0x2f99(%rip),%rdi        <span class="comment"># 4010 &lt;__TMC_END__&gt;</span></span><br><span class="line">    1077:       48 8d 05 92 2f 00 00    lea    0x2f92(%rip),%rax        <span class="comment"># 4010 &lt;__TMC_END__&gt;</span></span><br><span class="line">    107e:       48 39 f8                cmp    %rdi,%rax</span><br><span class="line">    1081:       74 15                   je     1098 &lt;deregister_tm_clones+0x28&gt;</span><br><span class="line">    1083:       48 8b 05 4e 2f 00 00    mov    0x2f4e(%rip),%rax        <span class="comment"># 3fd8 &lt;_ITM_deregisterTMCloneTable&gt;</span></span><br><span class="line">    108a:       48 85 c0                <span class="built_in">test</span>   %rax,%rax</span><br><span class="line">    108d:       74 09                   je     1098 &lt;deregister_tm_clones+0x28&gt;</span><br><span class="line">    108f:       ff e0                   jmpq   *%rax</span><br><span class="line">    1091:       0f 1f 80 00 00 00 00    nopl   0x0(%rax)</span><br><span class="line">    1098:       c3                      retq</span><br><span class="line">    1099:       0f 1f 80 00 00 00 00    nopl   0x0(%rax)</span><br><span class="line"></span><br><span class="line">00000000000010a0 &lt;register_tm_clones&gt;:</span><br><span class="line">    10a0:       48 8d 3d 69 2f 00 00    lea    0x2f69(%rip),%rdi        <span class="comment"># 4010 &lt;__TMC_END__&gt;</span></span><br><span class="line">    10a7:       48 8d 35 62 2f 00 00    lea    0x2f62(%rip),%rsi        <span class="comment"># 4010 &lt;__TMC_END__&gt;</span></span><br><span class="line">    10ae:       48 29 fe                sub    %rdi,%rsi</span><br><span class="line">    10b1:       48 89 f0                mov    %rsi,%rax</span><br><span class="line">    10b4:       48 c1 ee 3f             shr    <span class="variable">$0x3f</span>,%rsi</span><br><span class="line">    10b8:       48 c1 f8 03             sar    <span class="variable">$0x3</span>,%rax</span><br><span class="line">    10bc:       48 01 c6                add    %rax,%rsi</span><br><span class="line">    10bf:       48 d1 fe                sar    %rsi</span><br><span class="line">    10c2:       74 14                   je     10d8 &lt;register_tm_clones+0x38&gt;</span><br><span class="line">    10c4:       48 8b 05 25 2f 00 00    mov    0x2f25(%rip),%rax        <span class="comment"># 3ff0 &lt;_ITM_registerTMCloneTable&gt;</span></span><br><span class="line">    10cb:       48 85 c0                <span class="built_in">test</span>   %rax,%rax</span><br><span class="line">    10ce:       74 08                   je     10d8 &lt;register_tm_clones+0x38&gt;</span><br><span class="line">    10d0:       ff e0                   jmpq   *%rax</span><br><span class="line">    10d2:       66 0f 1f 44 00 00       nopw   0x0(%rax,%rax,1)</span><br><span class="line">    10d8:       c3                      retq</span><br><span class="line">    10d9:       0f 1f 80 00 00 00 00    nopl   0x0(%rax)</span><br><span class="line"></span><br><span class="line">00000000000010e0 &lt;__do_global_dtors_aux&gt;:</span><br><span class="line">    10e0:       f3 0f 1e fa             endbr64</span><br><span class="line">    10e4:       80 3d 25 2f 00 00 00    cmpb   <span class="variable">$0x0</span>,0x2f25(%rip)        <span class="comment"># 4010 &lt;__TMC_END__&gt;</span></span><br><span class="line">    10eb:       75 2b                   jne    1118 &lt;__do_global_dtors_aux+0x38&gt;</span><br><span class="line">    10ed:       55                      push   %rbp</span><br><span class="line">    10ee:       48 83 3d 02 2f 00 00    cmpq   <span class="variable">$0x0</span>,0x2f02(%rip)        <span class="comment"># 3ff8 &lt;__cxa_finalize@GLIBC_2.2.5&gt;</span></span><br><span class="line">    10f5:       00</span><br><span class="line">    10f6:       48 89 e5                mov    %rsp,%rbp</span><br><span class="line">    10f9:       74 0c                   je     1107 &lt;__do_global_dtors_aux+0x27&gt;</span><br><span class="line">    10fb:       48 8b 3d 06 2f 00 00    mov    0x2f06(%rip),%rdi        <span class="comment"># 4008 &lt;__dso_handle&gt;</span></span><br><span class="line">    1102:       e8 29 ff ff ff          callq  1030 &lt;__cxa_finalize@plt&gt;</span><br><span class="line">    1107:       e8 64 ff ff ff          callq  1070 &lt;deregister_tm_clones&gt;</span><br><span class="line">    110c:       c6 05 fd 2e 00 00 01    movb   <span class="variable">$0x1</span>,0x2efd(%rip)        <span class="comment"># 4010 &lt;__TMC_END__&gt;</span></span><br><span class="line">    1113:       5d                      pop    %rbp</span><br><span class="line">    1114:       c3                      retq</span><br><span class="line">    1115:       0f 1f 00                nopl   (%rax)</span><br><span class="line">    1118:       c3                      retq</span><br><span class="line">    1119:       0f 1f 80 00 00 00 00    nopl   0x0(%rax)</span><br><span class="line"></span><br><span class="line">0000000000001120 &lt;frame_dummy&gt;:</span><br><span class="line">    1120:       f3 0f 1e fa             endbr64</span><br><span class="line">    1124:       e9 77 ff ff ff          jmpq   10a0 &lt;register_tm_clones&gt;</span><br><span class="line"></span><br><span class="line">0000000000001129 &lt;func_bug&gt;:</span><br><span class="line">    1129:       f3 0f 1e fa             endbr64</span><br><span class="line">    112d:       55                      push   %rbp</span><br><span class="line">    112e:       48 89 e5                mov    %rsp,%rbp</span><br><span class="line">    1131:       48 c7 45 f8 00 00 00    movq   <span class="variable">$0x0</span>,-0x8(%rbp)</span><br><span class="line">    1138:       00</span><br><span class="line">    1139:       48 8b 45 f8             mov    -0x8(%rbp),%rax</span><br><span class="line">    113d:       c7 00 02 00 00 00       movl   <span class="variable">$0x2</span>,(%rax)</span><br><span class="line">    1143:       90                      nop</span><br><span class="line">    1144:       5d                      pop    %rbp</span><br><span class="line">    1145:       c3                      retq</span><br><span class="line"></span><br><span class="line">0000000000001146 &lt;main&gt;:</span><br><span class="line">    1146:       f3 0f 1e fa             endbr64</span><br><span class="line">    114a:       55                      push   %rbp</span><br><span class="line">    114b:       48 89 e5                mov    %rsp,%rbp</span><br><span class="line">    114e:       48 83 ec 10             sub    <span class="variable">$0x10</span>,%rsp</span><br><span class="line">    1152:       c7 45 <span class="built_in">fc</span> 01 00 00 00    movl   <span class="variable">$0x1</span>,-0x4(%rbp)</span><br><span class="line">    1159:       b8 00 00 00 00          mov    <span class="variable">$0x0</span>,%eax</span><br><span class="line">    115e:       e8 c6 ff ff ff          callq  1129 &lt;func_bug&gt;</span><br><span class="line">    1163:       b8 00 00 00 00          mov    <span class="variable">$0x0</span>,%eax</span><br><span class="line">    1168:       c9                      leaveq</span><br><span class="line">    1169:       c3                      retq</span><br><span class="line">    116a:       66 0f 1f 44 00 00       nopw   0x0(%rax,%rax,1)</span><br><span class="line"></span><br><span class="line">0000000000001170 &lt;__libc_csu_init&gt;:</span><br><span class="line">    1170:       f3 0f 1e fa             endbr64</span><br><span class="line">    1174:       41 57                   push   %r15</span><br><span class="line">    1176:       4c 8d 3d 73 2c 00 00    lea    0x2c73(%rip),%r15        <span class="comment"># 3df0 &lt;__frame_dummy_init_array_entry&gt;</span></span><br><span class="line">    117d:       41 56                   push   %r14</span><br><span class="line">    117f:       49 89 d6                mov    %rdx,%r14</span><br><span class="line">    1182:       41 55                   push   %r13</span><br><span class="line">    1184:       49 89 f5                mov    %rsi,%r13</span><br><span class="line">    1187:       41 54                   push   %r12</span><br><span class="line">    1189:       41 89 <span class="built_in">fc</span>                mov    %edi,%r12d</span><br><span class="line">    118c:       55                      push   %rbp</span><br><span class="line">    118d:       48 8d 2d 64 2c 00 00    lea    0x2c64(%rip),%rbp        <span class="comment"># 3df8 &lt;__do_global_dtors_aux_fini_array_entry&gt;</span></span><br><span class="line">    1194:       53                      push   %rbx</span><br><span class="line">    1195:       4c 29 fd                sub    %r15,%rbp</span><br><span class="line">    1198:       48 83 ec 08             sub    <span class="variable">$0x8</span>,%rsp</span><br><span class="line">    119c:       e8 5f fe ff ff          callq  1000 &lt;_init&gt;</span><br><span class="line">    11a1:       48 c1 fd 03             sar    <span class="variable">$0x3</span>,%rbp</span><br><span class="line">    11a5:       74 1f                   je     11c6 &lt;__libc_csu_init+0x56&gt;</span><br><span class="line">    11a7:       31 db                   xor    %ebx,%ebx</span><br><span class="line">    11a9:       0f 1f 80 00 00 00 00    nopl   0x0(%rax)</span><br><span class="line">    11b0:       4c 89 f2                mov    %r14,%rdx</span><br><span class="line">    11b3:       4c 89 ee                mov    %r13,%rsi</span><br><span class="line">    11b6:       44 89 e7                mov    %r12d,%edi</span><br><span class="line">    11b9:       41 ff 14 <span class="built_in">df</span>             callq  *(%r15,%rbx,8)</span><br><span class="line">    11bd:       48 83 c3 01             add    <span class="variable">$0x1</span>,%rbx</span><br><span class="line">    11c1:       48 39 <span class="built_in">dd</span>                cmp    %rbx,%rbp</span><br><span class="line">    11c4:       75 ea                   jne    11b0 &lt;__libc_csu_init+0x40&gt;</span><br><span class="line">    11c6:       48 83 c4 08             add    <span class="variable">$0x8</span>,%rsp</span><br><span class="line">    11ca:       5b                      pop    %rbx</span><br><span class="line">    11cb:       5d                      pop    %rbp</span><br><span class="line">    11cc:       41 5c                   pop    %r12</span><br><span class="line">    11ce:       41 5d                   pop    %r13</span><br><span class="line">    11d0:       41 5e                   pop    %r14</span><br><span class="line">    11d2:       41 5f                   pop    %r15</span><br><span class="line">    11d4:       c3                      retq</span><br><span class="line">    11d5:       66 66 2e 0f 1f 84 00    data16 nopw %cs:0x0(%rax,%rax,1)</span><br><span class="line">    11dc:       00 00 00 00</span><br><span class="line"></span><br><span class="line">00000000000011e0 &lt;__libc_csu_fini&gt;:</span><br><span class="line">    11e0:       f3 0f 1e fa             endbr64</span><br><span class="line">    11e4:       c3                      retq</span><br><span class="line"></span><br><span class="line">Disassembly of section .fini:</span><br><span class="line"></span><br><span class="line">00000000000011e8 &lt;_fini&gt;:</span><br><span class="line">    11e8:       f3 0f 1e fa             endbr64</span><br><span class="line">    11ec:       48 83 ec 08             sub    <span class="variable">$0x8</span>,%rsp</span><br><span class="line">    11f0:       48 83 c4 08             add    <span class="variable">$0x8</span>,%rsp</span><br><span class="line">    11f4:       c3                      retq</span><br></pre></td></tr></tbody></table></figure>
<p>æŸ¥çœ‹ <code>0x113d</code> é™„è¿‘çš„ä»£ç æ®µ</p>
<figure class="highlight x86asm"><table><tbody><tr><td class="code"><pre><span class="line"><span class="number">0000000000001129</span> &lt;func_bug&gt;:</span><br><span class="line">    <span class="number">1129</span>:       f3 0f 1e fa             endbr64</span><br><span class="line">    <span class="number">112d</span>:       <span class="number">55</span>                      <span class="keyword">push</span>   %rbp</span><br><span class="line">    112e:       <span class="number">48</span> <span class="number">89</span> e5                <span class="keyword">mov</span>    %rsp,%rbp</span><br><span class="line">    <span class="number">1131</span>:       <span class="number">48</span> c7 <span class="number">45</span> f8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    <span class="keyword">movq</span>   <span class="number">$0</span>x0,-<span class="number">0x8</span>(%rbp)</span><br><span class="line">    <span class="number">1138</span>:       <span class="number">00</span></span><br><span class="line">    <span class="number">1139</span>:       <span class="number">48</span> 8b <span class="number">45</span> f8             <span class="keyword">mov</span>    -<span class="number">0x8</span>(%rbp),%rax</span><br><span class="line">    <span class="number">113d</span>:       c7 <span class="number">00</span> <span class="number">02</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       movl   <span class="number">$0</span>x2,(%rax)</span><br><span class="line">    <span class="number">1143</span>:       <span class="number">90</span>                      <span class="keyword">nop</span></span><br><span class="line">    <span class="number">1144</span>:       <span class="number">5d</span>                      <span class="keyword">pop</span>    %rbp</span><br><span class="line">    <span class="number">1145</span>:       c3                      retq</span><br></pre></td></tr></tbody></table></figure>
<p>ç»“åˆæºç ä»¥åŠæ±‡ç¼–çš„å‰åå†…å®¹ä¸éš¾åˆ†æå‡º <code>movl $0x2,(%rax)</code>
ä¸æºä»£ç  <code>*p = 2;</code> å¯¹åº” è€Œ <code>movq $0x0,-0x8(%rbp)</code>
ä»¥åŠ <code>mov -0x8(%rbp),%rax</code> ä¸æºä»£ç ä¸­çš„
<code>int *p = NULL;</code> å¯¹åº”</p>
<p>å› æ­¤ä¸éš¾åˆ¤æ–­å‡ºå®é™…çš„å‡ºé”™åŸå› ä¸ºå¯¹ç©ºæŒ‡é’ˆçš„è¿›è¡Œäº†å†™æ“ä½œ</p>
<h4 id="ä¼˜åŒ–">ä¼˜åŒ–</h4>
<ul>
<li>èµ·å§‹åœ°å€</li>
</ul>
<p>é€šå¸¸å‡ºé”™çš„ç¨‹åºå¯èƒ½ä¼šæ¯”è¾ƒå¤§ï¼Œåæ±‡ç¼–æ•´ä¸ªç¨‹åºä¼šéå¸¸è€—æ—¶ï¼Œæ­¤æ—¶å¯ä»¥é€šè¿‡
<code>objdump</code> çš„
<code>--start-address=xxx --stop-address=xxx</code>
é€‰é¡¹æ¥æŒ‡å®šåæ±‡ç¼–çš„å¼€å§‹åœ°å€å’Œç»“æŸåœ°å€</p>
<p>ä¾‹å¦‚ï¼š</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ objdump -d --start-address=0x1129 --stop-address=0x1146 ./test</span><br><span class="line"></span><br><span class="line">./test:     file format elf64-x86-64</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Disassembly of section .text:</span><br><span class="line"></span><br><span class="line">0000000000001129 &lt;func_bug&gt;:</span><br><span class="line">    1129:       f3 0f 1e fa             endbr64</span><br><span class="line">    112d:       55                      push   %rbp</span><br><span class="line">    112e:       48 89 e5                mov    %rsp,%rbp</span><br><span class="line">    1131:       48 c7 45 f8 00 00 00    movq   <span class="variable">$0x0</span>,-0x8(%rbp)</span><br><span class="line">    1138:       00</span><br><span class="line">    1139:       48 8b 45 f8             mov    -0x8(%rbp),%rax</span><br><span class="line">    113d:       c7 00 02 00 00 00       movl   <span class="variable">$0x2</span>,(%rax)</span><br><span class="line">    1143:       90                      nop</span><br><span class="line">    1144:       5d                      pop    %rbp</span><br><span class="line">    1145:       c3                      retq</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>æºä»£ç å‚ç…§</li>
</ul>
<p>å¦‚æœç¼–è¯‘æ—¶æŒ‡å®šçš„ <code>-g</code> ä¹Ÿå°±æ˜¯æœ‰ debug ä¿¡æ¯çš„è¯ï¼Œå¯ä»¥é€šè¿‡
<code>objdump</code> çš„ <code>-S -l</code>
é€‰é¡¹æ¥å°†æ±‡ç¼–æŒ‡ä»¤ä¸æºä»£ç è¿›è¡Œå¯¹ç…§</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ gcc -g test.c -o <span class="built_in">test</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># -S éšå« -d</span></span><br><span class="line">$ objdump -S -l --start-address=0x1129 --stop-address=0x1146 ./test</span><br><span class="line"></span><br><span class="line">./test:     file format elf64-x86-64</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Disassembly of section .text:</span><br><span class="line"></span><br><span class="line">0000000000001129 &lt;func_bug&gt;:</span><br><span class="line">func_bug():</span><br><span class="line">/home/wangyu/test.c:3</span><br><span class="line"><span class="comment">#include &lt;stdio.h&gt;</span></span><br><span class="line"></span><br><span class="line">void <span class="function"><span class="title">func_bug</span></span>() {</span><br><span class="line">    1129:       f3 0f 1e fa             endbr64</span><br><span class="line">    112d:       55                      push   %rbp</span><br><span class="line">    112e:       48 89 e5                mov    %rsp,%rbp</span><br><span class="line">/home/wangyu/test.c:4</span><br><span class="line">    int *p = NULL;</span><br><span class="line">    1131:       48 c7 45 f8 00 00 00    movq   <span class="variable">$0x0</span>,-0x8(%rbp)</span><br><span class="line">    1138:       00</span><br><span class="line">/home/wangyu/test.c:5</span><br><span class="line">    *p = 2;</span><br><span class="line">    1139:       48 8b 45 f8             mov    -0x8(%rbp),%rax</span><br><span class="line">    113d:       c7 00 02 00 00 00       movl   <span class="variable">$0x2</span>,(%rax)</span><br><span class="line">/home/wangyu/test.c:6</span><br><span class="line">}</span><br><span class="line">    1143:       90                      nop</span><br><span class="line">    1144:       5d                      pop    %rbp</span><br><span class="line">    1145:       c3                      retq</span><br></pre></td></tr></tbody></table></figure>
<h2 id="äº‹ä¸­">äº‹ä¸­</h2>
<h3 id="æœ€å¼ºå·¥å…·-gdb">æœ€å¼ºå·¥å…· GDB</h3>
<p>TODO</p>
<h2 id="äº‹å…ˆ">äº‹å…ˆ</h2>
<h3 id="printf"><code>printf</code></h3>
<p>è™½ç„¶ <code>printf</code>
æ˜¯æœ€ç®€å•çš„è°ƒè¯•æ–¹æ³•ï¼Œä½†æ˜¯ä¹Ÿæ˜¯æœ€å¸¸ç”¨çš„è°ƒè¯•æ–¹æ³•ï¼ŒåŸºæœ¬ä¸Šæ²¡æœ‰
<code>printf</code> è°ƒè¯•ä¸å‡ºæ¥çš„ bug</p>
<p><strong>ä¸€èˆ¬æµç¨‹å¦‚ä¸‹ï¼š</strong></p>
<ol type="1">
<li>é€šå¸¸å¯¹äºä¸€èˆ¬çš„
bugï¼Œå¯ä»¥å…ˆæ ¹æ®å‡ºé”™æ—¶çš„ç¨‹åºè¾“å‡ºï¼Œå¤§è‡´ä¼°è®¡å‡ºé”™çš„ä½ç½®</li>
<li>ç„¶ååœ¨æºä»£ç ä¸­æ’å…¥æ‰“å°è¯­å¥ï¼Œé‡æ–°ç¼–è¯‘ï¼Œå†æ¬¡è¿è¡Œç¨‹åº</li>
<li>ç»§ç»­è§‚å¯Ÿæ‰“å°çš„è¾“å‡ºï¼Œä¸€æ­¥æ­¥çš„ç¼©å°å‡ºé”™çš„èŒƒå›´ï¼Œæœ€ç»ˆå®šä½åˆ°å‡ºé”™çš„ä½ç½®</li>
<li>ç„¶åå°±å¯ä»¥æ‰“å°å‡ºé”™ä½ç½®çš„ç›¸åº”å˜é‡çš„å€¼ï¼Œè¿›è€Œåˆ†æå‡ºé”™åŸå› </li>
</ol>
<p><strong>ç¼ºç‚¹ï¼š</strong></p>
<p>ä½†æ˜¯ç„¶è€Œ <code>printf</code>
æœ¬èº«ä¼šé€ æˆç¨‹åºçš„è¿è¡Œæ•ˆç‡é™ä½ï¼Œæœ‰æ—¶ä¼šå‡ºç°<strong>åŠ äº† <code>printf</code>
ä¹‹å bug å¤ç°ä¸äº†ï¼Œå»æ‰ <code>printf</code> ä¹‹å bug
åˆå¤ç°äº†</strong>çš„æƒ…å†µ</p>
<p>è¿™ç§æƒ…å†µä¸‹å°±éœ€è¦ä¼˜åŒ– <code>printf</code> çš„æ–¹å¼ï¼Œä¾‹å¦‚<strong>æ”¹ç”¨
<code>sprintf</code> å°†å†…å®¹è¾“å‡ºåˆ°å†…å­˜ä¸­ï¼Œç„¶åé€šè¿‡å•ç‹¬çš„çº¿ç¨‹
<code>fprintf</code>
è½¬å‚¨åˆ°æ–‡ä»¶ä¸­</strong>ï¼Œè¿™æ ·å°±ä¼šå‡å°‘å¯¹ç¨‹åºçš„è¿è¡Œæ•ˆç‡çš„å½±å“</p>
<p>å½“ç„¶ä¹Ÿå¯ä»¥æ¢ç”¨åç»­çš„å…¶ä»–çš„è°ƒè¯•æ–¹æ³•</p>
<h3 id="assert"><code>assert</code></h3>
<p><code>assert</code> æ˜¯ C/C++
ä¸­çš„ä¸€ä¸ªå®ï¼Œç”¨äºåˆ¤æ–­ä¸€ä¸ªè¡¨è¾¾å¼æ˜¯å¦ä¸ºçœŸï¼Œå¦‚æœä¸ºå‡ï¼Œåˆ™è¾“å‡ºé”™è¯¯ä¿¡æ¯ï¼Œå¹¶ç»ˆæ­¢ç¨‹åºçš„è¿è¡Œ</p>
<figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> {</span><br><span class="line">    <span class="type">int</span> a = <span class="number">1</span>;</span><br><span class="line">    assert(a == <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>ä¾‹å¦‚ä¸Šè¿°ä»£ç ä¼šè¾“å‡ºå¦‚ä¸‹é”™è¯¯ä¿¡æ¯ï¼Œå¹¶ç»ˆæ­¢ç¨‹åºçš„è¿è¡Œï¼š</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">test</span>: test.c:5: main: Assertion `a == 2<span class="string">' failed.</span></span><br><span class="line"><span class="string">[1]    3563773 abort (core dumped)  ./test</span></span><br></pre></td></tr></tbody></table></figure>
<p>å› æ­¤æˆ‘ä»¬å¯ä»¥æå‰åœ¨ä¸€äº›å¯èƒ½å‡ºé”™çš„åœ°æ–¹æ’å…¥ <code>assert</code>
è¯­å¥ï¼Œå½“ç¨‹åºè¿è¡Œåˆ°è¿™é‡Œæ—¶ï¼Œå¦‚æœ <code>assert</code>
è¯­å¥ä¸æˆç«‹ï¼Œåˆ™ä¼šè¾“å‡ºé”™è¯¯ä¿¡æ¯ï¼Œå¹¶ç»ˆæ­¢ç¨‹åºçš„è¿è¡Œï¼Œä»è€Œå¿«é€Ÿå®šä½åˆ°å‡ºé”™çš„åŸå› </p>
<p><strong>ç¼ºç‚¹ï¼š</strong></p>
<p>ä¸ <code>printf</code> ä¸€æ ·ï¼Œ<code>assert</code>
ä¹Ÿä¼šé€ æˆç¨‹åºçš„è¿è¡Œæ•ˆç‡ç¨å¾®é™ä½ï¼Œä½†æ˜¯ä¸€èˆ¬ä¸ä¼šå½±å“åˆ° bug çš„å¤ç°</p>
<p>ä½†æ˜¯ä¸ºäº†ç¨‹åºçš„è¿è¡Œæ•ˆç‡ï¼Œç¨‹åº <code>release</code> ç‰ˆæœ¬çš„æ—¶å€™åº”è¯¥å°†
<code>assert</code> è¯­å¥å»æ‰ï¼Œæˆ–è€…åˆ©ç”¨å®å®šä¹‰ï¼Œåœ¨ <code>release</code>
çš„æ—¶å€™å°† <code>assert</code> è¯­å¥æ›¿æ¢æˆç©ºè¯­å¥</p>
<p>ä¾‹å¦‚ï¼š</p>
<figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// #define DEBUG</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> DEBUG</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ASSERT(x) assert(x)</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ASSERT(x)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></tbody></table></figure>
<h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h2>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9tYW43Lm9yZy9saW51eC9tYW4tcGFnZXMvbWFuMS9hZGRyMmxpbmUuMS5odG1s">ã€manã€‘addr2line<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9tYW43Lm9yZy9saW51eC9tYW4tcGFnZXMvbWFuMS9vYmpkdW1wLjEuaHRtbA==">ã€manã€‘objdump<i class="fa fa-external-link-alt"></i></span></li>
</ul>
]]></content>
      <categories>
        <category>æ—¥å¸¸è¸©å‘</category>
      </categories>
      <tags>
        <tag>todo</tag>
        <tag>æ—¥å¸¸è¸©å‘</tag>
        <tag>Debug</tag>
        <tag>GDB</tag>
        <tag>åæ±‡ç¼–</tag>
      </tags>
  </entry>
  <entry>
    <title>è§£å†³ pip å®‰è£…ç¬¬ä¸‰æ–¹åŒ…æ—¶å›  SSL æŠ¥é”™</title>
    <url>/posts/2e7aa01a.html</url>
    <content><![CDATA[<h2 id="è¸©å‘">è¸©å‘</h2>
<p>å¥½ä¹…æ²¡ç”¨ <code>python</code>ï¼Œæœ€è¿‘é‡æ–°ä¸‹è½½å®‰è£…å¥½ <code>python</code>
åå‘ç°ç”¨ <code>pip</code>
å®‰è£…ç¬¬ä¸‰æ–¹åŒ…ä¸€ç›´å¤±è´¥ã€‚ç»è¿‡ä¸€ç•ªæŠ˜è…¾å‘ç°ï¼Œå¦‚æœæŠ¥é”™ä¿¡æ¯ç¬¦åˆä¸‹é¢ä¸¤ç§ï¼Œä¸€èˆ¬éƒ½æ˜¯å› ä¸ºç½‘ç»œè¿æ¥æ—¶
SSL è®¤è¯å¤±è´¥å¯¼è‡´çš„ <span id="more"></span></p>
<ol type="1">
<li><p>check_hostname requires server_hostname</p>
<blockquote>
<p><code>raise ValueError("check_hostname requires server_hostname")</code>
<code>ValueError: check_hostname requires server_hostname</code></p>
</blockquote></li>
<li><p>EOF occurred in violation of protocol</p>
<blockquote>
<p><code>Could not fetch URL https://pypi.org/simple/xxx/: There was a problem confirming the ssl certificate: HTTPSConnectionPool(host='pypi.org', port=443): Max retries exceeded with url: /simple/xxx/ (Caused by SSLError(SSLEOFError(8, 'EOF occurred in violation of protocol (_ssl.c:997)'))) - skipping</code></p>
</blockquote></li>
</ol>
<h2 id="ä»€ä¹ˆæ˜¯-ssl">ä»€ä¹ˆæ˜¯ SSL ï¼Ÿ</h2>
<p>ä¼ è¾“å±‚å®‰å…¨æ€§åè®®ï¼ˆè‹±è¯­ï¼šTransport Layer
Securityï¼ŒTLSï¼‰åŠå…¶å‰èº«å®‰å…¨å¥—æ¥å±‚ï¼ˆè‹±è¯­ï¼šSecure Sockets
Layerï¼ŒSSLï¼‰æ˜¯ç°åœ¨çš„ HTTPS
åè®®ä¸­çš„ä¸€ç§å®‰å…¨åè®®ï¼Œç›®çš„æ˜¯ä¸ºäº’è”ç½‘é€šä¿¡æä¾›å®‰å…¨åŠæ•°æ®å®Œæ•´æ€§ä¿éšœ</p>
<p>è€Œè¾ƒæ–°ç‰ˆæœ¬çš„ <code>python</code> å†…ç½®çš„ <code>pip</code>
ä»¥åŠç”¨äºç½‘ç»œè¯·æ±‚çš„ <code>requests</code>ã€<code>urllib3</code>
åŒ…ä¹Ÿè¾ƒæ–°ï¼Œå¹¶ä¸”ä¼šä½¿ç”¨ HTTPS åè®®æ¥ä¸‹è½½æ–°çš„è½¯ä»¶åŒ…</p>
<h2 id="ä¸ºä»€ä¹ˆä¼šæŠ¥é”™">ä¸ºä»€ä¹ˆä¼šæŠ¥é”™</h2>
<p>æ ¹æ®æŠ¥é”™ä¿¡æ¯å¯ä»¥å‘ç°é”™è¯¯çš„æ ¹æºå°±åœ¨äº
SSLï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰é€šè¿‡è¯¥å®‰å…¨åè®®çš„è®¤è¯ï¼Œé€šå¸¸æ˜¯ç”±äºå¼€å¯äº†ç½‘ç»œä»£ç†ã€VPN
æˆ–è€…ç½‘ç»œæŠ“åŒ…ç­‰è½¯ä»¶çš„å¯¼è‡´çš„</p>
<h2 id="è§£å†³åŠæ³•">è§£å†³åŠæ³•</h2>
<h3 id="ä¸´æ—¶å…³é—­ä»£ç†vpn-æˆ–è€…ç½‘ç»œæŠ“åŒ…ç­‰è½¯ä»¶">1. ä¸´æ—¶å…³é—­ä»£ç†ã€VPN
æˆ–è€…ç½‘ç»œæŠ“åŒ…ç­‰è½¯ä»¶</h3>
<p>æœ€æ¨èçš„åŠæ³•æ˜¯ä¸´æ—¶å…³é—­ä»£ç†ã€VPN
æˆ–è€…ç½‘ç»œæŠ“åŒ…ç­‰è½¯ä»¶ï¼Œä½†æ˜¯å¦‚æœå…³é—­åä¸‹è½½é€Ÿåº¦è¿‡æ…¢å¯ä»¥å°è¯•åé¢ä¸¤ç§è§£å†³åŠæ³•</p>
<h3 id="é€šè¿‡é•œåƒçš„-http-æºæ¥é¿å…-ssl-è®¤è¯é—®é¢˜">2. é€šè¿‡é•œåƒçš„ HTTP
æºæ¥é¿å… SSL è®¤è¯é—®é¢˜</h3>
<p>ç”±äºæ˜¯ SSL æ˜¯ HTTPS åè®®éœ€è¦çš„ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åˆ‡æ¢è‡³ HTTP
çš„é•œåƒç«™æ¥è¿›è¡Œå®‰è£…ä¸‹è½½</p>
<p>HTTPS ç°åœ¨å·²ç»æ¯”è¾ƒæ™®åŠï¼Œæœ‰ä¸å°‘é•œåƒæºä¹Ÿæ—©å·²ç»åˆ‡æ¢è‡³ HTTPS
åè®®ï¼Œä½†éƒ¨åˆ†é•œåƒæºåœ¨æ”¯æŒ HTTPS åè®®çš„è€ŒåŒæ—¶ä¹Ÿè¿˜æ”¯æŒ HTTP
åè®®ï¼Œä¸‹é¢ç®€å•ç½—åˆ—å‡ ä¸ª <code>pip</code> é•œåƒæº</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># æ¸…åï¼Œä»…æ”¯æŒ HTTPS</span></span><br><span class="line">https://pypi.tuna.tsinghua.edu.cn/simple/</span><br><span class="line"></span><br><span class="line"><span class="comment"># é˜¿é‡Œï¼ŒHTTP å’Œ HTTPS å‡æ”¯æŒ</span></span><br><span class="line">http://mirrors.aliyun.com/pypi/simple/</span><br><span class="line">https://mirrors.aliyun.com/pypi/simple/</span><br><span class="line"></span><br><span class="line"><span class="comment"># è±†ç“£ï¼ŒHTTP å’Œ HTTPS å‡æ”¯æŒ</span></span><br><span class="line">http://pypi.doubanio.com/simple/</span><br><span class="line">https://pypi.doubanio.com/simple/</span><br></pre></td></tr></tbody></table></figure>
<p>å®‰è£…æ—¶ç¬¬ä¸‰æ–¹åŒ…æ—¶å¯ä»¥å‚è€ƒå¦‚ä¸‹å‘½ä»¤ï¼š</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">pip install xxx-package -i http://mirrors.aliyun.com/pypi/simple/ --trusted-host mirrors.aliyun.com</span><br><span class="line">pip install xxx-package -i http://pypi.doubanio.com/simple/ --trusted-host pypi.doubanio.com</span><br></pre></td></tr></tbody></table></figure>
<p>å¦‚æœæƒ³æ°¸ä¹…ä½¿ç”¨é•œåƒç«™ï¼Œåˆ™éœ€è¦ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œä»¥ Linux ä¸ºä¾‹ï¼š</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">vim ~/.pip/pip.conf</span><br></pre></td></tr></tbody></table></figure>
<p>ä¿®æ”¹æ–‡ä»¶å†…å®¹å¦‚ä¸‹</p>
<figure class="highlight ini"><table><tbody><tr><td class="code"><pre><span class="line"><span class="section">[global]</span></span><br><span class="line"><span class="attr">index-url</span> = http://mirrors.aliyun.com/pypi/simple/</span><br><span class="line"></span><br><span class="line"><span class="section">[install]</span></span><br><span class="line"><span class="attr">trusted-host</span> = mirrors.aliyun.com</span><br></pre></td></tr></tbody></table></figure>
<h3 id="åˆ‡æ¢è‡³ä½ç‰ˆæœ¬-pip">3. åˆ‡æ¢è‡³ä½ç‰ˆæœ¬ <code>pip</code></h3>
<p>ç»è¿‡æµ‹è¯•ï¼Œå½“ <code>pip</code> ç‰ˆæœ¬é«˜äº <span class="exturl" data-url="aHR0cHM6Ly9weXBpLm9yZy9wcm9qZWN0L3BpcC8yMC4zLyNoaXN0b3J5">20.3<i class="fa fa-external-link-alt"></i></span>
åæ‰ä¼šå‡ºç°æ­¤é”™è¯¯ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥æ‰‹åŠ¨å°† pip ç‰ˆæœ¬é™çº§è‡³ <code>20.2.4</code>
æˆ–è€… <code>20.3b1</code> ç­‰è¾ƒä½ç‰ˆæœ¬å³å¯</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">python -m pip install pip==20.2.4 -i http://mirrors.aliyun.com/pypi/simple/ --trusted-host mirrors.aliyun.com</span><br><span class="line">python -m pip install pip==20.2.4 -i http://pypi.doubanio.com/simple/ --trusted-host pypi.doubanio.com</span><br></pre></td></tr></tbody></table></figure>
<h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h2>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIuYWxpeXVuLmNvbS9taXJyb3IvcHlwaQ==">ã€é˜¿é‡Œäº‘ã€‘PyPI
é•œåƒ<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3R6X3pzL2FydGljbGUvZGV0YWlscy84NzkzOTk3Nw==">ã€CSDNã€‘python
pip çš„å®‰è£…ã€æ›´æ–°ã€å¸è½½ã€é™çº§ã€å’Œä½¿ç”¨ pip ç®¡ç†åŒ…<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3lrdW4wODkvYXJ0aWNsZS9kZXRhaWxzLzEwNjA1Nzk1Mg==">ã€CSDNã€‘ä¿®æ”¹
pip é…ç½®æ–‡ä»¶è·¯å¾„ã€æ›´æ”¹ pip æºã€ä½¿ç”¨ pip å®‰è£…å·²ç»ä¸‹è½½çš„ whl æ–‡ä»¶<i class="fa fa-external-link-alt"></i></span></li>
</ul>
]]></content>
      <categories>
        <category>æ—¥å¸¸è¸©å‘</category>
      </categories>
      <tags>
        <tag>æ—¥å¸¸è¸©å‘</tag>
        <tag>pip</tag>
        <tag>python</tag>
        <tag>SSL</tag>
      </tags>
  </entry>
  <entry>
    <title>Windows å¹³å°æœ€å¼ºæ’­æ”¾å™¨ç»„åˆ â€”â€” Potplayer + LAV Filters + madVR + xy-SubFilter</title>
    <url>/posts/3b7ae835.html</url>
    <content><![CDATA[<p>æœ¬æ–‡ä¸»è¦æ¥æºäº VCB-Studio å®˜ç½‘çš„ <span class="exturl" data-url="aHR0cHM6Ly92Y2Itcy5jb20vYXJjaGl2ZXMvNzIyOA==">ç§‘æ™®æ•™ç¨‹<i class="fa fa-external-link-alt"></i></span>ï¼Œä¸ªäººé‡æ–°æ¢³ç†è¿›è¡Œå¤‡ä»½
<span id="more"></span></p>
<h2 id="å®‰è£…ç¨‹åº">å®‰è£…ç¨‹åº</h2>
<p>1ã€å®‰è£… <span class="exturl" data-url="aHR0cHM6Ly9wb3RwbGF5ZXIuZGF1bS5uZXQv">PotPlayer<i class="fa fa-external-link-alt"></i></span> å’Œ <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL05ldmNhaXJpZWwvTEFWRmlsdGVycy9yZWxlYXNlcw==">LAV
Filters<i class="fa fa-external-link-alt"></i></span></p>
<p>äºŒè€…éƒ½æ˜¯æ™®é€šçš„ <code>exe</code>
å®‰è£…åŒ…ï¼ŒåŒå‡»å¯åŠ¨å®‰è£…å³å¯ï¼Œå®‰è£…è¿‡ç¨‹ä¸­å¯ä»¥å…¨é»˜è®¤</p>
<p>2ã€å®‰è£… <span class="exturl" data-url="aHR0cDovL21hZHZyLmNvbS8=">madVR<i class="fa fa-external-link-alt"></i></span> å’Œ <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0N5YmVyYmVpbmcveHktVlNGaWx0ZXIvcmVsZWFzZXM=">xy-SubFilter<i class="fa fa-external-link-alt"></i></span></p>
<p>äºŒè€…éƒ½æ˜¯æ’ä»¶ï¼Œæ¨èå°†å…¶è§£å‹åˆ°å•ç‹¬çš„æ–‡ä»¶å¤¹ä¸­ï¼Œç„¶åç§»åŠ¨è‡³ Potplayer
ç›®å½•ä¸‹ï¼Œæœ€åä»¥ç®¡ç†å‘˜æƒé™è¿è¡Œå…¶ä¸­çš„å®‰è£…è„šæœ¬ <code>install.bat</code></p>
<h2 id="æ˜¾å¡é©±åŠ¨é…ç½®">æ˜¾å¡é©±åŠ¨é…ç½®</h2>
<p>é¦–å…ˆè§£é”æ˜¾å¡é©±åŠ¨ä¸Šçš„è‰²å½©ç®¡ç†èŒƒå›´å’Œæ˜¾ç¤ºå™¨è¾“å‡ºé…ç½®ï¼Œæ‰“å¼€ã€NVIDIA
æ§åˆ¶é¢æ¿ã€‘ï¼Œå‚è€ƒä¸‹å›¾è¿›è¡Œé…ç½®</p>
<figure>
<img data-src="/posts/3b7ae835/åŠ¨æ€èŒƒå›´.png" alt="åŠ¨æ€èŒƒå›´">
<figcaption aria-hidden="true">åŠ¨æ€èŒƒå›´</figcaption>
</figure>
<figure>
<img data-src="/posts/3b7ae835/æ˜¾ç¤ºå™¨è®¾ç½®.png" alt="æ˜¾ç¤ºå™¨è®¾ç½®">
<figcaption aria-hidden="true">æ˜¾ç¤ºå™¨è®¾ç½®</figcaption>
</figure>
<p>å…¶ä»–æ˜¾å¡é…ç½®ç±»ä¼¼ï¼Œè¿™é‡Œç•¥å»</p>
<h2 id="é…ç½®-potplayer">é…ç½® Potplayer</h2>
<p>é¦–å…ˆæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æœ€ç»ˆç›®æ ‡ï¼Œç”¨ PotPlayer éšä¾¿æ‰“å¼€ä¸€ä¸ªè§†é¢‘ï¼ŒæŒ‰ä¸€ä¸‹ Tab
é”®ï¼Œå³å¯è°ƒå‡º Potplayer è‡ªå¸¦çš„ OSD
èœå•ï¼Œçº¢æ¡†ä¸­çš„å†…å®¹æ˜¯é…ç½®å®Œæˆåçš„æœ€ä½³é…ç½®</p>
<figure>
<img data-src="/posts/3b7ae835/æœ€ç»ˆç›®æ ‡.png" alt="æœ€ç»ˆç›®æ ‡">
<figcaption aria-hidden="true">æœ€ç»ˆç›®æ ‡</figcaption>
</figure>
<p>ä¸‹é¢æˆ‘ä»¬ä¸€æ­¥ä¸€æ­¥è¿›è¡Œé…ç½®</p>
<h3 id="å…³é—­-potplayer-å†…ç½®æ»¤é•œ">å…³é—­ Potplayer å†…ç½®æ»¤é•œ</h3>
<p>åœ¨æ’­æ”¾è§†é¢‘ï¼ˆæš‚åœä¹Ÿå¯ä»¥ï¼‰æ—¶ <code>å³é”®-é€‰é¡¹</code>ï¼Œæˆ–è€…ç›´æ¥
<code>F5</code> å¿«æ·é”®ï¼Œè¿›å…¥ <code>é€‰é¡¹</code> èœå•</p>
<p>åˆ‡è‡³ <code>æ»¤é•œ</code> é€‰é¡¹å¡ï¼Œå…³é—­ Pot å†…ç½®æ»¤é•œ</p>
<figure>
<img data-src="/posts/3b7ae835/å…³é—­å†…ç½®æ»¤é•œ.png" alt="å…³é—­å†…ç½®æ»¤é•œ">
<figcaption aria-hidden="true">å…³é—­å†…ç½®æ»¤é•œ</figcaption>
</figure>
<h3 id="æ·»åŠ -lav-æ»¤é•œè§£ç å™¨">æ·»åŠ  LAV æ»¤é•œ / è§£ç å™¨</h3>
<p>åˆ‡è‡³ <code>æ»¤é•œ-æºæ»¤é•œ/åˆ†ç¦»å™¨</code> é€‰é¡¹å¡ï¼Œç‚¹å‡»
<code>æ»¤é•œ/è§£ç å™¨ç®¡ç†</code></p>
<figure>
<img data-src="/posts/3b7ae835/æ·»åŠ %20LAV%20æ»¤é•œã€è§£ç å™¨-1.png" alt="æ·»åŠ  LAV æ»¤é•œã€è§£ç å™¨-1">
<figcaption aria-hidden="true">æ·»åŠ  LAV æ»¤é•œã€è§£ç å™¨ - 1</figcaption>
</figure>
<p>åœ¨æ–°çª—å£ä¸­ï¼Œç‚¹å‡» <code>æœç´¢åæ·»åŠ </code> åç¡®è®¤ LAV
çš„ç›¸å…³æ»¤é•œã€è§£ç å™¨å·²è¢«å‹¾é€‰ï¼Œç„¶åç‚¹å‡» <code>ç¡®å®š</code></p>
<figure>
<img data-src="/posts/3b7ae835/æ·»åŠ %20LAV%20æ»¤é•œã€è§£ç å™¨-2.png" alt="æ·»åŠ  LAV æ»¤é•œã€è§£ç å™¨-2">
<figcaption aria-hidden="true">æ·»åŠ  LAV æ»¤é•œã€è§£ç å™¨ - 2</figcaption>
</figure>
<h3 id="åˆ†ç¦»å™¨">åˆ†ç¦»å™¨</h3>
<p>åˆ‡è‡³ <code>æ»¤é•œ-æºæ»¤é•œ/åˆ†ç¦»å™¨</code> é€‰é¡¹å¡ ï¼Œå°†å³ä¾§çš„æ‰€æœ‰é€‰é¡¹éƒ½æ¢æˆ
LAV Splitter Sourceï¼Œæ— æ³•åˆ‡æ¢çš„å°±ä¿æŒåŸçŠ¶ï¼Œåˆ—è¡¨è¾ƒé•¿ï¼Œè®°å¾—æ»šè½®ç¿»é¡µ</p>
<figure>
<img data-src="/posts/3b7ae835/é…ç½®åˆ†ç¦»å™¨.png" alt="é…ç½®åˆ†ç¦»å™¨">
<figcaption aria-hidden="true">é…ç½®åˆ†ç¦»å™¨</figcaption>
</figure>
<h3 id="è§†é¢‘è§£ç å™¨">è§†é¢‘è§£ç å™¨</h3>
<p>åˆ‡è‡³ <code>æ»¤é•œ-è§†é¢‘è§£ç å™¨</code> é€‰é¡¹å¡ï¼Œå°†å³ä¾§çš„æ‰€æœ‰é€‰é¡¹éƒ½æ¢æˆ LAV
Video Decoderï¼Œæ— æ³•åˆ‡æ¢ä¸º LAV çš„å°±ä¿æŒåŸçŠ¶ï¼Œåˆ—è¡¨è¾ƒé•¿ï¼Œè®°å¾—æ»šè½®ç¿»é¡µ</p>
<figure>
<img data-src="/posts/3b7ae835/é…ç½®è§†é¢‘è§£ç å™¨.png" alt="é…ç½®è§†é¢‘è§£ç å™¨">
<figcaption aria-hidden="true">é…ç½®è§†é¢‘è§£ç å™¨</figcaption>
</figure>
<h3 id="è§†é¢‘æ¸²æŸ“å™¨">è§†é¢‘æ¸²æŸ“å™¨</h3>
<p>åˆ‡è‡³ <code>è§†é¢‘</code> é€‰é¡¹å¡ï¼Œè®¾ç½®è§†é¢‘æ¸²æŸ“æ–¹å¼ï¼Œé€‰æ‹©
<code>Madshi è§†é¢‘æ¸²æŸ“</code>ï¼Œä¹Ÿå°±æ˜¯ madVR</p>
<figure>
<img data-src="/posts/3b7ae835/é…ç½®è§†é¢‘æ¸²æŸ“å™¨.png" alt="é…ç½®è§†é¢‘æ¸²æŸ“å™¨">
<figcaption aria-hidden="true">é…ç½®è§†é¢‘æ¸²æŸ“å™¨</figcaption>
</figure>
<h3 id="éŸ³é¢‘è§£ç å™¨">éŸ³é¢‘è§£ç å™¨</h3>
<p>åˆ‡è‡³ <code>æ»¤é•œ-éŸ³é¢‘è§£ç å™¨</code> é€‰é¡¹å¡ ï¼Œå°†å³ä¾§çš„æ‰€æœ‰é€‰é¡¹éƒ½æ¢æˆ LAV
Audio Decoderï¼Œæ— æ³•åˆ‡æ¢çš„å°±ä¿æŒåŸçŠ¶ï¼Œåˆ—è¡¨è¾ƒé•¿ï¼Œè®°å¾—æ»šè½®ç¿»é¡µ</p>
<figure>
<img data-src="/posts/3b7ae835/é…ç½®éŸ³é¢‘è§£ç å™¨.png" alt="é…ç½®éŸ³é¢‘è§£ç å™¨">
<figcaption aria-hidden="true">é…ç½®éŸ³é¢‘è§£ç å™¨</figcaption>
</figure>
<h3 id="éŸ³é¢‘æ¸²æŸ“å™¨">éŸ³é¢‘æ¸²æŸ“å™¨</h3>
<p>åˆ‡è‡³ <code>å£°éŸ³</code> é€‰é¡¹å¡ï¼Œè®¾ç½®éŸ³é¢‘æ¸²æŸ“æ–¹å¼ï¼Œé€‰æ‹©
<code>å†…ç½® WSAPI éŸ³é¢‘æ¸²æŸ“å™¨</code></p>
<figure>
<img data-src="/posts/3b7ae835/é…ç½®éŸ³é¢‘æ¸²æŸ“å™¨.png" alt="é…ç½®éŸ³é¢‘æ¸²æŸ“å™¨">
<figcaption aria-hidden="true">é…ç½®éŸ³é¢‘æ¸²æŸ“å™¨</figcaption>
</figure>
<h3 id="å…¶ä»–">å…¶ä»–</h3>
<h4 id="è°ƒæ•™è¿›åº¦æ¡">è°ƒæ•™è¿›åº¦æ¡</h4>
<p>åˆ‡è‡³ <code>æ’­æ”¾</code>
é€‰é¡¹å¡ï¼Œå¼€å§‹è°ƒæ•™è¿›åº¦æ¡ï¼Œå°†è¿›åº¦æ¡çš„ç›¸å…³é…ç½®å…¨å¼€å¯</p>
<figure>
<img data-src="/posts/3b7ae835/è°ƒæ•™è¿›åº¦æ¡.png" alt="è°ƒæ•™è¿›åº¦æ¡">
<figcaption aria-hidden="true">è°ƒæ•™è¿›åº¦æ¡</figcaption>
</figure>
<h4 id="å…³é—­éŸ³é¢‘è§„æ ¼åŒ–">å…³é—­éŸ³é¢‘è§„æ ¼åŒ–</h4>
<p>åˆ‡è‡³ <code>å£°éŸ³-è§„æ ¼åŒ–/æ··å“</code> é€‰é¡¹å¡ï¼Œå…³é—­éŸ³é¢‘è§„æ ¼åŒ–ï¼Œé¿å…
potplayer ä¹±æ”¹éŸ³é‡</p>
<figure>
<img data-src="/posts/3b7ae835/å…³é—­éŸ³é¢‘è§„æ ¼åŒ–.png" alt="å…³é—­éŸ³é¢‘è§„æ ¼åŒ–">
<figcaption aria-hidden="true">å…³é—­éŸ³é¢‘è§„æ ¼åŒ–</figcaption>
</figure>
<h4 id="å¯ç”¨-xy-subfilter">å¯ç”¨ xy-SubFilter</h4>
<p>åˆ‡è‡³ <code>æ»¤é•œ-ä¸ªäººæ»¤é•œä¼˜å…ˆæƒ</code> é€‰é¡¹å¡ï¼Œç‚¹å‡»
<code>æ·»åŠ ç³»ç»Ÿæ»¤é•œ</code></p>
<figure>
<img data-src="/posts/3b7ae835/æ·»åŠ å­—å¹•æ»¤é•œ-1.png" alt="æ·»åŠ å­—å¹•æ»¤é•œ-1">
<figcaption aria-hidden="true">æ·»åŠ å­—å¹•æ»¤é•œ - 1</figcaption>
</figure>
<p>åœ¨æ–°çª—å£ä¸­ï¼Œé€‰ä¸­ xy-SubFilter çš„ç›¸å…³æ»¤é•œï¼Œç„¶åç‚¹å‡»
<code>ç¡®å®š</code></p>
<figure>
<img data-src="/posts/3b7ae835/æ·»åŠ å­—å¹•æ»¤é•œ-2.png" alt="æ·»åŠ å­—å¹•æ»¤é•œ-2">
<figcaption aria-hidden="true">æ·»åŠ å­—å¹•æ»¤é•œ - 2</figcaption>
</figure>
<p>ä¼˜å…ˆçº§è®¾ç½®ä¸Šï¼Œå°† XySubFilterAutoLoader è®¾ä¸ºå¼ºåˆ¶ä½¿ç”¨ï¼Œè´Ÿè´£å¤–æŒ‚å­—å¹•ï¼›
XySubFilter è®¾ä¸ºæŒ‰ä¼˜å…ˆçº§ä½¿ç”¨ï¼Œè´Ÿè´£å†…æŒ‚å­—å¹•</p>
<figure>
<img data-src="/posts/3b7ae835/é…ç½®å­—å¹•æ»¤é•œ.png" alt="é…ç½®å­—å¹•æ»¤é•œ">
<figcaption aria-hidden="true">é…ç½®å­—å¹•æ»¤é•œ</figcaption>
</figure>
<p>æ‰€æœ‰é…ç½®å®Œæˆåè®°å¾—ç‚¹å‡» <code>åº”ç”¨</code> å’Œ <code>ç¡®å®š</code>
æŒ‰é’®ä¿å­˜å½“å‰é…ç½®</p>
<h2 id="é…ç½®-lav-filters">é…ç½® LAV Filters</h2>
<p>åœ¨æ’­æ”¾è§†é¢‘ï¼ˆæš‚åœä¹Ÿå¯ä»¥ï¼‰æ—¶ <code>å³é”®-å±æ€§</code>ï¼Œæˆ–è€…ç›´æ¥
<code>Ctrl+F1</code> å¿«æ·é”®ï¼Œè¿›å…¥ <code>å±æ€§</code> èœå•</p>
<p>ç‚¹å‡»çº¢è‰²æ¡†å°±èƒ½è¿›å…¥è§†é¢‘ / éŸ³é¢‘è§£ç å™¨è®¾ç½®ç•Œé¢</p>
<figure>
<img data-src="/posts/3b7ae835/å±æ€§ç•Œé¢.png" alt="å±æ€§ç•Œé¢">
<figcaption aria-hidden="true">å±æ€§ç•Œé¢</figcaption>
</figure>
<h3 id="lav-è§†é¢‘è§£ç å™¨">LAV è§†é¢‘è§£ç å™¨</h3>
<p>è§†é¢‘è§£ç å™¨ä¿æŒ LAV é»˜è®¤è®¾ç½®å³å¯ï¼Œä¹Ÿå°±æ˜¯å‹¾é€‰é™¤äº† <code>AYUV</code>
ä»¥å¤–çš„æ‰€æœ‰é€‰é¡¹ï¼›<code>RGB Output Level</code> é€‰
<code>PC</code>ï¼›<code>Dither Mode</code> é€‰
<code>Random</code>ï¼›<code>Hardware Decoder to use</code> é€‰
<code>None</code></p>
<figure>
<img data-src="/posts/3b7ae835/LAV%20è§†é¢‘è§£ç å™¨.png" alt="LAV è§†é¢‘è§£ç å™¨">
<figcaption aria-hidden="true">LAV è§†é¢‘è§£ç å™¨</figcaption>
</figure>
<h3 id="lav-éŸ³é¢‘è§£ç å™¨">LAV éŸ³é¢‘è§£ç å™¨</h3>
<p>åœ¨éŸ³é¢‘è§£ç å™¨ä¸­ï¼Œåˆ‡æ¢è‡³ <code>Mixing</code> æ ‡ç­¾ï¼Œå‹¾ä¸Š
<code>Enable Mixing</code> å³å¯</p>
<figure>
<img data-src="/posts/3b7ae835/LAV%20éŸ³é¢‘è§£ç å™¨.png" alt="LAV éŸ³é¢‘è§£ç å™¨">
<figcaption aria-hidden="true">LAV éŸ³é¢‘è§£ç å™¨</figcaption>
</figure>
<h2 id="é…ç½®-madvr">é…ç½® madVR</h2>
<p>madVR ä¸ªäººæ²¡æœ‰æŠ˜è…¾ï¼Œç›´æ¥ç”¨é»˜è®¤é…ç½®</p>
<h2 id="ä½¿ç”¨-xy-subfilter">ä½¿ç”¨ xy-SubFilter</h2>
<p>ç”±äº Potplayer å†…ç½®äº†å­—å¹•æ’ä»¶ï¼ŒåŠ ä¸Šæˆ‘ä»¬é€‰æ‹© xy-SubFilter
æ¥å¤„ç†å­—å¹•ï¼Œæ‰€ä»¥éœ€è¦å…³é—­ Potplayer
å†…ç½®å­—å¹•æ’ä»¶ï¼Œå¦åˆ™å°±ä¼šå‡ºç°ä¸¤è¡Œå­—å¹•</p>
<p>å¯ä»¥é€šè¿‡å¿«æ·é”® <code>ALt+H</code> å¿«é€Ÿå¼€å…³å†…ç½®å­—å¹•</p>
<p>è€Œ xy-SubFilter
çš„å­—å¹•é€‰æ‹©å’Œå¼€å…³åˆ™éœ€è¦è¦åœ¨æ¡Œé¢å³ä¸‹è§’å°å›¾æ ‡å³é”®è¿›è¡Œåˆ‡æ¢</p>
<h2 id="å…¶ä»–é—®é¢˜">å…¶ä»–é—®é¢˜</h2>
<h3 id="å€æ•°æ’­æ”¾å­—å¹•å¼‚å¸¸">å€æ•°æ’­æ”¾å­—å¹•å¼‚å¸¸</h3>
<p>é€šè¿‡ <code>x</code>ã€<code>c</code>
å¿«æ·é”®è°ƒæ•´å€æ•°æ’­æ”¾ä¹‹åå‘ç°ï¼Œå­—å¹•æ˜¾ç¤ºé€Ÿåº¦æ²¡å˜ï¼Œç»è¿‡ä¸€ç•ªæœç´¢åœ¨ Anime
å­—å¹•è®ºå›çš„ <span class="exturl" data-url="aHR0cHM6Ly9iYnMuYWNncmlwLmNvbS90aHJlYWQtNTg0Mi0yLTEuaHRtbA==">ä¸€ç¯‡å¸–å­<i class="fa fa-external-link-alt"></i></span>
é‡Œé¢æ‰¾åˆ°äº†è§£å†³åŠæ³•ï¼šç›´æ¥ <code>Shift+X</code> å¼€å…³å£°éŸ³å¤„ç†æ»¤é•œå³å¯</p>
<h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h2>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9wb3RwbGF5ZXIuZGF1bS5uZXQv">ã€PotPlayer å®˜ç½‘ã€‘<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL05ldmNhaXJpZWwvTEFWRmlsdGVycy9yZWxlYXNlcw==">ã€GitHubã€‘LAV
Filters<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cDovL21hZHZyLmNvbS8=">ã€madVR å®˜ç½‘ã€‘<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0N5YmVyYmVpbmcveHktVlNGaWx0ZXIvcmVsZWFzZXM=">ã€GitHubã€‘xy-SubFilter<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly92Y2Itcy5jb20vYXJjaGl2ZXMvNzIyOA==">ã€VCB-Studio
å®˜ç½‘ã€‘ç§‘æ™®æ•™ç¨‹ 2.2â€”â€” åŸºäº PotPlayer å’Œ madVR çš„æ’­æ”¾å™¨æ•™ç¨‹ï¼ˆå·²æ›´æ–°
XySubFilterï¼‰<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9iYnMuYWNncmlwLmNvbS90aHJlYWQtNTg0Mi0yLTEuaHRtbA==">ã€Anime
å­—å¹•è®ºå›ã€‘å€é€Ÿæ’­æ”¾<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9hY2VjbGVlLmFydC9hcmNoaXZlcy8zMzE=">ã€ä¸ªäººåšå®¢ã€‘è§†é¢‘æ’­æ”¾å™¨ä½¿ç”¨æ•™ç¨‹<i class="fa fa-external-link-alt"></i></span></li>
</ul>
]]></content>
      <categories>
        <category>è½¯ä»¶é…ç½®</category>
      </categories>
      <tags>
        <tag>Potplayer</tag>
      </tags>
  </entry>
  <entry>
    <title>ä» SSLEOFError åˆ°æ­£ç¡®é…ç½® Proxy</title>
    <url>/posts/76f6af57.html</url>
    <content><![CDATA[<p>æœ¬æ–‡ä¸»è¦å‚è€ƒ <span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vZGF2eXl5L3AvMTQzODg2MjMuaHRtbA==">Python é­é‡
ProxyError é—®é¢˜è®°å½•<i class="fa fa-external-link-alt"></i></span> é‡æ–°æ¢³ç†æ”¹å†™</p>
<h2 id="è¸©å‘">è¸©å‘</h2>
<p>åœ¨å‰å‡ å¤©æå®š <code>pip</code> çš„ SSL è®¤è¯ä¹‹åï¼Œç»“æœåœ¨åˆ©ç”¨
<code>requests</code> åº“è¯·æ±‚ HTTPS ç½‘ç«™åˆå‡ºç°äº†
<code>SSLError(SSLEOFError(8, 'EOF occurred in violation of protocol (_ssl.c:1129)'))</code>
çš„ SSL ç›¸å…³é”™è¯¯</p>
<p>ç»è¿‡ä¸€ç³»åˆ—çš„æŸ¥è¯¢èµ„æ–™å’Œæµ‹è¯•å‘ç°ï¼ŒåŸå› ç«Ÿç„¶åœ¨äº <code>python</code>
è‡ªèº«çš„ <code>urllib</code> åº“æ²¡æœ‰æ­£ç¡®é…ç½® HTTPS ä»£ç† <span id="more"></span></p>
<h2 id="ä»£ç†æœåŠ¡å™¨">ä»£ç†æœåŠ¡å™¨</h2>
<h3 id="æ™®é€šçš„ä»£ç†æœåŠ¡å™¨">æ™®é€šçš„ä»£ç†æœåŠ¡å™¨</h3>
<figure>
<img data-src="/posts/76f6af57/Proxy_Server.png" alt="Proxy_Server">
<figcaption aria-hidden="true">Proxy_Server</figcaption>
</figure>
<p>ä¸Šé¢æåŠçš„ HTTP (S) ä»£ç†ï¼Œå…¶å®æ˜¯é€šè¿‡ä»£ç†æœåŠ¡å™¨è¿›è¡Œ HTTP (S)
æµé‡çš„è½¬å‘çš„æ„æ€ï¼Œä¹Ÿæ˜¯åœ¨ä¸Šå›¾ä¸­çš„ <em>é»„çº¿</em> æ‰€ä»£è¡¨çš„åè®®ï¼Œæ–‡ä¸­åç»­ç”¨
<u>å‡ºå£åè®®</u> æ¥æŒ‡ä»£</p>
<p>è€Œå’Œä»£ç†æœåŠ¡å™¨ä¹‹é—´å…¶å®ä¹Ÿéœ€è¦ä¸€ç§åè®®è¿›è¡Œé€šä¿¡ï¼Œå°±æ˜¯åœ¨ä¸Šå›¾ä¸­çš„
<em>ç»¿çº¿</em> éƒ¨åˆ†ï¼Œæ–‡ä¸­åç»­ç”¨ <u>å…¥å£åè®®</u> æ¥æŒ‡ä»£</p>
<p>è€Œ <u>å…¥å£åè®®</u> <strong>é€šå¸¸ä½¿ç”¨è¾ƒå¤šçš„éƒ½æ˜¯ HTTP å’Œ
Socks4/Socks5ï¼Œå¾ˆå°‘æœ‰é‡‡ç”¨ HTTPS
ä½œä¸ºä¸ä»£ç†æœåŠ¡å™¨é—´çš„è¿æ¥åè®®</strong>ï¼Œè¿™ç‚¹ä¹Ÿæ˜¯<strong>å¯¼è‡´ä¹‹å‰æŠ¥é”™çš„ä¸»è¦åŸå› </strong></p>
<h3 id="ç§‘å­¦ä¸Šç½‘å·¥å…·">ç§‘å­¦ä¸Šç½‘å·¥å…·</h3>
<p>å…¶å®ä»£ç†æœåŠ¡å™¨å’Œ SSã€SSRã€V2Rayã€Clash
ç­‰ç§‘å­¦ä¸Šç½‘ä»£ç†å·¥å…·éƒ½æ˜¯åŒä¸€ç§æ€§è´¨ï¼Œä¸»è¦çš„ä¸åŒç‚¹åœ¨äºä¸å®é™…ä»£ç†æœåŠ¡å™¨ä¹‹é—´çš„
<u>å…¥å£åè®®</u> éƒ¨åˆ†ï¼ˆä¾‹å¦‚ Shadowsocksã€VMessã€Trojan ç­‰ï¼‰ã€‚ä¸ºäº†ä¸è¢« GFW
å‘ç°ï¼Œéœ€è¦å®ç°å¯¹æµé‡çš„æ··æ·†åŠ å¯†ç­‰ã€‚è€Œä¸”é€šå¸¸ä¸ºäº†å…¼å®¹æ€§ç­‰å› ç´ ï¼Œå¤§å¤šæ•°ç§‘å­¦ä¸Šç½‘å·¥å…·åœ¨ä¸å®é™…ä»£ç†æœåŠ¡å™¨ä¹‹é—´è¿˜æœ‰ä¸€çº§æœ¬åœ°çš„ä»£ç†æœåŠ¡å™¨</p>
<figure>
<img data-src="/posts/76f6af57/Fuck_GFW.png" alt="Fuck_GFW">
<figcaption aria-hidden="true">Fuck_GFW</figcaption>
</figure>
<p>ç§‘å­¦ä¸Šç½‘å·¥å…·çš„ç‰¹æ®Šåè®®åªæ˜¯åœ¨ä¸Šå›¾ä¸­çš„åªæœ‰çº¢çº¿éƒ¨åˆ†ä½¿ç”¨ï¼Œè€Œæ•´ä¸ªè“è‰²æ¡†çš„éƒ¨åˆ†å°±æ˜¯ç§‘å­¦ä¸Šç½‘å·¥å…·ï¼Œç”¨æˆ·å¹¶ä¸éœ€è¦å…³å¿ƒè¿™äº›ç‰¹æ®Šåè®®ï¼Œåªéœ€è¦é€šè¿‡ä¸é€šå¸¸ä»£ç†æœåŠ¡å™¨ä¸€æ ·çš„
<em>ç»¿çº¿</em> çš„ <u>å…¥å£åè®®</u> æ¥è¿›è¡Œè¿æ¥å³å¯</p>
<h3 id="ä»£ç†é…ç½®">ä»£ç†é…ç½®</h3>
<p>å› æ­¤ <u>å…¥å£åè®®</u> å’Œ <u>å‡ºå£åè®®</u> ä¹‹é—´å…¶å®æ²¡æœ‰ä»»ä½•å› æœè”ç³»ï¼Œä»¥
<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0ZuZHJvaWQvY2xhc2hfZm9yX3dpbmRvd3NfcGtn">Clash for
Windows, CFW<i class="fa fa-external-link-alt"></i></span> ä¸ºä¾‹</p>
<figure>
<img data-src="/posts/76f6af57/Clash_for_Windows_Local_Proxy.png" alt="Clash_for_Windows_Local_Proxy">
<figcaption aria-hidden="true">Clash_for_Windows_Local_Proxy</figcaption>
</figure>
<p>å®ƒçš„ <u>å…¥å£åè®®</u> æ”¯æŒ http ä»¥åŠ
socksï¼Œè€Œä¸”éƒ½åœ¨åŒä¸€ä¸ªç«¯å£ï¼Œå› æ­¤æ­£ç¡®çš„ä»£ç†é…ç½®åº”è¯¥æ˜¯è¿™æ ·çš„ï¼š</p>
<figure class="highlight ini"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># æ­£ç¡®çš„é…ç½®æ–¹å¼</span></span><br><span class="line"><span class="attr">HTTP_PROXY</span>=http://<span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">7890</span></span><br><span class="line"><span class="attr">HTTPS_PROXY</span>=http://<span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">7890</span></span><br></pre></td></tr></tbody></table></figure>
<p>æˆ–è€…</p>
<figure class="highlight ini"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># æ­£ç¡®çš„é…ç½®æ–¹å¼</span></span><br><span class="line"><span class="attr">HTTP_PROXY</span>=socks5://<span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">7890</span></span><br><span class="line"><span class="attr">HTTPS_PROXY</span>=socks5://<span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">7890</span></span><br></pre></td></tr></tbody></table></figure>
<p><strong>é‡ç‚¹ï¼š</strong></p>
<p><code>HTTPS_PROXY</code> ä¹Ÿåº”è¯¥å¡«å†™
<code>http://127.0.0.1:7890</code>ï¼Œå› ä¸º <code>HTTPS_PROXY</code> ä¸­
<code>HTTPS</code> ä»£è¡¨çš„æ˜¯ <u>å‡ºå£åè®®</u>ï¼Œè€Œ
<code>http://127.0.0.1:7890</code> ä»£è¡¨å’Œ <code>127.0.0.1:7890</code>
æœåŠ¡å™¨ä¹‹é—´çš„ <u>å…¥å£åè®®</u> æ˜¯ <code>HTTP</code></p>
<h2 id="è¿½æ ¹æº¯æº">è¿½æ ¹æº¯æº</h2>
<figure class="highlight ini"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># é”™è¯¯çš„é…ç½®æ–¹å¼</span></span><br><span class="line"><span class="attr">HTTP_PROXY</span>=http://<span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">7890</span></span><br><span class="line"><span class="attr">HTTPS_PROXY</span>=https://<span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">7890</span></span><br></pre></td></tr></tbody></table></figure>
<p>è€Œä¹‹å‰ä¸€ç›´é‡‡ç”¨çš„ä¸Šè¿°é”™è¯¯é…ç½®ï¼Œåˆ™ä¼šå› ä¸ºæ—§ç‰ˆæœ¬çš„ <code>python</code> çš„
<code>pip</code> å†…å«çš„ <code>urllib3</code> ä¸æ”¯æŒ HTTPS çš„
<u>å…¥å£åè®®</u> ï¼Œè‡ªåŠ¨è½¬æ¢æˆäº† HTTP çš„ <u>å…¥å£åè®®</u> è¿›è¡Œè¿æ¥äº†</p>
<h3 id="urllib3">urllib3</h3>
<p>ä½†æ˜¯åœ¨ <code>urllib3</code> åº“å‡çº§åˆ° v1.26.0 ç‰ˆæœ¬ä¹‹åï¼Œå¢åŠ äº†å¯¹ HTTPS
çš„ <u>å…¥å£åè®®</u> çš„æ”¯æŒï¼Œå‚è§ <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3VybGxpYjMvdXJsbGliMy9jb21taXQvOGM3YTQzYjRhNGNhMGM4ZDM2ZDU1ZjEzMmRhYTJhNDNkMDZmZTNjNA==">Add
support for HTTPS connections to proxies.<i class="fa fa-external-link-alt"></i></span></p>
<figure>
<img data-src="/posts/76f6af57/Urllib3_Support_HTTPS.png" alt="Urllib3_Support_HTTPS">
<figcaption aria-hidden="true">Urllib3_Support_HTTPS</figcaption>
</figure>
<h3 id="pip">pip</h3>
<p><code>pip</code> å†…ç½®äº†çš„ <code>requests</code> å’Œ
<code>urllib3</code> åŒ…ï¼Œè€Œä¸ä¾èµ–å…¨å±€çš„ <code>requests</code> å’Œ
<code>urllib3</code> åŒ…</p>
<p>å½“ <code>pip</code> ç‰ˆæœ¬é«˜äº <span class="exturl" data-url="aHR0cHM6Ly9weXBpLm9yZy9wcm9qZWN0L3BpcC8yMC4zLyNoaXN0b3J5">20.3<i class="fa fa-external-link-alt"></i></span> æ—¶ï¼Œå†…ç½®çš„
<code>requests</code> åŒ…å‡çº§åˆ°äº† v2.25.0ï¼Œ<code>urllib3</code>
åŒ…ä¹Ÿå‡çº§åˆ°äº† v1.26.2ï¼Œä¹Ÿå°±æ˜¯è¯´å¼€å§‹æ”¯æŒ HTTPS çš„ <u>å…¥å£åè®®</u> äº†ï¼Œå‚è§
<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3B5cGEvcGlwL2Jsb2IvYzMxYzE0OGE1YjFkODc1OTE4NjJjNzE1YWRjN2E3ZTVmMzI0MmZiYS9ORVdTLnJzdCN2ZW5kb3JlZC1saWJyYXJpZXM=">pypa/pip
20.3 (2020-11-30) NEWS.rst<i class="fa fa-external-link-alt"></i></span></p>
<figure>
<img data-src="/posts/76f6af57/Pip_Support_HTTPS.png" alt="Pip_Support_HTTPS">
<figcaption aria-hidden="true">Pip_Support_HTTPS</figcaption>
</figure>
<h3 id="ä¸‡æ¶ä¹‹æº-urllib">ä¸‡æ¶ä¹‹æº urllib</h3>
<p>ä½†æ˜¯å…¶å®ä»–ä»¬éƒ½ä¸æ˜¯ç½ªé­ç¥¸é¦–ï¼ŒçœŸæ­£çš„åŸå› å…¶å®åœ¨ python çš„å†…ç½®åŒ…
<code>urllib</code> ä¸Š</p>
<p>ä¸€èˆ¬ <code>CFW</code> ç­‰ç§‘å­¦ä¸Šç½‘è½¯ä»¶éƒ½ä¼šé€šè¿‡ä¿®æ”¹ Windows æ³¨å†Œè¡¨çš„
<code>è®¡ç®—æœº\HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings</code>
ç›®å½•ä¸‹çš„ <code>ProxyServer</code> æ¥é…ç½®ä»£ç†æœåŠ¡å™¨åœ°å€ç«¯å£ä»¥åŠ
<code>ProxyEnable</code> æ˜¯å¦å¯ç”¨ä»£ç†</p>
<figure>
<img data-src="/posts/76f6af57/Win11_Reg.png" alt="Win11_Reg">
<figcaption aria-hidden="true">Win11_Reg</figcaption>
</figure>
<p><code>CFW</code> åœ¨é…ç½®ä»£ç†æœåŠ¡å™¨æ—¶ï¼Œä»…ä»…ç»™å‡ºäº†åœ°å€å’Œç«¯å£ï¼Œå¹¶æ²¡æœ‰ç»™å‡º
<u>å…¥å£åè®®</u></p>
<figure class="highlight py"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># urllib é…ç½®ä»£ç†çš„æºç æ‘˜å½•ï¼š</span></span><br><span class="line"><span class="keyword">if</span> <span class="string">'='</span> <span class="keyword">in</span> proxyServer:</span><br><span class="line">    <span class="comment"># Per-protocol settings</span></span><br><span class="line">    <span class="keyword">for</span> p <span class="keyword">in</span> proxyServer.split(<span class="string">';'</span>):</span><br><span class="line">        protocol, address = p.split(<span class="string">'='</span>, <span class="number">1</span>)</span><br><span class="line">        <span class="comment"># See if address has a type:// prefix</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> re.<span class="keyword">match</span>(<span class="string">'(?:[^/:]+)://'</span>, address):</span><br><span class="line">            address = <span class="string">'%s://%s'</span> % (protocol, address)</span><br><span class="line">        proxies[protocol] = address</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="comment"># Use one setting for all protocols</span></span><br><span class="line">    <span class="keyword">if</span> proxyServer[:<span class="number">5</span>] == <span class="string">'http:'</span>:</span><br><span class="line">        proxies[<span class="string">'http'</span>] = proxyServer</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        proxies[<span class="string">'http'</span>] = <span class="string">'http://%s'</span> % proxyServer</span><br><span class="line">        proxies[<span class="string">'https'</span>] = <span class="string">'https://%s'</span> % proxyServer</span><br><span class="line">        proxies[<span class="string">'ftp'</span>] = <span class="string">'ftp://%s'</span> % proxyServer</span><br></pre></td></tr></tbody></table></figure>
<p>æŒ‰ç…§ä¸Šé¢ç»™å‡ºçš„ <code>urllib</code> åº“æºç é€»è¾‘ï¼Œä¼šå°†ä»£ç†é…ç½®ä¸º</p>
<figure class="highlight py"><table><tbody><tr><td class="code"><pre><span class="line">proxies = {</span><br><span class="line">    <span class="string">'http'</span>: <span class="string">'http://127.0.0.1:7890'</span>,</span><br><span class="line">    <span class="string">'https'</span>: <span class="string">'https://127.0.0.1:7890'</span>,</span><br><span class="line">    <span class="string">'ftp'</span>: <span class="string">'ftp://127.0.0.1:7890'</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>å› æ­¤å¯¼è‡´äº† <code>pip</code>ã€<code>requests</code> ç­‰ä¸Šå±‚åŒ…ï¼Œè®¿é—®
HTTPS ç½‘ç«™æ—¶ä¼šé”™è¯¯çš„ä½¿ç”¨ <code>https://127.0.0.1:7890</code> ä»£ç†ï¼Œè€Œ
<code>CFW</code> æ ¹æœ¬ä¸æ”¯æŒ HTTPS çš„
<u>å…¥å£åè®®</u>ï¼Œæ‰€ä»¥æ‰ä¼šäº§ç”Ÿè¿™ä¹ˆä¸€ç³»åˆ—çš„é”™è¯¯</p>
<p>ä¸ªäººæ¨èå¯ä»¥æ ¹æ®è‡ªå·±å¸¸ç”¨çš„ç§‘å­¦ä¸Šç½‘å·¥å…·æ‰€æ”¯æŒçš„ <u>å…¥å£åè®®</u> æ¥ä¿®æ”¹
<code>urllib</code> åº“æºç é€»è¾‘ï¼ˆæ–‡ä»¶ä½ç½®ä¸€èˆ¬åœ¨
<code>***/python3.*/urllib/request.py</code> æˆ–è€…
<code>***/anaconda3/Lib/urllib/request.py</code>ï¼‰</p>
<figure class="highlight py"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="string">'='</span> <span class="keyword">in</span> proxyServer:</span><br><span class="line">    <span class="comment"># Per-protocol settings</span></span><br><span class="line">    <span class="keyword">for</span> p <span class="keyword">in</span> proxyServer.split(<span class="string">';'</span>):</span><br><span class="line">        protocol, address = p.split(<span class="string">'='</span>, <span class="number">1</span>)</span><br><span class="line">        <span class="comment"># See if address has a type:// prefix</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> re.<span class="keyword">match</span>(<span class="string">'(?:[^/:]+)://'</span>, address):</span><br><span class="line">            address = <span class="string">'%s://%s'</span> % (protocol, address)</span><br><span class="line">        proxies[protocol] = address</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="comment"># Use one setting for all protocols</span></span><br><span class="line">    proxies[<span class="string">'http'</span>] = <span class="string">'http://%s'</span> % proxyServer</span><br><span class="line">    proxies[<span class="string">'https'</span>] = <span class="string">'http://%s'</span> % proxyServer</span><br><span class="line">    proxies[<span class="string">'ftp'</span>] = <span class="string">'http://%s'</span> % proxyServer</span><br></pre></td></tr></tbody></table></figure>
<p>æˆ–è€…ç®€å•çš„æŒ‰ç…§ä¸‹é¢çš„æ–¹å¼è¿›è¡Œä¿®æ”¹ï¼ˆå¹¶ä¸ä¸€å®šé€‚ç”¨æ‰€æœ‰æƒ…å†µï¼‰</p>
<figure class="highlight py"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="string">'='</span> <span class="keyword">in</span> proxyServer:</span><br><span class="line">    <span class="comment"># Per-protocol settings</span></span><br><span class="line">    <span class="keyword">for</span> p <span class="keyword">in</span> proxyServer.split(<span class="string">';'</span>):</span><br><span class="line">        protocol, address = p.split(<span class="string">'='</span>, <span class="number">1</span>)</span><br><span class="line">        <span class="comment"># See if address has a type:// prefix</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> re.<span class="keyword">match</span>(<span class="string">'(?:[^/:]+)://'</span>, address):</span><br><span class="line">            address = <span class="string">'%s://%s'</span> % (protocol, address)</span><br><span class="line">        proxies[protocol] = address</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="comment"># Use one setting for all protocols</span></span><br><span class="line">    proxies[<span class="string">'http'</span>] = proxyServer</span><br><span class="line">    proxies[<span class="string">'https'</span>] = proxyServer</span><br><span class="line">    proxies[<span class="string">'ftp'</span>] = proxyServer</span><br></pre></td></tr></tbody></table></figure>
<h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h2>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vZGF2eXl5L3AvMTQzODg2MjMuaHRtbA==">ã€åšå®¢å›­ã€‘Python
é­é‡ ProxyError é—®é¢˜è®°å½•<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvJUU0JUJCJUEzJUU3JTkwJTg2JUU2JTlDJThEJUU1JThBJUExJUU1JTk5JUE4">ã€ç»´åŸºç™¾ç§‘ã€‘ä»£ç†æœåŠ¡å™¨<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0ZuZHJvaWQvY2xhc2hfZm9yX3dpbmRvd3NfcGtnL2lzc3Vlcy8zMTI=">ã€GitHubã€‘Fndroid/clash_for_windows_pkg
ç³»ç»Ÿä»£ç†è‡ªåŠ¨å…³é—­æˆ–æ‰“å¼€<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3B5cGEvcGlwL2lzc3Vlcy85MjE2I2lzc3VlY29tbWVudC03NDE4MzYwNTg=">ã€GitHubã€‘pypa/pip
Pip 20.3+ break proxy connection<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3VybGxpYjMvdXJsbGliMy9jb21taXQvOGM3YTQzYjRhNGNhMGM4ZDM2ZDU1ZjEzMmRhYTJhNDNkMDZmZTNjNA==">ã€GitHubã€‘urllib3/urllib3
Add support for HTTPS connections to proxies.<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3B5cGEvcGlwL2Jsb2IvYzMxYzE0OGE1YjFkODc1OTE4NjJjNzE1YWRjN2E3ZTVmMzI0MmZiYS9ORVdTLnJzdCN2ZW5kb3JlZC1saWJyYXJpZXM=">ã€GitHubã€‘pypa/pip
20.3 (2020-11-30) NEWS.rst<i class="fa fa-external-link-alt"></i></span></li>
</ul>
]]></content>
      <categories>
        <category>æ—¥å¸¸è¸©å‘</category>
      </categories>
      <tags>
        <tag>æ—¥å¸¸è¸©å‘</tag>
        <tag>python</tag>
        <tag>SSL</tag>
        <tag>proxy</tag>
      </tags>
  </entry>
  <entry>
    <title>io_uring å†…æ ¸æºç åˆ†æ</title>
    <url>/posts/4f0d345c.html</url>
    <content><![CDATA[<p>å½“å‰å†…å®¹åŸºäº Linux Kernel <span class="exturl" data-url="aHR0cHM6Ly9naXQua2VybmVsLm9yZy9wdWIvc2NtL2xpbnV4L2tlcm5lbC9naXQvc3RhYmxlL2xpbnV4LmdpdC90YWcvP2g9djUuNC4xMjE=">v5.4.121<i class="fa fa-external-link-alt"></i></span></p>
<h2 id="io_uring">1. <code>io_uring</code></h2>
<p><a href="/posts/c142853f.html#ç³»ç»Ÿè°ƒç”¨">ä¹‹å‰</a> ä»‹ç»è¿‡ io_uring
åªå¢åŠ äº†ä¸‰ä¸ª Linux ç³»ç»Ÿè°ƒç”¨åˆ†åˆ«æ˜¯
<code>io_uring_setup</code>ï¼Œ<code>io_uring_enter</code> å’Œ
<code>io_uring_register</code></p>
<p>ä»–ä»¬çš„å…¥å£éƒ½åœ¨ Linux å†…æ ¸æºç çš„ <code>fs/io_uring.c</code>
æ–‡ä»¶ä¸­ï¼Œä¸‹é¢å°†é€ä¸ªåˆ†æ <span id="more"></span></p>
<h2 id="ç³»ç»Ÿè°ƒç”¨-io_uring_setup">2. ç³»ç»Ÿè°ƒç”¨
<code>io_uring_setup</code></h2>
<p><code>io_uring_setup</code> çš„ä½œç”¨åœ¨ <a href="/posts/d7259d1d.html#io-uring-queue-init">ç”¨æˆ·åº“æºç åˆ†æ</a>
ä¸­æœ‰è¿‡ä»‹ç»ï¼Œä¸»è¦æ˜¯åˆå§‹åŒ–åˆå§‹åŒ– <code>io_uring</code> ç»“æ„ä½“</p>
<h3 id="io_uring_setup">2.1. <code>io_uring_setup</code></h3>
<figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Sets up an aio uring context, and returns the fd. Applications asks for a</span></span><br><span class="line"><span class="comment"> * ring size, we return the actual sq/cq ring sizes (among other things) in the</span></span><br><span class="line"><span class="comment"> * params structure passed in.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">long</span> <span class="title function_">io_uring_setup</span><span class="params">(u32 entries, <span class="keyword">struct</span> io_uring_params __user *params)</span></span><br><span class="line">{</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">io_uring_params</span> <span class="title">p</span>;</span></span><br><span class="line">	<span class="type">long</span> ret;</span><br><span class="line">	<span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ç”¨æˆ·æ€æ‹·è´åˆ°å†…æ ¸æ€</span></span><br><span class="line">	<span class="keyword">if</span> (copy_from_user(&amp;p, params, <span class="keyword">sizeof</span>(p)))</span><br><span class="line">		<span class="keyword">return</span> -EFAULT;</span><br><span class="line">	<span class="comment">// ç¡®è®¤ä¿ç•™åŒºåŸŸæ²¡æœ‰è¢«èµ‹å€¼</span></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ARRAY_SIZE(p.resv); i++) {</span><br><span class="line">		<span class="keyword">if</span> (p.resv[i])</span><br><span class="line">			<span class="keyword">return</span> -EINVAL;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="comment">// æ£€æŸ¥ flags å‚æ•°</span></span><br><span class="line">	<span class="keyword">if</span> (p.flags &amp; ~(IORING_SETUP_IOPOLL | IORING_SETUP_SQPOLL |</span><br><span class="line">			IORING_SETUP_SQ_AFF))</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// åˆ†é…å†…å­˜ç©ºé—´ï¼Œåˆ›å»º workqueueï¼Œåˆ›å»º fd ç­‰</span></span><br><span class="line">	ret = io_uring_create(entries, &amp;p);</span><br><span class="line">	<span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// å†…æ ¸æ€æ‹·è´å›ç”¨æˆ·æ€</span></span><br><span class="line">	<span class="keyword">if</span> (copy_to_user(params, &amp;p, <span class="keyword">sizeof</span>(p)))</span><br><span class="line">		<span class="keyword">return</span> -EFAULT;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">SYSCALL_DEFINE2(io_uring_setup, u32, entries,</span><br><span class="line">		<span class="keyword">struct</span> io_uring_params __user *, params)</span><br><span class="line">{</span><br><span class="line">	<span class="keyword">return</span> io_uring_setup(entries, params);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>å¯ä»¥çœ‹åˆ° <code>io_uring_setup</code> çš„æ ¸å¿ƒå‡½æ•°æ˜¯
<code>io_uring_create</code></p>
<h3 id="io_uring_create">2.2. <code>io_uring_create</code></h3>
<figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">io_uring_create</span><span class="params">(<span class="type">unsigned</span> entries, <span class="keyword">struct</span> io_uring_params *p)</span></span><br><span class="line">{</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">user_struct</span> *<span class="title">user</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">io_ring_ctx</span> *<span class="title">ctx</span>;</span></span><br><span class="line">	<span class="type">bool</span> account_mem;</span><br><span class="line">	<span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!entries || entries &gt; IORING_MAX_ENTRIES)</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Use twice as many entries for the CQ ring. It's possible for the</span></span><br><span class="line"><span class="comment">	 * application to drive a higher depth than the size of the SQ ring,</span></span><br><span class="line"><span class="comment">	 * since the sqes are only used at submission time. This allows for</span></span><br><span class="line"><span class="comment">	 * some flexibility in overcommitting a bit.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	p-&gt;sq_entries = roundup_pow_of_two(entries);</span><br><span class="line">	p-&gt;cq_entries = <span class="number">2</span> * p-&gt;sq_entries;</span><br><span class="line"></span><br><span class="line">	user = get_uid(current_user());</span><br><span class="line">	<span class="comment">// å…è®¸å¯¹å…±äº«å†…å­˜æ®µè¿›è¡Œé”å®š</span></span><br><span class="line">	account_mem = !capable(CAP_IPC_LOCK);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (account_mem) {</span><br><span class="line">		<span class="comment">// ä¸èƒ½å¯¹å…±äº«å†…å­˜æ®µè¿›è¡Œé”å®šï¼Œå°±éœ€è¦å¢åŠ å½“å‰å¯ä»¥é”å®šçš„å†…å­˜</span></span><br><span class="line">		ret = io_account_mem(user,</span><br><span class="line">				ring_pages(p-&gt;sq_entries, p-&gt;cq_entries));</span><br><span class="line">		<span class="keyword">if</span> (ret) {</span><br><span class="line">			free_uid(user);</span><br><span class="line">			<span class="keyword">return</span> ret;</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	ctx = io_ring_ctx_alloc(p);</span><br><span class="line">	<span class="keyword">if</span> (!ctx) {</span><br><span class="line">		<span class="keyword">if</span> (account_mem)</span><br><span class="line">			io_unaccount_mem(user, ring_pages(p-&gt;sq_entries,</span><br><span class="line">								p-&gt;cq_entries));</span><br><span class="line">		free_uid(user);</span><br><span class="line">		<span class="keyword">return</span> -ENOMEM;</span><br><span class="line">	}</span><br><span class="line">	ctx-&gt;compat = in_compat_syscall();</span><br><span class="line">	ctx-&gt;account_mem = account_mem;</span><br><span class="line">	ctx-&gt;user = user;</span><br><span class="line"></span><br><span class="line">	ctx-&gt;creds = get_current_cred();</span><br><span class="line">	<span class="keyword">if</span> (!ctx-&gt;creds) {</span><br><span class="line">		ret = -ENOMEM;</span><br><span class="line">		<span class="keyword">goto</span> err;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ç”³è¯· io_rings SQEs</span></span><br><span class="line">	ret = io_allocate_scq_urings(ctx, p);</span><br><span class="line">	<span class="keyword">if</span> (ret)</span><br><span class="line">		<span class="keyword">goto</span> err;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// åˆå§‹åŒ– workqueueï¼Œ[åˆå§‹åŒ–å†…æ ¸çº¿ç¨‹ç”¨äºè¿›è¡Œ IO poll]</span></span><br><span class="line">	ret = io_sq_offload_start(ctx, p);</span><br><span class="line">	<span class="keyword">if</span> (ret)</span><br><span class="line">		<span class="keyword">goto</span> err;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">memset</span>(&amp;p-&gt;sq_off, <span class="number">0</span>, <span class="keyword">sizeof</span>(p-&gt;sq_off));</span><br><span class="line">	p-&gt;sq_off.head = offsetof(<span class="keyword">struct</span> io_rings, sq.head);</span><br><span class="line">	p-&gt;sq_off.tail = offsetof(<span class="keyword">struct</span> io_rings, sq.tail);</span><br><span class="line">	p-&gt;sq_off.ring_mask = offsetof(<span class="keyword">struct</span> io_rings, sq_ring_mask);</span><br><span class="line">	p-&gt;sq_off.ring_entries = offsetof(<span class="keyword">struct</span> io_rings, sq_ring_entries);</span><br><span class="line">	p-&gt;sq_off.flags = offsetof(<span class="keyword">struct</span> io_rings, sq_flags);</span><br><span class="line">	p-&gt;sq_off.dropped = offsetof(<span class="keyword">struct</span> io_rings, sq_dropped);</span><br><span class="line">	p-&gt;sq_off.<span class="built_in">array</span> = (<span class="type">char</span> *)ctx-&gt;sq_array - (<span class="type">char</span> *)ctx-&gt;rings;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">memset</span>(&amp;p-&gt;cq_off, <span class="number">0</span>, <span class="keyword">sizeof</span>(p-&gt;cq_off));</span><br><span class="line">	p-&gt;cq_off.head = offsetof(<span class="keyword">struct</span> io_rings, cq.head);</span><br><span class="line">	p-&gt;cq_off.tail = offsetof(<span class="keyword">struct</span> io_rings, cq.tail);</span><br><span class="line">	p-&gt;cq_off.ring_mask = offsetof(<span class="keyword">struct</span> io_rings, cq_ring_mask);</span><br><span class="line">	p-&gt;cq_off.ring_entries = offsetof(<span class="keyword">struct</span> io_rings, cq_ring_entries);</span><br><span class="line">	p-&gt;cq_off.overflow = offsetof(<span class="keyword">struct</span> io_rings, cq_overflow);</span><br><span class="line">	p-&gt;cq_off.cqes = offsetof(<span class="keyword">struct</span> io_rings, cqes);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Install ring fd as the very last thing, so we don't risk someone</span></span><br><span class="line"><span class="comment">	 * having closed it before we finish setup</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="comment">// åˆ›å»º fd ä¾¿äºç”¨æˆ·æ€è®¿é—® ctx</span></span><br><span class="line">	ret = io_uring_get_fd(ctx);</span><br><span class="line">	<span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">goto</span> err;</span><br><span class="line"></span><br><span class="line">	p-&gt;features = IORING_FEAT_SINGLE_MMAP;</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">err:</span><br><span class="line">	io_ring_ctx_wait_and_kill(ctx);</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<pre class="mermaid">graph TD
io_uring_setup --&gt; io_ring_ctx_alloc
io_uring_setup --&gt; io_allocate_scq_urings
io_uring_setup --&gt; io_sq_offload_start
io_uring_setup --&gt; io_uring_get_fd</pre>
<ol type="1">
<li><p><code>io_ring_ctx_alloc</code>
ä¸»è¦ç”¨æ¥ç”³è¯·ç©ºé—´ï¼Œåˆå§‹åŒ–åˆ—è¡¨å¤´ã€äº’æ–¥é”ã€è‡ªæ—‹é”ç­‰ç»“æ„</p></li>
<li><p><code>io_allocate_scq_urings</code> æ¥åˆå§‹åŒ–æ•´ä¸ª
<code>struct io_rings *rings</code>ï¼ŒåŒ…æ‹¬
<code>SQ</code>ã€<code>CQ</code> å¤´å°¾æŒ‡é’ˆçš„åˆå§‹åŒ–ï¼Œä»¥åŠ
<code>SQE</code>ã€<code>CQE</code> çš„åˆå§‹åŒ–</p>
<ul>
<li>ä¸åŒçš„æ˜¯ <code>SQ</code>ã€<code>CQ</code> å¤´å°¾æŒ‡é’ˆä»¥åŠ
<code>CQE</code> éƒ½åœ¨ <code>struct io_rings *rings</code> ç»“æ„ä½“ä¸­</li>
<li>è€Œ <code>SQE</code> åˆ™æ˜¯åœ¨ <code>struct io_ring_ctx *ctx</code>
ç»“æ„ä½“ä¸­</li>
</ul></li>
<li><p><code>io_sq_offload_start</code> ä¼šæ ¹æ®ç”¨æˆ·é€šè¿‡
<code>io_uring_setup</code> ä¼ é€’çš„ <code>flags</code> æ¥é…ç½®
<code>io_uring</code> çš„è¿è¡Œæ–¹å¼ï¼Œåç»­è¯¦ç»†å±•å¼€</p></li>
<li><p><code>io_uring_get_fd</code> å°†
<code>struct io_ring_ctx *ctx</code> æš´éœ²ç»™ç”¨æˆ·æ€è®¿é—®</p></li>
</ol>
<h3 id="io_sq_offload_start">2.3. <code>io_sq_offload_start</code></h3>
<figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">io_sq_offload_start</span><span class="params">(<span class="keyword">struct</span> io_ring_ctx *ctx,</span></span><br><span class="line"><span class="params">			       <span class="keyword">struct</span> io_uring_params *p)</span></span><br><span class="line">{</span><br><span class="line">	<span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">	mmgrab(current-&gt;mm);</span><br><span class="line">	ctx-&gt;sqo_mm = current-&gt;mm;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (ctx-&gt;flags &amp; IORING_SETUP_SQPOLL) {</span><br><span class="line">		<span class="comment">// IORING_SETUP_SQPOLL å°†ä¼šåˆ›å»ºä¸€ä¸ªå†…æ ¸çº¿ç¨‹æ¥ poll SQ</span></span><br><span class="line">		ret = -EPERM;</span><br><span class="line">		<span class="keyword">if</span> (!capable(CAP_SYS_ADMIN))</span><br><span class="line">			<span class="keyword">goto</span> err;</span><br><span class="line"></span><br><span class="line">		ctx-&gt;sq_thread_idle = msecs_to_jiffies(p-&gt;sq_thread_idle);</span><br><span class="line">		<span class="keyword">if</span> (!ctx-&gt;sq_thread_idle)</span><br><span class="line">			ctx-&gt;sq_thread_idle = HZ;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (p-&gt;flags &amp; IORING_SETUP_SQ_AFF) {</span><br><span class="line">			<span class="type">int</span> cpu = p-&gt;sq_thread_cpu;</span><br><span class="line"></span><br><span class="line">			ret = -EINVAL;</span><br><span class="line">			<span class="keyword">if</span> (cpu &gt;= nr_cpu_ids)</span><br><span class="line">				<span class="keyword">goto</span> err;</span><br><span class="line">			<span class="keyword">if</span> (!cpu_online(cpu))</span><br><span class="line">				<span class="keyword">goto</span> err;</span><br><span class="line"></span><br><span class="line">			ctx-&gt;sqo_thread = kthread_create_on_cpu(io_sq_thread,</span><br><span class="line">							ctx, cpu,</span><br><span class="line">							<span class="string">"io_uring-sq"</span>);</span><br><span class="line">		} <span class="keyword">else</span> {</span><br><span class="line">			ctx-&gt;sqo_thread = kthread_create(io_sq_thread, ctx,</span><br><span class="line">							<span class="string">"io_uring-sq"</span>);</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">if</span> (IS_ERR(ctx-&gt;sqo_thread)) {</span><br><span class="line">			ret = PTR_ERR(ctx-&gt;sqo_thread);</span><br><span class="line">			ctx-&gt;sqo_thread = <span class="literal">NULL</span>;</span><br><span class="line">			<span class="keyword">goto</span> err;</span><br><span class="line">		}</span><br><span class="line">		wake_up_process(ctx-&gt;sqo_thread);</span><br><span class="line">	} <span class="keyword">else</span> <span class="keyword">if</span> (p-&gt;flags &amp; IORING_SETUP_SQ_AFF) {</span><br><span class="line">		<span class="comment">/* Can't have SQ_AFF without SQPOLL */</span></span><br><span class="line">		ret = -EINVAL;</span><br><span class="line">		<span class="keyword">goto</span> err;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Do QD, or 2 * CPUS, whatever is smallest */</span></span><br><span class="line">	ctx-&gt;sqo_wq[<span class="number">0</span>] = alloc_workqueue(<span class="string">"io_ring-wq"</span>,</span><br><span class="line">			WQ_UNBOUND | WQ_FREEZABLE,</span><br><span class="line">			min(ctx-&gt;sq_entries - <span class="number">1</span>, <span class="number">2</span> * num_online_cpus()));</span><br><span class="line">	<span class="keyword">if</span> (!ctx-&gt;sqo_wq[<span class="number">0</span>]) {</span><br><span class="line">		ret = -ENOMEM;</span><br><span class="line">		<span class="keyword">goto</span> err;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * This is for buffered writes, where we want to limit the parallelism</span></span><br><span class="line"><span class="comment">	 * due to file locking in file systems. As "normal" buffered writes</span></span><br><span class="line"><span class="comment">	 * should parellelize on writeout quite nicely, limit us to having 2</span></span><br><span class="line"><span class="comment">	 * pending. This avoids massive contention on the inode when doing</span></span><br><span class="line"><span class="comment">	 * buffered async writes.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="comment">// å¯¹ buffer å†™çš„ workqueue æ·±åº¦è¿›è¡Œé™åˆ¶ï¼Œå‡å°‘é”äº‰ç”¨å¼€é”€?</span></span><br><span class="line">	ctx-&gt;sqo_wq[<span class="number">1</span>] = alloc_workqueue(<span class="string">"io_ring-write-wq"</span>,</span><br><span class="line">						WQ_UNBOUND | WQ_FREEZABLE, <span class="number">2</span>);</span><br><span class="line">	<span class="keyword">if</span> (!ctx-&gt;sqo_wq[<span class="number">1</span>]) {</span><br><span class="line">		ret = -ENOMEM;</span><br><span class="line">		<span class="keyword">goto</span> err;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">err:</span><br><span class="line">	io_finish_async(ctx);</span><br><span class="line">	mmdrop(ctx-&gt;sqo_mm);</span><br><span class="line">	ctx-&gt;sqo_mm = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>å½“ <code>flags</code> ä¸­é…ç½®äº† <code>IORING_SETUP_SQPOLL</code>
æ—¶ï¼Œå°†å¯åŠ¨ä¸€ä¸ªå•ç‹¬çš„å†…æ ¸çº¿ç¨‹ <code>io_sq_thread</code>ï¼Œè€Œå½“
<code>IORING_SETUP_SQ_AFF</code> å­—æ®µä¹Ÿé…ç½®æ—¶ï¼Œå°†æ ¹æ®
<code>sq_thread_cpu</code> å­—æ®µï¼Œåœ¨æŒ‡å®šçš„ CPU ä¸Šå¯ç”¨å†…æ ¸çº¿ç¨‹
<code>io_sq_thread</code></p>
<p>åŒæ—¶è¯¥å‡½æ•°è¿˜ä¼šåˆ›å»ºä¸¤ä¸ªå·¥ä½œé˜Ÿåˆ— <code>ctx-&gt;sqo_wq[2]</code>
åˆ†åˆ«åä¸º <code>io_ring-wq</code> å’Œ <code>io_ring-write-wq</code></p>
<ul>
<li><code>io_ring-wq</code> ä¸»è¦å¤„ç†è¯» IOï¼Œä»¥åŠ direct å†™ IO</li>
<li><code>io_ring-write-wq</code> ä¸»è¦æ˜¯å¤„ç† buffer å†™ IO</li>
</ul>
<h2 id="ç³»ç»Ÿè°ƒç”¨-io_uring_enter">3. ç³»ç»Ÿè°ƒç”¨
<code>io_uring_enter</code></h2>
<figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line">SYSCALL_DEFINE6(io_uring_enter, <span class="type">unsigned</span> <span class="type">int</span>, fd, u32, to_submit,</span><br><span class="line">		u32, min_complete, u32, flags, <span class="type">const</span> <span class="type">sigset_t</span> __user *, sig,</span><br><span class="line">		<span class="type">size_t</span>, sigsz)</span><br><span class="line">{</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">io_ring_ctx</span> *<span class="title">ctx</span>;</span></span><br><span class="line">	<span class="type">long</span> ret = -EBADF;</span><br><span class="line">	<span class="type">int</span> submitted = <span class="number">0</span>;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fd</span> <span class="title">f</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (flags &amp; ~(IORING_ENTER_GETEVENTS | IORING_ENTER_SQ_WAKEUP))</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">	f = fdget(fd);</span><br><span class="line">	<span class="keyword">if</span> (!f.file)</span><br><span class="line">		<span class="keyword">return</span> -EBADF;</span><br><span class="line"></span><br><span class="line">	ret = -EOPNOTSUPP;</span><br><span class="line">	<span class="keyword">if</span> (f.file-&gt;f_op != &amp;io_uring_fops)</span><br><span class="line">		<span class="keyword">goto</span> out_fput;</span><br><span class="line"></span><br><span class="line">	ret = -ENXIO;</span><br><span class="line">	ctx = f.file-&gt;private_data;</span><br><span class="line">	<span class="keyword">if</span> (!percpu_ref_tryget(&amp;ctx-&gt;refs))</span><br><span class="line">		<span class="keyword">goto</span> out_fput;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * For SQ polling, the thread will do all submissions and completions.</span></span><br><span class="line"><span class="comment">	 * Just return the requested submit count, and wake the thread if</span></span><br><span class="line"><span class="comment">	 * we were asked to.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	ret = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span> (ctx-&gt;flags &amp; IORING_SETUP_SQPOLL) {</span><br><span class="line">		<span class="keyword">if</span> (flags &amp; IORING_ENTER_SQ_WAKEUP)</span><br><span class="line">			wake_up(&amp;ctx-&gt;sqo_wait);</span><br><span class="line">		submitted = to_submit;</span><br><span class="line">	} <span class="keyword">else</span> <span class="keyword">if</span> (to_submit) {</span><br><span class="line">		to_submit = min(to_submit, ctx-&gt;sq_entries);</span><br><span class="line"></span><br><span class="line">		mutex_lock(&amp;ctx-&gt;uring_lock);</span><br><span class="line">		submitted = io_ring_submit(ctx, to_submit);</span><br><span class="line">		mutex_unlock(&amp;ctx-&gt;uring_lock);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (submitted != to_submit)</span><br><span class="line">			<span class="keyword">goto</span> out;</span><br><span class="line">	}</span><br><span class="line">	<span class="keyword">if</span> (flags &amp; IORING_ENTER_GETEVENTS) {</span><br><span class="line">		<span class="type">unsigned</span> nr_events = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">		min_complete = min(min_complete, ctx-&gt;cq_entries);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (ctx-&gt;flags &amp; IORING_SETUP_IOPOLL) {</span><br><span class="line">			ret = io_iopoll_check(ctx, &amp;nr_events, min_complete);</span><br><span class="line">		} <span class="keyword">else</span> {</span><br><span class="line">			ret = io_cqring_wait(ctx, min_complete, sig, sigsz);</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">out:</span><br><span class="line">	percpu_ref_put(&amp;ctx-&gt;refs);</span><br><span class="line">out_fput:</span><br><span class="line">	fdput(f);</span><br><span class="line">	<span class="keyword">return</span> submitted ? submitted : ret;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>TODO</p>
<h2 id="ç³»ç»Ÿè°ƒç”¨-io_uring_register">4. ç³»ç»Ÿè°ƒç”¨
<code>io_uring_register</code></h2>
<figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line">SYSCALL_DEFINE4(io_uring_register, <span class="type">unsigned</span> <span class="type">int</span>, fd, <span class="type">unsigned</span> <span class="type">int</span>, opcode,</span><br><span class="line">		<span class="type">void</span> __user *, arg, <span class="type">unsigned</span> <span class="type">int</span>, nr_args)</span><br><span class="line">{</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">io_ring_ctx</span> *<span class="title">ctx</span>;</span></span><br><span class="line">	<span class="type">long</span> ret = -EBADF;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fd</span> <span class="title">f</span>;</span></span><br><span class="line"></span><br><span class="line">	f = fdget(fd);</span><br><span class="line">	<span class="keyword">if</span> (!f.file)</span><br><span class="line">		<span class="keyword">return</span> -EBADF;</span><br><span class="line"></span><br><span class="line">	ret = -EOPNOTSUPP;</span><br><span class="line">	<span class="keyword">if</span> (f.file-&gt;f_op != &amp;io_uring_fops)</span><br><span class="line">		<span class="keyword">goto</span> out_fput;</span><br><span class="line"></span><br><span class="line">	ctx = f.file-&gt;private_data;</span><br><span class="line"></span><br><span class="line">	mutex_lock(&amp;ctx-&gt;uring_lock);</span><br><span class="line">	ret = __io_uring_register(ctx, opcode, arg, nr_args);</span><br><span class="line">	mutex_unlock(&amp;ctx-&gt;uring_lock);</span><br><span class="line">out_fput:</span><br><span class="line">	fdput(f);</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>TODO</p>
<h2 id="å†…æ ¸çº¿ç¨‹-io_sq_thread">5. å†…æ ¸çº¿ç¨‹
<code>io_sq_thread</code></h2>
<p>TODO</p>
<h2 id="iopoll-æ¨¡å¼">6. <code>IOPOLL</code> æ¨¡å¼</h2>
<h3 id="å¯ç”¨">6.1. å¯ç”¨</h3>
<p>å½“ <code>io_uring_setup</code> åˆå§‹åŒ–æ—¶ <code>flags</code> é…ç½®äº†
<code>IORING_SETUP_IOPOLL</code> å­—æ®µåå°†å¼€å¯ <code>IOPOLL</code>
æ¨¡å¼</p>
<h3 id="é™åˆ¶">6.2. é™åˆ¶</h3>
<p>å¼€å¯æ­¤é€‰é¡¹å¿…é¡»ä¿è¯åç»­åªç”¨ <code>O_DIRECT</code>
æ‰“å¼€æ–‡ä»¶å¹¶ä¸”æ–‡ä»¶ç³»ç»Ÿçš„ <code>file_operations</code> ä¸­æ³¨å†Œäº†
<code>iopoll</code> å‡½æ•°ï¼Œå¦åˆ™ IO å°†ä¸‹å‘å¤±è´¥</p>
<h3 id="è°ƒç”¨æ ˆ">6.3. è°ƒç”¨æ ˆ</h3>
<p>å¼€å¯åå†…æ ¸å°†è°ƒç”¨æ³¨å†Œçš„ <code>iopoll</code> å‡½æ•°æ¥ä¸»åŠ¨è½®è¯¢è®¾å¤‡é©±åŠ¨ç¡®è®¤
IO æ˜¯å¦å®Œæˆ</p>
<p>å¯¹ <code>f_op-&gt;iopoll</code> å‡½æ•°è°ƒç”¨å…³ç³»è¿›è¡Œäº†åˆ†æ</p>
<pre class="mermaid">graph TD
io_uring_create --&gt; io_ring_ctx_wait_and_kill
io_uring_release --&gt; io_ring_ctx_wait_and_kill
io_ring_ctx_wait_and_kill --&gt; io_iopoll_reap_events
io_ring_ctx_wait_and_kill --&gt; io_ring_ctx_free
io_ring_ctx_free --&gt; io_iopoll_reap_events
io_iopoll_reap_events --&gt; io_iopoll_getevents

syscall["SYSCALL_DEFINE6(io_uring_enter, â€¦â€¦)"] --&gt; io_iopoll_check --&gt; io_iopoll_getevents

io_sq_thread --&gt; io_iopoll_getevents

io_iopoll_getevents --&gt; io_do_iopoll --&gt; iopoll["f_op-&gt;iopoll"]</pre>
<p>ä¸»è¦æœ‰ä¸‰æ¡è°ƒç”¨è·¯çº¿ï¼ˆæ‰€æœ‰è°ƒç”¨é€»è¾‘éƒ½ä¼šåˆ¤æ–­æ˜¯å¦åœ¨åˆå§‹åŒ–æ—¶é…ç½®äº†
<code>IORING_SETUP_IOPOLL</code>ï¼‰ï¼š</p>
<ol type="1">
<li><code>io_uring</code> é”€æ¯æ—¶éœ€è¦è°ƒç”¨</li>
<li>ç³»ç»Ÿè°ƒç”¨ <code>io_uring_enter</code> å°†ä¼šè§¦å‘ï¼Œç”¨äºè½®è¯¢ IO
å®Œæˆæƒ…å†µï¼Œç›´åˆ°åˆ°è¾¾æŒ‡å®šçš„ <code>wait_nr</code> æ•°é‡ IO
å®Œæˆåæ‰ä¼šé€€å‡ºè½®è¯¢</li>
<li>å½“åˆå§‹åŒ–æ—¶åŒæ—¶é…ç½®äº† <code>IORING_SETUP_SQPOLL</code>
æ—¶ï¼Œ<code>io_sq_thread</code> å†…æ ¸çº¿ç¨‹è§¦å‘ï¼Œå½“å­˜åœ¨æœªå®Œæˆçš„ IO
æ—¶è°ƒç”¨ï¼Œç”¨äºæ›´æ–° IO å®Œæˆæƒ…å†µï¼ˆ <code>io_do_iopoll</code> çš„å‚æ•°
<code>min = 0</code>ï¼Œå³æ¯æ¬¡è°ƒç”¨æ— è®ºæ˜¯å¦æœ‰æ–°å®Œæˆçš„ IO
éƒ½ä¼šé€€å‡ºè½®è¯¢ï¼Œä¸ä¼šé˜»å¡çº¿ç¨‹ï¼‰</li>
</ol>
]]></content>
      <categories>
        <category>å­˜å‚¨</category>
        <category>IO</category>
      </categories>
      <tags>
        <tag>todo</tag>
        <tag>å¼‚æ­¥ IO</tag>
        <tag>kernel</tag>
        <tag>liburing</tag>
        <tag>io_uring</tag>
      </tags>
  </entry>
  <entry>
    <title>io_uring ç”¨æˆ·åº“æºç åˆ†æ</title>
    <url>/posts/d7259d1d.html</url>
    <content><![CDATA[<p>å½“å‰å†…å®¹åŸºäº <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2F4Ym9lL2xpYnVyaW5nL3JlbGVhc2VzL3RhZy9saWJ1cmluZy0yLjE=">liburing
2.1<i class="fa fa-external-link-alt"></i></span> ç‰ˆæœ¬</p>
<h2 id="æ•´ä½“æµç¨‹">æ•´ä½“æµç¨‹</h2>
<p>ä¹‹å‰åœ¨ <a href="/posts/c142853f.html#ä»£ç æµç¨‹">io_uring
ç®€ä»‹å’Œä½¿ç”¨</a> æœ‰è¿‡æ€»ç»“ï¼Œä½¿ç”¨ io_uring çš„ä¸€èˆ¬æµç¨‹å¦‚ä¸‹ï¼š
<span id="more"></span></p>
<ul>
<li>ä½¿ç”¨ <code>open</code>ã€<code>fstat</code>
ç­‰å‡½æ•°æ¥æ‰“å¼€æ–‡ä»¶ä»¥åŠå…ƒæ•°æ®æŸ¥çœ‹ç­‰æ“ä½œ
<ul>
<li>å› ä¸º io_uring æ›¿æ¢çš„æ˜¯è¯»å†™æ¥å£ï¼Œåç»­ io_uring æ“ä½œçš„å¯¹è±¡æ˜¯
<code>fd</code>ï¼ˆç”± <code>open</code> å‡½æ•°æ‰§è¡Œè¿”å›çš„ï¼‰</li>
</ul></li>
<li>ä½¿ç”¨ <code>io_uring_queue_init</code> åˆå§‹åŒ–
<code>struct io_uring ring</code> ç»“æ„ä½“</li>
<li>åˆå§‹åŒ– <code>struct iovec *iovecs</code> ç»“æ„ä½“ç”¨äºå­˜æ”¾ç”¨æˆ·æ€ buffer
æŒ‡é’ˆå’Œé•¿åº¦</li>
<li>é€šè¿‡ <code>io_uring_get_sqe</code> è·å– <code>sqe</code></li>
<li>é€šè¿‡ <code>io_uring_prep_#OP</code> å¯¹ <code>sqe</code>
å¡«å……å‘½ä»¤ï¼Œbuffer ä»¥åŠ offset ä¿¡æ¯
<ul>
<li>ã€å¯é€‰ã€‘ é€šè¿‡ <code>io_uring_sqe_set_data</code> å¯¹ <code>sqe</code>
é™„åŠ  <code>user_data</code> ä¿¡æ¯ï¼ˆè¯¥ä¿¡æ¯ä¼šåœ¨ <code>cqe</code>
ä¸­è¿›è¡Œè¿”å›ï¼‰</li>
</ul></li>
<li>é€šè¿‡ <code>io_uring_submit</code> å¯¹æ•´ä¸ª <code>ring</code> çš„æ‰€æœ‰
<code>sqe</code> è¿›è¡Œä¸‹å‘</li>
<li>é€šè¿‡ <code>io_uring_wait_cqe</code> æˆ–è€…
<code>io_uring_peek_cqe</code> æ¥è·å– <code>cqe</code>
<ul>
<li><code>io_uring_wait_cqe</code> ä¼šé˜»å¡å½“å‰çº¿ç¨‹ç›´åˆ°æœ‰ä¸€ä¸ª
<code>cqe</code> è¿”å›</li>
<li><code>io_uring_peek_cqe</code> ä¸ä¼šé˜»å¡ï¼Œå¦‚æœå½“å‰æ²¡æœ‰
<code>cqe</code>ï¼Œå°±ä¼šè¿”å›é”™è¯¯</li>
<li><code>io_uring_cqe_get_data</code> å¯ä»¥ä» <code>cqe</code> ä¸­è·å–
<code>user_data</code></li>
</ul></li>
<li>é€šè¿‡ <code>io_uring_cqe_seen</code> å¯¹å½“å‰ <code>cqe</code>
è¿›è¡Œæ¸…é™¤ï¼Œé¿å…è¢«äºŒæ¬¡å¤„ç†</li>
<li>æ‰€æœ‰ IO å®Œæˆåï¼Œé€šè¿‡ <code>io_uring_queue_exit</code> å°†
<code>ring</code> é”€æ¯</li>
</ul>
<h2 id="io_uring_queue_init"><code>io_uring_queue_init</code></h2>
<ul>
<li><p>å‡½æ•°è°ƒç”¨é€»è¾‘</p>
<pre class="mermaid">  graph TD
io_uring_queue_init --&gt; io_uring_queue_init_params --&gt; __sys_io_uring_setup --&gt; syscall --&gt;|é™·å…¥å†…æ ¸|io_uring_setup
io_uring_queue_init_params --&gt; io_uring_queue_mmap --&gt; io_uring_mmap --&gt; mmap</pre></li>
<li><p>å‡½æ•°åŠŸèƒ½</p>
<p>è¯¥å‡½æ•°ä¸»è¦å°†é˜Ÿåˆ—æ·±åº¦ä»¥åŠé¢å¤–çš„ <code>flags</code>
å‚æ•°ä¼ é€’åˆ°å†…æ ¸ï¼Œè®©å†…æ ¸çš„ <code>io_uring_setup</code> æ¥åˆå§‹åŒ–
<code>io_uring</code> ç»“æ„ä½“ï¼ŒåŒæ—¶ä½¿ç”¨ <code>mmap</code>
å°†åœ¨å†…æ ¸ä¸­åˆå§‹åŒ–çš„ <code>SQ</code>ã€<code>CQ</code> ä»¥åŠ
<code>SQEs</code> æ˜ å°„åˆ°ç”¨æˆ·æ€</p>
<p>åˆå§‹åŒ–æ—¶ä¼ é€’çš„ <code>flags</code> å°†å½±å“ <code>io_uring</code>
çš„è¿è¡Œæ–¹å¼ï¼š</p>
<ul>
<li><code>IORING_SETUP_IOPOLL</code>ï¼šå¼€å¯æ­¤é€‰é¡¹å¿…é¡»ä¿è¯åç»­åªç”¨
<code>O_DIRECT</code> æ‰“å¼€æ–‡ä»¶å¹¶ä¸”æ–‡ä»¶ç³»ç»Ÿçš„
<code>file_operations</code> ä¸­æ³¨å†Œäº† <code>iopoll</code> å‡½æ•°ï¼Œå¦åˆ™ IO
å°†ä¸‹å‘å¤±è´¥ã€‚å¼€å¯åå†…æ ¸å°†è°ƒç”¨æ³¨å†Œçš„ <code>iopoll</code>
å‡½æ•°æ¥ä¸»åŠ¨è½®è¯¢è®¾å¤‡é©±åŠ¨ç¡®è®¤ IO
æ˜¯å¦å®Œæˆ<!-- ï¼Œ`iopoll` çš„è§¦å‘æ—¶æœºå¯ä»¥å‚çœ‹ [io_uring å†…æ ¸æºç åˆ†æ](/io_uring/å†…æ ¸æºç åˆ†æ) --></li>
<li><code>IORING_SETUP_SQPOLL</code>ï¼šå°†å¯åŠ¨ä¸€ä¸ªå•ç‹¬çš„å†…æ ¸çº¿ç¨‹
<code>io_sq_thread</code>ï¼Œå†…æ ¸å°†ä¸»åŠ¨è½®è¯¢ SQï¼Œç„¶åå°† IO
ä¸‹å‘è‡³é©±åŠ¨è®¾å¤‡ï¼Œèƒ½å¤§å¤§å‡å°‘æäº¤ IO æ—¶çš„ç³»ç»Ÿè°ƒç”¨å¼€é”€ï¼ˆå†…æ ¸çº¿ç¨‹å·¥ä½œæ—¶ï¼Œæäº¤
IO
å°†æ— éœ€ç³»ç»Ÿè°ƒç”¨ï¼›ä½†æ˜¯è¯¥çº¿ç¨‹å¯èƒ½ä¼šä¼‘çœ ï¼Œä¼‘çœ æ—¶éœ€è¦ç³»ç»Ÿè°ƒç”¨æ¥å”¤é†’è¯¥çº¿ç¨‹ï¼‰</li>
<li><code>IORING_SETUP_SQ_AFF</code>ï¼šå½“
<code>IORING_SETUP_SQPOLL</code> å·²ç»é…ç½®åï¼Œå¯ç”¨
<code>sq_thread_cpu</code> å­—æ®µï¼Œç”¨äºé…ç½®å†…æ ¸çº¿ç¨‹
<code>io_sq_thread</code> çš„è·‘åœ¨å“ªä¸ª CPU ä¸Š</li>
</ul></li>
</ul>
<h2 id="io_uring_get_sqe"><code>io_uring_get_sqe</code></h2>
<p>ç”±äº SQ å·²ç»é€šè¿‡ <code>mmap</code> æ˜ å°„åˆ°ç”¨æˆ·æ€ï¼Œè¯¥å‡½æ•°åªéœ€åœ¨è¯»å–
<code>sq-&gt;khead</code> æ—¶é€šè¿‡ <code>io_uring_smp_load_acquire</code>
ä¿è¯ä¸€è‡´æ€§ï¼Œè€Œ <code>sq-&gt;sqe_tail</code>
åªç”¨äºç”¨æˆ·æ€ï¼Œç›´æ¥è¯»å–å³å¯ï¼Œæ ¹æ® <code>sq-&gt;khead</code> ä»¥åŠ
<code>sq-&gt;sqe_tail</code> åˆ¤æ–­ SQ æ˜¯å¦å·²æ»¡ï¼Œæœªæ»¡åˆ™ç»™å‡º
<code>sq-&gt;sqe_tail</code> å¤„çš„ <code>sqe</code> å³å¯ï¼Œç„¶åæ›´æ–°
<code>sq-&gt;sqe_tail</code></p>
<h2 id="io_uring_prep_op"><code>io_uring_prep_#OP</code></h2>
<p>é€šè¿‡è°ƒç”¨ <code>io_uring_prep_rw</code> å¯¹ <code>sqe</code> å¡«å……å‘½ä»¤
OPã€<code>fd</code>ã€buffer æŒ‡é’ˆä»¥åŠ offset ä¿¡æ¯ç­‰</p>
<h2 id="io_uring_sqe_set_data"><code>io_uring_sqe_set_data</code></h2>
<p>ç›´æ¥å¯¹ <code>sqe-&gt;user_data</code> è¿›è¡Œèµ‹å€¼</p>
<h2 id="io_uring_submit"><code>io_uring_submit</code></h2>
<ul>
<li><p>å‡½æ•°è°ƒç”¨é€»è¾‘</p>
<pre class="mermaid">    graph TD
  io_uring_submit --&gt; __io_uring_submit_and_wait --&gt; __io_uring_flush_sq
  __io_uring_submit_and_wait --&gt; __io_uring_submit --&gt; sq_ring_needs_enter
  __io_uring_submit --&gt; __sys_io_uring_enter --&gt; __sys_io_uring_enter2 --&gt; syscall --&gt;|é™·å…¥å†…æ ¸|io_uring_enter</pre></li>
<li><p>å‡½æ•°åŠŸèƒ½</p>
<ul>
<li><p><code>__io_uring_flush_sq</code></p>
<p>æ ¹æ® <code>sq-&gt;sqe_tail</code>ã€<code>sq-&gt;sqe_head</code>
å·®å€¼ä¾æ¬¡å¡«å…… <code>sq-&gt;array</code>ï¼Œç„¶åä¸€æ¬¡æ€§æ›´æ–°
<code>sq-&gt;ktail</code>ï¼Œå¹¶è¿”å›å†…æ ¸ä¸­ä»æœªå¤„ç† <code>sqe</code>
æ•°é‡ï¼ˆ<code>sq-&gt;ktail - sq-&gt;khead</code>ï¼‰</p></li>
<li><p><code>sq_ring_needs_enter</code></p>
<p>åˆ¤æ–­å†…æ ¸çº¿ç¨‹ <code>io_sq_thread</code>
æ˜¯å¦å¯ç”¨ä»¥åŠæ­£å¸¸å·¥ä½œï¼ˆæ²¡æœ‰ä¼‘çœ ï¼‰:</p>
<ul>
<li>é¦–å…ˆè¦åˆ¤æ–­ç”¨æˆ·æ€ <code>ring-&gt;flags</code> æ˜¯å¦é…ç½®äº†
<code>IORING_SETUP_SQPOLL</code> æ ‡å¿—ä½ï¼Œåˆ¤æ–­æ˜¯å¦å¯ç”¨äº†å†…æ ¸çº¿ç¨‹
<code>io_sq_thread</code></li>
<li>ç„¶åå†åˆ¤æ–­å†…æ ¸æ€ <code>ring-&gt;sq.kflags</code> æ˜¯å¦é…ç½®äº†
<code>IORING_SQ_NEED_WAKEUP</code> æ ‡å¿—ä½ï¼Œåˆ¤æ–­å†…æ ¸çº¿ç¨‹
<code>io_sq_thread</code> æ˜¯å¦éœ€è¦å”¤é†’</li>
</ul>
<p>å½“å†…æ ¸çº¿ç¨‹ <code>io_sq_thread</code> å¯ç”¨å¹¶ä¸”æ­£å¸¸å·¥ä½œæ—¶ï¼Œåˆ™æ•´ä¸ª
<code>io_uring_submit</code> åˆ°æ­¤ç»“æŸï¼Œæ— éœ€åç»­çš„
<code>__sys_io_uring_enter</code> ç³»ç»Ÿè°ƒç”¨ï¼Œå‡å°‘äº† IO
ä¸‹å‘çš„ç³»ç»Ÿè°ƒç”¨çš„å¼€é”€</p></li>
<li><p><code>__sys_io_uring_enter</code></p>
<p>ç³»ç»Ÿè°ƒç”¨é™·å…¥å†…æ ¸æ€ï¼Œå°†å‚æ•°ä¼ é€’ç»™å†…æ ¸çš„ <code>io_uring_setup</code>
å‡½æ•°ï¼Œä¸»è¦ç”¨äºæäº¤ IO å’Œè·å– IO å®Œæˆæƒ…å†µï¼Œå…·ä½“åŠŸèƒ½å’Œåˆå§‹åŒ–æ—¶é…ç½®çš„
<code>ring-&gt;flags</code>
ç›¸å…³<!-- ï¼Œè¯¦ç»†åˆ†æå¯ä»¥å‚çœ‹ [io_uring å†…æ ¸æºç åˆ†æ](/io_uring/å†…æ ¸æºç åˆ†æ) --></p></li>
</ul></li>
</ul>
<h2 id="io_uring_wait_cqe"><code>io_uring_wait_cqe</code></h2>
<p>åœ¨ç”¨æˆ·æ€è½®è¯¢åˆ¤æ–­æ˜¯å¦æœ‰ä¸€ä¸ªæ–°çš„
<code>cqe</code>ï¼Œæ— éœ€ç³»ç»Ÿè°ƒç”¨é™·å…¥å†…æ ¸ï¼Œä½†æ˜¯ä¼šé˜»å¡å½“å‰çº¿ç¨‹ç›´åˆ°æœ‰ä¸€ä¸ªæ–°çš„
<code>cqe</code> æˆ–è€…å‡ºé”™</p>
<h2 id="io_uring_peek_cqe"><code>io_uring_peek_cqe</code></h2>
<p>ä»…åœ¨ç”¨æˆ·æ€åˆ¤æ–­ä¸€æ¬¡æ˜¯å¦æœ‰æ–°çš„
<code>cqe</code>ï¼Œæ— éœ€ç³»ç»Ÿè°ƒç”¨é™·å…¥å†…æ ¸ï¼Œå¦‚æœæ²¡æœ‰æ–°çš„
<code>cqe</code>ï¼Œä¼šè¿”å›å¤±è´¥ä¿¡æ¯ <code>-errno</code></p>
<h2 id="io_uring_cqe_get_data"><code>io_uring_cqe_get_data</code></h2>
<p><code>cqe-&gt;user_data</code> ä¼šåœ¨ IO å®Œæˆåï¼Œä» <code>sqe</code>
å¤åˆ¶åˆ°å¯¹åº”çš„ <code>cqe</code> ä¸­ï¼Œè¯¥å‡½æ•°åªç”¨ç›´æ¥å¯¹
<code>cqe-&gt;user_data</code> è¿›è¡Œè¯»å–</p>
<h2 id="io_uring_cqe_seen"><code>io_uring_cqe_seen</code></h2>
<p>æ›´æ–° <code>cq-&gt;khead</code>ï¼Œé¿å…å½“å‰ <code>cqe</code>
è¢«é‡å¤è·å–</p>
<h2 id="io_uring_queue_exit"><code>io_uring_queue_exit</code></h2>
<p>é¦–å…ˆé€šè¿‡ <code>munmap</code> å°†åˆå§‹åŒ–æ—¶ <code>mmap</code> çš„
<code>SQ</code>ã€<code>CQ</code> ä»¥åŠ <code>SQEs</code>
è§£é™¤æ˜ å°„ï¼Œç„¶åé€šè¿‡ <code>close</code> å…³é—­ <code>io_uring</code> å¯¹åº”çš„
<code>fd</code>ï¼Œ<code>close</code> ä¼šè°ƒç”¨åˆ°è¯¥ <code>fd</code> æ³¨å†Œçš„
<code>io_uring_release</code> æ¥é‡Šæ”¾ <code>io_uring</code></p>
<h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h2>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9sb3JlLmtlcm5lbC5vcmcvbGludXgtYmxvY2svMjAxOTA1MTcyMTQxMzEuNTkyNS0xLWF4Ym9lQGtlcm5lbC5kay8=">ã€Kernelã€‘io_uring
IOSQE_IO_LINK<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly93d3cuc2t5emguZGV2L3Bvc3RzL2FydGljbGVzLzIwMjEtMDYtMTQtZGVlcC1kaXZlLWlvLXVyaW5nLw==">ã€ä¸ªäººåšå®¢ã€‘io_uring
çš„æ¥å£ä¸å®ç°<i class="fa fa-external-link-alt"></i></span></li>
</ul>
]]></content>
      <categories>
        <category>å­˜å‚¨</category>
        <category>IO</category>
      </categories>
      <tags>
        <tag>å¼‚æ­¥ IO</tag>
        <tag>liburing</tag>
        <tag>io_uring</tag>
      </tags>
  </entry>
  <entry>
    <title>io_uring ç®€ä»‹å’Œä½¿ç”¨</title>
    <url>/posts/c142853f.html</url>
    <content><![CDATA[<h2 id="ç®€ä»‹">ç®€ä»‹</h2>
<p>io_uring æ˜¯ Linux åœ¨ 5.1 ç‰ˆæœ¬å¼•å…¥çš„ä¸€å¥—æ–°çš„å¼‚æ­¥ IO å®ç°ã€‚ç›¸æ¯” Linux
åœ¨ 2.6 ç‰ˆæœ¬å¼•å…¥çš„ AIOï¼Œio_uring æ€§èƒ½å¼ºå¾ˆå¤šï¼Œæ¥è¿‘ SPDK<span class="exturl" data-url="aHR0cHM6Ly9sb3JlLmtlcm5lbC5vcmcvbGludXgtYmxvY2svMjAxOTAxMTYxNzUwMDMuMTc4ODAtMS1heGJvZUBrZXJuZWwuZGsv">[1]<i class="fa fa-external-link-alt"></i></span>ï¼ŒåŒæ—¶æ”¯æŒ
buffer IO <span id="more"></span></p>
<p>io_uring çš„ä½œè€… <span class="exturl" data-url="aHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvSmVuc19BeGJvZQ==">Jens Axboe<i class="fa fa-external-link-alt"></i></span> æ˜¯ Linux
å†…æ ¸å—å±‚å’Œå…¶ä»–å—è®¾å¤‡çš„ç»´æŠ¤è€…ï¼ŒåŒæ—¶ä¹Ÿæ˜¯ CFQã€Noopã€Deadline
è°ƒåº¦å™¨ã€blktrace ä»¥åŠ FIO çš„ä½œè€…ï¼Œå¯¹å†…æ ¸å—å±‚éå¸¸ç†Ÿæ‚‰</p>
<h2 id="ä½¿ç”¨">ä½¿ç”¨</h2>
<h3 id="ç³»ç»Ÿè°ƒç”¨">ç³»ç»Ÿè°ƒç”¨</h3>
<p>io_uring åªå¢åŠ äº†ä¸‰ä¸ª Linux ç³»ç»Ÿè°ƒç”¨åˆ†åˆ«æ˜¯
<code>io_uring_setup</code>ï¼Œ<code>io_uring_enter</code> å’Œ
<code>io_uring_register</code></p>
<p>ä»–ä»¬çš„å…¥å£éƒ½åœ¨ Linux å†…æ ¸æºç çš„ <code>fs/io_uring.c</code> æ–‡ä»¶ä¸­</p>
<p>ç”¨æˆ·ç¨‹åºå¯ä»¥ç›´æ¥ä½¿ç”¨ <code>syscall(__NR_xxx, â€¦â€¦)</code>
çš„æ–¹å¼ç›´æ¥è°ƒç”¨ï¼Œä½¿ç”¨èµ·æ¥å¾ˆéº»çƒ¦</p>
<h3 id="liburing">liburing</h3>
<p>ç”±äºç›´æ¥ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨è¾ƒä¸ºå¤æ‚ï¼ŒJens Axboe è¿˜æä¾›äº†å°è£…å¥½çš„ç”¨æˆ·æ€åº“
liburingï¼Œç®€åŒ–äº† io_uring çš„ä½¿ç”¨ï¼Œä»£ç ä½ç½®åœ¨ <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2F4Ym9lL2xpYnVyaW5n">github<i class="fa fa-external-link-alt"></i></span> ä¸Š</p>
<h4 id="æ ·ä¾‹">æ ·ä¾‹</h4>
<p>liburing ä»“åº“çš„ <code>examples/</code>
ç›®å½•ä¸‹æä¾›äº†å‡ ä¸ªç®€å•çš„æ ·ä¾‹ç¨‹åºï¼š</p>
<table>
<colgroup>
<col style="width: 9%">
<col style="width: 17%">
<col style="width: 73%">
</colgroup>
<thead>
<tr class="header">
<th>æ–‡ä»¶</th>
<th>åŠŸèƒ½</th>
<th>å…¶ä»–</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>io_uring-test.c</code></td>
<td>è¯»å–ä¸€ä¸ªæ–‡ä»¶çš„å…¨éƒ¨å†…å®¹</td>
<td> -</td>
</tr>
<tr class="even">
<td><code>io_uring-cp.c</code></td>
<td>å¤åˆ¶ä¸€ä¸ªæ–‡ä»¶çš„å†…å®¹åˆ°å¦ä¸€ä¸ªæ–‡ä»¶</td>
<td>ä½¿ç”¨ <code>user_data</code> æ‰‹åŠ¨å¤„ç†è¯»å†™ IO ä¹‹é—´çš„ä¾èµ–ï¼Œè¯» IO
è¿”å›ä¹‹åæ‰ä¸‹å‘å†™ IO</td>
</tr>
<tr class="odd">
<td><code>link-cp.c</code></td>
<td>å¤åˆ¶ä¸€ä¸ªæ–‡ä»¶çš„å†…å®¹åˆ°å¦ä¸€ä¸ªæ–‡ä»¶</td>
<td>åŒæ—¶ä¸‹å‘è¯»å†™ï¼Œä½¿ç”¨ <code>IOSQE_IO_LINK</code> ä¿è¯è¯»å†™ä¹‹é—´çš„ä¾èµ–<span class="exturl" data-url="aHR0cHM6Ly9sb3JlLmtlcm5lbC5vcmcvbGludXgtYmxvY2svMjAxOTA1MTcyMTQxMzEuNTkyNS0xLWF4Ym9lQGtlcm5lbC5kay8="> [2]<i class="fa fa-external-link-alt"></i></span></td>
</tr>
<tr class="even">
<td><code>ucontext-cp.c</code></td>
<td>å¤åˆ¶ n ä¸ªæ–‡ä»¶çš„å†…å®¹åˆ°å¦ n ä¸ªæ–‡ä»¶</td>
<td>ä½¿ç”¨ <code>ucontext</code> è¿›è¡Œä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œæ¨¡æ‹Ÿ <span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxOTEwODk0OTA0L2FydGljbGUvZGV0YWlscy80MTkxMTE3NQ==">åç¨‹<i class="fa fa-external-link-alt"></i></span></td>
</tr>
</tbody>
</table>
<h4 id="ä»£ç æµç¨‹">ä»£ç æµç¨‹</h4>
<p>ä»”ç»†é˜…è¯»å‰ä¸‰ä¸ªç”¨ä¾‹ï¼Œå¯ä»¥çœ‹å‡ºä½¿ç”¨ io_uring çš„ä¸€èˆ¬æµç¨‹å¦‚ä¸‹ï¼š</p>
<ul>
<li>ä½¿ç”¨ <code>open</code>ã€<code>fstat</code>
ç­‰å‡½æ•°æ¥æ‰“å¼€æ–‡ä»¶ä»¥åŠå…ƒæ•°æ®æŸ¥çœ‹ç­‰æ“ä½œ
<ul>
<li>å› ä¸º io_uring æ›¿æ¢çš„æ˜¯è¯»å†™æ¥å£ï¼Œåç»­ io_uring æ“ä½œçš„å¯¹è±¡æ˜¯
<code>fd</code>ï¼ˆç”± <code>open</code> å‡½æ•°æ‰§è¡Œè¿”å›çš„ï¼‰</li>
</ul></li>
<li>ä½¿ç”¨ <code>io_uring_queue_init</code> åˆå§‹åŒ–
<code>struct io_uring ring</code> ç»“æ„ä½“</li>
<li>åˆå§‹åŒ– <code>struct iovec *iovecs</code> ç»“æ„ä½“ç”¨äºå­˜æ”¾ç”¨æˆ·æ€ buffer
æŒ‡é’ˆå’Œé•¿åº¦</li>
<li>é€šè¿‡ <code>io_uring_get_sqe</code> è·å– <code>sqe</code></li>
<li>é€šè¿‡ <code>io_uring_prep_#OP</code> å¯¹ <code>sqe</code>
å¡«å……å‘½ä»¤ï¼Œbuffer ä»¥åŠ offset ä¿¡æ¯
<ul>
<li>ã€å¯é€‰ã€‘ é€šè¿‡ <code>io_uring_sqe_set_data</code> å¯¹ <code>sqe</code>
é™„åŠ  <code>user_data</code> ä¿¡æ¯ï¼ˆè¯¥ä¿¡æ¯ä¼šåœ¨ <code>cqe</code>
ä¸­è¿›è¡Œè¿”å›ï¼‰</li>
</ul></li>
<li>é€šè¿‡ <code>io_uring_submit</code> å¯¹æ•´ä¸ª <code>ring</code> çš„æ‰€æœ‰
<code>sqe</code> è¿›è¡Œä¸‹å‘</li>
<li>é€šè¿‡ <code>io_uring_wait_cqe</code> æˆ–è€…
<code>io_uring_peek_cqe</code> æ¥è·å– <code>cqe</code>
<ul>
<li><code>io_uring_wait_cqe</code> ä¼šé˜»å¡å½“å‰çº¿ç¨‹ç›´åˆ°æœ‰ä¸€ä¸ª
<code>cqe</code> è¿”å›</li>
<li><code>io_uring_peek_cqe</code> ä¸ä¼šé˜»å¡ï¼Œå¦‚æœå½“å‰æ²¡æœ‰
<code>cqe</code>ï¼Œå°±ä¼šè¿”å›é”™è¯¯</li>
<li><code>io_uring_cqe_get_data</code> å¯ä»¥ä» <code>cqe</code> ä¸­è·å–
<code>user_data</code></li>
</ul></li>
<li>é€šè¿‡ <code>io_uring_cqe_seen</code> å¯¹å½“å‰ <code>cqe</code>
è¿›è¡Œæ¸…é™¤ï¼Œé¿å…è¢«äºŒæ¬¡å¤„ç†</li>
<li>æ‰€æœ‰ IO å®Œæˆåï¼Œé€šè¿‡ <code>io_uring_queue_exit</code> å°†
<code>ring</code> é”€æ¯</li>
</ul>
<h2 id="ç¼–è¯‘">ç¼–è¯‘</h2>
<p>æ ¹æ®å®˜æ–¹ <code>Makefile</code> å¯ä»¥çœ‹å‡ºç¼–è¯‘æ—¶æœ‰é¢å¤–çš„ä¸‰ä¸ªæ¡ä»¶</p>
<ul>
<li>å®šä¹‰ <code>_GNU_SOURCE</code> å®ï¼Œ<code>-D</code> å®å®šä¹‰</li>
<li>æŒ‡å®šé¢å¤–çš„å¤´æ–‡ä»¶ç›®å½•ï¼Œ<code>-I</code> æŒ‡å®šå¤´æ–‡ä»¶ç›®å½•ä½ç½®</li>
<li>ä½¿ç”¨ <code>liburing</code> åº“ï¼Œ<code>-L</code>
æŒ‡å®šåº“ä½ç½®ï¼Œ<code>-l</code> æŒ‡å®šåº“å</li>
</ul>
<p>å³
<code>gcc -D_GNU_SOURCE -I../src/include/ -L../src/ -o test test.c -luring</code></p>
<p>å…¶ä¸­å¤´æ–‡ä»¶ç›®å½•ä¸‹ä¸»è¦æœ‰ä¸‰ä¸ªå¤´æ–‡ä»¶ï¼š</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ tree src/include/</span><br><span class="line">src/include/</span><br><span class="line">â”œâ”€â”€ liburing</span><br><span class="line">â”‚   â”œâ”€â”€ barrier.h</span><br><span class="line">â”‚   â””â”€â”€ io_uring.h</span><br><span class="line">â””â”€â”€ liburing.h</span><br><span class="line"></span><br><span class="line">1 directory, 3 files</span><br></pre></td></tr></tbody></table></figure>
<p>è€Œ <code>liburing</code> åº“ä¹Ÿéœ€è¦ç¼–è¯‘ç”Ÿæˆï¼Œæ¨èç›´æ¥åœ¨
<code>liburing</code> çš„é¡¶å±‚ç›®å½•ç›´æ¥ <code>make all</code></p>
<h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h2>
<ul>
<li><a href="/posts/c142853f/io_uring.pdf">ã€PDFã€‘å®˜æ–¹ pdf</a></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9sb3JlLmtlcm5lbC5vcmcvbGludXgtYmxvY2svMjAxOTAxMTYxNzUwMDMuMTc4ODAtMS1heGJvZUBrZXJuZWwuZGsv">ã€Kernelã€‘io_uring
æ€§èƒ½æµ‹è¯•<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvSmVuc19BeGJvZQ==">ã€ç»´åŸºç™¾ç§‘ã€‘Jens
Axboe<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9sb3JlLmtlcm5lbC5vcmcvbGludXgtYmxvY2svMjAxOTA1MTcyMTQxMzEuNTkyNS0xLWF4Ym9lQGtlcm5lbC5kay8=">ã€Kernelã€‘io_uring
IOSQE_IO_LINK<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9rZXJuZWwudGFvYmFvLm9yZy8yMDE5LzA2L2lvX3VyaW5nLWEtbmV3LWxpbnV4LWFzeW5jaHJvbm91cy1pby1BUEkv">ã€é˜¿é‡Œäº‘æŠ€æœ¯åšå®¢ã€‘Linux
å¼‚æ­¥ IO æ–°æ—¶ä»£ï¼šio_uring<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0xpbmtlcmlzdC9ibG9nL2lzc3Vlcy8yNQ==">ã€GitHubã€‘ã€Šæ“ä½œç³»ç»Ÿä¸å­˜å‚¨ï¼šè§£æ
Linux å†…æ ¸å…¨æ–°å¼‚æ­¥ IO å¼•æ“ â€”â€” io_uring è®¾è®¡ä¸å®ç°ã€‹<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9hcnRodXJjaGlhby5hcnQvYmxvZy9pbnRyby10by1pby11cmluZy16aC8=">ã€ä¸ªäººåšå®¢ã€‘[è¯‘]
Linux å¼‚æ­¥ I/O æ¡†æ¶
io_uringï¼šåŸºæœ¬åŸç†ã€ç¨‹åºç¤ºä¾‹ä¸æ€§èƒ½å‹æµ‹ï¼ˆ2020ï¼‰<i class="fa fa-external-link-alt"></i></span></li>
</ul>
]]></content>
      <categories>
        <category>å­˜å‚¨</category>
        <category>IO</category>
      </categories>
      <tags>
        <tag>å¼‚æ­¥ IO</tag>
        <tag>liburing</tag>
        <tag>io_uring</tag>
      </tags>
  </entry>
  <entry>
    <title>page cache ç®€ä»‹</title>
    <url>/posts/9ba60726.html</url>
    <content><![CDATA[<p>å½“å‰å†…å®¹åŸºäº Linux Kernel <span class="exturl" data-url="aHR0cHM6Ly9naXQua2VybmVsLm9yZy9wdWIvc2NtL2xpbnV4L2tlcm5lbC9naXQvc3RhYmxlL2xpbnV4LmdpdC90YWcvP2g9djUuNC4xMjE=">v5.4.121<i class="fa fa-external-link-alt"></i></span></p>
<h2 id="page-cache">page cache</h2>
<p>ç”±äºç£ç›˜ HDD ç”šè‡³äºç°åœ¨å¹¿æ³›ä½¿ç”¨çš„å›ºæ€ç¡¬ç›˜ SSD çš„è¯»å†™é€Ÿåº¦éƒ½è¿œå°äºå†…å­˜
DRAM
çš„è¯»å†™é€Ÿåº¦ï¼Œä¸ºäº†é¿å…æ¯æ¬¡è¯»å–æ•°æ®éƒ½è¦ç›´æ¥è®¿é—®è¿™äº›ä½é€Ÿçš„åº•å±‚å­˜å‚¨è®¾å¤‡ï¼ŒLinux
åœ¨åˆ©ç”¨ DRAM å®ç°äº†ä¸€ä¸ªç¼“å­˜å±‚ï¼Œç¼“å­˜çš„ç²’åº¦æ˜¯ pageï¼Œå› æ­¤ä¹Ÿå« page
cacheï¼Œä¸­æ–‡ä¸€èˆ¬ç§°ä¸ºé¡µï¼ˆé¢ï¼‰ç¼“å­˜ <span id="more"></span></p>
<p>ç»è¿‡è¿™å±‚ page cache çš„ä½œç”¨ï¼ŒIO çš„æ€§èƒ½å¾—åˆ°äº†æ˜¾è‘—çš„æå‡ã€‚ä¸è¿‡ç”±äº DRAM
å…·æœ‰æ˜“å¤±æ€§ï¼Œåœ¨æ‰ç”µåæ•°æ®ä¼šä¸¢å¤±ï¼Œå› æ­¤å†…æ ¸ä¸­çš„ <a href="/posts/646202b9.html">å›å†™æœºåˆ¶</a> å®šæ—¶å°† page cache
ä¸­çš„æ•°æ®ä¸‹åˆ·åˆ°è®¾å¤‡ä¸Šï¼Œä¿è¯æ•°æ®çš„æŒä¹…åŒ–ã€‚æ­¤å¤–å†…æ ¸è¿˜åœ¨ page cache
ä¸­å®ç°äº†å·§å¦™çš„ <a href="/TODO">é¢„è¯»æœºåˆ¶</a> æå‡äº†é¡ºåºè¯»æ€§èƒ½</p>
<h2 id="ç›´æ¥-io-ä¸-ç¼“å­˜-io">ç›´æ¥ IO ä¸ ç¼“å­˜ IO</h2>
<p>åœ¨æ‹¥æœ‰ page cache è¿™ä¸€å±‚ç¼“å­˜åï¼Œå†™æ•°æ®å°±æœ‰äº†ä¸‰ç§ä¸åŒçš„ç­–ç•¥ï¼š</p>
<ol type="1">
<li>ä¸ç»è¿‡ç¼“å­˜ï¼Œç›´æ¥å†™åº•å±‚å­˜å‚¨è®¾å¤‡ï¼Œä½†åŒæ—¶è¦ä½¿ç¼“å­˜ä¸­æ•°æ®å¤±æ•ˆï¼Œä¹Ÿå«ä¸ç¼“å­˜ï¼ˆnowriteï¼‰</li>
<li>åªå†™ç¼“å­˜ï¼Œç¼“å­˜ä¸­æ•°æ®å®šæœŸåˆ·åˆ°åº•å±‚å­˜å‚¨è®¾å¤‡ä¸Šï¼Œä¹Ÿå«å†™å›ï¼ˆwrite
backï¼‰</li>
<li>åŒæ—¶å†™ç¼“å­˜å’Œåº•å±‚å­˜å‚¨è®¾å¤‡ï¼Œä¹Ÿå«å†™ç©¿ï¼ˆwrite throughï¼‰</li>
</ol>
<p>å‰ä¸¤ç§å°±æ˜¯ Linux åœ¨ IO æ ˆä¸­æ”¯æŒçš„ç›´æ¥ IOï¼ˆdirect IOï¼‰å’Œç¼“å­˜
IOï¼ˆbuffer IOï¼‰</p>
<p>ç¬¬ä¸‰ç§ç­–ç•¥è™½ç„¶èƒ½éå¸¸ç®€å•ä¿è¯ç¼“å­˜å’Œåº•å±‚è®¾å¤‡çš„ä¸€è‡´æ€§ï¼Œä¸è¿‡åŸºäºæ—¶é—´å±€éƒ¨æ€§åŸç†ï¼Œpage
cache ä¸­çš„æ•°æ®å¯èƒ½åªæ˜¯ä¸­é—´æ€ï¼Œä¼šè¢«é¢‘ç¹ä¿®æ”¹ï¼Œæ¯æ¬¡å†™ç©¿ä¼šäº§ç”Ÿå¤§é‡çš„å¼€é”€</p>
<h2 id="linux-io-æ ˆ">Linux IO æ ˆ</h2>
<p>è¯¦ç»†çš„ Linux IO æ ˆå›¾å¦‚ä¸‹ï¼ˆæ¥æºäº <span class="exturl" data-url="aHR0cHM6Ly93d3cudGhvbWFzLWtyZW5uLmNvbS9lbi93aWtpL0xpbnV4X1N0b3JhZ2VfU3RhY2tfRGlhZ3JhbQ==">Thomas-Krenn-Wiki<i class="fa fa-external-link-alt"></i></span>ï¼‰ï¼š</p>
<figure>
<img data-src="/posts/9ba60726/Linux-storage-stack-diagram_v4.10.png" alt="Linux-storage-stack-diagram">
<figcaption aria-hidden="true">Linux-storage-stack-diagram</figcaption>
</figure>
<p>å…¶å®ç®€åŒ–ä¸€ä¸‹ï¼Œå¯ä»¥åˆ†ä¸ºæ–‡ä»¶ç³»ç»Ÿã€å—å±‚å’Œè®¾å¤‡é©±åŠ¨å±‚è¿™ä¸‰å±‚</p>
<figure>
<img data-src="/posts/9ba60726/simple_IO_stack.png" alt="simple_IO_stack">
<figcaption aria-hidden="true">simple_IO_stack</figcaption>
</figure>
<h2 id="linux-ä¸­çš„å…·ä½“å®ç°">Linux ä¸­çš„å…·ä½“å®ç°</h2>
<p>è¿™é‡Œä»‹ç»å’Œ page cache ç›¸å…³çš„ä¸»è¦ç»“æ„ä½“å’Œä¸€äº›å¸¸ç”¨çš„å‡½æ•°</p>
<h3 id="ç›¸å…³ç»“æ„ä½“">ç›¸å…³ç»“æ„ä½“</h3>
<h4 id="è¶…çº§å—-super_block">è¶…çº§å— <code>super_block</code></h4>
<p>æ¯ä¸ªæ–‡ä»¶ç³»ç»Ÿéƒ½æœ‰ <code>super_block</code>
ç»“æ„ä½“ï¼Œç”¨äºå­˜å‚¨è¯¥æ–‡ä»¶ç³»ç»Ÿçš„ç‰¹å®šä¿¡æ¯</p>
<p>å…¶å®šä¹‰åœ¨ <code>include/linux/fs.h</code> ä¸­</p>
<figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">super_block</span> {</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">s_list</span>;</span>		<span class="comment">/* Keep this first */</span></span><br><span class="line">	<span class="type">dev_t</span>			s_dev;		<span class="comment">/* search index; _not_ kdev_t */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span>		s_blocksize_bits;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		s_blocksize;</span><br><span class="line">	<span class="type">loff_t</span>			s_maxbytes;	<span class="comment">/* Max file size */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">file_system_type</span>	*<span class="title">s_type</span>;</span></span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">super_operations</span>	*<span class="title">s_op</span>;</span></span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">dquot_operations</span>	*<span class="title">dq_op</span>;</span></span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">quotactl_ops</span>	*<span class="title">s_qcop</span>;</span></span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">export_operations</span> *<span class="title">s_export_op</span>;</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		s_flags;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		s_iflags;	<span class="comment">/* internal SB_I_* flags */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		s_magic;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dentry</span>		*<span class="title">s_root</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rw_semaphore</span>	<span class="title">s_umount</span>;</span></span><br><span class="line">	<span class="type">int</span>			s_count;</span><br><span class="line">	<span class="type">atomic_t</span>		s_active;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SECURITY</span></span><br><span class="line">	<span class="type">void</span>                    *s_security;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">xattr_handler</span> **<span class="title">s_xattr</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_FS_ENCRYPTION</span></span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">fscrypt_operations</span>	*<span class="title">s_cop</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">key</span>		*<span class="title">s_master_keys</span>;</span> <span class="comment">/* master crypto keys in use */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_FS_VERITY</span></span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">fsverity_operations</span> *<span class="title">s_vop</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">hlist_bl_head</span>	<span class="title">s_roots</span>;</span>	<span class="comment">/* alternate root dentries for NFS */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">s_mounts</span>;</span>	<span class="comment">/* list of mounts; _not_ for fs use */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">block_device</span>	*<span class="title">s_bdev</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">backing_dev_info</span> *<span class="title">s_bdi</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mtd_info</span>		*<span class="title">s_mtd</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">hlist_node</span>	<span class="title">s_instances</span>;</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span>		s_quota_types;	<span class="comment">/* Bitmask of supported quota types */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">quota_info</span>	<span class="title">s_dquot</span>;</span>	<span class="comment">/* Diskquota specific options */</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sb_writers</span>	<span class="title">s_writers</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Keep s_fs_info, s_time_gran, s_fsnotify_mask, and</span></span><br><span class="line"><span class="comment">	 * s_fsnotify_marks together for cache efficiency. They are frequently</span></span><br><span class="line"><span class="comment">	 * accessed and rarely modified.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="type">void</span>			*s_fs_info;	<span class="comment">/* Filesystem private info */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Granularity of c/m/atime in ns (cannot be worse than a second) */</span></span><br><span class="line">	u32			s_time_gran;</span><br><span class="line">	<span class="comment">/* Time limits for c/m/atime in seconds */</span></span><br><span class="line">	<span class="type">time64_t</span>		   s_time_min;</span><br><span class="line">	<span class="type">time64_t</span>		   s_time_max;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_FSNOTIFY</span></span><br><span class="line">	__u32			s_fsnotify_mask;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fsnotify_mark_connector</span> __<span class="title">rcu</span>	*<span class="title">s_fsnotify_marks</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="type">char</span>			s_id[<span class="number">32</span>];	<span class="comment">/* Informational name */</span></span><br><span class="line">	<span class="type">uuid_t</span>			s_uuid;		<span class="comment">/* UUID */</span></span><br><span class="line"></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span>		s_max_links;</span><br><span class="line">	<span class="type">fmode_t</span>			s_mode;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * The next field is for VFS *only*. No filesystems have any business</span></span><br><span class="line"><span class="comment">	 * even looking at it. You had been warned.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">s_vfs_rename_mutex</span>;</span>	<span class="comment">/* Kludge */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Filesystem subtype.  If non-empty the filesystem type field</span></span><br><span class="line"><span class="comment">	 * in /proc/mounts will be "type.subtype"</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="type">const</span> <span class="type">char</span> *s_subtype;</span><br><span class="line"></span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">dentry_operations</span> *<span class="title">s_d_op</span>;</span> <span class="comment">/* default d_op for dentries */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Saved pool identifier for cleancache (-1 means none)</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="type">int</span> cleancache_poolid;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">shrinker</span> <span class="title">s_shrink</span>;</span>	<span class="comment">/* per-sb shrinker handle */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Number of inodes with nlink == 0 but still referenced */</span></span><br><span class="line">	<span class="type">atomic_long_t</span> s_remove_count;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Pending fsnotify inode refs */</span></span><br><span class="line">	<span class="type">atomic_long_t</span> s_fsnotify_inode_refs;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Being remounted read-only */</span></span><br><span class="line">	<span class="type">int</span> s_readonly_remount;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* AIO completions deferred from interrupt context */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">workqueue_struct</span> *<span class="title">s_dio_done_wq</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">hlist_head</span> <span class="title">s_pins</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Owning user namespace and default context in which to</span></span><br><span class="line"><span class="comment">	 * interpret filesystem uids, gids, quotas, device nodes,</span></span><br><span class="line"><span class="comment">	 * xattrs and security labels.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">user_namespace</span> *<span class="title">s_user_ns</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * The list_lru structure is essentially just a pointer to a table</span></span><br><span class="line"><span class="comment">	 * of per-node lru lists, each of which has its own spinlock.</span></span><br><span class="line"><span class="comment">	 * There is no need to put them into separate cachelines.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_lru</span>		<span class="title">s_dentry_lru</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_lru</span>		<span class="title">s_inode_lru</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span>		<span class="title">rcu</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">work_struct</span>	<span class="title">destroy_work</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mutex</span>		<span class="title">s_sync_lock</span>;</span>	<span class="comment">/* sync serialisation lock */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Indicates how deep in a filesystem stack this SB is</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="type">int</span> s_stack_depth;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* s_inode_list_lock protects s_inodes */</span></span><br><span class="line">	<span class="type">spinlock_t</span>		s_inode_list_lock ____cacheline_aligned_in_smp;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">s_inodes</span>;</span>	<span class="comment">/* all inodes */</span></span><br><span class="line"></span><br><span class="line">	<span class="type">spinlock_t</span>		s_inode_wblist_lock;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">s_inodes_wb</span>;</span>	<span class="comment">/* writeback inodes */</span></span><br><span class="line">} __randomize_layout;</span><br></pre></td></tr></tbody></table></figure>
<p><code>super_block</code>
é€šå¸¸åœ¨æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿæ—¶ä¼šä»åº•å±‚å­˜å‚¨è®¾å¤‡ä¸Šè¯»å–å¹¶æ„å»ºï¼Œå¹¶ä¸”éœ€è¦åŒæ­¥å›åº•å±‚å­˜å‚¨è®¾å¤‡</p>
<h4 id="ç´¢å¼•èŠ‚ç‚¹-inode">ç´¢å¼•èŠ‚ç‚¹ <code>inode</code></h4>
<p>è€Œ <code>inode</code>
åˆ™æ˜¯æ–‡ä»¶ç³»ç»Ÿä¸­æœ€é‡è¦çš„ä¸€ä¸ªç»“æ„ä½“ï¼Œç”¨äºä¿å­˜ä¸€ä¸ªæ–‡ä»¶çš„å…ƒæ•°æ®ä»¥åŠå…¶åœ¨åº•å±‚è®¾å¤‡ä¸Šçš„ä½ç½®ä¿¡æ¯ç­‰ï¼ˆåœ¨
Linux ä¸‹ä¸€åˆ‡çš†æ˜¯æ–‡ä»¶ï¼Œç›®å½•ä¹Ÿæ˜¯ä¸€ç§æ–‡ä»¶ï¼‰</p>
<p>å…¶å®šä¹‰ä¹Ÿåœ¨ <code>include/linux/fs.h</code> ä¸­</p>
<figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Keep mostly read-only and often accessed (especially for</span></span><br><span class="line"><span class="comment"> * the RCU path lookup and 'stat' data) fields at the beginning</span></span><br><span class="line"><span class="comment"> * of the 'struct inode'</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">inode</span> {</span></span><br><span class="line">	<span class="comment">// inode ç±»å‹</span></span><br><span class="line">	<span class="type">umode_t</span>			i_mode;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">short</span>		i_opflags;</span><br><span class="line">	<span class="type">kuid_t</span>			i_uid;</span><br><span class="line">	<span class="type">kgid_t</span>			i_gid;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span>		i_flags;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_FS_POSIX_ACL</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">posix_acl</span>	*<span class="title">i_acl</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">posix_acl</span>	*<span class="title">i_default_acl</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">inode_operations</span>	*<span class="title">i_op</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">super_block</span>	*<span class="title">i_sb</span>;</span></span><br><span class="line">	<span class="comment">// page cache ç›¸å…³</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">address_space</span>	*<span class="title">i_mapping</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SECURITY</span></span><br><span class="line">	<span class="type">void</span>			*i_security;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Stat data, not accessed from path walking */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		i_ino;</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Filesystems may only read i_nlink directly.  They shall use the</span></span><br><span class="line"><span class="comment">	 * following functions for modification:</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 *    (set|clear|inc|drop)_nlink</span></span><br><span class="line"><span class="comment">	 *    inode_(inc|dec)_link_count</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> {</span></span><br><span class="line">		<span class="type">const</span> <span class="type">unsigned</span> <span class="type">int</span> i_nlink;</span><br><span class="line">		<span class="type">unsigned</span> <span class="type">int</span> __i_nlink;</span><br><span class="line">	};</span><br><span class="line">	<span class="type">dev_t</span>			i_rdev;</span><br><span class="line">	<span class="type">loff_t</span>			i_size;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">timespec64</span>	<span class="title">i_atime</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">timespec64</span>	<span class="title">i_mtime</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">timespec64</span>	<span class="title">i_ctime</span>;</span></span><br><span class="line">	<span class="type">spinlock_t</span>		i_lock;	<span class="comment">/* i_blocks, i_bytes, maybe i_size */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">short</span>          i_bytes;</span><br><span class="line">	u8			i_blkbits;</span><br><span class="line">	u8			i_write_hint;</span><br><span class="line">	<span class="type">blkcnt_t</span>		i_blocks;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __NEED_I_SIZE_ORDERED</span></span><br><span class="line">	<span class="type">seqcount_t</span>		i_size_seqcount;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Misc */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		i_state;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rw_semaphore</span>	<span class="title">i_rwsem</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		dirtied_when;	<span class="comment">/* jiffies of first dirtying */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		dirtied_time_when;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">hlist_node</span>	<span class="title">i_hash</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">i_io_list</span>;</span>	<span class="comment">/* backing dev IO list */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_CGROUP_WRITEBACK</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">bdi_writeback</span>	*<span class="title">i_wb</span>;</span>		<span class="comment">/* the associated cgroup wb */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* foreign inode detection, see wbc_detach_inode() */</span></span><br><span class="line">	<span class="type">int</span>			i_wb_frn_winner;</span><br><span class="line">	u16			i_wb_frn_avg_time;</span><br><span class="line">	u16			i_wb_frn_history;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">i_lru</span>;</span>		<span class="comment">/* inode LRU list */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">i_sb_list</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">i_wb_list</span>;</span>	<span class="comment">/* backing dev writeback list */</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> {</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">hlist_head</span>	<span class="title">i_dentry</span>;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span>		<span class="title">i_rcu</span>;</span></span><br><span class="line">	};</span><br><span class="line">	<span class="type">atomic64_t</span>		i_version;</span><br><span class="line">	<span class="type">atomic64_t</span>		i_sequence; <span class="comment">/* see futex */</span></span><br><span class="line">	<span class="type">atomic_t</span>		i_count;</span><br><span class="line">	<span class="type">atomic_t</span>		i_dio_count;</span><br><span class="line">	<span class="type">atomic_t</span>		i_writecount;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_IMA) || defined(CONFIG_FILE_LOCKING)</span></span><br><span class="line">	<span class="type">atomic_t</span>		i_readcount; <span class="comment">/* struct files open RO */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> {</span></span><br><span class="line">		<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span>	*<span class="title">i_fop</span>;</span>	<span class="comment">/* former -&gt;i_op-&gt;default_file_ops */</span></span><br><span class="line">		<span class="type">void</span> (*free_inode)(<span class="keyword">struct</span> inode *);</span><br><span class="line">	};</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">file_lock_context</span>	*<span class="title">i_flctx</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">address_space</span>	<span class="title">i_data</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">i_devices</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> {</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">pipe_inode_info</span>	*<span class="title">i_pipe</span>;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">block_device</span>	*<span class="title">i_bdev</span>;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">cdev</span>		*<span class="title">i_cdev</span>;</span></span><br><span class="line">		<span class="type">char</span>			*i_link;</span><br><span class="line">		<span class="type">unsigned</span>		i_dir_seq;</span><br><span class="line">	};</span><br><span class="line"></span><br><span class="line">	__u32			i_generation;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_FSNOTIFY</span></span><br><span class="line">	__u32			i_fsnotify_mask; <span class="comment">/* all events this inode cares about */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fsnotify_mark_connector</span> __<span class="title">rcu</span>	*<span class="title">i_fsnotify_marks</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_FS_ENCRYPTION</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fscrypt_info</span>	*<span class="title">i_crypt_info</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_FS_VERITY</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fsverity_info</span>	*<span class="title">i_verity_info</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="type">void</span>			*i_private; <span class="comment">/* fs or device private pointer */</span></span><br><span class="line">} __randomize_layout;</span><br></pre></td></tr></tbody></table></figure>
<p>ä¸ <code>super_block</code> ä¸€æ ·ï¼Œ<code>inode</code>
ä¹Ÿæ˜¯ä»åº•å±‚å­˜å‚¨è®¾å¤‡ä¸Šè¯»å–å¹¶æ„å»ºçš„ï¼Œå¹¶ä¸”ä¹Ÿéœ€è¦åŒæ­¥å›åº•å±‚å­˜å‚¨è®¾å¤‡</p>
<h4 id="æ–‡ä»¶-file">æ–‡ä»¶ <code>file</code></h4>
<p><code>file</code>
å…¶å®æ˜¯å·²ç»æ‰“å¼€çš„åº•å±‚å­˜å‚¨è®¾å¤‡ä¸Šçš„æ–‡ä»¶åœ¨å†…å­˜ä¸­çš„è¡¨ç¤ºã€‚ä¸å‰é¢ä¸¤ä¸ªç»“æ„ä½“æœ‰æ‰€ä¸åŒï¼Œåº•å±‚å­˜å‚¨è®¾å¤‡ä¸Šå¹¶ä¸ä¼šå­˜å‚¨ï¼Œè¯¥ç»“æ„ä½“åªæ˜¯å†…æ ¸æŠ½è±¡å‡ºæ¥çš„ï¼Œä»…ä»…å­˜åœ¨äºå†…å­˜ä¸­ï¼Œæ–¹ä¾¿ç®¡ç†</p>
<p>å…¶å®šä¹‰ä¹Ÿåœ¨ <code>include/linux/fs.h</code> ä¸­</p>
<figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file</span> {</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> {</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">llist_node</span>	<span class="title">fu_llist</span>;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span> 	<span class="title">fu_rcuhead</span>;</span></span><br><span class="line">	} f_u;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">path</span>		<span class="title">f_path</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">inode</span>		*<span class="title">f_inode</span>;</span>	<span class="comment">/* cached value */</span></span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span>	*<span class="title">f_op</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Protects f_ep_links, f_flags.</span></span><br><span class="line"><span class="comment">	 * Must not be taken from IRQ context.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="type">spinlock_t</span>		f_lock;</span><br><span class="line">	<span class="class"><span class="keyword">enum</span> <span class="title">rw_hint</span>		<span class="title">f_write_hint</span>;</span></span><br><span class="line">	<span class="type">atomic_long_t</span>		f_count;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> 		f_flags;</span><br><span class="line">	<span class="type">fmode_t</span>			f_mode;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mutex</span>		<span class="title">f_pos_lock</span>;</span></span><br><span class="line">	<span class="type">loff_t</span>			f_pos;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fown_struct</span>	<span class="title">f_owner</span>;</span></span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span>	*<span class="title">f_cred</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">file_ra_state</span>	<span class="title">f_ra</span>;</span></span><br><span class="line"></span><br><span class="line">	u64			f_version;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SECURITY</span></span><br><span class="line">	<span class="type">void</span>			*f_security;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="comment">/* needed for tty driver, and maybe others */</span></span><br><span class="line">	<span class="type">void</span>			*private_data;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_EPOLL</span></span><br><span class="line">	<span class="comment">/* Used by fs/eventpoll.c to link all the hooks to this file */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">f_ep_links</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">f_tfile_llink</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* #ifdef CONFIG_EPOLL */</span></span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">address_space</span>	*<span class="title">f_mapping</span>;</span></span><br><span class="line">	<span class="type">errseq_t</span>		f_wb_err;</span><br><span class="line">} __randomize_layout</span><br><span class="line">  __attribute__((aligned(<span class="number">4</span>)));	<span class="comment">/* lest something weird decides that 2 is OK */</span></span><br></pre></td></tr></tbody></table></figure>
<p>æ¯ä¸ª file éƒ½ä¸ä¸€ä¸ª inode å¯¹åº”</p>
<h4 id="ç›®å½•é¡¹-dentry">ç›®å½•é¡¹ <code>dentry</code></h4>
<p><code>dentry</code> ä¸ <code>file</code>
ç±»ä¼¼ï¼Œåº•å±‚è®¾å¤‡ä¸Šå¹¶ä¸ä¼šå­˜å‚¨ï¼Œè¯¥ç»“æ„ä½“ä¹Ÿæ˜¯å†…æ ¸æŠ½è±¡å‡ºæ¥çš„ï¼Œé’ˆå¯¹ç›®å½•æ–‡ä»¶è¿›è¡Œç‰¹æ®Šçš„ç®¡ç†</p>
<p>ç›®å½•é¡¹ç›¸å¯¹äºæ–‡ä»¶å…·æœ‰æ›´é«˜çš„çƒ­åº¦ï¼ŒåŒæ—¶ä¸ºäº†åŠ é€Ÿæ‰“å¼€æ–‡ä»¶æ—¶çš„è·¯å¾„è§£æï¼Œå†…æ ¸ä¸­è¿˜å®ç°äº†ç›®å½•é¡¹ç¼“å­˜
<code>dcache</code> ç”¨äºç¼“å­˜ <code>dentry</code></p>
<p>å…¶å®šä¹‰åœ¨ <code>include/linux/dcache.h</code> ä¸­</p>
<figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> {</span></span><br><span class="line">	<span class="comment">/* RCU lookup touched fields */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> d_flags;		<span class="comment">/* protected by d_lock */</span></span><br><span class="line">	<span class="type">seqcount_t</span> d_seq;		<span class="comment">/* per dentry seqlock */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">hlist_bl_node</span> <span class="title">d_hash</span>;</span>	<span class="comment">/* lookup hash list */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> *<span class="title">d_parent</span>;</span>	<span class="comment">/* parent directory */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">qstr</span> <span class="title">d_name</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *<span class="title">d_inode</span>;</span>		<span class="comment">/* Where the name belongs to - NULL is</span></span><br><span class="line"><span class="comment">					 * negative */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> d_iname[DNAME_INLINE_LEN];	<span class="comment">/* small names */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Ref lookup also touches following */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">lockref</span> <span class="title">d_lockref</span>;</span>	<span class="comment">/* per-dentry lock and refcount */</span></span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">dentry_operations</span> *<span class="title">d_op</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">super_block</span> *<span class="title">d_sb</span>;</span>	<span class="comment">/* The root of the dentry tree */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> d_time;		<span class="comment">/* used by d_revalidate */</span></span><br><span class="line">	<span class="type">void</span> *d_fsdata;			<span class="comment">/* fs-specific data */</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">union</span> {</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">d_lru</span>;</span>		<span class="comment">/* LRU list */</span></span><br><span class="line">		<span class="type">wait_queue_head_t</span> *d_wait;	<span class="comment">/* in-lookup ones only */</span></span><br><span class="line">	};</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">d_child</span>;</span>	<span class="comment">/* child of parent list */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">d_subdirs</span>;</span>	<span class="comment">/* our children */</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * d_alias and d_rcu can share memory</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> {</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">hlist_node</span> <span class="title">d_alias</span>;</span>	<span class="comment">/* inode alias list */</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">hlist_bl_node</span> <span class="title">d_in_lookup_hash</span>;</span>	<span class="comment">/* only for in-lookup ones */</span></span><br><span class="line">	 	<span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span> <span class="title">d_rcu</span>;</span></span><br><span class="line">	} d_u;</span><br><span class="line">} __randomize_layout;</span><br></pre></td></tr></tbody></table></figure>
<p>å› ä¸ºç›®å½•ä¹Ÿæ˜¯æ–‡ä»¶ï¼Œæ‰€ä»¥æ¯ä¸ª <code>dentry</code> ä¹Ÿä¼šä¸ä¸€ä¸ª
<code>inode</code> å¯¹åº”</p>
<h4 id="é¡µç¼“å­˜-address_space">é¡µç¼“å­˜ <code>address_space</code></h4>
<p>åœ¨ <code>inode</code> ç»“æ„ä½“ä¸­å¯ä»¥çœ‹è§ä¸€ä¸ªç±»å‹ä¸º
<code>address_space</code> ç»“æ„ä½“æŒ‡é’ˆçš„ <code>i_mapping</code>
å­—æ®µï¼Œå…¶å®å®ƒå°±æ˜¯ page cache çš„æ ¸å¿ƒç»“æ„ä½“</p>
<p>å…¶å®šä¹‰ä¹Ÿåœ¨ <code>include/linux/fs.h</code> ä¸­</p>
<figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * struct address_space - Contents of a cacheable, mappable object.</span></span><br><span class="line"><span class="comment"> * @host: Owner, either the inode or the block_device.</span></span><br><span class="line"><span class="comment"> * @i_pages: Cached pages.</span></span><br><span class="line"><span class="comment"> * @gfp_mask: Memory allocation flags to use for allocating pages.</span></span><br><span class="line"><span class="comment"> * @i_mmap_writable: Number of VM_SHARED mappings.</span></span><br><span class="line"><span class="comment"> * @nr_thps: Number of THPs in the pagecache (non-shmem only).</span></span><br><span class="line"><span class="comment"> * @i_mmap: Tree of private and shared mappings.</span></span><br><span class="line"><span class="comment"> * @i_mmap_rwsem: Protects @i_mmap and @i_mmap_writable.</span></span><br><span class="line"><span class="comment"> * @nrpages: Number of page entries, protected by the i_pages lock.</span></span><br><span class="line"><span class="comment"> * @nrexceptional: Shadow or DAX entries, protected by the i_pages lock.</span></span><br><span class="line"><span class="comment"> * @writeback_index: Writeback starts here.</span></span><br><span class="line"><span class="comment"> * @a_ops: Methods.</span></span><br><span class="line"><span class="comment"> * @flags: Error bits and flags (AS_*).</span></span><br><span class="line"><span class="comment"> * @wb_err: The most recent error which has occurred.</span></span><br><span class="line"><span class="comment"> * @private_lock: For use by the owner of the address_space.</span></span><br><span class="line"><span class="comment"> * @private_list: For use by the owner of the address_space.</span></span><br><span class="line"><span class="comment"> * @private_data: For use by the owner of the address_space.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">address_space</span> {</span></span><br><span class="line">	<span class="comment">// æŒ‡å‘æ–‡ä»¶ inode</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">inode</span>		*<span class="title">host</span>;</span></span><br><span class="line">	<span class="comment">// å½“å‰æ–‡ä»¶ç¼“å­˜çš„æ‰€æœ‰ page</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">xarray</span>		<span class="title">i_pages</span>;</span></span><br><span class="line">	<span class="type">gfp_t</span>			gfp_mask;</span><br><span class="line">	<span class="type">atomic_t</span>		i_mmap_writable;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_READ_ONLY_THP_FOR_FS</span></span><br><span class="line">	<span class="comment">/* number of thp, only for non-shmem files */</span></span><br><span class="line">	<span class="type">atomic_t</span>		nr_thps;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rb_root_cached</span>	<span class="title">i_mmap</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rw_semaphore</span>	<span class="title">i_mmap_rwsem</span>;</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		nrpages;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		nrexceptional;</span><br><span class="line">	<span class="type">pgoff_t</span>			writeback_index;</span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">address_space_operations</span> *<span class="title">a_ops</span>;</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		flags;</span><br><span class="line">	<span class="type">errseq_t</span>		wb_err;</span><br><span class="line">	<span class="type">spinlock_t</span>		private_lock;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">private_list</span>;</span></span><br><span class="line">	<span class="type">void</span>			*private_data;</span><br><span class="line">} __attribute__((aligned(<span class="keyword">sizeof</span>(<span class="type">long</span>)))) __randomize_layout;</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * On most architectures that alignment is already the case; but</span></span><br><span class="line"><span class="comment">	 * must be enforced here for CRIS, to let the least significant bit</span></span><br><span class="line"><span class="comment">	 * of struct page's "mapping" pointer be used for PAGE_MAPPING_ANON.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">request_queue</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">block_device</span> {</span></span><br><span class="line">	<span class="type">dev_t</span>			bd_dev;  <span class="comment">/* not a kdev_t - it's a search key */</span></span><br><span class="line">	<span class="type">int</span>			bd_openers;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *		<span class="title">bd_inode</span>;</span>	<span class="comment">/* will die */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">super_block</span> *	<span class="title">bd_super</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mutex</span>		<span class="title">bd_mutex</span>;</span>	<span class="comment">/* open/close mutex */</span></span><br><span class="line">	<span class="type">void</span> *			bd_claiming;</span><br><span class="line">	<span class="type">void</span> *			bd_holder;</span><br><span class="line">	<span class="type">int</span>			bd_holders;</span><br><span class="line">	<span class="type">bool</span>			bd_write_holder;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SYSFS</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">bd_holder_disks</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">block_device</span> *	<span class="title">bd_contains</span>;</span></span><br><span class="line">	<span class="type">unsigned</span>		bd_block_size;</span><br><span class="line">	u8			bd_partno;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">hd_struct</span> *	<span class="title">bd_part</span>;</span></span><br><span class="line">	<span class="comment">/* number of times partitions within this device have been opened. */</span></span><br><span class="line">	<span class="type">unsigned</span>		bd_part_count;</span><br><span class="line">	<span class="type">int</span>			bd_invalidated;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">gendisk</span> *	<span class="title">bd_disk</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">request_queue</span> *  <span class="title">bd_queue</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">backing_dev_info</span> *<span class="title">bd_bdi</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">bd_list</span>;</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Private data.  You must have bd_claim'ed the block_device</span></span><br><span class="line"><span class="comment">	 * to use this.  <span class="doctag">NOTE:</span>  bd_claim allows an owner to claim</span></span><br><span class="line"><span class="comment">	 * the same device multiple times, the owner must take special</span></span><br><span class="line"><span class="comment">	 * care to not mess up bd_private for that case.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		bd_private;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* The counter of freeze processes */</span></span><br><span class="line">	<span class="type">int</span>			bd_fsfreeze_count;</span><br><span class="line">	<span class="comment">/* Mutex for freeze */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mutex</span>		<span class="title">bd_fsfreeze_mutex</span>;</span></span><br><span class="line">} __randomize_layout;</span><br></pre></td></tr></tbody></table></figure>
<p>æ¯ä¸€ä¸ª <code>address_space</code> ä¸ä¸€ä¸ª <code>inode</code>
å¯¹åº”ï¼ŒåŒæ—¶ <code>file</code> ä¸­çš„ <code>f_mapping</code>
å­—æ®µé€šå¸¸ç”±è¯¥æ–‡ä»¶çš„ <code>inode</code> ä¸­ <code>i_mapping</code>
èµ‹å€¼ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯ä¸ªæ–‡ä»¶éƒ½ä¼šæœ‰ç‹¬è‡ªçš„ <code>file</code>ã€<code>inode</code>
ä»¥åŠ <code>address_space</code> ç»“æ„ä½“</p>
<p><code>address_space</code> ç»“æ„ä½“ <code>struct xarray i_pages</code>
å°±æ˜¯è¯¥æ–‡ä»¶çš„ page cache
ä¸­ç¼“å­˜çš„æ‰€æœ‰ç‰©ç†é¡µã€‚å®ƒæ˜¯é€šè¿‡åŸºæ•°æ ‘è¿™ä¸€ç»“æ„è¿›è¡Œç®¡ç†çš„ï¼Œè€Œ
<code>xarray</code> åªæ˜¯åœ¨åŸºæ•°æ ‘ä¸Šè¿›è¡Œäº†ä¸€å±‚å°è£…</p>
<h3 id="å¸¸ç”¨å‡½æ•°">å¸¸ç”¨å‡½æ•°</h3>
<p>é€šå¸¸ <code>address_space</code> ä¸Šä¼šæŒ‚è½½ä¸€ä¸ª
<code>address_space_operations</code> ç»“æ„ï¼Œç”¨äºè‡ªå®šä¹‰å¯¹ page cache
ä¸­çš„é¡µé¢æ“ä½œçš„å‡½æ•°</p>
<p><code>address_space_operations</code> ç»“æ„å®šä¹‰ä¹Ÿåœ¨
<code>include/linux/fs.h</code> ä¸­</p>
<figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">address_space_operations</span> {</span></span><br><span class="line">	<span class="type">int</span> (*writepage)(<span class="keyword">struct</span> page *page, <span class="keyword">struct</span> writeback_control *wbc);</span><br><span class="line">	<span class="type">int</span> (*readpage)(<span class="keyword">struct</span> file *, <span class="keyword">struct</span> page *);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Write back some dirty pages from this mapping. */</span></span><br><span class="line">	<span class="type">int</span> (*writepages)(<span class="keyword">struct</span> address_space *, <span class="keyword">struct</span> writeback_control *);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Set a page dirty.  Return true if this dirtied it */</span></span><br><span class="line">	<span class="type">int</span> (*set_page_dirty)(<span class="keyword">struct</span> page *page);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Reads in the requested pages. Unlike -&gt;readpage(), this is</span></span><br><span class="line"><span class="comment">	 * PURELY used for read-ahead!.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="type">int</span> (*readpages)(<span class="keyword">struct</span> file *filp, <span class="keyword">struct</span> address_space *mapping,</span><br><span class="line">			<span class="keyword">struct</span> list_head *pages, <span class="type">unsigned</span> nr_pages);</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> (*write_begin)(<span class="keyword">struct</span> file *, <span class="keyword">struct</span> address_space *mapping,</span><br><span class="line">				<span class="type">loff_t</span> pos, <span class="type">unsigned</span> len, <span class="type">unsigned</span> flags,</span><br><span class="line">				<span class="keyword">struct</span> page **pagep, <span class="type">void</span> **fsdata);</span><br><span class="line">	<span class="type">int</span> (*write_end)(<span class="keyword">struct</span> file *, <span class="keyword">struct</span> address_space *mapping,</span><br><span class="line">				<span class="type">loff_t</span> pos, <span class="type">unsigned</span> len, <span class="type">unsigned</span> copied,</span><br><span class="line">				<span class="keyword">struct</span> page *page, <span class="type">void</span> *fsdata);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Unfortunately this kludge is needed for FIBMAP. Don't use it */</span></span><br><span class="line">	<span class="type">sector_t</span> (*bmap)(<span class="keyword">struct</span> address_space *, <span class="type">sector_t</span>);</span><br><span class="line">	<span class="type">void</span> (*invalidatepage) (<span class="keyword">struct</span> page *, <span class="type">unsigned</span> <span class="type">int</span>, <span class="type">unsigned</span> <span class="type">int</span>);</span><br><span class="line">	<span class="type">int</span> (*releasepage) (<span class="keyword">struct</span> page *, <span class="type">gfp_t</span>);</span><br><span class="line">	<span class="type">void</span> (*freepage)(<span class="keyword">struct</span> page *);</span><br><span class="line">	<span class="type">ssize_t</span> (*direct_IO)(<span class="keyword">struct</span> kiocb *, <span class="keyword">struct</span> iov_iter *iter);</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * migrate the contents of a page to the specified target. If</span></span><br><span class="line"><span class="comment">	 * migrate_mode is MIGRATE_ASYNC, it must not block.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="type">int</span> (*migratepage) (<span class="keyword">struct</span> address_space *,</span><br><span class="line">			<span class="keyword">struct</span> page *, <span class="keyword">struct</span> page *, <span class="keyword">enum</span> migrate_mode);</span><br><span class="line">	<span class="type">bool</span> (*isolate_page)(<span class="keyword">struct</span> page *, <span class="type">isolate_mode_t</span>);</span><br><span class="line">	<span class="type">void</span> (*putback_page)(<span class="keyword">struct</span> page *);</span><br><span class="line">	<span class="type">int</span> (*launder_page) (<span class="keyword">struct</span> page *);</span><br><span class="line">	<span class="type">int</span> (*is_partially_uptodate) (<span class="keyword">struct</span> page *, <span class="type">unsigned</span> <span class="type">long</span>,</span><br><span class="line">					<span class="type">unsigned</span> <span class="type">long</span>);</span><br><span class="line">	<span class="type">void</span> (*is_dirty_writeback) (<span class="keyword">struct</span> page *, <span class="type">bool</span> *, <span class="type">bool</span> *);</span><br><span class="line">	<span class="type">int</span> (*error_remove_page)(<span class="keyword">struct</span> address_space *, <span class="keyword">struct</span> page *);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* swapfile support */</span></span><br><span class="line">	<span class="type">int</span> (*swap_activate)(<span class="keyword">struct</span> swap_info_struct *sis, <span class="keyword">struct</span> file *file,</span><br><span class="line">				<span class="type">sector_t</span> *span);</span><br><span class="line">	<span class="type">void</span> (*swap_deactivate)(<span class="keyword">struct</span> file *file);</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>
<p>è¿™é‡Œç®€è¦ä»‹ç»ä¸€ä¸‹å…¶ä¸­é€šç”¨çš„éƒ¨åˆ†å¸¸ç”¨å‡½æ•°</p>
<h4 id="ä»åº•å±‚å¡«å……">ä»åº•å±‚å¡«å……</h4>
<p>å½“æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶åï¼Œpage cache
ä¸ä¼šç«‹å³ç¼“å­˜è¿™ä¸ªæ–‡ä»¶çš„æ‰€æœ‰æ•°æ®é¡µï¼Œè€Œæ˜¯éšç€å¯¹æ–‡ä»¶çš„è¯»å†™æ¥é€æ¸å¡«å……çš„</p>
<p><code>readpage</code> å’Œ <code>readpages</code>
å°±æ˜¯å°†åº•å±‚å­˜å‚¨è®¾å¤‡ä¸Šçš„ä¸€ä¸ªæˆ–è€…å¤šä¸ªé¡µçš„æ•°æ®è¯»åˆ° page cache ä¸­</p>
<h4 id="å†™å…¥ä¿®æ”¹">å†™å…¥ä¿®æ”¹</h4>
<p>page cache çš„å†™å…¥è¾ƒä¸ºå¤æ‚ï¼Œä¸»è¦åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼š</p>
<ol type="1">
<li><code>write_begin</code>
ä¸»è¦è´Ÿè´£æŸ¥æ‰¾ã€æˆ–è€…åˆ†é…æ–°çš„ç‰©ç†é¡µï¼Œå¹¶å°†å…¶é”å®šï¼Œæœ‰æ—¶è¿˜éœ€è¦å…ˆä»åº•å±‚è¯»å–æœ€æ–°çš„æ•°æ®é¡µ</li>
<li><code>writepage</code> æˆ–è€… <code>writepages</code>
å°±æ˜¯è´Ÿè´£å¯¹è¿™äº›ç‰©ç†é¡µçš„å®é™…å†™å…¥è¿‡ç¨‹</li>
<li><code>write_end</code> ä¸»è¦è´Ÿè´£è§£é”è¿™äº›ç‰©ç†é¡µï¼Œå¹¶ä¸”æ›´æ–°
<code>inode</code> ä¸­çš„å…ƒæ•°æ®ä¿¡æ¯ï¼Œä¾‹å¦‚ <code>i_size</code></li>
</ol>
<h4 id="å…¶ä»–">å…¶ä»–</h4>
<p><code>direct_IO</code> åˆ™æ˜¯è´Ÿè´£ä¸ç»è¿‡ page cache çš„ç›´æ¥ IO çš„å®ç°</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå½“éœ€è¦è¯»çš„æ•°æ®åœ¨ page cache
ä¸­ç¼“å­˜çš„å’Œåº•å±‚å­˜å‚¨æ•°æ®ä¸ä¸€è‡´æ—¶ï¼Œä¹Ÿå°±æ˜¯ <code>page</code> ä¸º
<code>dirty</code> çŠ¶æ€æ—¶ï¼Œé€šå¸¸éœ€è¦è°ƒç”¨
<code>filemap_write_and_wait</code> æˆ–è€…
<code>filemap_write_and_wait_range</code>
å…ˆå°†è¿™éƒ¨åˆ†è„æ•°æ®å†™åˆ°åº•å±‚è®¾å¤‡ä¹‹åï¼Œæ‰èƒ½æ‰§è¡Œ direct read</p>
<h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h2>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly93d3cudGhvbWFzLWtyZW5uLmNvbS9lbi93aWtpL0xpbnV4X1N0b3JhZ2VfU3RhY2tfRGlhZ3JhbQ==">ã€Thomas-Krenn-Wikiã€‘Linux
Storage Stack Diagram<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2p1UzNWZS9hcnRpY2xlL2RldGFpbHMvODIzMjI2Mzc=">ã€CSDNã€‘æµ…å¢¨:
èŠèŠ Linux IO (ä¸­) â€”â€” Linux å†…æ ¸ä¸­çš„ IO æ ˆ<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly93d3cuZG9jLWRldmVsb3BwZW1lbnQtZHVyYWJsZS5vcmcvZmlsZS9Qcm9qZXRzLWluZm9ybWF0aXF1ZXMvY291cnMtJi1tYW51ZWxzLWluZm9ybWF0aXF1ZXMvTGludXgvTGludXglMjBLZXJuZWwlMjBEZXZlbG9wbWVudCwlMjAzcmQlMjBFZGl0aW9uLnBkZg==">ã€LKDã€‘Linux
Kernel Development (3rd Edition)<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9rZXJuZWwudGFvYmFvLm9yZy8yMDE4LzA1L1RoZS1YQXJyYXktZGF0YS1zdHJ1Y3R1cmUv">ã€é˜¿é‡Œäº‘æŠ€æœ¯åšå®¢ã€‘The
Xarray Data Structure<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9sd24ubmV0L0FydGljbGVzLzI1NDg1Ni8=">ã€LWNã€‘Some VFS address
space operations changes<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vbGluaGFvc3R1ZHkvcC8xMDE5NjkxNS5odG1s">ã€åšå®¢å›­ã€‘Page
Cache ä¸ Page å›å†™<i class="fa fa-external-link-alt"></i></span></li>
</ul>
]]></content>
      <categories>
        <category>å­˜å‚¨</category>
        <category>IO</category>
      </categories>
      <tags>
        <tag>todo</tag>
        <tag>kernel</tag>
        <tag>buffer IO</tag>
        <tag>page cache</tag>
        <tag>writeback</tag>
      </tags>
  </entry>
  <entry>
    <title>ç¾åŒ– Shell ä¹‹ Windows/Linux PowerShell ç¯‡</title>
    <url>/posts/8ad4716e.html</url>
    <content><![CDATA[<h2 id="ç®€ä»‹">ç®€ä»‹</h2>
<p><code>PowerShell</code> æ˜¯ Windows æœ€æ–°çš„ <code>Shell</code>ï¼Œè€Œä¸”åœ¨
GitHub ä¸Šå¼€æºå¹¶ä¸”æä¾›äº†è·¨å¹³å°æ”¯æŒï¼ˆè™½ç„¶ä¼°è®¡æ²¡å“ªä¸ª <code>Linux</code>
ç”¨æˆ·ä¼šé€‰æ‹© <code>PowerShell</code></p>
<p>ä¸ºäº†ç¾åŒ– <code>PowerShell</code>ï¼Œä¸ªäººé€‰æ‹©äº†
<code>Oh My Posh</code>ã€‚<code>Oh My Posh</code>
æ˜¯ä¸€ä¸ªå¼€æºçš„ä¸»ä½“çš„æ¡†æ¶ï¼Œæ”¯æŒ
<code>PowerShell</code>ã€<code>CMD</code>ã€<code>Zsh</code>ã€<code>Bash</code>ã€<code>Fish</code>
ç­‰å¤šç§ <code>Shell</code></p>
<p>æœ¬æ–‡ä¸»è¦è®°å½•è‡ªå·±çš„ <code>Oh My Posh</code> å®‰è£…ä»¥åŠé…ç½®æµç¨‹
<span id="more"></span></p>
<h2 id="å®‰è£…æœ€æ–°çš„-powershell">å®‰è£…æœ€æ–°çš„ <code>PowerShell</code></h2>
<p>Windows é»˜è®¤å®‰è£…çš„ <code>PowerShell</code> ç‰ˆæœ¬å¤ªæ—§ï¼Œæ‰€ä»¥å…ˆé€šè¿‡
<code>winget</code> å®‰è£…æœ€æ–°çš„ç‰ˆæœ¬</p>
<figure class="highlight powershell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># winget search Microsoft.PowerShell</span></span><br><span class="line">winget install <span class="literal">--id</span> Microsoft.Powershell <span class="literal">--source</span> winget</span><br></pre></td></tr></tbody></table></figure>
<h2 id="å®‰è£…-oh-my-posh">å®‰è£… <code>Oh My Posh</code></h2>
<p>é€šè¿‡ <code>winget</code> ä¸€é”®å®‰è£… <code>Oh My Posh</code> å³å¯</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">winget install JanDeDobbeleer.OhMyPosh -s winget</span><br></pre></td></tr></tbody></table></figure>
<h2 id="å®‰è£…-nerd-å­—ä½“">å®‰è£… Nerd å­—ä½“</h2>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cubmVyZGZvbnRzLmNvbS8=">Nerd å­—ä½“<i class="fa fa-external-link-alt"></i></span>
å…¶å®åªæ˜¯åœ¨åŸæœ¬çš„å¼€æºå­—ä½“ä¸Šå¢åŠ äº†ä¸€äº›å›¾æ ‡ï¼ˆåŒ…æ‹¬ PowerLine
æ‰€éœ€çš„ç¬¦å·ï¼‰ï¼Œè€Œ <code>Oh My Posh</code> ä¸­å¤§å¤šæ•°ä¸»ä½“éƒ½éœ€è¦ Nerd
å­—ä½“</p>
<p>ç›´æ¥åœ¨ <span class="exturl" data-url="aHR0cHM6Ly93d3cubmVyZGZvbnRzLmNvbS9mb250LWRvd25sb2Fkcw==">å®˜ç½‘<i class="fa fa-external-link-alt"></i></span>
æˆ–è€… <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3J5YW5vYXNpcy9uZXJkLWZvbnRzL3JlbGVhc2Vz">GitHub
çš„ Release<i class="fa fa-external-link-alt"></i></span> ä¸­ä¸‹è½½è‡ªå·±å¸¸ç”¨å­—ä½“çš„å‹ç¼©åŒ…ï¼Œè§£å‹åç›´æ¥æ‰“å¼€ ttf
æ–‡ä»¶å®‰è£…å³å¯</p>
<p>ä¸ªäººä¹ æƒ¯ç”¨ <code>Cascadia Code</code>ã€<code>FiraCode</code></p>
<p>å­—ä½“çš„å¯ç”¨ä¸ <code>Shell</code> çš„è¿è¡Œç¨‹åºç›¸å…³ï¼Œéœ€è¦åœ¨ VSCode æˆ–è€…
Windows Terminal åº”ç”¨ä¸­å•ç‹¬é…ç½®ï¼Œè¿™é‡Œä¸åšä»‹ç»</p>
<h2 id="å¯ç”¨-oh-my-posh">å¯ç”¨ <code>Oh My Posh</code></h2>
<p>å¯ç”¨ <code>Oh My Posh</code> éœ€è¦ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œé€šè¿‡ notepad
ç›´æ¥æ‰“å¼€é…ç½®æ–‡ä»¶</p>
<figure class="highlight powershell"><table><tbody><tr><td class="code"><pre><span class="line">notepad <span class="variable">$PROFILE</span></span><br></pre></td></tr></tbody></table></figure>
<blockquote>
<p>å¦‚æœæ‰“å¼€æŠ¥é”™ï¼Œåˆ™éœ€è¦é¦–å…ˆåˆ›å»ºé…ç½®æ–‡ä»¶</p>
<figure class="highlight powershell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">New-Item</span> <span class="literal">-Path</span> <span class="variable">$PROFILE</span> <span class="literal">-Type</span> File <span class="literal">-Force</span></span><br></pre></td></tr></tbody></table></figure>
</blockquote>
<p>åœ¨é…ç½®æ–‡ä»¶ä¸­æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼Œä»¥åå¯åŠ¨ <code>PowerShell</code>
å°±ä¼šè‡ªåŠ¨å¯ç”¨ <code>Oh My Posh</code> äº†</p>
<figure class="highlight powershell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">oh</span><span class="literal">-my-posh</span> init pwsh | <span class="built_in">Invoke-Expression</span></span><br></pre></td></tr></tbody></table></figure>
<h2 id="é€‰æ‹©ä¸»é¢˜">é€‰æ‹©ä¸»é¢˜</h2>
<p><code>Oh My Posh</code>
æ”¯æŒéå¸¸ä¸°å¯Œçš„ä¸»é¢˜ï¼Œè€Œä¸”åªéœ€ä¸€è¡Œå‘½ä»¤å°±å¯ä»¥ç›´æ¥åœ¨ <code>Shell</code>
é¢„è§ˆ</p>
<figure class="highlight powershell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">Get-PoshThemes</span></span><br></pre></td></tr></tbody></table></figure>
<p>ä¸ªäººé€‰æ‹©äº† <code>powerlevel10k_rainbow</code>
ä¸»é¢˜ï¼Œä¿®æ”¹ä¸»é¢˜éœ€è¦ä¿®æ”¹ä¹‹å‰çš„é…ç½®æ–‡ä»¶ï¼Œå°†ä¹‹å‰å†…å®¹è¿›è¡Œä¿®æ”¹å³å¯ï¼Œé…ç½®å®Œæˆåéœ€è¦é‡å¯ç»ˆç«¯ï½</p>
<figure class="highlight powershell"><table><tbody><tr><td class="code"><pre><span class="line">notepad <span class="variable">$PROFILE</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">oh</span><span class="literal">-my-posh</span> init pwsh <span class="literal">--config</span> <span class="string">"<span class="variable">$env:POSH_THEMES_PATH</span>/powerlevel10k_rainbow.omp.json"</span> | <span class="built_in">Invoke-Expression</span></span><br></pre></td></tr></tbody></table></figure>
<h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h2>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9vaG15cG9zaC5kZXYv">ã€ohmyposhã€‘Oh My Posh å®˜ç½‘<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0phbkRlRG9iYmVsZWVyL29oLW15LXBvc2g=">ã€GitHubã€‘Oh
My Posh ä»“åº“<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9sZWFybi5taWNyb3NvZnQuY29tL2VuLXVzL3Bvd2Vyc2hlbGwvc2NyaXB0aW5nL2luc3RhbGwvaW5zdGFsbGluZy1wb3dlcnNoZWxsLW9uLXdpbmRvd3M/dmlldz1wb3dlcnNoZWxsLTcuMw==">ã€Microsoftã€‘Installing
PowerShell on Windows<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9vaG15cG9zaC5kZXYvZG9jcy9pbnN0YWxsYXRpb24vd2luZG93cw==">ã€ohmyposhã€‘Installation-Windows<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9vaG15cG9zaC5kZXYvZG9jcy9pbnN0YWxsYXRpb24vZm9udHM=">ã€ohmyposhã€‘Fonts<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9vaG15cG9zaC5kZXYvZG9jcy9pbnN0YWxsYXRpb24vcHJvbXB0">ã€ohmyposhã€‘Prompt<i class="fa fa-external-link-alt"></i></span></li>
</ul>
]]></content>
      <categories>
        <category>Linux</category>
        <category>Shell</category>
      </categories>
      <tags>
        <tag>PowerShell</tag>
        <tag>Windows</tag>
      </tags>
  </entry>
  <entry>
    <title>ç¾åŒ– Shell ä¹‹ Linux Zsh ç¯‡</title>
    <url>/posts/f2cdf8a6.html</url>
    <content><![CDATA[<h2 id="ç®€ä»‹">ç®€ä»‹</h2>
<p><code>Z shellï¼ˆZshï¼‰</code>æ˜¯ä¸€æ¬¾å¯ç”¨ä½œäº’åŠ¨å¼ç™»å…¥çš„ shell åŠæŒ‡ä»¤ç ç¼–å†™çš„å‘½ä»¤ç›´è¯‘å™¨ã€‚
<code>Zsh</code> å¯¹ Linux é»˜è®¤çš„
<code>Bourne shellï¼ˆshï¼‰</code>åšå‡ºäº†å¤§é‡æ”¹è¿›ï¼ŒåŒæ—¶åŠ å…¥äº†
<code>Bash</code>ã€<code>ksh</code> åŠ <code>tcsh</code> çš„æŸäº›åŠŸèƒ½ã€‚
å¹¶ä¸”è‡ª 2019 å¹´èµ·ï¼ŒmacOS çš„é¢„è®¾ <code>Shell</code> å·²ä» <code>Bash</code>
æ”¹ä¸º <code>Zsh</code></p>
<p>ä¸ºäº†ç¾åŒ–ä»¥åŠå¿«é€Ÿé…ç½® <code>Zsh</code>ï¼Œ<code>Oh My Zsh</code>
åº”è¿è€Œç”Ÿã€‚ <code>Oh My Zsh</code>
æ˜¯ä¸€ä¸ªå¼€æºçš„ã€ç¤¾åŒºé©±åŠ¨çš„æ¡†æ¶ï¼Œæ”¯æŒå„ç§æ’ä»¶ä»¥åŠä¸»é¢˜ï¼Œåœ¨ç®¡ç†
<code>Zsh</code> é…ç½®æä¾›äº†å¾ˆå¤§çš„ä¾¿åˆ©</p>
<p>æœ¬æ–‡ä¸»è¦è®°å½•è‡ªå·±çš„ <code>Oh My Zsh</code> å®‰è£…ä»¥åŠé…ç½®æµç¨‹
<span id="more"></span></p>
<h2 id="å®‰è£…-zsh">å®‰è£… <code>Zsh</code></h2>
<p>å¦‚æœæ²¡æœ‰å®‰è£… <code>Zsh</code> åˆ™éœ€è¦æ‰‹åŠ¨å®‰è£…ä¸€ä¸‹ï¼Œä»¥ Ubuntu
ä¸ºä¾‹ï¼š</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt install zsh</span><br></pre></td></tr></tbody></table></figure>
<p>é…ç½® Zsh ä¸ºé»˜è®¤ Shell</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">chsh -s $(<span class="built_in">which</span> zsh)</span><br></pre></td></tr></tbody></table></figure>
<h2 id="å®‰è£…-oh-my-zsh">å®‰è£… <code>Oh My Zsh</code></h2>
<p>é€šè¿‡ <code>curl</code> æˆ–è€… <code>wget</code> ä¸‹è½½å®‰è£…è„šæœ¬ä¸€é”®å®‰è£…
<code>Oh My Zsh</code> å³å¯</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># curl</span></span><br><span class="line">sh -c <span class="string">"<span class="subst">$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)</span>"</span></span><br><span class="line"><span class="comment"># wget</span></span><br><span class="line">sh -c <span class="string">"<span class="subst">$(wget -O- https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)</span>"</span></span><br></pre></td></tr></tbody></table></figure>
<p>ç±»ä¼¼äº <code>bash</code> çš„é…ç½®æ–‡ä»¶ <code>~/.bashrc</code>
å‘½åè§„åˆ™ç±»ä¼¼ï¼Œ<code>Zsh</code> çš„é…ç½®æ–‡ä»¶æ˜¯
<code>~/.zshrc</code>ï¼Œåç»­é…ç½®åªéœ€å¯¹è¯¥é…ç½®æ–‡ä»¶è¿›è¡Œå°å°çš„ä¿®æ”¹å³å¯</p>
<h2 id="ä¸»é¢˜é…ç½®">ä¸»é¢˜é…ç½®</h2>
<p><code>Oh My Zsh</code> æ”¯æŒéå¸¸ä¸°å¯Œçš„ä¸»é¢˜ï¼Œ<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL29obXl6c2gvb2hteXpzaC93aWtpL1RoZW1lcw==">å®˜æ–¹<i class="fa fa-external-link-alt"></i></span>
ç»™å‡ºäº†å†…ç½®çš„æ‰€æœ‰ä¸»é¢˜çš„é¢„è§ˆå›¾</p>
<p>éƒ¨åˆ†ä¸»é¢˜éœ€è¦é¢å¤– <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3Bvd2VybGluZS9mb250cw==">PL
å­—ä½“<i class="fa fa-external-link-alt"></i></span> ä»¥åŠ <span class="exturl" data-url="aHR0cHM6Ly93d3cubmVyZGZvbnRzLmNvbS8=">Nerd å­—ä½“<i class="fa fa-external-link-alt"></i></span>
æ”¯æŒï¼Œå‚è§ <a href="/posts/8ad4716e.html#å®‰è£…%20Nerd%20å­—ä½“">å®‰è£… Nerd
å­—ä½“</a></p>
<p>ç”±äºåœ¨ <a href="/posts/8ad4716e.html"><code>Oh My Posh</code></a>
ä¸­ç”¨ä¹ æƒ¯äº† <code>powerlevel10k</code>ï¼Œå¹¶ä¸” <code>powerlevel10k</code>
ä¹Ÿæ”¯æŒ <code>Oh My Zsh</code>ï¼Œäºæ˜¯åæ¥åˆé¢å¤–å®‰è£…äº†
<code>powerlevel10k</code> ä¸»é¢˜</p>
<p>å®‰è£…æµç¨‹ä¹Ÿå¾ˆæ–¹ä¾¿ï¼Œç›´æ¥ä» GitHub æ‹‰å–ä»“åº“ï¼Œç„¶åä¿®æ”¹é…ç½®æ–‡ä»¶å³å¯</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> --depth=1 https://github.com/romkatv/powerlevel10k.git <span class="variable">${ZSH_CUSTOM:-<span class="variable">$HOME</span>/.oh-my-zsh/custom}</span>/themes/powerlevel10k</span><br><span class="line"></span><br><span class="line">vim ~/.zshrc</span><br><span class="line"></span><br><span class="line">ZSH_THEME=<span class="string">"powerlevel10k/powerlevel10k"</span></span><br></pre></td></tr></tbody></table></figure>
<p>ä¹‹åé‡å¯ç»ˆç«¯åï¼Œ<code>powerlevel10k</code>
ä¼šè¿›å…¥å¼•å¯¼æµç¨‹ï¼Œå¯ä»¥è‡ªè¡Œå¾®è°ƒé£æ ¼</p>
<h2 id="æ’ä»¶å®‰è£…">æ’ä»¶å®‰è£…</h2>
<p><code>Oh My Zsh</code> é»˜è®¤ä¼šå¼€å¯ <code>git</code>
æ’ä»¶ï¼Œé™¤æ­¤ä¹‹å¤–ä¸ªäººè¿˜é¢å¤–å®‰è£…äº† <code>zsh-autosuggestions</code> ä»¥åŠ
<code>zsh-syntax-highlighting</code> æ’ä»¶</p>
<h3 id="zsh-autosuggestions"><code>zsh-autosuggestions</code></h3>
<p><code>zsh-autosuggestions</code> å¼€å¯åï¼Œ<code>Zsh</code>
ä¼šæ ¹æ®å†å²è®°å½•å’Œå®Œæˆæƒ…å†µåœ¨æ‚¨é”®å…¥æ—¶å»ºè®®å‘½ä»¤ï¼Œä¹Ÿå°±æ˜¯æ ¹æ®å†å²è®°å½•å¿«é€Ÿè¡¥å…¨å‘½ä»¤ï¼Œéå¸¸çš„å¥½ç”¨ï¼ï¼ï¼</p>
<p>å®‰è£…èµ·æ¥ä¹Ÿéå¸¸ç®€å•ï¼Œç›´æ¥ <code>git clone</code> å³å¯</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/zsh-users/zsh-autosuggestions <span class="variable">${ZSH_CUSTOM:-~/.oh-my-zsh/custom}</span>/plugins/zsh-autosuggestions</span><br><span class="line"><span class="comment"># git clone git@github.com:zsh-users/zsh-autosuggestions.git ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-autosuggestions</span></span><br></pre></td></tr></tbody></table></figure>
<p>ä¹‹åä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œåœ¨ <code>plugins</code> ä¸­åŠ å…¥
<code>zsh-autosuggestions</code> å³å¯</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">vim ~/.zshrc</span><br><span class="line"></span><br><span class="line">plugins=(git zsh-autosuggestions)</span><br></pre></td></tr></tbody></table></figure>
<h3 id="zsh-syntax-highlighting"><code>zsh-syntax-highlighting</code></h3>
<p><code>zsh-syntax-highlighting</code>
å¼€å¯åï¼Œåœ¨è¾“å…¥å‘½ä»¤æ—¶å°±æœ‰äº†è¯­æ³•é«˜äº®ï¼Œæå‡æ•´ä½“é¢œå€¼çš„åŒæ—¶ï¼Œè¿˜èƒ½è¾…åŠ©æ£€æŸ¥å‘½ä»¤æ˜¯å¦æ‰“é”™ï¼Œå®‰è£…è¿‡ç¨‹ç±»ä¼¼</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/zsh-users/zsh-syntax-highlighting <span class="variable">${ZSH_CUSTOM:-~/.oh-my-zsh/custom}</span>/plugins/zsh-syntax-highlighting</span><br><span class="line"><span class="comment"># git clone git@github.com:zsh-users/zsh-syntax-highlighting.git ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-syntax-highlighting</span></span><br></pre></td></tr></tbody></table></figure>
<p>ä¹‹åä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œåœ¨ <code>plugins</code> ä¸­åŠ å…¥
<code>zsh-syntax-highlighting</code> å³å¯</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">vim ~/.zshrc</span><br><span class="line"></span><br><span class="line">plugins=(git zsh-autosuggestions zsh-syntax-highlighting)</span><br></pre></td></tr></tbody></table></figure>
<h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h2>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3poLWhrL1pfc2hlbGw=">ã€ç»´åŸºç™¾ç§‘ã€‘Z
shell<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9vaG15ei5zaC8=">ã€ohmyzã€‘Oh My Zsh å®˜ç½‘<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL29obXl6c2gvb2hteXpzaA==">ã€GitHubã€‘Oh My Zsh
ä»“åº“<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL29obXl6c2gvb2hteXpzaC93aWtpL0luc3RhbGxpbmctWlNI">ã€GitHubã€‘Installing
ZSH<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL29obXl6c2gvb2hteXpzaC93aWtpL1RoZW1lcw==">ã€GitHubã€‘Themes<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3pzaC11c2Vycy96c2gtYXV0b3N1Z2dlc3Rpb25z">ã€GitHubã€‘zsh-autosuggestions<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3pzaC11c2Vycy96c2gtc3ludGF4LWhpZ2hsaWdodGluZw==">ã€GitHubã€‘zsh-syntax-highlighting<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC82MjUwMTE3NQ==">ã€Zhihuã€‘oh-my-zshï¼šè®©ç»ˆç«¯é£<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3JvbWthdHYvcG93ZXJsZXZlbDEwayNpbnN0YWxsYXRpb24=">ã€GitHubã€‘Powerlevel10k<i class="fa fa-external-link-alt"></i></span></li>
</ul>
]]></content>
      <categories>
        <category>Linux</category>
        <category>Shell</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>Zsh</tag>
      </tags>
  </entry>
  <entry>
    <title>page cache å›å†™æœºåˆ¶</title>
    <url>/posts/646202b9.html</url>
    <content><![CDATA[<p>å½“å‰å†…å®¹åŸºäº Linux Kernel <span class="exturl" data-url="aHR0cHM6Ly9naXQua2VybmVsLm9yZy9wdWIvc2NtL2xpbnV4L2tlcm5lbC9naXQvc3RhYmxlL2xpbnV4LmdpdC90YWcvP2g9djUuNC4xMjE=">v5.4.121<i class="fa fa-external-link-alt"></i></span></p>
<h2 id="writeback-å›å†™">writeback å›å†™</h2>
<p>åœ¨ <a href="/posts/9ba60726">page cache ç®€ä»‹</a> æœ‰è¿‡ä»‹ç»</p>
<p>buffer IO é€šè¿‡ page cache
è¿›è¡Œç¼“å­˜ï¼Œå‡å°‘å¯¹åº•å±‚å­˜å‚¨è®¾å¤‡çš„ç›´æ¥è¯»å†™ï¼ŒåŒæ—¶èƒ½å¤Ÿæé«˜æ•´ä½“æ€§èƒ½</p>
<p>å†™å…¥åˆ° page cache
çš„æ•°æ®ä¸ä¼šç«‹åˆ»å†™å…¥åç«¯è®¾å¤‡ï¼Œè€Œæ˜¯æ ‡è®°ä¸º â€œè„â€ï¼Œå¹¶è¢«åŠ å…¥åˆ°è„é¡µé“¾è¡¨ï¼Œåç»­ç”±å†…æ ¸ä¸­çš„å›å†™è¿›ç¨‹å‘¨æœŸæ€§çš„å°†è„é¡µå†™å›åˆ°åº•å±‚å­˜å‚¨è®¾å¤‡</p>
<p>ä¸‹é¢ä¸»è¦åˆ†æ page cache å›å†™æœºåˆ¶çš„ç­–ç•¥å’Œå®ç° <span id="more"></span></p>
<h2 id="ç›¸å…³ç»“æ„ä½“">ç›¸å…³ç»“æ„ä½“</h2>
<h3 id="åº•å±‚è®¾å¤‡ä¿¡æ¯">åº•å±‚è®¾å¤‡ä¿¡æ¯</h3>
<p>åœ¨ <code>include/linux/backing-dev-defs.h</code> ä¸­å®šä¹‰äº†
<code>backing_dev_info</code> ç»“æ„ä½“ï¼Œä¸»è¦ç”¨ä¸è®°å½•åº•å±‚çš„è®¾å¤‡ä¿¡æ¯</p>
<figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">backing_dev_info</span> {</span></span><br><span class="line">	u64 id;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rb_node</span> <span class="title">rb_node</span>;</span> <span class="comment">/* keyed by -&gt;id */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">bdi_list</span>;</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> ra_pages;	<span class="comment">/* max readahead in PAGE_SIZE units */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> io_pages;	<span class="comment">/* max allowed IO size */</span></span><br><span class="line">	congested_fn *congested_fn; <span class="comment">/* Function pointer if device is md/dm */</span></span><br><span class="line">	<span class="type">void</span> *congested_data;	<span class="comment">/* Pointer to aux data for congested func */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// é€šå¸¸ä¸º "block"</span></span><br><span class="line">	<span class="type">const</span> <span class="type">char</span> *name;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kref</span> <span class="title">refcnt</span>;</span>	<span class="comment">/* Reference counter for the structure */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> capabilities; <span class="comment">/* Device capabilities */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> min_ratio;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> max_ratio, max_prop_frac;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Sum of avg_write_bw of wbs with dirty inodes.  &gt; 0 if there are</span></span><br><span class="line"><span class="comment">	 * any dirty wbs, which is depended upon by bdi_has_dirty().</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="type">atomic_long_t</span> tot_write_bandwidth;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">bdi_writeback</span> <span class="title">wb</span>;</span>  <span class="comment">/* the root writeback info for this bdi */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">wb_list</span>;</span> <span class="comment">/* list of all wbs */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_CGROUP_WRITEBACK</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">radix_tree_root</span> <span class="title">cgwb_tree</span>;</span> <span class="comment">/* radix tree of active cgroup wbs */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rb_root</span> <span class="title">cgwb_congested_tree</span>;</span> <span class="comment">/* their congested states */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">cgwb_release_mutex</span>;</span>  <span class="comment">/* protect shutdown of wb structs */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rw_semaphore</span> <span class="title">wb_switch_rwsem</span>;</span> <span class="comment">/* no cgwb switch while syncing */</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">bdi_writeback_congested</span> *<span class="title">wb_congested</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="type">wait_queue_head_t</span> wb_waitq;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// bdi_class è®¾å¤‡</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">dev</span>;</span></span><br><span class="line">	<span class="comment">// ä¸»è®¾å¤‡å·:æ¬¡è®¾å¤‡å·</span></span><br><span class="line">	<span class="type">char</span> dev_name[<span class="number">64</span>];</span><br><span class="line">	<span class="comment">// å®é™…çš„åº•å±‚è®¾å¤‡</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">owner</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">timer_list</span> <span class="title">laptop_mode_wb_timer</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_DEBUG_FS</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> *<span class="title">debug_dir</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>
<h4 id="åˆå§‹åŒ–">åˆå§‹åŒ–</h4>
<p>è¯¥ç»“æ„ä½“åªä¼šç”± <code>mm/backing-dev.c</code> ä¸­çš„
<code>bdi_alloc_node</code> å‡½æ•°æ¥ç”³è¯·å†…å­˜ç©ºé—´å¹¶è°ƒç”¨
<code>bdi_init</code> åˆå§‹åŒ–</p>
<h4 id="éƒ¨åˆ†å­—æ®µè¯´æ˜">éƒ¨åˆ†å­—æ®µè¯´æ˜</h4>
<ol type="1">
<li><p><code>name</code> å­—æ®µ</p>
<figure>
<img data-src="/posts/646202b9/bdi_name.png" alt="name å­—æ®µ">
<figcaption aria-hidden="true">name å­—æ®µ</figcaption>
</figure>
<p>åœ¨ <code>block/blk-core.c</code> ä¸­ <code>blk_alloc_queue_node</code>
ä¼šè°ƒç”¨ <code>bdi_alloc_node</code> æ¥åˆå§‹åŒ–è¯¥ç»“æ„ä½“ï¼Œå…¶ä¸­
<code>name</code> å­—æ®µèµ‹å€¼ä¸º <code>"block"</code></p></li>
<li><p><code>dev</code> å­—æ®µ</p>
<p>åœ¨ <code>mm/backing-dev.c</code> çš„ <code>bdi_register_va</code>
ä¼šè°ƒç”¨ <code>device_create</code> åˆ›å»ºä¸€ä¸ª <code>bdi_class</code>
ç±»å‹çš„è®¾å¤‡ï¼Œå¹¶èµ‹å€¼ç»™ <code>dev</code> å­—æ®µ</p></li>
<li><p><code>dev_name</code> å­—æ®µ</p>
<p>åœ¨ <code>mm/backing-dev.c</code> çš„ <code>bdi_register_va</code>
è¿˜ä¼šå¯¹ <code>dev_name</code> è¿›è¡Œèµ‹å€¼</p>
<figure>
<img data-src="/posts/646202b9/bdi_dev_name.png" alt="dev_name å­—æ®µ">
<figcaption aria-hidden="true">dev_name å­—æ®µ</figcaption>
</figure>
<p>æ ¹æ®è°ƒç”¨æ ˆæº¯æºå¯ä»¥å‘ç°ï¼Œ<code>mm/backing-dev.c</code> çš„
<code>bdi_register_owner</code> å°† <code>fmt</code> å’Œ <code>args</code>
ä¼ é€’åˆ°
<code>bdi_register_va</code>ï¼Œæœ€ç»ˆä¼šå°†ä¸»è®¾å¤‡å·å’Œæ¬¡è®¾å¤‡å·æ‹¼æ¥ç»„åˆåè¿›è¡Œèµ‹å€¼</p></li>
<li><p><code>owner</code> å­—æ®µ</p>
<p>åœ¨ <code>mm/backing-dev.c</code> çš„ <code>bdi_register_owner</code>
è¿˜ä¼šå¯¹ <code>owner</code> è¿›è¡Œèµ‹å€¼</p>
<figure>
<img data-src="/posts/646202b9/bdi_owner.png" alt="owner å­—æ®µ">
<figcaption aria-hidden="true">owner å­—æ®µ</figcaption>
</figure>
<p>å®é™…èµ‹å€¼çš„ä¸º <code>disk</code> å¯¹åº”çš„ <code>dev</code>ï¼Œé€šè¿‡
<code>disk_to_dev</code> å®è½¬æ¢å¾—åˆ°</p></li>
</ol>
<h3 id="è®¾å¤‡å›å†™ç®¡ç†">è®¾å¤‡å›å†™ç®¡ç†</h3>
<p>åœ¨ <code>include/linux/backing-dev-defs.h</code> ä¸­å®šä¹‰äº†
<code>bdi_writeback</code> ç»“æ„ä½“ï¼Œç”¨äºç®¡ç†ä¸€ä¸ªå—è®¾å¤‡çš„å›å†™ï¼ŒåŒæ—¶æ”¯æŒ
<code>cgroup</code> è¿›è¡Œé™åˆ¶</p>
<figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Each wb (bdi_writeback) can perform writeback operations, is measured</span></span><br><span class="line"><span class="comment"> * and throttled, independently.  Without cgroup writeback, each bdi</span></span><br><span class="line"><span class="comment"> * (bdi_writeback) is served by its embedded bdi-&gt;wb.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * On the default hierarchy, blkcg implicitly enables memcg.  This allows</span></span><br><span class="line"><span class="comment"> * using memcg's page ownership for attributing writeback IOs, and every</span></span><br><span class="line"><span class="comment"> * memcg - blkcg combination can be served by its own wb by assigning a</span></span><br><span class="line"><span class="comment"> * dedicated wb to each memcg, which enables isolation across different</span></span><br><span class="line"><span class="comment"> * cgroups and propagation of IO back pressure down from the IO layer upto</span></span><br><span class="line"><span class="comment"> * the tasks which are generating the dirty pages to be written back.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * A cgroup wb is indexed on its bdi by the ID of the associated memcg,</span></span><br><span class="line"><span class="comment"> * refcounted with the number of inodes attached to it, and pins the memcg</span></span><br><span class="line"><span class="comment"> * and the corresponding blkcg.  As the corresponding blkcg for a memcg may</span></span><br><span class="line"><span class="comment"> * change as blkcg is disabled and enabled higher up in the hierarchy, a wb</span></span><br><span class="line"><span class="comment"> * is tested for blkcg after lookup and removed from index on mismatch so</span></span><br><span class="line"><span class="comment"> * that a new wb for the combination can be created.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bdi_writeback</span> {</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">backing_dev_info</span> *<span class="title">bdi</span>;</span>	<span class="comment">/* our parent bdi */</span></span><br><span class="line"></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> state;		<span class="comment">/* Always use atomic bitops on this */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> last_old_flush;	<span class="comment">/* last old data flush */</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">b_dirty</span>;</span>	<span class="comment">/* dirty inodes */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">b_io</span>;</span>		<span class="comment">/* parked for writeback */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">b_more_io</span>;</span>	<span class="comment">/* parked for more writeback */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">b_dirty_time</span>;</span>	<span class="comment">/* time stamps are dirty */</span></span><br><span class="line">	<span class="type">spinlock_t</span> list_lock;		<span class="comment">/* protects the b_* lists */</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">percpu_counter</span> <span class="title">stat</span>[<span class="title">NR_WB_STAT_ITEMS</span>];</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">bdi_writeback_congested</span> *<span class="title">congested</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> bw_time_stamp;	<span class="comment">/* last time write bw is updated */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> dirtied_stamp;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> written_stamp;	<span class="comment">/* pages written at bw_time_stamp */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> write_bandwidth;	<span class="comment">/* the estimated write bandwidth */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> avg_write_bandwidth; <span class="comment">/* further smoothed write bw, &gt; 0 */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * The base dirty throttle rate, re-calculated on every 200ms.</span></span><br><span class="line"><span class="comment">	 * All the bdi tasks' dirty rate will be curbed under it.</span></span><br><span class="line"><span class="comment">	 * @dirty_ratelimit tracks the estimated @balanced_dirty_ratelimit</span></span><br><span class="line"><span class="comment">	 * in small steps and is much more smooth/stable than the latter.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> dirty_ratelimit;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> balanced_dirty_ratelimit;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fprop_local_percpu</span> <span class="title">completions</span>;</span></span><br><span class="line">	<span class="type">int</span> dirty_exceeded;</span><br><span class="line">	<span class="class"><span class="keyword">enum</span> <span class="title">wb_reason</span> <span class="title">start_all_reason</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="type">spinlock_t</span> work_lock;		<span class="comment">/* protects work_list &amp; dwork scheduling */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">work_list</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">delayed_work</span> <span class="title">dwork</span>;</span>	<span class="comment">/* work item used for writeback */</span></span><br><span class="line"></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> dirty_sleep;	<span class="comment">/* last wait */</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">bdi_node</span>;</span>	<span class="comment">/* anchored at bdi-&gt;wb_list */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_CGROUP_WRITEBACK</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">percpu_ref</span> <span class="title">refcnt</span>;</span>	<span class="comment">/* used only for !root wb's */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fprop_local_percpu</span> <span class="title">memcg_completions</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">cgroup_subsys_state</span> *<span class="title">memcg_css</span>;</span> <span class="comment">/* the associated memcg */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">cgroup_subsys_state</span> *<span class="title">blkcg_css</span>;</span> <span class="comment">/* and blkcg */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">memcg_node</span>;</span>	<span class="comment">/* anchored at memcg-&gt;cgwb_list */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">blkcg_node</span>;</span>	<span class="comment">/* anchored at blkcg-&gt;cgwb_list */</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">union</span> {</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">work_struct</span> <span class="title">release_work</span>;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span> <span class="title">rcu</span>;</span></span><br><span class="line">	};</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>
<h4 id="åˆå§‹åŒ–-1">åˆå§‹åŒ–</h4>
<p>è¯¥ç»“æ„ä½“ç”± <code>mm/backing-dev.c</code> ä¸­çš„ <code>wb_init</code>
å‡½æ•°åˆå§‹åŒ–</p>
<pre class="mermaid">graph TD
bdi_init --&gt; cgwb_bdi_init --&gt; wb_init</pre>
<h4 id="éƒ¨åˆ†å­—æ®µè¯´æ˜-1">éƒ¨åˆ†å­—æ®µè¯´æ˜</h4>
<ol type="1">
<li><p><code>b_dirty</code> å­—æ®µ</p>
<p>æš‚å­˜æ‰€æœ‰çš„è„ inode çš„é“¾è¡¨</p></li>
<li><p><code>b_io</code> å­—æ®µ</p>
<p>æš‚å­˜å³å°†å›å†™çš„ inode çš„é“¾è¡¨</p></li>
<li><p><code>b_more_io</code> å­—æ®µ</p>
<p>æš‚å­˜ç”±äºä¸€æ¬¡å›å†™æ•°é‡é™åˆ¶åŸå› å¯¼è‡´çš„ç­‰å¾…ä¸‹æ¬¡å›å†™çš„ inode é“¾è¡¨</p></li>
<li><p><code>b_dirty_time</code> å­—æ®µ</p>
<p>æš‚å­˜ä»…ä»…æ˜¯æ—¶é—´æˆ³æ›´æ–°è€Œè¢«è‡³è„çš„ inode çš„é“¾è¡¨</p></li>
<li><p><code>list_lock</code> å­—æ®µ</p>
<p>ä¸ºäº†ä¿æŠ¤ä¸Šè¿° 4 ä¸ª <code>b_*</code> åˆ—è¡¨çš„è‡ªæ—‹é”</p></li>
<li><p><code>dwork</code> å­—æ®µ</p>
<p>ç”¨äº page cache å›å†™æœºåˆ¶çš„ <code>work</code> å…³é”®ç»“æ„ä½“</p></li>
<li><p><code>work_list</code> å­—æ®µ</p>
<p>æš‚å­˜æ‰€æœ‰éœ€è¦å›å†™çš„ä»»åŠ¡çš„é“¾è¡¨</p></li>
<li><p><code>work_lock</code> å­—æ®µ</p>
<p>ä¸ºäº†ä¿æŠ¤ <code>work_list</code> ä»¥åŠ <code>dwork</code>
è°ƒåº¦çš„è‡ªæ—‹é”</p></li>
</ol>
<h3 id="å›å†™ä»»åŠ¡">å›å†™ä»»åŠ¡</h3>
<p>åœ¨ <code>fs/fs-writeback.c</code> ä¸­å®šä¹‰äº†
<code>wb_writeback_work</code>
ç»“æ„ä½“ï¼Œç”¨äºæè¿°ä¸€æ¬¡å›å†™ä»»åŠ¡çš„ç›¸å…³å‚æ•°</p>
<figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Passed into wb_writeback(), essentially a subset of writeback_control</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">wb_writeback_work</span> {</span></span><br><span class="line">	<span class="comment">// æœ¬æ¬¡å›å†™çš„é¡µæ•°é™åˆ¶</span></span><br><span class="line">	<span class="type">long</span> nr_pages;</span><br><span class="line">	<span class="comment">// å›å†™çš„æ–‡ä»¶ç³»ç»Ÿçš„è¶…çº§å—</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">super_block</span> *<span class="title">sb</span>;</span></span><br><span class="line">	<span class="comment">// å›å†™çš„æ¨¡å¼</span></span><br><span class="line">	<span class="class"><span class="keyword">enum</span> <span class="title">writeback_sync_modes</span> <span class="title">sync_mode</span>;</span></span><br><span class="line">	<span class="comment">// tag-and-write æœºåˆ¶æ ‡è®°</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> tagged_writepages:<span class="number">1</span>;</span><br><span class="line">	<span class="comment">// å®šæœŸå›å†™æ ‡è®°</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> for_kupdate:<span class="number">1</span>;</span><br><span class="line">	<span class="comment">// ç»§ç»­ä¸Šæ¬¡å¾ªç¯å›å†™æ ‡è®°</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> range_cyclic:<span class="number">1</span>;</span><br><span class="line">	<span class="comment">// é˜ˆå€¼å›å†™æ ‡è®°</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> for_background:<span class="number">1</span>;</span><br><span class="line">	<span class="comment">// sync ç³»ç»Ÿè°ƒç”¨æ ‡è®°</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> for_sync:<span class="number">1</span>;	<span class="comment">/* sync(2) WB_SYNC_ALL writeback */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> auto_free:<span class="number">1</span>;	<span class="comment">/* free on completion */</span></span><br><span class="line">	<span class="class"><span class="keyword">enum</span> <span class="title">wb_reason</span> <span class="title">reason</span>;</span>		<span class="comment">/* why was writeback initiated? */</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span>		<span class="comment">/* pending work list */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">wb_completion</span> *<span class="title">done</span>;</span>	<span class="comment">/* set if the caller waits */</span></span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>
<p>åç»­é€šè¿‡ <code>include/linux/writeback.h</code> ä¸­çš„
<code>writeback_control</code> ç»“æ„ä½“å°è£…ï¼Œä¼ é€’ç»™åº•å±‚çš„
<code>writepages</code> å‡½æ•°</p>
<figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * A control structure which tells the writeback code what to do.  These are</span></span><br><span class="line"><span class="comment"> * always on the stack, and hence need no locking.  They are always initialised</span></span><br><span class="line"><span class="comment"> * in a manner such that unspecified fields are set to zero.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">writeback_control</span> {</span></span><br><span class="line">	<span class="type">long</span> nr_to_write;		<span class="comment">/* Write this many pages, and decrement</span></span><br><span class="line"><span class="comment">					   this for each page written */</span></span><br><span class="line">	<span class="type">long</span> pages_skipped;		<span class="comment">/* Pages which were not written */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * For a_ops-&gt;writepages(): if start or end are non-zero then this is</span></span><br><span class="line"><span class="comment">	 * a hint that the filesystem need only write out the pages inside that</span></span><br><span class="line"><span class="comment">	 * byterange.  The byte at `end' is included in the writeout request.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="type">loff_t</span> range_start;</span><br><span class="line">	<span class="type">loff_t</span> range_end;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">enum</span> <span class="title">writeback_sync_modes</span> <span class="title">sync_mode</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="type">unsigned</span> for_kupdate:<span class="number">1</span>;		<span class="comment">/* A kupdate writeback */</span></span><br><span class="line">	<span class="type">unsigned</span> for_background:<span class="number">1</span>;	<span class="comment">/* A background writeback */</span></span><br><span class="line">	<span class="type">unsigned</span> tagged_writepages:<span class="number">1</span>;	<span class="comment">/* tag-and-write to avoid livelock */</span></span><br><span class="line">	<span class="type">unsigned</span> for_reclaim:<span class="number">1</span>;		<span class="comment">/* Invoked from the page allocator */</span></span><br><span class="line">	<span class="type">unsigned</span> range_cyclic:<span class="number">1</span>;	<span class="comment">/* range_start is cyclic */</span></span><br><span class="line">	<span class="type">unsigned</span> for_sync:<span class="number">1</span>;		<span class="comment">/* sync(2) WB_SYNC_ALL writeback */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * When writeback IOs are bounced through async layers, only the</span></span><br><span class="line"><span class="comment">	 * initial synchronous phase should be accounted towards inode</span></span><br><span class="line"><span class="comment">	 * cgroup ownership arbitration to avoid confusion.  Later stages</span></span><br><span class="line"><span class="comment">	 * can set the following flag to disable the accounting.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="type">unsigned</span> no_cgroup_owner:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="type">unsigned</span> punt_to_cgroup:<span class="number">1</span>;	<span class="comment">/* cgrp punting, see __REQ_CGROUP_PUNT */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_CGROUP_WRITEBACK</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">bdi_writeback</span> *<span class="title">wb</span>;</span>	<span class="comment">/* wb this writeback is issued under */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *<span class="title">inode</span>;</span>		<span class="comment">/* inode being written out */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* foreign inode detection, see wbc_detach_inode() */</span></span><br><span class="line">	<span class="type">int</span> wb_id;			<span class="comment">/* current wb id */</span></span><br><span class="line">	<span class="type">int</span> wb_lcand_id;		<span class="comment">/* last foreign candidate wb id */</span></span><br><span class="line">	<span class="type">int</span> wb_tcand_id;		<span class="comment">/* this foreign candidate wb id */</span></span><br><span class="line">	<span class="type">size_t</span> wb_bytes;		<span class="comment">/* bytes written by current wb */</span></span><br><span class="line">	<span class="type">size_t</span> wb_lcand_bytes;		<span class="comment">/* bytes written by last candidate */</span></span><br><span class="line">	<span class="type">size_t</span> wb_tcand_bytes;		<span class="comment">/* bytes written by this candidate */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>
<h4 id="éƒ¨åˆ†å­—æ®µè¯´æ˜-2">éƒ¨åˆ†å­—æ®µè¯´æ˜</h4>
<ol type="1">
<li><p><code>sync_mode</code> å­—æ®µ</p>
<p><code>WB_SYNC_NONE</code>ï¼šç»å¤§éƒ¨åˆ†å›å†™ä»»åŠ¡çš„é…ç½®ï¼Œä¸ä¼šç­‰å¾…å›å†™çœŸæ­£è½ç›˜ï¼Œä¸‹å‘å†™å‘½ä»¤åå°±è¿”å›</p>
<p><code>WB_SYNC_ALL</code>ï¼š<code>sync</code>
ç³»ç»Ÿè°ƒç”¨æ—¶é…ç½®ï¼Œå¿…é¡»ç­‰å¾…å›è°ƒå‡½æ•°æ‰§è¡Œå®Œæˆï¼Œå†™çš„æ•°æ®çœŸæ­£è½ç›˜ä¹‹åæ‰ä¼šè¿”å›</p></li>
<li><p><code>tagged_writepages</code> å­—æ®µ</p>
<p>å€¼ä¸º 1 è¡¨ç¤ºå¼€å¯ <code>tag-and-write</code>
æœºåˆ¶ç”¨äºé¿å…æ´»é”ã€‚è¯¥æœºåˆ¶è¯¦æƒ…å‚è€ƒ <a href="#tag-and-write">åç»­å°èŠ‚</a></p></li>
<li><p><code>for_kupdate</code> å­—æ®µ</p>
<p>å€¼ä¸º 1
è¡¨ç¤ºå½“å‰ä»»åŠ¡æ˜¯å®šæœŸå›å†™ä»»åŠ¡ï¼Œç”¨äºå›å†™å·²ç»è‡³è„è¶…è¿‡æŒ‡å®šæ—¶é—´ï¼ˆå†…æ ¸ä¸­å½“å‰é…ç½®ä¸º
30sï¼‰çš„è„é¡µã€‚å®šæœŸå›å†™è¯¦æƒ…å‚è€ƒ <a href="#å®šæœŸå›å†™">åç»­å°èŠ‚</a></p></li>
<li><p><code>range_cyclic</code> å­—æ®µ</p>
<p>å€¼ä¸º 1 è¡¨ç¤ºå½“å‰ä»»åŠ¡çš„å›å†™èŒƒå›´ä¸ºæ•´ä¸ª
<code>inode</code>ï¼Œå¹¶ä¸”ä»ä¸Šæ¬¡å®Œæˆçš„ä½ç½®ä½œä¸ºèµ·å§‹ä½ç½®è¿›è¡Œå¾ªç¯å›å†™ã€‚å€¼ä¸º 0
åˆ™æ ¹æ® <code>struct writeback_control wbc</code> çš„
<code>range_start</code> ä»¥åŠ <code>range_end</code>
ä½œä¸ºå›å†™çš„èŒƒå›´ã€‚<code>range_cyclic</code> çš„è¯¦æƒ…å‚è€ƒ <a href="#range_cyclic">åç»­å°èŠ‚</a></p></li>
<li><p><code>for_background</code> å­—æ®µ</p>
<p>å€¼ä¸º 1
è¡¨ç¤ºå½“å‰ä»»åŠ¡æ˜¯é˜ˆå€¼å›å†™ä»»åŠ¡ï¼Œå½“è„é¡µæ¯”ä¾‹è¶…è¿‡é˜ˆå€¼åæ‰ä¼šè§¦å‘ã€‚é˜ˆå€¼å›å†™è¯¦æƒ…å‚è€ƒ
<a href="#é˜ˆå€¼å›å†™">åç»­å°èŠ‚</a></p></li>
<li><p><code>for_sync</code> å­—æ®µ</p>
<p>å€¼ä¸º 1 è¡¨ç¤ºå½“å‰ä»»åŠ¡æ˜¯é˜ˆå€¼å›å†™ä»»åŠ¡ <code>sync</code>
ç³»ç»Ÿè°ƒç”¨æ‰‹åŠ¨è§¦å‘çš„å›å†™ä»»åŠ¡ã€‚<code>sync</code> ç³»ç»Ÿè°ƒç”¨è¯¦æƒ…å‚è€ƒ <a href="#sync">åç»­å°èŠ‚</a></p></li>
</ol>
<h2 id="å›å†™çº¿ç¨‹">å›å†™çº¿ç¨‹</h2>
<p>å‰é¢è¯´è¿‡ <code>bdi_writeback</code> ç»“æ„ä½“ä¸­
<code>struct delayed_work dwork</code> å°±æ˜¯å…³é”®çš„è´Ÿè´£ page cache
å›å†™å·¥ä½œçš„ç»“æ„ä½“</p>
<h3 id="åˆå§‹åŒ–-2">åˆå§‹åŒ–</h3>
<p><code>wb_init</code> å‡½æ•°ä¼šå¯¹ <code>wb-&gt;dwork</code>
èµ‹å€¼ï¼Œæ³¨å†Œå®é™…çš„å·¥ä½œå‡½æ•° <code>wb_workfn</code></p>
<p>ç”±äºè¿™æ˜¯ä¸ª
<code>delayed_work</code>ï¼Œæ³¨å†Œçš„å·¥ä½œå‡½æ•°ä¸ä¼šç«‹å³æ‰§è¡Œï¼Œéœ€è¦åç»­åˆ©ç”¨
<code>mod_delayed_work</code> æ¥ä¿®æ”¹ <code>delayed_work</code>
å†…ç½®çš„å®šæ—¶å™¨æ—¶é—´æ¥å”¤é†’</p>
<figure>
<img data-src="/posts/646202b9/wb_init.png" alt="wb_init è°ƒç”¨å›¾">
<figcaption aria-hidden="true">wb_init è°ƒç”¨å›¾</figcaption>
</figure>
<p>(P.S. å›¾ç‰‡ä¸­å‡½æ•°å¼€å¤´ä¸º <code>cg</code> ä»£è¡¨å’Œ <code>cgroup</code>
ç›¸å…³ï¼ŒåŒä¸€å±‚çº§å¤šä¸ªåŒåå‡½æ•°å’Œå®å®šä¹‰çš„ç¼–è¯‘æ§åˆ¶æœ‰å…³)</p>
<p>æ ¹æ®å‡½æ•°è°ƒç”¨å›¾ï¼Œå¤§è‡´åˆ†æå¯çŸ¥ï¼Œå½“è®¾å¤‡ç”³è¯· <code>queue</code>
æ—¶ä¼šåˆå§‹åŒ– <code>backing_dev_info</code> ç»“æ„ä½“å’Œ
<code>bdi_writeback</code> ç»“æ„ä½“ï¼Œä»¥åŠåˆå§‹åŒ–å›å†™çº¿ç¨‹</p>
<h3 id="ç«‹å³å”¤é†’">ç«‹å³å”¤é†’</h3>
<p>è™½ç„¶ <code>dwork</code> æ˜¯ä¸ª
<code>delayed_work</code>ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥åœ¨è°ƒç”¨
<code>mod_delayed_work</code> å°†å»¶æ—¶è®¾ç½®ä¸º 0ï¼Œæ¥ç«‹å³å”¤é†’å›å†™çº¿ç¨‹</p>
<figure>
<img data-src="/posts/646202b9/dwork_callers.png" alt="dwork è°ƒç”¨å›¾">
<figcaption aria-hidden="true">dwork è°ƒç”¨å›¾</figcaption>
</figure>
<h4 id="wb_wakeup"><code>wb_wakeup</code></h4>
<p><code>wb_wakeup</code> å°±æ˜¯ä¿®æ”¹å»¶æ—¶ä¸º 0ï¼Œç›´æ¥å”¤é†’å›å†™çº¿ç¨‹</p>
<figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// fs/fs-writeback.c</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">wb_wakeup</span><span class="params">(<span class="keyword">struct</span> bdi_writeback *wb)</span></span><br><span class="line">{</span><br><span class="line">	spin_lock_bh(&amp;wb-&gt;work_lock);</span><br><span class="line">	<span class="keyword">if</span> (test_bit(WB_registered, &amp;wb-&gt;state))</span><br><span class="line">		mod_delayed_work(bdi_wq, &amp;wb-&gt;dwork, <span class="number">0</span>);</span><br><span class="line">	spin_unlock_bh(&amp;wb-&gt;work_lock);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="wb_queue_work"><code>wb_queue_work</code></h4>
<p><code>wb_queue_work</code>
å°†ä¸€ä¸ªå›å†™ä»»åŠ¡æ’å…¥åˆ°é˜Ÿåˆ—å°¾éƒ¨ï¼Œç„¶åä¿®æ”¹å»¶æ—¶ä¸º 0ï¼Œç«‹å³å”¤é†’å›å†™çº¿ç¨‹</p>
<figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// fs/fs-writeback.c</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">wb_queue_work</span><span class="params">(<span class="keyword">struct</span> bdi_writeback *wb,</span></span><br><span class="line"><span class="params">			  <span class="keyword">struct</span> wb_writeback_work *work)</span></span><br><span class="line">{</span><br><span class="line">	trace_writeback_queue(wb, work);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (work-&gt;done)</span><br><span class="line">		<span class="type">atomic_inc</span>(&amp;work-&gt;done-&gt;cnt);</span><br><span class="line"></span><br><span class="line">	spin_lock_bh(&amp;wb-&gt;work_lock);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (test_bit(WB_registered, &amp;wb-&gt;state)) {</span><br><span class="line">		list_add_tail(&amp;work-&gt;<span class="built_in">list</span>, &amp;wb-&gt;work_list);</span><br><span class="line">		mod_delayed_work(bdi_wq, &amp;wb-&gt;dwork, <span class="number">0</span>);</span><br><span class="line">	} <span class="keyword">else</span></span><br><span class="line">		finish_writeback_work(wb, work);</span><br><span class="line"></span><br><span class="line">	spin_unlock_bh(&amp;wb-&gt;work_lock);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="å®šæ—¶å”¤é†’">å®šæ—¶å”¤é†’</h3>
<p>å®šæ—¶å”¤é†’ä¸»è¦æ˜¯ç”± <code>wb_wakeup_delayed</code>
æ¥å®ç°çš„ï¼Œè€Œæ—¶é—´é—´éš”åœ¨ <code>mm/page-writeback.c</code> è¿›è¡Œäº†å®šä¹‰</p>
<figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// mm/page-writeback.c</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The interval between `kupdate'-style writebacks</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> dirty_writeback_interval = <span class="number">5</span> * <span class="number">100</span>; <span class="comment">/* centiseconds */</span></span><br><span class="line"></span><br><span class="line">EXPORT_SYMBOL_GPL(dirty_writeback_interval);</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// mm/backing-dev.c</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * This function is used when the first inode for this wb is marked dirty. It</span></span><br><span class="line"><span class="comment"> * wakes-up the corresponding bdi thread which should then take care of the</span></span><br><span class="line"><span class="comment"> * periodic background write-out of dirty inodes. Since the write-out would</span></span><br><span class="line"><span class="comment"> * starts only 'dirty_writeback_interval' centisecs from now anyway, we just</span></span><br><span class="line"><span class="comment"> * set up a timer which wakes the bdi thread up later.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Note, we wouldn't bother setting up the timer, but this function is on the</span></span><br><span class="line"><span class="comment"> * fast-path (used by '__mark_inode_dirty()'), so we save few context switches</span></span><br><span class="line"><span class="comment"> * by delaying the wake-up.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * We have to be careful not to postpone flush work if it is scheduled for</span></span><br><span class="line"><span class="comment"> * earlier. Thus we use queue_delayed_work().</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">wb_wakeup_delayed</span><span class="params">(<span class="keyword">struct</span> bdi_writeback *wb)</span></span><br><span class="line">{</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> timeout;</span><br><span class="line"></span><br><span class="line">	timeout = msecs_to_jiffies(dirty_writeback_interval * <span class="number">10</span>);</span><br><span class="line">	spin_lock_bh(&amp;wb-&gt;work_lock);</span><br><span class="line">	<span class="keyword">if</span> (test_bit(WB_registered, &amp;wb-&gt;state))</span><br><span class="line">		queue_delayed_work(bdi_wq, &amp;wb-&gt;dwork, timeout);</span><br><span class="line">	spin_unlock_bh(&amp;wb-&gt;work_lock);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p><code>wb_wakeup_delayed</code> ä½¿ç”¨ 5s ä½œä¸ºæ—¶é—´é—´éš”ï¼Œå½“è°ƒç”¨
<code>wb_wakeup_delayed</code> åï¼Œå›å†™çº¿ç¨‹ä¼šåœ¨ 5s åè¢«å”¤é†’</p>
<figure>
<img data-src="/posts/646202b9/wb_wakeup_delayed.png" alt="wb_wakeup_delayed è°ƒç”¨å›¾">
<figcaption aria-hidden="true">wb_wakeup_delayed è°ƒç”¨å›¾</figcaption>
</figure>
<p>å®šæ—¶å”¤é†’åªä¼šåœ¨ä¸¤ç§æƒ…å½¢ä¸‹è¢«è°ƒç”¨ï¼š</p>
<ul>
<li><code>__mark_inode_dirty</code>ï¼šå½“ç»™ä¸€ä¸ª <code>inode</code>
æ ‡è®°ä¸ºè„æ—¶ï¼Œå¦‚æœè„çš„ä¸ä»…ä»…æ˜¯æ—¶é—´æˆ³ï¼Œè€Œä¸”å½“å‰çš„ <code>b_dirty</code>
é“¾è¡¨æ˜¯ç©ºçš„ï¼Œä¹Ÿå°±æ˜¯è¯´ç¬¬ä¸€æ¬¡å°†è„é¡µæŒ‚åœ¨ <code>b_dirty</code>
é“¾è¡¨æ—¶ï¼Œå¼€å¯å®šæ—¶å”¤é†’</li>
<li><code>wb_workfn</code>ï¼šå½“å›å†™çº¿ç¨‹å¤„ç†å®Œ <code>work_list</code>
ä¸Šçš„æ‰€æœ‰ä»»åŠ¡åï¼Œå¦‚æœä»æœ‰è„ <code>inode</code> åœ¨
<code>b_{dirty|io|more_io}</code> ä¸Šæ—¶ï¼Œå¼€å¯å®šæ—¶å”¤é†’</li>
</ul>
<p>ç®€å•çš„è®²ï¼Œå°±æ˜¯åªè¦å­˜åœ¨è„ <code>inode</code> åœ¨
<code>b_{dirty|io|more_io}</code> ä¸Šæ—¶ï¼Œå†…æ ¸çš„å›å†™çº¿ç¨‹æ¯ 5s
å†…è‚¯å®šä¼šè¢«å”¤é†’ä¸€æ¬¡</p>
<h3 id="é‡Šæ”¾é”€æ¯">é‡Šæ”¾é”€æ¯</h3>
<figure>
<img data-src="/posts/646202b9/release_bdi.png" alt="release_bdi è°ƒç”¨å›¾">
<figcaption aria-hidden="true">release_bdi è°ƒç”¨å›¾</figcaption>
</figure>
<p>å½“éœ€è¦å¯¹æ•´ä¸ª <code>backing_dev_info</code>
ç»“æ„é‡Šæ”¾æ—¶ï¼Œä¹Ÿä¼šç«‹å³å”¤é†’å†…æ ¸å›å†™çº¿ç¨‹ï¼Œå¹¶ä¸”ä¼šä¸‹åˆ·ç°æœ‰çš„æ‰€æœ‰å·¥ä½œ</p>
<pre class="mermaid">graph TD
release_bdi --&gt; bdi_unregister --&gt; wb_shutdown
release_bdi ---&gt; wb_exit</pre>
<h2 id="ç»†èŠ‚åˆ†æ">ç»†èŠ‚åˆ†æ</h2>
<h3 id="tag-and-write"><code>tag-and-write</code></h3>
<p>è¯¥æœºåˆ¶ä¼šåœ¨ <code>write_pages</code>
æ—¶å…ˆå¿«é€Ÿå¯¹ä¸‹åˆ·èŒƒå›´å†…çš„è„é¡µè¿›è¡Œæ ‡è®°ï¼Œåç»­åªå¯¹æ ‡è®°è¿‡çš„è„é¡µè¿›è¡Œä¸‹åˆ·</p>
<p>é¦–å…ˆå›å†™ä»»åŠ¡çš„å‚æ•°ä¼šé€šè¿‡ <code>fs/fs-writeback.c</code> çš„
<code>writeback_sb_inodes</code> å‡½æ•°ä¼ é€’ç»™
<code>struct writeback_control wbc</code></p>
<p>åç»­åœ¨ <code>mm/page-writeback.c</code> ä¸­
<code>write_cache_pages</code> å°±ä¼šæ ¹æ® <code>wbc</code> çš„
<code>tagged_writepages</code> å­—æ®µè¿›è¡Œåˆ¤æ–­ï¼Œé…ç½®ä¸åŒçš„
<code>tag</code>ï¼Œä»¥åŠæ˜¯å¦éœ€è¦å¿«é€Ÿéå†è„é¡µå¹¶æ ‡è®°</p>
<figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * write_cache_pages - walk the list of dirty pages of the given address space and write all of them.</span></span><br><span class="line"><span class="comment"> * @mapping: address space structure to write</span></span><br><span class="line"><span class="comment"> * @wbc: subtract the number of written pages from *@wbc-&gt;nr_to_write</span></span><br><span class="line"><span class="comment"> * @writepage: function called for each page</span></span><br><span class="line"><span class="comment"> * @data: data passed to writepage function</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * If a page is already under I/O, write_cache_pages() skips it, even</span></span><br><span class="line"><span class="comment"> * if it's dirty.  This is desirable behaviour for memory-cleaning writeback,</span></span><br><span class="line"><span class="comment"> * but it is INCORRECT for data-integrity system calls such as fsync().  fsync()</span></span><br><span class="line"><span class="comment"> * and msync() need to guarantee that all the data which was dirty at the time</span></span><br><span class="line"><span class="comment"> * the call was made get new I/O started against them.  If wbc-&gt;sync_mode is</span></span><br><span class="line"><span class="comment"> * WB_SYNC_ALL then we were called for data integrity and we must wait for</span></span><br><span class="line"><span class="comment"> * existing IO to complete.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * To avoid livelocks (when other process dirties new pages), we first tag</span></span><br><span class="line"><span class="comment"> * pages which should be written back with TOWRITE tag and only then start</span></span><br><span class="line"><span class="comment"> * writing them. For data-integrity sync we have to be careful so that we do</span></span><br><span class="line"><span class="comment"> * not miss some pages (e.g., because some other process has cleared TOWRITE</span></span><br><span class="line"><span class="comment"> * tag we set). The rule we follow is that TOWRITE tag can be cleared only</span></span><br><span class="line"><span class="comment"> * by the process clearing the DIRTY tag (and submitting the page for IO).</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * To avoid deadlocks between range_cyclic writeback and callers that hold</span></span><br><span class="line"><span class="comment"> * pages in PageWriteback to aggregate IO until write_cache_pages() returns,</span></span><br><span class="line"><span class="comment"> * we do not loop back to the start of the file. Doing so causes a page</span></span><br><span class="line"><span class="comment"> * lock/page writeback access order inversion - we should only ever lock</span></span><br><span class="line"><span class="comment"> * multiple pages in ascending page-&gt;index order, and looping back to the start</span></span><br><span class="line"><span class="comment"> * of the file violates that rule and causes deadlocks.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Return: %0 on success, negative error code otherwise</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">write_cache_pages</span><span class="params">(<span class="keyword">struct</span> address_space *mapping,</span></span><br><span class="line"><span class="params">		      <span class="keyword">struct</span> writeback_control *wbc, <span class="type">writepage_t</span> writepage,</span></span><br><span class="line"><span class="params">		      <span class="type">void</span> *data)</span></span><br><span class="line">{</span><br><span class="line">	<span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line">	<span class="type">int</span> done = <span class="number">0</span>;</span><br><span class="line">	<span class="type">int</span> error;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pagevec</span> <span class="title">pvec</span>;</span></span><br><span class="line">	<span class="type">int</span> nr_pages;</span><br><span class="line">	<span class="type">pgoff_t</span> <span class="title function_">uninitialized_var</span><span class="params">(writeback_index)</span>;</span><br><span class="line">	<span class="type">pgoff_t</span> index;</span><br><span class="line">	<span class="type">pgoff_t</span> end;		<span class="comment">/* Inclusive */</span></span><br><span class="line">	<span class="type">pgoff_t</span> done_index;</span><br><span class="line">	<span class="type">int</span> range_whole = <span class="number">0</span>;</span><br><span class="line">	<span class="type">xa_mark_t</span> tag;</span><br><span class="line"></span><br><span class="line">	pagevec_init(&amp;pvec);</span><br><span class="line">	<span class="keyword">if</span> (wbc-&gt;range_cyclic) {</span><br><span class="line">		writeback_index = mapping-&gt;writeback_index; <span class="comment">/* prev offset */</span></span><br><span class="line">		index = writeback_index;</span><br><span class="line">		end = <span class="number">-1</span>;</span><br><span class="line">	} <span class="keyword">else</span> {</span><br><span class="line">		index = wbc-&gt;range_start &gt;&gt; PAGE_SHIFT;</span><br><span class="line">		end = wbc-&gt;range_end &gt;&gt; PAGE_SHIFT;</span><br><span class="line">		<span class="keyword">if</span> (wbc-&gt;range_start == <span class="number">0</span> &amp;&amp; wbc-&gt;range_end == LLONG_MAX)</span><br><span class="line">			range_whole = <span class="number">1</span>;</span><br><span class="line">	}</span><br><span class="line">	<span class="keyword">if</span> (wbc-&gt;sync_mode == WB_SYNC_ALL || wbc-&gt;tagged_writepages)</span><br><span class="line">		tag = PAGECACHE_TAG_TOWRITE;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		tag = PAGECACHE_TAG_DIRTY;</span><br><span class="line">	<span class="keyword">if</span> (wbc-&gt;sync_mode == WB_SYNC_ALL || wbc-&gt;tagged_writepages)</span><br><span class="line">		tag_pages_for_writeback(mapping, index, end);</span><br><span class="line">	done_index = index;</span><br><span class="line">	<span class="keyword">while</span> (!done &amp;&amp; (index &lt;= end)) {</span><br><span class="line">		<span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line">		nr_pages = pagevec_lookup_range_tag(&amp;pvec, mapping, &amp;index, end,</span><br><span class="line">				tag);</span><br><span class="line">		<span class="keyword">if</span> (nr_pages == <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; nr_pages; i++) {</span><br><span class="line">			<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span> =</span> pvec.pages[i];</span><br><span class="line"></span><br><span class="line">			done_index = page-&gt;index;</span><br><span class="line"></span><br><span class="line">			lock_page(page);</span><br><span class="line"></span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * Page truncated or invalidated. We can freely skip it</span></span><br><span class="line"><span class="comment">			 * then, even for data integrity operations: the page</span></span><br><span class="line"><span class="comment">			 * has disappeared concurrently, so there could be no</span></span><br><span class="line"><span class="comment">			 * real expectation of this data interity operation</span></span><br><span class="line"><span class="comment">			 * even if there is now a new, dirty page at the same</span></span><br><span class="line"><span class="comment">			 * pagecache address.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			<span class="keyword">if</span> (unlikely(page-&gt;mapping != mapping)) {</span><br><span class="line">continue_unlock:</span><br><span class="line">				unlock_page(page);</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			}</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (!PageDirty(page)) {</span><br><span class="line">				<span class="comment">/* someone wrote it for us */</span></span><br><span class="line">				<span class="keyword">goto</span> continue_unlock;</span><br><span class="line">			}</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (PageWriteback(page)) {</span><br><span class="line">				<span class="keyword">if</span> (wbc-&gt;sync_mode != WB_SYNC_NONE)</span><br><span class="line">					wait_on_page_writeback(page);</span><br><span class="line">				<span class="keyword">else</span></span><br><span class="line">					<span class="keyword">goto</span> continue_unlock;</span><br><span class="line">			}</span><br><span class="line"></span><br><span class="line">			BUG_ON(PageWriteback(page));</span><br><span class="line">			<span class="keyword">if</span> (!clear_page_dirty_for_io(page))</span><br><span class="line">				<span class="keyword">goto</span> continue_unlock;</span><br><span class="line"></span><br><span class="line">			trace_wbc_writepage(wbc, inode_to_bdi(mapping-&gt;host));</span><br><span class="line">			error = (*writepage)(page, wbc, data);</span><br><span class="line">			<span class="keyword">if</span> (unlikely(error)) {</span><br><span class="line">				<span class="comment">/*</span></span><br><span class="line"><span class="comment">				 * Handle errors according to the type of</span></span><br><span class="line"><span class="comment">				 * writeback. There's no need to continue for</span></span><br><span class="line"><span class="comment">				 * background writeback. Just push done_index</span></span><br><span class="line"><span class="comment">				 * past this page so media errors won't choke</span></span><br><span class="line"><span class="comment">				 * writeout for the entire file. For integrity</span></span><br><span class="line"><span class="comment">				 * writeback, we must process the entire dirty</span></span><br><span class="line"><span class="comment">				 * set regardless of errors because the fs may</span></span><br><span class="line"><span class="comment">				 * still have state to clear for each page. In</span></span><br><span class="line"><span class="comment">				 * that case we continue processing and return</span></span><br><span class="line"><span class="comment">				 * the first error.</span></span><br><span class="line"><span class="comment">				 */</span></span><br><span class="line">				<span class="keyword">if</span> (error == AOP_WRITEPAGE_ACTIVATE) {</span><br><span class="line">					unlock_page(page);</span><br><span class="line">					error = <span class="number">0</span>;</span><br><span class="line">				} <span class="keyword">else</span> <span class="keyword">if</span> (wbc-&gt;sync_mode != WB_SYNC_ALL) {</span><br><span class="line">					ret = error;</span><br><span class="line">					done_index = page-&gt;index + <span class="number">1</span>;</span><br><span class="line">					done = <span class="number">1</span>;</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				}</span><br><span class="line">				<span class="keyword">if</span> (!ret)</span><br><span class="line">					ret = error;</span><br><span class="line">			}</span><br><span class="line"></span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * We stop writing back only if we are not doing</span></span><br><span class="line"><span class="comment">			 * integrity sync. In case of integrity sync we have to</span></span><br><span class="line"><span class="comment">			 * keep going until we have written all the pages</span></span><br><span class="line"><span class="comment">			 * we tagged for writeback prior to entering this loop.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			<span class="keyword">if</span> (--wbc-&gt;nr_to_write &lt;= <span class="number">0</span> &amp;&amp;</span><br><span class="line">			    wbc-&gt;sync_mode == WB_SYNC_NONE) {</span><br><span class="line">				done = <span class="number">1</span>;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			}</span><br><span class="line">		}</span><br><span class="line">		pagevec_release(&amp;pvec);</span><br><span class="line">		cond_resched();</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * If we hit the last page and there is more work to be done: wrap</span></span><br><span class="line"><span class="comment">	 * back the index back to the start of the file for the next</span></span><br><span class="line"><span class="comment">	 * time we are called.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (wbc-&gt;range_cyclic &amp;&amp; !done)</span><br><span class="line">		done_index = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span> (wbc-&gt;range_cyclic || (range_whole &amp;&amp; wbc-&gt;nr_to_write &gt; <span class="number">0</span>))</span><br><span class="line">		mapping-&gt;writeback_index = done_index;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">}</span><br><span class="line">EXPORT_SYMBOL(write_cache_pages);</span><br></pre></td></tr></tbody></table></figure>
<p>åœ¨ <code>fs/fs-writeback.c</code> ä¸­
<code>writeback_chunk_size</code> é‡Œé¢çš„æ³¨é‡Šä¹Ÿå¯¹è¿™ä¸ªæµç¨‹è¿›è¡Œäº†æè¿°</p>
<figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">long</span> <span class="title function_">writeback_chunk_size</span><span class="params">(<span class="keyword">struct</span> bdi_writeback *wb,</span></span><br><span class="line"><span class="params">				 <span class="keyword">struct</span> wb_writeback_work *work)</span></span><br><span class="line">{</span><br><span class="line">	<span class="type">long</span> pages;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * WB_SYNC_ALL mode does livelock avoidance by syncing dirty</span></span><br><span class="line"><span class="comment">	 * inodes/pages in one big loop. Setting wbc.nr_to_write=LONG_MAX</span></span><br><span class="line"><span class="comment">	 * here avoids calling into writeback_inodes_wb() more than once.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * The intended call sequence for WB_SYNC_ALL writeback is:</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 *      wb_writeback()</span></span><br><span class="line"><span class="comment">	 *          writeback_sb_inodes()       &lt;== called only once</span></span><br><span class="line"><span class="comment">	 *              write_cache_pages()     &lt;== called once for each inode</span></span><br><span class="line"><span class="comment">	 *                   (quickly) tag currently dirty pages</span></span><br><span class="line"><span class="comment">	 *                   (maybe slowly) sync all tagged pages</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (work-&gt;sync_mode == WB_SYNC_ALL || work-&gt;tagged_writepages)</span><br><span class="line">		pages = LONG_MAX;</span><br><span class="line">	<span class="keyword">else</span> {</span><br><span class="line">		pages = min(wb-&gt;avg_write_bandwidth / <span class="number">2</span>,</span><br><span class="line">			    global_wb_domain.dirty_limit / DIRTY_SCOPE);</span><br><span class="line">		pages = min(pages, work-&gt;nr_pages);</span><br><span class="line">		pages = round_down(pages + MIN_WRITEBACK_PAGES,</span><br><span class="line">				   MIN_WRITEBACK_PAGES);</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> pages;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="range_cyclic"><code>range_cyclic</code></h3>
<p><code>range_cyclic</code> æ—©åœ¨å†…æ ¸çš„ v2.6.18-rc1
ç‰ˆæœ¬å°±å·²ç»å®ç°ï¼Œå¯ä»¥å‚è€ƒ <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3RvcnZhbGRzL2xpbnV4L2NvbW1pdC8xMTFlYmI2ZTZmN2JkN2RlNmQ3MjJjNTg0OGU5NTYyMWY0MzcwMGQ5">111ebb6<i class="fa fa-external-link-alt"></i></span>
çš„æäº¤ä¿¡æ¯è¾…åŠ©ç†è§£</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">[PATCH] writeback: fix range handling</span><br><span class="line">When a writeback_control's `start' and `end' fields are used to</span><br><span class="line">indicate a one-byte-range starting at file offset zero, the required</span><br><span class="line">values of .start=0,.end=0 mean that the -&gt;writepages() implementation</span><br><span class="line">has no way of telling that it is being asked to perform a range</span><br><span class="line">request.  Because we're currently overloading (start == 0 &amp;&amp; end == 0)</span><br><span class="line">to mean "this is not a write-a-range request".</span><br><span class="line"></span><br><span class="line">To make all this sane, the patch changes range of writeback_control.</span><br><span class="line"></span><br><span class="line">So caller does: If it is calling -&gt;writepages() to write pages, it</span><br><span class="line">sets range (range_start/end or range_cyclic) always.</span><br><span class="line"></span><br><span class="line">And if range_cyclic is true, -&gt;writepages() thinks the range is</span><br><span class="line">cyclic, otherwise it just uses range_start and range_end.</span><br><span class="line"></span><br><span class="line">This patch does,</span><br><span class="line"></span><br><span class="line">    - Add LLONG_MAX, LLONG_MIN, ULLONG_MAX to include/linux/kernel.h</span><br><span class="line">      -1 is usually ok for range_end (type is long long). But, if someone did,</span><br><span class="line"></span><br><span class="line">		range_end += val;		range_end is "val - 1"</span><br><span class="line">		u64val = range_end &gt;&gt; bits;	u64val is "~(0ULL)"</span><br><span class="line"></span><br><span class="line">      or something, they are wrong. So, this adds LLONG_MAX to avoid nasty</span><br><span class="line">      things, and uses LLONG_MAX for range_end.</span><br><span class="line"></span><br><span class="line">    - All callers of -&gt;writepages() sets range_start/end or range_cyclic.</span><br><span class="line"></span><br><span class="line">    - Fix updates of -&gt;writeback_index. It seems already bit strange.</span><br><span class="line">      If it starts at 0 and ended by check of nr_to_write, this last</span><br><span class="line">      index may reduce chance to scan end of file.  So, this updates</span><br><span class="line">      -&gt;writeback_index only if range_cyclic is true or whole-file is</span><br><span class="line">      scanned.</span><br><span class="line"></span><br><span class="line">Signed-off-by: OGAWA Hirofumi &lt;hirofumi@mail.parknet.co.jp&gt;</span><br><span class="line">Cc: Nathan Scott &lt;nathans@sgi.com&gt;</span><br><span class="line">Cc: Anton Altaparmakov &lt;aia21@cantab.net&gt;</span><br><span class="line">Cc: Steven French &lt;sfrench@us.ibm.com&gt;</span><br><span class="line">Cc: "Vladimir V. Saveliev" &lt;vs@namesys.com&gt;</span><br><span class="line">Signed-off-by: Andrew Morton &lt;akpm@osdl.org&gt;</span><br><span class="line">Signed-off-by: Linus Torvalds &lt;torvalds@osdl.org&gt;</span><br></pre></td></tr></tbody></table></figure>
<p><code>range_cyclic</code> å’Œ <code>range_start/end</code> äº’æ–¥</p>
<ul>
<li>å½“å¼€å¯ <code>range_cyclic</code> å°†æ— è§† <code>range_start/end</code>
çš„å€¼</li>
<li>å¦åˆ™åº•å±‚ <code>writepages</code> å‡½æ•°åˆ™ä½¿ç”¨
<code>range_start/end</code> ä½œä¸ºå†™çš„èŒƒå›´ </li>
</ul>
<pre class="mermaid">graph TD
do_writepages --&gt; writepages("mapping-&gt;a_ops-&gt;writepages()")
do_writepages --&gt; generic_writepages --&gt; write_cache_pages</pre>
<p>ç»“åˆå®é™…ä»£ç ï¼Œåœ¨ <code>mm/page-writeback.c</code> çš„
<code>write_cache_pages</code> å‡½æ•°ä¸­æœ‰ä»¥ä¸‹ç‰‡æ®µ</p>
<figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (wbc-&gt;range_cyclic) {</span><br><span class="line">	writeback_index = mapping-&gt;writeback_index; <span class="comment">/* prev offset */</span></span><br><span class="line">	index = writeback_index;</span><br><span class="line">	end = <span class="number">-1</span>;</span><br><span class="line">} <span class="keyword">else</span> {</span><br><span class="line">	index = wbc-&gt;range_start &gt;&gt; PAGE_SHIFT;</span><br><span class="line">	end = wbc-&gt;range_end &gt;&gt; PAGE_SHIFT;</span><br><span class="line">	<span class="keyword">if</span> (wbc-&gt;range_start == <span class="number">0</span> &amp;&amp; wbc-&gt;range_end == LLONG_MAX)</span><br><span class="line">		range_whole = <span class="number">1</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ­¤å¤„çœç•¥éƒ¨åˆ†ä»£ç </span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * If we hit the last page and there is more work to be done: wrap</span></span><br><span class="line"><span class="comment"> * back the index back to the start of the file for the next</span></span><br><span class="line"><span class="comment"> * time we are called.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (wbc-&gt;range_cyclic &amp;&amp; !done)</span><br><span class="line">	done_index = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span> (wbc-&gt;range_cyclic || (range_whole &amp;&amp; wbc-&gt;nr_to_write &gt; <span class="number">0</span>))</span><br><span class="line">	mapping-&gt;writeback_index = done_index;</span><br></pre></td></tr></tbody></table></figure>
<p><code>range_cyclic</code> å¼€å¯åä¼šä½¿ç”¨
<code>mapping-&gt;writeback_index</code>
ä½œä¸ºæœ¬æ¬¡å›å†™çš„èµ·å§‹åœ°å€ï¼Œå¹¶ä¼šåœ¨å®Œæˆæœ¬æ¬¡å›å†™æµç¨‹ï¼ˆå›å†™é¡µæ•°é™åˆ¶æˆ–è€…åˆ°è¾¾æ–‡ä»¶æœ«å°¾ï¼‰åæ›´æ–°
<code>mapping-&gt;writeback_index</code></p>
<h3 id="å®šæœŸå›å†™">å®šæœŸå›å†™</h3>
<p>å®šæœŸå›å†™çš„ä»»åŠ¡å£°æ˜åœ¨ <code>fs/fs-writeback.c</code> çš„
<code>wb_check_old_data_flush</code> å‡½æ•°ä¸­ï¼Œè€Œè¿™ä¸ªå‡½æ•°åˆ™æ˜¯è¢«
<code>wb_workfn</code> è°ƒç”¨</p>
<figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">long</span> <span class="title function_">wb_check_old_data_flush</span><span class="params">(<span class="keyword">struct</span> bdi_writeback *wb)</span></span><br><span class="line">{</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> expired;</span><br><span class="line">	<span class="type">long</span> nr_pages;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * When set to zero, disable periodic writeback</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (!dirty_writeback_interval)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	expired = wb-&gt;last_old_flush +</span><br><span class="line">			msecs_to_jiffies(dirty_writeback_interval * <span class="number">10</span>);</span><br><span class="line">	<span class="keyword">if</span> (time_before(jiffies, expired))</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	wb-&gt;last_old_flush = jiffies;</span><br><span class="line">	nr_pages = get_nr_dirty_pages();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (nr_pages) {</span><br><span class="line">		<span class="comment">// å®šæœŸå›å†™</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">wb_writeback_work</span> <span class="title">work</span> =</span> {</span><br><span class="line">			.nr_pages	= nr_pages,</span><br><span class="line">			.sync_mode	= WB_SYNC_NONE,</span><br><span class="line">			.for_kupdate	= <span class="number">1</span>,</span><br><span class="line">			.range_cyclic	= <span class="number">1</span>,</span><br><span class="line">			.reason		= WB_REASON_PERIODIC,</span><br><span class="line">		};</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> wb_writeback(wb, &amp;work);</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<pre class="mermaid">graph TD
wb_wakeup -.-&gt; wb_workfn --&gt;|é€šå¸¸æƒ…å†µ| wb_do_writeback --&gt; wb_check_old_data_flush</pre>
<p>é¦–å…ˆè¦ä¿è¯å½“å‰æ—¶é—´åœ¨ä¸Šæ¬¡å®šæœŸå›å†™çš„ 5s
ï¼ˆå’Œå®šæœŸå”¤é†’çš„æ—¶é—´é—´éš”ä¸€è‡´ï¼‰åï¼Œå¹¶ä¸”å½“å‰å­˜åœ¨è„é¡µï¼Œæ‰ä¼šç”Ÿæˆä¸€æ¬¡å®šæœŸå›å†™çš„ä»»åŠ¡ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯
5s å†…æœ€å¤šè§¦å‘ä¸€æ¬¡å®šæœŸå›å†™</p>
<p>ç”Ÿæˆçš„å›å†™ä»»åŠ¡äº¤ç»™ <code>fs/fs-writeback.c</code> çš„
<code>wb_writeback</code> å‡½æ•°å¤„ç†</p>
<p>å¹¶ä¸”å®šæœŸå›å†™å±äºä¸€ç§åå°å›å†™ï¼Œä¼˜å…ˆçº§è¾ƒä½ï¼Œåªæœ‰åœ¨
<code>wb-&gt;work_list</code> ä¸ºç©ºæ—¶æ‰ä¼šæ‰§è¡Œ</p>
<p><code>wb_writeback</code> æ‰§è¡Œå®šæœŸå›å†™æ—¶åªä¼šé€‰æ‹©åœ¨è‡³è„æ—¶é—´åœ¨å½“å‰æ—¶é—´
30s ä¹‹å‰çš„ <code>inode</code> çš„æ‰€æœ‰è„é¡µè¿›è¡Œå›å†™</p>
<h3 id="é˜ˆå€¼å›å†™">é˜ˆå€¼å›å†™</h3>
<p>é’ˆå¯¹è„é¡µç‡å†…æ ¸ä¸­æœ‰ä¸¤ä¸ªé˜ˆå€¼ï¼Œ10% å’Œ 20%</p>
<figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// mm/page-writeback.c</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Start background writeback (via writeback threads) at this percentage</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> dirty_background_ratio = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The generator of dirty data starts writeback at this percentage</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> vm_dirty_ratio = <span class="number">20</span>;</span><br></pre></td></tr></tbody></table></figure>
<ol type="1">
<li><p>bg_thresh åå°é˜ˆå€¼</p>
<p>å½“è„é¡µç‡è¾¾åˆ° 10% æ—¶ä¼šä»¥åå°çš„æ–¹å¼è¿›è¡Œå›å†™</p>
<pre class="mermaid">   graph TD
 generic_perform_write --&gt; balance_dirty_pages_ratelimited --&gt; balance_dirty_pages --&gt; wb_start_background_writeback --&gt; wb_wakeup
 wb_wakeup -.-&gt; wb_workfn --&gt;|é€šå¸¸æƒ…å†µ| wb_do_writeback --&gt;|wb_over_bg_thresh| wb_check_background_flush</pre>
<p>å½“ç”¨æˆ· <code>write</code> è°ƒç”¨ä½¿ç”¨ <code>generic_perform_write</code>
æ¥å†™ page cache æ—¶ï¼Œä¼šè°ƒç”¨ <code>balance_dirty_pages_ratelimited</code>
æ¥æ£€æŸ¥è„é¡µç‡ï¼Œå½“è„é¡µç‡è¶…è¿‡ 10% å°±ä¼šè°ƒç”¨ <code>balance_dirty_pages</code>
æ¥å”¤é†’ <code>wb_workfn</code> æ¥è¿›è¡Œä¸‹åˆ·è„é¡µï¼Œæ­¤æ—¶å¹¶ä¸ä¼šé˜»å¡å½“å‰çš„
<code>write</code> è¿‡ç¨‹</p></li>
<li><p> thresh å‰å°é˜ˆå€¼</p>
<p>è€Œå½“è„é¡µç‡è¾¾åˆ° 20%
ä¹‹ååˆ™ä¼šè§¦å‘å‰å°å›å†™ï¼Œæ­¤æ—¶çš„å‡½æ•°è°ƒç”¨å’Œé€»è¾‘å’Œä¸Šé¢åŸºæœ¬ä¸€è‡´ï¼Œä¸åŒç‚¹åœ¨äºå½“è„é¡µç‡è¶…è¿‡
20% åä¼šåœ¨ <code>balance_dirty_pages</code>
çš„å¾ªç¯ä¸­æ— æ³•è·³å‡ºï¼Œå› æ­¤çº¿ç¨‹ä¼šé˜»å¡ï¼Œç›´åˆ°è„é¡µç‡é™ä½è‡³ 20%
ä»¥ä¸‹ï¼Œè·³å‡ºå¾ªç¯ï¼Œå¯ç”¨åå°å›å†™</p></li>
</ol>
<h2 id="æ‰‹åŠ¨è§¦å‘å›å†™">æ‰‹åŠ¨è§¦å‘å›å†™</h2>
<h3 id="sync"><code>sync</code></h3>
<p><code>sync</code> ç³»ç»Ÿè°ƒç”¨ä¼šåŒæ­¥æ‰€æœ‰çš„ page cache</p>
<p>åœ¨ <code>bash</code> ä¸Šç›´æ¥è¾“å…¥ <code>sync</code> å‘½ä»¤å°±ä¼šè§¦å‘
<code>sync</code> ç³»ç»Ÿè°ƒç”¨</p>
<figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// fs/sync.c</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Sync everything. We start by waking flusher threads so that most of</span></span><br><span class="line"><span class="comment"> * writeback runs on all devices in parallel. Then we sync all inodes reliably</span></span><br><span class="line"><span class="comment"> * which effectively also waits for all flusher threads to finish doing</span></span><br><span class="line"><span class="comment"> * writeback. At this point all data is on disk so metadata should be stable</span></span><br><span class="line"><span class="comment"> * and we tell filesystems to sync their metadata via -&gt;sync_fs() calls.</span></span><br><span class="line"><span class="comment"> * Finally, we writeout all block devices because some filesystems (e.g. ext2)</span></span><br><span class="line"><span class="comment"> * just write metadata (such as inodes or bitmaps) to block device page cache</span></span><br><span class="line"><span class="comment"> * and do not sync it on their own in -&gt;sync_fs().</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">ksys_sync</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">{</span><br><span class="line">	<span class="type">int</span> nowait = <span class="number">0</span>, wait = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// å”¤é†’æ‰€æœ‰ bdi çš„å›å†™çº¿ç¨‹</span></span><br><span class="line">	wakeup_flusher_threads(WB_REASON_SYNC);</span><br><span class="line">	<span class="comment">// ä¸‹å‘æ‰€æœ‰ inode çš„å›å†™ä»»åŠ¡</span></span><br><span class="line">	iterate_supers(sync_inodes_one_sb, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="comment">// è°ƒç”¨ sync_fs() åŒæ­¥æ–‡ä»¶ç³»ç»Ÿçš„å…ƒæ•°æ®</span></span><br><span class="line">	iterate_supers(sync_fs_one_sb, &amp;nowait);</span><br><span class="line">	iterate_supers(sync_fs_one_sb, &amp;wait);</span><br><span class="line">	<span class="comment">// å›å†™å—è®¾å¤‡çš„ page cache</span></span><br><span class="line">	iterate_bdevs(fdatawrite_one_bdev, <span class="literal">NULL</span>);</span><br><span class="line">	iterate_bdevs(fdatawait_one_bdev, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">if</span> (unlikely(laptop_mode))</span><br><span class="line">		laptop_sync_completion();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">SYSCALL_DEFINE0(sync)</span><br><span class="line">{</span><br><span class="line">	ksys_sync();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>é¦–å…ˆï¼Œå”¤é†’æ‰€æœ‰è®¾å¤‡çš„å›å†™çº¿ç¨‹çº¿ç¨‹ï¼Œè¿™æ ·å¤§éƒ¨åˆ†çš„å›å†™åœ¨æ‰€æœ‰è®¾å¤‡ä¸Šå¹¶è¡Œè¿è¡Œ</li>
<li>å¹¶ç«‹åˆ»ç”Ÿæˆä¸€ä¸ªä¸‹åˆ·è®¾å¤‡ä¸Šæ‰€æœ‰ inode çš„å›å†™ä»»åŠ¡ï¼Œå¹¶ç­‰å¾…å®Œæˆ</li>
<li>ç„¶åæ–‡ä»¶ç³»ç»Ÿé€šè¿‡æ³¨å†Œçš„ <code>sync_fs()</code>
è°ƒç”¨æ¥åŒæ­¥ä»–ä»¬çš„å…ƒæ•°æ®</li>
<li>æœ€åï¼Œå›å†™æ‰€æœ‰çš„å—è®¾å¤‡çš„ page cache
<ul>
<li>å› ä¸ºæœ‰äº›æ–‡ä»¶ç³»ç»Ÿï¼ˆä¾‹å¦‚ <code>ext2</code>ï¼‰ä¼šå°†å…ƒæ•°æ®ï¼ˆå¦‚
<code>inodes</code> æˆ– <code>bitmaps</code>ï¼‰å†™å…¥å—è®¾å¤‡ page
cacheï¼Œè€Œä¸æ˜¯åœ¨ <code>sync_fs()</code> ä¸­è‡ªè¡ŒåŒæ­¥</li>
</ul></li>
</ul>
<h3 id="fsync-å’Œ-fdatasync"><code>fsync</code> å’Œ
<code>fdatasync</code></h3>
<p><code>fsync</code> å’Œ <code>fdatasync</code>
ç³»ç»Ÿè°ƒç”¨åˆ™å¯ä»¥æ›´åŠ ç»†ç²’åº¦çš„ä¸‹åˆ·è„é¡µï¼Œä»–ä»¬çš„ä¸‹åˆ·å¯¹è±¡æ˜¯ä¸€ä¸ªæ–‡ä»¶</p>
<figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// fs/sync.c</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * vfs_fsync_range - helper to sync a range of data &amp; metadata to disk</span></span><br><span class="line"><span class="comment"> * @file:		file to sync</span></span><br><span class="line"><span class="comment"> * @start:		offset in bytes of the beginning of data range to sync</span></span><br><span class="line"><span class="comment"> * @end:		offset in bytes of the end of data range (inclusive)</span></span><br><span class="line"><span class="comment"> * @datasync:		perform only datasync</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Write back data in range @start..@end and metadata for @file to disk.  If</span></span><br><span class="line"><span class="comment"> * @datasync is set only metadata needed to access modified file data is</span></span><br><span class="line"><span class="comment"> * written.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">vfs_fsync_range</span><span class="params">(<span class="keyword">struct</span> file *file, <span class="type">loff_t</span> start, <span class="type">loff_t</span> end, <span class="type">int</span> datasync)</span></span><br><span class="line">{</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *<span class="title">inode</span> =</span> file-&gt;f_mapping-&gt;host;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!file-&gt;f_op-&gt;fsync)</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line">	<span class="keyword">if</span> (!datasync &amp;&amp; (inode-&gt;i_state &amp; I_DIRTY_TIME))</span><br><span class="line">		mark_inode_dirty_sync(inode);</span><br><span class="line">	<span class="keyword">return</span> file-&gt;f_op-&gt;fsync(file, start, end, datasync);</span><br><span class="line">}</span><br><span class="line">EXPORT_SYMBOL(vfs_fsync_range);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * vfs_fsync - perform a fsync or fdatasync on a file</span></span><br><span class="line"><span class="comment"> * @file:		file to sync</span></span><br><span class="line"><span class="comment"> * @datasync:		only perform a fdatasync operation</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Write back data and metadata for @file to disk.  If @datasync is</span></span><br><span class="line"><span class="comment"> * set only metadata needed to access modified file data is written.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">vfs_fsync</span><span class="params">(<span class="keyword">struct</span> file *file, <span class="type">int</span> datasync)</span></span><br><span class="line">{</span><br><span class="line">	<span class="keyword">return</span> vfs_fsync_range(file, <span class="number">0</span>, LLONG_MAX, datasync);</span><br><span class="line">}</span><br><span class="line">EXPORT_SYMBOL(vfs_fsync);</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">do_fsync</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> fd, <span class="type">int</span> datasync)</span></span><br><span class="line">{</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fd</span> <span class="title">f</span> =</span> fdget(fd);</span><br><span class="line">	<span class="type">int</span> ret = -EBADF;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (f.file) {</span><br><span class="line">		ret = vfs_fsync(f.file, datasync);</span><br><span class="line">		fdput(f);</span><br><span class="line">	}</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">SYSCALL_DEFINE1(fsync, <span class="type">unsigned</span> <span class="type">int</span>, fd)</span><br><span class="line">{</span><br><span class="line">	<span class="keyword">return</span> do_fsync(fd, <span class="number">0</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">SYSCALL_DEFINE1(fdatasync, <span class="type">unsigned</span> <span class="type">int</span>, fd)</span><br><span class="line">{</span><br><span class="line">	<span class="keyword">return</span> do_fsync(fd, <span class="number">1</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p><code>fsync</code> å’Œ <code>fdatasync</code> ä¼šè°ƒç”¨æ–‡ä»¶ç³»ç»Ÿæ³¨å†Œçš„
<code>f_op-&gt;fsync()</code>
å‡½æ•°è¿›è¡Œè„é¡µçš„ä¸‹åˆ·ã€‚å¾ˆå¤šæ–‡ä»¶ç³»ç»Ÿä¼šä½¿ç”¨æˆ–è€…å‚è€ƒé€šç”¨çš„
<code>generic_file_fsync</code> æ¥å®ç°ï¼Œè¿™é‡Œé’ˆå¯¹
<code>__generic_file_fsync</code> è¿›è¡Œåˆ†æ</p>
<figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// fs/libfs.c</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * __generic_file_fsync - generic fsync implementation for simple filesystems</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @file:	file to synchronize</span></span><br><span class="line"><span class="comment"> * @start:	start offset in bytes</span></span><br><span class="line"><span class="comment"> * @end:	end offset in bytes (inclusive)</span></span><br><span class="line"><span class="comment"> * @datasync:	only synchronize essential metadata if true</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This is a generic implementation of the fsync method for simple</span></span><br><span class="line"><span class="comment"> * filesystems which track all non-inode metadata in the buffers list</span></span><br><span class="line"><span class="comment"> * hanging off the address_space structure.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> __generic_file_fsync(<span class="keyword">struct</span> file *file, <span class="type">loff_t</span> start, <span class="type">loff_t</span> end,</span><br><span class="line">				 <span class="type">int</span> datasync)</span><br><span class="line">{</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *<span class="title">inode</span> =</span> file-&gt;f_mapping-&gt;host;</span><br><span class="line">	<span class="type">int</span> err;</span><br><span class="line">	<span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">	err = file_write_and_wait_range(file, start, end);</span><br><span class="line">	<span class="keyword">if</span> (err)</span><br><span class="line">		<span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">	inode_lock(inode);</span><br><span class="line">	ret = sync_mapping_buffers(inode-&gt;i_mapping);</span><br><span class="line">	<span class="keyword">if</span> (!(inode-&gt;i_state &amp; I_DIRTY_ALL))</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line">	<span class="keyword">if</span> (datasync &amp;&amp; !(inode-&gt;i_state &amp; I_DIRTY_DATASYNC))</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">	err = sync_inode_metadata(inode, <span class="number">1</span>);</span><br><span class="line">	<span class="keyword">if</span> (ret == <span class="number">0</span>)</span><br><span class="line">		ret = err;</span><br><span class="line"></span><br><span class="line">out:</span><br><span class="line">	inode_unlock(inode);</span><br><span class="line">	<span class="comment">/* check and advance again to catch errors after syncing out buffers */</span></span><br><span class="line">	err = file_check_and_advance_wb_err(file);</span><br><span class="line">	<span class="keyword">if</span> (ret == <span class="number">0</span>)</span><br><span class="line">		ret = err;</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">}</span><br><span class="line">EXPORT_SYMBOL(__generic_file_fsync);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * generic_file_fsync - generic fsync implementation for simple filesystems</span></span><br><span class="line"><span class="comment"> *			with flush</span></span><br><span class="line"><span class="comment"> * @file:	file to synchronize</span></span><br><span class="line"><span class="comment"> * @start:	start offset in bytes</span></span><br><span class="line"><span class="comment"> * @end:	end offset in bytes (inclusive)</span></span><br><span class="line"><span class="comment"> * @datasync:	only synchronize essential metadata if true</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">generic_file_fsync</span><span class="params">(<span class="keyword">struct</span> file *file, <span class="type">loff_t</span> start, <span class="type">loff_t</span> end,</span></span><br><span class="line"><span class="params">		       <span class="type">int</span> datasync)</span></span><br><span class="line">{</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *<span class="title">inode</span> =</span> file-&gt;f_mapping-&gt;host;</span><br><span class="line">	<span class="type">int</span> err;</span><br><span class="line"></span><br><span class="line">	err = __generic_file_fsync(file, start, end, datasync);</span><br><span class="line">	<span class="keyword">if</span> (err)</span><br><span class="line">		<span class="keyword">return</span> err;</span><br><span class="line">	<span class="keyword">return</span> blkdev_issue_flush(inode-&gt;i_sb-&gt;s_bdev, GFP_KERNEL, <span class="literal">NULL</span>);</span><br><span class="line">}</span><br><span class="line">EXPORT_SYMBOL(generic_file_fsync);</span><br></pre></td></tr></tbody></table></figure>
<p>æ— è®º <code>fsync</code> è¿˜æ˜¯ <code>fdatasync</code> éƒ½ä¼šè°ƒç”¨
<code>file_write_and_wait_range</code> ä¸‹åˆ· page cache ä¸­çš„è„é¡µã€‚è€Œåœ¨
indoe æœ¬èº«å…ƒæ•°æ®åªæ˜¯æ—¶é—´æˆ³æ˜¯è„æ—¶ï¼Œ<code>fdatasync</code> å°±ä¼šè·³è¿‡
<code>sync_inode_metadata</code>ï¼Œä¸å°†å…ƒæ•°æ®ä¸€èµ·ä¸‹åˆ·åˆ°åº•å±‚è®¾å¤‡ä¸Šï¼›<code>fsync</code>
åˆ™ä¸ä¼šè·³è¿‡å…ƒæ•°æ®çš„ä¸‹åˆ·ã€‚</p>
<p>å› æ­¤ <code>fsync</code> è‡³å°‘éœ€è¦ä¸¤æ¬¡ IO å†™æ“ä½œï¼Œå¼€é”€æ¯”
<code>fdatasync</code> æ›´å¤§</p>
<h3 id="open-æ—¶å¸¦æœ‰-o_sync"><code>open</code> æ—¶å¸¦æœ‰
<code>O_SYNC</code></h3>
<p>å¦‚æœåœ¨æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶æ—¶å¸¦äº† <code>O_SYNC</code> æ ‡è®°ï¼Œåˆ™ä¼šåœ¨å†™å…¥ page
cache åï¼Œå†æ¬¡è°ƒç”¨ <code>vfs_fsync_range</code>
å°†æ•°æ®ä¸‹åˆ·åˆ°åº•å±‚è®¾å¤‡ä¸Š</p>
<pre class="mermaid">graph LR
writeç³»ç»Ÿè°ƒç”¨ --&gt; ksys_write --&gt; vfs_write --&gt; __vfs_write --&gt;|ext4,f2fsç­‰æ–‡ä»¶ç³»ç»Ÿ| new_sync_write</pre>
<p>åœ¨ <code>ext4</code>ã€<code>f2fs</code> ç­‰æ–‡ä»¶ç³»ç»Ÿ <code>write</code>
ç³»ç»Ÿè°ƒç”¨ä¼šä½¿ç”¨ <code>new_sync_write</code> æ¥è°ƒç”¨å®é™…æ–‡ä»¶ç³»ç»Ÿæ³¨å†Œçš„
<code>read_iter</code> å‡½æ•°</p>
<p>è€Œ <code>new_sync_write</code> è°ƒç”¨å…ˆè°ƒç”¨ <code>iocb_flags</code>
å°†ç”¨æˆ·é…ç½®çš„ <code>O_SYNC</code> è¿›è¡Œè§£æï¼Œä¸º <code>struct kiocb</code>
çš„ <code>ki_flags</code> å­—æ®µç”Ÿæˆæ ‡è®°</p>
<pre class="mermaid">graph TD
new_sync_write --&gt; init_sync_kiocb --&gt; iocb_flags
new_sync_write --&gt; iov_iter_init
new_sync_write --&gt; call_write_iter</pre>
<p>å’Œä¹‹å‰ä¸€æ ·ï¼Œå¤§å¤šæ•°æ–‡ä»¶ç³»ç»Ÿä¼šç›´æ¥ä½¿ç”¨æˆ–è€…å‚è€ƒé€šç”¨çš„
<code>generic_file_write_iter</code> æ¥å®ç° <code>read_iter</code>
å‡½æ•°ï¼Œè¿™é‡Œé’ˆå¯¹ <code>generic_file_write_iter</code> è¿›è¡Œåˆ†æ</p>
<figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// mm/filemap.c</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * generic_file_write_iter - write data to a file</span></span><br><span class="line"><span class="comment"> * @iocb:	IO state structure</span></span><br><span class="line"><span class="comment"> * @from:	iov_iter with data to write</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This is a wrapper around __generic_file_write_iter() to be used by most</span></span><br><span class="line"><span class="comment"> * filesystems. It takes care of syncing the file in case of O_SYNC file</span></span><br><span class="line"><span class="comment"> * and acquires i_mutex as needed.</span></span><br><span class="line"><span class="comment"> * Return:</span></span><br><span class="line"><span class="comment"> * * negative error code if no data has been written at all of</span></span><br><span class="line"><span class="comment"> *   vfs_fsync_range() failed for a synchronous write</span></span><br><span class="line"><span class="comment"> * * number of bytes written, even for truncated writes</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">generic_file_write_iter</span><span class="params">(<span class="keyword">struct</span> kiocb *iocb, <span class="keyword">struct</span> iov_iter *from)</span></span><br><span class="line">{</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">file</span> =</span> iocb-&gt;ki_filp;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *<span class="title">inode</span> =</span> file-&gt;f_mapping-&gt;host;</span><br><span class="line">	<span class="type">ssize_t</span> ret;</span><br><span class="line"></span><br><span class="line">	inode_lock(inode);</span><br><span class="line">	ret = generic_write_checks(iocb, from);</span><br><span class="line">	<span class="keyword">if</span> (ret &gt; <span class="number">0</span>)</span><br><span class="line">		ret = __generic_file_write_iter(iocb, from);</span><br><span class="line">	inode_unlock(inode);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (ret &gt; <span class="number">0</span>)</span><br><span class="line">		ret = generic_write_sync(iocb, ret);</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">}</span><br><span class="line">EXPORT_SYMBOL(generic_file_write_iter);</span><br></pre></td></tr></tbody></table></figure>
<p>åœ¨ <code>__generic_file_write_iter</code>
å®Œæˆä¹‹åï¼Œå®é™…çš„æ•°æ®å·²ç»è¢«å†™å…¥ page cacheï¼Œä¹‹åä¼šè°ƒç”¨
<code>generic_write_sync</code> ä¼šå°†åˆšåˆšå†™å…¥ page cache çš„æ•°æ®é€šè¿‡
<code>vfs_fsync_range</code> ä¸‹åˆ·åˆ°åº•å±‚è®¾å¤‡ä¸Š</p>
<figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// include/linux/fs.h</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Sync the bytes written if this was a synchronous write.  Expect ki_pos</span></span><br><span class="line"><span class="comment"> * to already be updated for the write, and will return either the amount</span></span><br><span class="line"><span class="comment"> * of bytes passed in, or an error if syncing the file failed.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">ssize_t</span> <span class="title function_">generic_write_sync</span><span class="params">(<span class="keyword">struct</span> kiocb *iocb, <span class="type">ssize_t</span> count)</span></span><br><span class="line">{</span><br><span class="line">	<span class="keyword">if</span> (iocb-&gt;ki_flags &amp; IOCB_DSYNC) {</span><br><span class="line">		<span class="type">int</span> ret = vfs_fsync_range(iocb-&gt;ki_filp,</span><br><span class="line">				iocb-&gt;ki_pos - count, iocb-&gt;ki_pos - <span class="number">1</span>,</span><br><span class="line">				(iocb-&gt;ki_flags &amp; IOCB_SYNC) ? <span class="number">0</span> : <span class="number">1</span>);</span><br><span class="line">		<span class="keyword">if</span> (ret)</span><br><span class="line">			<span class="keyword">return</span> ret;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> count;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h2>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2phc29uYWN0aW9ucy9hcnRpY2xlL2RldGFpbHMvMTE3MjkyMjMz">ã€CSDNã€‘VFS
åŸºç¡€å­¦ä¹ ç¬”è®° - 7. page cache å›å†™<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTE2NDk0MDAvYXJ0aWNsZS9kZXRhaWxzLzk2NTA1NjAw">ã€CSDNã€‘VFS
æºç åˆ†æ - Page Cache Writeback è„é¡µå›å†™æœºåˆ¶<i class="fa fa-external-link-alt"></i></span></li>
<li>ä»¥åŠåœ¨è¯„è®ºåŒºçš„æŸä½ä¸æ„¿é€éœ²å§“åçš„ dalao çš„ç¬”è®°</li>
</ul>
]]></content>
      <categories>
        <category>å­˜å‚¨</category>
        <category>IO</category>
      </categories>
      <tags>
        <tag>kernel</tag>
        <tag>buffer IO</tag>
        <tag>page cache</tag>
        <tag>writeback</tag>
      </tags>
  </entry>
  <entry>
    <title>rm -r ä¸ rmdir åŒºåˆ«</title>
    <url>/posts/935ae1f0.html</url>
    <content><![CDATA[<h2 id="èƒŒæ™¯">èƒŒæ™¯</h2>
<p>ä»Šå¤©å­¦å¼Ÿåœ¨ä½¿ç”¨ NVMe-over-TCP æ—¶å‘ç°æ— æ³•å¸è½½ <code>nvmet</code>
é©±åŠ¨ï¼Œæ˜¾ç¤ºä½¿ç”¨ä¸­</p>
<p>åœ¨ä¸€èµ·æ¢è®¨å’Œæµ‹è¯•ä¸­å‘ç°æœ€ç»ˆçš„åŸå› ç«Ÿç„¶åœ¨äº <code>rm -r</code> å’Œ
<code>rmdir</code> è¿™ä¸¤ä¸ªå‘½ä»¤ä¸Š <span id="more"></span></p>
<h2 id="äºŒè€…åŒºåˆ«">äºŒè€…åŒºåˆ«</h2>
<table>
<colgroup>
<col style="width: 9%">
<col style="width: 59%">
<col style="width: 30%">
</colgroup>
<thead>
<tr class="header">
<th>å‘½ä»¤</th>
<th>ä¸»è¦ç³»ç»Ÿè°ƒç”¨</th>
<th>æ“ä½œå¯¹è±¡</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>rmdir</code></td>
<td><code>rmdir</code></td>
<td>ä»…ç›®å½•</td>
</tr>
<tr class="even">
<td><code>rm -r</code></td>
<td><code>openat</code>, <code>getdents64</code>, <code>close</code>,
<code>unlinkat</code></td>
<td>ç›®å½•ï¼Œä»¥åŠç›®å½•æ‰€æœ‰æ–‡ä»¶</td>
</tr>
</tbody>
</table>
<h3 id="rmdir"><code>rmdir</code></h3>
<p><code>rmdir</code> ç›´æ¥è°ƒç”¨ <code>rmdir</code>
æ¥åˆ é™¤ç›®å½•ï¼Œå¦‚æœç›®å½•éç©ºï¼Œåˆ™ä¼šåˆ é™¤å¤±è´¥</p>
<h3 id="rm--r"><code>rm -r</code></h3>
<ol type="1">
<li>ä¼šå…ˆç”¨ <code>openat</code> æ‰“å¼€ç›®å½•ï¼Œé€šè¿‡ <code>getdents64</code>
è·å–ç›®å½•ä¸­çš„å†…å®¹ï¼Œç„¶å <code>close</code> ç›®å½•</li>
<li>å†ç¬¬äºŒæ¬¡åŠ ä¸Š <code>O_CLOEXEC</code> æ ‡è®° <code>openat</code>
æ‰“å¼€ç›®å½•ï¼Œè¡¨æ˜å½“å‰ç›®å½•å³å°†åˆ é™¤ï¼Œå†æ¬¡é€šè¿‡ <code>getdents64</code>
è·å–ç›®å½•ä¸­çš„å†…å®¹ï¼Œç„¶å <code>close</code> ç›®å½•</li>
<li>ç„¶åä¾æ¬¡é€šè¿‡ <code>unlinkat</code> åˆ é™¤ç›®å½•ä¸­çš„å†…å®¹</li>
<li>æœ€åé€šè¿‡ <code>unlinkat</code> åˆ é™¤ç›®å½•</li>
</ol>
<h3 id="rm--rf"><code>rm -rf</code></h3>
<p>ä½†æ˜¯å¦‚æœä½¿ç”¨çš„æ˜¯ <code>rm -rf</code>ï¼Œå¹¶ä¸”åœ¨ç¬¬ 3
æ­¥åˆ é™¤ç›®å½•å†…æ–‡ä»¶å¤±è´¥æ—¶ï¼Œåˆ™ä¼šè·³è¿‡ç¬¬ 4
æ­¥ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸ä¼šå†å¯¹ç›®å½•åšä»»ä½•æ“ä½œ</p>
<h2 id="æµ‹è¯•è¿‡ç¨‹">æµ‹è¯•è¿‡ç¨‹</h2>
<h3 id="é…ç½®ç¯å¢ƒ">é…ç½®ç¯å¢ƒ</h3>
<p>é¦–å…ˆå»ºç«‹ä¸€ä¸ªéç©ºç›®å½•ï¼Œå¹¶ä¸”ç»™ç›®å½•ä¸­çš„æ–‡ä»¶é…ç½®æƒé™ï¼Œç¦æ­¢åˆ é™¤æ–‡ä»¶</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> <span class="built_in">dir</span></span><br><span class="line"><span class="built_in">touch</span> <span class="built_in">dir</span>/file</span><br><span class="line">sudo chattr +i <span class="built_in">dir</span>/file</span><br></pre></td></tr></tbody></table></figure>
<p>æ­¤æ—¶ç›®å½•æ ‘å¦‚ä¸‹</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ tree <span class="built_in">dir</span></span><br><span class="line"><span class="built_in">dir</span></span><br><span class="line">â””â”€â”€ file</span><br><span class="line"></span><br><span class="line">0 directories, 1 file</span><br></pre></td></tr></tbody></table></figure>
<h3 id="rmdir-1"><code>rmdir</code></h3>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ strace -o <span class="built_in">rmdir</span> <span class="built_in">rmdir</span> <span class="built_in">dir</span>/</span><br><span class="line"><span class="built_in">rmdir</span>: failed to remove <span class="string">'dir/'</span>: Directory not empty</span><br></pre></td></tr></tbody></table></figure>
<p><code>strace</code> æŠ“åˆ°çš„å†…å®¹å¦‚ä¸‹ï¼Œä¸»è¦å†…å®¹åœ¨ç¬¬ 37 è¡Œ</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">execve("/usr/bin/rmdir", ["rmdir", "dir/"], 0x7ffe38ddae38 /* 26 vars */) = 0</span><br><span class="line">brk(NULL)                               = 0x561e92b83000</span><br><span class="line">arch_prctl(0x3001 /* ARCH_??? */, 0x7fff06684960) = -1 EINVAL (Invalid argument)</span><br><span class="line">access("/etc/ld.so.preload", R_OK)      = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, "/etc/ld.so.cache", O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">fstat(3, {st_mode=S_IFREG|0644, st_size=46019, ...}) = 0</span><br><span class="line">mmap(NULL, 46019, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7f51af80c000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">openat(AT_FDCWD, "/lib/x86_64-linux-gnu/libc.so.6", O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">read(3, "\177ELF\2\1\1\3\0\0\0\0\0\0\0\0\3\0&gt;\0\1\0\0\0\360q\2\0\0\0\0\0"..., 832) = 832</span><br><span class="line">pread64(3, "\6\0\0\0\4\0\0\0@\0\0\0\0\0\0\0@\0\0\0\0\0\0\0@\0\0\0\0\0\0\0"..., 784, 64) = 784</span><br><span class="line">pread64(3, "\4\0\0\0\20\0\0\0\5\0\0\0GNU\0\2\0\0\300\4\0\0\0\3\0\0\0\0\0\0\0", 32, 848) = 32</span><br><span class="line">pread64(3, "\4\0\0\0\24\0\0\0\3\0\0\0GNU\0\t\233\222%\274\260\320\31\331\326\10\204\276X&gt;\263"..., 68, 880) = 68</span><br><span class="line">fstat(3, {st_mode=S_IFREG|0755, st_size=2029224, ...}) = 0</span><br><span class="line">mmap(NULL, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7f51af80a000</span><br><span class="line">pread64(3, "\6\0\0\0\4\0\0\0@\0\0\0\0\0\0\0@\0\0\0\0\0\0\0@\0\0\0\0\0\0\0"..., 784, 64) = 784</span><br><span class="line">pread64(3, "\4\0\0\0\20\0\0\0\5\0\0\0GNU\0\2\0\0\300\4\0\0\0\3\0\0\0\0\0\0\0", 32, 848) = 32</span><br><span class="line">pread64(3, "\4\0\0\0\24\0\0\0\3\0\0\0GNU\0\t\233\222%\274\260\320\31\331\326\10\204\276X&gt;\263"..., 68, 880) = 68</span><br><span class="line">mmap(NULL, 2036952, PROT_READ, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0x7f51af618000</span><br><span class="line">mprotect(0x7f51af63d000, 1847296, PROT_NONE) = 0</span><br><span class="line">mmap(0x7f51af63d000, 1540096, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x25000) = 0x7f51af63d000</span><br><span class="line">mmap(0x7f51af7b5000, 303104, PROT_READ, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x19d000) = 0x7f51af7b5000</span><br><span class="line">mmap(0x7f51af800000, 24576, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x1e7000) = 0x7f51af800000</span><br><span class="line">mmap(0x7f51af806000, 13528, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_ANONYMOUS, -1, 0) = 0x7f51af806000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">arch_prctl(ARCH_SET_FS, 0x7f51af80b580) = 0</span><br><span class="line">mprotect(0x7f51af800000, 12288, PROT_READ) = 0</span><br><span class="line">mprotect(0x561e91688000, 4096, PROT_READ) = 0</span><br><span class="line">mprotect(0x7f51af845000, 4096, PROT_READ) = 0</span><br><span class="line">munmap(0x7f51af80c000, 46019)           = 0</span><br><span class="line">brk(NULL)                               = 0x561e92b83000</span><br><span class="line">brk(0x561e92ba4000)                     = 0x561e92ba4000</span><br><span class="line">openat(AT_FDCWD, "/usr/lib/locale/locale-archive", O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">fstat(3, {st_mode=S_IFREG|0644, st_size=3035952, ...}) = 0</span><br><span class="line">mmap(NULL, 3035952, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7f51af332000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">rmdir("dir/")                           = -1 ENOTEMPTY (Directory not empty)</span><br><span class="line">openat(AT_FDCWD, "/usr/share/locale/locale.alias", O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">fstat(3, {st_mode=S_IFREG|0644, st_size=2996, ...}) = 0</span><br><span class="line">read(3, "# Locale name alias data base.\n#"..., 4096) = 2996</span><br><span class="line">read(3, "", 4096)                       = 0</span><br><span class="line">close(3)                                = 0</span><br><span class="line">openat(AT_FDCWD, "/usr/share/locale/en_US.UTF-8/LC_MESSAGES/coreutils.mo", O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, "/usr/share/locale/en_US.utf8/LC_MESSAGES/coreutils.mo", O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, "/usr/share/locale/en_US/LC_MESSAGES/coreutils.mo", O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, "/usr/share/locale/en.UTF-8/LC_MESSAGES/coreutils.mo", O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, "/usr/share/locale/en.utf8/LC_MESSAGES/coreutils.mo", O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, "/usr/share/locale/en/LC_MESSAGES/coreutils.mo", O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, "/usr/share/locale-langpack/en_US.UTF-8/LC_MESSAGES/coreutils.mo", O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, "/usr/share/locale-langpack/en_US.utf8/LC_MESSAGES/coreutils.mo", O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, "/usr/share/locale-langpack/en_US/LC_MESSAGES/coreutils.mo", O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, "/usr/share/locale-langpack/en.UTF-8/LC_MESSAGES/coreutils.mo", O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, "/usr/share/locale-langpack/en.utf8/LC_MESSAGES/coreutils.mo", O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, "/usr/share/locale-langpack/en/LC_MESSAGES/coreutils.mo", O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">write(2, "rmdir: ", 7)                  = 7</span><br><span class="line">write(2, "failed to remove 'dir/'", 23) = 23</span><br><span class="line">openat(AT_FDCWD, "/usr/share/locale/en_US.UTF-8/LC_MESSAGES/libc.mo", O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, "/usr/share/locale/en_US.utf8/LC_MESSAGES/libc.mo", O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, "/usr/share/locale/en_US/LC_MESSAGES/libc.mo", O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, "/usr/share/locale/en.UTF-8/LC_MESSAGES/libc.mo", O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, "/usr/share/locale/en.utf8/LC_MESSAGES/libc.mo", O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, "/usr/share/locale/en/LC_MESSAGES/libc.mo", O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, "/usr/share/locale-langpack/en_US.UTF-8/LC_MESSAGES/libc.mo", O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, "/usr/share/locale-langpack/en_US.utf8/LC_MESSAGES/libc.mo", O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, "/usr/share/locale-langpack/en_US/LC_MESSAGES/libc.mo", O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, "/usr/share/locale-langpack/en.UTF-8/LC_MESSAGES/libc.mo", O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, "/usr/share/locale-langpack/en.utf8/LC_MESSAGES/libc.mo", O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, "/usr/share/locale-langpack/en/LC_MESSAGES/libc.mo", O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">write(2, ": Directory not empty", 21)   = 21</span><br><span class="line">write(2, "\n", 1)                       = 1</span><br><span class="line">close(1)                                = 0</span><br><span class="line">close(2)                                = 0</span><br><span class="line">exit_group(1)                           = ?</span><br><span class="line">+++ exited with 1 +++</span><br></pre></td></tr></tbody></table></figure>
<h3 id="rm--r-1"><code>rm -r</code></h3>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ strace -o rm_r_fail.strace <span class="built_in">rm</span> -r <span class="built_in">dir</span>/</span><br><span class="line"><span class="built_in">rm</span>: cannot remove <span class="string">'dir/file'</span>: Operation not permitted</span><br><span class="line"><span class="built_in">rm</span>: cannot remove <span class="string">'dir/'</span>: Directory not empty</span><br></pre></td></tr></tbody></table></figure>
<p><code>strace</code> æŠ“åˆ°çš„å†…å®¹å¦‚ä¸‹ï¼Œä¸»è¦å†…å®¹åœ¨ç¬¬ 39-59 ä»¥åŠ 94-96
è¡Œ</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">execve("/usr/bin/rm", ["rm", "-r", "dir/"], 0x7ffc2c0fb640 /* 26 vars */) = 0</span><br><span class="line">brk(NULL)                               = 0x56082871e000</span><br><span class="line">arch_prctl(0x3001 /* ARCH_??? */, 0x7ffd0d910cf0) = -1 EINVAL (Invalid argument)</span><br><span class="line">access("/etc/ld.so.preload", R_OK)      = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, "/etc/ld.so.cache", O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">fstat(3, {st_mode=S_IFREG|0644, st_size=46019, ...}) = 0</span><br><span class="line">mmap(NULL, 46019, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7f65c441d000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">openat(AT_FDCWD, "/lib/x86_64-linux-gnu/libc.so.6", O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">read(3, "\177ELF\2\1\1\3\0\0\0\0\0\0\0\0\3\0&gt;\0\1\0\0\0\360q\2\0\0\0\0\0"..., 832) = 832</span><br><span class="line">pread64(3, "\6\0\0\0\4\0\0\0@\0\0\0\0\0\0\0@\0\0\0\0\0\0\0@\0\0\0\0\0\0\0"..., 784, 64) = 784</span><br><span class="line">pread64(3, "\4\0\0\0\20\0\0\0\5\0\0\0GNU\0\2\0\0\300\4\0\0\0\3\0\0\0\0\0\0\0", 32, 848) = 32</span><br><span class="line">pread64(3, "\4\0\0\0\24\0\0\0\3\0\0\0GNU\0\t\233\222%\274\260\320\31\331\326\10\204\276X&gt;\263"..., 68, 880) = 68</span><br><span class="line">fstat(3, {st_mode=S_IFREG|0755, st_size=2029224, ...}) = 0</span><br><span class="line">mmap(NULL, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7f65c441b000</span><br><span class="line">pread64(3, "\6\0\0\0\4\0\0\0@\0\0\0\0\0\0\0@\0\0\0\0\0\0\0@\0\0\0\0\0\0\0"..., 784, 64) = 784</span><br><span class="line">pread64(3, "\4\0\0\0\20\0\0\0\5\0\0\0GNU\0\2\0\0\300\4\0\0\0\3\0\0\0\0\0\0\0", 32, 848) = 32</span><br><span class="line">pread64(3, "\4\0\0\0\24\0\0\0\3\0\0\0GNU\0\t\233\222%\274\260\320\31\331\326\10\204\276X&gt;\263"..., 68, 880) = 68</span><br><span class="line">mmap(NULL, 2036952, PROT_READ, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0x7f65c4229000</span><br><span class="line">mprotect(0x7f65c424e000, 1847296, PROT_NONE) = 0</span><br><span class="line">mmap(0x7f65c424e000, 1540096, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x25000) = 0x7f65c424e000</span><br><span class="line">mmap(0x7f65c43c6000, 303104, PROT_READ, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x19d000) = 0x7f65c43c6000</span><br><span class="line">mmap(0x7f65c4411000, 24576, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x1e7000) = 0x7f65c4411000</span><br><span class="line">mmap(0x7f65c4417000, 13528, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_ANONYMOUS, -1, 0) = 0x7f65c4417000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">arch_prctl(ARCH_SET_FS, 0x7f65c441c580) = 0</span><br><span class="line">mprotect(0x7f65c4411000, 12288, PROT_READ) = 0</span><br><span class="line">mprotect(0x560827bb0000, 4096, PROT_READ) = 0</span><br><span class="line">mprotect(0x7f65c4456000, 4096, PROT_READ) = 0</span><br><span class="line">munmap(0x7f65c441d000, 46019)           = 0</span><br><span class="line">brk(NULL)                               = 0x56082871e000</span><br><span class="line">brk(0x56082873f000)                     = 0x56082873f000</span><br><span class="line">openat(AT_FDCWD, "/usr/lib/locale/locale-archive", O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">fstat(3, {st_mode=S_IFREG|0644, st_size=3035952, ...}) = 0</span><br><span class="line">mmap(NULL, 3035952, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7f65c3f43000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">ioctl(0, TCGETS, {B38400 opost isig icanon echo ...}) = 0</span><br><span class="line">lstat("/", {st_mode=S_IFDIR|0755, st_size=4096, ...}) = 0</span><br><span class="line">newfstatat(AT_FDCWD, "dir/", {st_mode=S_IFDIR|0775, st_size=4096, ...}, AT_SYMLINK_NOFOLLOW) = 0</span><br><span class="line">openat(AT_FDCWD, "dir/", O_RDONLY|O_NOCTTY|O_NONBLOCK|O_NOFOLLOW|O_DIRECTORY) = 3</span><br><span class="line">fstat(3, {st_mode=S_IFDIR|0775, st_size=4096, ...}) = 0</span><br><span class="line">fcntl(3, F_GETFL)                       = 0x38800 (flags O_RDONLY|O_NONBLOCK|O_LARGEFILE|O_NOFOLLOW|O_DIRECTORY)</span><br><span class="line">fcntl(3, F_SETFD, FD_CLOEXEC)           = 0</span><br><span class="line">getdents64(3, /* 3 entries */, 32768)   = 72</span><br><span class="line">close(3)                                = 0</span><br><span class="line">geteuid()                               = 1000</span><br><span class="line">newfstatat(AT_FDCWD, "dir/", {st_mode=S_IFDIR|0775, st_size=4096, ...}, AT_SYMLINK_NOFOLLOW) = 0</span><br><span class="line">faccessat(AT_FDCWD, "dir/", W_OK)       = 0</span><br><span class="line">openat(AT_FDCWD, "dir/", O_RDONLY|O_NOCTTY|O_NONBLOCK|O_NOFOLLOW|O_CLOEXEC|O_DIRECTORY) = 3</span><br><span class="line">fstat(3, {st_mode=S_IFDIR|0775, st_size=4096, ...}) = 0</span><br><span class="line">fcntl(3, F_GETFL)                       = 0x38800 (flags O_RDONLY|O_NONBLOCK|O_LARGEFILE|O_NOFOLLOW|O_DIRECTORY)</span><br><span class="line">fcntl(3, F_SETFD, FD_CLOEXEC)           = 0</span><br><span class="line">fstatfs(3, {f_type=EXT2_SUPER_MAGIC, f_bsize=4096, f_blocks=20510566, f_bfree=15993067, f_bavail=14940434, f_files=5242880, f_ffree=5074130, f_fsid={val=[3258576323, 2412010735]}, f_namelen=255, f_frsize=4096, f_flags=ST_VALID|ST_RELATIME}) = 0</span><br><span class="line">fcntl(3, F_DUPFD_CLOEXEC, 3)            = 4</span><br><span class="line">getdents64(3, /* 3 entries */, 32768)   = 72</span><br><span class="line">getdents64(3, /* 0 entries */, 32768)   = 0</span><br><span class="line">close(3)                                = 0</span><br><span class="line">newfstatat(4, "file", {st_mode=S_IFREG|0664, st_size=0, ...}, AT_SYMLINK_NOFOLLOW) = 0</span><br><span class="line">faccessat(4, "file", W_OK)              = -1 EPERM (Operation not permitted)</span><br><span class="line">openat(AT_FDCWD, "/usr/share/locale/locale.alias", O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">fstat(3, {st_mode=S_IFREG|0644, st_size=2996, ...}) = 0</span><br><span class="line">read(3, "# Locale name alias data base.\n#"..., 4096) = 2996</span><br><span class="line">read(3, "", 4096)                       = 0</span><br><span class="line">close(3)                                = 0</span><br><span class="line">openat(AT_FDCWD, "/usr/share/locale/en_US.UTF-8/LC_MESSAGES/coreutils.mo", O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, "/usr/share/locale/en_US.utf8/LC_MESSAGES/coreutils.mo", O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, "/usr/share/locale/en_US/LC_MESSAGES/coreutils.mo", O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, "/usr/share/locale/en.UTF-8/LC_MESSAGES/coreutils.mo", O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, "/usr/share/locale/en.utf8/LC_MESSAGES/coreutils.mo", O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, "/usr/share/locale/en/LC_MESSAGES/coreutils.mo", O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, "/usr/share/locale-langpack/en_US.UTF-8/LC_MESSAGES/coreutils.mo", O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, "/usr/share/locale-langpack/en_US.utf8/LC_MESSAGES/coreutils.mo", O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, "/usr/share/locale-langpack/en_US/LC_MESSAGES/coreutils.mo", O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, "/usr/share/locale-langpack/en.UTF-8/LC_MESSAGES/coreutils.mo", O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, "/usr/share/locale-langpack/en.utf8/LC_MESSAGES/coreutils.mo", O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, "/usr/share/locale-langpack/en/LC_MESSAGES/coreutils.mo", O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">write(2, "rm: ", 4)                     = 4</span><br><span class="line">write(2, "cannot remove 'dir/file'", 24) = 24</span><br><span class="line">openat(AT_FDCWD, "/usr/share/locale/en_US.UTF-8/LC_MESSAGES/libc.mo", O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, "/usr/share/locale/en_US.utf8/LC_MESSAGES/libc.mo", O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, "/usr/share/locale/en_US/LC_MESSAGES/libc.mo", O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, "/usr/share/locale/en.UTF-8/LC_MESSAGES/libc.mo", O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, "/usr/share/locale/en.utf8/LC_MESSAGES/libc.mo", O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, "/usr/share/locale/en/LC_MESSAGES/libc.mo", O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, "/usr/share/locale-langpack/en_US.UTF-8/LC_MESSAGES/libc.mo", O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, "/usr/share/locale-langpack/en_US.utf8/LC_MESSAGES/libc.mo", O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, "/usr/share/locale-langpack/en_US/LC_MESSAGES/libc.mo", O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, "/usr/share/locale-langpack/en.UTF-8/LC_MESSAGES/libc.mo", O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, "/usr/share/locale-langpack/en.utf8/LC_MESSAGES/libc.mo", O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, "/usr/share/locale-langpack/en/LC_MESSAGES/libc.mo", O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">write(2, ": Operation not permitted", 25) = 25</span><br><span class="line">write(2, "\n", 1)                       = 1</span><br><span class="line">close(4)                                = 0</span><br><span class="line">newfstatat(AT_FDCWD, "dir/", {st_mode=S_IFDIR|0775, st_size=4096, ...}, AT_SYMLINK_NOFOLLOW) = 0</span><br><span class="line">faccessat(AT_FDCWD, "dir/", W_OK)       = 0</span><br><span class="line">unlinkat(AT_FDCWD, "dir/", AT_REMOVEDIR) = -1 ENOTEMPTY (Directory not empty)</span><br><span class="line">write(2, "rm: ", 4)                     = 4</span><br><span class="line">write(2, "cannot remove 'dir/'", 20)    = 20</span><br><span class="line">write(2, ": Directory not empty", 21)   = 21</span><br><span class="line">write(2, "\n", 1)                       = 1</span><br><span class="line">lseek(0, 0, SEEK_CUR)                   = -1 ESPIPE (Illegal seek)</span><br><span class="line">close(0)                                = 0</span><br><span class="line">close(1)                                = 0</span><br><span class="line">close(2)                                = 0</span><br><span class="line">exit_group(1)                           = ?</span><br><span class="line">+++ exited with 1 +++</span><br></pre></td></tr></tbody></table></figure>
<h3 id="rm--rf-1"><code>rm -rf</code></h3>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ strace -o rm_fail.strace <span class="built_in">rm</span> -rf <span class="built_in">dir</span>/</span><br><span class="line"><span class="built_in">rm</span>: cannot remove <span class="string">'dir/file'</span>: Operation not permitted</span><br></pre></td></tr></tbody></table></figure>
<p><code>strace</code> æŠ“åˆ°çš„å†…å®¹å¦‚ä¸‹ï¼Œä¸»è¦å†…å®¹åœ¨ç¬¬ 39-55 è¡Œ</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">execve("/usr/bin/rm", ["rm", "-rf", "dir/"], 0x7fff7bc99c20 /* 26 vars */) = 0</span><br><span class="line">brk(NULL)                               = 0x5566570fe000</span><br><span class="line">arch_prctl(0x3001 /* ARCH_??? */, 0x7ffde2720670) = -1 EINVAL (Invalid argument)</span><br><span class="line">access("/etc/ld.so.preload", R_OK)      = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, "/etc/ld.so.cache", O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">fstat(3, {st_mode=S_IFREG|0644, st_size=46019, ...}) = 0</span><br><span class="line">mmap(NULL, 46019, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7fcb89d87000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">openat(AT_FDCWD, "/lib/x86_64-linux-gnu/libc.so.6", O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">read(3, "\177ELF\2\1\1\3\0\0\0\0\0\0\0\0\3\0&gt;\0\1\0\0\0\360q\2\0\0\0\0\0"..., 832) = 832</span><br><span class="line">pread64(3, "\6\0\0\0\4\0\0\0@\0\0\0\0\0\0\0@\0\0\0\0\0\0\0@\0\0\0\0\0\0\0"..., 784, 64) = 784</span><br><span class="line">pread64(3, "\4\0\0\0\20\0\0\0\5\0\0\0GNU\0\2\0\0\300\4\0\0\0\3\0\0\0\0\0\0\0", 32, 848) = 32</span><br><span class="line">pread64(3, "\4\0\0\0\24\0\0\0\3\0\0\0GNU\0\t\233\222%\274\260\320\31\331\326\10\204\276X&gt;\263"..., 68, 880) = 68</span><br><span class="line">fstat(3, {st_mode=S_IFREG|0755, st_size=2029224, ...}) = 0</span><br><span class="line">mmap(NULL, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7fcb89d85000</span><br><span class="line">pread64(3, "\6\0\0\0\4\0\0\0@\0\0\0\0\0\0\0@\0\0\0\0\0\0\0@\0\0\0\0\0\0\0"..., 784, 64) = 784</span><br><span class="line">pread64(3, "\4\0\0\0\20\0\0\0\5\0\0\0GNU\0\2\0\0\300\4\0\0\0\3\0\0\0\0\0\0\0", 32, 848) = 32</span><br><span class="line">pread64(3, "\4\0\0\0\24\0\0\0\3\0\0\0GNU\0\t\233\222%\274\260\320\31\331\326\10\204\276X&gt;\263"..., 68, 880) = 68</span><br><span class="line">mmap(NULL, 2036952, PROT_READ, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0x7fcb89b93000</span><br><span class="line">mprotect(0x7fcb89bb8000, 1847296, PROT_NONE) = 0</span><br><span class="line">mmap(0x7fcb89bb8000, 1540096, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x25000) = 0x7fcb89bb8000</span><br><span class="line">mmap(0x7fcb89d30000, 303104, PROT_READ, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x19d000) = 0x7fcb89d30000</span><br><span class="line">mmap(0x7fcb89d7b000, 24576, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x1e7000) = 0x7fcb89d7b000</span><br><span class="line">mmap(0x7fcb89d81000, 13528, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_ANONYMOUS, -1, 0) = 0x7fcb89d81000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">arch_prctl(ARCH_SET_FS, 0x7fcb89d86580) = 0</span><br><span class="line">mprotect(0x7fcb89d7b000, 12288, PROT_READ) = 0</span><br><span class="line">mprotect(0x5566566dd000, 4096, PROT_READ) = 0</span><br><span class="line">mprotect(0x7fcb89dc0000, 4096, PROT_READ) = 0</span><br><span class="line">munmap(0x7fcb89d87000, 46019)           = 0</span><br><span class="line">brk(NULL)                               = 0x5566570fe000</span><br><span class="line">brk(0x55665711f000)                     = 0x55665711f000</span><br><span class="line">openat(AT_FDCWD, "/usr/lib/locale/locale-archive", O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">fstat(3, {st_mode=S_IFREG|0644, st_size=3035952, ...}) = 0</span><br><span class="line">mmap(NULL, 3035952, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7fcb898ad000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">ioctl(0, TCGETS, {B38400 opost isig icanon echo ...}) = 0</span><br><span class="line">lstat("/", {st_mode=S_IFDIR|0755, st_size=4096, ...}) = 0</span><br><span class="line">newfstatat(AT_FDCWD, "dir/", {st_mode=S_IFDIR|0775, st_size=4096, ...}, AT_SYMLINK_NOFOLLOW) = 0</span><br><span class="line">openat(AT_FDCWD, "dir/", O_RDONLY|O_NOCTTY|O_NONBLOCK|O_NOFOLLOW|O_DIRECTORY) = 3</span><br><span class="line">fstat(3, {st_mode=S_IFDIR|0775, st_size=4096, ...}) = 0</span><br><span class="line">fcntl(3, F_GETFL)                       = 0x38800 (flags O_RDONLY|O_NONBLOCK|O_LARGEFILE|O_NOFOLLOW|O_DIRECTORY)</span><br><span class="line">fcntl(3, F_SETFD, FD_CLOEXEC)           = 0</span><br><span class="line">getdents64(3, /* 3 entries */, 32768)   = 72</span><br><span class="line">close(3)                                = 0</span><br><span class="line">openat(AT_FDCWD, "dir/", O_RDONLY|O_NOCTTY|O_NONBLOCK|O_NOFOLLOW|O_CLOEXEC|O_DIRECTORY) = 3</span><br><span class="line">fstat(3, {st_mode=S_IFDIR|0775, st_size=4096, ...}) = 0</span><br><span class="line">fcntl(3, F_GETFL)                       = 0x38800 (flags O_RDONLY|O_NONBLOCK|O_LARGEFILE|O_NOFOLLOW|O_DIRECTORY)</span><br><span class="line">fcntl(3, F_SETFD, FD_CLOEXEC)           = 0</span><br><span class="line">fstatfs(3, {f_type=EXT2_SUPER_MAGIC, f_bsize=4096, f_blocks=20510566, f_bfree=15993067, f_bavail=14940434, f_files=5242880, f_ffree=5074130, f_fsid={val=[3258576323, 2412010735]}, f_namelen=255, f_frsize=4096, f_flags=ST_VALID|ST_RELATIME}) = 0</span><br><span class="line">fcntl(3, F_DUPFD_CLOEXEC, 3)            = 4</span><br><span class="line">getdents64(3, /* 3 entries */, 32768)   = 72</span><br><span class="line">getdents64(3, /* 0 entries */, 32768)   = 0</span><br><span class="line">close(3)                                = 0</span><br><span class="line">unlinkat(4, "file", 0)                  = -1 EPERM (Operation not permitted)</span><br><span class="line">openat(AT_FDCWD, "/usr/share/locale/locale.alias", O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">fstat(3, {st_mode=S_IFREG|0644, st_size=2996, ...}) = 0</span><br><span class="line">read(3, "# Locale name alias data base.\n#"..., 4096) = 2996</span><br><span class="line">read(3, "", 4096)                       = 0</span><br><span class="line">close(3)                                = 0</span><br><span class="line">openat(AT_FDCWD, "/usr/share/locale/en_US.UTF-8/LC_MESSAGES/coreutils.mo", O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, "/usr/share/locale/en_US.utf8/LC_MESSAGES/coreutils.mo", O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, "/usr/share/locale/en_US/LC_MESSAGES/coreutils.mo", O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, "/usr/share/locale/en.UTF-8/LC_MESSAGES/coreutils.mo", O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, "/usr/share/locale/en.utf8/LC_MESSAGES/coreutils.mo", O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, "/usr/share/locale/en/LC_MESSAGES/coreutils.mo", O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, "/usr/share/locale-langpack/en_US.UTF-8/LC_MESSAGES/coreutils.mo", O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, "/usr/share/locale-langpack/en_US.utf8/LC_MESSAGES/coreutils.mo", O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, "/usr/share/locale-langpack/en_US/LC_MESSAGES/coreutils.mo", O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, "/usr/share/locale-langpack/en.UTF-8/LC_MESSAGES/coreutils.mo", O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, "/usr/share/locale-langpack/en.utf8/LC_MESSAGES/coreutils.mo", O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, "/usr/share/locale-langpack/en/LC_MESSAGES/coreutils.mo", O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">write(2, "rm: ", 4)                     = 4</span><br><span class="line">write(2, "cannot remove 'dir/file'", 24) = 24</span><br><span class="line">openat(AT_FDCWD, "/usr/share/locale/en_US.UTF-8/LC_MESSAGES/libc.mo", O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, "/usr/share/locale/en_US.utf8/LC_MESSAGES/libc.mo", O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, "/usr/share/locale/en_US/LC_MESSAGES/libc.mo", O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, "/usr/share/locale/en.UTF-8/LC_MESSAGES/libc.mo", O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, "/usr/share/locale/en.utf8/LC_MESSAGES/libc.mo", O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, "/usr/share/locale/en/LC_MESSAGES/libc.mo", O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, "/usr/share/locale-langpack/en_US.UTF-8/LC_MESSAGES/libc.mo", O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, "/usr/share/locale-langpack/en_US.utf8/LC_MESSAGES/libc.mo", O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, "/usr/share/locale-langpack/en_US/LC_MESSAGES/libc.mo", O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, "/usr/share/locale-langpack/en.UTF-8/LC_MESSAGES/libc.mo", O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, "/usr/share/locale-langpack/en.utf8/LC_MESSAGES/libc.mo", O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, "/usr/share/locale-langpack/en/LC_MESSAGES/libc.mo", O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">write(2, ": Operation not permitted", 25) = 25</span><br><span class="line">write(2, "\n", 1)                       = 1</span><br><span class="line">close(4)                                = 0</span><br><span class="line">lseek(0, 0, SEEK_CUR)                   = -1 ESPIPE (Illegal seek)</span><br><span class="line">close(0)                                = 0</span><br><span class="line">close(1)                                = 0</span><br><span class="line">close(2)                                = 0</span><br><span class="line">exit_group(1)                           = ?</span><br><span class="line">+++ exited with 1 +++</span><br></pre></td></tr></tbody></table></figure>
<p>æœ€åå–æ¶ˆæ–‡ä»¶çš„æƒé™ï¼Œçœ‹ä¸€ä¸‹ <code>rm -rf</code> æˆåŠŸæ—¶çš„ç³»ç»Ÿè°ƒç”¨</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">sudo chattr -i <span class="built_in">dir</span>/file</span><br><span class="line">strace -o rm_rf_succ.strace <span class="built_in">rm</span> -rf <span class="built_in">dir</span>/</span><br></pre></td></tr></tbody></table></figure>
<p><code>strace</code> æŠ“åˆ°çš„å†…å®¹å¦‚ä¸‹ï¼Œä¸»è¦å†…å®¹åœ¨ç¬¬ 39-57 è¡Œ</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">execve("/usr/bin/rm", ["rm", "-rf", "dir/"], 0x7ffee56569a0 /* 26 vars */) = 0</span><br><span class="line">brk(NULL)                               = 0x55cc9fc1d000</span><br><span class="line">arch_prctl(0x3001 /* ARCH_??? */, 0x7ffec41c6210) = -1 EINVAL (Invalid argument)</span><br><span class="line">access("/etc/ld.so.preload", R_OK)      = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, "/etc/ld.so.cache", O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">fstat(3, {st_mode=S_IFREG|0644, st_size=46019, ...}) = 0</span><br><span class="line">mmap(NULL, 46019, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7f771df9d000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">openat(AT_FDCWD, "/lib/x86_64-linux-gnu/libc.so.6", O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">read(3, "\177ELF\2\1\1\3\0\0\0\0\0\0\0\0\3\0&gt;\0\1\0\0\0\360q\2\0\0\0\0\0"..., 832) = 832</span><br><span class="line">pread64(3, "\6\0\0\0\4\0\0\0@\0\0\0\0\0\0\0@\0\0\0\0\0\0\0@\0\0\0\0\0\0\0"..., 784, 64) = 784</span><br><span class="line">pread64(3, "\4\0\0\0\20\0\0\0\5\0\0\0GNU\0\2\0\0\300\4\0\0\0\3\0\0\0\0\0\0\0", 32, 848) = 32</span><br><span class="line">pread64(3, "\4\0\0\0\24\0\0\0\3\0\0\0GNU\0\t\233\222%\274\260\320\31\331\326\10\204\276X&gt;\263"..., 68, 880) = 68</span><br><span class="line">fstat(3, {st_mode=S_IFREG|0755, st_size=2029224, ...}) = 0</span><br><span class="line">mmap(NULL, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7f771df9b000</span><br><span class="line">pread64(3, "\6\0\0\0\4\0\0\0@\0\0\0\0\0\0\0@\0\0\0\0\0\0\0@\0\0\0\0\0\0\0"..., 784, 64) = 784</span><br><span class="line">pread64(3, "\4\0\0\0\20\0\0\0\5\0\0\0GNU\0\2\0\0\300\4\0\0\0\3\0\0\0\0\0\0\0", 32, 848) = 32</span><br><span class="line">pread64(3, "\4\0\0\0\24\0\0\0\3\0\0\0GNU\0\t\233\222%\274\260\320\31\331\326\10\204\276X&gt;\263"..., 68, 880) = 68</span><br><span class="line">mmap(NULL, 2036952, PROT_READ, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0x7f771dda9000</span><br><span class="line">mprotect(0x7f771ddce000, 1847296, PROT_NONE) = 0</span><br><span class="line">mmap(0x7f771ddce000, 1540096, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x25000) = 0x7f771ddce000</span><br><span class="line">mmap(0x7f771df46000, 303104, PROT_READ, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x19d000) = 0x7f771df46000</span><br><span class="line">mmap(0x7f771df91000, 24576, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x1e7000) = 0x7f771df91000</span><br><span class="line">mmap(0x7f771df97000, 13528, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_ANONYMOUS, -1, 0) = 0x7f771df97000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">arch_prctl(ARCH_SET_FS, 0x7f771df9c580) = 0</span><br><span class="line">mprotect(0x7f771df91000, 12288, PROT_READ) = 0</span><br><span class="line">mprotect(0x55cc9ec06000, 4096, PROT_READ) = 0</span><br><span class="line">mprotect(0x7f771dfd6000, 4096, PROT_READ) = 0</span><br><span class="line">munmap(0x7f771df9d000, 46019)           = 0</span><br><span class="line">brk(NULL)                               = 0x55cc9fc1d000</span><br><span class="line">brk(0x55cc9fc3e000)                     = 0x55cc9fc3e000</span><br><span class="line">openat(AT_FDCWD, "/usr/lib/locale/locale-archive", O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">fstat(3, {st_mode=S_IFREG|0644, st_size=3035952, ...}) = 0</span><br><span class="line">mmap(NULL, 3035952, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7f771dac3000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">ioctl(0, TCGETS, {B38400 opost isig icanon echo ...}) = 0</span><br><span class="line">lstat("/", {st_mode=S_IFDIR|0755, st_size=4096, ...}) = 0</span><br><span class="line">newfstatat(AT_FDCWD, "dir/", {st_mode=S_IFDIR|0775, st_size=4096, ...}, AT_SYMLINK_NOFOLLOW) = 0</span><br><span class="line">openat(AT_FDCWD, "dir/", O_RDONLY|O_NOCTTY|O_NONBLOCK|O_NOFOLLOW|O_DIRECTORY) = 3</span><br><span class="line">fstat(3, {st_mode=S_IFDIR|0775, st_size=4096, ...}) = 0</span><br><span class="line">fcntl(3, F_GETFL)                       = 0x38800 (flags O_RDONLY|O_NONBLOCK|O_LARGEFILE|O_NOFOLLOW|O_DIRECTORY)</span><br><span class="line">fcntl(3, F_SETFD, FD_CLOEXEC)           = 0</span><br><span class="line">getdents64(3, /* 3 entries */, 32768)   = 72</span><br><span class="line">close(3)                                = 0</span><br><span class="line">openat(AT_FDCWD, "dir/", O_RDONLY|O_NOCTTY|O_NONBLOCK|O_NOFOLLOW|O_CLOEXEC|O_DIRECTORY) = 3</span><br><span class="line">fstat(3, {st_mode=S_IFDIR|0775, st_size=4096, ...}) = 0</span><br><span class="line">fcntl(3, F_GETFL)                       = 0x38800 (flags O_RDONLY|O_NONBLOCK|O_LARGEFILE|O_NOFOLLOW|O_DIRECTORY)</span><br><span class="line">fcntl(3, F_SETFD, FD_CLOEXEC)           = 0</span><br><span class="line">fstatfs(3, {f_type=EXT2_SUPER_MAGIC, f_bsize=4096, f_blocks=20510566, f_bfree=15993064, f_bavail=14940431, f_files=5242880, f_ffree=5074129, f_fsid={val=[3258576323, 2412010735]}, f_namelen=255, f_frsize=4096, f_flags=ST_VALID|ST_RELATIME}) = 0</span><br><span class="line">fcntl(3, F_DUPFD_CLOEXEC, 3)            = 4</span><br><span class="line">getdents64(3, /* 3 entries */, 32768)   = 72</span><br><span class="line">getdents64(3, /* 0 entries */, 32768)   = 0</span><br><span class="line">close(3)                                = 0</span><br><span class="line">unlinkat(4, "file", 0)                  = 0</span><br><span class="line">close(4)                                = 0</span><br><span class="line">unlinkat(AT_FDCWD, "dir/", AT_REMOVEDIR) = 0</span><br><span class="line">lseek(0, 0, SEEK_CUR)                   = -1 ESPIPE (Illegal seek)</span><br><span class="line">close(0)                                = 0</span><br><span class="line">close(1)                                = 0</span><br><span class="line">close(2)                                = 0</span><br><span class="line">exit_group(0)                           = ?</span><br><span class="line">+++ exited with 0 +++</span><br></pre></td></tr></tbody></table></figure>
<h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h2>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9jb21tdW5pdHkubWVsbGFub3guY29tL3MvYXJ0aWNsZS9ob3d0by1jb25maWd1cmUtbnZtZS1vdmVyLWZhYnJpY3M=">ã€mellanox
ç¤¾åŒºã€‘HowTo Configure NVMe over Fabrics<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9vcGVuLnRlY2gycmVhbC5jb20vaW5mb19kZXRhaWxfcGFnZT9pZD0xODQ0MQ==">ã€ç¡¬è§ã€‘NVMe-oF
ä¸åªæ˜¯ RDMAï¼Œè¿˜æœ‰ TCP<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NvZGVkYW5jaW5nL2FydGljbGUvZGV0YWlscy8xMDM4MzUwODU=">ã€CSDNã€‘Linux
é˜²æ­¢æ–‡ä»¶å’Œç›®å½•è¢«æ„å¤–åˆ é™¤æˆ–ä¿®æ”¹<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9tYW43Lm9yZy9saW51eC9tYW4tcGFnZXMvbWFuMi9vcGVuLjIuaHRtbA==">ã€manã€‘open<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly91bml4LnN0YWNrZXhjaGFuZ2UuY29tL3F1ZXN0aW9ucy8xNTA5NjAvd2h5LWFyZS1ybWRpci1hbmQtdW5saW5rLXR3by1zZXBhcmF0ZS1zeXN0ZW0tY2FsbHM=">ã€stackexchangeã€‘Why
are rmdir and unlink two separate system calls?<i class="fa fa-external-link-alt"></i></span></li>
</ul>
]]></content>
      <categories>
        <category>Linux</category>
        <category>Shell</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>strace</tag>
      </tags>
  </entry>
  <entry>
    <title>å°ç±³ WR30U è§£é”å¹¶åˆ·æœº</title>
    <url>/posts/e6410576.html</url>
    <content><![CDATA[<p>æœ¬æ–‡ä¸»è¦è®°å½•ä¸ªäººå¯¹å°ç±³ WR30U è·¯ç”±å™¨çš„è§£é”å’Œåˆ·æœºè¿‡ç¨‹ï¼Œæ•´ä½“æ­¥éª¤ä¸ <a href="/posts/8507aaa1.html#ä¸€èˆ¬å®‰è£…æµç¨‹">ä¸€èˆ¬å®‰è£…æµç¨‹</a> ç±»ä¼¼ï¼Œä½†æ˜¯ç”±äº
WR30U çš„è§£é” <code>ssh</code>
å’Œåˆ·æœºçš„è¿‡ç¨‹ä¸­æœ‰ä¸€äº›ç»†èŠ‚éœ€è¦æ³¨æ„ï¼Œå› æ­¤è®°å½•ä¸€ä¸‹ <span id="more"></span></p>
<h2 id="è§£é”-ssh">è§£é” ssh</h2>
<h3 id="ç¯å¢ƒå‡†å¤‡">ç¯å¢ƒå‡†å¤‡</h3>
<p>éœ€è¦ä¸€å°<strong>åŒæ—¶å…·æœ‰ WiFi
å’Œæœ‰çº¿ç½‘ç»œ</strong>çš„ç”µè„‘ï¼Œä»¥åŠä¸€æ ¹ç½‘çº¿</p>
<p>ç„¶åéœ€è¦é…ç½® <code>python</code> ç¯å¢ƒï¼Œå¹¶ä¸”å®‰è£…
<code>pycryptodome</code> ä¾èµ–</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">conda create -n wr30u</span><br><span class="line">conda activate wr30u</span><br><span class="line">conda install pycryptodome</span><br></pre></td></tr></tbody></table></figure>
<p>ç„¶åæ˜¯è§£é”è„šæœ¬ï¼Œå¯ä»¥ç›´æ¥ä» <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL1BhdHJpY2lhTGVlMy93cjMwdV9zc2gvYmxvYi9tYWluL3NlcnZlcl9lbXVsYXRvci5weQ==">PatriciaLee3<i class="fa fa-external-link-alt"></i></span>
çš„ä»“åº“ä¸­ä¸‹è½½</p>
<h3 id="è§£é”è¿‡ç¨‹">è§£é”è¿‡ç¨‹</h3>
<p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL1BhdHJpY2lhTGVlMy93cjMwdV9zc2gvYmxvYi9tYWluL1JFQURNRS5tZA==">PatriciaLee3<i class="fa fa-external-link-alt"></i></span>
çš„ä»“åº“ä¸­å·²ç»ç»™å‡ºäº†è¯¦ç»†çš„è§£é”è¿‡ç¨‹ï¼Œè¿™é‡Œåªæ˜¯ç®€å•è®°å½•ä¸€ä¸‹</p>
<ol type="1">
<li><p>ç”µè„‘è¿æ¥åŸå‚å›ºä»¶çš„è·¯ç”±å™¨ï¼Œè¿›å…¥ 192.168.31.1
çš„ç®¡ç†åå°ï¼Œåœ¨å¸¸ç”¨è®¾ç½® - ä¸Šç½‘è®¾ç½®é‡Œåˆ†åˆ«è®¾ç½®ï¼š</p>
<ul>
<li>ä¸Šç½‘è®¾ç½® DHCPï¼Œè‡ªåŠ¨é…ç½® DNS</li>
<li> å¯åŠ¨ä¸æ™ºèƒ½ç½‘å…³æ— çº¿é…ç½®åŒæ­¥ï¼ˆä¼šé‡å¯ï¼‰</li>
<li>å›ºå®š WAN å£ä¸º 1ï¼ˆä¼šé‡å¯ï¼‰</li>
</ul></li>
<li><p>ç”µè„‘è¿æ¥æœ‰æ­£å¸¸ç½‘ç»œçš„ WiFiï¼Œç„¶åå°†ç½‘çº¿è¿æ¥åˆ°è·¯ç”±å™¨çš„ WAN
å£</p></li>
<li><p>æ‰“å¼€
<code>æ§åˆ¶é¢æ¿ - ç½‘ç»œå’Œ Internet - ç½‘ç»œå’Œå…±äº«ä¸­å¿ƒ - æ›´æ”¹é€‚é…å™¨è®¾ç½® - é€‰æ‹© WLAN - å³é”®å±æ€§ - å…±äº«</code>ï¼Œå‹¾é€‰ç¬¬ä¸€ä¸ªå¹¶ç¡®è®¤ï¼Œè¿™ä¸ªæ—¶å€™
WR30U ä¼šé€šè¿‡æœ‰çº¿è¿æ¥å…±äº«ç”µè„‘çš„ç½‘ç»œï¼Œå¹¶ä¸”ç½‘ç»œæŒ‡ç¤ºç¯ä¼šå˜æˆè“è‰²</p>
<figure>
<img data-src="/posts/e6410576/å…±äº«ç½‘ç»œ.png" alt="å…±äº«ç½‘ç»œ">
<figcaption aria-hidden="true">å…±äº«ç½‘ç»œ</figcaption>
</figure></li>
<li><p>æ‰“å¼€
<code>æ§åˆ¶é¢æ¿ - ç³»ç»Ÿå’Œå®‰å…¨ - Windows Defender é˜²ç«å¢™ - å¯åŠ¨æˆ–å…³é—­ Windows Defender é˜²ç«å¢™</code>ï¼Œå…³é—­
Windows Defender é˜²ç«å¢™</p>
<figure>
<img data-src="/posts/e6410576/å…³é—­é˜²ç«å¢™.png" alt="å…³é—­é˜²ç«å¢™">
<figcaption aria-hidden="true">å…³é—­é˜²ç«å¢™</figcaption>
</figure></li>
<li><p>è¿è¡Œè§£é”è„šæœ¬ï¼Œå¹¶æŒ‰ç…§è„šæœ¬æç¤ºæ“ä½œ</p>
<p></p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">conda activate wr30u</span><br><span class="line">python server_emulator.py</span><br></pre></td></tr></tbody></table></figure><p></p></li>
<li><p>è§£é”å®Œæˆåï¼Œè·¯ç”±å™¨çš„è´¦å·å¯†ç ä¸º <code>root</code> å’Œ
<code>admin</code>ï¼Œä¹‹åè®°å¾—é‡æ–°å¼€å¯é˜²ç«å¢™ï¼Œå¹¶ä¸”å…³é—­å…±äº«ç½‘ç»œ</p></li>
</ol>
<h2 id="åˆ·å…¥-mt798x-uboot">åˆ·å…¥ mt798x uboot</h2>
<h3 id="ç®€ä»‹">ç®€ä»‹</h3>
<p>è¿™é‡Œé¦–å…ˆæ¨èåˆ·å…¥ hanwckf çš„ <span class="exturl" data-url="aHR0cHM6Ly9jbWkuaGFud2NrZi50b3AvcC9tdDc5OHgtdWJvb3QtdXNhZ2U=">mt798x
uboot<i class="fa fa-external-link-alt"></i></span>ï¼Œè¿™ä¸ª uboot æœ‰å¾ˆå¤šåŠŸèƒ½ï¼Œå…¶ä¸­ä»¥ä¸‹ä¸¤ç‚¹éå¸¸å®ç”¨ï¼š</p>
<ul>
<li>ã€ä½¿ç”¨æ–¹ä¾¿ã€‘è‡ªå¸¦ MTK åŸå‚å¼€å‘çš„ç®€æ˜“ WebUI æ¢å¤ç•Œé¢ï¼Œå¯ä»¥é€šè¿‡ WebUI
ç›´æ¥åˆ·å…¥å›ºä»¶æˆ–è€…æ›´æ–° uboot</li>
<li>ã€å…¼å®¹æ€§å¥½ã€‘æ”¯æŒå¤šç§ Flash åˆ†åŒºå¸ƒå±€åˆ‡æ¢åŠŸèƒ½ï¼ˆä»…æ”¯æŒ
spi-nandï¼‰ï¼Œå¯ä»¥åœ¨ WebUI ä¸­åˆ‡æ¢ä¸åŒçš„åˆ†åŒºå¸ƒå±€ï¼Œå®Œç¾å…¼å®¹å°ç±³åŸå‚å›ºä»¶</li>
</ul>
<h3 id="åˆ·å…¥æµç¨‹">åˆ·å…¥æµç¨‹</h3>
<ol type="1">
<li><p>ç”µè„‘æ¥å…¥æ­£å¸¸ç½‘ç»œï¼Œç„¶åå» hanwckf çš„ä»“åº“ release é¡µé¢ä¸‹è½½å¯¹åº”çš„
uboot æ–‡ä»¶ï¼š<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2hhbndja2YvYmwtbXQ3OTh4L3JlbGVhc2Vz">mt7981_wr30u-fip-fixed-parts-multi-layout.bin<i class="fa fa-external-link-alt"></i></span></p></li>
<li><p>ç”µè„‘æ¥å…¥è·¯ç”±å™¨ç½‘ç»œï¼Œé€šè¿‡ <code>scp</code> å°† uboot
ä¼ åˆ°è·¯ç”±å™¨ä¸Š</p>
<p></p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">scp mt7981_wr30u-fip-fixed-parts-multi-layout.bin root@192.168.31.1:/tmp</span><br></pre></td></tr></tbody></table></figure><p></p></li>
<li><p>é€šè¿‡ <code>ssh</code> ç™»å½•è·¯ç”±å™¨ï¼ŒæŸ¥çœ‹å¸ƒå±€</p>
<p></p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># on PC</span></span><br><span class="line">ssh root@192.168.31.1</span><br><span class="line"></span><br><span class="line"><span class="comment"># on Router</span></span><br><span class="line"><span class="comment"># æŸ¥çœ‹å½“å‰åˆ†åŒºå¸ƒå±€</span></span><br><span class="line"><span class="built_in">cat</span> /proc/mtd</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>é»˜è®¤å¸ƒå±€å¦‚ä¸‹:</p>
<p></p><figure class="highlight txt"><table><tbody><tr><td class="code"><pre><span class="line">dev:    size   erasesize  name</span><br><span class="line">mtd0: 08000000 00020000 "spi0.0"</span><br><span class="line">mtd1: 00100000 00020000 "BL2"</span><br><span class="line">mtd2: 00040000 00020000 "Nvram"</span><br><span class="line">mtd3: 00040000 00020000 "Bdata"</span><br><span class="line">mtd4: 00200000 00020000 "Factory"</span><br><span class="line">mtd5: 00200000 00020000 "FIP"</span><br><span class="line">mtd6: 00040000 00020000 "crash"</span><br><span class="line">mtd7: 00040000 00020000 "crash_log"</span><br><span class="line">mtd8: 02200000 00020000 "ubi"</span><br><span class="line">mtd9: 02200000 00020000 "ubi1"</span><br><span class="line">mtd10: 02000000 00020000 "overlay"</span><br><span class="line">mtd11: 00c00000 00020000 "data"</span><br><span class="line">mtd12: 00040000 00020000 "KF"</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>å¦‚æœéœ€è¦å¤‡ä»½ï¼Œå¯ä»¥é€šè¿‡ <code>nanddump</code> å‘½ä»¤å¤‡ä»½ï¼Œä¹‹åé€šè¿‡
<code>scp</code> å°†å¤‡ä»½çš„æ–‡ä»¶ä¼ åˆ°ç”µè„‘ä¸Š</p>
<p></p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># on Router</span></span><br><span class="line">nanddump -f /tmp/BL2.bin /dev/mtd1</span><br><span class="line">nanddump -f /tmp/Nvram.bin /dev/mtd2</span><br><span class="line">nanddump -f /tmp/Bdata.bin /dev/mtd3</span><br><span class="line">nanddump -f /tmp/Factory.bin /dev/mtd4</span><br><span class="line">nanddump -f /tmp/FIP.bin /dev/mtd5</span><br><span class="line">nanddump -f /tmp/ubi.bin /dev/mtd8</span><br><span class="line">nanddump -f /tmp/KF.bin /dev/mtd12</span><br><span class="line"></span><br><span class="line"><span class="comment"># on PC</span></span><br><span class="line">scp root@192.168.31.1:/tmp/*.bin .</span><br></pre></td></tr></tbody></table></figure><p></p></li>
<li><p>ç„¶åå°† uboot åˆ·å…¥ FIP åˆ†åŒºï¼Œä¹‹åå…³æœº</p>
<p></p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># on Router</span></span><br><span class="line">mtd write /tmp/mt7981_wr30u-fip-fixed-parts-multi-layout.bin FIP</span><br><span class="line"></span><br><span class="line">poweroff</span><br></pre></td></tr></tbody></table></figure><p></p></li>
</ol>
<h2 id="åˆ·å…¥-immortalwrt">åˆ·å…¥ ImmortalWrt</h2>
<h3 id="ç®€ä»‹-1">ç®€ä»‹</h3>
<p>ImmortalWrt æ˜¯ OpenWrt çš„ä¸€ä¸ªåˆ†æ”¯ï¼Œç›¸æ¯”äº OpenWrt
æœ‰æ›´å¤šçš„è½¯ä»¶åŒ…ä»¥åŠè®¾å¤‡æ”¯æŒï¼Œå¹¶ä¸”å¯¹ä¸­å›½å¤§é™†ç”¨æˆ·æœ‰ç‰¹æ®Šä¼˜åŒ–</p>
<h3 id="åˆ·å…¥æµç¨‹-1">åˆ·å…¥æµç¨‹</h3>
<ol type="1">
<li><p>ç”µè„‘è¿æ¥æ­£å¸¸ç½‘ç»œï¼Œå»å®˜ç½‘ä¸‹è½½ <span class="exturl" data-url="aHR0cHM6Ly9maXJtd2FyZS1zZWxlY3Rvci5pbW1vcnRhbHdydC5vcmcvP3ZlcnNpb249MjMuMDUtU05BUFNIT1QmdGFyZ2V0PW1lZGlhdGVrJTJGZmlsb2dpYyZpZD14aWFvbWlfbWktcm91dGVyLXdyMzB1LTExMm0tbm1ibQ==">Sysupgrade
å›ºä»¶<i class="fa fa-external-link-alt"></i></span></p>
<p>è¿™é‡Œé€‰æ‹©äº† custom U-Boot layout çš„å›ºä»¶ï¼Œä¹Ÿå°±æ˜¯ 112M UBI layout
çš„å›ºä»¶ï¼Œè¿™æ ·å¯ä»¥æœ‰æ›´å¤šçš„ç©ºé—´ç”¨äºå®‰è£…è½¯ä»¶åŒ…ï¼Œå›ºä»¶åæ ¼å¼ä¸º
<code>immortalwrt-xxxxxx-mediatek-filogic-xiaomi_mi-router-wr30u-112m-nmbm-squashfs-sysupgrade.bin</code></p></li>
<li><p>é’ˆæŒ‰ä½ reset ä¸æ”¾ï¼Œå†æ¥ä¸Šç”µæºï¼Œç­‰å¾… 10s
å·¦å³æ¾å¼€ï¼Œè·¯ç”±å™¨çš„ç³»ç»Ÿç¯å˜è“åå°±æ˜¯æˆåŠŸè¿›å…¥ uboot äº†</p></li>
<li><p>å›  uboot ä¸æ”¯æŒ DHCP åŠŸèƒ½ï¼Œéœ€è¦æŠŠç”µè„‘çš„ IP åœ°å€è®¾ç½®æˆå›ºå®š
IPï¼š</p>
<p>ç”µè„‘é€šè¿‡ç½‘çº¿è¿æ¥è·¯ç”±å™¨ï¼Œç„¶ååœ¨ç½‘ç»œè®¾ç½®é‡Œå°†ä»¥å¤ªç½‘è®¾ç½®ä¸ºé™æ€ï¼ŒIP åœ°å€ï¼š192.168.31.100ï¼Œå­ç½‘æ©ç ï¼š255.255.255.0ï¼Œç½‘å…³ï¼š192.168.31.1ï¼Œé¦–é€‰
DNSï¼š192.168.31.1ï¼Œæœ€åä¿å­˜</p></li>
<li><p>ç›´æ¥è®¿é—® <span class="exturl" data-url="aHR0cDovLzE5Mi4xNjguMzEuMQ==">WebUI<i class="fa fa-external-link-alt"></i></span> è¿›è¡Œåˆ·å›ºä»¶ï¼Œå°†
layout é€‰ä¸º
<code>immortalwrt-112m</code>ï¼Œç„¶åä¸Šä¼ å‰é¢ä¸‹è½½çš„å›ºä»¶ï¼Œç‚¹å‡»åˆ·æœºå³å¯</p>
<figure>
<img data-src="/posts/e6410576/layout%20é€‰æ‹©.png" alt="layout é€‰æ‹©">
<figcaption aria-hidden="true">layout é€‰æ‹©</figcaption>
</figure></li>
</ol>
<h2 id="åˆ·ä¸ºåŸå‚å›ºä»¶">åˆ·ä¸ºåŸå‚å›ºä»¶</h2>
<p>åˆ·å›åŸå‚å›ºä»¶çš„è¿‡ç¨‹ä¸åˆ·å…¥ ImmortalWrt ç±»ä¼¼ï¼Œåªæ˜¯éœ€è¦ä¸‹è½½<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2hhbndja2YveGlhb21pLXJvdXRlci1zdG9jay11YmktYmlu">åŸå‚å›ºä»¶<i class="fa fa-external-link-alt"></i></span>ï¼Œç„¶ååœ¨
WebUI ä¸­å°† layout é…ç½®ä¸º
<code>default</code>ï¼Œä¹‹åä¸Šä¼ åŸå‚å›ºä»¶åˆ·æœºå³å¯</p>
<h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h2>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLnF1c3QubWUvd3IzMHU=">ã€ä¸ªäººåšå®¢ã€‘é…±ç´«è¡¨ - å°ç±³ WR30U
è§£é” SSH åˆ· openwrtï¼Œæœ€æœ‰æ€§ä»·æ¯”çš„ç™¾å…ƒè·¯ç”±å™¨<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL1BhdHJpY2lhTGVlMy93cjMwdV9zc2g=">ã€GitHubã€‘wr30u_ssh<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9jbWkuaGFud2NrZi50b3AvcC9tdDc5OHgtdWJvb3QtdXNhZ2U=">ã€ä¸ªäººåšå®¢ã€‘hanwckf
- mt798x uboot åŠŸèƒ½ä»‹ç»<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9maXJtd2FyZS1zZWxlY3Rvci5pbW1vcnRhbHdydC5vcmcv">ã€ImmortalWrtã€‘å›ºä»¶ä¸‹è½½<i class="fa fa-external-link-alt"></i></span></li>
</ul>
]]></content>
      <categories>
        <category>è·¯ç”±å™¨</category>
      </categories>
      <tags>
        <tag>OpenWrt</tag>
        <tag>BootLoader</tag>
        <tag>ImmortalWrt</tag>
      </tags>
  </entry>
  <entry>
    <title>Breed ä»‹ç»ã€åˆ·å…¥å’Œä½¿ç”¨</title>
    <url>/posts/53d6c2d9.html</url>
    <content><![CDATA[<h2 id="ä»‹ç»">ä»‹ç»</h2>
<p>Breed æ˜¯å›½å†…ä¸ªäºº <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2hhY2twYXNjYWw=">hackpascal<i class="fa fa-external-link-alt"></i></span> å¼€å‘çš„é—­æº
Bootloaderï¼Œä¹Ÿè¢«ç§°ä¸º â€œä¸æ­»é¸Ÿâ€</p>
<p>å› ä¸ºæœ‰äº›å®˜æ–¹å‡çº§å›ºä»¶è‡ªå¸¦ bootloaderï¼Œå¦‚æœä»å®˜æ–¹å›ºä»¶å‡çº§ï¼Œä¼šå¯¼è‡´ç°æœ‰
bootloader è¢«è¦†ç›–ã€‚è€Œå½“ Breed
æ›´æ–°å›ºä»¶æ—¶ï¼Œå®ƒä¼šè‡ªåŠ¨åˆ é™¤å›ºä»¶é™„å¸¦çš„å¼•å¯¼åŠ è½½ç¨‹åºï¼Œå› æ­¤å¯ä»¥é˜²æ­¢ Breed
è¢«è¦†ç›– <span id="more"></span></p>
<p>Breed æ‹¥æœ‰ä»¥ä¸‹ç‰¹æ€§ï¼š</p>
<ul>
<li>å®æ—¶åˆ·æœºè¿›åº¦ï¼Œè¿›åº¦æ¡èƒ½å‡†ç¡®åæ˜ åˆ·æœºè¿›åº¦</li>
<li> Web é¡µé¢å¿«é€Ÿå“åº”</li>
<li>æœ€å¤§å›ºä»¶å¤‡ä»½é€Ÿåº¦ï¼Œä¾ Flash è€Œå®šï¼Œä¸€èˆ¬èƒ½è¾¾åˆ° 1MB/s</li>
<li> å…æŒ‰å¤ä½é”®è¿›å…¥ Web åˆ·æœºæ¨¡å¼</li>
<li> Telnet åŠŸèƒ½ï¼Œå… TTL è¿›å…¥ Breed å‘½ä»¤æ§åˆ¶å°</li>
<li>å¤ä½é”®å®šä¹‰æµ‹è¯•åŠŸèƒ½</li>
<li>å›ºä»¶å¯åŠ¨å¤±è´¥è‡ªåŠ¨è¿›å…¥ Web åˆ·æœºæ¨¡å¼</li>
<li>å¯è‡ªå®šä¹‰ä½ç½®å’Œå¤§å°çš„ç¯å¢ƒå˜é‡å—</li>
</ul>
<p>ç”±äºæ˜¯é—­æºï¼Œæ— æ³•è¿›è¡ŒäºŒæ¬¡å¼€å‘ï¼Œæ‰€æœ‰æ”¯æŒçš„è®¾å¤‡å‡ç”± hackpascal
ä¸€äººå®Œæˆã€‚åœ¨ 2020-10-09 åå·²ç»åœæ­¢ç‰ˆæœ¬æ›´æ–°ï¼Œä½† <span class="exturl" data-url="aHR0cHM6Ly9icmVlZC5oYWNrcGFzY2FsLm5ldC8=">å®˜ç½‘<i class="fa fa-external-link-alt"></i></span> ç›®å‰ä»ç„¶å¼€æ”¾æ‰€æœ‰çš„ Breed
ä¸‹è½½</p>
<h3 id="æ–‡ä»¶è¯´æ˜">æ–‡ä»¶è¯´æ˜</h3>
<p>ä¸‹è¡¨ä¸º Breed çš„æ–‡ä»¶å¯¹åº”çš„è®¾å¤‡ä»‹ç»ï¼Œå‘å¸ƒåœ¨ <span class="exturl" data-url="aHR0cHM6Ly93d3cucmlnaHQuY29tLmNuL2ZvcnVtL3RocmVhZC0xNjE5MDYtMS0xLmh0bWw=">æ©å±±è®ºå›<i class="fa fa-external-link-alt"></i></span>
ä¸Šï¼Œåœ¨æ­¤å¤„åšä¸€ä¸ªå¤‡ä»½</p>
<table>
<colgroup>
<col style="width: 26%">
<col style="width: 73%">
</colgroup>
<thead>
<tr class="header">
<th>æ–‡ä»¶å</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td> BreedEnter.exe</td>
<td>Breed å¯åŠ¨ä¸­æ–­å·¥å…·ï¼Œå®ç°å…æŒ‰å¤ä½é”®è¿›å…¥ Web åˆ·æœºæ¨¡å¼</td>
</tr>
<tr class="even">
<td> md5sum.txt</td>
<td> å½“å‰ç‰ˆæœ¬æ‰€æœ‰ Breed æ–‡ä»¶çš„ MD5 å€¼ï¼Œç”¨äºæ ¡éªŒæ–‡ä»¶çš„å®Œæ•´æ€§</td>
</tr>
<tr class="odd">
<td> breed-mt7620-reset1.bin</td>
<td>MT7620A / MT7620N å…¨é€šç”¨ï¼Œæ³¢ç‰¹ç‡ 57600ï¼Œå¤ä½é”® GPIO#1</td>
</tr>
<tr class="even">
<td>breed-mt7620-reset2.bin</td>
<td>MT7620A / MT7620N å…¨é€šç”¨ï¼Œæ³¢ç‰¹ç‡ 57600ï¼Œå¤ä½é”® GPIO#2</td>
</tr>
<tr class="odd">
<td>breed-mt7620-reset11.bin</td>
<td>MT7620A / MT7620N å…¨é€šç”¨ï¼Œæ³¢ç‰¹ç‡ 57600ï¼Œå¤ä½é”® GPIO#11</td>
</tr>
<tr class="even">
<td>breed-mt7620-reset12.bin</td>
<td>MT7620A / MT7620N å…¨é€šç”¨ï¼Œæ³¢ç‰¹ç‡ 57600ï¼Œå¤ä½é”® GPIO#12</td>
</tr>
<tr class="odd">
<td>breed-mt7620-reset13.bin</td>
<td>MT7620A / MT7620N å…¨é€šç”¨ï¼Œæ³¢ç‰¹ç‡ 57600ï¼Œå¤ä½é”® GPIO#13</td>
</tr>
<tr class="even">
<td>breed-mt7620-reset26.bin</td>
<td>MT7620A / MT7620N å…¨é€šç”¨ï¼Œæ³¢ç‰¹ç‡ 57600ï¼Œå¤ä½é”® GPIO#26</td>
</tr>
<tr class="odd">
<td>breed-mt7620-reset30.bin</td>
<td>MT7620A / MT7620N å…¨é€šç”¨ï¼Œæ³¢ç‰¹ç‡ 57600ï¼Œå¤ä½é”® GPIO#30</td>
</tr>
<tr class="even">
<td>breed-mt7620-rt-n14u.bin</td>
<td>MT7620A / MT7620N å…¨é€šç”¨ï¼Œæ³¢ç‰¹ç‡ 57600ï¼Œå¤ä½é”® GPIO#1ï¼ŒWPS é”®
GPIO#2</td>
</tr>
<tr class="odd">
<td>breed-mt7620-whr-1166dhp.bin</td>
<td>MT7620A / MT7620N å…¨é€šç”¨ï¼Œæ³¢ç‰¹ç‡ 57600ï¼Œå¤ä½é”® GPIO#52ï¼ŒAOSS é”®
GPIO#53</td>
</tr>
<tr class="even">
<td>breed-mt7620-lenovo-y1.bin</td>
<td> è”æƒ³ Y1 (newifi mini) ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#11</td>
</tr>
<tr class="odd">
<td>breed-mt7620-lenovo-y1s.bin</td>
<td> è”æƒ³ Y1S (newifi) ä¸“ç”¨ï¼Œåƒå…†å£å¯ç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”®
GPIO#11</td>
</tr>
<tr class="even">
<td>breed-mt7620-zte-q7.bin</td>
<td> ä¸­å…´ ZTE Q7 ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 57600ï¼Œå¤ä½é”® GPIO#26</td>
</tr>
<tr class="odd">
<td>breed-mt7620-youku-yk1.bin</td>
<td> ä¼˜é…·è·¯ç”±å®ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 57600ï¼Œå¤ä½é”® GPIO#1</td>
</tr>
<tr class="even">
<td>breed-mt7620-xiaomi-mini.bin</td>
<td> å°ç±³ Mini ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#30</td>
</tr>
<tr class="odd">
<td>breed-mt7620-fir302m.bin</td>
<td> æ–è®¯ FIR300M/302M ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 57600ï¼Œå¤ä½é”® GPIO#2</td>
</tr>
<tr class="even">
<td>breed-mt7620-phicomm-psg1208.bin</td>
<td> æ–è®¯ PSG1208 (K1)/ PSG1218 (K2) ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 57600ï¼Œå¤ä½é”®
GPIO#1</td>
</tr>
<tr class="odd">
<td>breed-mt7620-hiwifi-hc5761.bin</td>
<td> æè·¯ç”± æå£¹ S (HC5661)/ æè´° (HC5761) ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”®
GPIO#12</td>
</tr>
<tr class="even">
<td>breed-mt7620-hiwifi-hc5861.bin</td>
<td> æè·¯ç”± æå (HC5861) ä¸“ç”¨ï¼Œåƒå…† LAN å¯ç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”®
GPIO#12</td>
</tr>
<tr class="odd">
<td>breed-mt7620-oye-0001.bin</td>
<td> å“¦è€¶ Oye-0001 ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#1</td>
</tr>
<tr class="even">
<td>breed-mt7620-airmobi-iplay2.bin</td>
<td>AirMobi iPlay2 ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 57600ï¼Œå¤ä½é”® GPIO#26</td>
</tr>
<tr class="odd">
<td>breed-mt7621-newifi-d1.bin</td>
<td> è”æƒ³ Newifi D1 ä¸“ç”¨ï¼ŒDDR3 å†…å­˜é€‚ç”¨ï¼Œé»˜è®¤ 256MB DDR AC
æ—¶åºå‚æ•°ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#15ï¼ŒWPS é”® GPIO#18</td>
</tr>
<tr class="even">
<td>breed-mt7621-newifi-d2.bin</td>
<td> è”æƒ³ Newifi D2 ä¸“ç”¨ï¼ŒDDR3 å†…å­˜é€‚ç”¨ï¼Œé»˜è®¤ 512MB DDR AC
æ—¶åºå‚æ•°ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#3ï¼ŒWPS é”® GPIO#7</td>
</tr>
<tr class="odd">
<td>breed-mt7621-xunlei-timeplug.bin</td>
<td> è¿…é›·æ—¶å…‰æœº (æ—¶å…‰äº‘) ä¸“ç”¨ï¼ŒDDR3 å†…å­˜é€‚ç”¨ï¼Œé»˜è®¤ 256MB DDR AC
æ—¶åºå‚æ•°ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#4</td>
</tr>
<tr class="even">
<td>breed-mt7621-youku-l2.bin</td>
<td> ä¼˜é…·è·¯ç”±å® YK-L2 ä¸“ç”¨ï¼ŒDDR3 å†…å­˜é€‚ç”¨ï¼Œé»˜è®¤ 256MB DDR AC
æ—¶åºå‚æ•°ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#18ï¼ŒWPS é”® GPIO#17</td>
</tr>
<tr class="odd">
<td>breed-mt7621-phicomm-k2p.bin</td>
<td> æ–è®¯ K2P ä¸“ç”¨ï¼ŒDDR3 å†…å­˜é€‚ç”¨ï¼Œé»˜è®¤ 512MB DDR AC æ—¶åºå‚æ•°ï¼Œæ³¢ç‰¹ç‡
57600ï¼Œå¤ä½é”® GPIO#3</td>
</tr>
<tr class="even">
<td>breed-mt7621-pbr-m1.bin</td>
<td>PandoraBox PBR-M1 ä¸“ç”¨ï¼ŒDDR3 å†…å­˜é€‚ç”¨ï¼Œé»˜è®¤ 512MB DDR AC
æ—¶åºå‚æ•°ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#18</td>
</tr>
<tr class="odd">
<td>breed-mt7621-totolink-a3004ns.bin</td>
<td>TOTOLINK A3004NS ä¸“ç”¨ï¼ŒDDR3 å†…å­˜é€‚ç”¨ï¼Œé»˜è®¤ 256MB DDR AC
æ—¶åºå‚æ•°ï¼Œæ³¢ç‰¹ç‡ 57600ï¼Œå¤ä½é”® GPIO#4ï¼ŒWPS é”® GPIO#3</td>
</tr>
<tr class="even">
<td>breed-mt7621-xiaomi-r3g.bin</td>
<td> å°ç±³è·¯ç”±å™¨ 3G ä¸“ç”¨ï¼ŒNAND å¯åŠ¨ï¼ŒDDR3 å†…å­˜é€‚ç”¨ï¼Œé»˜è®¤ 256MB DDR AC
æ—¶åºå‚æ•°ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#18</td>
</tr>
<tr class="odd">
<td>breed-mt7621-creativebox-v1.bin</td>
<td>CreativeBox v1 ä¸“ç”¨ï¼ŒDDR3 å†…å­˜é€‚ç”¨ï¼Œé»˜è®¤ 512MB DDR AC
æ—¶åºå‚æ•°ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#18</td>
</tr>
<tr class="even">
<td>breed-mt7621-hiwifi-hc5962.bin</td>
<td> æè·¯ç”± 4/HC5962/B70 ä¸“ç”¨ï¼ŒNAND å¯åŠ¨ï¼ŒDDR3 å†…å­˜é€‚ç”¨ï¼Œé»˜è®¤ 256MB DDR AC
æ—¶åºå‚æ•°ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#18</td>
</tr>
<tr class="odd">
<td>breed-mt7621-r6220.bin</td>
<td>Netgear R6220 ä¸“ç”¨ï¼ŒNAND å¯åŠ¨ï¼ŒDDR2 å†…å­˜é€‚ç”¨ï¼Œå›ºå®š 128MB DDR AC
æ—¶åºå‚æ•°ï¼Œæ³¢ç‰¹ç‡ 57600ï¼Œå¤ä½é”® GPIO#14ï¼ŒWPS é”® GPIO#7ï¼ŒRFKILL é”®
GPIO#8</td>
</tr>
<tr class="even">
<td>breed-mt7621-wndr3700v5.bin</td>
<td>Netgear WNDR3700 v5 ä¸“ç”¨ï¼ŒDDR2 å†…å­˜é€‚ç”¨ï¼Œå›ºå®š 128MB DDR AC
æ—¶åºå‚æ•°ï¼Œæ³¢ç‰¹ç‡ 57600ï¼Œå¤ä½é”® GPIO#14ï¼ŒWPS é”® GPIO#7ï¼ŒRFKILL é”®
GPIO#8</td>
</tr>
<tr class="odd">
<td>breed-mt7621-gehua-ghl-r-001.bin</td>
<td> æ­Œå GHL-R-001 ä¸“ç”¨ï¼ŒDDR3 å†…å­˜é€‚ç”¨ï¼Œé»˜è®¤ 512MB DDR AC
æ—¶åºå‚æ•°ï¼Œæ³¢ç‰¹ç‡ 57600ï¼Œå¤ä½é”® GPIO#18</td>
</tr>
<tr class="even">
<td>breed-mt7621-jd-cloud-1.bin</td>
<td> äº¬ä¸œäº‘è·¯ç”±å® RE-SP-01B ä¸“ç”¨ï¼ŒDDR3 å†…å­˜é€‚ç”¨ï¼Œé»˜è®¤ 512MB DDR AC
æ—¶åºå‚æ•°ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#18</td>
</tr>
<tr class="odd">
<td>breed-mt7628-hiwifi-hc5661a.bin</td>
<td> æè·¯ç”± æå£¹ S (HC5661A) ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#38</td>
</tr>
<tr class="even">
<td>breed-mt7628-oye-0006.bin</td>
<td> å“¦è€¶ OYE-0006 ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#38</td>
</tr>
<tr class="odd">
<td>breed-mt7688-reset38.bin</td>
<td>MT7628AN/KN å…¨é€šç”¨ï¼Œæ³¢ç‰¹ç‡ 57600ï¼Œå¤ä½é”® GPIO#38</td>
</tr>
<tr class="even">
<td>breed-mt7688-wrtnode2r.bin</td>
<td>MT7628AN/KN å…¨é€šç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#5</td>
</tr>
<tr class="odd">
<td>breed-rt3050-buffalo-wcr-hp-gn.bin (ä¸å†æ›´æ–°)</td>
<td>Buffalo WCR-HP-GN ä¸“ç”¨ï¼ŒSPI å¯åŠ¨ï¼Œæ³¢ç‰¹ç‡ 57600ï¼Œå¤ä½é”® GPIO#10ï¼ŒWPS
é”® GPIO#0</td>
</tr>
<tr class="even">
<td>breed-rt3050-di-524m-b1.bin (ä¸å†æ›´æ–°)</td>
<td>D-LINK DI-624M B1 ä¸“ç”¨ï¼ŒSPI å¯åŠ¨ï¼Œæ³¢ç‰¹ç‡ 57600ï¼Œå¤ä½é”® GPIO#10</td>
</tr>
<tr class="odd">
<td>breed-rt305x-nor-reset0.bin (ä¸å†æ›´æ–°)</td>
<td>RT305X é€šç”¨ï¼ŒNOR å¯åŠ¨ï¼Œæ³¢ç‰¹ç‡ 57600ï¼Œå¤ä½é”® GPIO#0</td>
</tr>
<tr class="even">
<td>breed-rt305x-nor-reset10.bin (ä¸å†æ›´æ–°)</td>
<td>RT305X é€šç”¨ï¼ŒNOR å¯åŠ¨ï¼Œæ³¢ç‰¹ç‡ 57600ï¼Œå¤ä½é”® GPIO#10</td>
</tr>
<tr class="odd">
<td>breed-rt3052-dir-605-b1.bin (ä¸å†æ›´æ–°)</td>
<td>D-LINK DIR-605 B1 ä¸“ç”¨ï¼ŒNOR å¯åŠ¨ï¼Œæ³¢ç‰¹ç‡ 57600ï¼Œå¤ä½é”® GPIO#10ï¼ŒWPS
é”® GPIO#0</td>
</tr>
<tr class="even">
<td>breed-rt3052-hg255d.bin (ä¸å†æ›´æ–°)</td>
<td> åä¸º HG255D ä¸“ç”¨ï¼ŒNOR å¯åŠ¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#4ï¼ŒWPS é”®
GPIO#10</td>
</tr>
<tr class="odd">
<td>breed-rt5350-airmobi-iplay.bin (ä¸å†æ›´æ–°)</td>
<td>AirMobi iPlay ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 57600ï¼Œå¤ä½é”® GPIO#12</td>
</tr>
<tr class="even">
<td>breed-rt5350-hame-a5.bin (ä¸å†æ›´æ–°)</td>
<td> åç¾ A5 ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 57600ï¼Œå¤ä½é”® GPIO#0</td>
</tr>
<tr class="odd">
<td>breed-rt5350-zm-10.bin (ä¸å†æ›´æ–°)</td>
<td> ä¸­æ²ƒ ZM-10 ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 57600ï¼Œå¤ä½é”® GPIO#10</td>
</tr>
<tr class="even">
<td>breed-ar7161-dir-825-b1.bin (ä¸å†æ›´æ–°)</td>
<td>D-LINK DIR-825 B1 ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#3ï¼ŒWPS é”®
GPIO#8</td>
</tr>
<tr class="odd">
<td>breed-ar724x.bin (ä¸å†æ›´æ–°)</td>
<td>AR724X é€šç”¨ï¼Œç™¾å…†æœ‰çº¿ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#11ï¼ŒQSS é”®
GPIO#12</td>
</tr>
<tr class="even">
<td>breed-ar724x-reset11.bin (ä¸å†æ›´æ–°)</td>
<td>AR724X é€šç”¨ï¼Œç™¾å…†æœ‰çº¿ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#11</td>
</tr>
<tr class="odd">
<td>breed-ar724x-reset12.bin (ä¸å†æ›´æ–°)</td>
<td>AR724X é€šç”¨ï¼Œç™¾å…†æœ‰çº¿ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#12</td>
</tr>
<tr class="even">
<td>breed-ar7240-wnr1000v2.bin (ä¸å†æ›´æ–°)</td>
<td>Netgear WNR1000 v2 ä¸“ç”¨ï¼Œç™¾å…†æœ‰çº¿ï¼Œæ³¢ç‰¹ç‡ 115200</td>
</tr>
<tr class="odd">
<td>breed-ar7242-wr2543nd.bin (ä¸å†æ›´æ–°)</td>
<td>TP-LINK WR2543ND ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#11ï¼ŒQSS é”®
GPIO#12</td>
</tr>
<tr class="even">
<td>breed-ar7242-aruba-ap93.bin (ä¸å†æ›´æ–°)</td>
<td>Aruba-AP93 ä¸“ç”¨ï¼Œåƒå…†æœ‰çº¿ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#11ï¼ŒWPS é”®
GPIO#12</td>
</tr>
<tr class="odd">
<td>breed-ar913x.bin (ä¸å†æ›´æ–°)</td>
<td>AR913X é€šç”¨ï¼Œç™¾å…†æœ‰çº¿ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#7ï¼ŒWPS é”®
GPIO#3</td>
</tr>
<tr class="even">
<td>breed-ar9132-wr1043ndv1.bin (ä¸å†æ›´æ–°)</td>
<td>TP-LINK WR1043ND v1 ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#7ï¼ŒWPS é”®
GPIO#3</td>
</tr>
<tr class="odd">
<td>breed-ar9331.bin (ä¸å†æ›´æ–°)</td>
<td>AR9331 é€šç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#11</td>
</tr>
<tr class="even">
<td>breed-ar9331-mr12u.bin (ä¸å†æ›´æ–°)</td>
<td>TP-LINK MR12U ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#11</td>
</tr>
<tr class="odd">
<td>breed-ar9331-pisen.bin (ä¸å†æ›´æ–°)</td>
<td> å“èƒœäº‘è·¯ç”± (äº‘åº§æ˜“å…… WMM003N / æ— çº¿éŸ³ä¹è·¯ç”± WPR001N) ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡
115200ï¼Œå¤ä½é”® GPIO#12</td>
</tr>
<tr class="even">
<td>breed-ar9331-wr710n.bin (ä¸å†æ›´æ–°)</td>
<td>TP-LINK WR710N/WR720N v3 ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#11</td>
</tr>
<tr class="odd">
<td>breed-ar9331-hiwifi-hc6361.bin (ä¸å†æ›´æ–°)</td>
<td> æè·¯ç”± æå£¹ (HC6361) ä¸“ç”¨ï¼Œä»…æ”¯æŒ TP ç±»å›ºä»¶ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”®
GPIO#11</td>
</tr>
<tr class="even">
<td>breed-ar9341.bin (ä¸å†æ›´æ–°)</td>
<td>AR9341 é€šç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#17</td>
</tr>
<tr class="odd">
<td>breed-ar9341-wnr2000v4.bin (ä¸å†æ›´æ–°)</td>
<td>Netgear WNR2000 v4 ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#4</td>
</tr>
<tr class="even">
<td>breed-ar9341-pisen-wmp002n.bin (ä¸å†æ›´æ–°)</td>
<td> å“èƒœäº‘è¿½å‰§ WMP002N ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#17</td>
</tr>
<tr class="odd">
<td>breed-ar9341-wr800n.bin (ä¸å†æ›´æ–°)</td>
<td>TP-LINK WR800N ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#18</td>
</tr>
<tr class="even">
<td>breed-ar9342-wr1041nv2.bin (ä¸å†æ›´æ–°)</td>
<td>TP-LINK WR1042N v2 ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#14</td>
</tr>
<tr class="odd">
<td>breed-ar9342-huawei-ws322.bin (ä¸å†æ›´æ–°)</td>
<td> åä¸º WS322 ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#0ï¼ŒWPS é”® GPIO#16</td>
</tr>
<tr class="even">
<td>breed-ar9344.bin (ä¸å†æ›´æ–°)</td>
<td>AR9344 ç™¾å…†ç‰ˆï¼Œé€šç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#16</td>
</tr>
<tr class="odd">
<td>breed-ar9344-ar8327n.bin (ä¸å†æ›´æ–°)</td>
<td>AR9344 + AR8327N åƒå…†ç‰ˆï¼Œé€šç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#16</td>
</tr>
<tr class="even">
<td>breed-ar9344-wdr3320v2.bin (ä¸å†æ›´æ–°)</td>
<td>TP-LINK WDR3320 v2 ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#16</td>
</tr>
<tr class="odd">
<td>breed-ar9344-wr941nv6.bin (ä¸å†æ›´æ–°)</td>
<td>TP-LINK WR941N v6 ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#12</td>
</tr>
<tr class="even">
<td>breed-ar9344-mw4530r.bin (ä¸å†æ›´æ–°)</td>
<td> æ°´æ˜Ÿ MW4530R ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#17ï¼ŒQSS é”®
GPIO#16</td>
</tr>
<tr class="odd">
<td>breed-ar9344-wndr4300-spi.bin (ä¸å†æ›´æ–°)</td>
<td>Netgear WNDR4300/WNDR3700 v4 ä¸“ç”¨ï¼ŒSPI å¯åŠ¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”®
GPIO#21ï¼ŒQSS é”® GPIO#12</td>
</tr>
<tr class="even">
<td>breed-ar9344-wndr4300-spi-recovery.bin (ä¸å†æ›´æ–°)</td>
<td>Netgear WNDR4300/WNDR3700 v4 ä¸“ç”¨ï¼ŒSPI å¯åŠ¨ï¼Œä»…ç”¨äºæ¢å¤ç›®çš„ï¼Œæ³¢ç‰¹ç‡
115200ï¼Œå¤ä½é”® GPIO#21ï¼ŒQSS é”® GPIO#12</td>
</tr>
<tr class="odd">
<td>breed-ar9344-belair20e11.bin (ä¸å†æ›´æ–°)</td>
<td>BelAir20E-11 ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#17ï¼ŒWPS é”®
GPIO#12</td>
</tr>
<tr class="even">
<td>breed-ar9344-sgr-w500-n85b-v2.bin</td>
<td> å›½äººé€šä¿¡ GRENTECH SGR-W500-N85b v2 ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œæ”¯æŒ
RTL8211Eï¼Œå¤ä½é”® GPIO#3</td>
</tr>
<tr class="odd">
<td>breed-qca953x.bin</td>
<td>QCA9531/QCA9533ï¼Œé€šç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#12</td>
</tr>
<tr class="even">
<td>breed-qca953x-letv-lba-047-ch.bin</td>
<td> ä¹è§†è·¯ç”±ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#17</td>
</tr>
<tr class="odd">
<td>breed-qca9558-wr941nv7.bin</td>
<td>TP-LINK WR941N v7 ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#17</td>
</tr>
<tr class="even">
<td>breed-qca9558-ar8236.bin</td>
<td>QCA9558 + AR8236 ç™¾å…†ç‰ˆï¼Œé€šç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#16</td>
</tr>
<tr class="odd">
<td>breed-qca9558-ar8327n.bin</td>
<td>QCA9558 + AR8327N åƒå…†ç‰ˆï¼Œé€šç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#16</td>
</tr>
<tr class="even">
<td>breed-qca9558-wr2041nv2.bin</td>
<td>TP-LINK WR2041N v2 ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#17</td>
</tr>
<tr class="odd">
<td>breed-qca9558-wr1043ndv2.bin</td>
<td>TP-LINK WR1043ND v2 ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#16</td>
</tr>
<tr class="even">
<td>breed-qca9558-dw33d.bin</td>
<td> å¤§éº¦ DW33D ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#17</td>
</tr>
<tr class="odd">
<td>breed-qca956x-uart_rx18_tx20-reset1.bin</td>
<td>QCA956X é€šç”¨ï¼Œç™¾å…† / åƒå…†è‡ªé€‚åº”ï¼Œæ³¢ç‰¹ç‡ 115200ï¼ŒUART RX GPIO#18ï¼ŒTX
GPIO#20ï¼Œå¤ä½é”® GPIO#1</td>
</tr>
<tr class="even">
<td>breed-qca956x-uart_rx18_tx20-reset2.bin</td>
<td>QCA956X é€šç”¨ï¼Œç™¾å…† / åƒå…†è‡ªé€‚åº”ï¼Œæ³¢ç‰¹ç‡ 115200ï¼ŒUART RX GPIO#18ï¼ŒTX
GPIO#20ï¼Œå¤ä½é”® GPIO#2</td>
</tr>
<tr class="odd">
<td>breed-qca956x-uart_rx18_tx22-reset1.bin</td>
<td>QCA956X é€šç”¨ï¼Œç™¾å…† / åƒå…†è‡ªé€‚åº”ï¼Œæ³¢ç‰¹ç‡ 115200ï¼ŒUART RX GPIO#18ï¼ŒTX
GPIO#22ï¼Œå¤ä½é”® GPIO#1</td>
</tr>
<tr class="even">
<td>breed-qca956x-uart_rx18_tx22-reset2.bin</td>
<td>QCA956X é€šç”¨ï¼Œç™¾å…† / åƒå…†è‡ªé€‚åº”ï¼Œæ³¢ç‰¹ç‡ 115200ï¼ŒUART RX GPIO#18ï¼ŒTX
GPIO#22ï¼Œå¤ä½é”® GPIO#2</td>
</tr>
<tr class="odd">
<td>breed-qca956x-uart_rx19_tx20-reset1.bin</td>
<td>QCA956X é€šç”¨ï¼Œç™¾å…† / åƒå…†è‡ªé€‚åº”ï¼Œæ³¢ç‰¹ç‡ 115200ï¼ŒUART RX GPIO#19ï¼ŒTX
GPIO#20ï¼Œå¤ä½é”® GPIO#1</td>
</tr>
<tr class="even">
<td>breed-qca956x-uart_rx19_tx20-reset2.bin</td>
<td>QCA956X é€šç”¨ï¼Œç™¾å…† / åƒå…†è‡ªé€‚åº”ï¼Œæ³¢ç‰¹ç‡ 115200ï¼ŒUART RX GPIO#19ï¼ŒTX
GPIO#20ï¼Œå¤ä½é”® GPIO#2</td>
</tr>
<tr class="odd">
<td>breed-qca956x-uart_rx19_tx20-reset1.bin</td>
<td>QCA956X é€šç”¨ï¼Œç™¾å…† / åƒå…†è‡ªé€‚åº”ï¼Œæ³¢ç‰¹ç‡ 115200ï¼ŒUART RX GPIO#19ï¼ŒTX
GPIO#22ï¼Œå¤ä½é”® GPIO#1</td>
</tr>
<tr class="even">
<td>breed-qca956x-uart_rx19_tx22-reset2.bin</td>
<td>QCA956X é€šç”¨ï¼Œç™¾å…† / åƒå…†è‡ªé€‚åº”ï¼Œæ³¢ç‰¹ç‡ 115200ï¼ŒUART RX GPIO#19ï¼ŒTX
GPIO#22ï¼Œå¤ä½é”® GPIO#2</td>
</tr>
<tr class="odd">
<td>breed-qca956x-uart_rx20_tx22-reset1.bin</td>
<td>QCA956X é€šç”¨ï¼Œç™¾å…† / åƒå…†è‡ªé€‚åº”ï¼Œæ³¢ç‰¹ç‡ 115200ï¼ŒUART RX GPIO#20ï¼ŒTX
GPIO#22ï¼Œå¤ä½é”® GPIO#1</td>
</tr>
<tr class="even">
<td>breed-qca956x-uart_rx20_tx22-reset2.bin</td>
<td>QCA956X é€šç”¨ï¼Œç™¾å…† / åƒå…†è‡ªé€‚åº”ï¼Œæ³¢ç‰¹ç‡ 115200ï¼ŒUART RX GPIO#20ï¼ŒTX
GPIO#22ï¼Œå¤ä½é”® GPIO#2</td>
</tr>
<tr class="odd">
<td>breed-qca956x-reset2.bin</td>
<td>QCA956X ç™¾å…†ç‰ˆï¼Œé€šç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#2</td>
</tr>
<tr class="even">
<td>breed-qca9561-wdr6500v2.bin (ä¸å†æ›´æ–°)</td>
<td>TP-LINK WDR6500 v2 ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#1</td>
</tr>
<tr class="odd">
<td>breed-qca9563-wndr4500v3.bin</td>
<td>Netgear WNDR4500 v3 ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#2ï¼ŒWPS é”®
GPIO#1</td>
</tr>
<tr class="even">
<td>breed-qca9563-phicomm-k2t.bin</td>
<td> æ–è®¯ K2T ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#2</td>
</tr>
<tr class="odd">
<td>breed-qca9563-rosinson-wr818.bin</td>
<td>ROSINSON WR818 ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#2</td>
</tr>
<tr class="even">
<td>breed-qca9563-jhr-848q.bin</td>
<td>JHR-848Q ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#2</td>
</tr>
<tr class="odd">
<td>breed-qca9563-dir-859-a.bin</td>
<td>D-Link DIR-859 A1/A2 ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#2</td>
</tr>
<tr class="even">
<td>breed-tp9343.bin</td>
<td>TP9343ï¼Œé€šç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#1ï¼ŒWPS é”® GPIO#1</td>
</tr>
</tbody>
</table>
<p>æ³¨ï¼šä¸“ç”¨ç‰ˆèƒ½å¤Ÿç‚¹äº®æ‰€æœ‰ LED</p>
<p>ä»¥ä¸‹æ˜¯å¯ä»¥æ”¯æŒè‡ªå®šä¹‰å¤ä½é”® GPIO çš„ç‰¹åˆ«ç‰ˆ</p>
<table>
<colgroup>
<col style="width: 27%">
<col style="width: 72%">
</colgroup>
<thead>
<tr class="header">
<th>æ–‡ä»¶å</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td> breed-ar7161-blank.bin (ä¸å†æ›´æ–°)</td>
<td>AR7161 ä¸“ç”¨ï¼Œæ”¯æŒ AR8035 IP1001 MV88E1116 BCM5481 åƒå…† PHY</td>
</tr>
<tr class="even">
<td>breed-ar913x-blank.bin (ä¸å†æ›´æ–°)</td>
<td>AR913X ä¸“ç”¨ï¼Œä»…æ”¯æŒ 88E6060 ç™¾å…†äº¤æ¢æœº</td>
</tr>
<tr class="odd">
<td> breed-ar724x-blank.bin (ä¸å†æ›´æ–°)</td>
<td>AR724X ä¸“ç”¨ï¼Œæ”¯æŒå†…ç½®ç™¾å…†äº¤æ¢æœºå’Œ AR8021 åƒå…† PHY</td>
</tr>
<tr class="even">
<td>breed-ar9331-blank.bin (ä¸å†æ›´æ–°)</td>
<td>AR9331 ä¸“ç”¨ï¼Œä»…æ”¯æŒå†…ç½®ç™¾å…†äº¤æ¢æœº</td>
</tr>
<tr class="odd">
<td> breed-ar934x-blank.bin (ä¸å†æ›´æ–°)</td>
<td>AR934X ä¸“ç”¨ï¼Œæ”¯æŒå†…ç½®ç™¾å…†äº¤æ¢æœºå’Œ AR8327 (N) åƒå…†äº¤æ¢æœºã€AR8035
RTL8211E åƒå…† PHYã€RTL8201 ç™¾å…† PHY</td>
</tr>
<tr class="even">
<td>breed-mt7620-blank.bin</td>
<td>MT7620 ä¸“ç”¨ï¼Œä»…æ”¯æŒå†…ç½®ç™¾å…†äº¤æ¢æœº</td>
</tr>
<tr class="odd">
<td> breed-mt76x8-blank.bin</td>
<td>MT7628/MT7688 ä¸“ç”¨ï¼Œä»…æ”¯æŒå†…ç½®ç™¾å…†äº¤æ¢æœº</td>
</tr>
<tr class="even">
<td> breed-rt305x-nor-blank.bin (ä¸å†æ›´æ–°)</td>
<td>RT305X ä¸“ç”¨ï¼Œä» NOR é—ªå­˜å¯åŠ¨ï¼Œä»…æ”¯æŒå†…ç½®ç™¾å…†äº¤æ¢æœº</td>
</tr>
<tr class="odd">
<td> breed-rt305x-spi-blank.bin (ä¸å†æ›´æ–°)</td>
<td>RT305X ä¸“ç”¨ï¼Œä» SPI é—ªå­˜å¯åŠ¨ï¼Œä»…æ”¯æŒå†…ç½®ç™¾å…†äº¤æ¢æœº</td>
</tr>
<tr class="even">
<td> breed-rt5350-blank.bin (ä¸å†æ›´æ–°)</td>
<td>RT5350 ä¸“ç”¨ï¼Œä»…æ”¯æŒå†…ç½®ç™¾å…†äº¤æ¢æœº</td>
</tr>
</tbody>
</table>
<h2 id="åˆ·å…¥-breed">åˆ·å…¥ Breed</h2>
<p>Breed çš„åˆ·å…¥å’Œå›ºä»¶åˆ·å…¥æµç¨‹åŸºæœ¬ä¸€è‡´ï¼š</p>
<ol type="1">
<li>è·å–åŸå‚å›ºä»¶çš„ SSH ç™»å½•æƒé™ï¼ˆå¯èƒ½æ˜¯é€šè¿‡åŸå‚å›ºä»¶æ¼æ´ç­‰æ–¹å¼ï¼‰</li>
<li>åœ¨åŸå‚å›ºä»¶ä¸Šåˆ©ç”¨ <code>cat /proc/mtd</code> è·å– ROM åˆ†åŒºçš„å¸ƒå±€</li>
<li> [å¯é€‰] å¤‡ä»½åŸæœ‰çš„æ‰€æœ‰ ROM åˆ†åŒºæ•°æ®ï¼Œä¸»è¦ç›®çš„æ˜¯ä¸ºäº†æ¢å¤åŸå‚å›ºä»¶</li>
<li>åˆ©ç”¨ <code>mtd</code> ç­‰å‘½ä»¤ç›´æ¥å¯¹ Bootloader æ‰€åœ¨çš„ ROM
åŒºåŸŸè¿›è¡Œå†™å…¥é•œåƒ</li>
<li>é‡å¯è®¾å¤‡</li>
</ol>
<p>åˆ·å…¥ Breed åï¼Œè€å¿ƒç­‰å¾…è®¾å¤‡é‡å¯ï¼Œé€šå¸¸å¯ä»¥é€šè¿‡ 192.168.1.1
è¿™ä¸ªåœ°å€æ¥è¿›å…¥ Breed çš„ Web ç®¡ç†ç•Œé¢</p>
<figure>
<img data-src="/posts/53d6c2d9/Breed-WEB.png" alt="Breed çš„ Web ç®¡ç†ç•Œé¢">
<figcaption aria-hidden="true">Breed çš„ Web ç®¡ç†ç•Œé¢</figcaption>
</figure>
<h2 id="é€šè¿‡-breed-åˆ·æœº">é€šè¿‡ Breed åˆ·æœº</h2>
<p>é€šè¿‡ Breed åˆ·æœºå°±å¾ˆæ–¹ä¾¿äº†ï¼Œç›´æ¥åœ¨ <span class="exturl" data-url="aHR0cDovLzE5Mi4xNjguMS4xL3VwZ3JhZGUuaHRtbA==">å›ºä»¶æ›´æ–°<i class="fa fa-external-link-alt"></i></span>
ç•Œé¢ï¼Œå‹¾é€‰å›ºä»¶ï¼Œå¹¶ä¸Šä¼ å¯¹åº”çš„å›ºä»¶ï¼Œå¹¶å‹¾é€‰æ­£ç¡®çš„é—ªå­˜å¸ƒå±€åï¼Œç‚¹å‡»ä¸Šä¼ ï¼Œç­‰å¾…è®¾å¤‡é‡å¯å³å¯</p>
<figure>
<img data-src="/posts/53d6c2d9/Breed-upgrade.png" alt="Breed è¿›è¡Œå›ºä»¶æ›´æ–°">
<figcaption aria-hidden="true">Breed è¿›è¡Œå›ºä»¶æ›´æ–°</figcaption>
</figure>
<h2 id="å…¶ä»–åŠŸèƒ½">å…¶ä»–åŠŸèƒ½</h2>
<p>é™¤å» Web ç•Œé¢åˆ·æœºï¼ŒBreed
è¿˜æ”¯æŒä¸€äº›å…¶ä»–çš„åŠŸèƒ½ï¼ŒåŒ…æ‹¬å›ºä»¶å¤‡ä»½ã€è¶…é¢‘ç­‰ï¼Œæ›´å¤šçš„ä½¿ç”¨æ–¹å¼æ¨èå‚è€ƒç½‘ä¸Šçš„å…¶ä»–èµ„æ–™</p>
<h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h2>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly93d3cucmlnaHQuY29tLmNuL2ZvcnVtL3RocmVhZC0xNjE5MDYtMS0xLmh0bWw=">ã€æ©å±±è®ºå›ã€‘Breed<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly93d3cucmlnaHQuY29tLmNuL2ZvcnVtL3RocmVhZC0xNTQ1NjEtMS0xLmh0bWw=">ã€æ©å±±è®ºå›ã€‘U-Boot
åˆ·æœº<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly93d3cucmlnaHQuY29tLmNuL2ZvcnVtL3RocmVhZC02OTA2MDUtMS0xLmh0bWw=">ã€æ©å±±è®ºå›ã€‘å°ç±³è·¯ç”±å™¨
MINI åˆ· Breed åŠ Pandavan æ•™ç¨‹<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly93d3cucmlnaHQuY29tLmNuL2ZvcnVtL3RocmVhZC0yNTc0MjMtMS0xLmh0bWw=">ã€æ©å±±è®ºå›ã€‘å°ç±³è·¯ç”±å™¨
3G åˆ· Breed åŠè€æ¯›å­ Padavan å›ºä»¶æ•™ç¨‹<i class="fa fa-external-link-alt"></i></span></li>
</ul>
]]></content>
      <categories>
        <category>è·¯ç”±å™¨</category>
      </categories>
      <tags>
        <tag>BootLoader</tag>
        <tag>Breed</tag>
      </tags>
  </entry>
  <entry>
    <title>OpenWrt æ‰‹åŠ¨ç¼–è¯‘ ipk</title>
    <url>/posts/96a1807.html</url>
    <content><![CDATA[<h2 id="ipk-æ–‡ä»¶"><code>.ipk</code> æ–‡ä»¶</h2>
<p><code>.ipk</code> æ–‡ä»¶æ˜¯å¯ä»¥é€šè¿‡ OpenWrt çš„åŒ…ç®¡ç†è½¯ä»¶
<code>opkg</code> ç›´æ¥å®‰è£…ï¼Œå¥½æ¯” <code>.deb</code> æ–‡ä»¶ä¸
<code>apt</code>
çš„å…³ç³»ã€‚è™½ç„¶å®˜æ–¹çš„è½¯ä»¶ä»“åº“å·²ç»å¾ˆä¸°å¯Œäº†ï¼Œä½†æ˜¯æœ‰æ—¶ä»ç„¶éœ€è¦ä»æºç ç¼–è¯‘ä¸€äº›ç¬¬ä¸‰æ–¹çš„è½¯ä»¶ä½¿ç”¨ï¼Œä¾‹å¦‚é”æ·è®¤è¯ç­‰</p>
<p>ä½†æ˜¯ç”±äºè·¯ç”±å™¨å¹³å°é€šå¸¸ä¸å¸¸ç”¨çš„æœåŠ¡å™¨æˆ–è€…ä¸ªäºº PC
çš„å¤„ç†å™¨æ¶æ„ä¸åŒï¼Œå¹¶ä¸”è·¯ç”±å™¨çš„å¤„ç†å™¨æœ¬èº«æ€§èƒ½è¾ƒå¼±ï¼Œå‡ ä¹ä¸å¯èƒ½ç›´æ¥åœ¨è·¯ç”±å™¨ä¸Šè¿›è¡Œç¼–è¯‘ç”Ÿæˆ
<code>.ipk</code> æ–‡ä»¶ï¼Œå› æ­¤éœ€è¦äº¤å‰ç¼–è¯‘æ¥å®ç° <span id="more"></span></p>
<p>è€Œå®˜æ–¹çš„ <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL29wZW53cnQvb3BlbndydA==">OpenWrt<i class="fa fa-external-link-alt"></i></span>
ä»“åº“å°±æä¾›äº†ä¸€ä¸ªæ–¹ä¾¿ä½¿ç”¨çš„äº¤å‰ç¼–è¯‘ç¯å¢ƒ</p>
<h2 id="ç¼–è¯‘å‡†å¤‡">ç¼–è¯‘å‡†å¤‡</h2>
<p>ä»¥ Debian / Ubuntu ä¸ºä¾‹ï¼Œå‚è€ƒ <span class="exturl" data-url="aHR0cHM6Ly9vcGVud3J0Lm9yZy9kb2NzL2d1aWRlLWRldmVsb3Blci90b29sY2hhaW4vaW5zdGFsbC1idWlsZHN5c3RlbQ==">å®˜ç½‘ç»™å‡ºçš„è¦æ±‚<i class="fa fa-external-link-alt"></i></span>ï¼Œå¯ä»¥é€šè¿‡ä¸‹é¢å‘½ä»¤æ¥è¿›è¡Œå®‰è£…ä¾èµ–åŒ…</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt update</span><br><span class="line">sudo apt install build-essential ccache ecj fastjar file g++ gawk \</span><br><span class="line">gettext git java-propose-classpath libelf-dev libncurses5-dev \</span><br><span class="line">libncursesw5-dev libssl-dev python python2.7-dev python3 unzip wget \</span><br><span class="line">python3-distutils python3-setuptools python3-dev rsync subversion \</span><br><span class="line">swig time xsltproc zlib1g-dev</span><br></pre></td></tr></tbody></table></figure>
<p>å®‰è£… / æ›´æ–°å¥½è¿™äº›ä¾èµ–ä¹‹åï¼Œå°±å¯ä»¥é€šè¿‡ <code>git</code> æ‹‰å– OpenWrt
ä»“åº“äº†</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://git.openwrt.org/openwrt/openwrt.git</span><br></pre></td></tr></tbody></table></figure>
<p>é€šå¸¸ç”±äºä»“åº“è¾ƒå¤§ä»¥åŠç½‘é€Ÿé—®é¢˜ï¼Œå¯èƒ½ä¼šéœ€è¦å¾ˆä¹…ï¼Œå…¶å®å¯ä»¥é€šè¿‡
<code>--depth</code>
æ¥é™åˆ¶æ‹‰å–çš„ä»“åº“æ·±åº¦ï¼Œæˆ–è€…é€šè¿‡é•œåƒç«™æ¥åŠ é€Ÿæ‹‰å–ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ä¸¤è€…åŒæ—¶é‡‡ç”¨</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://git.openwrt.org/openwrt/openwrt.git --depth=1</span><br><span class="line"><span class="comment"># cnpmjs.org å·²ç»ä¸èƒ½ä½¿ç”¨ï¼Œè¯·è‡ªè¡Œå¯»æ‰¾å…¶ä»–é•œåƒç«™</span></span><br><span class="line"><span class="comment"># git clone https://git.openwrt.org.cnpmjs.org/openwrt/openwrt.git</span></span><br><span class="line"><span class="comment"># git clone https://git.openwrt.org.cnpmjs.org/openwrt/openwrt.git --depth=1</span></span><br></pre></td></tr></tbody></table></figure>
<h2 id="ç¼–è¯‘-.ipk-æ–‡ä»¶">ç¼–è¯‘ <code>.ipk</code> æ–‡ä»¶</h2>
<h3 id="æ›´æ–°-feeds">æ›´æ–° feeds</h3>
<p>è¿›å…¥ openwrt ä»“åº“åï¼Œé¦–å…ˆéœ€è¦æ›´æ–°è½¯ä»¶åŒ…åˆ—è¡¨
<code>feeds</code>ï¼Œå®ƒæ˜¯åœ¨ OpenWrt
ä¸­å…±ç”¨ä½ç½®çš„åŒ…çš„é›†åˆã€‚è¿è¡Œä»¥ä¸‹å‘½ä»¤å³å¯æ›´æ–°å†…ç½®è½¯ä»¶åŒ…åˆ—è¡¨å¹¶é“¾æ¥åˆ°ç¼–è¯‘å·¥å…·ä¸­ï¼š</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> openwrt/</span><br><span class="line">./scripts/feeds update</span><br><span class="line">./scripts/feeds install</span><br></pre></td></tr></tbody></table></figure>
<h3 id="é…ç½®å¹³å°">é…ç½®å¹³å°</h3>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">make menuconfig</span><br></pre></td></tr></tbody></table></figure>
<p>é€šå¸¸ä½¿ç”¨å›¾å½¢åŒ–èœå•ç•Œé¢æ¥è¿›è¡Œé…ç½®ç¼–è¯‘é€‰é¡¹ï¼Œä¾æ¬¡é…ç½®å¤„ç†å™¨æ¶æ„ã€å…·ä½“çš„å¤„ç†å™¨å‹å·ä»¥åŠè®¾å¤‡</p>
<p>ä»¥å°ç±³ R3G è·¯ç”±å™¨ä¸ºä¾‹ï¼Œåº”è¯¥å°†ä»–ä»¬é…ç½®æˆå¦‚ä¸‹å›¾æ‰€ç¤º</p>
<figure>
<img data-src="/posts/96a1807/Target-Config.png" alt="å¹³å°é…ç½®">
<figcaption aria-hidden="true">å¹³å°é…ç½®</figcaption>
</figure>
<h3 id="è·å–äº¤å‰ç¼–è¯‘é“¾">è·å–äº¤å‰ç¼–è¯‘é“¾</h3>
<p>è¿™ä¸€æ­¥å°±æ˜¯è·å–å¯¹åº”è®¾å¤‡äº¤å‰ç¼–è¯‘æ‰€éœ€çš„ç¼–è¯‘é“¾</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">make tools/install V=s -j$(grep processor /proc/cpuinfo | <span class="built_in">wc</span> -l)</span><br><span class="line">make toolchain/install V=s -j$(grep processor /proc/cpuinfo | <span class="built_in">wc</span> -l)</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>V=s</code> å¯ä»¥æ˜¾ç¤º <code>make</code>
è¿‡ç¨‹ä¸­çš„æ‰€æœ‰è¾“å‡ºï¼Œæ–¹ä¾¿å®šä½å½“å‰æ˜¯å¦å¡åœ¨äº†æŸä¸€æ­¥éª¤ä¸Š</li>
<li><code>-j$(grep processor /proc/cpuinfo | wc -l)</code>
åˆ™æ˜¯æ ¹æ®æœºå™¨çš„ CPU æ•°é‡æ¥è¿›è¡Œå¤šçº¿ç¨‹ç¼–è¯‘</li>
<li>ç›´æ¥ <code>-j</code> ä¹Ÿå¯ä»¥</li>
</ul>
<h3 id="æ·»åŠ éœ€è¦ç¼–è¯‘çš„ç¬¬ä¸‰æ–¹è½¯ä»¶åŒ…">æ·»åŠ éœ€è¦ç¼–è¯‘çš„ç¬¬ä¸‰æ–¹è½¯ä»¶åŒ…</h3>
<p>å¯ä»¥å…ˆæœç´¢æœ‰æ²¡æœ‰å·²ç»é…ç½®å¥½çš„å«æœ‰ <code>Makefile</code>
çš„ä»“åº“ï¼Œæœ‰äº†é€‚é…è¿‡çš„ <code>Makefile</code>
æ–‡ä»¶å°±å¯ä»¥å¾ˆæ–¹ä¾¿çš„æ¥ç¼–è¯‘æºç ç”Ÿæˆ <code>.ipk</code> æ–‡ä»¶äº†</p>
<p>ä»¥ <code>MentoHUST</code> ä¸ºä¾‹ï¼Œ<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0t5bGVSaWNhcmRvL01lbnRvSFVTVC1PcGVuV3J0LWlwaw==">github<i class="fa fa-external-link-alt"></i></span>
ä¸Šæœ‰å·²ç»å®Œæˆçš„ä»“åº“ï¼Œä¾æ¬¡å¯ä»¥ç›´æ¥æ‹‰å–æ¥ç¼–è¯‘</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/KyleRicardo/MentoHUST-OpenWrt-ipk.git package/minieap</span><br></pre></td></tr></tbody></table></figure>
<p>åœ¨æ‹‰å–å®Œæˆä»“åº“åï¼Œå°±å¯ä»¥å†æ¬¡é…ç½®ç¼–è¯‘é€‰é¡¹ï¼Œå°†éœ€è¦ç¼–è¯‘æˆ
<code>.ipk</code> çš„åŠŸèƒ½é…ç½®æˆæ¨¡å—ç¼–è¯‘ï¼Œä¹Ÿå°±æ˜¯æ ‡è®°æˆ <code>M</code></p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">make menuconfig</span><br></pre></td></tr></tbody></table></figure>
<p>å¯¹äº <code>MentoHUST</code> æ¥è¯´ï¼Œåœ¨ <code>Network</code> ä¸­çš„
<code>Ruijie</code> æ‰¾åˆ°å¯¹åº”é€‰é¡¹å¹¶é…ç½®æˆ <code>M</code> å³å¯ï¼Œå¦‚ä¸‹å›¾</p>
<figure>
<img data-src="/posts/96a1807/MentoHUST-Config.png" alt="MentoHUST é…ç½®">
<figcaption aria-hidden="true">MentoHUST é…ç½®</figcaption>
</figure>
<p>é…ç½®å®Œæˆåå°±å¯ä»¥è¿›è¡Œç¼–è¯‘äº†ï¼Œç¼–è¯‘å‘½ä»¤ä¹Ÿå¾ˆç®€å•ï¼Œä»¥
<code>MentoHUST</code> ä¸ºä¾‹å¦‚ä¸‹æ‰€ç¤º</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">make package/mentohust/compile V=s -j</span><br></pre></td></tr></tbody></table></figure>
<p>ç¼–è¯‘å®Œæˆåï¼Œ<code>.ipk</code> æ–‡ä»¶ä¼šç”Ÿæˆåœ¨
<code>./bin/packages/&lt;YourArchitecture&gt;/base</code>
ç›®å½•ä¸‹ï¼Œå°†å…¶æ‹·è´åˆ°è·¯ç”±å™¨ä¸Šå°±å¯ä»¥é€šè¿‡ <code>opkg</code>
è¿›è¡Œå®‰è£…ä½¿ç”¨äº†</p>
<h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h2>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9vcGVud3J0Lm9yZy9kb2NzL2d1aWRlLWRldmVsb3Blci90b29sY2hhaW4vaW5zdGFsbC1idWlsZHN5c3RlbQ==">ã€OpenWrtã€‘ç¼–è¯‘ç³»ç»Ÿå‡†å¤‡<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9vcGVud3J0LW5jdHUuZ2l0Ym9vay5pby9wcm9qZWN0L29wZW53cnQtY29tcGlsZS1lbnYvb3BlbndydC1zZGstYW5kLWlway1mb3JtYXQ=">ã€Gitbookã€‘å»ºç«‹ç¼–è¯‘ç¯å¢ƒ<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL29wZW53cnQvb3BlbndydA==">ã€GitHubã€‘OpenWrt<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0t5bGVSaWNhcmRvL01lbnRvSFVTVC1PcGVuV3J0LWlwaw==">ã€GitHubã€‘MentoHUST-OpenWrt-ipk<i class="fa fa-external-link-alt"></i></span></li>
</ul>
]]></content>
      <categories>
        <category>è·¯ç”±å™¨</category>
      </categories>
      <tags>
        <tag>OpenWrt</tag>
        <tag>äº¤å‰ç¼–è¯‘</tag>
        <tag>ipk</tag>
      </tags>
  </entry>
  <entry>
    <title>OpenWrt ç®€ä»‹å’Œå®‰è£…</title>
    <url>/posts/8507aaa1.html</url>
    <content><![CDATA[<h2 id="ç®€ä»‹">ç®€ä»‹</h2>
<h3 id="æ¥æº">æ¥æº</h3>
<p>2002 å¹´åº• Linksys å…¬å¸æ¨å‡º WRT-54Gï¼Œé‡‡ç”¨äº† Linux å–ä»£äº†åŸæ¥çš„ vXworks
ç³»ç»Ÿã€‚è¿«äº Linux çš„å¼€æºåè®®è¦æ±‚ï¼ŒLinksys
å¼€æºäº†è·¯ç”±å™¨çš„å›ºä»¶ä»£ç ï¼Œåç»­é€æ¸å‘å±•æˆäº† OpenWrt è¿™æ ·ä¸€ä¸ªé¡¹ç›®
<span id="more"></span></p>
<h3 id="ä»‹ç»">ä»‹ç»</h3>
<p>OpenWrt æ˜¯ä¸€ä¸ªé’ˆå¯¹åµŒå…¥å¼è®¾å¤‡ï¼ˆé€šå¸¸æ˜¯è·¯ç”±å™¨æˆ–è€…è½¯è·¯ç”±ï¼‰çš„ Linux
æ“ä½œç³»ç»Ÿé¡¹ç›®ï¼Œæä¾›äº†å…·æœ‰è½¯ä»¶åŒ…ç®¡ç†åŠŸèƒ½çš„å®Œå…¨å¯å†™çš„æ–‡ä»¶ç³»ç»Ÿï¼Œå› æ­¤æ‹¥æœ‰äº†å®Œå…¨å®šåˆ¶çš„èƒ½åŠ›ï¼Œå¯ä»¥æ¦¨å¹²è®¾å¤‡çš„å…¨éƒ¨æ€§èƒ½</p>
<h2 id="å®‰è£…">å®‰è£…</h2>
<p>åˆæ¬¡å®‰è£…æ¨èåœ¨ <span class="exturl" data-url="aHR0cHM6Ly9vcGVud3J0Lm9yZy90b2gvc3RhcnQ=">æ”¯æŒè®¾å¤‡åˆ—è¡¨<i class="fa fa-external-link-alt"></i></span>
ä¸­æ‰¾åˆ°å¯¹åº”è®¾å¤‡æ‰€åœ¨çš„ <span class="exturl" data-url="aHR0cHM6Ly9vcGVud3J0Lm9yZy90b2gvc3RhcnQ/ZGF0YXNydD0lNUVkZXZpY2UlMjBwYWdl">è®¾å¤‡ä¸“å±é¡µé¢<i class="fa fa-external-link-alt"></i></span>ï¼Œç„¶åæ ¹æ®é¡µé¢ä»‹ç»è¿›è¡Œå®‰è£…</p>
<h3 id="ä¸€èˆ¬å®‰è£…æµç¨‹">ä¸€èˆ¬å®‰è£…æµç¨‹</h3>
<p>é€šå¸¸çš„å®‰è£…æ­¥éª¤ä¸»è¦é€šè¿‡ä»¥ä¸‹æµç¨‹ï¼š</p>
<ol type="1">
<li>è·å–åŸå‚å›ºä»¶çš„ SSH ç™»å½•æƒé™ï¼ˆå¯èƒ½æ˜¯é€šè¿‡åŸå‚å›ºä»¶æ¼æ´ç­‰æ–¹å¼ï¼‰</li>
<li>åœ¨åŸå‚å›ºä»¶ä¸Šåˆ©ç”¨ <code>cat /proc/mtd</code> è·å– ROM åˆ†åŒºçš„å¸ƒå±€</li>
<li> [å¯é€‰] å¤‡ä»½åŸæœ‰çš„æ‰€æœ‰ ROM åˆ†åŒºæ•°æ®</li>
<li>åˆ©ç”¨ <code>mtd</code> ç­‰å‘½ä»¤ç›´æ¥å¯¹ç›¸åº”çš„ ROM åŒºåŸŸè¿›è¡Œå†™å…¥é•œåƒ
<ul>
<li>[å¯é€‰] bootloader é•œåƒï¼ˆè®¾å¤‡è¿è¡Œçš„æƒ…å†µä¸‹ï¼Œä¸ªäººæ›´å€¾å‘äºåˆ·å…¥ <a href="/posts/53d6c2d9.html">Breed</a>ï¼‰</li>
<li>kernel é•œåƒ</li>
<li> rootfs é•œåƒ</li>
</ul></li>
<li>é‡å¯è®¾å¤‡</li>
</ol>
<h3 id="å›ºä»¶æœç´¢ä¸‹è½½">å›ºä»¶æœç´¢ä¸‹è½½</h3>
<p>å®˜ç½‘ä¹Ÿå¯¹è€æ‰‹æä¾›äº†å¿«æ·çš„ <span class="exturl" data-url="aHR0cHM6Ly9maXJtd2FyZS1zZWxlY3Rvci5vcGVud3J0Lm9yZy8=">å›ºä»¶æœç´¢<i class="fa fa-external-link-alt"></i></span>
é¡µé¢ï¼Œèƒ½å¤Ÿæ›´åŠ å¿«æ·çš„æ‰¾åˆ° ROM é•œåƒçš„ä¸‹è½½ç•Œé¢</p>
<h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h2>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvT3BlbldydA==">ã€ç»´åŸºç™¾ç§‘ã€‘OpenWrt<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9vcGVud3J0Lm9yZy8=">ã€OpenWrtã€‘å®˜ç½‘<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9vcGVud3J0Lm9yZy90b2gvc3RhcnQ=">ã€OpenWrtã€‘æ”¯æŒè®¾å¤‡åˆ—è¡¨<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9maXJtd2FyZS1zZWxlY3Rvci5vcGVud3J0Lm9yZy8=">ã€OpenWrtã€‘å›ºä»¶æœç´¢<i class="fa fa-external-link-alt"></i></span></li>
</ul>
]]></content>
      <categories>
        <category>è·¯ç”±å™¨</category>
      </categories>
      <tags>
        <tag>OpenWrt</tag>
      </tags>
  </entry>
  <entry>
    <title>OpenWrt é…ç½®ä½¿ç”¨</title>
    <url>/posts/51140c4a.html</url>
    <content><![CDATA[<h2 id="web-ç•Œé¢">Web ç•Œé¢</h2>
<p>ä¸€èˆ¬ OpenWrt å®‰è£…å¥½ä¹‹åä¼šå·²ç»é»˜å¯ç”¨äº† Web
ç®¡ç†ç•Œé¢ï¼ˆLuCIï¼‰ï¼Œé»˜è®¤åœ°å€æ˜¯ <code>192.168.1.1</code>ï¼Œé»˜è®¤è´¦å·æ˜¯
<code>root</code>ï¼Œæ— å¯†ç ï¼Œç›´æ¥ç‚¹å‡»ç™»å½•å³å¯è¿›å…¥ <span id="more"></span></p>
<h3 id="æ±‰åŒ–">æ±‰åŒ–</h3>
<p>é»˜è®¤ç•Œé¢æ˜¯è‹±æ–‡çš„ï¼Œå¯ä»¥åœ¨ <span class="exturl" data-url="aHR0cDovLzE5Mi4xNjguMS4xL2NnaS1iaW4vbHVjaS9hZG1pbi9zeXN0ZW0vb3BrZw==">ç³»ç»Ÿ - è½¯ä»¶<i class="fa fa-external-link-alt"></i></span>
ä¸­æœç´¢ä¸­æ–‡åŒ…å®‰è£…è¿›è¡Œæ±‰åŒ–</p>
<ul>
<li>ç‚¹å‡» <code>UPDATE LIST...</code> è€å¿ƒç­‰å¾…è½¯ä»¶åŒ…çš„æ›´æ–°</li>
<li>ç„¶ååœ¨ <code>Filter:</code> ä¸‹çš„è¾“å…¥æ¡†ä¸­è¾“å…¥
<code>luci-i18n-base-zh-cn</code>ï¼Œåœ¨ç­›é€‰å‡ºæ¥çš„ç»“æœä¸­ç‚¹å‡»
<code>INSTALL...</code>ï¼Œå®‰è£…å‹¾ä¸Š
<code>Overwrite files from other package(s)</code>ï¼Œç„¶åç‚¹å‡»
<code>INSTALL</code>ï¼Œè€å¿ƒç­‰å¾…å®‰è£…å®Œæˆä¹‹ååˆ·æ–°ç½‘é¡µï¼ˆCtrl+F5ï¼‰å¯ä»¥çœ‹è§å¤§éƒ¨åˆ†ç•Œé¢å·²ç»æ±‰åŒ–äº†</li>
<li>åŒç†å®‰è£… <code>luci-i18n-opkg-zh-cn</code> åŒ…ç”¨äº <span class="exturl" data-url="aHR0cDovLzE5Mi4xNjguMS4xL2NnaS1iaW4vbHVjaS9hZG1pbi9zeXN0ZW0vb3BrZw==">ç³»ç»Ÿ - è½¯ä»¶<i class="fa fa-external-link-alt"></i></span>
ç•Œé¢çš„æ±‰åŒ–</li>
<li>åŒç†å®‰è£… <code>luci-i18n-firewall-zh-cn</code> åŒ…ç”¨äº <span class="exturl" data-url="aHR0cDovLzE5Mi4xNjguMS4xL2NnaS1iaW4vbHVjaS9hZG1pbi9uZXR3b3JrL2ZpcmV3YWxs">ç½‘ç»œ - é˜²ç«å¢™<i class="fa fa-external-link-alt"></i></span>
ç•Œé¢çš„æ±‰åŒ– </li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">opkg update</span><br><span class="line">opkg install luci-i18n-base-zh-cn luci-i18n-opkg-zh-cn luci-i18n-firewall-zh-cn</span><br></pre></td></tr></tbody></table></figure>
<h3 id="root-å¯†ç ">root å¯†ç </h3>
<p>è¿›å…¥ç®¡ç†ç•Œé¢åè¿›å…¥ <span class="exturl" data-url="aHR0cDovLzE5Mi4xNjguMS4xL2NnaS1iaW4vbHVjaS9hZG1pbi9zeXN0ZW0vYWRtaW4vcGFzc3dvcmQ=">ç³»ç»Ÿ - ç®¡ç† - å¯†ç <i class="fa fa-external-link-alt"></i></span>
ç•Œé¢ä¿®æ”¹è·¯ç”±å™¨å¯†ç ï¼ŒåŒæ—¶ä¹Ÿæ˜¯ç³»ç»Ÿçš„ root è´¦å·çš„å¯†ç </p>
<h3 id="ssh">ssh</h3>
<p>ç„¶ååœ¨ <span class="exturl" data-url="aHR0cDovLzE5Mi4xNjguMS4xL2NnaS1iaW4vbHVjaS9hZG1pbi9zeXN0ZW0vYWRtaW4vZHJvcGJlYXI=">ç³»ç»Ÿ - ç®¡ç† - ssh<i class="fa fa-external-link-alt"></i></span>
å¯ä»¥é…ç½® ssh ç™»å½•ï¼Œå‚è€ƒé…ç½®å¦‚ä¸‹</p>
<ul>
<li>æ¥å£ï¼šä¸æŒ‡å®š â†’ å†…ç½‘ä»¥åŠå¤–ç½‘éƒ½å¯ä»¥ ssh ç™»å½•</li>
<li>ç«¯å£ï¼š22 â†’ ssh é»˜è®¤ç«¯å£ï¼Œä¸åšä¿®æ”¹</li>
<li>å¯†ç éªŒè¯ï¼šä¸å‹¾é€‰ â†’ æ¨èä½¿ç”¨ ssh ç™»å½•</li>
<li>å…è®¸ root ç”¨æˆ·å‡­å¯†ç ç™»å½•ï¼šä¸å‹¾é€‰ â†’ æ¨èä½¿ç”¨ ssh ç™»å½•</li>
<li>ç½‘å…³ç«¯å£ï¼šæ ¹æ®éœ€è¦å‹¾é€‰</li>
</ul>
<p>æŒ‰ç…§ä¸Šé¢é…ç½®å®Œæˆåå°†åªèƒ½é€šè¿‡ ssh å¯†é’¥è¿›è¡Œç™»å½•ï¼Œæ‰€ä»¥è¿˜å¾—åœ¨ <span class="exturl" data-url="aHR0cDovLzE5Mi4xNjguMS4xL2NnaS1iaW4vbHVjaS9hZG1pbi9zeXN0ZW0vYWRtaW4vc3Noa2V5cw==">ç³»ç»Ÿ - ç®¡ç† - ssh å¯†é’¥<i class="fa fa-external-link-alt"></i></span>
æ·»åŠ è®¾å¤‡çš„å…¬é’¥</p>
<h3 id="å‡çº§-luci">å‡çº§ LuCI</h3>
<p>ssh ç™»å…¥è·¯ç”±å™¨åæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># æ›´æ–°è½¯ä»¶æº</span></span><br><span class="line">opkg update</span><br><span class="line"><span class="comment"># luci-compat åŒ…æœ‰æ—¶å¯ä»¥å¸®åŠ©è§£å†³ä¸€äº›å…¼å®¹æ€§é—®é¢˜ï¼Œæ¨èä¸€åŒå®‰è£…</span></span><br><span class="line">opkg install luci luci-base luci-compat</span><br></pre></td></tr></tbody></table></figure>
<h3 id="ç¾åŒ–">ç¾åŒ–</h3>
<p>åŸå§‹çš„ <code>bootstrap</code>
ä¸»é¢˜ä¸ªäººä¸å¤ªå–œæ¬¢ï¼Œåœ¨ç©ºé—´è¶³å¤Ÿçš„æƒ…å†µä¸‹æˆ‘ä¸ªäººé¢å¤–å®‰è£…äº†
<code>material</code>ï¼Œä¸»é¢˜çš„åˆ‡æ¢åœ¨ <span class="exturl" data-url="aHR0cDovLzE5Mi4xNjguMS4xL2NnaS1iaW4vbHVjaS9hZG1pbi9zeXN0ZW0vc3lzdGVt">ç³»ç»Ÿ - ç³»ç»Ÿ - è¯­è¨€å’Œç•Œé¢<i class="fa fa-external-link-alt"></i></span>
ä¸­</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">opkg update</span><br><span class="line">opkg install luci-theme-material</span><br></pre></td></tr></tbody></table></figure>
<h2 id="usb">USB</h2>
<p>å¾ˆå¤šè·¯ç”±å™¨æœ‰ USB ç«¯å£ï¼Œé€šè¿‡æ’å…¥ U ç›˜æˆ–è€…æ¥å…¥ç£ç›˜ã€SSD
ç­‰è®¾å¤‡å¯ä»¥æ‹“å±•å­˜å‚¨ç©ºé—´ï¼Œè¿™æ ·å°±å¯ä»¥å®‰è£…æ›´å¤šçš„æ’ä»¶ï¼Œæˆ–è€…æ­å»ºä¸€ä¸ªç®€å•çš„
FTPã€SMB æœåŠ¡å™¨ç”¨äºå…±äº«æ•°æ®</p>
<h3 id="å®‰è£…-usb-é©±åŠ¨">å®‰è£… USB é©±åŠ¨</h3>
<p>ä¾æ¬¡æ‰§è¡Œä»¥ä¸‹å‘½ä»¤è¿›è¡Œé©±åŠ¨åŸºæœ¬åŒ…çš„å®‰è£…</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">opkg update</span><br><span class="line">opkg install kmod-usb-core</span><br><span class="line"><span class="comment"># insmod usbcore</span></span><br><span class="line">opkg install kmod-usb-storage</span><br></pre></td></tr></tbody></table></figure>
<p>å¦‚æœè®¾å¤‡æ˜¯ USB 2.0</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">opkg install kmod-usb2</span><br><span class="line"><span class="comment"># insmod ehci-hcd</span></span><br></pre></td></tr></tbody></table></figure>
<p>å¦‚æœè®¾å¤‡æ˜¯ USB 3.0</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">opkg install kmod-usb3</span><br><span class="line"><span class="comment"># insmod xhci-hcd</span></span><br></pre></td></tr></tbody></table></figure>
<p>é€šå¸¸ç§»åŠ¨ç¡¬ç›˜æˆ–è€…ç§»åŠ¨ SSD è¿˜éœ€è¦å®‰è£… UAS/UASP æ”¯æŒ</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">opkg install kmod-usb-storage-uas</span><br></pre></td></tr></tbody></table></figure>
<p>ç„¶åçƒ­æ’æ‹”å­˜å‚¨è®¾å¤‡ï¼Œé€šå¸¸å°±èƒ½åœ¨ <code>/dev</code> ç›®å½•ä¸‹çœ‹è§
<code>sda</code> è®¾å¤‡äº†</p>
<h3 id="è‡ªåŠ¨æŒ‚è½½">è‡ªåŠ¨æŒ‚è½½</h3>
<ul>
<li><p>å®‰è£…å—è®¾å¤‡å·¥å…·åŒ…</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">opkg install block-mount</span><br></pre></td></tr></tbody></table></figure></li>
<li><p>åˆ†åŒº</p>
<p>ä¸ªäººå·²ç»æå‰å°†å­˜å‚¨è®¾å¤‡åˆ’åˆ†äº†ä¸¤ä¸ªåˆ†åŒºï¼Œä¸€ä¸ªåˆ†åŒºè¾ƒå° (sda1) ç”¨äºåç»­çš„ <a href="#extroot">Extroot</a>ï¼Œå‰©ä½™çš„ç©ºé—´ (sda2) å…¨ç”¨äºå­˜å‚¨ä¸ªäººæ•°æ®</p></li>
<li><p>åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿ</p>
<p>æ¨èç§»åŠ¨ç£ç›˜ç”¨ ext4 æ–‡ä»¶ç³»ç»Ÿï¼Œè€Œç§»åŠ¨ SSD æ¨èä½¿ç”¨ f2fs æ–‡ä»¶ç³»ç»Ÿ</p>
<p>åˆ†åŒºå’Œåˆ›å»ºæ–‡ä»¶ç³»ç»Ÿå¯ä»¥å‚è€ƒ <span class="exturl" data-url="aHR0cHM6Ly9vcGVud3J0Lm9yZy9kb2NzL2d1aWRlLXVzZXIvc3RvcmFnZS91c2ItZHJpdmVzI2NyZWF0ZV9hX3BhcnRpdGlvbl9vbl90aGVfdXNiX2Rpc2s=">å®˜ç½‘çš„æŒ‡å¯¼<i class="fa fa-external-link-alt"></i></span></p>
<p>ä¾‹å¦‚ï¼š</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># ext4</span></span><br><span class="line">opkg install e2fsprogs</span><br><span class="line">opkg install kmod-fs-ext4</span><br><span class="line">mkfs.ext4 /dev/sda1</span><br><span class="line"></span><br><span class="line"><span class="comment"># f2fs</span></span><br><span class="line">opkg install f2fs-tools</span><br><span class="line">opkg install kmod-fs-f2fs</span><br><span class="line">mkfs.f2fs /dev/sda1</span><br></pre></td></tr></tbody></table></figure></li>
<li><p>é…ç½®æŒ‚è½½</p>
<p>é…ç½®æŒ‚è½½å¯ä»¥é€šè¿‡ç›´æ¥åœ¨ç½‘é¡µç«¯çš„ <span class="exturl" data-url="aHR0cDovLzE5Mi4xNjguMS4xL2NnaS1iaW4vbHVjaS9hZG1pbi9zeXN0ZW0vbW91bnRz">ç³»ç»Ÿ - æŒ‚è½½ç‚¹<i class="fa fa-external-link-alt"></i></span>
è¿›è¡Œæ‰‹åŠ¨é…ç½®ï¼Œæ¯”è¾ƒç›´è§‚ï¼Œå¦‚å›¾æ‰€ç¤ºï¼š</p>
<figure>
<img data-src="/posts/51140c4a/Mount-sda6.png" alt="æŒ‚è½½è®¾å¤‡">
<figcaption aria-hidden="true">æŒ‚è½½è®¾å¤‡</figcaption>
</figure>
<ul>
<li>å·²å¯ç”¨ï¼šå‹¾é€‰</li>
<li> UUIDï¼šæ¨èä½¿ç”¨ UUID æ¥è¿›è¡ŒæŒ‚è½½</li>
<li>æŒ‚è½½ç‚¹ï¼šä¹Ÿå°±æ˜¯æŒ‚è½½çš„ä½ç½®ï¼Œé€šå¸¸åœ¨ <code>/mnt</code>
ç›®å½•ä¸‹æ–°å»ºä¸€ä¸ªæ–‡ä»¶å¤¹</li>
</ul></li>
</ul>
<h3 id="extroot">Extroot</h3>
<p>æœ‰æ—¶å€™å®‰è£…å¤ªå¤šåŒ…ä¼šå¯¼è‡´æœ¬åœ°ç©ºé—´ä¸è¶³ï¼Œæ­¤æ—¶å¯ä»¥é€šè¿‡å°†åŒ…å®‰è£…åœ¨ USB
è®¾å¤‡ä¸Šï¼Œä¹Ÿå¯ä»¥é€šè¿‡ Extroot çš„æ–¹å¼å°† USB è®¾å¤‡çš„ç©ºé—´ç›´æ¥é…ç½®æˆ
<code>overlay</code> åˆ†åŒºï¼Œåè€…æ›´ä¸ºæ¨è</p>
<ol type="1">
<li><p>ä¿®æ”¹ <code>fstab</code>ï¼Œå°†åŸæœ¬æŒ‚è½½çš„ <code>overlay</code>
è®¾å¤‡æŒ‚è½½åˆ°æ–°çš„ç›®å½• <code>/rwm</code></p>
<p></p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">DEVICE=<span class="string">"<span class="subst">$(sed -n -e <span class="string">"/\s\/overlay\s.*$/s///p"</span> /etc/mtab)</span>"</span></span><br><span class="line">uci -q delete fstab.rwm</span><br><span class="line">uci <span class="built_in">set</span> fstab.rwm=<span class="string">"mount"</span></span><br><span class="line">uci <span class="built_in">set</span> fstab.rwm.device=<span class="string">"<span class="variable">${DEVICE}</span>"</span></span><br><span class="line">uci <span class="built_in">set</span> fstab.rwm.target=<span class="string">"/rwm"</span></span><br><span class="line">uci commit fstab</span><br></pre></td></tr></tbody></table></figure><p></p></li>
<li><p>ä¿®æ”¹ <code>fstab</code>ï¼Œé…ç½® USB è®¾å¤‡æŒ‚è½½æˆ <code>overlay</code>
åˆ†åŒº</p>
<p>å…¶ä¸­éƒ¨åˆ†éƒ¨åˆ†æ“ä½œåœ¨ <a href="#è‡ªåŠ¨æŒ‚è½½">ä¸ŠèŠ‚</a>
å·²ç»æ‰§è¡Œè¿‡ï¼Œå¯ä»¥ç•¥å»</p>
<p></p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹åˆ†åŒºä¿¡æ¯</span></span><br><span class="line"><span class="comment"># block info</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¡®å®šåˆ†åŒºå¹¶åˆ¶ä½œæ–‡ä»¶ç³»ç»Ÿ</span></span><br><span class="line">DEVICE=<span class="string">"/dev/sda1"</span></span><br><span class="line"><span class="comment"># mkfs.ext4 ${DEVICE}</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">eval</span> $(block info <span class="variable">${DEVICE}</span> | grep -o -e <span class="string">"UUID=\S*"</span>)</span><br><span class="line">uci -q delete fstab.overlay</span><br><span class="line">uci <span class="built_in">set</span> fstab.overlay=<span class="string">"mount"</span></span><br><span class="line">uci <span class="built_in">set</span> fstab.overlay.uuid=<span class="string">"<span class="variable">${UUID}</span>"</span></span><br><span class="line">uci <span class="built_in">set</span> fstab.overlay.target=<span class="string">"/overlay"</span></span><br><span class="line">uci commit fstab</span><br></pre></td></tr></tbody></table></figure><p></p></li>
<li><p>å°†åŸæœ¬ <code>overlay</code> åˆ†åŒºæ•°æ®å¤åˆ¶åˆ° USB
è®¾å¤‡ä¸Šï¼Œé‡å¯è®¾å¤‡</p>
<p></p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /tmp/cproot</span><br><span class="line">mount --<span class="built_in">bind</span> /overlay /tmp/cproot</span><br><span class="line"><span class="built_in">mkdir</span> -p /mnt/tmp</span><br><span class="line">mount <span class="variable">${DEVICE}</span> /mnt/tmp</span><br><span class="line">tar -C /tmp/cproot -cvf - . | tar -C /mnt/tmp -xf -</span><br><span class="line">umount /tmp/cproot /mnt/tmp</span><br><span class="line">reboot</span><br></pre></td></tr></tbody></table></figure><p></p></li>
</ol>
<h2 id="é”æ·è®¤è¯">é”æ·è®¤è¯</h2>
<p>å¾ˆå¤šå­¦æ ¡æ ¡å›­ç½‘é€šå¸¸é‡‡ç”¨é”æ·è®¤è¯ï¼Œå¹¶ä¸”é™åˆ¶äº†ç”¨æˆ·è´¦å·çš„ç™»é™†æ•°é‡ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨è·¯ç”±å™¨ä¸Šè¿›è¡Œé”æ·è®¤è¯æ¥æ¥å…¥æ ¡å›­ç½‘ï¼Œä¹‹åè¿æ¥è·¯ç”±å™¨çš„æ‰€æœ‰è®¾å¤‡éƒ½ä¼šç›´æ¥æ¥å…¥æ ¡å›­ç½‘è€Œä¸éœ€è¦è®¤è¯äº†</p>
<h3 id="mentohust">MentoHUST</h3>
<p><strong>é¦–é€‰ï¼Œè‡ªåŠ¨é‡è¿æ¯” Minieap é è°±å¾—å¤šï¼ï¼ï¼</strong></p>
<p><span class="exturl" data-url="aHR0cDovL2J5aGguaHVzdC5lZHUuY24vY2dpLWJpbi9iYnNuZXd0Y29uP2JvYXJkPU5ldFJlc291cmNlJmZpbGU9TS4xMjMwNzc0MjgyLkE=">MentoHUST<i class="fa fa-external-link-alt"></i></span>
æ˜¯åä¸­ç§‘æŠ€å¤§å­¦çš„ <span class="exturl" data-url="aHR0cDovL2J5aGguaHVzdC5lZHUuY24vY2dpLWJpbi9iYnNxcnk/dXNlcmlkPUh1c3RNb29u">HustMoon<i class="fa fa-external-link-alt"></i></span>
æœ€åˆåœ¨æ ¡å†… BBS ç™½äº‘é»„é¹¤ä¸Šå‘å¸ƒçš„ä¸€æ¬¾å¯ä»¥åœ¨ Linux
ç³»ç»Ÿä¸Šè¿›è¡Œé”æ·è®¤è¯çš„è½¯ä»¶ã€‚ä¸è¿‡ <span class="exturl" data-url="aHR0cHM6Ly9jb2RlLmdvb2dsZS5jb20vYXJjaGl2ZS9wL21lbnRvaHVzdC8=">åŸå§‹é¡¹ç›®<i class="fa fa-external-link-alt"></i></span>
å·²ç»å½’æ¡£ï¼Œä¸åœ¨å¼€å‘ï¼ŒGitHub ä¸Šæœ‰åŠ å…¥ v4 æ”¯æŒçš„ <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2h5cmF0aGIvbWVudG9odXN0">æ–°é¡¹ç›®<i class="fa fa-external-link-alt"></i></span></p>
<p>è€Œåœ¨ OpenWrt å¯ä»¥é€šè¿‡ GitHub ä¸Šçš„ä¸¤ä¸ªé¡¹ç›®æ‰‹åŠ¨ç¼–è¯‘ <code>.ipk</code>
æ–‡ä»¶ï¼Œç„¶å <code>opkg install xxx.ipk</code> è¿›è¡Œå®‰è£…å³å¯</p>
<ul>
<li>é€šè¿‡ <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0t5bGVSaWNhcmRvL01lbnRvSFVTVC1PcGVuV3J0LWlwaw==">MentoHUST-OpenWrt-ipk<i class="fa fa-external-link-alt"></i></span>
OpenWrt é¡¹ç›®å¯ä»¥ç”Ÿæˆ <code>mentohust</code> çš„äºŒè¿›åˆ¶æ–‡ä»¶</li>
<li><del>é€šè¿‡ <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0JvcmluZ0NhdC9sdWNpLWFwcC1tZW50b2h1c3Q=">OpenWrt/LEDE LuCI
for MentoHUST<i class="fa fa-external-link-alt"></i></span> é¡¹ç›®å¯ä»¥ç”Ÿæˆ MentoHUST çš„ LuCI
æ§åˆ¶ç•Œé¢</del>ï¼ˆå‘½ä»¤è¡Œå·²ç»è¶³å¤Ÿï¼‰</li>
</ul>
<p>æ‰‹åŠ¨ç¼–è¯‘ <code>ipk</code> æ–‡ä»¶çš„è¿‡ç¨‹å¯ä»¥å‚è€ƒ <a href="/posts/96a1807.html">è¿™é‡Œ</a></p>
<h3 id="minieap"><del>MiniEAP</del></h3>
<p><del><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3VwZGF0ZWluZy9taW5pZWFw">MiniEAP<i class="fa fa-external-link-alt"></i></span>
æ˜¯ä¸€ä¸ªå®ç°äº†æ ‡å‡† EAP-MD5-Challenge ç®—æ³•çš„ EAP
å®¢æˆ·ç«¯ï¼Œæ”¯æŒé€šè¿‡æ’ä»¶æ¥ä¿®æ”¹æ ‡å‡†æ•°æ®åŒ…ä»¥é€šè¿‡ç‰¹æ®ŠæœåŠ¡ç«¯çš„è®¤è¯ã€‚åŒæ—¶å«æœ‰æ”¯æŒé”æ·
v3 (v4) ç®—æ³•çš„æ’ä»¶ï¼Œå¯ä»¥ç”¨æ¥è¿›è¡Œé”æ·è®¤è¯</del></p>
<p><del>è€Œåœ¨ OpenWrt å¯ä»¥é€šè¿‡ GitHub ä¸Šçš„ä¸¤ä¸ªé¡¹ç›®æ‰‹åŠ¨ç¼–è¯‘
<code>.ipk</code> æ–‡ä»¶ï¼Œç„¶å <code>opkg install xxx.ipk</code>
è¿›è¡Œå®‰è£…å³å¯</del></p>
<ul>
<li><del>é€šè¿‡ <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0JvcmluZ0NhdC9taW5pZWFwLW9wZW53cnQ=">minieap-openwrt<i class="fa fa-external-link-alt"></i></span>
é¡¹ç›®å¯ä»¥ç”Ÿæˆ <code>minieap</code> çš„äºŒè¿›åˆ¶æ–‡ä»¶</del></li>
<li><del>(å¯é€‰) é€šè¿‡ <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0JvcmluZ0NhdC9sdWNpLWFwcC1taW5pZWFw">OpenWrt/LEDE LuCI
for minieap<i class="fa fa-external-link-alt"></i></span> é¡¹ç›®å¯ä»¥ç”Ÿæˆ MiniEAP çš„ LuCI æ§åˆ¶ç•Œé¢</del></li>
</ul>
<p><del>è¡¥å……ï¼šå¦‚æœæƒ³è¦æ‰çº¿è‡ªåŠ¨é‡æ–°è®¤è¯ï¼Œåœ¨é…ç½®æ–‡ä»¶ä¸­ä¸è¦é…ç½®
<code>no-auto-reauth</code>ï¼Œå‚è€ƒè¯¥ <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3VwZGF0ZWluZy9taW5pZWFwL2lzc3Vlcy80Mw==">minieap@issue#43<i class="fa fa-external-link-alt"></i></span></del></p>
<h2 id="é˜²ç«å¢™">é˜²ç«å¢™</h2>
<p>é˜²ç«å¢™è§„åˆ™çš„è¯¦ç»†é…ç½®å¯ä»¥å‚è€ƒ <span class="exturl" data-url="aHR0cHM6Ly9vcGVud3J0Lm9yZy9kb2NzL2d1aWRlLXVzZXIvZmlyZXdhbGwvZmlyZXdhbGxfY29uZmlndXJhdGlvbiNydWxlcw==">å®˜æ–¹çš„ä»‹ç»<i class="fa fa-external-link-alt"></i></span>
ä»¥åŠéƒ¨åˆ† <span class="exturl" data-url="aHR0cHM6Ly9vcGVud3J0Lm9yZy96aC1jbi9kb2MvdWNpL2ZpcmV3YWxsIyVFNCVCOCVCRSVFNCVCRSU4Qg==">ä¾‹å­<i class="fa fa-external-link-alt"></i></span></p>
<h3 id="å¼€æ”¾ç«¯å£">å¼€æ”¾ç«¯å£</h3>
<p>ä»¥å¼€æ”¾ 80 ç«¯å£ï¼Œç”¨äºå¤–ç½‘ç›´æ¥è®¿é—® Web ç•Œé¢ä¸ºä¾‹ï¼š</p>
<ol type="1">
<li><p>é¦–å…ˆè¦åœ¨ <span class="exturl" data-url="aHR0cDovLzE5Mi4xNjguMS4xL2NnaS1iaW4vbHVjaS9hZG1pbi9uZXR3b3JrL2ZpcmV3YWxsL3J1bGVz">ç½‘ç»œ - é˜²ç«å¢™ - é€šä¿¡è§„åˆ™<i class="fa fa-external-link-alt"></i></span>
ç‚¹å‡»æ–°å¢ï¼Œè¿›è¡Œå¦‚ä¸‹é…ç½®</p>
<figure>
<img data-src="/posts/51140c4a/Allow-LuCI-WAN.png" alt="å¼€æ”¾ 80 ç«¯å£">
<figcaption aria-hidden="true">å¼€æ”¾ 80 ç«¯å£</figcaption>
</figure>
<ul>
<li>åç§°ï¼šå¯ä»¥éšæ„è®¾ç½®</li>
<li>åè®®ï¼šæ ¹æ®éœ€è¦è¿›è¡Œé€‰æ‹©å³å¯</li>
<li>æºåŒºåŸŸï¼šé€‰æ‹© WAN è¡¨ç¤ºæ˜¯ä»å¤–ç½‘è¿›è¡Œè®¿é—®</li>
<li>æºåœ°å€ä»¥åŠæºç«¯å£ï¼šä¸»è¦ç”¨äºé™åˆ¶æ¥è®¿çš„è®¾å¤‡ï¼Œå¯ä»¥æ ¹æ®éœ€è¦è¿›è¡Œé…ç½®</li>
<li>ç›®æ ‡åŒºåŸŸï¼šé€‰æ‹© <code>è®¾å¤‡</code> ä»£è¡¨è¿™æ˜¯ä¸€ä¸ªå…¥ç«™çš„è§„åˆ™</li>
<li>ç›®æ ‡åœ°å€ï¼šå› ä¸ºæ˜¯è®¿é—®è®¾å¤‡ï¼Œæ­¤æ—¶ä¸éœ€è¦é…ç½®</li>
<li>ç›®æ ‡ç«¯å£ï¼šWeb çš„é»˜è®¤ç«¯å£æ˜¯ 80</li>
<li> æ“ä½œï¼šå¼€æ”¾ç«¯å£ï¼Œå½“ç„¶æ˜¯é€‰æ‹©æ¥å—</li>
</ul></li>
<li><p>ç„¶ååœ¨ <span class="exturl" data-url="aHR0cDovLzE5Mi4xNjguMS4xL2NnaS1iaW4vbHVjaS9hZG1pbi9zdGF0dXMvaXB0YWJsZXM=">çŠ¶æ€ - é˜²ç«å¢™<i class="fa fa-external-link-alt"></i></span>
æ ¹æ®éœ€è¦å¯¹ IPv4ã€IPv6 é˜²ç«å¢™è¿›è¡Œé‡å¯å³å¯</p></li>
</ol>
<p>å¦‚æœè¿™æ—¶å¤–ç½‘è¿˜æ˜¯ä¸èƒ½è®¿é—® LuCI çš„ Web
ç•Œé¢ï¼Œå¯ä»¥å°è¯•è·¯ç”±å™¨é‡å¯ï¼Œç¡®è®¤è·¯ç”±å™¨çš„ IP æ˜¯å¦èƒ½å¤Ÿ ping é€šï¼Œä»¥åŠç¡®è®¤ 80
ç«¯å£æœ‰æ²¡æœ‰è¢«è¿è¥å•†å°ç¦</p>
<h3 id="ç«¯å£è½¬å‘">ç«¯å£è½¬å‘</h3>
<p>ä»¥å°† Windows çš„è¿œç¨‹è¿æ¥çš„ç«¯å£ 3389 ä¸ºä¾‹ï¼š</p>
<ol type="1">
<li><p>é¦–å…ˆè¦åœ¨ <span class="exturl" data-url="aHR0cDovLzE5Mi4xNjguMS4xL2NnaS1iaW4vbHVjaS9hZG1pbi9uZXR3b3JrL2ZpcmV3YWxsL2ZvcndhcmRz">ç½‘ç»œ - é˜²ç«å¢™ - ç«¯å£è½¬å‘<i class="fa fa-external-link-alt"></i></span>
ç‚¹å‡»æ–°å¢ï¼Œè¿›è¡Œå¦‚ä¸‹é…ç½®</p>
<figure>
<img data-src="/posts/51140c4a/Win-Remote.png" alt="ç«¯å£è½¬å‘">
<figcaption aria-hidden="true">ç«¯å£è½¬å‘</figcaption>
</figure>
<ul>
<li>åç§°ï¼šå¯ä»¥éšæ„è®¾ç½®</li>
<li>åè®®ï¼šæ ¹æ®éœ€è¦è¿›è¡Œé€‰æ‹©å³å¯</li>
<li>æºåŒºåŸŸï¼šé€‰æ‹© WAN è¡¨ç¤ºæ˜¯ä»å¤–ç½‘è¿›è¡Œè®¿é—®</li>
<li>å¤–éƒ¨ç«¯å£ï¼šè¿™é‡Œé…ç½®æˆ 13389</li>
<li> ç›®æ ‡åŒºåŸŸï¼šé€‰æ‹© <code>LAN</code></li>
<li>å†…éƒ¨ IP åœ°å€ï¼šé…ç½®æˆå†…ç½‘éœ€è¦è¿œç¨‹è¿æ¥çš„ä¸»æœº</li>
<li>å†…éƒ¨ç«¯å£ï¼šè¿œç¨‹è¿æ¥çš„é»˜è®¤ç«¯å£æ˜¯ 3389</li>
</ul></li>
<li><p> ç„¶ååœ¨ <span class="exturl" data-url="aHR0cDovLzE5Mi4xNjguMS4xL2NnaS1iaW4vbHVjaS9hZG1pbi9zdGF0dXMvaXB0YWJsZXM=">çŠ¶æ€ - é˜²ç«å¢™<i class="fa fa-external-link-alt"></i></span>
æ ¹æ®éœ€è¦å¯¹ IPv4ã€IPv6 é˜²ç«å¢™è¿›è¡Œé‡å¯å³å¯</p></li>
</ol>
<p>åç»­å°±å¯ä»¥é€šè¿‡è®¿é—®è·¯ç”±å™¨ <code>WAN_IP:13389</code> æ¥è¿œç¨‹è¿æ¥å†…ç½‘çš„
Windows ä¸»æœºäº†</p>
<h2 id="ipv6">IPv6</h2>
<p>åœ¨æ ¡å›­ç½‘ç¯å¢ƒä¸‹å‘ç° WAN å£é»˜è®¤èƒ½è‡ªåŠ¨è·å–åˆ° IPv6 åœ°å€ï¼ˆä½†æ˜¯ /128
çš„åœ°å€ï¼‰ï¼Œå¹¶ä¸”åœ¨è·¯ç”±å™¨ä¸Šæµ‹è¯•ä¹Ÿèƒ½æ­£å¸¸è®¿é—® IPv6
ç½‘ç«™ï¼Œä½†æ˜¯å±€åŸŸç½‘å†…çš„è®¾å¤‡ä¸èƒ½æ­£å¸¸è®¿é—® IPv6 ç½‘ç«™ï¼Œäºæ˜¯é€‰æ‹© NAT6
çš„æ–¹å¼æ¥è§£å†³</p>
<p>å‚è€ƒ <span class="exturl" data-url="aHR0cHM6Ly9vcGVud3J0Lm9yZy9kb2NzL2d1aWRlLXVzZXIvbmV0d29yay9pcHY2L2lwdjYubmF0Ng==">å®˜ç½‘çš„
NAT6 æ–‡æ¡£<i class="fa fa-external-link-alt"></i></span>ï¼Œéœ€è¦åœ¨è·¯ç”±å™¨å†…ä¾æ¬¡è¿›è¡Œå¦‚ä¸‹é…ç½®ï¼š</p>
<p>æ³¨ï¼šåŸºäº OpenWrt 22.03.2 ç‰ˆæœ¬é…ç½®ï¼Œç‰ˆæœ¬ä¸åŒé…ç½®å¯èƒ½æœ‰æ‰€ä¸åŒï¼</p>
<ol type="1">
<li><p>å®‰è£… kmod-ipt-nat6 åŒ…</p>
<p></p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># Install packages</span></span><br><span class="line">opkg update</span><br><span class="line">opkg install kmod-ipt-nat6</span><br></pre></td></tr></tbody></table></figure><p></p></li>
<li><p>é…ç½® IPv6 ULA å‰ç¼€ï¼Œä½¿å¾—å†…ç½‘è®¾å¤‡é»˜è®¤ä½¿ç”¨ IPv6</p>
<p></p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># Using IPv6 by default</span></span><br><span class="line">NET_ULA=<span class="string">"<span class="subst">$(uci get network.globals.ula_prefix)</span>"</span></span><br><span class="line">uci <span class="built_in">set</span> network.globals.ula_prefix=<span class="string">"d<span class="variable">${NET_ULA:1}</span>"</span></span><br><span class="line"><span class="comment"># é»˜è®¤ network.lan.ip6assign é…ç½®å¯èƒ½æœ‰è¯¯ï¼Œéœ€è¦æ ¹æ® ula_prefix é‡æ–°é…ç½®</span></span><br><span class="line">IP6_ASSIGN=<span class="string">"<span class="subst">$(echo ${NET_ULA} | grep -E '(\d+)</span>$' -o)"</span></span><br><span class="line">uci <span class="built_in">set</span> network.lan.ip6assign=<span class="string">"<span class="variable">${IP6_ASSIGN}</span>"</span></span><br><span class="line">uci commit network</span><br><span class="line">/etc/init.d/network restart</span><br></pre></td></tr></tbody></table></figure><p></p></li>
<li><p>é…ç½® WAN6 ä»¥åŠ LAN ç«¯å£</p>
<p></p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">uci <span class="built_in">set</span> dhcp.wan6.ra=<span class="string">'relay'</span></span><br><span class="line">uci <span class="built_in">set</span> dhcp.wan6.dhcpv6=<span class="string">'relay'</span></span><br><span class="line">uci delete dhcp.wan6.ndp</span><br><span class="line">uci <span class="built_in">set</span> dhcp.wan6.master=<span class="string">'1'</span></span><br><span class="line"></span><br><span class="line">uci <span class="built_in">set</span> dhcp.lan.ra_default=<span class="string">'1'</span></span><br><span class="line">uci <span class="built_in">set</span> dhcp.lan.ra=<span class="string">'server'</span></span><br><span class="line">uci <span class="built_in">set</span> dhcp.lan.dhcpv6=<span class="string">'server'</span></span><br><span class="line">uci delete dhcp.lan.ndp</span><br><span class="line">uci <span class="built_in">set</span> dhcp.lan.ra_management=<span class="string">'1'</span></span><br><span class="line"></span><br><span class="line">uci commit dhcp</span><br><span class="line">/etc/init.d/odhcpd restart</span><br></pre></td></tr></tbody></table></figure><p></p></li>
<li><p>é…ç½®é˜²ç«å¢™</p>
<p></p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># Configure firewall</span></span><br><span class="line">uci <span class="built_in">set</span> firewall.@zone[1].masq6=<span class="string">"1"</span></span><br><span class="line">uci commit firewall</span><br><span class="line">/etc/init.d/firewall restart</span><br></pre></td></tr></tbody></table></figure><p></p></li>
<li><p>æ·»åŠ  ipv6 é»˜è®¤ç½‘å…³</p>
<p></p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc/hotplug.d/iface</span><br><span class="line"><span class="built_in">touch</span> 90-nat66</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"#!/bin/sh"</span> &gt;&gt; 90-nat66</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"[ \"\$ACTION\" = ifup ] || exit 0"</span> &gt;&gt; 90-nat66</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"route -A inet6 add default gw \`(ip -6 route | grep default | awk '{print \$5,\$6,\$7}')\`"</span> &gt;&gt; 90-nat66</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>ä¹Ÿå¯ä»¥ç›´æ¥ <code>vim /etc/hotplug.d/iface/90-nat66</code> å¡«å…¥ï¼š</p>
<p></p><figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line">[ "$ACTION" = ifup ] || exit 0</span><br><span class="line">route -A inet6 add default gw `(ip -6 route | grep default | awk '{print $5,$6,$7}')`</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>è¯¥æ­¥éª¤ä¸»è¦æ˜¯è®© OpenWRT æ¯æ¬¡é‡å¯åè‡ªåŠ¨æ·»åŠ  ipv6
é»˜è®¤ç½‘å…³ï¼Œå¦‚æœè¦ç«‹å³ç”Ÿæ•ˆå¯ä»¥æ‰‹åŠ¨æ‰§è¡Œ</p></li>
<li><p>é‡å¯è·¯ç”±å™¨</p></li>
</ol>
<h2 id="zerotier">ZeroTier</h2>
<p>ä¸ºäº†å¼‚åœ°å†…ç½‘äº’è®¿ï¼ŒZeroTier å¯ä»¥ç®—æ˜¯ä¸€ä¸ª â€œç¥å™¨â€ äº†ï¼Œè™½ç„¶ä¸å¦‚ frp
ç¨³å®šï¼Œä½†æ˜¯èƒœåœ¨å…è´¹ï¼Œæ— éœ€å…¬ç½‘ VPS</p>
<ol type="1">
<li><p>é¦–å…ˆå®‰è£… zerotier åŒ…</p>
<p></p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">opkg update</span><br><span class="line">opkg install zerotier</span><br></pre></td></tr></tbody></table></figure><p></p></li>
<li><p>ç›´æ¥ä¿®æ”¹é…ç½®æ–‡ä»¶</p>
<p></p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">vim /etc/config/zerotier</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>é»˜è®¤æ–‡ä»¶ç±»ä¼¼ä¸‹é¢è¿™æ ·</p>
<p></p><figure class="highlight txt"><table><tbody><tr><td class="code"><pre><span class="line">config zerotier sample_config</span><br><span class="line">    option enabled 0</span><br><span class="line"></span><br><span class="line">    # persistent configuration folder (for ZT controller mode)</span><br><span class="line">    #option config_path '/etc/zerotier'</span><br><span class="line"></span><br><span class="line">    #option port '9993'</span><br><span class="line"></span><br><span class="line">    # Generate secret on first start</span><br><span class="line">    option secret ''</span><br><span class="line"></span><br><span class="line">    # Join a public network called Earth</span><br><span class="line">    list join '8056c2e21c000001'</span><br><span class="line">    #list join '&lt;other_network&gt;'</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>ä¿®æ”¹å…¶ä¸­çš„ <code>enabled</code> ä¸º 1ï¼Œå¼€å¯æœåŠ¡ï¼Œå¹¶ä¸”
<code>list join</code> åçš„ç½‘ç»œ ID æ”¹ä¸ºè‡ªå·±ç”³è¯·çš„ç½‘ç»œ ID å³å¯</p>
<p>ä¹Ÿå¯ä»¥æ–°å»ºä¸€ä¸ªé…ç½®ï¼Œå¡«ä¸Šè‡ªå·±çš„ç½‘ç»œ IDï¼Œå¦‚ä¸‹</p>
<p></p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">uci <span class="built_in">set</span> zerotier.openwrt_network=zerotier</span><br><span class="line">uci add_list zerotier.openwrt_network.join=<span class="string">'xxxxxxxxxxxxxxxx'</span></span><br><span class="line">uci <span class="built_in">set</span> zerotier.openwrt_network.enabled=<span class="string">'1'</span></span><br><span class="line">uci commit zerotier</span><br></pre></td></tr></tbody></table></figure><p></p></li>
<li><p>é‡å¯è·¯ç”±å™¨</p>
<p></p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">reboot</span><br></pre></td></tr></tbody></table></figure><p></p></li>
<li><p>é…ç½®é˜²ç«å¢™</p>
<p>å¼€å¯å¤–ç½‘ udp åˆ° 9993 ç«¯å£çš„è®¿é—®æƒé™</p>
<p></p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">uci add firewall rule</span><br><span class="line">uci <span class="built_in">set</span> firewall.@rule[-1].name=<span class="string">'Allow-ZeroTier-Inbound'</span></span><br><span class="line">uci <span class="built_in">set</span> firewall.@rule[-1].src=<span class="string">'*'</span></span><br><span class="line">uci <span class="built_in">set</span> firewall.@rule[-1].target=<span class="string">'ACCEPT'</span></span><br><span class="line">uci <span class="built_in">set</span> firewall.@rule[-1].proto=<span class="string">'udp'</span></span><br><span class="line">uci <span class="built_in">set</span> firewall.@rule[-1].dest_port=<span class="string">'9993'</span></span><br><span class="line">uci commit firewall</span><br><span class="line">/etc/init.d/firewall restart</span><br></pre></td></tr></tbody></table></figure><p></p></li>
<li><p>é…ç½® ZeroTier çš„è·¯ç”±</p>
<p>åœ¨ <span class="exturl" data-url="aHR0cDovLzE5Mi4xNjguMS4xL2NnaS1iaW4vbHVjaS9hZG1pbi9uZXR3b3JrL25ldHdvcms=">ç½‘ç»œ - æ¥å£<i class="fa fa-external-link-alt"></i></span>
ç•Œé¢æ–°å»ºä¸€ä¸ªæ¥å£ï¼ŒztXXXXXXXX æ ¹æ®å®é™…æƒ…å†µæ›¿æ¢ï¼Œåç»­ç±»ä¼¼ä¸å†é‡å¤</p>
<p></p><figure class="highlight txt"><table><tbody><tr><td class="code"><pre><span class="line">åç§°ï¼šZeroTier</span><br><span class="line">åè®®ï¼šä¸é…ç½®åè®®</span><br><span class="line">è®¾å¤‡ï¼šztXXXXXXXX</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>å‘½ä»¤è¡Œä¹Ÿå¯ä»¥</p>
<p></p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">uci <span class="built_in">set</span> network.ZeroTier=interface</span><br><span class="line">uci <span class="built_in">set</span> network.ZeroTier.proto=<span class="string">'none'</span></span><br><span class="line">uci <span class="built_in">set</span> network.ZeroTier.device=<span class="string">'ztXXXXXXXX'</span></span><br><span class="line">uci commit network</span><br><span class="line">/etc/init.d/network restart</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>ç„¶ååœ¨ <span class="exturl" data-url="aHR0cDovLzE5Mi4xNjguMS4xL2NnaS1iaW4vbHVjaS9hZG1pbi9uZXR3b3JrL2ZpcmV3YWxs">ç½‘ç»œ - é˜²ç«å¢™<i class="fa fa-external-link-alt"></i></span>
ç•Œé¢æ–°å»ºä¸€ä¸ªé˜²ç«å¢™åŒºåŸŸ</p>
<p></p><figure class="highlight txt"><table><tbody><tr><td class="code"><pre><span class="line">åç§°: zerotier</span><br><span class="line">å…¥ç«™æ•°æ®ï¼šæ¥å—</span><br><span class="line">å‡ºç«™æ•°æ®ï¼šæ¥å—</span><br><span class="line">è½¬å‘ï¼šæ‹’ç»</span><br><span class="line">IP åŠ¨æ€ä¼ªè£…: [âˆš]</span><br><span class="line">MSS é’³åˆ¶: [ ]</span><br><span class="line">æ¶µç›–çš„ç½‘ç»œ: [âˆš] ZeroTier</span><br><span class="line">å…è®¸è½¬å‘åˆ°ç›®æ ‡åŒºåŸŸï¼š[âˆš] lan</span><br><span class="line">                [âˆš] wan wan6</span><br><span class="line">å…è®¸æ¥è‡ªæºåŒºåŸŸçš„è½¬å‘ï¼š[âˆš] lan</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>å‘½ä»¤è¡Œä¹Ÿå¯ä»¥ï¼Œä»…ä¾›å‚è€ƒ</p>
<p></p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">uci add firewall zone</span><br><span class="line">uci <span class="built_in">set</span> firewall.@zone[-1].name=<span class="string">'zerotier'</span></span><br><span class="line">uci <span class="built_in">set</span> firewall.@zone[-1].input=<span class="string">'ACCEPT'</span></span><br><span class="line">uci <span class="built_in">set</span> firewall.@zone[-1].output=<span class="string">'ACCEPT'</span></span><br><span class="line">uci <span class="built_in">set</span> firewall.@zone[-1].forward=<span class="string">'ACCEPT'</span></span><br><span class="line">uci <span class="built_in">set</span> firewall.@zone[-1].masq=<span class="string">'1'</span></span><br><span class="line">uci add_list firewall.@zone[-1].network=<span class="string">'ZeroTier'</span></span><br><span class="line">uci add firewall forwarding</span><br><span class="line">uci <span class="built_in">set</span> firewall.@forwarding[-1].src=<span class="string">'zerotier'</span></span><br><span class="line">uci <span class="built_in">set</span> firewall.@forwarding[-1].dest=<span class="string">'lan'</span></span><br><span class="line">uci add firewall forwarding</span><br><span class="line">uci <span class="built_in">set</span> firewall.@forwarding[-1].src=<span class="string">'zerotier'</span></span><br><span class="line">uci <span class="built_in">set</span> firewall.@forwarding[-1].dest=<span class="string">'wan'</span></span><br><span class="line">uci add firewall forwarding</span><br><span class="line">uci <span class="built_in">set</span> firewall.@forwarding[-1].src=<span class="string">'lan'</span></span><br><span class="line">uci <span class="built_in">set</span> firewall.@forwarding[-1].dest=<span class="string">'zerotier'</span></span><br><span class="line">uci commit firewall</span><br><span class="line">/etc/init.d/firewall restart</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>è‡³æ­¤è·¯ç”±å™¨æœ¬èº«çš„é…ç½®å°±å®Œäº†ï¼Œç„¶åéœ€è¦å» <span class="exturl" data-url="aHR0cHM6Ly9teS56ZXJvdGllci5jb20vbmV0d29yaw==">zerotier å®˜ç½‘<i class="fa fa-external-link-alt"></i></span>
é…ç½®ä¸€ä¸‹è·¯ç”±</p>
<figure>
<img data-src="/posts/51140c4a/ZeroTier-Routes.png" alt="ZeroTier è·¯ç”±ç®¡ç†">
<figcaption aria-hidden="true">ZeroTier è·¯ç”±ç®¡ç†</figcaption>
</figure>
<p>ä¾‹å¦‚æˆ‘çš„å±€åŸŸç½‘æ®µé€‰çš„
<code>192.168.192.*</code>ï¼Œä¸¤ä¸ªè·¯ç”±å™¨å®é™…çš„å†…ç½‘çš„ LAN å£é…ç½®ä¾æ¬¡ä¸º
<code>192.168.22.0/24</code> å’Œ <code>192.168.33.0/24</code>
å¯¹åº”å·¦è¾¹çš„çº¢æ¡†ï¼Œè·¯ç”±å™¨è‡ªèº«çš„ ZeroTier çš„è™šæ‹Ÿ IP ä¸º
<code>192.168.192.22</code> å’Œ <code>192.168.192.33</code>
åˆ™å¯¹åº”ç€å³è¾¹çº¢æ¡†ï¼Œè¿™é‡Œä¸è¯¦ç»†å±•å¼€ï¼Œå¯ä»¥å‚è€ƒ <span class="exturl" data-url="aHR0cHM6Ly9zdHJheS5sb3ZlL2ppYW8tY2hlbmcvemVyb3RpZXItemhvbmctamllLWppYW8tY2hlbmc=">è¿™ç¯‡åšæ–‡<i class="fa fa-external-link-alt"></i></span></p></li>
</ol>
<h2 id="ftp">FTP</h2>
<p>é…ç½®å¥½ USB åï¼Œå°±å¯ä»¥é…ç½® FTP æ¥å…±äº« USB è®¾å¤‡</p>
<ol type="1">
<li><p>é¦–å…ˆå®‰è£… vsftpd åŒ…</p>
<p></p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">opkg install vsftpd</span><br></pre></td></tr></tbody></table></figure><p></p></li>
<li><p>ä¿®æ”¹é…ç½®æ–‡ä»¶
<code>/etc/vsftpd.conf</code>ï¼Œè¿™é‡Œç»™å‡ºä¸ªäººçš„é…ç½®ï¼Œå¯ä»¥å‚è€ƒ</p>
<p></p><figure class="highlight ini"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">background</span>=<span class="literal">YES</span></span><br><span class="line"><span class="attr">listen</span>=<span class="literal">YES</span></span><br><span class="line"><span class="attr">anonymous_enable</span>=<span class="literal">NO</span></span><br><span class="line"><span class="attr">local_enable</span>=<span class="literal">YES</span></span><br><span class="line"><span class="attr">write_enable</span>=<span class="literal">YES</span></span><br><span class="line"><span class="attr">local_umask</span>=<span class="number">022</span></span><br><span class="line"><span class="attr">check_shell</span>=<span class="literal">NO</span></span><br><span class="line"><span class="comment">#dirmessage_enable=YES</span></span><br><span class="line"><span class="comment">#ftpd_banner=Welcome to MINI FTP service.</span></span><br><span class="line"><span class="attr">session_support</span>=<span class="literal">NO</span></span><br><span class="line"><span class="comment">#syslog_enable=YES</span></span><br><span class="line"><span class="comment">#userlist_enable=YES</span></span><br><span class="line"><span class="comment">#userlist_deny=NO</span></span><br><span class="line"><span class="comment">#userlist_file=/etc/vsftpd/vsftpd.users</span></span><br><span class="line"><span class="comment">#xferlog_enable=YES</span></span><br><span class="line"><span class="comment">#xferlog_file=/var/log/vsftpd.log</span></span><br><span class="line"><span class="comment">#xferlog_std_format=YES</span></span><br><span class="line"><span class="comment">###</span></span><br><span class="line"><span class="comment">### TLS/SSL options</span></span><br><span class="line"><span class="comment">### example key generation: openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout /etc/vsftpd/vsftpd_privkey.pem -out /etc</span></span><br><span class="line"><span class="comment">#ssl_enable=YES</span></span><br><span class="line"><span class="comment">#allow_anon_ssl=NO</span></span><br><span class="line"><span class="comment">#force_local_data_ssl=NO</span></span><br><span class="line"><span class="comment">#force_local_logins_ssl=NO</span></span><br><span class="line"><span class="comment">#ssl_tlsv1=YES</span></span><br><span class="line"><span class="comment">#ssl_sslv2=NO</span></span><br><span class="line"><span class="comment">#ssl_sslv3=NO</span></span><br><span class="line"><span class="comment">#rsa_cert_file=/etc/vsftpd/vsftpd_cert.pem</span></span><br><span class="line"><span class="comment">#rsa_private_key_file=/etc/vsftpd/vsftpd_privkey.pem</span></span><br><span class="line"><span class="comment"># å…±äº«çš„ç›®å½•ä½ç½®</span></span><br><span class="line"><span class="attr">local_root</span>=/mnt/ext4</span><br><span class="line"><span class="attr">pasv_enable</span>=<span class="literal">YES</span></span><br><span class="line"><span class="attr">pasv_min_port</span>=<span class="number">10090</span></span><br><span class="line"><span class="attr">pasv_max_port</span>=<span class="number">10100</span></span><br></pre></td></tr></tbody></table></figure><p></p></li>
<li><p>ç„¶åå‚è€ƒä¹‹å‰çš„ <a href="#å¼€æ”¾ç«¯å£">å¼€æ”¾ç«¯å£</a>ï¼Œæ‰“å¼€
20ã€21ã€10090-10100 ç«¯å£å°±å¯ä»¥åœ¨å¤–ç½‘è®¿é—® FTP æœåŠ¡å™¨äº†</p>
<figure>
<img data-src="/posts/51140c4a/Allow-FTP-WAN.png" alt="å¼€æ”¾ FTP ç«¯å£">
<figcaption aria-hidden="true">å¼€æ”¾ FTP ç«¯å£</figcaption>
</figure></li>
<li><p>ä¹‹åé‡å¯ <code>vsftpd</code> æœåŠ¡å³å¯ä½¿ç”¨</p>
<p></p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">/etc/init.d/vsftpd restart</span><br></pre></td></tr></tbody></table></figure><p></p></li>
</ol>
<p>P.S. è¿æ¥ ftp æœåŠ¡å™¨çš„è´¦å·å¯†ç å°±æ˜¯è·¯ç”±å™¨çš„ root è´¦å·å¯†ç </p>
<h2 id="smb">SMB</h2>
<p>ä½¿ç”¨ Samba æ¥å…±äº«çš„è®¾å¤‡å¯ä»¥åœ¨ Windows
çš„æ–‡ä»¶èµ„æºç®¡ç†å™¨ä¸­æŒ‚è½½ï¼Œä½¿ç”¨èµ·æ¥å’Œæœ¬åœ°ç£ç›˜ä¸€æ ·ï¼ˆåœ¨å±€åŸŸç½‘å†…ï¼‰</p>
<ol type="1">
<li><p>å®‰è£… samba4-server ä»¥åŠ LuCI ç®¡ç†ç•Œé¢</p>
<p></p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">opkg install samba4-server</span><br><span class="line">opkg install luci-app-samba4 luci-i18n-samba4-zh-cn</span><br></pre></td></tr></tbody></table></figure><p></p></li>
<li><p>åœ¨ç½‘é¡µç«¯çš„ <span class="exturl" data-url="aHR0cDovLzE5Mi4xNjguMS4xL2NnaS1iaW4vbHVjaS9hZG1pbi9zZXJ2aWNlcy9zYW1iYTQ=">æœåŠ¡ - ç½‘ç»œå…±äº«<i class="fa fa-external-link-alt"></i></span>
ä¸­è¿›è¡Œé…ç½®ï¼Œä¸ªäººé…ç½®å¦‚ä¸‹ï¼Œå¯ä»¥å‚è€ƒ</p>
<figure>
<img data-src="/posts/51140c4a/Samba.png" alt="Samba é…ç½®">
<figcaption aria-hidden="true">Samba é…ç½®</figcaption>
</figure></li>
<li><p>ä¹‹åé‡å¯ <code>samba4</code> æœåŠ¡å³å¯ä½¿ç”¨</p>
<p></p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">/etc/init.d/samba4 restart</span><br></pre></td></tr></tbody></table></figure><p></p></li>
</ol>
<p>P.S. è¿æ¥ Samba æœåŠ¡å™¨çš„è´¦å·å¯†ç ä¹Ÿæ˜¯è·¯ç”±å™¨çš„ root è´¦å·å¯†ç </p>
<h2 id="bt-ä¸‹è½½">BT ä¸‹è½½</h2>
<p>transmission æ˜¯ä¸€ä¸ªè½»é‡çº§è·¨å¹³å°çš„ BT ä¸‹è½½å®¢æˆ·ç«¯</p>
<ol type="1">
<li><p>å®‰è£… transmission</p>
<p></p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">opkg install transmission-daemon</span><br><span class="line">opkg install transmission-cli</span><br><span class="line">opkg install transmission-web   <span class="comment"># web ç•Œé¢ï¼Œå¯é€‰</span></span><br><span class="line">opkg install transmission-remote</span><br><span class="line">opkg install luci-app-transmission luci-i18n-transmission-zh-cn</span><br></pre></td></tr></tbody></table></figure><p></p></li>
<li><p>ç›´æ¥ä¿®æ”¹ <code>/etc/config/transmission</code>ï¼Œæˆ–è€…åœ¨ç½‘é¡µç«¯çš„ <span class="exturl" data-url="aHR0cDovLzE5Mi4xNjguMS4xL2NnaS1iaW4vbHVjaS9hZG1pbi9zZXJ2aWNlcy90cmFuc21pc3Npb24=">æœåŠ¡ - Transmission<i class="fa fa-external-link-alt"></i></span>
è¿›è¡Œé…ç½®ï¼Œä¸‹é¢ç»™å‡ºä¸ªäººé…ç½®ï¼Œå¯ä»¥å‚è€ƒ</p>
<figure>
<img data-src="/posts/51140c4a/Transmission.png" alt="Transmission é…ç½®">
<figcaption aria-hidden="true">Transmission é…ç½® </figcaption>
</figure>
<p></p><figure class="highlight ini"><table><tbody><tr><td class="code"><pre><span class="line">config transmission</span><br><span class="line">    option config_overwrite '1'</span><br><span class="line">    option mem_percentage '50'</span><br><span class="line">    option nice '10'</span><br><span class="line">    option alt_speed_enabled 'false'</span><br><span class="line">    option alt_speed_time_enabled 'false'</span><br><span class="line">    option bind_address_ipv4 '0.0.0.0'</span><br><span class="line">    option bind_address_ipv6 '::'</span><br><span class="line">    option blocklist_enabled 'false'</span><br><span class="line">    option cache_size_mb '2'</span><br><span class="line">    option dht_enabled 'true'</span><br><span class="line">    option download_queue_enabled 'true'</span><br><span class="line">    option download_queue_size '4'</span><br><span class="line">    option encryption '1'</span><br><span class="line">    option idle_seeding_limit_enabled 'false'</span><br><span class="line">    option lazy_bitfield_enabled 'true'</span><br><span class="line">    option lpd_enabled 'false'</span><br><span class="line">    option message_level '1'</span><br><span class="line">    option peer_limit_global '240'</span><br><span class="line">    option peer_limit_per_torrent '60'</span><br><span class="line">    option peer_port '51413'</span><br><span class="line">    option peer_port_random_on_start 'false'</span><br><span class="line">    option peer_socket_tos 'default'</span><br><span class="line">    option pex_enabled 'true'</span><br><span class="line">    option port_forwarding_enabled 'true'</span><br><span class="line">    option preallocation '1'</span><br><span class="line">    option queue_stalled_enabled 'true'</span><br><span class="line">    option queue_stalled_minutes '30'</span><br><span class="line">    option ratio_limit '2.0000'</span><br><span class="line">    option rename_partial_files 'true'</span><br><span class="line">    option rpc_bind_address '0.0.0.0'</span><br><span class="line">    option rpc_enabled 'true'</span><br><span class="line">    option rpc_host_whitelist_enabled 'false'</span><br><span class="line">    option rpc_port '9091'</span><br><span class="line">    option rpc_url '/transmission/'</span><br><span class="line">    option rpc_whitelist_enabled 'false'</span><br><span class="line">    option scrape_paused_torrents_enabled 'true'</span><br><span class="line">    option script_torrent_done_enabled 'false'</span><br><span class="line">    option seed_queue_enabled 'false'</span><br><span class="line">    option speed_limit_down_enabled 'false'</span><br><span class="line">    option speed_limit_up_enabled 'false'</span><br><span class="line">    option start_added_torrents 'true'</span><br><span class="line">    option umask '18'</span><br><span class="line">    option utp_enabled 'true'</span><br><span class="line">    option scrape_paused_torrents 'true'</span><br><span class="line">    option watch_dir_enabled 'false'</span><br><span class="line">    option enabled '1'</span><br><span class="line">    option user 'root'</span><br><span class="line">    option group 'root'</span><br><span class="line">    option upload_slots_per_torrent '10'</span><br><span class="line">    option download_dir '/mnt/ext4/transmission'</span><br><span class="line">    option incomplete_dir_enabled 'true'</span><br><span class="line">    option incomplete_dir '/mnt/ext4/transmission/incomplete'</span><br><span class="line">    option trash_original_torrent_files 'true'</span><br><span class="line">    option rpc_authentication_required 'true'</span><br><span class="line">    option rpc_username 'rpc_username'</span><br><span class="line">    option rpc_password 'rpc_password'</span><br><span class="line">    option ratio_limit_enabled 'true'</span><br><span class="line">    option config_dir '/etc/transmission'</span><br></pre></td></tr></tbody></table></figure><p></p></li>
<li><p>ä¹‹åé‡å¯ <code>transmission</code> æœåŠ¡å³å¯ä½¿ç”¨</p>
<p></p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">/etc/init.d/transmission restart</span><br></pre></td></tr></tbody></table></figure><p></p></li>
</ol>
<p>è¿æ¥çš„è´¦å·å¯†ç ä¸ºè‡ªè¡Œé…ç½®çš„ <code>RPC</code> è¿æ¥çš„è´¦å·å¯†ç </p>
<p>é»˜è®¤çš„ <span class="exturl" data-url="aHR0cDovLzE5Mi4xNjguMS4xOjkwOTEvdHJhbnNtaXNzaW9uL3dlYi8=">Web
ç•Œé¢<i class="fa fa-external-link-alt"></i></span> æ¯”è¾ƒç®€é™‹ï¼Œå¹¶ä¸”ä¸èƒ½é…ç½® trackerï¼Œä¸ªäººæ¨èä½¿ç”¨ <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3RyYW5zbWlzc2lvbi1yZW1vdGUtZ3VpL3RyYW5zZ3Vp">transgui<i class="fa fa-external-link-alt"></i></span>
æ¥ <code>RPC</code> è¿æ¥ä½¿ç”¨</p>
<p>å¦‚æœéœ€è¦è¿œç¨‹è®¿é—®ï¼Œåˆ™éœ€è¦å°† <code>rpc_port</code>
é…ç½®çš„ç«¯å£å¼€æ”¾ï¼Œå…·ä½“æµç¨‹å‚è€ƒ <a href="#å¼€æ”¾ç«¯å£">ä¸Šæ–‡</a></p>
<h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h2>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9vcGVud3J0Lm9yZy9kb2NzL2d1aWRlLXVzZXIvbHVjaS9sdWNpLmVzc2VudGlhbHM=">ã€OpenWrtã€‘LuCI<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MzI3NDA5Ny9hcnRpY2xlL2RldGFpbHMvMTA3MTk3NzE3">ã€CSDNã€‘luci.cbi
æŠ¥é”™<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2t1b3J1YW4vbHVjaS1hcHAtdjJyYXkvaXNzdWVzLzQy">ã€GitHubã€‘åº”ç”¨è®¾ç½®ç•Œé¢é”™è¯¯<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9vcGVud3J0Lm9yZy9kb2NzL2d1aWRlLXVzZXIvc3RvcmFnZS91c2ItaW5zdGFsbGluZw==">ã€OpenWrtã€‘å®‰è£…
USB é©±åŠ¨<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9vcGVud3J0Lm9yZy9kb2NzL2d1aWRlLXVzZXIvc3RvcmFnZS91c2ItZHJpdmVz">ã€OpenWrtã€‘ä½¿ç”¨
USB è®¾å¤‡<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9vcGVud3J0Lm9yZy9kb2NzL2d1aWRlLXVzZXIvYWRkaXRpb25hbC1zb2Z0d2FyZS9leHRyb290X2NvbmZpZ3VyYXRpb24=">ã€OpenWrtã€‘Extroot
é…ç½®<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2h5cmF0aGIvbWVudG9odXN0">ã€GitHubã€‘MentoHUST
åŠ å…¥ v4 æ”¯æŒ<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0t5bGVSaWNhcmRvL01lbnRvSFVTVC1PcGVuV3J0LWlwaw==">ã€GitHubã€‘MentoHUST-OpenWrt-ipk<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0JvcmluZ0NhdC9sdWNpLWFwcC1tZW50b2h1c3Q=">ã€GitHubã€‘OpenWrt/LEDE
LuCI for MentoHUST<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3VwZGF0ZWluZy9taW5pZWFw">ã€GitHubã€‘MiniEAP<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0JvcmluZ0NhdC9taW5pZWFwLW9wZW53cnQ=">ã€GitHubã€‘minieap-openwrt<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0JvcmluZ0NhdC9sdWNpLWFwcC1taW5pZWFw">ã€GitHubã€‘OpenWrt/LEDE
LuCI for minieap<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3VwZGF0ZWluZy9taW5pZWFwL2lzc3Vlcy80Mw==">ã€GitHubã€‘no-auto-reauth
é…ç½®é¡¹çš„é€»è¾‘åˆ¤æ–­æœ‰é—®é¢˜<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9vcGVud3J0Lm9yZy9kb2NzL2d1aWRlLXVzZXIvZmlyZXdhbGwvZmlyZXdhbGxfY29uZmlndXJhdGlvbiNydWxlcw==">ã€OpenWrtã€‘firewall
rules<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9vcGVud3J0Lm9yZy96aC1jbi9kb2MvdWNpL2ZpcmV3YWxsIyVFNCVCOCVCRSVFNCVCRSU4Qg==">ã€OpenWrtã€‘é˜²ç«å¢™é…ç½®ä¸¾ä¾‹<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9vcGVud3J0Lm9yZy9kb2NzL2d1aWRlLXVzZXIvbmV0d29yay9pcHY2L2lwdjYubmF0Ng==">ã€OpenWrtã€‘IPv6
NAT6 é…ç½®<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9vcGVud3J0Lm9yZy9kb2NzL2d1aWRlLXVzZXIvbmV0d29yay9pcHY2L2lwdjZfZXh0cmFzI3VzaW5nX2lwdjZfYnlfZGVmYXVsdA==">ã€OpenWrtã€‘é»˜è®¤ä½¿ç”¨
IPv6<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9vcGVud3J0Lm9yZy9kb2NzL2d1aWRlLXVzZXIvbmV0d29yay9pcHY2L2lwdjZfZXh0cmFzI2Fubm91bmNpbmdfZGVmYXVsdF9pcHY2X3JvdXRl">ã€OpenWrtã€‘é»˜è®¤
IPv6 è·¯ç”±<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly93d3cuYmlsaWJpbGkuY29tL3ZpZGVvL0JWMU55NHkxeDdQYQ==">ã€Bilibiliã€‘ã€è€æ¹¿åŸºã€‘IPv6
ç«Ÿç„¶ä¹Ÿå¯ä»¥å¼€ NATï½œOpenWRT IPv6 NAT æ‰‹æŠŠæ‰‹æ•™å­¦<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8zNDY2MDY4NTY=">ã€Zhihuã€‘å¦‚ä½•å¼€å¯
NAT6<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL213YXJuaW5nL3plcm90aWVyLW9wZW53cnQvd2lraQ==">ã€GitHubã€‘ZeroTier
setup on OpenWRT<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9zdHJheS5sb3ZlL2ppYW8tY2hlbmcvemVyb3RpZXItemhvbmctamllLWppYW8tY2hlbmc=">ã€ä¸ªäººåšå®¢ã€‘ZeroTier
ä¸­é˜¶æ•™ç¨‹<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9vcGVud3J0Lm9yZy9kb2NzL2d1aWRlLXVzZXIvc2VydmljZXMvbmFzL2Z0cC5vdmVydmlldw==">ã€OpenWrtã€‘FTP<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9vcGVud3J0Lm9yZy9kb2NzL2d1aWRlLXVzZXIvc2VydmljZXMvbmFzL3NhbWJh">ã€OpenWrtã€‘Samba<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9vcGVud3J0Lm9yZy9kb2NzL2d1aWRlLXVzZXIvc2VydmljZXMvZG93bmxvYWRpbmdfYW5kX2ZpbGVzaGFyaW5nL3RyYW5zbWlzc2lvbg==">ã€OpenWrtã€‘transmission<i class="fa fa-external-link-alt"></i></span></li>
</ul>
]]></content>
      <categories>
        <category>è·¯ç”±å™¨</category>
      </categories>
      <tags>
        <tag>OpenWrt</tag>
        <tag>é”æ·</tag>
        <tag>IPv6</tag>
        <tag>NAS</tag>
      </tags>
  </entry>
</search>
