<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Hexo æ’ä»¶æ¨èä»¥åŠä½¿ç”¨å°æŠ€å·§</title>
    <url>/posts/4143201a.html</url>
    <content><![CDATA[<p><a href="https://hexo.io/zh-cn/">Hexo</a> æ˜¯ä¸€ä¸ªå¿«é€Ÿã€ç®€æ´ä¸”é«˜æ•ˆçš„åšå®¢æ¡†æ¶ï¼Œä¸ªäººåªéœ€ç”¨ Markdown æ¥å†™æ–‡æ¡£ï¼Œå¹¶ä¸”æ‹¥æœ‰ä¸°å¯Œçš„æ’ä»¶å’Œä¸»é¢˜ã€‚å½“å‰åšå®¢å°±æ˜¯ä½¿ç”¨ Hexo é…åˆ NexT ä¸»é¢˜æ­å»ºçš„</p>
<span id="more"></span>
<p>å› ä¸ºç¬”è€…ä¸ªäººåœ¨ Windows ç¯å¢ƒä¸‹å†™åšå®¢ï¼Œåç»­å‘½ä»¤å‡ä»¥ <a href="https://docs.microsoft.com/zh-cn/powershell/scripting/install/installing-powershell?view=powershell-7.2">PowerShell</a> ä¸ºä¾‹</p>
<h2 id="æ’ä»¶æ¨è"><a href="#æ’ä»¶æ¨è" class="headerlink" title="æ’ä»¶æ¨è"></a>æ’ä»¶æ¨è</h2><h3 id="hexo-deployer-git"><a href="#hexo-deployer-git" class="headerlink" title="hexo-deployer-git"></a><a href="https://github.com/hexojs/hexo-deployer-git">hexo-deployer-git</a></h3><p>Hexo æ”¯æŒä¸€é”®éƒ¨ç½²ç½‘ç«™åˆ° git ä»“åº“ä¸Šï¼Œå…¶ä»–çš„ä¸€é”®éƒ¨ç½²æ–¹å¼å‚è€ƒ <a href="https://hexo.io/zh-cn/docs/one-command-deployment">å®˜ç½‘ä»‹ç»</a></p>
<ul>
<li>å®‰è£…</li>
</ul>
<figure class="highlight ps"><table><tr><td class="code"><pre><span class="line">npm install hexo<span class="literal">-deployer</span><span class="literal">-git</span> -<span class="literal">-save</span></span><br></pre></td></tr></table></figure>

<ul>
<li>é…ç½®</li>
</ul>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">deploy:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">git</span></span><br><span class="line">  <span class="attr">repo:</span> <span class="string">&lt;ä»“åº“é“¾æ¥&gt;</span> <span class="comment"># å¯ä»¥æ˜¯ https é“¾æ¥ä¹Ÿå¯ä»¥æ˜¯ git é“¾æ¥</span></span><br><span class="line">  <span class="attr">branch:</span> [<span class="string">åˆ†æ”¯</span>] <span class="comment"># GitHub çš„ç½‘ç«™åˆ†æ”¯ä¸º gh-pagesï¼Œå…¶ä»–ç½‘ç«™å¯èƒ½æœ‰æ‰€ä¸åŒ</span></span><br><span class="line">  <span class="attr">message:</span> [<span class="string">message</span>] <span class="comment"># é»˜è®¤æ˜¯ Site updated: &#123;&#123; now(&#x27;YYYY-MM-DD HH:mm:ss&#x27;) &#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>é»˜è®¤çš„æäº¤ä¿¡æ¯åªæœ‰æ—¶é—´ä¿¡æ¯ï¼Œæ²¡æœ‰è¿‡å¤šçš„å‚è€ƒä»·å€¼æ¨èä½¿ç”¨è‡ªå®šä¹‰æäº¤ä¿¡æ¯ï¼Œå…·ä½“å‚è€ƒ <a href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8F%90%E4%BA%A4%E4%BF%A1%E6%81%AF">åç»­å°èŠ‚</a></p>
<h3 id="hexo-word-counter"><a href="#hexo-word-counter" class="headerlink" title="hexo-word-counter"></a><a href="https://github.com/next-theme/hexo-word-counter">hexo-word-counter</a></h3><p>æ˜¾ç¤ºæ¯ç¯‡æ–‡ç« çš„å­—æ•°ç»Ÿè®¡ä»¥åŠå¤§è‡´é˜…è¯»æ—¶é•¿ï¼Œéœ€è¦ä¸»é¢˜æ”¯æŒ</p>
<ul>
<li>å®‰è£…</li>
</ul>
<figure class="highlight ps"><table><tr><td class="code"><pre><span class="line">npm install hexo<span class="literal">-word</span><span class="literal">-counter</span> -<span class="literal">-save</span></span><br></pre></td></tr></table></figure>

<ul>
<li>é…ç½®</li>
</ul>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># hexo-word-counter</span></span><br><span class="line"><span class="comment">## https://github.com/next-theme/hexo-word-counter</span></span><br><span class="line"><span class="attr">symbols_count_time:</span></span><br><span class="line">  <span class="attr">symbols:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">time:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">total_symbols:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">total_time:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">exclude_codeblock:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">awl:</span> <span class="number">4</span></span><br><span class="line">  <span class="attr">wpm:</span> <span class="number">275</span></span><br><span class="line">  <span class="attr">suffix:</span> <span class="string">&quot;mins.&quot;</span></span><br></pre></td></tr></table></figure>

<p>å…·ä½“é…ç½®å¯ä»¥å‚è€ƒå®˜æ–¹ç»™å‡ºçš„è¯´æ˜ï¼š</p>
<blockquote>
<p>Note for Chinese users: because in Chinese language average word length about ~1.5 and if you at most cases write posts in Chinese (without mixed English), recommended to set awl to 2 and wpm to 300.<br>But if you usualy mix your posts with English, awl to 4 and wpm to 275 will be nice.</p>
</blockquote>
<p>ä¹Ÿå°±æ˜¯è¯´çº¯ä¸­æ–‡æ—¶æ¨è <code>awl</code> è®¾ä¸º 2ï¼Œ<code>wpm</code> è®¾ä¸º 300ï¼›è€Œä¸­è‹±æ–‡æ··åˆæ—¶æ¨è <code>awl</code> è®¾ä¸º 4ï¼Œ<code>wpm</code> è®¾ä¸º 275</p>
<h3 id="hexo-abbrlink"><a href="#hexo-abbrlink" class="headerlink" title="hexo-abbrlink"></a><a href="https://github.com/rozbo/hexo-abbrlink">hexo-abbrlink</a></h3><p>Hexo é»˜è®¤çš„æ–‡ç« é“¾æ¥æ˜¯ä»¥æ—¶é—´ä»¥åŠæ–‡ä»¶åå‘½åçš„ï¼Œå¦‚æœæ–‡ä»¶åä¸ºä¸­æ–‡æ—¶è½¬è¯‘ä¹‹åä¼šå¾ˆé•¿ï¼Œå¹¶ä¸”ä¸ç¾è§‚ã€‚è€Œè¯¥æ’ä»¶å¯ä»¥åˆ©ç”¨ hash å€¼æ›¿æ¢åŸæœ‰çš„æ–‡ç« é“¾æ¥</p>
<ul>
<li>å®‰è£…</li>
</ul>
<figure class="highlight ps"><table><tr><td class="code"><pre><span class="line">npm install hexo<span class="literal">-abbrlink</span> -<span class="literal">-save</span></span><br></pre></td></tr></table></figure>

<ul>
<li>é…ç½®</li>
</ul>
<p>é¦–å…ˆä¿®æ”¹ <code>_config.yml</code> æ–‡ä»¶ä¸­çš„ <code>permalink</code> çš„é…ç½®</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">permalink:</span> <span class="string">posts/:abbrlink.html</span></span><br></pre></td></tr></table></figure>

<p>å†å¢åŠ ä»¥ä¸‹é…ç½®</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># abbrlink config</span></span><br><span class="line"><span class="comment">## https://github.com/rozbo/hexo-abbrlink</span></span><br><span class="line"><span class="attr">abbrlink:</span></span><br><span class="line">  <span class="attr">alg:</span> <span class="string">crc32</span> <span class="comment"># support crc16(default) and crc32</span></span><br><span class="line">  <span class="attr">rep:</span> <span class="string">hex</span> <span class="comment"># support dec(default) and hex</span></span><br><span class="line">  <span class="attr">drafts:</span> <span class="literal">true</span> <span class="comment"># (true)Process draft,(false)Do not process draft. false(default)</span></span><br><span class="line">  <span class="comment"># Generate categories from directory-tree</span></span><br><span class="line">  <span class="comment"># depth: the max_depth of directory-tree you want to generate, should &gt; 0</span></span><br><span class="line">  <span class="attr">auto_category:</span></span><br><span class="line">     <span class="attr">enable:</span> <span class="literal">true</span> <span class="comment"># true(default)</span></span><br><span class="line">     <span class="attr">depth:</span> <span class="number">3</span> <span class="comment"># 3(default)</span></span><br><span class="line">     <span class="attr">over_write:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">auto_title:</span> <span class="literal">false</span> <span class="comment"># enable auto title, it can auto fill the title by path</span></span><br><span class="line">  <span class="attr">auto_date:</span> <span class="literal">false</span> <span class="comment"># enable auto date, it can auto fill the date by time today</span></span><br><span class="line">  <span class="attr">force:</span> <span class="literal">false</span> <span class="comment"># enable force mode, in this mode, the plugin will ignore the cache, and calc the abbrlink for every post even it already had abbrlink.</span></span><br></pre></td></tr></table></figure>

<h3 id="hexo-generator-sitemap"><a href="#hexo-generator-sitemap" class="headerlink" title="hexo-generator-sitemap"></a><a href="https://github.com/hexojs/hexo-generator-sitemap">hexo-generator-sitemap</a></h3><p>ä¸ºäº†ä½¿åšå®¢èƒ½è¢«è°·æ­Œã€bingã€ç™¾åº¦æ”¶å½•ï¼Œæœ€å¥½ç”Ÿæˆ <code>sitemap</code> æ–¹ä¾¿çˆ¬å–ï¼Œæ•´ä½“æµç¨‹å¯ä»¥å…ˆå‚è€ƒ <a href="https://mizeri.github.io/2021/04/18/hexo-sitemap-google/">è¿™ç¯‡åšå®¢</a> å’Œ <a href="https://asurada.zone/post/Blog-Search-Engine-Index/">è¿™ç¯‡åšå®¢</a>ï¼Œåç»­æˆ‘å•ç‹¬å†™ä¸€ç¯‡åšå®¢ä»‹ç»æ•´ä½“æµç¨‹<!-- TODO --></p>
<ul>
<li>å®‰è£…</li>
</ul>
<figure class="highlight ps"><table><tr><td class="code"><pre><span class="line">npm install hexo<span class="literal">-generator</span><span class="literal">-sitemap</span> -<span class="literal">-save</span></span><br></pre></td></tr></table></figure>

<ul>
<li>é…ç½®</li>
</ul>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># hexo-generator-sitemap</span></span><br><span class="line"><span class="comment">## https://github.com/hexojs/hexo-generator-sitemap</span></span><br><span class="line"><span class="attr">sitemap:</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">sitemap.xml</span></span><br><span class="line">  <span class="comment"># template: ./sitemap_template.xml</span></span><br><span class="line">  <span class="attr">rel:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">tags:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">categories:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<h2 id="å°æŠ€å·§"><a href="#å°æŠ€å·§" class="headerlink" title="å°æŠ€å·§"></a>å°æŠ€å·§</h2><h3 id="è‡ªå®šä¹‰æäº¤ä¿¡æ¯"><a href="#è‡ªå®šä¹‰æäº¤ä¿¡æ¯" class="headerlink" title="è‡ªå®šä¹‰æäº¤ä¿¡æ¯"></a>è‡ªå®šä¹‰æäº¤ä¿¡æ¯</h3><figure class="highlight ps"><table><tr><td class="code"><pre><span class="line">hexo deploy <span class="literal">-m</span> <span class="string">&quot;è‡ªå®šä¹‰æäº¤ä¿¡æ¯&quot;</span></span><br></pre></td></tr></table></figure>

<p>ä¾‹å¦‚ä½¿ç”¨ <code>hexo</code> ä»“åº“çš„æäº¤ä¿¡æ¯æ¥æäº¤åˆ° <code>deploy</code> ä»“åº“</p>
<figure class="highlight ps"><table><tr><td class="code"><pre><span class="line">hexo deploy <span class="literal">-m</span> (git log <span class="literal">-1</span> -<span class="literal">-pretty</span>=format:%s)</span><br></pre></td></tr></table></figure>

<p>å¦‚æœä¸­æ–‡ä¹±ç ï¼Œå¯ä»¥å‚è€ƒ <a href="https://blog.csdn.net/weixin_43426860/article/details/83348284">è¿™ç¯‡åšå®¢</a> ä¿®æ”¹ UTF-8 ç¼–ç </p>
<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul>
<li><a href="https://hexo.io/zh-cn/docs/one-command-deployment">ã€Hexoã€‘ä¸€é”®éƒ¨ç½²</a></li>
<li><a href="https://github.com/hexojs/hexo-deployer-git">ã€GitHubã€‘hexo-deployer-git</a></li>
<li><a href="https://github.com/next-theme/hexo-word-counter">ã€GitHubã€‘hexo-word-counter</a></li>
<li><a href="https://github.com/rozbo/hexo-abbrlink">ã€GitHubã€‘hexo-abbrlink</a></li>
<li><a href="https://github.com/hexojs/hexo-generator-sitemap">ã€GitHubã€‘hexo-generator-sitemap</a></li>
<li><a href="https://git-scm.com/docs/git-log#_pretty_formats">ã€Gitã€‘git log è‡ªå®šä¹‰è¾“å‡ºæ ¼å¼</a></li>
<li><a href="https://blog.csdn.net/weixin_43426860/article/details/83348284">ã€CSDNã€‘è§£å†³ Windows PowerShell ä¹±ç </a></li>
</ul>
]]></content>
      <categories>
        <category>Hexo</category>
      </categories>
      <tags>
        <tag>Hexo</tag>
        <tag>NexT</tag>
      </tags>
  </entry>
  <entry>
    <title>NexT ä¸»é¢˜çš„é…ç½®ä½¿ç”¨è®°å½•</title>
    <url>/posts/9a0b7c3b.html</url>
    <content><![CDATA[<h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>NexT ä¸»é¢˜æ˜¯ Hexo ä¸Šä½¿ç”¨æœ€å¹¿ï¼ŒåŒæ—¶åœ¨ GitHub ä¸Šä¹Ÿæ˜¯ Star æœ€å¤šçš„ä¸»é¢˜ï¼Œbug ä¿®å¤å’ŒåŠŸèƒ½æ›´æ–°ä¹Ÿæ¯”è¾ƒå¿«ã€‚å½“å‰åšå®¢å°±æ˜¯ä½¿ç”¨ Hexo é…åˆ NexT ä¸»é¢˜æ­å»ºçš„</p>
<span id="more"></span>
<h3 id="ç‰ˆæœ¬"><a href="#ç‰ˆæœ¬" class="headerlink" title="ç‰ˆæœ¬"></a>ç‰ˆæœ¬</h3><p>åœ¨ <a href="https://github.com/next-theme/hexo-theme-next/issues/4">ã€å¿…è¯»ã€‘æ›´æ–°è¯´æ˜åŠå¸¸è§é—®é¢˜</a> ä¸­æœ‰ç›¸å…³è¯´æ˜ï¼ŒNexT ä¸€å…±æœ‰ä¸‰ä¸ªä¸åŒçš„ä»“åº“ï¼š</p>
<table>
<thead>
<tr>
<th>ç‰ˆæœ¬</th>
<th>å¹´ä»½</th>
<th>ä»“åº“</th>
</tr>
</thead>
<tbody><tr>
<td>v5.1.4 æˆ–æ›´ä½</td>
<td>2014 ~ 2017</td>
<td><a href="https://github.com/iissnan/hexo-theme-next">iissnan/hexo-theme-next</a></td>
</tr>
<tr>
<td>v6.0.0 ~ v7.8.0</td>
<td>2018 ~ 2019</td>
<td><a href="https://github.com/theme-next/hexo-theme-next">theme-next/hexo-theme-next</a></td>
</tr>
<tr>
<td>v8.0.0 æˆ–æ›´é«˜</td>
<td>2020</td>
<td><a href="https://github.com/next-theme/hexo-theme-next">next-theme/hexo-theme-next</a></td>
</tr>
</tbody></table>
<p>æ—§çš„ä»“åº“åŸºæœ¬ä¸Šå·²ç»ä¸å†æ›´æ–°ï¼Œå› æ­¤æ¨èé€‰æ‹©æœ€æ–°çš„ <a href="https://github.com/next-theme/hexo-theme-next">next-theme/hexo-theme-next</a> ä»“åº“çš„ NexT ä¸»é¢˜</p>
<h2 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h2><p>æ¨èä½¿ç”¨ GitHub è¿›è¡Œå®‰è£…ï¼Œå¯ä»¥éšæ—¶æ›´æ–°</p>
<p>å› ä¸ºç¬”è€…ä¸ªäººåœ¨ Windows ç¯å¢ƒä¸‹å†™åšå®¢ï¼Œåç»­å‘½ä»¤å‡ä»¥ <a href="https://docs.microsoft.com/zh-cn/powershell/scripting/install/installing-powershell?view=powershell-7.2">PowerShell</a> ä¸ºä¾‹</p>
<figure class="highlight ps"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> &lt;hexo<span class="literal">-dir</span>&gt;</span><br><span class="line"><span class="comment"># git clone https://github.com/next-theme/hexo-theme-next.git .\themes\next\</span></span><br><span class="line">git clone git@github.com:next<span class="literal">-theme</span>/hexo<span class="literal">-theme</span><span class="literal">-next</span>.git</span><br><span class="line"></span><br><span class="line"><span class="built_in">cp</span> .\themes\next\_config.yml .\_config.next.yml</span><br></pre></td></tr></table></figure>

<h2 id="é…ç½®è®°å½•"><a href="#é…ç½®è®°å½•" class="headerlink" title="é…ç½®è®°å½•"></a>é…ç½®è®°å½•</h2><p>å¯¹ NexT ä¸»é¢˜çš„é…ç½®å¯ä»¥ç›´æ¥åœ¨ <code>hexo</code> ä»“åº“ä¸‹çš„é…ç½®æ–‡ä»¶ <code>_config.next.yml</code> ä¸­è¿›è¡Œä¿®æ”¹å³å¯ï¼Œè¯¥æ–‡ä»¶çš„ä¿®æ”¹ä¼šåœ¨ç”Ÿæˆé¡µé¢æ—¶è¦†ç›–ä¸»é¢˜ç›®å½•ä¸‹çš„é…ç½®æ–‡ä»¶ <code>.\themes\next\_config.yml</code></p>
<p>è¡ç”Ÿæ‹“å±•ï¼š<a href="https://hexo.io/zh-cn/docs/configuration#%E4%BD%BF%E7%94%A8%E4%BB%A3%E6%9B%BF%E4%B8%BB%E9%A2%98%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6">ã€Hexoã€‘é…ç½®æ–‡ä»¶ä¼˜å…ˆçº§</a></p>
<h3 id="é£æ ¼-ä¸»é¢˜"><a href="#é£æ ¼-ä¸»é¢˜" class="headerlink" title="é£æ ¼/ä¸»é¢˜"></a>é£æ ¼/ä¸»é¢˜</h3><p>NexT ä¸»é¢˜åŒ…å«äº† 4 ä¸ªé£æ ¼ï¼Œä¸ªäººå–œæ¬¢ Geminiï¼Œç±»ä¼¼å¡ç‰‡çš„é£æ ¼ï¼Œè¾¹ç•Œæ¯”è¾ƒæ˜æ˜¾</p>
<p><img data-src="/posts/9a0b7c3b/NexT_Schemes.png" alt="NexT_Schemes"></p>
<p>ä¿®æ”¹ <code>_config.next.yml</code> ä¹‹åï¼Œç”¨ <code>hexo clean; hexo g; hexo s</code> é‡æ–°ç”Ÿæˆä¸€ä¸‹ï¼Œå°±å¯ä»¥åœ¨ <a href="http://localhost:4000/">æœ¬åœ°</a> é¢„è§ˆäº†ï¼ˆåç»­æµç¨‹å¦‚æœæ²¡æœ‰ç‰¹æ®Šè¯´æ˜åˆ™åŸºæœ¬ä¸€è‡´ï¼‰</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Schemes</span></span><br><span class="line"><span class="comment"># scheme: Muse</span></span><br><span class="line"><span class="comment"># scheme: Mist</span></span><br><span class="line"><span class="comment"># scheme: Pisces</span></span><br><span class="line"><span class="attr">scheme:</span> <span class="string">Gemini</span></span><br></pre></td></tr></table></figure>

<h3 id="ç½‘é¡µå›¾æ ‡"><a href="#ç½‘é¡µå›¾æ ‡" class="headerlink" title="ç½‘é¡µå›¾æ ‡"></a>ç½‘é¡µå›¾æ ‡</h3><p>åœ¨å„ç±»ç½‘ç«™ä¸Šä¸‹è½½åˆé€‚å›¾æ ‡ï¼ŒæŒ‰ç…§é…ç½®æ–‡ä»¶ä¸­çš„æ–‡ä»¶åå‘½åï¼Œå¹¶æ”¾åœ¨ <code>images</code> ä¸‹å³å¯</p>
<p>è¡ç”Ÿé˜…è¯»ï¼š<a href="https://developer.apple.com/library/archive/documentation/AppleApplications/Reference/SafariWebContent/ConfiguringWebApplications/ConfiguringWebApplications.html">ã€Appleã€‘Configuring Web Applications</a></p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">favicon:</span></span><br><span class="line">  <span class="attr">small:</span> <span class="string">/images/favicon-16x16-next.png</span></span><br><span class="line">  <span class="attr">medium:</span> <span class="string">/images/favicon-32x32-next.png</span></span><br><span class="line">  <span class="attr">apple_touch_icon:</span> <span class="string">/images/apple-touch-icon-next.png</span></span><br><span class="line">  <span class="attr">safari_pinned_tab:</span> <span class="string">/images/logo.svg</span></span><br><span class="line">  <span class="comment">#android_manifest: /manifest.json</span></span><br></pre></td></tr></table></figure>

<h3 id="èœå•æ "><a href="#èœå•æ " class="headerlink" title="èœå•æ "></a>èœå•æ </h3><p>èœå•æ é…ç½®é»˜è®¤æ²¡æœ‰å¼€å¯ï¼Œä¸ªäººå¼€å¯äº† <code>é¦–é¡µ</code>ã€<code>æ ‡ç­¾</code>ã€<code>åˆ†ç±»</code>ã€<code>å½’æ¡£</code> å››ä¸ªå­é¡¹ç›®ï¼Œå¹¶å¼€å¯äº†å›¾æ ‡å’Œæ•°é‡çš„æ°”æ³¡æ˜¾ç¤º</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Usage: `Key: /link/ || icon`</span></span><br><span class="line"><span class="comment"># Key is the name of menu item. If the translation for this item is available, the translated text will be loaded, otherwise the Key name will be used. Key is case-sensitive.</span></span><br><span class="line"><span class="comment"># Value before `||` delimiter is the target link, value after `||` delimiter is the name of Font Awesome icon.</span></span><br><span class="line"><span class="comment"># External url should start with http:// or https://</span></span><br><span class="line"><span class="attr">menu:</span></span><br><span class="line">  <span class="attr">home:</span> <span class="string">/</span> <span class="string">||</span> <span class="string">fa</span> <span class="string">fa-home</span></span><br><span class="line">  <span class="comment">#about: /about/ || fa fa-user</span></span><br><span class="line">  <span class="attr">tags:</span> <span class="string">/tags/</span> <span class="string">||</span> <span class="string">fa</span> <span class="string">fa-tags</span></span><br><span class="line">  <span class="attr">categories:</span> <span class="string">/categories/</span> <span class="string">||</span> <span class="string">fa</span> <span class="string">fa-th</span></span><br><span class="line">  <span class="attr">archives:</span> <span class="string">/archives/</span> <span class="string">||</span> <span class="string">fa</span> <span class="string">fa-archive</span></span><br><span class="line">  <span class="comment">#schedule: /schedule/ || fa fa-calendar</span></span><br><span class="line">  <span class="comment">#sitemap: /sitemap.xml || fa fa-sitemap</span></span><br><span class="line">  <span class="comment">#commonweal: /404/ || fa fa-heartbeat</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Enable / Disable menu icons / item badges.</span></span><br><span class="line"><span class="attr">menu_settings:</span></span><br><span class="line">  <span class="attr">icons:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">badges:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h3 id="ä¾§è¾¹æ "><a href="#ä¾§è¾¹æ " class="headerlink" title="ä¾§è¾¹æ "></a>ä¾§è¾¹æ </h3><p>é»˜è®¤å¤´åƒä¼šå¼€å¯æ—‹è½¬åŠŸèƒ½ï¼ŒèŠ±é‡Œèƒ¡å“¨çš„è€Œä¸”æ—‹è½¬æœ‰ç‚¹å¿«ï¼Œä¸ªäººé€‰æ‹©äº†å…³é—­</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Sidebar Avatar</span></span><br><span class="line"><span class="attr">avatar:</span></span><br><span class="line">  <span class="comment"># Replace the default image and set the url here.</span></span><br><span class="line">  <span class="attr">url:</span> <span class="string">/images/avatar.gif</span></span><br><span class="line">  <span class="comment"># If true, the avatar will be displayed in circle.</span></span><br><span class="line">  <span class="attr">rounded:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># If true, the avatar will be rotated with the cursor.</span></span><br><span class="line">  <span class="attr">rotated:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<p>åœ¨å•ç‹¬çš„æ–‡ç« é¡µé¢æ—¶ä¾§è¾¹æ ä¼šé»˜è®¤æ˜¾ç¤ºä¸ºç›®å½•ï¼Œå¹¶ä¸” <code>æ ‡ç­¾</code>ã€<code>åˆ†ç±»</code>ã€<code>å½’æ¡£</code> å·²ç»åœ¨èœå•æ å¼€å¯äº†ï¼Œæ‰€ä»¥ä¸ªäººé€‰æ‹©äº†å…³é—­</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Posts / Categories / Tags in sidebar.</span></span><br><span class="line"><span class="attr">site_state:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<p>å…¶ä»–ç¤¾äº¤ç½‘ç«™çš„ä¸»é¡µçš„é…ç½®èµ·æ¥ä¹Ÿå¾ˆç®€å•ï¼Œç®€å•æ›¿æ¢ä¸€ä¸‹é“¾æ¥ï¼Œå¹¶ä¸”å–æ¶ˆæ³¨é‡Šå³å¯</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Social Links</span></span><br><span class="line"><span class="comment"># Usage: `Key: permalink || icon`</span></span><br><span class="line"><span class="comment"># Key is the link label showing to end users.</span></span><br><span class="line"><span class="comment"># Value before `||` delimiter is the target permalink, value after `||` delimiter is the name of Font Awesome icon.</span></span><br><span class="line"><span class="attr">social:</span></span><br><span class="line">  <span class="attr">GitHub:</span> <span class="string">https://github.com/ywang-wnlo</span> <span class="string">||</span> <span class="string">fab</span> <span class="string">fa-github</span></span><br><span class="line">  <span class="attr">E-Mail:</span> <span class="string">mailto:ywang_wnlo@qq.com</span> <span class="string">||</span> <span class="string">fa</span> <span class="string">fa-envelope</span></span><br><span class="line">  <span class="comment">#Weibo: https://weibo.com/yourname || fab fa-weibo</span></span><br><span class="line">  <span class="comment">#Google: https://plus.google.com/yourname || fab fa-google</span></span><br><span class="line">  <span class="comment">#Twitter: https://twitter.com/yourname || fab fa-twitter</span></span><br><span class="line">  <span class="comment">#FB Page: https://www.facebook.com/yourname || fab fa-facebook</span></span><br><span class="line">  <span class="comment">#StackOverflow: https://stackoverflow.com/yourname || fab fa-stack-overflow</span></span><br><span class="line">  <span class="comment">#YouTube: https://youtube.com/yourname || fab fa-youtube</span></span><br><span class="line">  <span class="comment">#Instagram: https://instagram.com/yourname || fab fa-instagram</span></span><br><span class="line">  <span class="comment">#Skype: skype:yourname?call|chat || fab fa-skype</span></span><br></pre></td></tr></table></figure>

<h3 id="æœ¬åœ°æœç´¢"><a href="#æœ¬åœ°æœç´¢" class="headerlink" title="æœ¬åœ°æœç´¢"></a>æœ¬åœ°æœç´¢</h3><p>æœ¬åœ°æœç´¢å¯ä»¥å¿«é€Ÿçš„æ£€ç´¢æ‰€æœ‰çš„æ–‡ç« ï¼Œæœ‰æ—¶å€™è¿˜æ˜¯å¾ˆæœ‰ç”¨çš„</p>
<p>é…ç½®æœ¬åœ°æœç´¢ä¹‹å‰ï¼Œé¦–å…ˆè¦åœ¨ <code>hexo</code> ä¸‹å®‰è£…æ’ä»¶</p>
<figure class="highlight ps"><table><tr><td class="code"><pre><span class="line">npm install hexo<span class="literal">-generator</span><span class="literal">-searchdb</span> -<span class="literal">-save</span></span><br></pre></td></tr></table></figure>

<p>ç„¶ååœ¨é…ç½®ä¸­å¼€å¯å³å¯</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Local Search</span></span><br><span class="line"><span class="comment"># Dependencies: https://github.com/next-theme/hexo-generator-searchdb</span></span><br><span class="line"><span class="attr">local_search:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># If auto, trigger search by changing input.</span></span><br><span class="line">  <span class="comment"># If manual, trigger search by pressing enter key or search button.</span></span><br><span class="line">  <span class="attr">trigger:</span> <span class="string">auto</span></span><br><span class="line">  <span class="comment"># Show top n results per article, show all results by setting to -1</span></span><br><span class="line">  <span class="attr">top_n_per_article:</span> <span class="number">-1</span></span><br><span class="line">  <span class="comment"># Unescape html strings to the readable one.</span></span><br><span class="line">  <span class="attr">unescape:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># Preload the search data when the page loads.</span></span><br><span class="line">  <span class="attr">preload:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<h3 id="ä»£ç å—"><a href="#ä»£ç å—" class="headerlink" title="ä»£ç å—"></a>ä»£ç å—</h3><p>ä»£ç å—çš„é«˜äº®æœ‰å¾ˆå¤šç§é…è‰²å¯ä»¥é€‰ï¼Œå¹¶ä¸”å¯ä»¥å¼€å¯ä¸€é”®å¤åˆ¶åŠŸèƒ½</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">codeblock:</span></span><br><span class="line">  <span class="comment"># Code Highlight theme</span></span><br><span class="line">  <span class="comment"># All available themes: https://theme-next.js.org/highlight/</span></span><br><span class="line">  <span class="attr">theme:</span></span><br><span class="line">    <span class="attr">light:</span> <span class="string">vs</span></span><br><span class="line">    <span class="attr">dark:</span> <span class="string">vs2015</span></span><br><span class="line">  <span class="attr">prism:</span></span><br><span class="line">    <span class="attr">light:</span> <span class="string">prism</span></span><br><span class="line">    <span class="attr">dark:</span> <span class="string">prism-dark</span></span><br><span class="line">  <span class="comment"># Add copy button on codeblock</span></span><br><span class="line">  <span class="attr">copy_button:</span></span><br><span class="line">    <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># Available values: default | flat | mac</span></span><br><span class="line">    <span class="attr">style:</span> <span class="string">default</span></span><br></pre></td></tr></table></figure>

<h3 id="åŠ¨ç”»æ•ˆæœ"><a href="#åŠ¨ç”»æ•ˆæœ" class="headerlink" title="åŠ¨ç”»æ•ˆæœ"></a>åŠ¨ç”»æ•ˆæœ</h3><p>NexT é»˜è®¤å¼€å¯äº†åŠ¨ç”»æ•ˆæœï¼Œä½†æ˜¯æ„Ÿè§‰æ¯”è¾ƒæ…¢ï¼Œæ„Ÿè§‰æœ‰äº›å½±å“é˜…è¯»ï¼Œæ¨èå¼€å¯ <code>async</code>ï¼Œå¹¶ä¸”é€‚å½“çš„ä¿®æ”¹åŠ¨ç”»æ•ˆæœ</p>
<p>P.S. èœå•æ çš„åŠ¨ç”»ä¸å¯ä»¥å…³é—­å’Œè°ƒæ•´ï¼Œåº”è¯¥æ˜¯ä¸ª <a href="https://github.com/next-theme/hexo-theme-next/issues/412">bug</a></p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Use Animate.css to animate everything.</span></span><br><span class="line"><span class="comment"># For more information: https://animate.style</span></span><br><span class="line"><span class="attr">motion:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">async:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">transition:</span></span><br><span class="line">    <span class="comment"># All available transition variants: https://theme-next.js.org/animate/</span></span><br><span class="line">    <span class="attr">post_block:</span> <span class="string">fadeIn</span></span><br><span class="line">    <span class="attr">post_header:</span></span><br><span class="line">    <span class="attr">post_body:</span></span><br><span class="line">    <span class="attr">coll_header:</span></span><br><span class="line">    <span class="comment"># Only for Pisces | Gemini.</span></span><br><span class="line">    <span class="attr">sidebar:</span> <span class="string">fadeInDown</span></span><br></pre></td></tr></table></figure>

<h3 id="é˜…è¯»è¿›åº¦"><a href="#é˜…è¯»è¿›åº¦" class="headerlink" title="é˜…è¯»è¿›åº¦"></a>é˜…è¯»è¿›åº¦</h3><p>é˜…è¯»è¿›åº¦æœ‰ä¸¤ç§å±•ç¤ºæ–¹å¼ï¼Œä¸€ä¸ªåœ¨å›åˆ°é¦–é¡µçš„æŒ‰é’®ä¸Šç›´æ¥æ˜¾ç¤ºç™¾åˆ†æ¯”ï¼Œå¦ä¸€ä¸ªå¯ä»¥é…ç½®åœ¨é¦–ä½éƒ¨å¢åŠ è¿›åº¦æ¡ï¼Œä¸ªäººä¸¤ä¸ªéƒ½å¼€å¯äº†</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">back2top:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># Back to top in sidebar.</span></span><br><span class="line">  <span class="attr">sidebar:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># Scroll percent label in b2t button.</span></span><br><span class="line">  <span class="attr">scrollpercent:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Reading progress bar</span></span><br><span class="line"><span class="attr">reading_progress:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># Available values: left | right</span></span><br><span class="line">  <span class="attr">start_at:</span> <span class="string">left</span></span><br><span class="line">  <span class="comment"># Available values: top | bottom</span></span><br><span class="line">  <span class="attr">position:</span> <span class="string">bottom</span></span><br><span class="line">  <span class="attr">reversed:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">color:</span> <span class="string">&quot;#37c6c0&quot;</span></span><br><span class="line">  <span class="attr">height:</span> <span class="string">5px</span></span><br></pre></td></tr></table></figure>

<h3 id="ä¹¦ç­¾"><a href="#ä¹¦ç­¾" class="headerlink" title="ä¹¦ç­¾"></a>ä¹¦ç­¾</h3><p>NexT çš„ä¹¦ç­¾åŠŸèƒ½å¯ä»¥ä¿å­˜å½“å‰çš„é˜…è¯»è¿›åº¦ï¼Œä¸‹æ¬¡æ‰“å¼€æ˜¯ä¼šåœ¨ç»­æ¥è¯¥è¿›åº¦</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Bookmark Support</span></span><br><span class="line"><span class="attr">bookmark:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># Customize the color of the bookmark.</span></span><br><span class="line">  <span class="attr">color:</span> <span class="string">&quot;#222&quot;</span></span><br><span class="line">  <span class="comment"># If auto, save the reading progress when closing the page or clicking the bookmark-icon.</span></span><br><span class="line">  <span class="comment"># If manual, only save it by clicking the bookmark-icon.</span></span><br><span class="line">  <span class="attr">save:</span> <span class="string">auto</span></span><br></pre></td></tr></table></figure>

<h3 id="Mermaid"><a href="#Mermaid" class="headerlink" title="Mermaid"></a>Mermaid</h3><p><a href="https://mermaid-js.github.io/mermaid/#/">Mermaid</a> å¯ä»¥å¿«é€Ÿçš„ç”¨ä»£ç ç”Ÿæˆç®€å•çš„æµç¨‹å›¾ã€æ—¶åºå›¾ã€ç”˜ç‰¹å›¾ç­‰</p>
<p>NexT ä¸­å¼€å¯ Mermaid æ”¯æŒå¾ˆæ–¹ä¾¿ï¼ŒåŒæ—¶è¿˜æœ‰ä¸åŒçš„é£æ ¼å¯ä»¥é€‰</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Mermaid tag</span></span><br><span class="line"><span class="attr">mermaid:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># Available themes: default | dark | forest | neutral</span></span><br><span class="line">  <span class="attr">theme:</span></span><br><span class="line">    <span class="attr">light:</span> <span class="string">neutral</span></span><br><span class="line">    <span class="attr">dark:</span> <span class="string">dark</span></span><br></pre></td></tr></table></figure>

<h3 id="lazyload"><a href="#lazyload" class="headerlink" title="lazyload"></a>lazyload</h3><p>lazyload æ˜¯ç½‘ç«™å¸¸ç”¨çš„æŠ€æœ¯ï¼Œé€šè¿‡æŒ‰éœ€åŠ è½½ï¼Œé¿å…ä¸€æ¬¡æ€§åŠ è½½è¿‡å¤šå†…å®¹å¯¼è‡´çš„æ‰“å¼€ç¼“æ…¢</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Vanilla JavaScript plugin for lazyloading images.</span></span><br><span class="line"><span class="comment"># For more information: https://apoorv.pro/lozad.js/demo/</span></span><br><span class="line"><span class="attr">lazyload:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h3 id="fancybox"><a href="#fancybox" class="headerlink" title="fancybox"></a>fancybox</h3><p>fancybox å¯ä»¥åœ¨ç‚¹å‡»å›¾ç‰‡æ—¶æ”¾å¤§è¯¥å›¾ç‰‡ï¼Œå¹¶ä¸”å¯ä»¥å¿«é€Ÿæµè§ˆå½“å‰æ–‡ç« çš„æ‰€æœ‰å›¾ç‰‡</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># FancyBox is a tool that offers a nice and elegant way to add zooming functionality for images.</span></span><br><span class="line"><span class="comment"># For more information: https://fancyapps.com/fancybox/</span></span><br><span class="line"><span class="attr">fancybox:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h3 id="pangu"><a href="#pangu" class="headerlink" title="pangu"></a>pangu</h3><p>å¯¹äºå¼ºè¿«ç—‡æ¥è¯´ï¼Œä¸­è‹±æ–‡æ··æ’æ—¶åŠ ä¸Šç©ºæ ¼èƒ½å¾ˆå¤§ç¨‹åº¦æ”¹å–„é˜…è¯»ä½“éªŒï¼Œä½†æ˜¯æœ‰æ—¶å€™ä¼šä¸å°å¿ƒæ‰“æ¼éƒ¨åˆ†ç©ºæ ¼ï¼Œè€Œ <a href="https://github.com/vinta/pangu.js">pangu</a> è¿™ä¸ªé¡¹ç›®å°±å¯ä»¥å¸®ä½ åœ¨å±•ç¤ºæ—¶è‡ªåŠ¨åŠ ä¸Šç©ºæ ¼</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Pangu Support</span></span><br><span class="line"><span class="comment"># For more information: https://github.com/vinta/pangu.js</span></span><br><span class="line"><span class="comment"># Server-side plugin: https://github.com/next-theme/hexo-pangu</span></span><br><span class="line"><span class="attr">pangu:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h3 id="æèµ "><a href="#æèµ " class="headerlink" title="æèµ "></a>æèµ </h3><p>æ–‡ç« æœ«å°¾è¿˜å¯ä»¥æ±‚æ‰“èµï¼Œéœ€è¦é…ç½®å¥½ç›¸åº”çš„äºŒç»´ç å›¾ç‰‡ï¼Œå¹¶ä¸”å¯ä»¥ä¿®æ”¹æç¤ºè¯­å¥</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Donate (Sponsor) settings</span></span><br><span class="line"><span class="comment"># Front-matter variable (nonsupport animation).</span></span><br><span class="line"><span class="attr">reward_settings:</span></span><br><span class="line">  <span class="comment"># If true, a donate button will be displayed in every article by default.</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">animation:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">comment:</span> <span class="string">èµä¸ªé¸¡è…¿ğŸ—</span></span><br><span class="line"></span><br><span class="line"><span class="attr">reward:</span></span><br><span class="line">  <span class="attr">wechatpay:</span> <span class="string">/images/wechatpay.png</span></span><br><span class="line">  <span class="attr">alipay:</span> <span class="string">/images/alipay.jpg</span></span><br><span class="line">  <span class="comment">#paypal: /images/paypal.png</span></span><br><span class="line">  <span class="comment">#bitcoin: /images/bitcoin.png</span></span><br></pre></td></tr></table></figure>

<h3 id="ç‰ˆæƒå£°æ˜"><a href="#ç‰ˆæƒå£°æ˜" class="headerlink" title="ç‰ˆæƒå£°æ˜"></a>ç‰ˆæƒå£°æ˜</h3><p>NexT å†…ç½®äº†æ–‡ç« æœ«å°¾å¢åŠ ç‰ˆæƒå£°æ˜ï¼Œåªéœ€æ‰‹åŠ¨å¼€å¯å³å¯</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Creative Commons 4.0 International License.</span></span><br><span class="line"><span class="comment"># See: https://creativecommons.org/about/cclicenses/</span></span><br><span class="line"><span class="attr">creative_commons:</span></span><br><span class="line">  <span class="comment"># Available values: by | by-nc | by-nc-nd | by-nc-sa | by-nd | by-sa | cc-zero</span></span><br><span class="line">  <span class="attr">license:</span> <span class="string">by-nc-sa</span></span><br><span class="line">  <span class="comment"># Available values: big | small</span></span><br><span class="line">  <span class="attr">size:</span> <span class="string">small</span></span><br><span class="line">  <span class="attr">sidebar:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">post:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># You can set a language value if you prefer a translated version of CC license, e.g. deed.zh</span></span><br><span class="line">  <span class="comment"># CC licenses are available in 39 languages, you can find the specific and correct abbreviation you need on https://creativecommons.org</span></span><br><span class="line">  <span class="attr">language:</span></span><br></pre></td></tr></table></figure>

<h3 id="ä¸è’œå­"><a href="#ä¸è’œå­" class="headerlink" title="ä¸è’œå­"></a>ä¸è’œå­</h3><p><a href="https://busuanzi.ibruce.info/">ä¸è’œå­</a> æ˜¯ä¸€ä¸ªæç®€çš„ç½‘é¡µè®¡æ•°å™¨ï¼ŒNexT å·²ç»å†…ç½®ï¼Œåªéœ€æ‰“å¼€å³å¯</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Show Views / Visitors of the website / page with busuanzi.</span></span><br><span class="line"><span class="comment"># For more information: http://ibruce.info/2015/04/04/busuanzi/</span></span><br><span class="line"><span class="attr">busuanzi_count:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">total_visitors:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">total_visitors_icon:</span> <span class="string">fa</span> <span class="string">fa-user</span></span><br><span class="line">  <span class="attr">total_views:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">total_views_icon:</span> <span class="string">fa</span> <span class="string">fa-eye</span></span><br><span class="line">  <span class="attr">post_views:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">post_views_icon:</span> <span class="string">far</span> <span class="string">fa-eye</span></span><br></pre></td></tr></table></figure>

<h3 id="gitalk"><a href="#gitalk" class="headerlink" title="gitalk"></a>gitalk</h3><p>è¯„è®ºç³»ç»Ÿä¹Ÿæ˜¯ä¸€ä¸ªåšå®¢å¿…ä¸å¯å°‘çš„ï¼Œç”±äºæœ¬åšå®¢æ­åœ¨ GitHub Pages ä¸Šï¼Œæ‰€ä»¥è¯„è®ºç³»ç»Ÿå°±é‡‡ç”¨åˆ©ç”¨ GitHub Issues å®ç°çš„ <a href="https://github.com/gitalk/gitalk">gitalk</a></p>
<p>NexT å·²ç»å†…ç½®çš„ gitalk çš„ <code>js</code> å’Œ <code>css</code>ï¼Œåœ¨é…ç½®æ–‡ä»¶ä¸­å¼€å¯å¹¶è¿›è¡Œé…ç½®å³å¯</p>
<p>åœ¨ä¿®æ”¹é…ç½®æ–‡ä»¶ä¹‹å‰éœ€è¦å…ˆåœ¨ GitHub ä¸Šç”³è¯·ä¸€ä¸ª OAuth<br> Applicationï¼Œå…¥å£åœ¨ <code>ã€Settingsã€‘</code> -&gt; <code>ã€Developer settingsã€‘</code> -&gt; <code>ã€OAuth Appsã€‘</code> -&gt; <code>ã€New OAuth Appã€‘</code>ï¼Œæˆ–è€…ç›´æ¥ä½¿ç”¨è¿™ä¸ª <a href="https://github.com/settings/applications/new">é“¾æ¥</a></p>
<p><img data-src="/posts/9a0b7c3b/OAuth_APP_Register.png" alt="OAuth_APP_Register"></p>
<p>å¡«å†™å¥½ä¹‹åï¼Œè®°å½•ä¸‹åº”ç”¨ id ä»¥åŠå¯†é’¥ï¼Œå¦‚æœæ²¡æœ‰æ˜¾ç¤ºå¯†é’¥éœ€è¦æ‰‹åŠ¨ç”Ÿæˆä¸€ä¸‹</p>
<p><img data-src="/posts/9a0b7c3b/OAuth_APP_ID_Secrets.png" alt="OAuth_APP_ID_Secrets"></p>
<p>ç„¶åé¦–å…ˆé€‰ç”¨ gitalk ä½œä¸ºè¯„è®ºç³»ç»Ÿ</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Multiple Comment System Support</span></span><br><span class="line"><span class="attr">comments:</span></span><br><span class="line">  <span class="comment"># Available values: tabs | buttons</span></span><br><span class="line">  <span class="attr">style:</span> <span class="string">tabs</span></span><br><span class="line">  <span class="comment"># Choose a comment system to be displayed by default.</span></span><br><span class="line">  <span class="comment"># Available values: disqus | disqusjs | changyan | livere | gitalk | utterances</span></span><br><span class="line">  <span class="attr">active:</span> <span class="string">gitalk</span></span><br><span class="line">  <span class="comment"># Setting `true` means remembering the comment system selected by the visitor.</span></span><br><span class="line">  <span class="attr">storage:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># Lazyload all comment systems.</span></span><br><span class="line">  <span class="attr">lazyload:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># Modify texts or order for any naves, here are some examples.</span></span><br><span class="line">  <span class="attr">nav:</span></span><br><span class="line">    <span class="comment">#disqus:</span></span><br><span class="line">    <span class="comment">#  text: Load Disqus</span></span><br><span class="line">    <span class="comment">#  order: -1</span></span><br><span class="line">    <span class="comment">#gitalk:</span></span><br><span class="line">    <span class="comment">#  order: -2</span></span><br></pre></td></tr></table></figure>

<p>åœ¨ gitalk é…ç½®ä¸­å¡«ä¸Šç›¸åº”çš„å†…å®¹</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Gitalk</span></span><br><span class="line"><span class="comment"># For more information: https://gitalk.github.io</span></span><br><span class="line"><span class="attr">gitalk:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">github_id:</span> <span class="string">&lt;GitHub</span> <span class="string">id&gt;</span> <span class="comment"># GitHub repo owner</span></span><br><span class="line">  <span class="attr">repo:</span> <span class="string">&lt;GitHub</span> <span class="string">id&gt;.github.io</span> <span class="comment"># Repository name to store issues</span></span><br><span class="line">  <span class="attr">client_id:</span> <span class="string">&lt;åº”ç”¨</span> <span class="string">id&gt;</span> <span class="comment"># GitHub Application Client ID</span></span><br><span class="line">  <span class="attr">client_secret:</span> <span class="string">&lt;åº”ç”¨å¯†é’¥&gt;</span> <span class="comment"># GitHub Application Client Secret</span></span><br><span class="line">  <span class="attr">admin_user:</span> <span class="string">&lt;GitHub</span> <span class="string">id&gt;</span> <span class="comment"># GitHub repo owner and collaborators, only these guys can initialize gitHub issues</span></span><br><span class="line">  <span class="attr">distraction_free_mode:</span> <span class="literal">true</span> <span class="comment"># Facebook-like distraction free mode</span></span><br><span class="line">  <span class="comment"># When the official proxy is not available, you can change it to your own proxy address</span></span><br><span class="line">  <span class="attr">proxy:</span> <span class="string">https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token</span> <span class="comment"># This is official proxy address</span></span><br><span class="line">  <span class="comment"># Gitalk&#x27;s display language depends on user&#x27;s browser or system environment</span></span><br><span class="line">  <span class="comment"># If you want everyone visiting your site to see a uniform language, you can set a force language value</span></span><br><span class="line">  <span class="comment"># Available values: en | es-ES | fr | ru | zh-CN | zh-TW</span></span><br><span class="line">  <span class="attr">language:</span></span><br></pre></td></tr></table></figure>

<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul>
<li><a href="https://theme-next.js.org/">ã€NexTã€‘v8.0.0+ å®˜ç½‘</a></li>
<li><a href="https://github.com/next-theme/hexo-theme-next/issues/4">ã€å¿…è¯»ã€‘æ›´æ–°è¯´æ˜åŠå¸¸è§é—®é¢˜</a></li>
<li><a href="https://hexo.io/zh-cn/docs/configuration#%E4%BD%BF%E7%94%A8%E4%BB%A3%E6%9B%BF%E4%B8%BB%E9%A2%98%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6">ã€Hexoã€‘é…ç½®æ–‡ä»¶ä¼˜å…ˆçº§</a></li>
<li><a href="https://developer.apple.com/library/archive/documentation/AppleApplications/Reference/SafariWebContent/ConfiguringWebApplications/ConfiguringWebApplications.html">ã€Appleã€‘Configuring Web Applications</a></li>
<li><a href="https://mermaid-js.github.io/mermaid/#/">ã€Mermaidã€‘å®˜ç½‘</a></li>
<li><a href="https://github.com/vinta/pangu.js">ã€GitHubã€‘pangu</a></li>
<li><a href="https://busuanzi.ibruce.info/">ã€ä¸è’œå­ã€‘å®˜ç½‘</a></li>
<li><a href="https://github.com/gitalk/gitalk">ã€GitHubã€‘Gitalk</a></li>
</ul>
]]></content>
      <categories>
        <category>Hexo</category>
      </categories>
      <tags>
        <tag>Hexo</tag>
        <tag>NexT</tag>
      </tags>
  </entry>
  <entry>
    <title>io_uring å†…æ ¸æºç åˆ†æ</title>
    <url>/posts/4f0d345c.html</url>
    <content><![CDATA[<p>å½“å‰å†…å®¹åŸºäº Linux Kernel <a href="https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/tag/?h=v5.4.121">v5.4.121</a></p>
<h2 id="1-io-uring"><a href="#1-io-uring" class="headerlink" title="1. io_uring"></a>1. <code>io_uring</code></h2><p><a href="/posts/c142853f.html#%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8">ä¹‹å‰</a> ä»‹ç»è¿‡ io_uring åªå¢åŠ äº†ä¸‰ä¸ª Linux ç³»ç»Ÿè°ƒç”¨åˆ†åˆ«æ˜¯ <code>io_uring_setup</code>ï¼Œ<code>io_uring_enter</code> å’Œ <code>io_uring_register</code></p>
<p>ä»–ä»¬çš„å…¥å£éƒ½åœ¨ Linux å†…æ ¸æºç çš„ <code>fs/io_uring.c</code> æ–‡ä»¶ä¸­ï¼Œä¸‹é¢å°†é€ä¸ªåˆ†æ</p>
<span id="more"></span>
<h2 id="2-ç³»ç»Ÿè°ƒç”¨-io-uring-setup"><a href="#2-ç³»ç»Ÿè°ƒç”¨-io-uring-setup" class="headerlink" title="2. ç³»ç»Ÿè°ƒç”¨ io_uring_setup"></a>2. ç³»ç»Ÿè°ƒç”¨ <code>io_uring_setup</code></h2><p><code>io_uring_setup</code> çš„ä½œç”¨åœ¨ <a href="/posts/d7259d1d.html#io-uring-queue-init">ç”¨æˆ·åº“æºç åˆ†æ</a> ä¸­æœ‰è¿‡ä»‹ç»ï¼Œä¸»è¦æ˜¯åˆå§‹åŒ–åˆå§‹åŒ– <code>io_uring</code> ç»“æ„ä½“</p>
<h3 id="2-1-io-uring-setup"><a href="#2-1-io-uring-setup" class="headerlink" title="2.1. io_uring_setup"></a>2.1. <code>io_uring_setup</code></h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Sets up an aio uring context, and returns the fd. Applications asks for a</span></span><br><span class="line"><span class="comment"> * ring size, we return the actual sq/cq ring sizes (among other things) in the</span></span><br><span class="line"><span class="comment"> * params structure passed in.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">long</span> <span class="title">io_uring_setup</span><span class="params">(u32 entries, struct io_uring_params __user *params)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">io_uring_params</span> <span class="title">p</span>;</span></span><br><span class="line">	<span class="keyword">long</span> ret;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ç”¨æˆ·æ€æ‹·è´åˆ°å†…æ ¸æ€</span></span><br><span class="line">	<span class="keyword">if</span> (copy_from_user(&amp;p, params, <span class="keyword">sizeof</span>(p)))</span><br><span class="line">		<span class="keyword">return</span> -EFAULT;</span><br><span class="line">	<span class="comment">// ç¡®è®¤ä¿ç•™åŒºåŸŸæ²¡æœ‰è¢«èµ‹å€¼</span></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ARRAY_SIZE(p.resv); i++) &#123;</span><br><span class="line">		<span class="keyword">if</span> (p.resv[i])</span><br><span class="line">			<span class="keyword">return</span> -EINVAL;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// æ£€æŸ¥ flags å‚æ•°</span></span><br><span class="line">	<span class="keyword">if</span> (p.flags &amp; ~(IORING_SETUP_IOPOLL | IORING_SETUP_SQPOLL |</span><br><span class="line">			IORING_SETUP_SQ_AFF))</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// åˆ†é…å†…å­˜ç©ºé—´ï¼Œåˆ›å»º workqueueï¼Œåˆ›å»º fd ç­‰</span></span><br><span class="line">	ret = io_uring_create(entries, &amp;p);</span><br><span class="line">	<span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// å†…æ ¸æ€æ‹·è´å›ç”¨æˆ·æ€</span></span><br><span class="line">	<span class="keyword">if</span> (copy_to_user(params, &amp;p, <span class="keyword">sizeof</span>(p)))</span><br><span class="line">		<span class="keyword">return</span> -EFAULT;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">SYSCALL_DEFINE2(io_uring_setup, u32, entries,</span><br><span class="line">		struct io_uring_params __user *, params)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> io_uring_setup(entries, params);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ° <code>io_uring_setup</code> çš„æ ¸å¿ƒå‡½æ•°æ˜¯ <code>io_uring_create</code></p>
<h3 id="2-2-io-uring-create"><a href="#2-2-io-uring-create" class="headerlink" title="2.2. io_uring_create"></a>2.2. <code>io_uring_create</code></h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">io_uring_create</span><span class="params">(<span class="keyword">unsigned</span> entries, struct io_uring_params *p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">user_struct</span> *<span class="title">user</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">io_ring_ctx</span> *<span class="title">ctx</span>;</span></span><br><span class="line">	<span class="keyword">bool</span> account_mem;</span><br><span class="line">	<span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!entries || entries &gt; IORING_MAX_ENTRIES)</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Use twice as many entries for the CQ ring. It&#x27;s possible for the</span></span><br><span class="line"><span class="comment">	 * application to drive a higher depth than the size of the SQ ring,</span></span><br><span class="line"><span class="comment">	 * since the sqes are only used at submission time. This allows for</span></span><br><span class="line"><span class="comment">	 * some flexibility in overcommitting a bit.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	p-&gt;sq_entries = roundup_pow_of_two(entries);</span><br><span class="line">	p-&gt;cq_entries = <span class="number">2</span> * p-&gt;sq_entries;</span><br><span class="line"></span><br><span class="line">	user = get_uid(current_user());</span><br><span class="line">	<span class="comment">// å…è®¸å¯¹å…±äº«å†…å­˜æ®µè¿›è¡Œé”å®š</span></span><br><span class="line">	account_mem = !capable(CAP_IPC_LOCK);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (account_mem) &#123;</span><br><span class="line">		<span class="comment">// ä¸èƒ½å¯¹å…±äº«å†…å­˜æ®µè¿›è¡Œé”å®šï¼Œå°±éœ€è¦å¢åŠ å½“å‰å¯ä»¥é”å®šçš„å†…å­˜</span></span><br><span class="line">		ret = io_account_mem(user,</span><br><span class="line">				ring_pages(p-&gt;sq_entries, p-&gt;cq_entries));</span><br><span class="line">		<span class="keyword">if</span> (ret) &#123;</span><br><span class="line">			free_uid(user);</span><br><span class="line">			<span class="keyword">return</span> ret;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ctx = io_ring_ctx_alloc(p);</span><br><span class="line">	<span class="keyword">if</span> (!ctx) &#123;</span><br><span class="line">		<span class="keyword">if</span> (account_mem)</span><br><span class="line">			io_unaccount_mem(user, ring_pages(p-&gt;sq_entries,</span><br><span class="line">								p-&gt;cq_entries));</span><br><span class="line">		free_uid(user);</span><br><span class="line">		<span class="keyword">return</span> -ENOMEM;</span><br><span class="line">	&#125;</span><br><span class="line">	ctx-&gt;compat = in_compat_syscall();</span><br><span class="line">	ctx-&gt;account_mem = account_mem;</span><br><span class="line">	ctx-&gt;user = user;</span><br><span class="line"></span><br><span class="line">	ctx-&gt;creds = get_current_cred();</span><br><span class="line">	<span class="keyword">if</span> (!ctx-&gt;creds) &#123;</span><br><span class="line">		ret = -ENOMEM;</span><br><span class="line">		<span class="keyword">goto</span> err;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ç”³è¯· io_rings SQEs</span></span><br><span class="line">	ret = io_allocate_scq_urings(ctx, p);</span><br><span class="line">	<span class="keyword">if</span> (ret)</span><br><span class="line">		<span class="keyword">goto</span> err;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// åˆå§‹åŒ– workqueueï¼Œ[åˆå§‹åŒ–å†…æ ¸çº¿ç¨‹ç”¨äºè¿›è¡Œ IO poll]</span></span><br><span class="line">	ret = io_sq_offload_start(ctx, p);</span><br><span class="line">	<span class="keyword">if</span> (ret)</span><br><span class="line">		<span class="keyword">goto</span> err;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">memset</span>(&amp;p-&gt;sq_off, <span class="number">0</span>, <span class="keyword">sizeof</span>(p-&gt;sq_off));</span><br><span class="line">	p-&gt;sq_off.head = offsetof(struct io_rings, sq.head);</span><br><span class="line">	p-&gt;sq_off.tail = offsetof(struct io_rings, sq.tail);</span><br><span class="line">	p-&gt;sq_off.ring_mask = offsetof(struct io_rings, sq_ring_mask);</span><br><span class="line">	p-&gt;sq_off.ring_entries = offsetof(struct io_rings, sq_ring_entries);</span><br><span class="line">	p-&gt;sq_off.flags = offsetof(struct io_rings, sq_flags);</span><br><span class="line">	p-&gt;sq_off.dropped = offsetof(struct io_rings, sq_dropped);</span><br><span class="line">	p-&gt;sq_off.<span class="built_in">array</span> = (<span class="keyword">char</span> *)ctx-&gt;sq_array - (<span class="keyword">char</span> *)ctx-&gt;rings;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">memset</span>(&amp;p-&gt;cq_off, <span class="number">0</span>, <span class="keyword">sizeof</span>(p-&gt;cq_off));</span><br><span class="line">	p-&gt;cq_off.head = offsetof(struct io_rings, cq.head);</span><br><span class="line">	p-&gt;cq_off.tail = offsetof(struct io_rings, cq.tail);</span><br><span class="line">	p-&gt;cq_off.ring_mask = offsetof(struct io_rings, cq_ring_mask);</span><br><span class="line">	p-&gt;cq_off.ring_entries = offsetof(struct io_rings, cq_ring_entries);</span><br><span class="line">	p-&gt;cq_off.overflow = offsetof(struct io_rings, cq_overflow);</span><br><span class="line">	p-&gt;cq_off.cqes = offsetof(struct io_rings, cqes);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Install ring fd as the very last thing, so we don&#x27;t risk someone</span></span><br><span class="line"><span class="comment">	 * having closed it before we finish setup</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="comment">// åˆ›å»º fd ä¾¿äºç”¨æˆ·æ€è®¿é—® ctx</span></span><br><span class="line">	ret = io_uring_get_fd(ctx);</span><br><span class="line">	<span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">goto</span> err;</span><br><span class="line"></span><br><span class="line">	p-&gt;features = IORING_FEAT_SINGLE_MMAP;</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">err:</span><br><span class="line">	io_ring_ctx_wait_and_kill(ctx);</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<pre class="mermaid">  graph TD;
  io_uring_setup --> io_ring_ctx_alloc;
  io_uring_setup --> io_allocate_scq_urings;
  io_uring_setup --> io_sq_offload_start;
  io_uring_setup --> io_uring_get_fd;</pre>

<ol>
<li><p><code>io_ring_ctx_alloc</code> ä¸»è¦ç”¨æ¥ç”³è¯·ç©ºé—´ï¼Œåˆå§‹åŒ–åˆ—è¡¨å¤´ã€äº’æ–¥é”ã€è‡ªæ—‹é”ç­‰ç»“æ„</p>
</li>
<li><p><code>io_allocate_scq_urings</code> æ¥åˆå§‹åŒ–æ•´ä¸ª <code>struct io_rings *rings</code>ï¼ŒåŒ…æ‹¬ <code>SQ</code>ã€<code>CQ</code> å¤´å°¾æŒ‡é’ˆçš„åˆå§‹åŒ–ï¼Œä»¥åŠ <code>SQE</code>ã€<code>CQE</code> çš„åˆå§‹åŒ–</p>
<ul>
<li>ä¸åŒçš„æ˜¯ <code>SQ</code>ã€<code>CQ</code> å¤´å°¾æŒ‡é’ˆä»¥åŠ <code>CQE</code> éƒ½åœ¨ <code>struct io_rings *rings</code> ç»“æ„ä½“ä¸­</li>
<li>è€Œ <code>SQE</code> åˆ™æ˜¯åœ¨ <code>struct io_ring_ctx *ctx</code> ç»“æ„ä½“ä¸­</li>
</ul>
</li>
<li><p><code>io_sq_offload_start</code> ä¼šæ ¹æ®ç”¨æˆ·é€šè¿‡ <code>io_uring_setup</code> ä¼ é€’çš„ <code>flags</code> æ¥é…ç½® <code>io_uring</code> çš„è¿è¡Œæ–¹å¼ï¼Œåç»­è¯¦ç»†å±•å¼€</p>
</li>
<li><p><code>io_uring_get_fd</code> å°† <code>struct io_ring_ctx *ctx</code> æš´éœ²ç»™ç”¨æˆ·æ€è®¿é—®</p>
</li>
</ol>
<h3 id="2-3-io-sq-offload-start"><a href="#2-3-io-sq-offload-start" class="headerlink" title="2.3. io_sq_offload_start"></a>2.3. <code>io_sq_offload_start</code></h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">io_sq_offload_start</span><span class="params">(struct io_ring_ctx *ctx,</span></span></span><br><span class="line"><span class="params"><span class="function">			       struct io_uring_params *p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">	mmgrab(current-&gt;mm);</span><br><span class="line">	ctx-&gt;sqo_mm = current-&gt;mm;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (ctx-&gt;flags &amp; IORING_SETUP_SQPOLL) &#123;</span><br><span class="line">		<span class="comment">// IORING_SETUP_SQPOLL å°†ä¼šåˆ›å»ºä¸€ä¸ªå†…æ ¸çº¿ç¨‹æ¥ poll SQ</span></span><br><span class="line">		ret = -EPERM;</span><br><span class="line">		<span class="keyword">if</span> (!capable(CAP_SYS_ADMIN))</span><br><span class="line">			<span class="keyword">goto</span> err;</span><br><span class="line"></span><br><span class="line">		ctx-&gt;sq_thread_idle = msecs_to_jiffies(p-&gt;sq_thread_idle);</span><br><span class="line">		<span class="keyword">if</span> (!ctx-&gt;sq_thread_idle)</span><br><span class="line">			ctx-&gt;sq_thread_idle = HZ;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (p-&gt;flags &amp; IORING_SETUP_SQ_AFF) &#123;</span><br><span class="line">			<span class="keyword">int</span> cpu = p-&gt;sq_thread_cpu;</span><br><span class="line"></span><br><span class="line">			ret = -EINVAL;</span><br><span class="line">			<span class="keyword">if</span> (cpu &gt;= nr_cpu_ids)</span><br><span class="line">				<span class="keyword">goto</span> err;</span><br><span class="line">			<span class="keyword">if</span> (!cpu_online(cpu))</span><br><span class="line">				<span class="keyword">goto</span> err;</span><br><span class="line"></span><br><span class="line">			ctx-&gt;sqo_thread = kthread_create_on_cpu(io_sq_thread,</span><br><span class="line">							ctx, cpu,</span><br><span class="line">							<span class="string">&quot;io_uring-sq&quot;</span>);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			ctx-&gt;sqo_thread = kthread_create(io_sq_thread, ctx,</span><br><span class="line">							<span class="string">&quot;io_uring-sq&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (IS_ERR(ctx-&gt;sqo_thread)) &#123;</span><br><span class="line">			ret = PTR_ERR(ctx-&gt;sqo_thread);</span><br><span class="line">			ctx-&gt;sqo_thread = <span class="literal">NULL</span>;</span><br><span class="line">			<span class="keyword">goto</span> err;</span><br><span class="line">		&#125;</span><br><span class="line">		wake_up_process(ctx-&gt;sqo_thread);</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (p-&gt;flags &amp; IORING_SETUP_SQ_AFF) &#123;</span><br><span class="line">		<span class="comment">/* Can&#x27;t have SQ_AFF without SQPOLL */</span></span><br><span class="line">		ret = -EINVAL;</span><br><span class="line">		<span class="keyword">goto</span> err;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Do QD, or 2 * CPUS, whatever is smallest */</span></span><br><span class="line">	ctx-&gt;sqo_wq[<span class="number">0</span>] = alloc_workqueue(<span class="string">&quot;io_ring-wq&quot;</span>,</span><br><span class="line">			WQ_UNBOUND | WQ_FREEZABLE,</span><br><span class="line">			min(ctx-&gt;sq_entries - <span class="number">1</span>, <span class="number">2</span> * num_online_cpus()));</span><br><span class="line">	<span class="keyword">if</span> (!ctx-&gt;sqo_wq[<span class="number">0</span>]) &#123;</span><br><span class="line">		ret = -ENOMEM;</span><br><span class="line">		<span class="keyword">goto</span> err;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * This is for buffered writes, where we want to limit the parallelism</span></span><br><span class="line"><span class="comment">	 * due to file locking in file systems. As &quot;normal&quot; buffered writes</span></span><br><span class="line"><span class="comment">	 * should parellelize on writeout quite nicely, limit us to having 2</span></span><br><span class="line"><span class="comment">	 * pending. This avoids massive contention on the inode when doing</span></span><br><span class="line"><span class="comment">	 * buffered async writes.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="comment">// å¯¹ buffer å†™çš„ workqueue æ·±åº¦è¿›è¡Œé™åˆ¶ï¼Œå‡å°‘é”äº‰ç”¨å¼€é”€?</span></span><br><span class="line">	ctx-&gt;sqo_wq[<span class="number">1</span>] = alloc_workqueue(<span class="string">&quot;io_ring-write-wq&quot;</span>,</span><br><span class="line">						WQ_UNBOUND | WQ_FREEZABLE, <span class="number">2</span>);</span><br><span class="line">	<span class="keyword">if</span> (!ctx-&gt;sqo_wq[<span class="number">1</span>]) &#123;</span><br><span class="line">		ret = -ENOMEM;</span><br><span class="line">		<span class="keyword">goto</span> err;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">err:</span><br><span class="line">	io_finish_async(ctx);</span><br><span class="line">	mmdrop(ctx-&gt;sqo_mm);</span><br><span class="line">	ctx-&gt;sqo_mm = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å½“ <code>flags</code> ä¸­é…ç½®äº† <code>IORING_SETUP_SQPOLL</code> æ—¶ï¼Œå°†å¯åŠ¨ä¸€ä¸ªå•ç‹¬çš„å†…æ ¸çº¿ç¨‹ <code>io_sq_thread</code>ï¼Œè€Œå½“ <code>IORING_SETUP_SQ_AFF</code> å­—æ®µä¹Ÿé…ç½®æ—¶ï¼Œå°†æ ¹æ® <code>sq_thread_cpu</code> å­—æ®µï¼Œåœ¨æŒ‡å®šçš„ CPU ä¸Šå¯ç”¨å†…æ ¸çº¿ç¨‹ <code>io_sq_thread</code></p>
<p>åŒæ—¶è¯¥å‡½æ•°è¿˜ä¼šåˆ›å»ºä¸¤ä¸ªå·¥ä½œé˜Ÿåˆ— <code>ctx-&gt;sqo_wq[2]</code> åˆ†åˆ«åä¸º <code>io_ring-wq</code> å’Œ <code>io_ring-write-wq</code></p>
<ul>
<li><code>io_ring-wq</code> ä¸»è¦å¤„ç†è¯» IOï¼Œä»¥åŠ direct å†™ IO</li>
<li><code>io_ring-write-wq</code> ä¸»è¦æ˜¯å¤„ç† buffer å†™ IO</li>
</ul>
<h2 id="3-ç³»ç»Ÿè°ƒç”¨-io-uring-enter"><a href="#3-ç³»ç»Ÿè°ƒç”¨-io-uring-enter" class="headerlink" title="3. ç³»ç»Ÿè°ƒç”¨ io_uring_enter"></a>3. ç³»ç»Ÿè°ƒç”¨ <code>io_uring_enter</code></h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">SYSCALL_DEFINE6(io_uring_enter, <span class="keyword">unsigned</span> <span class="keyword">int</span>, fd, u32, to_submit,</span><br><span class="line">		u32, min_complete, u32, flags, <span class="keyword">const</span> <span class="keyword">sigset_t</span> __user *, sig,</span><br><span class="line">		<span class="keyword">size_t</span>, sigsz)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">io_ring_ctx</span> *<span class="title">ctx</span>;</span></span><br><span class="line">	<span class="keyword">long</span> ret = -EBADF;</span><br><span class="line">	<span class="keyword">int</span> submitted = <span class="number">0</span>;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fd</span> <span class="title">f</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (flags &amp; ~(IORING_ENTER_GETEVENTS | IORING_ENTER_SQ_WAKEUP))</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">	f = fdget(fd);</span><br><span class="line">	<span class="keyword">if</span> (!f.file)</span><br><span class="line">		<span class="keyword">return</span> -EBADF;</span><br><span class="line"></span><br><span class="line">	ret = -EOPNOTSUPP;</span><br><span class="line">	<span class="keyword">if</span> (f.file-&gt;f_op != &amp;io_uring_fops)</span><br><span class="line">		<span class="keyword">goto</span> out_fput;</span><br><span class="line"></span><br><span class="line">	ret = -ENXIO;</span><br><span class="line">	ctx = f.file-&gt;private_data;</span><br><span class="line">	<span class="keyword">if</span> (!percpu_ref_tryget(&amp;ctx-&gt;refs))</span><br><span class="line">		<span class="keyword">goto</span> out_fput;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * For SQ polling, the thread will do all submissions and completions.</span></span><br><span class="line"><span class="comment">	 * Just return the requested submit count, and wake the thread if</span></span><br><span class="line"><span class="comment">	 * we were asked to.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	ret = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span> (ctx-&gt;flags &amp; IORING_SETUP_SQPOLL) &#123;</span><br><span class="line">		<span class="keyword">if</span> (flags &amp; IORING_ENTER_SQ_WAKEUP)</span><br><span class="line">			wake_up(&amp;ctx-&gt;sqo_wait);</span><br><span class="line">		submitted = to_submit;</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (to_submit) &#123;</span><br><span class="line">		to_submit = min(to_submit, ctx-&gt;sq_entries);</span><br><span class="line"></span><br><span class="line">		mutex_lock(&amp;ctx-&gt;uring_lock);</span><br><span class="line">		submitted = io_ring_submit(ctx, to_submit);</span><br><span class="line">		mutex_unlock(&amp;ctx-&gt;uring_lock);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (submitted != to_submit)</span><br><span class="line">			<span class="keyword">goto</span> out;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (flags &amp; IORING_ENTER_GETEVENTS) &#123;</span><br><span class="line">		<span class="keyword">unsigned</span> nr_events = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">		min_complete = min(min_complete, ctx-&gt;cq_entries);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (ctx-&gt;flags &amp; IORING_SETUP_IOPOLL) &#123;</span><br><span class="line">			ret = io_iopoll_check(ctx, &amp;nr_events, min_complete);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			ret = io_cqring_wait(ctx, min_complete, sig, sigsz);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">out:</span><br><span class="line">	percpu_ref_put(&amp;ctx-&gt;refs);</span><br><span class="line">out_fput:</span><br><span class="line">	fdput(f);</span><br><span class="line">	<span class="keyword">return</span> submitted ? submitted : ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>TODO</p>
<h2 id="4-ç³»ç»Ÿè°ƒç”¨-io-uring-register"><a href="#4-ç³»ç»Ÿè°ƒç”¨-io-uring-register" class="headerlink" title="4. ç³»ç»Ÿè°ƒç”¨ io_uring_register"></a>4. ç³»ç»Ÿè°ƒç”¨ <code>io_uring_register</code></h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">SYSCALL_DEFINE4(io_uring_register, <span class="keyword">unsigned</span> <span class="keyword">int</span>, fd, <span class="keyword">unsigned</span> <span class="keyword">int</span>, opcode,</span><br><span class="line">		<span class="keyword">void</span> __user *, arg, <span class="keyword">unsigned</span> <span class="keyword">int</span>, nr_args)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">io_ring_ctx</span> *<span class="title">ctx</span>;</span></span><br><span class="line">	<span class="keyword">long</span> ret = -EBADF;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fd</span> <span class="title">f</span>;</span></span><br><span class="line"></span><br><span class="line">	f = fdget(fd);</span><br><span class="line">	<span class="keyword">if</span> (!f.file)</span><br><span class="line">		<span class="keyword">return</span> -EBADF;</span><br><span class="line"></span><br><span class="line">	ret = -EOPNOTSUPP;</span><br><span class="line">	<span class="keyword">if</span> (f.file-&gt;f_op != &amp;io_uring_fops)</span><br><span class="line">		<span class="keyword">goto</span> out_fput;</span><br><span class="line"></span><br><span class="line">	ctx = f.file-&gt;private_data;</span><br><span class="line"></span><br><span class="line">	mutex_lock(&amp;ctx-&gt;uring_lock);</span><br><span class="line">	ret = __io_uring_register(ctx, opcode, arg, nr_args);</span><br><span class="line">	mutex_unlock(&amp;ctx-&gt;uring_lock);</span><br><span class="line">out_fput:</span><br><span class="line">	fdput(f);</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>TODO</p>
<h2 id="5-å†…æ ¸çº¿ç¨‹-io-sq-thread"><a href="#5-å†…æ ¸çº¿ç¨‹-io-sq-thread" class="headerlink" title="5. å†…æ ¸çº¿ç¨‹ io_sq_thread"></a>5. å†…æ ¸çº¿ç¨‹ <code>io_sq_thread</code></h2><p>TODO</p>
<h2 id="6-IOPOLL-æ¨¡å¼"><a href="#6-IOPOLL-æ¨¡å¼" class="headerlink" title="6. IOPOLL æ¨¡å¼"></a>6. <code>IOPOLL</code> æ¨¡å¼</h2><h3 id="6-1-å¯ç”¨"><a href="#6-1-å¯ç”¨" class="headerlink" title="6.1. å¯ç”¨"></a>6.1. å¯ç”¨</h3><p>å½“ <code>io_uring_setup</code> åˆå§‹åŒ–æ—¶ <code>flags</code> é…ç½®äº† <code>IORING_SETUP_IOPOLL</code> å­—æ®µåå°†å¼€å¯ <code>IOPOLL</code> æ¨¡å¼</p>
<h3 id="6-2-é™åˆ¶"><a href="#6-2-é™åˆ¶" class="headerlink" title="6.2. é™åˆ¶"></a>6.2. é™åˆ¶</h3><p>å¼€å¯æ­¤é€‰é¡¹å¿…é¡»ä¿è¯åç»­åªç”¨ <code>O_DIRECT</code> æ‰“å¼€æ–‡ä»¶å¹¶ä¸”æ–‡ä»¶ç³»ç»Ÿçš„ <code>file_operations</code> ä¸­æ³¨å†Œäº† <code>iopoll</code> å‡½æ•°ï¼Œå¦åˆ™ IO å°†ä¸‹å‘å¤±è´¥</p>
<h3 id="6-3-è°ƒç”¨æ ˆ"><a href="#6-3-è°ƒç”¨æ ˆ" class="headerlink" title="6.3. è°ƒç”¨æ ˆ"></a>6.3. è°ƒç”¨æ ˆ</h3><p>å¼€å¯åå†…æ ¸å°†è°ƒç”¨æ³¨å†Œçš„ <code>iopoll</code> å‡½æ•°æ¥ä¸»åŠ¨è½®è¯¢è®¾å¤‡é©±åŠ¨ç¡®è®¤ IO æ˜¯å¦å®Œæˆ</p>
<p>å¯¹ <code>f_op-&gt;iopoll</code> å‡½æ•°è°ƒç”¨å…³ç³»è¿›è¡Œäº†åˆ†æ</p>
<pre class="mermaid">graph TD
  io_uring_create --> io_ring_ctx_wait_and_kill
  io_uring_release --> io_ring_ctx_wait_and_kill
  io_ring_ctx_wait_and_kill --> io_iopoll_reap_events
  io_ring_ctx_wait_and_kill --> io_ring_ctx_free
  io_ring_ctx_free --> io_iopoll_reap_events
  io_iopoll_reap_events --> io_iopoll_getevents

  syscall["SYSCALL_DEFINE6(io_uring_enter, â€¦â€¦)"] --> io_iopoll_check --> io_iopoll_getevents

  io_sq_thread --> io_iopoll_getevents

  io_iopoll_getevents --> io_do_iopoll --> iopoll["f_op->iopoll"]</pre>

<p>ä¸»è¦æœ‰ä¸‰æ¡è°ƒç”¨è·¯çº¿ï¼ˆæ‰€æœ‰è°ƒç”¨é€»è¾‘éƒ½ä¼šåˆ¤æ–­æ˜¯å¦åœ¨åˆå§‹åŒ–æ—¶é…ç½®äº† <code>IORING_SETUP_IOPOLL</code>ï¼‰ï¼š</p>
<ol>
<li><code>io_uring</code> é”€æ¯æ—¶éœ€è¦è°ƒç”¨</li>
<li>ç³»ç»Ÿè°ƒç”¨ <code>io_uring_enter</code> å°†ä¼šè§¦å‘ï¼Œç”¨äºè½®è¯¢ IO å®Œæˆæƒ…å†µï¼Œç›´åˆ°åˆ°è¾¾æŒ‡å®šçš„ <code>wait_nr</code> æ•°é‡ IO å®Œæˆåæ‰ä¼šé€€å‡ºè½®è¯¢</li>
<li>å½“åˆå§‹åŒ–æ—¶åŒæ—¶é…ç½®äº† <code>IORING_SETUP_SQPOLL</code> æ—¶ï¼Œ<code>io_sq_thread</code> å†…æ ¸çº¿ç¨‹è§¦å‘ï¼Œå½“å­˜åœ¨æœªå®Œæˆçš„ IO æ—¶è°ƒç”¨ï¼Œç”¨äºæ›´æ–° IO å®Œæˆæƒ…å†µï¼ˆ <code>io_do_iopoll</code> çš„å‚æ•° <code>min = 0</code>ï¼Œå³æ¯æ¬¡è°ƒç”¨æ— è®ºæ˜¯å¦æœ‰æ–°å®Œæˆçš„ IO éƒ½ä¼šé€€å‡ºè½®è¯¢ï¼Œä¸ä¼šé˜»å¡çº¿ç¨‹ï¼‰</li>
</ol>
]]></content>
      <categories>
        <category>å­˜å‚¨</category>
        <category>IO</category>
      </categories>
      <tags>
        <tag>io_uring</tag>
        <tag>liburing</tag>
        <tag>å¼‚æ­¥ IO</tag>
        <tag>å†…æ ¸</tag>
        <tag>æ›´æ–°ä¸­</tag>
      </tags>
  </entry>
  <entry>
    <title>io_uring ç”¨æˆ·åº“æºç åˆ†æ</title>
    <url>/posts/d7259d1d.html</url>
    <content><![CDATA[<p>å½“å‰å†…å®¹åŸºäº <a href="https://github.com/axboe/liburing/releases/tag/liburing-2.1">liburing 2.1</a> ç‰ˆæœ¬</p>
<h2 id="æ•´ä½“æµç¨‹"><a href="#æ•´ä½“æµç¨‹" class="headerlink" title="æ•´ä½“æµç¨‹"></a>æ•´ä½“æµç¨‹</h2><p>ä¹‹å‰åœ¨ <a href="/posts/c142853f.html#%E4%BB%A3%E7%A0%81%E6%B5%81%E7%A8%8B">io_uring ç®€ä»‹å’Œä½¿ç”¨</a> æœ‰è¿‡æ€»ç»“ï¼Œä½¿ç”¨ io_uring çš„ä¸€èˆ¬æµç¨‹å¦‚ä¸‹ï¼š</p>
<span id="more"></span>
<ul>
<li>ä½¿ç”¨ <code>open</code>ã€<code>fstat</code> ç­‰å‡½æ•°æ¥æ‰“å¼€æ–‡ä»¶ä»¥åŠå…ƒæ•°æ®æŸ¥çœ‹ç­‰æ“ä½œ<ul>
<li>å› ä¸º io_uring æ›¿æ¢çš„æ˜¯è¯»å†™æ¥å£ï¼Œåç»­ io_uring æ“ä½œçš„å¯¹è±¡æ˜¯ <code>fd</code>ï¼ˆç”± <code>open</code> å‡½æ•°æ‰§è¡Œè¿”å›çš„ï¼‰</li>
</ul>
</li>
<li>ä½¿ç”¨ <code>io_uring_queue_init</code> åˆå§‹åŒ– <code>struct io_uring ring</code> ç»“æ„ä½“</li>
<li>åˆå§‹åŒ– <code>struct iovec *iovecs</code> ç»“æ„ä½“ç”¨äºå­˜æ”¾ç”¨æˆ·æ€ buffer æŒ‡é’ˆå’Œé•¿åº¦</li>
<li>é€šè¿‡ <code>io_uring_get_sqe</code> è·å– <code>sqe</code></li>
<li>é€šè¿‡ <code>io_uring_prep_#OP</code> å¯¹ <code>sqe</code> å¡«å……å‘½ä»¤ï¼Œbuffer ä»¥åŠ offset ä¿¡æ¯<ul>
<li>ã€å¯é€‰ã€‘ é€šè¿‡ <code>io_uring_sqe_set_data</code> å¯¹ <code>sqe</code> é™„åŠ  <code>user_data</code> ä¿¡æ¯ï¼ˆè¯¥ä¿¡æ¯ä¼šåœ¨ <code>cqe</code> ä¸­è¿›è¡Œè¿”å›ï¼‰</li>
</ul>
</li>
<li>é€šè¿‡ <code>io_uring_submit</code> å¯¹æ•´ä¸ª <code>ring</code> çš„æ‰€æœ‰ <code>sqe</code> è¿›è¡Œä¸‹å‘</li>
<li>é€šè¿‡ <code>io_uring_wait_cqe</code> æˆ–è€… <code>io_uring_peek_cqe</code> æ¥è·å– <code>cqe</code><ul>
<li><code>io_uring_wait_cqe</code> ä¼šé˜»å¡å½“å‰çº¿ç¨‹ç›´åˆ°æœ‰ä¸€ä¸ª <code>cqe</code> è¿”å›</li>
<li><code>io_uring_peek_cqe</code> ä¸ä¼šé˜»å¡ï¼Œå¦‚æœå½“å‰æ²¡æœ‰ <code>cqe</code>ï¼Œå°±ä¼šè¿”å›é”™è¯¯</li>
<li><code>io_uring_cqe_get_data</code> å¯ä»¥ä» <code>cqe</code> ä¸­è·å– <code>user_data</code></li>
</ul>
</li>
<li>é€šè¿‡ <code>io_uring_cqe_seen</code> å¯¹å½“å‰ <code>cqe</code> è¿›è¡Œæ¸…é™¤ï¼Œé¿å…è¢«äºŒæ¬¡å¤„ç†</li>
<li>æ‰€æœ‰ IO å®Œæˆåï¼Œé€šè¿‡ <code>io_uring_queue_exit</code> å°† <code>ring</code> é”€æ¯</li>
</ul>
<h2 id="io-uring-queue-init"><a href="#io-uring-queue-init" class="headerlink" title="io_uring_queue_init"></a><code>io_uring_queue_init</code></h2><ul>
<li><p>å‡½æ•°è°ƒç”¨é€»è¾‘</p>
<pre class="mermaid">  graph TD
    io_uring_queue_init --> io_uring_queue_init_params --> __sys_io_uring_setup --> syscall -->|é™·å…¥å†…æ ¸|io_uring_setup
    io_uring_queue_init_params --> io_uring_queue_mmap --> io_uring_mmap --> mmap</pre></li>
<li><p>å‡½æ•°åŠŸèƒ½</p>
<p>è¯¥å‡½æ•°ä¸»è¦å°†é˜Ÿåˆ—æ·±åº¦ä»¥åŠé¢å¤–çš„ <code>flags</code> å‚æ•°ä¼ é€’åˆ°å†…æ ¸ï¼Œè®©å†…æ ¸çš„ <code>io_uring_setup</code> æ¥åˆå§‹åŒ– <code>io_uring</code> ç»“æ„ä½“ï¼ŒåŒæ—¶ä½¿ç”¨ <code>mmap</code> å°†åœ¨å†…æ ¸ä¸­åˆå§‹åŒ–çš„ <code>SQ</code>ã€<code>CQ</code> ä»¥åŠ <code>SQEs</code> æ˜ å°„åˆ°ç”¨æˆ·æ€</p>
<p>åˆå§‹åŒ–æ—¶ä¼ é€’çš„ <code>flags</code> å°†å½±å“ <code>io_uring</code> çš„è¿è¡Œæ–¹å¼ï¼š</p>
<ul>
<li><code>IORING_SETUP_IOPOLL</code>ï¼šå¼€å¯æ­¤é€‰é¡¹å¿…é¡»ä¿è¯åç»­åªç”¨ <code>O_DIRECT</code> æ‰“å¼€æ–‡ä»¶å¹¶ä¸”æ–‡ä»¶ç³»ç»Ÿçš„ <code>file_operations</code> ä¸­æ³¨å†Œäº† <code>iopoll</code> å‡½æ•°ï¼Œå¦åˆ™ IO å°†ä¸‹å‘å¤±è´¥ã€‚å¼€å¯åå†…æ ¸å°†è°ƒç”¨æ³¨å†Œçš„ <code>iopoll</code> å‡½æ•°æ¥ä¸»åŠ¨è½®è¯¢è®¾å¤‡é©±åŠ¨ç¡®è®¤ IO æ˜¯å¦å®Œæˆ<!-- ï¼Œ`iopoll` çš„è§¦å‘æ—¶æœºå¯ä»¥å‚çœ‹ [io_uring å†…æ ¸æºç åˆ†æ](/io_uring/å†…æ ¸æºç åˆ†æ) --></li>
<li><code>IORING_SETUP_SQPOLL</code>ï¼šå°†å¯åŠ¨ä¸€ä¸ªå•ç‹¬çš„å†…æ ¸çº¿ç¨‹ <code>io_sq_thread</code>ï¼Œå†…æ ¸å°†ä¸»åŠ¨è½®è¯¢ SQï¼Œç„¶åå°† IO ä¸‹å‘è‡³é©±åŠ¨è®¾å¤‡ï¼Œèƒ½å¤§å¤§å‡å°‘æäº¤ IO æ—¶çš„ç³»ç»Ÿè°ƒç”¨å¼€é”€ï¼ˆå†…æ ¸çº¿ç¨‹å·¥ä½œæ—¶ï¼Œæäº¤ IO å°†æ— éœ€ç³»ç»Ÿè°ƒç”¨ï¼›ä½†æ˜¯è¯¥çº¿ç¨‹å¯èƒ½ä¼šä¼‘çœ ï¼Œä¼‘çœ æ—¶éœ€è¦ç³»ç»Ÿè°ƒç”¨æ¥å”¤é†’è¯¥çº¿ç¨‹ï¼‰</li>
<li><code>IORING_SETUP_SQ_AFF</code>ï¼šå½“ <code>IORING_SETUP_SQPOLL</code> å·²ç»é…ç½®åï¼Œå¯ç”¨ <code>sq_thread_cpu</code> å­—æ®µï¼Œç”¨äºé…ç½®å†…æ ¸çº¿ç¨‹ <code>io_sq_thread</code> çš„è·‘åœ¨å“ªä¸ª CPU ä¸Š</li>
</ul>
</li>
</ul>
<h2 id="io-uring-get-sqe"><a href="#io-uring-get-sqe" class="headerlink" title="io_uring_get_sqe"></a><code>io_uring_get_sqe</code></h2><p>ç”±äº SQ å·²ç»é€šè¿‡ <code>mmap</code> æ˜ å°„åˆ°ç”¨æˆ·æ€ï¼Œè¯¥å‡½æ•°åªéœ€åœ¨è¯»å– <code>sq-&gt;khead</code> æ—¶é€šè¿‡ <code>io_uring_smp_load_acquire</code> ä¿è¯ä¸€è‡´æ€§ï¼Œè€Œ <code>sq-&gt;sqe_tail</code> åªç”¨äºç”¨æˆ·æ€ï¼Œç›´æ¥è¯»å–å³å¯ï¼Œæ ¹æ® <code>sq-&gt;khead</code> ä»¥åŠ <code>sq-&gt;sqe_tail</code> åˆ¤æ–­ SQ æ˜¯å¦å·²æ»¡ï¼Œæœªæ»¡åˆ™ç»™å‡º <code>sq-&gt;sqe_tail</code> å¤„çš„ <code>sqe</code> å³å¯ï¼Œç„¶åæ›´æ–° <code>sq-&gt;sqe_tail</code></p>
<h2 id="io-uring-prep-OP"><a href="#io-uring-prep-OP" class="headerlink" title="io_uring_prep_#OP"></a><code>io_uring_prep_#OP</code></h2><p>é€šè¿‡è°ƒç”¨ <code>io_uring_prep_rw</code> å¯¹ <code>sqe</code> å¡«å……å‘½ä»¤ OPã€<code>fd</code>ã€buffer æŒ‡é’ˆä»¥åŠ offset ä¿¡æ¯ç­‰</p>
<h2 id="io-uring-sqe-set-data"><a href="#io-uring-sqe-set-data" class="headerlink" title="io_uring_sqe_set_data"></a><code>io_uring_sqe_set_data</code></h2><p>ç›´æ¥å¯¹ <code>sqe-&gt;user_data</code> è¿›è¡Œèµ‹å€¼</p>
<h2 id="io-uring-submit"><a href="#io-uring-submit" class="headerlink" title="io_uring_submit"></a><code>io_uring_submit</code></h2><ul>
<li><p>å‡½æ•°è°ƒç”¨é€»è¾‘</p>
  <pre class="mermaid">    graph TD
      io_uring_submit --> __io_uring_submit_and_wait --> __io_uring_flush_sq
      __io_uring_submit_and_wait --> __io_uring_submit --> sq_ring_needs_enter
      __io_uring_submit --> __sys_io_uring_enter --> __sys_io_uring_enter2 --> syscall -->|é™·å…¥å†…æ ¸|io_uring_enter</pre></li>
<li><p>å‡½æ•°åŠŸèƒ½</p>
<ul>
<li><p><code>__io_uring_flush_sq</code></p>
<p>æ ¹æ® <code>sq-&gt;sqe_tail</code>ã€<code>sq-&gt;sqe_head</code> å·®å€¼ä¾æ¬¡å¡«å…… <code>sq-&gt;array</code>ï¼Œç„¶åä¸€æ¬¡æ€§æ›´æ–° <code>sq-&gt;ktail</code>ï¼Œå¹¶è¿”å›å†…æ ¸ä¸­ä»æœªå¤„ç† <code>sqe</code> æ•°é‡ï¼ˆ<code>sq-&gt;ktail - sq-&gt;khead</code>ï¼‰</p>
</li>
<li><p><code>sq_ring_needs_enter</code></p>
<p>åˆ¤æ–­å†…æ ¸çº¿ç¨‹ <code>io_sq_thread</code> æ˜¯å¦å¯ç”¨ä»¥åŠæ­£å¸¸å·¥ä½œï¼ˆæ²¡æœ‰ä¼‘çœ ï¼‰:</p>
<ul>
<li>é¦–å…ˆè¦åˆ¤æ–­ç”¨æˆ·æ€ <code>ring-&gt;flags</code> æ˜¯å¦é…ç½®äº† <code>IORING_SETUP_SQPOLL</code> æ ‡å¿—ä½ï¼Œåˆ¤æ–­æ˜¯å¦å¯ç”¨äº†å†…æ ¸çº¿ç¨‹ <code>io_sq_thread</code></li>
<li>ç„¶åå†åˆ¤æ–­å†…æ ¸æ€ <code>ring-&gt;sq.kflags</code> æ˜¯å¦é…ç½®äº† <code>IORING_SQ_NEED_WAKEUP</code> æ ‡å¿—ä½ï¼Œåˆ¤æ–­å†…æ ¸çº¿ç¨‹ <code>io_sq_thread</code> æ˜¯å¦éœ€è¦å”¤é†’</li>
</ul>
<p>å½“å†…æ ¸çº¿ç¨‹ <code>io_sq_thread</code> å¯ç”¨å¹¶ä¸”æ­£å¸¸å·¥ä½œæ—¶ï¼Œåˆ™æ•´ä¸ª <code>io_uring_submit</code> åˆ°æ­¤ç»“æŸï¼Œæ— éœ€åç»­çš„ <code>__sys_io_uring_enter</code> ç³»ç»Ÿè°ƒç”¨ï¼Œå‡å°‘äº† IO ä¸‹å‘çš„ç³»ç»Ÿè°ƒç”¨çš„å¼€é”€</p>
</li>
<li><p><code>__sys_io_uring_enter</code></p>
<p>ç³»ç»Ÿè°ƒç”¨é™·å…¥å†…æ ¸æ€ï¼Œå°†å‚æ•°ä¼ é€’ç»™å†…æ ¸çš„ <code>io_uring_setup</code> å‡½æ•°ï¼Œä¸»è¦ç”¨äºæäº¤ IO å’Œè·å– IO å®Œæˆæƒ…å†µï¼Œå…·ä½“åŠŸèƒ½å’Œåˆå§‹åŒ–æ—¶é…ç½®çš„ <code>ring-&gt;flags</code> ç›¸å…³<!-- ï¼Œè¯¦ç»†åˆ†æå¯ä»¥å‚çœ‹ [io_uring å†…æ ¸æºç åˆ†æ](/io_uring/å†…æ ¸æºç åˆ†æ) --></p>
</li>
</ul>
</li>
</ul>
<h2 id="io-uring-wait-cqe"><a href="#io-uring-wait-cqe" class="headerlink" title="io_uring_wait_cqe"></a><code>io_uring_wait_cqe</code></h2><p>åœ¨ç”¨æˆ·æ€è½®è¯¢åˆ¤æ–­æ˜¯å¦æœ‰ä¸€ä¸ªæ–°çš„ <code>cqe</code>ï¼Œæ— éœ€ç³»ç»Ÿè°ƒç”¨é™·å…¥å†…æ ¸ï¼Œä½†æ˜¯ä¼šé˜»å¡å½“å‰çº¿ç¨‹ç›´åˆ°æœ‰ä¸€ä¸ªæ–°çš„ <code>cqe</code> æˆ–è€…å‡ºé”™</p>
<h2 id="io-uring-peek-cqe"><a href="#io-uring-peek-cqe" class="headerlink" title="io_uring_peek_cqe"></a><code>io_uring_peek_cqe</code></h2><p>ä»…åœ¨ç”¨æˆ·æ€åˆ¤æ–­ä¸€æ¬¡æ˜¯å¦æœ‰æ–°çš„ <code>cqe</code>ï¼Œæ— éœ€ç³»ç»Ÿè°ƒç”¨é™·å…¥å†…æ ¸ï¼Œå¦‚æœæ²¡æœ‰æ–°çš„ <code>cqe</code>ï¼Œä¼šè¿”å›å¤±è´¥ä¿¡æ¯ <code>-errno</code></p>
<h2 id="io-uring-cqe-get-data"><a href="#io-uring-cqe-get-data" class="headerlink" title="io_uring_cqe_get_data"></a><code>io_uring_cqe_get_data</code></h2><p><code>cqe-&gt;user_data</code> ä¼šåœ¨ IO å®Œæˆåï¼Œä» <code>sqe</code> å¤åˆ¶åˆ°å¯¹åº”çš„ <code>cqe</code> ä¸­ï¼Œè¯¥å‡½æ•°åªç”¨ç›´æ¥å¯¹ <code>cqe-&gt;user_data</code> è¿›è¡Œè¯»å–</p>
<h2 id="io-uring-cqe-seen"><a href="#io-uring-cqe-seen" class="headerlink" title="io_uring_cqe_seen"></a><code>io_uring_cqe_seen</code></h2><p>æ›´æ–° <code>cq-&gt;khead</code>ï¼Œé¿å…å½“å‰ <code>cqe</code> è¢«é‡å¤è·å–</p>
<h2 id="io-uring-queue-exit"><a href="#io-uring-queue-exit" class="headerlink" title="io_uring_queue_exit"></a><code>io_uring_queue_exit</code></h2><p>é¦–å…ˆé€šè¿‡ <code>munmap</code> å°†åˆå§‹åŒ–æ—¶ <code>mmap</code> çš„ <code>SQ</code>ã€<code>CQ</code> ä»¥åŠ <code>SQEs</code> è§£é™¤æ˜ å°„ï¼Œç„¶åé€šè¿‡ <code>close</code> å…³é—­ <code>io_uring</code> å¯¹åº”çš„ <code>fd</code>ï¼Œ<code>close</code> ä¼šè°ƒç”¨åˆ°è¯¥ <code>fd</code> æ³¨å†Œçš„ <code>io_uring_release</code> æ¥é‡Šæ”¾ <code>io_uring</code></p>
<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul>
<li><a href="https://lore.kernel.org/linux-block/20190517214131.5925-1-axboe@kernel.dk/">ã€Kernelã€‘io_uring IOSQE_IO_LINK</a></li>
<li><a href="https://www.skyzh.dev/posts/articles/2021-06-14-deep-dive-io-uring/">ã€ä¸ªäººåšå®¢ã€‘io_uring çš„æ¥å£ä¸å®ç°</a></li>
</ul>
]]></content>
      <categories>
        <category>å­˜å‚¨</category>
        <category>IO</category>
      </categories>
      <tags>
        <tag>io_uring</tag>
        <tag>liburing</tag>
        <tag>å¼‚æ­¥ IO</tag>
      </tags>
  </entry>
  <entry>
    <title>LaTeX PPT</title>
    <url>/posts/499c5a19.html</url>
    <content><![CDATA[<h2 id="Beamer-æ¨¡æ¿"><a href="#Beamer-æ¨¡æ¿" class="headerlink" title="Beamer æ¨¡æ¿"></a>Beamer æ¨¡æ¿</h2><p>PPT æ¨èç”¨ Beamer æ¨¡æ¿æ¥åšï¼Œå¯ä»¥å‚è€ƒ <a href="https://www.overleaf.com/learn/latex/Beamer">Overleaf ä¸Šç›¸å…³ä»‹ç»</a> æ¥ä½¿ç”¨</p>
<span id="more"></span>
<p><img data-src="/posts/499c5a19/Beamer-overview.png" alt="Beamer"></p>
<!-- TODO: Beamer ä»‹ç»å’Œé¢å¤–çš„ç‰¹æ€§ -->

<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul>
<li><a href="https://www.overleaf.com/learn/latex/Beamer">ã€Overleafã€‘Beamer</a></li>
</ul>
]]></content>
      <categories>
        <category>LaTeX</category>
      </categories>
      <tags>
        <tag>æ›´æ–°ä¸­</tag>
        <tag>LaTeX</tag>
        <tag>Beamer</tag>
      </tags>
  </entry>
  <entry>
    <title>io_uring ç®€ä»‹å’Œä½¿ç”¨</title>
    <url>/posts/c142853f.html</url>
    <content><![CDATA[<h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>io_uring æ˜¯ Linux åœ¨ 5.1 ç‰ˆæœ¬å¼•å…¥çš„ä¸€å¥—æ–°çš„å¼‚æ­¥ IO å®ç°ã€‚ç›¸æ¯” Linux åœ¨ 2.6 ç‰ˆæœ¬å¼•å…¥çš„ AIOï¼Œio_uring æ€§èƒ½å¼ºå¾ˆå¤šï¼Œæ¥è¿‘ SPDK<a href="https://lore.kernel.org/linux-block/20190116175003.17880-1-axboe@kernel.dk/">[1]</a>ï¼ŒåŒæ—¶æ”¯æŒ buffer IO</p>
<span id="more"></span>
<p>io_uring çš„ä½œè€… <a href="https://en.wikipedia.org/wiki/Jens_Axboe">Jens Axboe</a> æ˜¯ Linux å†…æ ¸å—å±‚å’Œå…¶ä»–å—è®¾å¤‡çš„ç»´æŠ¤è€…ï¼ŒåŒæ—¶ä¹Ÿæ˜¯ CFQã€Noopã€Deadline è°ƒåº¦å™¨ã€blktrace ä»¥åŠ FIO çš„ä½œè€…ï¼Œå¯¹å†…æ ¸å—å±‚éå¸¸ç†Ÿæ‚‰</p>
<h2 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h2><h3 id="ç³»ç»Ÿè°ƒç”¨"><a href="#ç³»ç»Ÿè°ƒç”¨" class="headerlink" title="ç³»ç»Ÿè°ƒç”¨"></a>ç³»ç»Ÿè°ƒç”¨</h3><p>io_uring åªå¢åŠ äº†ä¸‰ä¸ª Linux ç³»ç»Ÿè°ƒç”¨åˆ†åˆ«æ˜¯ <code>io_uring_setup</code>ï¼Œ<code>io_uring_enter</code> å’Œ <code>io_uring_register</code></p>
<p>ä»–ä»¬çš„å…¥å£éƒ½åœ¨ Linux å†…æ ¸æºç çš„ <code>fs/io_uring.c</code> æ–‡ä»¶ä¸­</p>
<p>ç”¨æˆ·ç¨‹åºå¯ä»¥ç›´æ¥ä½¿ç”¨ <code>syscall(__NR_xxx, â€¦â€¦)</code> çš„æ–¹å¼ç›´æ¥è°ƒç”¨ï¼Œä½¿ç”¨èµ·æ¥å¾ˆéº»çƒ¦</p>
<h3 id="liburing"><a href="#liburing" class="headerlink" title="liburing"></a>liburing</h3><p>ç”±äºç›´æ¥ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨è¾ƒä¸ºå¤æ‚ï¼ŒJens Axboe è¿˜æä¾›äº†å°è£…å¥½çš„ç”¨æˆ·æ€åº“ liburingï¼Œç®€åŒ–äº† io_uring çš„ä½¿ç”¨ï¼Œä»£ç ä½ç½®åœ¨ <a href="https://github.com/axboe/liburing">github</a> ä¸Š</p>
<h4 id="æ ·ä¾‹"><a href="#æ ·ä¾‹" class="headerlink" title="æ ·ä¾‹"></a>æ ·ä¾‹</h4><p>liburing ä»“åº“çš„ <code>examples/</code> ç›®å½•ä¸‹æä¾›äº†å‡ ä¸ªç®€å•çš„æ ·ä¾‹ç¨‹åºï¼š</p>
<table>
<thead>
<tr>
<th>æ–‡ä»¶</th>
<th>åŠŸèƒ½</th>
<th>å…¶ä»–</th>
</tr>
</thead>
<tbody><tr>
<td><code>io_uring-test.c</code></td>
<td>è¯»å–ä¸€ä¸ªæ–‡ä»¶çš„å…¨éƒ¨å†…å®¹</td>
<td>-</td>
</tr>
<tr>
<td><code>io_uring-cp.c</code></td>
<td>å¤åˆ¶ä¸€ä¸ªæ–‡ä»¶çš„å†…å®¹åˆ°å¦ä¸€ä¸ªæ–‡ä»¶</td>
<td>ä½¿ç”¨ <code>user_data</code> æ‰‹åŠ¨å¤„ç†è¯»å†™ IO ä¹‹é—´çš„ä¾èµ–ï¼Œè¯» IO è¿”å›ä¹‹åæ‰ä¸‹å‘å†™ IO</td>
</tr>
<tr>
<td><code>link-cp.c</code></td>
<td>å¤åˆ¶ä¸€ä¸ªæ–‡ä»¶çš„å†…å®¹åˆ°å¦ä¸€ä¸ªæ–‡ä»¶</td>
<td>åŒæ—¶ä¸‹å‘è¯»å†™ï¼Œä½¿ç”¨ <code>IOSQE_IO_LINK</code> ä¿è¯è¯»å†™ä¹‹é—´çš„ä¾èµ–<a href="https://lore.kernel.org/linux-block/20190517214131.5925-1-axboe@kernel.dk/">[2]</a></td>
</tr>
<tr>
<td><code>ucontext-cp.c</code></td>
<td>å¤åˆ¶ n ä¸ªæ–‡ä»¶çš„å†…å®¹åˆ°å¦ n ä¸ªæ–‡ä»¶</td>
<td>ä½¿ç”¨ <code>ucontext</code> è¿›è¡Œä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œæ¨¡æ‹Ÿ <a href="https://blog.csdn.net/qq910894904/article/details/41911175">åç¨‹</a></td>
</tr>
</tbody></table>
<h4 id="ä»£ç æµç¨‹"><a href="#ä»£ç æµç¨‹" class="headerlink" title="ä»£ç æµç¨‹"></a>ä»£ç æµç¨‹</h4><p>ä»”ç»†é˜…è¯»å‰ä¸‰ä¸ªç”¨ä¾‹ï¼Œå¯ä»¥çœ‹å‡ºä½¿ç”¨ io_uring çš„ä¸€èˆ¬æµç¨‹å¦‚ä¸‹ï¼š</p>
<ul>
<li>ä½¿ç”¨ <code>open</code>ã€<code>fstat</code> ç­‰å‡½æ•°æ¥æ‰“å¼€æ–‡ä»¶ä»¥åŠå…ƒæ•°æ®æŸ¥çœ‹ç­‰æ“ä½œ<ul>
<li>å› ä¸º io_uring æ›¿æ¢çš„æ˜¯è¯»å†™æ¥å£ï¼Œåç»­ io_uring æ“ä½œçš„å¯¹è±¡æ˜¯ <code>fd</code>ï¼ˆç”± <code>open</code> å‡½æ•°æ‰§è¡Œè¿”å›çš„ï¼‰</li>
</ul>
</li>
<li>ä½¿ç”¨ <code>io_uring_queue_init</code> åˆå§‹åŒ– <code>struct io_uring ring</code> ç»“æ„ä½“</li>
<li>åˆå§‹åŒ– <code>struct iovec *iovecs</code> ç»“æ„ä½“ç”¨äºå­˜æ”¾ç”¨æˆ·æ€ buffer æŒ‡é’ˆå’Œé•¿åº¦</li>
<li>é€šè¿‡ <code>io_uring_get_sqe</code> è·å– <code>sqe</code></li>
<li>é€šè¿‡ <code>io_uring_prep_#OP</code> å¯¹ <code>sqe</code> å¡«å……å‘½ä»¤ï¼Œbuffer ä»¥åŠ offset ä¿¡æ¯<ul>
<li>ã€å¯é€‰ã€‘ é€šè¿‡ <code>io_uring_sqe_set_data</code> å¯¹ <code>sqe</code> é™„åŠ  <code>user_data</code> ä¿¡æ¯ï¼ˆè¯¥ä¿¡æ¯ä¼šåœ¨ <code>cqe</code> ä¸­è¿›è¡Œè¿”å›ï¼‰</li>
</ul>
</li>
<li>é€šè¿‡ <code>io_uring_submit</code> å¯¹æ•´ä¸ª <code>ring</code> çš„æ‰€æœ‰ <code>sqe</code> è¿›è¡Œä¸‹å‘</li>
<li>é€šè¿‡ <code>io_uring_wait_cqe</code> æˆ–è€… <code>io_uring_peek_cqe</code> æ¥è·å– <code>cqe</code><ul>
<li><code>io_uring_wait_cqe</code> ä¼šé˜»å¡å½“å‰çº¿ç¨‹ç›´åˆ°æœ‰ä¸€ä¸ª <code>cqe</code> è¿”å›</li>
<li><code>io_uring_peek_cqe</code> ä¸ä¼šé˜»å¡ï¼Œå¦‚æœå½“å‰æ²¡æœ‰ <code>cqe</code>ï¼Œå°±ä¼šè¿”å›é”™è¯¯</li>
<li><code>io_uring_cqe_get_data</code> å¯ä»¥ä» <code>cqe</code> ä¸­è·å– <code>user_data</code></li>
</ul>
</li>
<li>é€šè¿‡ <code>io_uring_cqe_seen</code> å¯¹å½“å‰ <code>cqe</code> è¿›è¡Œæ¸…é™¤ï¼Œé¿å…è¢«äºŒæ¬¡å¤„ç†</li>
<li>æ‰€æœ‰ IO å®Œæˆåï¼Œé€šè¿‡ <code>io_uring_queue_exit</code> å°† <code>ring</code> é”€æ¯</li>
</ul>
<h2 id="ç¼–è¯‘"><a href="#ç¼–è¯‘" class="headerlink" title="ç¼–è¯‘"></a>ç¼–è¯‘</h2><p>æ ¹æ®å®˜æ–¹ <code>Makefile</code> å¯ä»¥çœ‹å‡ºç¼–è¯‘æ—¶æœ‰é¢å¤–çš„ä¸‰ä¸ªæ¡ä»¶</p>
<ul>
<li>å®šä¹‰ <code>_GNU_SOURCE</code> å®ï¼Œ<code>-D</code> å®å®šä¹‰</li>
<li>æŒ‡å®šé¢å¤–çš„å¤´æ–‡ä»¶ç›®å½•ï¼Œ<code>-I</code> æŒ‡å®šå¤´æ–‡ä»¶ç›®å½•ä½ç½®</li>
<li>ä½¿ç”¨ <code>liburing</code> åº“ï¼Œ<code>-L</code> æŒ‡å®šåº“ä½ç½®ï¼Œ<code>-l</code> æŒ‡å®šåº“å</li>
</ul>
<p>å³ <code>gcc -D_GNU_SOURCE -I../src/include/ -L../src/ -o test test.c -luring</code></p>
<p>å…¶ä¸­å¤´æ–‡ä»¶ç›®å½•ä¸‹ä¸»è¦æœ‰ä¸‰ä¸ªå¤´æ–‡ä»¶ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ tree src/include/</span><br><span class="line">src/include/</span><br><span class="line">â”œâ”€â”€ liburing</span><br><span class="line">â”‚   â”œâ”€â”€ barrier.h</span><br><span class="line">â”‚   â””â”€â”€ io_uring.h</span><br><span class="line">â””â”€â”€ liburing.h</span><br><span class="line"></span><br><span class="line">1 directory, 3 files</span><br></pre></td></tr></table></figure>

<p>è€Œ <code>liburing</code> åº“ä¹Ÿéœ€è¦ç¼–è¯‘ç”Ÿæˆï¼Œæ¨èç›´æ¥åœ¨ <code>liburing</code> çš„é¡¶å±‚ç›®å½•ç›´æ¥ <code>make all</code></p>
<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul>
<li><a href="/posts/c142853f/io_uring.pdf">ã€PDFã€‘å®˜æ–¹ pdf</a></li>
<li><a href="https://lore.kernel.org/linux-block/20190116175003.17880-1-axboe@kernel.dk/">ã€Kernelã€‘io_uring æ€§èƒ½æµ‹è¯•</a></li>
<li><a href="https://en.wikipedia.org/wiki/Jens_Axboe">ã€ç»´åŸºç™¾ç§‘ã€‘Jens Axboe</a></li>
<li><a href="https://lore.kernel.org/linux-block/20190517214131.5925-1-axboe@kernel.dk/">ã€Kernelã€‘io_uring IOSQE_IO_LINK</a></li>
</ul>
]]></content>
      <categories>
        <category>å­˜å‚¨</category>
        <category>IO</category>
      </categories>
      <tags>
        <tag>io_uring</tag>
        <tag>liburing</tag>
        <tag>å¼‚æ­¥ IO</tag>
      </tags>
  </entry>
  <entry>
    <title>LaTeX åŸºç¡€ä»‹ç»</title>
    <url>/posts/a4752f87.html</url>
    <content><![CDATA[<h2 id="TeX-å’Œ-LaTeX"><a href="#TeX-å’Œ-LaTeX" class="headerlink" title="TeX å’Œ LaTeX"></a>TeX å’Œ LaTeX</h2><p>Tex æ˜¯ä¸€ä¸ªæ’ç‰ˆè½¯ä»¶ï¼Œè€Œ LaTeX æ˜¯åŸºäº TeX å¼€å‘çš„æ’ç‰ˆç³»ç»Ÿï¼Œå¯ä»¥ç†è§£æˆ LaTeX é€šè¿‡å¯¹ TeX è¿›è¡Œå°è£…ï¼Œä½¿ç”¨ TeX ä½œä¸ºå®ƒçš„æ ¼å¼åŒ–å¼•æ“ï¼Œä½¿å¾—æ’ç‰ˆæ–‡å­—å˜å¾—æ›´åŠ æ–¹ä¾¿ã€‚</p>
<p>LaTeX åˆ©ç”¨ TeX å¯¹ <code>.tex</code> åç¼€çš„æ–‡ä»¶è¿›è¡Œç¼–è¯‘ï¼Œç”Ÿæˆ <code>.dvi</code> æ–‡ä»¶</p>
<span id="more"></span>
<h2 id="pdfTeXã€XeTeX-å’Œ-LuaTeX"><a href="#pdfTeXã€XeTeX-å’Œ-LuaTeX" class="headerlink" title="pdfTeXã€XeTeX å’Œ LuaTeX"></a>pdfTeXã€XeTeX å’Œ LuaTeX</h2><h3 id="ä¸‰è€…çš„ä»‹ç»"><a href="#ä¸‰è€…çš„ä»‹ç»" class="headerlink" title="ä¸‰è€…çš„ä»‹ç»"></a>ä¸‰è€…çš„ä»‹ç»</h3><p>pdfTeXã€XeTeX å’Œ LuaTeX éƒ½æ˜¯åœ¨åŸæœ‰çš„ TeX åœæ­¢æ›´æ–°åè¿›è¡Œä¿®æ”¹å¢å¼ºçš„ TeX å¼•æ“ï¼Œæä¾›ä¸€äº›é¢å¤–çš„é™„åŠ åŠŸèƒ½ï¼Œä¾‹å¦‚å¯ä»¥ç›´æ¥è¾“å‡ºæˆ pdf æ–‡ä»¶ç­‰ã€‚</p>
<ul>
<li>pdfLaTeX è¡¨ç¤ºå°† LaTeX å®åŒ…ä¸ pdfTeX å¼•æ“ä¸€èµ·ä½¿ç”¨</li>
<li>XeLaTeX è¡¨ç¤ºå°† LaTeX å®åŒ…ä¸ XeTeX å¼•æ“ä¸€èµ·ä½¿ç”¨</li>
<li>LuaLaTeX è¡¨ç¤ºå°† LaTeX å®åŒ…ä¸ LuaTeX å¼•æ“ä¸€èµ·ä½¿ç”¨</li>
</ul>
<h3 id="å„è‡ªçš„ç‰¹æ€§"><a href="#å„è‡ªçš„ç‰¹æ€§" class="headerlink" title="å„è‡ªçš„ç‰¹æ€§"></a>å„è‡ªçš„ç‰¹æ€§</h3><ul>
<li>pdfTeX çš„ä¸»è¦ç‰¹æ€§æ˜¯èƒ½ç›´æ¥ç”Ÿæˆ pdf</li>
<li>XeLaTeX çš„ä¸»è¦ç‰¹æ€§æ˜¯æ”¯æŒ UTF-8 ç¼–ç ï¼Œå› æ­¤ç†è®ºä¸ŠåŸç”Ÿæ”¯æŒä¸­æ–‡å­—ç¬¦</li>
<li>LuaLaTeX çš„ä¸»è¦ç‰¹æ€§é™¤äº†æ”¯æŒ UTF-8 ç¼–å¤–ä¹‹å¤–ï¼Œä¸»è¦æ˜¯å¢åŠ äº† Lua è„šæœ¬</li>
</ul>
<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul>
<li><a href="https://www.overleaf.com/learn/latex/Articles/What%27s_in_a_Name%3A_A_Guide_to_the_Many_Flavours_of_TeX#And_finally:_from_TeX_to_pdfTeX.2C_XeTeX_and_LuaTeX">ã€Overleafã€‘pdfTeX, XeTeX and LuaTeX</a></li>
</ul>
]]></content>
      <categories>
        <category>LaTeX</category>
      </categories>
      <tags>
        <tag>LaTeX</tag>
      </tags>
  </entry>
  <entry>
    <title>LaTeX ç¯å¢ƒé…ç½®</title>
    <url>/posts/4f94956.html</url>
    <content><![CDATA[<h2 id="ç½‘é¡µç¯å¢ƒ"><a href="#ç½‘é¡µç¯å¢ƒ" class="headerlink" title="ç½‘é¡µç¯å¢ƒ"></a>ç½‘é¡µç¯å¢ƒ</h2><h3 id="Overleaf"><a href="#Overleaf" class="headerlink" title="Overleaf"></a>Overleaf</h3><p><a href="https://www.overleaf.com/">Overleaf</a> æ˜¯ä¸€ä¸ªåœ¨çº¿çš„ LaTeX ç¼–è¾‘ç¯å¢ƒï¼Œå¯ä»¥é¿å…åœ¨æœ¬åœ°å®‰è£…å’Œé…ç½®çš„è¿‡ç¨‹ï¼ŒåŒæ—¶è¿˜èƒ½å’Œä»–äººå…±äº«ç¼–è¾‘</p>
<span id="more"></span>
<h2 id="æœ¬åœ°ç¯å¢ƒ"><a href="#æœ¬åœ°ç¯å¢ƒ" class="headerlink" title="æœ¬åœ°ç¯å¢ƒ"></a>æœ¬åœ°ç¯å¢ƒ</h2><h3 id="TeX-Live"><a href="#TeX-Live" class="headerlink" title="TeX Live"></a>TeX Live</h3><p>TeX Live å¯ä»¥åˆ©ç”¨é•œåƒå®‰è£…èŠ‚çœä¸‹è½½æ—¶é—´</p>
<ul>
<li>ä» <a href="https://mirrors.tuna.tsinghua.edu.cn/CTAN/systems/texlive/Images/">æ¸…åé•œåƒç«™</a> ç›´æ¥ä¸‹è½½</li>
<li>æˆ–è€…åˆ©ç”¨ <a href="http://www.tug.org/texlive/acquire-iso.html#torrent">ç§å­æ–‡ä»¶</a> BT ä¸‹è½½é•œåƒ</li>
</ul>
<p>å¯ä»¥åœ¨å®‰è£… TeX Live æ—¶åŒæ—¶å‹¾é€‰ä¸Šå®‰è£… TeXworks å‰ç«¯ï¼Œç„¶åå°±å¯ä»¥ä½¿ç”¨ TeXworks ä½œä¸º IDE æ¥ä½¿ç”¨äº†</p>
<h3 id="TeXstudio"><a href="#TeXstudio" class="headerlink" title="TeXstudio"></a>TeXstudio</h3><p>TeXstudio ä¹Ÿæ˜¯ä¸€ä¸ªå¾ˆå¥½çš„ LaTeX ç¼–è¾‘è½¯ä»¶ï¼Œå¯ä»¥ç›´æ¥å» <a href="https://www.texstudio.org/">å®˜ç½‘</a> ä¸‹è½½å®‰è£…ï¼Œå¹¶ä¸”æœ‰ä¸­æ–‡ç•Œé¢</p>
<h3 id="VSCode"><a href="#VSCode" class="headerlink" title="VSCode"></a>VSCode</h3><p>ä¸ªäººæ›´å–œæ¬¢ VSCodeï¼Œé€šè¿‡å®‰è£…æ‰©å±•å¹¶è¿›è¡Œç›¸åº”çš„é…ç½®å³å¯è¾ƒå¥½çš„æ”¯æŒ LaTeXï¼ŒåŒæ—¶è¿˜æœ‰æ ¼å¼åŒ–å’Œè‡ªåŠ¨è¡¥å…¨ç­‰åŠŸèƒ½ï¼Œéå¸¸æ–¹ä¾¿</p>
<h4 id="å®‰è£…-LaTeX-Workshop-æ‰©å±•"><a href="#å®‰è£…-LaTeX-Workshop-æ‰©å±•" class="headerlink" title="å®‰è£… LaTeX Workshop æ‰©å±•"></a>å®‰è£… LaTeX Workshop æ‰©å±•</h4><p>ç›´æ¥åœ¨ <a href="https://marketplace.visualstudio.com/items?itemName=James-Yu.latex-workshop">VSCode çš„æ‰©å±•å•†åº—</a> ä¸­æœç´¢ <code>LaTeX Workshop</code> å®‰è£…å³å¯</p>
<h4 id="ç¼–è¯‘é“¾é…ç½®"><a href="#ç¼–è¯‘é“¾é…ç½®" class="headerlink" title="ç¼–è¯‘é“¾é…ç½®"></a>ç¼–è¯‘é“¾é…ç½®</h4><ol>
<li><p>é»˜è®¤é…ç½®</p>
<p> TeX Live å®‰è£…æ—¶ä¼šåŒæ—¶å®‰è£… <code>latexmk</code>, LaTeX Workshop ä¼šé»˜è®¤ä½¿ç”¨ <code>latexmk</code> æ¥ç¼–è¯‘ <code>.tex</code>ï¼Œæ— éœ€æ‰‹åŠ¨å†é…ç½®</p>
</li>
<li><p>æ‰‹åŠ¨é…ç½®(å¯é€‰)</p>
<p> æ‰‹åŠ¨é…ç½® LaTeX Workshopï¼Œåœ¨ VSCode çš„é…ç½®æ–‡ä»¶ <code>settings.json</code> ä¸­ç›´æ¥æ‰‹åŠ¨æ·»åŠ å¦‚ä¸‹ä»£ç :</p>
<p> ä¸»è¦å‚è€ƒæ’ä»¶çš„ <a href="https://github.com/James-Yu/LaTeX-Workshop/wiki/Compile#latex-recipes">å®˜æ–¹ recipes é…ç½®</a> ä¿®æ”¹</p>
 <figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="comment">// é…ç½®ç¼–è¯‘é“¾ï¼Œå¯ä»¥æ ¹æ®éœ€è¦åšä¿®æ”¹</span></span><br><span class="line"><span class="string">&quot;latex-workshop.latex.recipes&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;xelatex ğŸ”ƒ&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;tools&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;xelatex&quot;</span></span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;pdflatex ğŸ”ƒ&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;tools&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;pdflatex&quot;</span></span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;latexmk ğŸ”ƒ&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;tools&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;latexmk&quot;</span></span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;xelatex â bibtex â xelatex`Ã—2&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;tools&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;xelatex&quot;</span>,</span><br><span class="line">            <span class="string">&quot;bibtex&quot;</span>,</span><br><span class="line">            <span class="string">&quot;xelatex&quot;</span>,</span><br><span class="line">            <span class="string">&quot;xelatex&quot;</span></span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;pdflatex â bibtex â pdflatex`Ã—2&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;tools&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;pdflatex&quot;</span>,</span><br><span class="line">            <span class="string">&quot;bibtex&quot;</span>,</span><br><span class="line">            <span class="string">&quot;pdflatex&quot;</span>,</span><br><span class="line">            <span class="string">&quot;pdflatex&quot;</span></span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">],</span><br><span class="line"><span class="comment">// å…·ä½“çš„ç¼–è¯‘å‘½ä»¤é…ç½®</span></span><br><span class="line"><span class="string">&quot;latex-workshop.latex.tools&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;latexmk&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;command&quot;</span>: <span class="string">&quot;latexmk&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;args&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;-synctex=1&quot;</span>,</span><br><span class="line">            <span class="string">&quot;-interaction=nonstopmode&quot;</span>,</span><br><span class="line">            <span class="string">&quot;-file-line-error&quot;</span>,</span><br><span class="line">            <span class="string">&quot;-pdf&quot;</span>,</span><br><span class="line">            <span class="string">&quot;-outdir=%OUTDIR%&quot;</span>,</span><br><span class="line">            <span class="string">&quot;%DOC%&quot;</span></span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;xelatex&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;command&quot;</span>: <span class="string">&quot;xelatex&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;args&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;-synctex=1&quot;</span>,</span><br><span class="line">            <span class="string">&quot;-interaction=nonstopmode&quot;</span>,</span><br><span class="line">            <span class="string">&quot;-file-line-error&quot;</span>,</span><br><span class="line">            <span class="string">&quot;%DOC%&quot;</span></span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;pdflatex&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;command&quot;</span>: <span class="string">&quot;pdflatex&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;args&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;-synctex=1&quot;</span>,</span><br><span class="line">            <span class="string">&quot;-interaction=nonstopmode&quot;</span>,</span><br><span class="line">            <span class="string">&quot;-file-line-error&quot;</span>,</span><br><span class="line">            <span class="string">&quot;%DOC%&quot;</span></span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;bibtex&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;command&quot;</span>: <span class="string">&quot;bibtex&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;args&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;%DOCFILE%&quot;</span></span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">],</span><br></pre></td></tr></table></figure>

 <!-- TODO: å¼„æ¸…ç¼–è¯‘å‘½ä»¤å’Œç¼–è¯‘é“¾å½“å‰é…ç½®çš„å…·ä½“å«ä¹‰ï¼Œä¸»è¦æ˜¯ bibtex --></li>
</ol>
<h4 id="æ­£å‘åŒæ­¥"><a href="#æ­£å‘åŒæ­¥" class="headerlink" title="æ­£å‘åŒæ­¥"></a>æ­£å‘åŒæ­¥</h4><p>æ­£å‘åŒæ­¥æŒ‡çš„æ˜¯ç¼–è¯‘å®Œæˆåï¼Œåœ¨ <code>.tex</code> æ–‡ä»¶å†…é€šè¿‡å¿«æ·é”®ï¼Œå¿«é€Ÿå®šä½åˆ°å…‰æ ‡ä½ç½®åœ¨ <code>.tex</code> çš„å¯¹åº”ä½ç½®ï¼Œæ–¹ä¾¿æŸ¥çœ‹ PDF æ–‡ä»¶</p>
<p>æ¨èæ‰“å¼€æ–‡ä»¶ä¿®æ”¹åï¼Œç¼–è¯‘å®Œæˆåè‡ªåŠ¨æ­£å‘åŒæ­¥ã€‚è¯¥åŠŸèƒ½é€šè¿‡ <code>latex-workshop.synctex.afterBuild.enabled</code> æ¥æ§åˆ¶</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;latex-workshop.synctex.afterBuild.enabled&quot;</span>: <span class="literal">true</span>,</span><br></pre></td></tr></table></figure>

<h4 id="åå‘åŒæ­¥"><a href="#åå‘åŒæ­¥" class="headerlink" title="åå‘åŒæ­¥"></a>åå‘åŒæ­¥</h4><p>åå‘åŒæ­¥æŒ‡çš„æ˜¯ç¼–è¯‘å®Œæˆåï¼Œåœ¨ PDF æ–‡ä»¶å†…é€šè¿‡å¿«æ·é”®ï¼Œå¿«é€Ÿå®šä½ç‚¹å‡»éƒ¨åˆ†åœ¨ <code>.tex</code> çš„ä½ç½®ï¼Œæ–¹ä¾¿ä¿®æ”¹ <code>.tex</code> æºç </p>
<p>ä¸»è¦å‚è€ƒæ’ä»¶çš„ <a href="https://github.com/James-Yu/LaTeX-Workshop/wiki/View#synctex">å®˜æ–¹ synctex é…ç½®</a> ä¿®æ”¹</p>
<ol>
<li><p>VSCode å†…éƒ¨ PDF æµè§ˆå™¨</p>
<p> å¦‚æœç›´æ¥ä½¿ç”¨ VSCode æ¥æµè§ˆ PDFï¼Œä¸éœ€è¦é¢å¤–è®¾ç½®ï¼Œå¯ä»¥æ ¹æ®éœ€è¦ä¿®æ”¹ <code>latex-workshop.view.pdf.internal.synctex.keybinding</code> æ¥ä¿®æ”¹åå‘åŒæ­¥çš„å¿«æ·é”®å³å¯ï¼Œé»˜è®¤ Ctrl åŠ é¼ æ ‡å·¦é”®</p>
 <figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="comment">// é»˜è®¤ Ctrl åŠ é¼ æ ‡å·¦é”®</span></span><br><span class="line"><span class="string">&quot;latex-workshop.view.pdf.internal.synctex.keybinding&quot;</span>: <span class="string">&quot;ctrl-click&quot;</span>,</span><br></pre></td></tr></table></figure></li>
<li><p>å¤–éƒ¨ PDF æµè§ˆå™¨</p>
<p> <a href="https://www.sumatrapdfreader.org/free-pdf-reader">SumatraPDF</a> æ˜¯ä¸€æ¬¾æµè¡Œçš„å°å·§æ–¹ä¾¿çš„å…è´¹ PDF æµè§ˆè½¯ä»¶ã€‚VSCode æ”¯æŒä½¿ç”¨å¤–éƒ¨çš„ PDF æµè§ˆå™¨æ¥æŸ¥çœ‹ç¼–è¯‘åçš„ PDF æ–‡ä»¶ï¼Œä»¥åŠåå‘æœç´¢åŠŸèƒ½ã€‚ä¸»è¦éœ€è¦å¦‚ä¸‹é…ç½®ï¼š</p>
 <figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="comment">// é…ç½®ä¸ºä½¿ç”¨å¤–éƒ¨ PDF æµè§ˆè½¯ä»¶æ¥æµè§ˆ PDF</span></span><br><span class="line"><span class="string">&quot;latex-workshop.view.pdf.viewer&quot;</span>: <span class="string">&quot;external&quot;</span>,</span><br><span class="line"><span class="comment">// é…ç½®å¤–éƒ¨ PDF æµè§ˆè½¯ä»¶çš„å‘½ä»¤è¡Œä»¥åŠå‚æ•°</span></span><br><span class="line"><span class="string">&quot;latex-workshop.view.pdf.external.viewer.command&quot;</span>: <span class="string">&quot;D:/Program/SumatraPDF/SumatraPDF-3.2-64.exe&quot;</span>, <span class="comment">// è‡ªè¡Œä¿®æ”¹è·¯å¾„</span></span><br><span class="line"><span class="string">&quot;latex-workshop.view.pdf.external.viewer.args&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;%PDF%&quot;</span></span><br><span class="line">],</span><br></pre></td></tr></table></figure>

<p> åœ¨ SumatraPDF çš„è®¾ç½®-é€‰é¡¹ä¸­è®¾ç½®åå‘æœç´¢å‘½ä»¤è¡Œ <code>C:\Users\&lt;user&gt;\AppData\Local\Programs\Microsoft VS Code\Code.exe -g &quot;%f:%l&quot;</code>ï¼ŒCode çš„è·¯å¾„åº”è¯¥ä¸ºå®Œæ•´çš„ç»å¯¹è·¯å¾„</p>
</li>
</ol>
<h4 id="å…¶ä»–å¯é€‰é…ç½®"><a href="#å…¶ä»–å¯é€‰é…ç½®" class="headerlink" title="å…¶ä»–å¯é€‰é…ç½®"></a>å…¶ä»–å¯é€‰é…ç½®</h4><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å…³é—­è‡ªåŠ¨ç¼–è¯‘</span></span><br><span class="line"><span class="string">&quot;latex-workshop.latex.autoBuild.run&quot;</span>: <span class="string">&quot;never&quot;</span>,</span><br><span class="line"><span class="comment">// é»˜è®¤é€‰æ‹©ä¸Šæ¬¡ç¼–è¯‘é“¾</span></span><br><span class="line"><span class="string">&quot;latex-workshop.latex.recipe.default&quot;</span>: <span class="string">&quot;lastUsed&quot;</span></span><br><span class="line"><span class="comment">// å³é”®èœå•</span></span><br><span class="line"><span class="string">&quot;latex-workshop.showContextMenu&quot;</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="comment">// å…³é—­ç¼–è¯‘å‡ºé”™çš„å¼¹çª—</span></span><br><span class="line"><span class="string">&quot;latex-workshop.message.error.show&quot;</span>: <span class="literal">false</span>,</span><br><span class="line"><span class="string">&quot;latex-workshop.message.warning.show&quot;</span>: <span class="literal">false</span>,</span><br></pre></td></tr></table></figure>

<h2 id="ä¸­æ–‡æ”¯æŒ"><a href="#ä¸­æ–‡æ”¯æŒ" class="headerlink" title="ä¸­æ–‡æ”¯æŒ"></a>ä¸­æ–‡æ”¯æŒ</h2><p>è¯¥èŠ‚ä¸»è¦å‚è€ƒ <a href="https://cn.overleaf.com/learn/latex/Chinese">Overleaf Chinese</a> æ–‡æ¡£</p>
<p><strong>æ¨èä½¿ç”¨ XeLaTeX å’Œ LuaLaTeX æ¥ç¼–è¯‘å«æœ‰ä¸­æ–‡å­—ç¬¦çš„ <code>.tex</code> æ–‡ä»¶</strong></p>
<h3 id="XeLaTeX-å’Œ-LuaLaTeX"><a href="#XeLaTeX-å’Œ-LuaLaTeX" class="headerlink" title="XeLaTeX å’Œ LuaLaTeX"></a>XeLaTeX å’Œ LuaLaTeX</h3><ol>
<li>ç›´æ¥ä½¿ç”¨ <code>ctexart</code> æ–‡æ¡£ç±»å³å¯æ”¯æŒä¸­æ–‡</li>
<li>æˆ–è€…ä½¿ç”¨ <code>ctex</code> åŒ…æ¥æ”¯æŒä¸­æ–‡</li>
</ol>
<p>å‚è€ƒä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight tex"><table><tr><td class="code"><pre><span class="line"><span class="keyword">\documentclass</span>&#123;ctexart&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">\begin</span>&#123;document&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">\tableofcontents</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">\begin</span>&#123;abstract&#125;</span><br><span class="line">è¿™æ˜¯ç®€ä»‹åŠæ‘˜è¦ã€‚</span><br><span class="line"><span class="keyword">\end</span>&#123;abstract&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">\section</span>&#123;å‰è¨€&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">\section</span>&#123;å…³äºæ•°å­¦éƒ¨åˆ†&#125;</span><br><span class="line">æ•°å­¦ã€ä¸­è‹±æ–‡çš†å¯ä»¥æ··æ’ã€‚You can intersperse math, Chinese and English (Latin script) without adding extra environments.</span><br><span class="line"></span><br><span class="line">é€™æ˜¯ç¹é«”ä¸­æ–‡ã€‚</span><br><span class="line"></span><br><span class="line"><span class="keyword">\end</span>&#123;document&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ–è€…</p>
<figure class="highlight tex"><table><tr><td class="code"><pre><span class="line"><span class="keyword">\documentclass</span>&#123;xxx&#125;</span><br><span class="line"><span class="keyword">\usepackage</span>&#123;ctex&#125;</span><br></pre></td></tr></table></figure>

<h3 id="XeLaTeX"><a href="#XeLaTeX" class="headerlink" title="XeLaTeX"></a>XeLaTeX</h3><p>XeLaTeX è¿˜å¯ä»¥ä½¿ç”¨ <code>xeCJK</code> åŒ…æ¥æ”¯æŒä¸­æ–‡</p>
<p>å‚è€ƒä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight tex"><table><tr><td class="code"><pre><span class="line"><span class="keyword">\documentclass</span>&#123;article&#125;</span><br><span class="line"><span class="keyword">\usepackage</span>&#123;xeCJK&#125;</span><br><span class="line"><span class="keyword">\begin</span>&#123;document&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">\section</span>&#123;å‰è¨€&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">\section</span>&#123;å…³äºæ•°å­¦éƒ¨åˆ†&#125;</span><br><span class="line">æ•°å­¦ã€ä¸­è‹±æ–‡çš†å¯ä»¥æ··æ’ã€‚You can intersperse math, Chinese and English (Latin script) without adding extra environments.</span><br><span class="line"></span><br><span class="line">é€™æ˜¯ç¹é«”ä¸­æ–‡ã€‚</span><br><span class="line"><span class="keyword">\end</span>&#123;document&#125;</span><br></pre></td></tr></table></figure>

<h3 id="pdfLaTeX"><a href="#pdfLaTeX" class="headerlink" title="pdfLaTeX"></a>pdfLaTeX</h3><p>pdfLaTeX å¯¹ä¸­æ–‡æ”¯æŒä¸æ˜¯å¾ˆå¥½ï¼Œåªç”¨ pdaLaTeX çš„è¯éœ€è¦å¼•å…¥ <code>CJKutf8</code> åŒ…ï¼Œå¹¶ä¸”ç”¨ <code>\begin&#123;CJK*&#125;&#123;UTF8&#125;&#123;gbsn&#125;</code> å’Œ <code>\end&#123;CJK*&#125;</code> åŒ…ä½æ‰€æœ‰çš„ä¸­æ–‡ã€‚</p>
<ul>
<li><code>gbsn</code> å’Œ <code>gkai</code> æ˜¯ç®€ä½“çš„å­—ä½“</li>
<li><code>bsmi</code> å’Œ <code>bkai</code> æ˜¯ç¹ä½“çš„å­—ä½“</li>
</ul>
<p>å‚è€ƒä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight tex"><table><tr><td class="code"><pre><span class="line"><span class="keyword">\documentclass</span>&#123;article&#125;</span><br><span class="line"><span class="keyword">\usepackage</span>&#123;CJKutf8&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">\begin</span>&#123;document&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">\begin</span>&#123;CJK*&#125;&#123;UTF8&#125;&#123;gbsn&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">\section</span>&#123;å‰è¨€&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">\section</span>&#123;å…³äºæ•°å­¦éƒ¨åˆ†&#125;</span><br><span class="line">æ•°å­¦ã€ä¸­è‹±æ–‡çš†å¯ä»¥æ··æ’ã€‚You can intersperse math, Chinese and English (Latin script) without adding extra environments.</span><br><span class="line"></span><br><span class="line"><span class="keyword">\end</span>&#123;CJK*&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">\bigskip</span>  <span class="comment">%% Just some white space</span></span><br><span class="line"></span><br><span class="line">You can also insert Latin text in your document</span><br><span class="line"></span><br><span class="line"><span class="keyword">\bigskip</span>  <span class="comment">%% Just some white space</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">\begin</span>&#123;CJK*&#125;&#123;UTF8&#125;&#123;bsmi&#125;</span><br><span class="line">é€™æ˜¯ç¹é«”ä¸­æ–‡ã€‚</span><br><span class="line"><span class="keyword">\end</span>&#123;CJK*&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">\end</span>&#123;document&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ç¼–è¯‘"><a href="#ç¼–è¯‘" class="headerlink" title="ç¼–è¯‘"></a>ç¼–è¯‘</h3><ol>
<li><p>é¦–å…ˆ <code>.tex</code> æ–‡ä»¶åä»¥åŠè·¯å¾„å°½é‡ä¸è¦å«æœ‰ç©ºæ ¼ä»¥åŠä¸­æ–‡å­—ç¬¦</p>
</li>
<li><p>åœ¨ä½¿ç”¨ <code>latexmk</code> å’Œ VSCode çš„ LaTeX Workshop æ—¶ï¼Œæ¨èä½¿ç”¨ç¬¬ä¸‰ä¸ªç¼–è¯‘é“¾ <code>Recipe: latexmk (lualatex)</code></p>
<p> <img data-src="/posts/4f94956/build-chinese-latex.png" alt="ç¼–è¯‘ä¸­æ–‡ LaTeX"></p>
</li>
</ol>
<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul>
<li><a href="https://github.com/James-Yu/LaTeX-Workshop/wiki/Install#requirements">ã€LaTeX Workshopã€‘ä¾èµ–</a></li>
<li><a href="https://github.com/James-Yu/LaTeX-Workshop/wiki/Compile#latex-recipes">ã€LaTeX Workshopã€‘recipes é…ç½®</a></li>
<li><a href="https://github.com/James-Yu/LaTeX-Workshop/wiki/View#synctex">ã€LaTeX Workshopã€‘synctex é…ç½®</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/38178015">ã€çŸ¥ä¹ã€‘ä½¿ç”¨ VSCode ç¼–å†™ LaTeX</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/166523064">ã€çŸ¥ä¹ã€‘Visual Studio Code é…ç½® LaTeX</a></li>
<li><a href="https://cn.overleaf.com/learn/latex/Chinese">ã€Overleafã€‘Chinese</a></li>
</ul>
]]></content>
      <categories>
        <category>LaTeX</category>
      </categories>
      <tags>
        <tag>LaTeX</tag>
        <tag>VSCode</tag>
      </tags>
  </entry>
  <entry>
    <title>LaTeX è¯­æ³•</title>
    <url>/posts/2033aa70.html</url>
    <content><![CDATA[<p>ä¸­æ–‡æ”¯æŒå‚è€ƒç¯å¢ƒé…ç½®ä¸­çš„ <a href="/posts/4f94956.html#%E4%B8%AD%E6%96%87%E6%94%AF%E6%8C%81">å†…å®¹</a>ï¼Œåœ¨è¿™é‡Œä¸åšé‡å¤</p>
<span id="more"></span>
<h2 id="é•¿åº¦"><a href="#é•¿åº¦" class="headerlink" title="é•¿åº¦"></a>é•¿åº¦</h2><p>å¸¸ç”¨çš„é•¿åº¦å•ä½</p>
<table>
<thead>
<tr>
<th>å•ä½</th>
<th>å«ä¹‰</th>
<th>æ¢ç®—æˆ pt</th>
<th>æ¢æˆç®—æˆ mm</th>
</tr>
</thead>
<tbody><tr>
<td>pt</td>
<td>åŸºæœ¬å•ä½</td>
<td>1 pt</td>
<td>0.35146 mm</td>
</tr>
<tr>
<td>mm</td>
<td>æ¯«ç±³</td>
<td>2.84 pt</td>
<td>1 mm</td>
</tr>
<tr>
<td>cm</td>
<td>å˜ç±³</td>
<td>28.4 pt</td>
<td>10 mm</td>
</tr>
<tr>
<td>in</td>
<td>è‹±å¯¸</td>
<td>72.27 pt</td>
<td>0.35146 mm</td>
</tr>
<tr>
<td>ex</td>
<td>å½“å‰å­—ä½“çš„ x å­—æ¯é«˜åº¦</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>em</td>
<td>å½“å‰å­—ä½“çš„ m å­—æ¯å®½åº¦</td>
<td>-</td>
<td>-</td>
</tr>
</tbody></table>
<h2 id="ç©ºè¡Œ"><a href="#ç©ºè¡Œ" class="headerlink" title="ç©ºè¡Œ"></a>ç©ºè¡Œ</h2><figure class="highlight tex"><table><tr><td class="code"><pre><span class="line"><span class="keyword">\vspace</span>&#123;length&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ç©ºæ ¼"><a href="#ç©ºæ ¼" class="headerlink" title="ç©ºæ ¼"></a>ç©ºæ ¼</h2><figure class="highlight tex"><table><tr><td class="code"><pre><span class="line"><span class="keyword">\hspace</span>&#123;length&#125;</span><br></pre></td></tr></table></figure>

<h2 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h2><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul>
<li><a href="https://en.wikibooks.org/wiki/LaTeX/Lengths">ã€ç»´åŸºç™¾ç§‘ã€‘LaTeX Lengths</a></li>
</ul>
]]></content>
      <categories>
        <category>LaTeX</category>
      </categories>
      <tags>
        <tag>æ›´æ–°ä¸­</tag>
        <tag>LaTeX</tag>
      </tags>
  </entry>
  <entry>
    <title>rm -r ä¸ rmdir åŒºåˆ«</title>
    <url>/posts/935ae1f0.html</url>
    <content><![CDATA[<h2 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h2><p>ä»Šå¤©å­¦å¼Ÿåœ¨ä½¿ç”¨ NVMe-over-TCP æ—¶å‘ç°æ— æ³•å¸è½½ <code>nvmet</code> é©±åŠ¨ï¼Œæ˜¾ç¤ºä½¿ç”¨ä¸­</p>
<p>åœ¨ä¸€èµ·æ¢è®¨å’Œæµ‹è¯•ä¸­å‘ç°æœ€ç»ˆçš„åŸå› ç«Ÿç„¶åœ¨äº <code>rm -r</code> å’Œ <code>rmdir</code> è¿™ä¸¤ä¸ªå‘½ä»¤ä¸Š</p>
<span id="more"></span>
<h2 id="äºŒè€…åŒºåˆ«"><a href="#äºŒè€…åŒºåˆ«" class="headerlink" title="äºŒè€…åŒºåˆ«"></a>äºŒè€…åŒºåˆ«</h2><table>
<thead>
<tr>
<th>å‘½ä»¤</th>
<th>ä¸»è¦ç³»ç»Ÿè°ƒç”¨</th>
<th>æ“ä½œå¯¹è±¡</th>
</tr>
</thead>
<tbody><tr>
<td><code>rmdir</code></td>
<td><code>rmdir</code></td>
<td>ä»…ç›®å½•</td>
</tr>
<tr>
<td><code>rm -r</code></td>
<td><code>openat</code>, <code>getdents64</code>, <code>close</code>, <code>unlinkat</code></td>
<td>ç›®å½•ï¼Œä»¥åŠç›®å½•æ‰€æœ‰æ–‡ä»¶</td>
</tr>
</tbody></table>
<h3 id="rmdir"><a href="#rmdir" class="headerlink" title="rmdir"></a><code>rmdir</code></h3><p><code>rmdir</code> ç›´æ¥è°ƒç”¨ <code>rmdir</code> æ¥åˆ é™¤ç›®å½•ï¼Œå¦‚æœç›®å½•éç©ºï¼Œåˆ™ä¼šåˆ é™¤å¤±è´¥</p>
<h3 id="rm-r"><a href="#rm-r" class="headerlink" title="rm -r"></a><code>rm -r</code></h3><ol>
<li>ä¼šå…ˆç”¨ <code>openat</code> æ‰“å¼€ç›®å½•ï¼Œé€šè¿‡ <code>getdents64</code> è·å–ç›®å½•ä¸­çš„å†…å®¹ï¼Œç„¶å <code>close</code> ç›®å½•</li>
<li>å†ç¬¬äºŒæ¬¡åŠ ä¸Š <code>O_CLOEXEC</code> æ ‡è®°<code>openat</code> æ‰“å¼€ç›®å½•ï¼Œè¡¨æ˜å½“å‰ç›®å½•å³å°†åˆ é™¤ï¼Œå†æ¬¡é€šè¿‡ <code>getdents64</code> è·å–ç›®å½•ä¸­çš„å†…å®¹ï¼Œç„¶å <code>close</code> ç›®å½•</li>
<li>ç„¶åä¾æ¬¡é€šè¿‡ <code>unlinkat</code> åˆ é™¤ç›®å½•ä¸­çš„å†…å®¹</li>
<li>æœ€åé€šè¿‡ <code>unlinkat</code> åˆ é™¤ç›®å½•</li>
</ol>
<h3 id="rm-rf"><a href="#rm-rf" class="headerlink" title="rm -rf"></a><code>rm -rf</code></h3><p>ä½†æ˜¯å¦‚æœä½¿ç”¨çš„æ˜¯ <code>rm -rf</code>ï¼Œå¹¶ä¸”åœ¨ç¬¬ 3 æ­¥åˆ é™¤ç›®å½•å†…æ–‡ä»¶å¤±è´¥æ—¶ï¼Œåˆ™ä¼šè·³è¿‡ç¬¬ 4 æ­¥ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸ä¼šå†å¯¹ç›®å½•åšä»»ä½•æ“ä½œ</p>
<h2 id="æµ‹è¯•è¿‡ç¨‹"><a href="#æµ‹è¯•è¿‡ç¨‹" class="headerlink" title="æµ‹è¯•è¿‡ç¨‹"></a>æµ‹è¯•è¿‡ç¨‹</h2><h3 id="é…ç½®ç¯å¢ƒ"><a href="#é…ç½®ç¯å¢ƒ" class="headerlink" title="é…ç½®ç¯å¢ƒ"></a>é…ç½®ç¯å¢ƒ</h3><p>é¦–å…ˆå»ºç«‹ä¸€ä¸ªéç©ºç›®å½•ï¼Œå¹¶ä¸”ç»™ç›®å½•ä¸­çš„æ–‡ä»¶é…ç½®æƒé™ï¼Œç¦æ­¢åˆ é™¤æ–‡ä»¶</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mkdir dir</span><br><span class="line">touch dir/file</span><br><span class="line">sudo chattr +i dir/file</span><br></pre></td></tr></table></figure>

<p>æ­¤æ—¶ç›®å½•æ ‘å¦‚ä¸‹</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ tree dir</span><br><span class="line">dir</span><br><span class="line">â””â”€â”€ file</span><br><span class="line"></span><br><span class="line">0 directories, 1 file</span><br></pre></td></tr></table></figure>

<h3 id="rmdir-1"><a href="#rmdir-1" class="headerlink" title="rmdir"></a><code>rmdir</code></h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ strace -o rmdir rmdir dir/</span><br><span class="line">rmdir: failed to remove <span class="string">&#x27;dir/&#x27;</span>: Directory not empty</span><br></pre></td></tr></table></figure>

<p><code>strace</code> æŠ“åˆ°çš„å†…å®¹å¦‚ä¸‹ï¼Œä¸»è¦å†…å®¹åœ¨ç¬¬ 37 è¡Œ</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">execve(&quot;/usr/bin/rmdir&quot;, [&quot;rmdir&quot;, &quot;dir/&quot;], 0x7ffe38ddae38 /* 26 vars */) = 0</span><br><span class="line">brk(NULL)                               = 0x561e92b83000</span><br><span class="line">arch_prctl(0x3001 /* ARCH_??? */, 0x7fff06684960) = -1 EINVAL (Invalid argument)</span><br><span class="line">access(&quot;/etc/ld.so.preload&quot;, R_OK)      = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, &quot;/etc/ld.so.cache&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=46019, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 46019, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7f51af80c000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">openat(AT_FDCWD, &quot;/lib/x86_64-linux-gnu/libc.so.6&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">read(3, &quot;\177ELF\2\1\1\3\0\0\0\0\0\0\0\0\3\0&gt;\0\1\0\0\0\360q\2\0\0\0\0\0&quot;..., 832) = 832</span><br><span class="line">pread64(3, &quot;\6\0\0\0\4\0\0\0@\0\0\0\0\0\0\0@\0\0\0\0\0\0\0@\0\0\0\0\0\0\0&quot;..., 784, 64) = 784</span><br><span class="line">pread64(3, &quot;\4\0\0\0\20\0\0\0\5\0\0\0GNU\0\2\0\0\300\4\0\0\0\3\0\0\0\0\0\0\0&quot;, 32, 848) = 32</span><br><span class="line">pread64(3, &quot;\4\0\0\0\24\0\0\0\3\0\0\0GNU\0\t\233\222%\274\260\320\31\331\326\10\204\276X&gt;\263&quot;..., 68, 880) = 68</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0755, st_size=2029224, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7f51af80a000</span><br><span class="line">pread64(3, &quot;\6\0\0\0\4\0\0\0@\0\0\0\0\0\0\0@\0\0\0\0\0\0\0@\0\0\0\0\0\0\0&quot;..., 784, 64) = 784</span><br><span class="line">pread64(3, &quot;\4\0\0\0\20\0\0\0\5\0\0\0GNU\0\2\0\0\300\4\0\0\0\3\0\0\0\0\0\0\0&quot;, 32, 848) = 32</span><br><span class="line">pread64(3, &quot;\4\0\0\0\24\0\0\0\3\0\0\0GNU\0\t\233\222%\274\260\320\31\331\326\10\204\276X&gt;\263&quot;..., 68, 880) = 68</span><br><span class="line">mmap(NULL, 2036952, PROT_READ, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0x7f51af618000</span><br><span class="line">mprotect(0x7f51af63d000, 1847296, PROT_NONE) = 0</span><br><span class="line">mmap(0x7f51af63d000, 1540096, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x25000) = 0x7f51af63d000</span><br><span class="line">mmap(0x7f51af7b5000, 303104, PROT_READ, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x19d000) = 0x7f51af7b5000</span><br><span class="line">mmap(0x7f51af800000, 24576, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x1e7000) = 0x7f51af800000</span><br><span class="line">mmap(0x7f51af806000, 13528, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_ANONYMOUS, -1, 0) = 0x7f51af806000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">arch_prctl(ARCH_SET_FS, 0x7f51af80b580) = 0</span><br><span class="line">mprotect(0x7f51af800000, 12288, PROT_READ) = 0</span><br><span class="line">mprotect(0x561e91688000, 4096, PROT_READ) = 0</span><br><span class="line">mprotect(0x7f51af845000, 4096, PROT_READ) = 0</span><br><span class="line">munmap(0x7f51af80c000, 46019)           = 0</span><br><span class="line">brk(NULL)                               = 0x561e92b83000</span><br><span class="line">brk(0x561e92ba4000)                     = 0x561e92ba4000</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/lib/locale/locale-archive&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=3035952, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 3035952, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7f51af332000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">rmdir(&quot;dir/&quot;)                           = -1 ENOTEMPTY (Directory not empty)</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/share/locale/locale.alias&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=2996, ...&#125;) = 0</span><br><span class="line">read(3, &quot;# Locale name alias data base.\n#&quot;..., 4096) = 2996</span><br><span class="line">read(3, &quot;&quot;, 4096)                       = 0</span><br><span class="line">close(3)                                = 0</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/share/locale/en_US.UTF-8/LC_MESSAGES/coreutils.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/share/locale/en_US.utf8/LC_MESSAGES/coreutils.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/share/locale/en_US/LC_MESSAGES/coreutils.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/share/locale/en.UTF-8/LC_MESSAGES/coreutils.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/share/locale/en.utf8/LC_MESSAGES/coreutils.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/share/locale/en/LC_MESSAGES/coreutils.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/share/locale-langpack/en_US.UTF-8/LC_MESSAGES/coreutils.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/share/locale-langpack/en_US.utf8/LC_MESSAGES/coreutils.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/share/locale-langpack/en_US/LC_MESSAGES/coreutils.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/share/locale-langpack/en.UTF-8/LC_MESSAGES/coreutils.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/share/locale-langpack/en.utf8/LC_MESSAGES/coreutils.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/share/locale-langpack/en/LC_MESSAGES/coreutils.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">write(2, &quot;rmdir: &quot;, 7)                  = 7</span><br><span class="line">write(2, &quot;failed to remove &#x27;dir/&#x27;&quot;, 23) = 23</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/share/locale/en_US.UTF-8/LC_MESSAGES/libc.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/share/locale/en_US.utf8/LC_MESSAGES/libc.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/share/locale/en_US/LC_MESSAGES/libc.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/share/locale/en.UTF-8/LC_MESSAGES/libc.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/share/locale/en.utf8/LC_MESSAGES/libc.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/share/locale/en/LC_MESSAGES/libc.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/share/locale-langpack/en_US.UTF-8/LC_MESSAGES/libc.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/share/locale-langpack/en_US.utf8/LC_MESSAGES/libc.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/share/locale-langpack/en_US/LC_MESSAGES/libc.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/share/locale-langpack/en.UTF-8/LC_MESSAGES/libc.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/share/locale-langpack/en.utf8/LC_MESSAGES/libc.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/share/locale-langpack/en/LC_MESSAGES/libc.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">write(2, &quot;: Directory not empty&quot;, 21)   = 21</span><br><span class="line">write(2, &quot;\n&quot;, 1)                       = 1</span><br><span class="line">close(1)                                = 0</span><br><span class="line">close(2)                                = 0</span><br><span class="line">exit_group(1)                           = ?</span><br><span class="line">+++ exited with 1 +++</span><br></pre></td></tr></table></figure>

<h3 id="rm-r-1"><a href="#rm-r-1" class="headerlink" title="rm -r"></a><code>rm -r</code></h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ strace -o rm_r_fail.strace rm -r dir/</span><br><span class="line">rm: cannot remove <span class="string">&#x27;dir/file&#x27;</span>: Operation not permitted</span><br><span class="line">rm: cannot remove <span class="string">&#x27;dir/&#x27;</span>: Directory not empty</span><br></pre></td></tr></table></figure>

<p><code>strace</code> æŠ“åˆ°çš„å†…å®¹å¦‚ä¸‹ï¼Œä¸»è¦å†…å®¹åœ¨ç¬¬ 39-59 ä»¥åŠ 94-96 è¡Œ</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">execve(&quot;/usr/bin/rm&quot;, [&quot;rm&quot;, &quot;-r&quot;, &quot;dir/&quot;], 0x7ffc2c0fb640 /* 26 vars */) = 0</span><br><span class="line">brk(NULL)                               = 0x56082871e000</span><br><span class="line">arch_prctl(0x3001 /* ARCH_??? */, 0x7ffd0d910cf0) = -1 EINVAL (Invalid argument)</span><br><span class="line">access(&quot;/etc/ld.so.preload&quot;, R_OK)      = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, &quot;/etc/ld.so.cache&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=46019, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 46019, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7f65c441d000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">openat(AT_FDCWD, &quot;/lib/x86_64-linux-gnu/libc.so.6&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">read(3, &quot;\177ELF\2\1\1\3\0\0\0\0\0\0\0\0\3\0&gt;\0\1\0\0\0\360q\2\0\0\0\0\0&quot;..., 832) = 832</span><br><span class="line">pread64(3, &quot;\6\0\0\0\4\0\0\0@\0\0\0\0\0\0\0@\0\0\0\0\0\0\0@\0\0\0\0\0\0\0&quot;..., 784, 64) = 784</span><br><span class="line">pread64(3, &quot;\4\0\0\0\20\0\0\0\5\0\0\0GNU\0\2\0\0\300\4\0\0\0\3\0\0\0\0\0\0\0&quot;, 32, 848) = 32</span><br><span class="line">pread64(3, &quot;\4\0\0\0\24\0\0\0\3\0\0\0GNU\0\t\233\222%\274\260\320\31\331\326\10\204\276X&gt;\263&quot;..., 68, 880) = 68</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0755, st_size=2029224, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7f65c441b000</span><br><span class="line">pread64(3, &quot;\6\0\0\0\4\0\0\0@\0\0\0\0\0\0\0@\0\0\0\0\0\0\0@\0\0\0\0\0\0\0&quot;..., 784, 64) = 784</span><br><span class="line">pread64(3, &quot;\4\0\0\0\20\0\0\0\5\0\0\0GNU\0\2\0\0\300\4\0\0\0\3\0\0\0\0\0\0\0&quot;, 32, 848) = 32</span><br><span class="line">pread64(3, &quot;\4\0\0\0\24\0\0\0\3\0\0\0GNU\0\t\233\222%\274\260\320\31\331\326\10\204\276X&gt;\263&quot;..., 68, 880) = 68</span><br><span class="line">mmap(NULL, 2036952, PROT_READ, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0x7f65c4229000</span><br><span class="line">mprotect(0x7f65c424e000, 1847296, PROT_NONE) = 0</span><br><span class="line">mmap(0x7f65c424e000, 1540096, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x25000) = 0x7f65c424e000</span><br><span class="line">mmap(0x7f65c43c6000, 303104, PROT_READ, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x19d000) = 0x7f65c43c6000</span><br><span class="line">mmap(0x7f65c4411000, 24576, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x1e7000) = 0x7f65c4411000</span><br><span class="line">mmap(0x7f65c4417000, 13528, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_ANONYMOUS, -1, 0) = 0x7f65c4417000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">arch_prctl(ARCH_SET_FS, 0x7f65c441c580) = 0</span><br><span class="line">mprotect(0x7f65c4411000, 12288, PROT_READ) = 0</span><br><span class="line">mprotect(0x560827bb0000, 4096, PROT_READ) = 0</span><br><span class="line">mprotect(0x7f65c4456000, 4096, PROT_READ) = 0</span><br><span class="line">munmap(0x7f65c441d000, 46019)           = 0</span><br><span class="line">brk(NULL)                               = 0x56082871e000</span><br><span class="line">brk(0x56082873f000)                     = 0x56082873f000</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/lib/locale/locale-archive&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=3035952, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 3035952, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7f65c3f43000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">ioctl(0, TCGETS, &#123;B38400 opost isig icanon echo ...&#125;) = 0</span><br><span class="line">lstat(&quot;/&quot;, &#123;st_mode=S_IFDIR|0755, st_size=4096, ...&#125;) = 0</span><br><span class="line">newfstatat(AT_FDCWD, &quot;dir/&quot;, &#123;st_mode=S_IFDIR|0775, st_size=4096, ...&#125;, AT_SYMLINK_NOFOLLOW) = 0</span><br><span class="line">openat(AT_FDCWD, &quot;dir/&quot;, O_RDONLY|O_NOCTTY|O_NONBLOCK|O_NOFOLLOW|O_DIRECTORY) = 3</span><br><span class="line">fstat(3, &#123;st_mode=S_IFDIR|0775, st_size=4096, ...&#125;) = 0</span><br><span class="line">fcntl(3, F_GETFL)                       = 0x38800 (flags O_RDONLY|O_NONBLOCK|O_LARGEFILE|O_NOFOLLOW|O_DIRECTORY)</span><br><span class="line">fcntl(3, F_SETFD, FD_CLOEXEC)           = 0</span><br><span class="line">getdents64(3, /* 3 entries */, 32768)   = 72</span><br><span class="line">close(3)                                = 0</span><br><span class="line">geteuid()                               = 1000</span><br><span class="line">newfstatat(AT_FDCWD, &quot;dir/&quot;, &#123;st_mode=S_IFDIR|0775, st_size=4096, ...&#125;, AT_SYMLINK_NOFOLLOW) = 0</span><br><span class="line">faccessat(AT_FDCWD, &quot;dir/&quot;, W_OK)       = 0</span><br><span class="line">openat(AT_FDCWD, &quot;dir/&quot;, O_RDONLY|O_NOCTTY|O_NONBLOCK|O_NOFOLLOW|O_CLOEXEC|O_DIRECTORY) = 3</span><br><span class="line">fstat(3, &#123;st_mode=S_IFDIR|0775, st_size=4096, ...&#125;) = 0</span><br><span class="line">fcntl(3, F_GETFL)                       = 0x38800 (flags O_RDONLY|O_NONBLOCK|O_LARGEFILE|O_NOFOLLOW|O_DIRECTORY)</span><br><span class="line">fcntl(3, F_SETFD, FD_CLOEXEC)           = 0</span><br><span class="line">fstatfs(3, &#123;f_type=EXT2_SUPER_MAGIC, f_bsize=4096, f_blocks=20510566, f_bfree=15993067, f_bavail=14940434, f_files=5242880, f_ffree=5074130, f_fsid=&#123;val=[3258576323, 2412010735]&#125;, f_namelen=255, f_frsize=4096, f_flags=ST_VALID|ST_RELATIME&#125;) = 0</span><br><span class="line">fcntl(3, F_DUPFD_CLOEXEC, 3)            = 4</span><br><span class="line">getdents64(3, /* 3 entries */, 32768)   = 72</span><br><span class="line">getdents64(3, /* 0 entries */, 32768)   = 0</span><br><span class="line">close(3)                                = 0</span><br><span class="line">newfstatat(4, &quot;file&quot;, &#123;st_mode=S_IFREG|0664, st_size=0, ...&#125;, AT_SYMLINK_NOFOLLOW) = 0</span><br><span class="line">faccessat(4, &quot;file&quot;, W_OK)              = -1 EPERM (Operation not permitted)</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/share/locale/locale.alias&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=2996, ...&#125;) = 0</span><br><span class="line">read(3, &quot;# Locale name alias data base.\n#&quot;..., 4096) = 2996</span><br><span class="line">read(3, &quot;&quot;, 4096)                       = 0</span><br><span class="line">close(3)                                = 0</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/share/locale/en_US.UTF-8/LC_MESSAGES/coreutils.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/share/locale/en_US.utf8/LC_MESSAGES/coreutils.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/share/locale/en_US/LC_MESSAGES/coreutils.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/share/locale/en.UTF-8/LC_MESSAGES/coreutils.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/share/locale/en.utf8/LC_MESSAGES/coreutils.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/share/locale/en/LC_MESSAGES/coreutils.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/share/locale-langpack/en_US.UTF-8/LC_MESSAGES/coreutils.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/share/locale-langpack/en_US.utf8/LC_MESSAGES/coreutils.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/share/locale-langpack/en_US/LC_MESSAGES/coreutils.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/share/locale-langpack/en.UTF-8/LC_MESSAGES/coreutils.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/share/locale-langpack/en.utf8/LC_MESSAGES/coreutils.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/share/locale-langpack/en/LC_MESSAGES/coreutils.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">write(2, &quot;rm: &quot;, 4)                     = 4</span><br><span class="line">write(2, &quot;cannot remove &#x27;dir/file&#x27;&quot;, 24) = 24</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/share/locale/en_US.UTF-8/LC_MESSAGES/libc.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/share/locale/en_US.utf8/LC_MESSAGES/libc.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/share/locale/en_US/LC_MESSAGES/libc.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/share/locale/en.UTF-8/LC_MESSAGES/libc.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/share/locale/en.utf8/LC_MESSAGES/libc.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/share/locale/en/LC_MESSAGES/libc.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/share/locale-langpack/en_US.UTF-8/LC_MESSAGES/libc.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/share/locale-langpack/en_US.utf8/LC_MESSAGES/libc.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/share/locale-langpack/en_US/LC_MESSAGES/libc.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/share/locale-langpack/en.UTF-8/LC_MESSAGES/libc.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/share/locale-langpack/en.utf8/LC_MESSAGES/libc.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/share/locale-langpack/en/LC_MESSAGES/libc.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">write(2, &quot;: Operation not permitted&quot;, 25) = 25</span><br><span class="line">write(2, &quot;\n&quot;, 1)                       = 1</span><br><span class="line">close(4)                                = 0</span><br><span class="line">newfstatat(AT_FDCWD, &quot;dir/&quot;, &#123;st_mode=S_IFDIR|0775, st_size=4096, ...&#125;, AT_SYMLINK_NOFOLLOW) = 0</span><br><span class="line">faccessat(AT_FDCWD, &quot;dir/&quot;, W_OK)       = 0</span><br><span class="line">unlinkat(AT_FDCWD, &quot;dir/&quot;, AT_REMOVEDIR) = -1 ENOTEMPTY (Directory not empty)</span><br><span class="line">write(2, &quot;rm: &quot;, 4)                     = 4</span><br><span class="line">write(2, &quot;cannot remove &#x27;dir/&#x27;&quot;, 20)    = 20</span><br><span class="line">write(2, &quot;: Directory not empty&quot;, 21)   = 21</span><br><span class="line">write(2, &quot;\n&quot;, 1)                       = 1</span><br><span class="line">lseek(0, 0, SEEK_CUR)                   = -1 ESPIPE (Illegal seek)</span><br><span class="line">close(0)                                = 0</span><br><span class="line">close(1)                                = 0</span><br><span class="line">close(2)                                = 0</span><br><span class="line">exit_group(1)                           = ?</span><br><span class="line">+++ exited with 1 +++</span><br></pre></td></tr></table></figure>

<h3 id="rm-rf-1"><a href="#rm-rf-1" class="headerlink" title="rm -rf"></a><code>rm -rf</code></h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ strace -o rm_fail.strace rm -rf dir/</span><br><span class="line">rm: cannot remove <span class="string">&#x27;dir/file&#x27;</span>: Operation not permitted</span><br></pre></td></tr></table></figure>

<p><code>strace</code> æŠ“åˆ°çš„å†…å®¹å¦‚ä¸‹ï¼Œä¸»è¦å†…å®¹åœ¨ç¬¬ 39-55 è¡Œ</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">execve(&quot;/usr/bin/rm&quot;, [&quot;rm&quot;, &quot;-rf&quot;, &quot;dir/&quot;], 0x7fff7bc99c20 /* 26 vars */) = 0</span><br><span class="line">brk(NULL)                               = 0x5566570fe000</span><br><span class="line">arch_prctl(0x3001 /* ARCH_??? */, 0x7ffde2720670) = -1 EINVAL (Invalid argument)</span><br><span class="line">access(&quot;/etc/ld.so.preload&quot;, R_OK)      = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, &quot;/etc/ld.so.cache&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=46019, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 46019, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7fcb89d87000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">openat(AT_FDCWD, &quot;/lib/x86_64-linux-gnu/libc.so.6&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">read(3, &quot;\177ELF\2\1\1\3\0\0\0\0\0\0\0\0\3\0&gt;\0\1\0\0\0\360q\2\0\0\0\0\0&quot;..., 832) = 832</span><br><span class="line">pread64(3, &quot;\6\0\0\0\4\0\0\0@\0\0\0\0\0\0\0@\0\0\0\0\0\0\0@\0\0\0\0\0\0\0&quot;..., 784, 64) = 784</span><br><span class="line">pread64(3, &quot;\4\0\0\0\20\0\0\0\5\0\0\0GNU\0\2\0\0\300\4\0\0\0\3\0\0\0\0\0\0\0&quot;, 32, 848) = 32</span><br><span class="line">pread64(3, &quot;\4\0\0\0\24\0\0\0\3\0\0\0GNU\0\t\233\222%\274\260\320\31\331\326\10\204\276X&gt;\263&quot;..., 68, 880) = 68</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0755, st_size=2029224, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7fcb89d85000</span><br><span class="line">pread64(3, &quot;\6\0\0\0\4\0\0\0@\0\0\0\0\0\0\0@\0\0\0\0\0\0\0@\0\0\0\0\0\0\0&quot;..., 784, 64) = 784</span><br><span class="line">pread64(3, &quot;\4\0\0\0\20\0\0\0\5\0\0\0GNU\0\2\0\0\300\4\0\0\0\3\0\0\0\0\0\0\0&quot;, 32, 848) = 32</span><br><span class="line">pread64(3, &quot;\4\0\0\0\24\0\0\0\3\0\0\0GNU\0\t\233\222%\274\260\320\31\331\326\10\204\276X&gt;\263&quot;..., 68, 880) = 68</span><br><span class="line">mmap(NULL, 2036952, PROT_READ, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0x7fcb89b93000</span><br><span class="line">mprotect(0x7fcb89bb8000, 1847296, PROT_NONE) = 0</span><br><span class="line">mmap(0x7fcb89bb8000, 1540096, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x25000) = 0x7fcb89bb8000</span><br><span class="line">mmap(0x7fcb89d30000, 303104, PROT_READ, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x19d000) = 0x7fcb89d30000</span><br><span class="line">mmap(0x7fcb89d7b000, 24576, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x1e7000) = 0x7fcb89d7b000</span><br><span class="line">mmap(0x7fcb89d81000, 13528, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_ANONYMOUS, -1, 0) = 0x7fcb89d81000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">arch_prctl(ARCH_SET_FS, 0x7fcb89d86580) = 0</span><br><span class="line">mprotect(0x7fcb89d7b000, 12288, PROT_READ) = 0</span><br><span class="line">mprotect(0x5566566dd000, 4096, PROT_READ) = 0</span><br><span class="line">mprotect(0x7fcb89dc0000, 4096, PROT_READ) = 0</span><br><span class="line">munmap(0x7fcb89d87000, 46019)           = 0</span><br><span class="line">brk(NULL)                               = 0x5566570fe000</span><br><span class="line">brk(0x55665711f000)                     = 0x55665711f000</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/lib/locale/locale-archive&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=3035952, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 3035952, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7fcb898ad000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">ioctl(0, TCGETS, &#123;B38400 opost isig icanon echo ...&#125;) = 0</span><br><span class="line">lstat(&quot;/&quot;, &#123;st_mode=S_IFDIR|0755, st_size=4096, ...&#125;) = 0</span><br><span class="line">newfstatat(AT_FDCWD, &quot;dir/&quot;, &#123;st_mode=S_IFDIR|0775, st_size=4096, ...&#125;, AT_SYMLINK_NOFOLLOW) = 0</span><br><span class="line">openat(AT_FDCWD, &quot;dir/&quot;, O_RDONLY|O_NOCTTY|O_NONBLOCK|O_NOFOLLOW|O_DIRECTORY) = 3</span><br><span class="line">fstat(3, &#123;st_mode=S_IFDIR|0775, st_size=4096, ...&#125;) = 0</span><br><span class="line">fcntl(3, F_GETFL)                       = 0x38800 (flags O_RDONLY|O_NONBLOCK|O_LARGEFILE|O_NOFOLLOW|O_DIRECTORY)</span><br><span class="line">fcntl(3, F_SETFD, FD_CLOEXEC)           = 0</span><br><span class="line">getdents64(3, /* 3 entries */, 32768)   = 72</span><br><span class="line">close(3)                                = 0</span><br><span class="line">openat(AT_FDCWD, &quot;dir/&quot;, O_RDONLY|O_NOCTTY|O_NONBLOCK|O_NOFOLLOW|O_CLOEXEC|O_DIRECTORY) = 3</span><br><span class="line">fstat(3, &#123;st_mode=S_IFDIR|0775, st_size=4096, ...&#125;) = 0</span><br><span class="line">fcntl(3, F_GETFL)                       = 0x38800 (flags O_RDONLY|O_NONBLOCK|O_LARGEFILE|O_NOFOLLOW|O_DIRECTORY)</span><br><span class="line">fcntl(3, F_SETFD, FD_CLOEXEC)           = 0</span><br><span class="line">fstatfs(3, &#123;f_type=EXT2_SUPER_MAGIC, f_bsize=4096, f_blocks=20510566, f_bfree=15993067, f_bavail=14940434, f_files=5242880, f_ffree=5074130, f_fsid=&#123;val=[3258576323, 2412010735]&#125;, f_namelen=255, f_frsize=4096, f_flags=ST_VALID|ST_RELATIME&#125;) = 0</span><br><span class="line">fcntl(3, F_DUPFD_CLOEXEC, 3)            = 4</span><br><span class="line">getdents64(3, /* 3 entries */, 32768)   = 72</span><br><span class="line">getdents64(3, /* 0 entries */, 32768)   = 0</span><br><span class="line">close(3)                                = 0</span><br><span class="line">unlinkat(4, &quot;file&quot;, 0)                  = -1 EPERM (Operation not permitted)</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/share/locale/locale.alias&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=2996, ...&#125;) = 0</span><br><span class="line">read(3, &quot;# Locale name alias data base.\n#&quot;..., 4096) = 2996</span><br><span class="line">read(3, &quot;&quot;, 4096)                       = 0</span><br><span class="line">close(3)                                = 0</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/share/locale/en_US.UTF-8/LC_MESSAGES/coreutils.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/share/locale/en_US.utf8/LC_MESSAGES/coreutils.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/share/locale/en_US/LC_MESSAGES/coreutils.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/share/locale/en.UTF-8/LC_MESSAGES/coreutils.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/share/locale/en.utf8/LC_MESSAGES/coreutils.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/share/locale/en/LC_MESSAGES/coreutils.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/share/locale-langpack/en_US.UTF-8/LC_MESSAGES/coreutils.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/share/locale-langpack/en_US.utf8/LC_MESSAGES/coreutils.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/share/locale-langpack/en_US/LC_MESSAGES/coreutils.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/share/locale-langpack/en.UTF-8/LC_MESSAGES/coreutils.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/share/locale-langpack/en.utf8/LC_MESSAGES/coreutils.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/share/locale-langpack/en/LC_MESSAGES/coreutils.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">write(2, &quot;rm: &quot;, 4)                     = 4</span><br><span class="line">write(2, &quot;cannot remove &#x27;dir/file&#x27;&quot;, 24) = 24</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/share/locale/en_US.UTF-8/LC_MESSAGES/libc.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/share/locale/en_US.utf8/LC_MESSAGES/libc.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/share/locale/en_US/LC_MESSAGES/libc.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/share/locale/en.UTF-8/LC_MESSAGES/libc.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/share/locale/en.utf8/LC_MESSAGES/libc.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/share/locale/en/LC_MESSAGES/libc.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/share/locale-langpack/en_US.UTF-8/LC_MESSAGES/libc.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/share/locale-langpack/en_US.utf8/LC_MESSAGES/libc.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/share/locale-langpack/en_US/LC_MESSAGES/libc.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/share/locale-langpack/en.UTF-8/LC_MESSAGES/libc.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/share/locale-langpack/en.utf8/LC_MESSAGES/libc.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/share/locale-langpack/en/LC_MESSAGES/libc.mo&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">write(2, &quot;: Operation not permitted&quot;, 25) = 25</span><br><span class="line">write(2, &quot;\n&quot;, 1)                       = 1</span><br><span class="line">close(4)                                = 0</span><br><span class="line">lseek(0, 0, SEEK_CUR)                   = -1 ESPIPE (Illegal seek)</span><br><span class="line">close(0)                                = 0</span><br><span class="line">close(1)                                = 0</span><br><span class="line">close(2)                                = 0</span><br><span class="line">exit_group(1)                           = ?</span><br><span class="line">+++ exited with 1 +++</span><br></pre></td></tr></table></figure>

<p>æœ€åå–æ¶ˆæ–‡ä»¶çš„æƒé™ï¼Œçœ‹ä¸€ä¸‹ <code>rm -rf</code> æˆåŠŸæ—¶çš„ç³»ç»Ÿè°ƒç”¨</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo chattr -i dir/file</span><br><span class="line">strace -o rm_rf_succ.strace rm -rf dir/</span><br></pre></td></tr></table></figure>

<p><code>strace</code> æŠ“åˆ°çš„å†…å®¹å¦‚ä¸‹ï¼Œä¸»è¦å†…å®¹åœ¨ç¬¬ 39-57 è¡Œ</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">execve(&quot;/usr/bin/rm&quot;, [&quot;rm&quot;, &quot;-rf&quot;, &quot;dir/&quot;], 0x7ffee56569a0 /* 26 vars */) = 0</span><br><span class="line">brk(NULL)                               = 0x55cc9fc1d000</span><br><span class="line">arch_prctl(0x3001 /* ARCH_??? */, 0x7ffec41c6210) = -1 EINVAL (Invalid argument)</span><br><span class="line">access(&quot;/etc/ld.so.preload&quot;, R_OK)      = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, &quot;/etc/ld.so.cache&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=46019, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 46019, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7f771df9d000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">openat(AT_FDCWD, &quot;/lib/x86_64-linux-gnu/libc.so.6&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">read(3, &quot;\177ELF\2\1\1\3\0\0\0\0\0\0\0\0\3\0&gt;\0\1\0\0\0\360q\2\0\0\0\0\0&quot;..., 832) = 832</span><br><span class="line">pread64(3, &quot;\6\0\0\0\4\0\0\0@\0\0\0\0\0\0\0@\0\0\0\0\0\0\0@\0\0\0\0\0\0\0&quot;..., 784, 64) = 784</span><br><span class="line">pread64(3, &quot;\4\0\0\0\20\0\0\0\5\0\0\0GNU\0\2\0\0\300\4\0\0\0\3\0\0\0\0\0\0\0&quot;, 32, 848) = 32</span><br><span class="line">pread64(3, &quot;\4\0\0\0\24\0\0\0\3\0\0\0GNU\0\t\233\222%\274\260\320\31\331\326\10\204\276X&gt;\263&quot;..., 68, 880) = 68</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0755, st_size=2029224, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7f771df9b000</span><br><span class="line">pread64(3, &quot;\6\0\0\0\4\0\0\0@\0\0\0\0\0\0\0@\0\0\0\0\0\0\0@\0\0\0\0\0\0\0&quot;..., 784, 64) = 784</span><br><span class="line">pread64(3, &quot;\4\0\0\0\20\0\0\0\5\0\0\0GNU\0\2\0\0\300\4\0\0\0\3\0\0\0\0\0\0\0&quot;, 32, 848) = 32</span><br><span class="line">pread64(3, &quot;\4\0\0\0\24\0\0\0\3\0\0\0GNU\0\t\233\222%\274\260\320\31\331\326\10\204\276X&gt;\263&quot;..., 68, 880) = 68</span><br><span class="line">mmap(NULL, 2036952, PROT_READ, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0x7f771dda9000</span><br><span class="line">mprotect(0x7f771ddce000, 1847296, PROT_NONE) = 0</span><br><span class="line">mmap(0x7f771ddce000, 1540096, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x25000) = 0x7f771ddce000</span><br><span class="line">mmap(0x7f771df46000, 303104, PROT_READ, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x19d000) = 0x7f771df46000</span><br><span class="line">mmap(0x7f771df91000, 24576, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x1e7000) = 0x7f771df91000</span><br><span class="line">mmap(0x7f771df97000, 13528, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_ANONYMOUS, -1, 0) = 0x7f771df97000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">arch_prctl(ARCH_SET_FS, 0x7f771df9c580) = 0</span><br><span class="line">mprotect(0x7f771df91000, 12288, PROT_READ) = 0</span><br><span class="line">mprotect(0x55cc9ec06000, 4096, PROT_READ) = 0</span><br><span class="line">mprotect(0x7f771dfd6000, 4096, PROT_READ) = 0</span><br><span class="line">munmap(0x7f771df9d000, 46019)           = 0</span><br><span class="line">brk(NULL)                               = 0x55cc9fc1d000</span><br><span class="line">brk(0x55cc9fc3e000)                     = 0x55cc9fc3e000</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/lib/locale/locale-archive&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=3035952, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 3035952, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7f771dac3000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">ioctl(0, TCGETS, &#123;B38400 opost isig icanon echo ...&#125;) = 0</span><br><span class="line">lstat(&quot;/&quot;, &#123;st_mode=S_IFDIR|0755, st_size=4096, ...&#125;) = 0</span><br><span class="line">newfstatat(AT_FDCWD, &quot;dir/&quot;, &#123;st_mode=S_IFDIR|0775, st_size=4096, ...&#125;, AT_SYMLINK_NOFOLLOW) = 0</span><br><span class="line">openat(AT_FDCWD, &quot;dir/&quot;, O_RDONLY|O_NOCTTY|O_NONBLOCK|O_NOFOLLOW|O_DIRECTORY) = 3</span><br><span class="line">fstat(3, &#123;st_mode=S_IFDIR|0775, st_size=4096, ...&#125;) = 0</span><br><span class="line">fcntl(3, F_GETFL)                       = 0x38800 (flags O_RDONLY|O_NONBLOCK|O_LARGEFILE|O_NOFOLLOW|O_DIRECTORY)</span><br><span class="line">fcntl(3, F_SETFD, FD_CLOEXEC)           = 0</span><br><span class="line">getdents64(3, /* 3 entries */, 32768)   = 72</span><br><span class="line">close(3)                                = 0</span><br><span class="line">openat(AT_FDCWD, &quot;dir/&quot;, O_RDONLY|O_NOCTTY|O_NONBLOCK|O_NOFOLLOW|O_CLOEXEC|O_DIRECTORY) = 3</span><br><span class="line">fstat(3, &#123;st_mode=S_IFDIR|0775, st_size=4096, ...&#125;) = 0</span><br><span class="line">fcntl(3, F_GETFL)                       = 0x38800 (flags O_RDONLY|O_NONBLOCK|O_LARGEFILE|O_NOFOLLOW|O_DIRECTORY)</span><br><span class="line">fcntl(3, F_SETFD, FD_CLOEXEC)           = 0</span><br><span class="line">fstatfs(3, &#123;f_type=EXT2_SUPER_MAGIC, f_bsize=4096, f_blocks=20510566, f_bfree=15993064, f_bavail=14940431, f_files=5242880, f_ffree=5074129, f_fsid=&#123;val=[3258576323, 2412010735]&#125;, f_namelen=255, f_frsize=4096, f_flags=ST_VALID|ST_RELATIME&#125;) = 0</span><br><span class="line">fcntl(3, F_DUPFD_CLOEXEC, 3)            = 4</span><br><span class="line">getdents64(3, /* 3 entries */, 32768)   = 72</span><br><span class="line">getdents64(3, /* 0 entries */, 32768)   = 0</span><br><span class="line">close(3)                                = 0</span><br><span class="line">unlinkat(4, &quot;file&quot;, 0)                  = 0</span><br><span class="line">close(4)                                = 0</span><br><span class="line">unlinkat(AT_FDCWD, &quot;dir/&quot;, AT_REMOVEDIR) = 0</span><br><span class="line">lseek(0, 0, SEEK_CUR)                   = -1 ESPIPE (Illegal seek)</span><br><span class="line">close(0)                                = 0</span><br><span class="line">close(1)                                = 0</span><br><span class="line">close(2)                                = 0</span><br><span class="line">exit_group(0)                           = ?</span><br><span class="line">+++ exited with 0 +++</span><br></pre></td></tr></table></figure>

<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul>
<li><a href="https://community.mellanox.com/s/article/howto-configure-nvme-over-fabrics">ã€mellanox ç¤¾åŒºã€‘HowTo Configure NVMe over Fabrics</a></li>
<li><a href="https://open.tech2real.com/info_detail_page?id=18441">ã€ç¡¬è§ã€‘NVMe-oF ä¸åªæ˜¯ RDMAï¼Œè¿˜æœ‰ TCP</a></li>
<li><a href="https://blog.csdn.net/codedancing/article/details/103835085">ã€CSDNã€‘Linux é˜²æ­¢æ–‡ä»¶å’Œç›®å½•è¢«æ„å¤–åˆ é™¤æˆ–ä¿®æ”¹</a></li>
<li><a href="https://man7.org/linux/man-pages/man2/open.2.html">ã€manã€‘open</a></li>
<li><a href="https://unix.stackexchange.com/questions/150960/why-are-rmdir-and-unlink-two-separate-system-calls">ã€stackexchangeã€‘Why are rmdir and unlink two separate system calls?</a></li>
</ul>
]]></content>
      <categories>
        <category>Linux</category>
        <category>Shell</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>strace</tag>
      </tags>
  </entry>
  <entry>
    <title>page cache ç®€ä»‹</title>
    <url>/posts/9ba60726.html</url>
    <content><![CDATA[<p>å½“å‰å†…å®¹åŸºäº Linux Kernel <a href="https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/tag/?h=v5.4.121">v5.4.121</a></p>
<h2 id="page-cache"><a href="#page-cache" class="headerlink" title="page cache"></a>page cache</h2><p>ç”±äºç£ç›˜ HDD ç”šè‡³äºç°åœ¨å¹¿æ³›ä½¿ç”¨çš„å›ºæ€ç¡¬ç›˜ SSD çš„è¯»å†™é€Ÿåº¦éƒ½è¿œå°äºå†…å­˜ DRAM çš„è¯»å†™é€Ÿåº¦ï¼Œä¸ºäº†é¿å…æ¯æ¬¡è¯»å–æ•°æ®éƒ½è¦ç›´æ¥è®¿é—®è¿™äº›ä½é€Ÿçš„åº•å±‚å­˜å‚¨è®¾å¤‡ï¼ŒLinux åœ¨åˆ©ç”¨ DRAM å®ç°äº†ä¸€ä¸ªç¼“å­˜å±‚ï¼Œç¼“å­˜çš„ç²’åº¦æ˜¯ pageï¼Œå› æ­¤ä¹Ÿå« page cacheï¼Œä¸­æ–‡ä¸€èˆ¬ç§°ä¸ºé¡µï¼ˆé¢ï¼‰ç¼“å­˜</p>
<span id="more"></span>
<p>ç»è¿‡è¿™å±‚ page cache çš„ä½œç”¨ï¼ŒIO çš„æ€§èƒ½å¾—åˆ°äº†æ˜¾è‘—çš„æå‡ã€‚ä¸è¿‡ç”±äº DRAM å…·æœ‰æ˜“å¤±æ€§ï¼Œåœ¨æ‰ç”µåæ•°æ®ä¼šä¸¢å¤±ï¼Œå› æ­¤å†…æ ¸ä¸­çš„ <a href="/posts/646202b9.html">å›å†™æœºåˆ¶</a> å®šæ—¶å°† page cache ä¸­çš„æ•°æ®ä¸‹åˆ·åˆ°è®¾å¤‡ä¸Šï¼Œä¿è¯æ•°æ®çš„æŒä¹…åŒ–ã€‚æ­¤å¤–å†…æ ¸è¿˜åœ¨ page cache ä¸­å®ç°äº†å·§å¦™çš„ <a href="/TODO">é¢„è¯»æœºåˆ¶</a> æå‡äº†é¡ºåºè¯»æ€§èƒ½</p>
<h2 id="ç›´æ¥-IO-ä¸-ç¼“å­˜-IO"><a href="#ç›´æ¥-IO-ä¸-ç¼“å­˜-IO" class="headerlink" title="ç›´æ¥ IO ä¸ ç¼“å­˜ IO"></a>ç›´æ¥ IO ä¸ ç¼“å­˜ IO</h2><p>åœ¨æ‹¥æœ‰ page cache è¿™ä¸€å±‚ç¼“å­˜åï¼Œå†™æ•°æ®å°±æœ‰äº†ä¸‰ç§ä¸åŒçš„ç­–ç•¥ï¼š</p>
<ol>
<li>ä¸ç»è¿‡ç¼“å­˜ï¼Œç›´æ¥å†™åº•å±‚å­˜å‚¨è®¾å¤‡ï¼Œä½†åŒæ—¶è¦ä½¿ç¼“å­˜ä¸­æ•°æ®å¤±æ•ˆï¼Œä¹Ÿå«ä¸ç¼“å­˜ï¼ˆnowriteï¼‰</li>
<li>åªå†™ç¼“å­˜ï¼Œç¼“å­˜ä¸­æ•°æ®å®šæœŸåˆ·åˆ°åº•å±‚å­˜å‚¨è®¾å¤‡ä¸Šï¼Œä¹Ÿå«å†™å›ï¼ˆwrite backï¼‰</li>
<li>åŒæ—¶å†™ç¼“å­˜å’Œåº•å±‚å­˜å‚¨è®¾å¤‡ï¼Œä¹Ÿå«å†™ç©¿ï¼ˆwrite throughï¼‰</li>
</ol>
<p>å‰ä¸¤ç§å°±æ˜¯ Linux åœ¨ IO æ ˆä¸­æ”¯æŒçš„ç›´æ¥ IOï¼ˆdirect IOï¼‰å’Œç¼“å­˜ IOï¼ˆbuffer IOï¼‰</p>
<p>ç¬¬ä¸‰ç§ç­–ç•¥è™½ç„¶èƒ½éå¸¸ç®€å•ä¿è¯ç¼“å­˜å’Œåº•å±‚è®¾å¤‡çš„ä¸€è‡´æ€§ï¼Œä¸è¿‡åŸºäºæ—¶é—´å±€éƒ¨æ€§åŸç†ï¼Œpage cache ä¸­çš„æ•°æ®å¯èƒ½åªæ˜¯ä¸­é—´æ€ï¼Œä¼šè¢«é¢‘ç¹ä¿®æ”¹ï¼Œæ¯æ¬¡å†™ç©¿ä¼šäº§ç”Ÿå¤§é‡çš„å¼€é”€</p>
<h2 id="Linux-IO-æ ˆ"><a href="#Linux-IO-æ ˆ" class="headerlink" title="Linux IO æ ˆ"></a>Linux IO æ ˆ</h2><p>è¯¦ç»†çš„ Linux IO æ ˆå›¾å¦‚ä¸‹ï¼ˆæ¥æºäº <a href="https://www.thomas-krenn.com/en/wiki/Linux_Storage_Stack_Diagram">Thomas-Krenn-Wiki</a>ï¼‰ï¼š</p>
<p><img data-src="/posts/9ba60726/Linux-storage-stack-diagram_v4.10.png" alt="Linux-storage-stack-diagram"></p>
<p>å…¶å®ç®€åŒ–ä¸€ä¸‹ï¼Œå¯ä»¥åˆ†ä¸ºæ–‡ä»¶ç³»ç»Ÿã€å—å±‚å’Œè®¾å¤‡é©±åŠ¨å±‚è¿™ä¸‰å±‚</p>
<p><img data-src="/posts/9ba60726/simple_IO_stack.png" alt="simple_IO_stack"></p>
<h2 id="Linux-ä¸­çš„å…·ä½“å®ç°"><a href="#Linux-ä¸­çš„å…·ä½“å®ç°" class="headerlink" title="Linux ä¸­çš„å…·ä½“å®ç°"></a>Linux ä¸­çš„å…·ä½“å®ç°</h2><p>è¿™é‡Œä»‹ç»å’Œ page cache ç›¸å…³çš„ä¸»è¦ç»“æ„ä½“å’Œä¸€äº›å¸¸ç”¨çš„å‡½æ•°</p>
<h3 id="ç›¸å…³ç»“æ„ä½“"><a href="#ç›¸å…³ç»“æ„ä½“" class="headerlink" title="ç›¸å…³ç»“æ„ä½“"></a>ç›¸å…³ç»“æ„ä½“</h3><h4 id="è¶…çº§å—-super-block"><a href="#è¶…çº§å—-super-block" class="headerlink" title="è¶…çº§å— super_block"></a>è¶…çº§å— <code>super_block</code></h4><p>æ¯ä¸ªæ–‡ä»¶ç³»ç»Ÿéƒ½æœ‰ <code>super_block</code> ç»“æ„ä½“ï¼Œç”¨äºå­˜å‚¨è¯¥æ–‡ä»¶ç³»ç»Ÿçš„ç‰¹å®šä¿¡æ¯</p>
<p>å…¶å®šä¹‰åœ¨ <code>include/linux/fs.h</code> ä¸­</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">super_block</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">s_list</span>;</span>		<span class="comment">/* Keep this first */</span></span><br><span class="line">	<span class="keyword">dev_t</span>			s_dev;		<span class="comment">/* search index; _not_ kdev_t */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span>		s_blocksize_bits;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>		s_blocksize;</span><br><span class="line">	<span class="keyword">loff_t</span>			s_maxbytes;	<span class="comment">/* Max file size */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">file_system_type</span>	*<span class="title">s_type</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">super_operations</span>	*<span class="title">s_op</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">dquot_operations</span>	*<span class="title">dq_op</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">quotactl_ops</span>	*<span class="title">s_qcop</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">export_operations</span> *<span class="title">s_export_op</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>		s_flags;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>		s_iflags;	<span class="comment">/* internal SB_I_* flags */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>		s_magic;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dentry</span>		*<span class="title">s_root</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rw_semaphore</span>	<span class="title">s_umount</span>;</span></span><br><span class="line">	<span class="keyword">int</span>			s_count;</span><br><span class="line">	<span class="keyword">atomic_t</span>		s_active;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SECURITY</span></span><br><span class="line">	<span class="keyword">void</span>                    *s_security;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">xattr_handler</span> **<span class="title">s_xattr</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_FS_ENCRYPTION</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">fscrypt_operations</span>	*<span class="title">s_cop</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">key</span>		*<span class="title">s_master_keys</span>;</span> <span class="comment">/* master crypto keys in use */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_FS_VERITY</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">fsverity_operations</span> *<span class="title">s_vop</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">hlist_bl_head</span>	<span class="title">s_roots</span>;</span>	<span class="comment">/* alternate root dentries for NFS */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">s_mounts</span>;</span>	<span class="comment">/* list of mounts; _not_ for fs use */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">block_device</span>	*<span class="title">s_bdev</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">backing_dev_info</span> *<span class="title">s_bdi</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mtd_info</span>		*<span class="title">s_mtd</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">hlist_node</span>	<span class="title">s_instances</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		s_quota_types;	<span class="comment">/* Bitmask of supported quota types */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">quota_info</span>	<span class="title">s_dquot</span>;</span>	<span class="comment">/* Diskquota specific options */</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sb_writers</span>	<span class="title">s_writers</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Keep s_fs_info, s_time_gran, s_fsnotify_mask, and</span></span><br><span class="line"><span class="comment">	 * s_fsnotify_marks together for cache efficiency. They are frequently</span></span><br><span class="line"><span class="comment">	 * accessed and rarely modified.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">void</span>			*s_fs_info;	<span class="comment">/* Filesystem private info */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Granularity of c/m/atime in ns (cannot be worse than a second) */</span></span><br><span class="line">	u32			s_time_gran;</span><br><span class="line">	<span class="comment">/* Time limits for c/m/atime in seconds */</span></span><br><span class="line">	<span class="keyword">time64_t</span>		   s_time_min;</span><br><span class="line">	<span class="keyword">time64_t</span>		   s_time_max;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_FSNOTIFY</span></span><br><span class="line">	__u32			s_fsnotify_mask;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fsnotify_mark_connector</span> __<span class="title">rcu</span>	*<span class="title">s_fsnotify_marks</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">char</span>			s_id[<span class="number">32</span>];	<span class="comment">/* Informational name */</span></span><br><span class="line">	<span class="keyword">uuid_t</span>			s_uuid;		<span class="comment">/* UUID */</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		s_max_links;</span><br><span class="line">	<span class="keyword">fmode_t</span>			s_mode;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * The next field is for VFS *only*. No filesystems have any business</span></span><br><span class="line"><span class="comment">	 * even looking at it. You had been warned.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">s_vfs_rename_mutex</span>;</span>	<span class="comment">/* Kludge */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Filesystem subtype.  If non-empty the filesystem type field</span></span><br><span class="line"><span class="comment">	 * in /proc/mounts will be &quot;type.subtype&quot;</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *s_subtype;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">dentry_operations</span> *<span class="title">s_d_op</span>;</span> <span class="comment">/* default d_op for dentries */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Saved pool identifier for cleancache (-1 means none)</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">int</span> cleancache_poolid;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">shrinker</span> <span class="title">s_shrink</span>;</span>	<span class="comment">/* per-sb shrinker handle */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Number of inodes with nlink == 0 but still referenced */</span></span><br><span class="line">	<span class="keyword">atomic_long_t</span> s_remove_count;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Pending fsnotify inode refs */</span></span><br><span class="line">	<span class="keyword">atomic_long_t</span> s_fsnotify_inode_refs;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Being remounted read-only */</span></span><br><span class="line">	<span class="keyword">int</span> s_readonly_remount;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* AIO completions deferred from interrupt context */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">workqueue_struct</span> *<span class="title">s_dio_done_wq</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">hlist_head</span> <span class="title">s_pins</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Owning user namespace and default context in which to</span></span><br><span class="line"><span class="comment">	 * interpret filesystem uids, gids, quotas, device nodes,</span></span><br><span class="line"><span class="comment">	 * xattrs and security labels.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">user_namespace</span> *<span class="title">s_user_ns</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * The list_lru structure is essentially just a pointer to a table</span></span><br><span class="line"><span class="comment">	 * of per-node lru lists, each of which has its own spinlock.</span></span><br><span class="line"><span class="comment">	 * There is no need to put them into separate cachelines.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_lru</span>		<span class="title">s_dentry_lru</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_lru</span>		<span class="title">s_inode_lru</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span>		<span class="title">rcu</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">work_struct</span>	<span class="title">destroy_work</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mutex</span>		<span class="title">s_sync_lock</span>;</span>	<span class="comment">/* sync serialisation lock */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Indicates how deep in a filesystem stack this SB is</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">int</span> s_stack_depth;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* s_inode_list_lock protects s_inodes */</span></span><br><span class="line">	<span class="keyword">spinlock_t</span>		s_inode_list_lock ____cacheline_aligned_in_smp;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">s_inodes</span>;</span>	<span class="comment">/* all inodes */</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">spinlock_t</span>		s_inode_wblist_lock;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">s_inodes_wb</span>;</span>	<span class="comment">/* writeback inodes */</span></span><br><span class="line">&#125; __randomize_layout;</span><br></pre></td></tr></table></figure>

<p><code>super_block</code> é€šå¸¸åœ¨æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿæ—¶ä¼šä»åº•å±‚å­˜å‚¨è®¾å¤‡ä¸Šè¯»å–å¹¶æ„å»ºï¼Œå¹¶ä¸”éœ€è¦åŒæ­¥å›åº•å±‚å­˜å‚¨è®¾å¤‡</p>
<h4 id="ç´¢å¼•èŠ‚ç‚¹-inode"><a href="#ç´¢å¼•èŠ‚ç‚¹-inode" class="headerlink" title="ç´¢å¼•èŠ‚ç‚¹ inode"></a>ç´¢å¼•èŠ‚ç‚¹ <code>inode</code></h4><p>è€Œ <code>inode</code> åˆ™æ˜¯æ–‡ä»¶ç³»ç»Ÿä¸­æœ€é‡è¦çš„ä¸€ä¸ªç»“æ„ä½“ï¼Œç”¨äºä¿å­˜ä¸€ä¸ªæ–‡ä»¶çš„å…ƒæ•°æ®ä»¥åŠå…¶åœ¨åº•å±‚è®¾å¤‡ä¸Šçš„ä½ç½®ä¿¡æ¯ç­‰ï¼ˆåœ¨ Linux ä¸‹ä¸€åˆ‡çš†æ˜¯æ–‡ä»¶ï¼Œç›®å½•ä¹Ÿæ˜¯ä¸€ç§æ–‡ä»¶ï¼‰</p>
<p>å…¶å®šä¹‰ä¹Ÿåœ¨ <code>include/linux/fs.h</code> ä¸­</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Keep mostly read-only and often accessed (especially for</span></span><br><span class="line"><span class="comment"> * the RCU path lookup and &#x27;stat&#x27; data) fields at the beginning</span></span><br><span class="line"><span class="comment"> * of the &#x27;struct inode&#x27;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">inode</span> &#123;</span></span><br><span class="line">	<span class="comment">// inode ç±»å‹</span></span><br><span class="line">	<span class="keyword">umode_t</span>			i_mode;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">short</span>		i_opflags;</span><br><span class="line">	<span class="keyword">kuid_t</span>			i_uid;</span><br><span class="line">	<span class="keyword">kgid_t</span>			i_gid;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		i_flags;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_FS_POSIX_ACL</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">posix_acl</span>	*<span class="title">i_acl</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">posix_acl</span>	*<span class="title">i_default_acl</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">inode_operations</span>	*<span class="title">i_op</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">super_block</span>	*<span class="title">i_sb</span>;</span></span><br><span class="line">	<span class="comment">// page cache ç›¸å…³</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">address_space</span>	*<span class="title">i_mapping</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SECURITY</span></span><br><span class="line">	<span class="keyword">void</span>			*i_security;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Stat data, not accessed from path walking */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>		i_ino;</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Filesystems may only read i_nlink directly.  They shall use the</span></span><br><span class="line"><span class="comment">	 * following functions for modification:</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 *    (set|clear|inc|drop)_nlink</span></span><br><span class="line"><span class="comment">	 *    inode_(inc|dec)_link_count</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> i_nlink;</span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">int</span> __i_nlink;</span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="keyword">dev_t</span>			i_rdev;</span><br><span class="line">	<span class="keyword">loff_t</span>			i_size;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">timespec64</span>	<span class="title">i_atime</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">timespec64</span>	<span class="title">i_mtime</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">timespec64</span>	<span class="title">i_ctime</span>;</span></span><br><span class="line">	<span class="keyword">spinlock_t</span>		i_lock;	<span class="comment">/* i_blocks, i_bytes, maybe i_size */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">short</span>          i_bytes;</span><br><span class="line">	u8			i_blkbits;</span><br><span class="line">	u8			i_write_hint;</span><br><span class="line">	<span class="keyword">blkcnt_t</span>		i_blocks;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __NEED_I_SIZE_ORDERED</span></span><br><span class="line">	<span class="keyword">seqcount_t</span>		i_size_seqcount;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Misc */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>		i_state;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rw_semaphore</span>	<span class="title">i_rwsem</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>		dirtied_when;	<span class="comment">/* jiffies of first dirtying */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>		dirtied_time_when;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">hlist_node</span>	<span class="title">i_hash</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">i_io_list</span>;</span>	<span class="comment">/* backing dev IO list */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_CGROUP_WRITEBACK</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">bdi_writeback</span>	*<span class="title">i_wb</span>;</span>		<span class="comment">/* the associated cgroup wb */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* foreign inode detection, see wbc_detach_inode() */</span></span><br><span class="line">	<span class="keyword">int</span>			i_wb_frn_winner;</span><br><span class="line">	u16			i_wb_frn_avg_time;</span><br><span class="line">	u16			i_wb_frn_history;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">i_lru</span>;</span>		<span class="comment">/* inode LRU list */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">i_sb_list</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">i_wb_list</span>;</span>	<span class="comment">/* backing dev writeback list */</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">hlist_head</span>	<span class="title">i_dentry</span>;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span>		<span class="title">i_rcu</span>;</span></span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="keyword">atomic64_t</span>		i_version;</span><br><span class="line">	<span class="keyword">atomic64_t</span>		i_sequence; <span class="comment">/* see futex */</span></span><br><span class="line">	<span class="keyword">atomic_t</span>		i_count;</span><br><span class="line">	<span class="keyword">atomic_t</span>		i_dio_count;</span><br><span class="line">	<span class="keyword">atomic_t</span>		i_writecount;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(CONFIG_IMA) || defined(CONFIG_FILE_LOCKING)</span></span><br><span class="line">	<span class="keyword">atomic_t</span>		i_readcount; <span class="comment">/* struct files open RO */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span>	*<span class="title">i_fop</span>;</span>	<span class="comment">/* former -&gt;i_op-&gt;default_file_ops */</span></span><br><span class="line">		<span class="keyword">void</span> (*free_inode)(struct inode *);</span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">file_lock_context</span>	*<span class="title">i_flctx</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">address_space</span>	<span class="title">i_data</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">i_devices</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">pipe_inode_info</span>	*<span class="title">i_pipe</span>;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">block_device</span>	*<span class="title">i_bdev</span>;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">cdev</span>		*<span class="title">i_cdev</span>;</span></span><br><span class="line">		<span class="keyword">char</span>			*i_link;</span><br><span class="line">		<span class="keyword">unsigned</span>		i_dir_seq;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	__u32			i_generation;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_FSNOTIFY</span></span><br><span class="line">	__u32			i_fsnotify_mask; <span class="comment">/* all events this inode cares about */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fsnotify_mark_connector</span> __<span class="title">rcu</span>	*<span class="title">i_fsnotify_marks</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_FS_ENCRYPTION</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fscrypt_info</span>	*<span class="title">i_crypt_info</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_FS_VERITY</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fsverity_info</span>	*<span class="title">i_verity_info</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">void</span>			*i_private; <span class="comment">/* fs or device private pointer */</span></span><br><span class="line">&#125; __randomize_layout;</span><br></pre></td></tr></table></figure>

<p>ä¸ <code>super_block</code> ä¸€æ ·ï¼Œ<code>inode</code> ä¹Ÿæ˜¯ä»åº•å±‚å­˜å‚¨è®¾å¤‡ä¸Šè¯»å–å¹¶æ„å»ºçš„ï¼Œå¹¶ä¸”ä¹Ÿéœ€è¦åŒæ­¥å›åº•å±‚å­˜å‚¨è®¾å¤‡</p>
<h4 id="æ–‡ä»¶-file"><a href="#æ–‡ä»¶-file" class="headerlink" title="æ–‡ä»¶ file"></a>æ–‡ä»¶ <code>file</code></h4><p><code>file</code> å…¶å®æ˜¯å·²ç»æ‰“å¼€çš„åº•å±‚å­˜å‚¨è®¾å¤‡ä¸Šçš„æ–‡ä»¶åœ¨å†…å­˜ä¸­çš„è¡¨ç¤ºã€‚ä¸å‰é¢ä¸¤ä¸ªç»“æ„ä½“æœ‰æ‰€ä¸åŒï¼Œåº•å±‚å­˜å‚¨è®¾å¤‡ä¸Šå¹¶ä¸ä¼šå­˜å‚¨ï¼Œè¯¥ç»“æ„ä½“åªæ˜¯å†…æ ¸æŠ½è±¡å‡ºæ¥çš„ï¼Œä»…ä»…å­˜åœ¨äºå†…å­˜ä¸­ï¼Œæ–¹ä¾¿ç®¡ç†</p>
<p>å…¶å®šä¹‰ä¹Ÿåœ¨ <code>include/linux/fs.h</code> ä¸­</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">llist_node</span>	<span class="title">fu_llist</span>;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span> 	<span class="title">fu_rcuhead</span>;</span></span><br><span class="line">	&#125; f_u;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">path</span>		<span class="title">f_path</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">inode</span>		*<span class="title">f_inode</span>;</span>	<span class="comment">/* cached value */</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span>	*<span class="title">f_op</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Protects f_ep_links, f_flags.</span></span><br><span class="line"><span class="comment">	 * Must not be taken from IRQ context.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">spinlock_t</span>		f_lock;</span><br><span class="line">	<span class="class"><span class="keyword">enum</span> <span class="title">rw_hint</span>		<span class="title">f_write_hint</span>;</span></span><br><span class="line">	<span class="keyword">atomic_long_t</span>		f_count;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> 		f_flags;</span><br><span class="line">	<span class="keyword">fmode_t</span>			f_mode;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mutex</span>		<span class="title">f_pos_lock</span>;</span></span><br><span class="line">	<span class="keyword">loff_t</span>			f_pos;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fown_struct</span>	<span class="title">f_owner</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span>	*<span class="title">f_cred</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">file_ra_state</span>	<span class="title">f_ra</span>;</span></span><br><span class="line"></span><br><span class="line">	u64			f_version;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SECURITY</span></span><br><span class="line">	<span class="keyword">void</span>			*f_security;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="comment">/* needed for tty driver, and maybe others */</span></span><br><span class="line">	<span class="keyword">void</span>			*private_data;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_EPOLL</span></span><br><span class="line">	<span class="comment">/* Used by fs/eventpoll.c to link all the hooks to this file */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">f_ep_links</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">f_tfile_llink</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* #ifdef CONFIG_EPOLL */</span></span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">address_space</span>	*<span class="title">f_mapping</span>;</span></span><br><span class="line">	<span class="keyword">errseq_t</span>		f_wb_err;</span><br><span class="line">&#125; __randomize_layout</span><br><span class="line">  __attribute__((aligned(<span class="number">4</span>)));	<span class="comment">/* lest something weird decides that 2 is OK */</span></span><br></pre></td></tr></table></figure>

<p>æ¯ä¸ª file éƒ½ä¸ä¸€ä¸ª inode å¯¹åº”</p>
<h4 id="ç›®å½•é¡¹-dentry"><a href="#ç›®å½•é¡¹-dentry" class="headerlink" title="ç›®å½•é¡¹ dentry"></a>ç›®å½•é¡¹ <code>dentry</code></h4><p><code>dentry</code> ä¸ <code>file</code> ç±»ä¼¼ï¼Œåº•å±‚è®¾å¤‡ä¸Šå¹¶ä¸ä¼šå­˜å‚¨ï¼Œè¯¥ç»“æ„ä½“ä¹Ÿæ˜¯å†…æ ¸æŠ½è±¡å‡ºæ¥çš„ï¼Œé’ˆå¯¹ç›®å½•æ–‡ä»¶è¿›è¡Œç‰¹æ®Šçš„ç®¡ç†</p>
<p>ç›®å½•é¡¹ç›¸å¯¹äºæ–‡ä»¶å…·æœ‰æ›´é«˜çš„çƒ­åº¦ï¼ŒåŒæ—¶ä¸ºäº†åŠ é€Ÿæ‰“å¼€æ–‡ä»¶æ—¶çš„è·¯å¾„è§£æï¼Œå†…æ ¸ä¸­è¿˜å®ç°äº†ç›®å½•é¡¹ç¼“å­˜ <code>dcache</code> ç”¨äºç¼“å­˜ <code>dentry</code></p>
<p>å…¶å®šä¹‰åœ¨ <code>include/linux/dcache.h</code> ä¸­</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> &#123;</span></span><br><span class="line">	<span class="comment">/* RCU lookup touched fields */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> d_flags;		<span class="comment">/* protected by d_lock */</span></span><br><span class="line">	<span class="keyword">seqcount_t</span> d_seq;		<span class="comment">/* per dentry seqlock */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">hlist_bl_node</span> <span class="title">d_hash</span>;</span>	<span class="comment">/* lookup hash list */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> *<span class="title">d_parent</span>;</span>	<span class="comment">/* parent directory */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">qstr</span> <span class="title">d_name</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *<span class="title">d_inode</span>;</span>		<span class="comment">/* Where the name belongs to - NULL is</span></span><br><span class="line"><span class="comment">					 * negative */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> d_iname[DNAME_INLINE_LEN];	<span class="comment">/* small names */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Ref lookup also touches following */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">lockref</span> <span class="title">d_lockref</span>;</span>	<span class="comment">/* per-dentry lock and refcount */</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">dentry_operations</span> *<span class="title">d_op</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">super_block</span> *<span class="title">d_sb</span>;</span>	<span class="comment">/* The root of the dentry tree */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> d_time;		<span class="comment">/* used by d_revalidate */</span></span><br><span class="line">	<span class="keyword">void</span> *d_fsdata;			<span class="comment">/* fs-specific data */</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">d_lru</span>;</span>		<span class="comment">/* LRU list */</span></span><br><span class="line">		<span class="keyword">wait_queue_head_t</span> *d_wait;	<span class="comment">/* in-lookup ones only */</span></span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">d_child</span>;</span>	<span class="comment">/* child of parent list */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">d_subdirs</span>;</span>	<span class="comment">/* our children */</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * d_alias and d_rcu can share memory</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">hlist_node</span> <span class="title">d_alias</span>;</span>	<span class="comment">/* inode alias list */</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">hlist_bl_node</span> <span class="title">d_in_lookup_hash</span>;</span>	<span class="comment">/* only for in-lookup ones */</span></span><br><span class="line">	 	<span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span> <span class="title">d_rcu</span>;</span></span><br><span class="line">	&#125; d_u;</span><br><span class="line">&#125; __randomize_layout;</span><br></pre></td></tr></table></figure>

<p>å› ä¸ºç›®å½•ä¹Ÿæ˜¯æ–‡ä»¶ï¼Œæ‰€ä»¥æ¯ä¸ª <code>dentry</code> ä¹Ÿä¼šä¸ä¸€ä¸ª <code>inode</code> å¯¹åº”</p>
<h4 id="é¡µç¼“å­˜-address-space"><a href="#é¡µç¼“å­˜-address-space" class="headerlink" title="é¡µç¼“å­˜ address_space"></a>é¡µç¼“å­˜ <code>address_space</code></h4><p>åœ¨ <code>inode</code> ç»“æ„ä½“ä¸­å¯ä»¥çœ‹è§ä¸€ä¸ªç±»å‹ä¸º <code>address_space</code> ç»“æ„ä½“æŒ‡é’ˆçš„ <code>i_mapping</code> å­—æ®µï¼Œå…¶å®å®ƒå°±æ˜¯ page cache çš„æ ¸å¿ƒç»“æ„ä½“</p>
<p>å…¶å®šä¹‰ä¹Ÿåœ¨ <code>include/linux/fs.h</code> ä¸­</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * struct address_space - Contents of a cacheable, mappable object.</span></span><br><span class="line"><span class="comment"> * @host: Owner, either the inode or the block_device.</span></span><br><span class="line"><span class="comment"> * @i_pages: Cached pages.</span></span><br><span class="line"><span class="comment"> * @gfp_mask: Memory allocation flags to use for allocating pages.</span></span><br><span class="line"><span class="comment"> * @i_mmap_writable: Number of VM_SHARED mappings.</span></span><br><span class="line"><span class="comment"> * @nr_thps: Number of THPs in the pagecache (non-shmem only).</span></span><br><span class="line"><span class="comment"> * @i_mmap: Tree of private and shared mappings.</span></span><br><span class="line"><span class="comment"> * @i_mmap_rwsem: Protects @i_mmap and @i_mmap_writable.</span></span><br><span class="line"><span class="comment"> * @nrpages: Number of page entries, protected by the i_pages lock.</span></span><br><span class="line"><span class="comment"> * @nrexceptional: Shadow or DAX entries, protected by the i_pages lock.</span></span><br><span class="line"><span class="comment"> * @writeback_index: Writeback starts here.</span></span><br><span class="line"><span class="comment"> * @a_ops: Methods.</span></span><br><span class="line"><span class="comment"> * @flags: Error bits and flags (AS_*).</span></span><br><span class="line"><span class="comment"> * @wb_err: The most recent error which has occurred.</span></span><br><span class="line"><span class="comment"> * @private_lock: For use by the owner of the address_space.</span></span><br><span class="line"><span class="comment"> * @private_list: For use by the owner of the address_space.</span></span><br><span class="line"><span class="comment"> * @private_data: For use by the owner of the address_space.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">address_space</span> &#123;</span></span><br><span class="line">	<span class="comment">// æŒ‡å‘æ–‡ä»¶ inode</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">inode</span>		*<span class="title">host</span>;</span></span><br><span class="line">	<span class="comment">// å½“å‰æ–‡ä»¶ç¼“å­˜çš„æ‰€æœ‰ page</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">xarray</span>		<span class="title">i_pages</span>;</span></span><br><span class="line">	<span class="keyword">gfp_t</span>			gfp_mask;</span><br><span class="line">	<span class="keyword">atomic_t</span>		i_mmap_writable;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_READ_ONLY_THP_FOR_FS</span></span><br><span class="line">	<span class="comment">/* number of thp, only for non-shmem files */</span></span><br><span class="line">	<span class="keyword">atomic_t</span>		nr_thps;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rb_root_cached</span>	<span class="title">i_mmap</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rw_semaphore</span>	<span class="title">i_mmap_rwsem</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>		nrpages;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>		nrexceptional;</span><br><span class="line">	<span class="keyword">pgoff_t</span>			writeback_index;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">address_space_operations</span> *<span class="title">a_ops</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>		flags;</span><br><span class="line">	<span class="keyword">errseq_t</span>		wb_err;</span><br><span class="line">	<span class="keyword">spinlock_t</span>		private_lock;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">private_list</span>;</span></span><br><span class="line">	<span class="keyword">void</span>			*private_data;</span><br><span class="line">&#125; __attribute__((aligned(<span class="keyword">sizeof</span>(<span class="keyword">long</span>)))) __randomize_layout;</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * On most architectures that alignment is already the case; but</span></span><br><span class="line"><span class="comment">	 * must be enforced here for CRIS, to let the least significant bit</span></span><br><span class="line"><span class="comment">	 * of struct page&#x27;s &quot;mapping&quot; pointer be used for PAGE_MAPPING_ANON.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">request_queue</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">block_device</span> &#123;</span></span><br><span class="line">	<span class="keyword">dev_t</span>			bd_dev;  <span class="comment">/* not a kdev_t - it&#x27;s a search key */</span></span><br><span class="line">	<span class="keyword">int</span>			bd_openers;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *		<span class="title">bd_inode</span>;</span>	<span class="comment">/* will die */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">super_block</span> *	<span class="title">bd_super</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mutex</span>		<span class="title">bd_mutex</span>;</span>	<span class="comment">/* open/close mutex */</span></span><br><span class="line">	<span class="keyword">void</span> *			bd_claiming;</span><br><span class="line">	<span class="keyword">void</span> *			bd_holder;</span><br><span class="line">	<span class="keyword">int</span>			bd_holders;</span><br><span class="line">	<span class="keyword">bool</span>			bd_write_holder;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SYSFS</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">bd_holder_disks</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">block_device</span> *	<span class="title">bd_contains</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span>		bd_block_size;</span><br><span class="line">	u8			bd_partno;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">hd_struct</span> *	<span class="title">bd_part</span>;</span></span><br><span class="line">	<span class="comment">/* number of times partitions within this device have been opened. */</span></span><br><span class="line">	<span class="keyword">unsigned</span>		bd_part_count;</span><br><span class="line">	<span class="keyword">int</span>			bd_invalidated;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">gendisk</span> *	<span class="title">bd_disk</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">request_queue</span> *  <span class="title">bd_queue</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">backing_dev_info</span> *<span class="title">bd_bdi</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">bd_list</span>;</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Private data.  You must have bd_claim&#x27;ed the block_device</span></span><br><span class="line"><span class="comment">	 * to use this.  <span class="doctag">NOTE:</span>  bd_claim allows an owner to claim</span></span><br><span class="line"><span class="comment">	 * the same device multiple times, the owner must take special</span></span><br><span class="line"><span class="comment">	 * care to not mess up bd_private for that case.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>		bd_private;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* The counter of freeze processes */</span></span><br><span class="line">	<span class="keyword">int</span>			bd_fsfreeze_count;</span><br><span class="line">	<span class="comment">/* Mutex for freeze */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mutex</span>		<span class="title">bd_fsfreeze_mutex</span>;</span></span><br><span class="line">&#125; __randomize_layout;</span><br></pre></td></tr></table></figure>

<p>æ¯ä¸€ä¸ª <code>address_space</code> ä¸ä¸€ä¸ª <code>inode</code> å¯¹åº”ï¼ŒåŒæ—¶ <code>file</code> ä¸­çš„ <code>f_mapping</code> å­—æ®µé€šå¸¸ç”±è¯¥æ–‡ä»¶çš„ <code>inode</code> ä¸­ <code>i_mapping</code> èµ‹å€¼ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯ä¸ªæ–‡ä»¶éƒ½ä¼šæœ‰ç‹¬è‡ªçš„ <code>file</code>ã€<code>inode</code> ä»¥åŠ <code>address_space</code> ç»“æ„ä½“</p>
<p><code>address_space</code> ç»“æ„ä½“ <code>struct xarray i_pages</code> å°±æ˜¯è¯¥æ–‡ä»¶çš„ page cache ä¸­ç¼“å­˜çš„æ‰€æœ‰ç‰©ç†é¡µã€‚å®ƒæ˜¯é€šè¿‡åŸºæ•°æ ‘è¿™ä¸€ç»“æ„è¿›è¡Œç®¡ç†çš„ï¼Œè€Œ <code>xarray</code> åªæ˜¯åœ¨åŸºæ•°æ ‘ä¸Šè¿›è¡Œäº†ä¸€å±‚å°è£…</p>
<h3 id="å¸¸ç”¨å‡½æ•°"><a href="#å¸¸ç”¨å‡½æ•°" class="headerlink" title="å¸¸ç”¨å‡½æ•°"></a>å¸¸ç”¨å‡½æ•°</h3><p>é€šå¸¸ <code>address_space</code> ä¸Šä¼šæŒ‚è½½ä¸€ä¸ª <code>address_space_operations</code> ç»“æ„ï¼Œç”¨äºè‡ªå®šä¹‰å¯¹ page cache ä¸­çš„é¡µé¢æ“ä½œçš„å‡½æ•°</p>
<p><code>address_space_operations</code> ç»“æ„å®šä¹‰ä¹Ÿåœ¨ <code>include/linux/fs.h</code> ä¸­</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">address_space_operations</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span> (*writepage)(struct page *page, struct writeback_control *wbc);</span><br><span class="line">	<span class="keyword">int</span> (*readpage)(struct file *, struct page *);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Write back some dirty pages from this mapping. */</span></span><br><span class="line">	<span class="keyword">int</span> (*writepages)(struct address_space *, struct writeback_control *);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Set a page dirty.  Return true if this dirtied it */</span></span><br><span class="line">	<span class="keyword">int</span> (*set_page_dirty)(struct page *page);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Reads in the requested pages. Unlike -&gt;readpage(), this is</span></span><br><span class="line"><span class="comment">	 * PURELY used for read-ahead!.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">int</span> (*readpages)(struct file *filp, struct address_space *mapping,</span><br><span class="line">			struct list_head *pages, <span class="keyword">unsigned</span> nr_pages);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> (*write_begin)(struct file *, struct address_space *mapping,</span><br><span class="line">				<span class="keyword">loff_t</span> pos, <span class="keyword">unsigned</span> len, <span class="keyword">unsigned</span> flags,</span><br><span class="line">				struct page **pagep, <span class="keyword">void</span> **fsdata);</span><br><span class="line">	<span class="keyword">int</span> (*write_end)(struct file *, struct address_space *mapping,</span><br><span class="line">				<span class="keyword">loff_t</span> pos, <span class="keyword">unsigned</span> len, <span class="keyword">unsigned</span> copied,</span><br><span class="line">				struct page *page, <span class="keyword">void</span> *fsdata);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Unfortunately this kludge is needed for FIBMAP. Don&#x27;t use it */</span></span><br><span class="line">	<span class="keyword">sector_t</span> (*bmap)(struct address_space *, <span class="keyword">sector_t</span>);</span><br><span class="line">	<span class="keyword">void</span> (*invalidatepage) (struct page *, <span class="keyword">unsigned</span> <span class="keyword">int</span>, <span class="keyword">unsigned</span> <span class="keyword">int</span>);</span><br><span class="line">	<span class="keyword">int</span> (*releasepage) (struct page *, <span class="keyword">gfp_t</span>);</span><br><span class="line">	<span class="keyword">void</span> (*freepage)(struct page *);</span><br><span class="line">	<span class="keyword">ssize_t</span> (*direct_IO)(struct kiocb *, struct iov_iter *iter);</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * migrate the contents of a page to the specified target. If</span></span><br><span class="line"><span class="comment">	 * migrate_mode is MIGRATE_ASYNC, it must not block.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">int</span> (*migratepage) (struct address_space *,</span><br><span class="line">			struct page *, struct page *, <span class="keyword">enum</span> migrate_mode);</span><br><span class="line">	<span class="keyword">bool</span> (*isolate_page)(struct page *, <span class="keyword">isolate_mode_t</span>);</span><br><span class="line">	<span class="keyword">void</span> (*putback_page)(struct page *);</span><br><span class="line">	<span class="keyword">int</span> (*launder_page) (struct page *);</span><br><span class="line">	<span class="keyword">int</span> (*is_partially_uptodate) (struct page *, <span class="keyword">unsigned</span> <span class="keyword">long</span>,</span><br><span class="line">					<span class="keyword">unsigned</span> <span class="keyword">long</span>);</span><br><span class="line">	<span class="keyword">void</span> (*is_dirty_writeback) (struct page *, <span class="keyword">bool</span> *, <span class="keyword">bool</span> *);</span><br><span class="line">	<span class="keyword">int</span> (*error_remove_page)(struct address_space *, struct page *);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* swapfile support */</span></span><br><span class="line">	<span class="keyword">int</span> (*swap_activate)(struct swap_info_struct *sis, struct file *file,</span><br><span class="line">				<span class="keyword">sector_t</span> *span);</span><br><span class="line">	<span class="keyword">void</span> (*swap_deactivate)(struct file *file);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œç®€è¦ä»‹ç»ä¸€ä¸‹å…¶ä¸­é€šç”¨çš„éƒ¨åˆ†å¸¸ç”¨å‡½æ•°</p>
<h4 id="ä»åº•å±‚å¡«å……"><a href="#ä»åº•å±‚å¡«å……" class="headerlink" title="ä»åº•å±‚å¡«å……"></a>ä»åº•å±‚å¡«å……</h4><p>å½“æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶åï¼Œpage cache ä¸ä¼šç«‹å³ç¼“å­˜è¿™ä¸ªæ–‡ä»¶çš„æ‰€æœ‰æ•°æ®é¡µï¼Œè€Œæ˜¯éšç€å¯¹æ–‡ä»¶çš„è¯»å†™æ¥é€æ¸å¡«å……çš„</p>
<p><code>readpage</code> å’Œ <code>readpages</code> å°±æ˜¯å°†åº•å±‚å­˜å‚¨è®¾å¤‡ä¸Šçš„ä¸€ä¸ªæˆ–è€…å¤šä¸ªé¡µçš„æ•°æ®è¯»åˆ° page cache ä¸­</p>
<h4 id="å†™å…¥ä¿®æ”¹"><a href="#å†™å…¥ä¿®æ”¹" class="headerlink" title="å†™å…¥ä¿®æ”¹"></a>å†™å…¥ä¿®æ”¹</h4><p>page cache çš„å†™å…¥è¾ƒä¸ºå¤æ‚ï¼Œä¸»è¦åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼š</p>
<ol>
<li><code>write_begin</code> ä¸»è¦è´Ÿè´£æŸ¥æ‰¾ã€æˆ–è€…åˆ†é…æ–°çš„ç‰©ç†é¡µï¼Œå¹¶å°†å…¶é”å®šï¼Œæœ‰æ—¶è¿˜éœ€è¦å…ˆä»åº•å±‚è¯»å–æœ€æ–°çš„æ•°æ®é¡µ</li>
<li><code>writepage</code> æˆ–è€… <code>writepages</code> å°±æ˜¯è´Ÿè´£å¯¹è¿™äº›ç‰©ç†é¡µçš„å®é™…å†™å…¥è¿‡ç¨‹</li>
<li><code>write_end</code> ä¸»è¦è´Ÿè´£è§£é”è¿™äº›ç‰©ç†é¡µï¼Œå¹¶ä¸”æ›´æ–° <code>inode</code> ä¸­çš„å…ƒæ•°æ®ä¿¡æ¯ï¼Œä¾‹å¦‚ <code>i_size</code></li>
</ol>
<h4 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h4><p><code>direct_IO</code> åˆ™æ˜¯è´Ÿè´£ä¸ç»è¿‡ page cache çš„ç›´æ¥ IO çš„å®ç°</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå½“éœ€è¦è¯»çš„æ•°æ®åœ¨ page cache ä¸­ç¼“å­˜çš„å’Œåº•å±‚å­˜å‚¨æ•°æ®ä¸ä¸€è‡´æ—¶ï¼Œä¹Ÿå°±æ˜¯ <code>page</code> ä¸º <code>dirty</code> çŠ¶æ€æ—¶ï¼Œé€šå¸¸éœ€è¦è°ƒç”¨ <code>filemap_write_and_wait</code> æˆ–è€… <code>filemap_write_and_wait_range</code> å…ˆå°†è¿™éƒ¨åˆ†è„æ•°æ®å†™åˆ°åº•å±‚è®¾å¤‡ä¹‹åï¼Œæ‰èƒ½æ‰§è¡Œ direct read</p>
<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul>
<li><a href="https://www.thomas-krenn.com/en/wiki/Linux_Storage_Stack_Diagram">ã€Thomas-Krenn-Wikiã€‘Linux Storage Stack Diagram</a></li>
<li><a href="https://blog.csdn.net/juS3Ve/article/details/82322637">ã€CSDNã€‘æµ…å¢¨: èŠèŠ Linux IO (ä¸­) â€”â€” Linux å†…æ ¸ä¸­çš„ IO æ ˆ</a></li>
<li><a href="https://www.doc-developpement-durable.org/file/Projets-informatiques/cours-&-manuels-informatiques/Linux/Linux%20Kernel%20Development,%203rd%20Edition.pdf">ã€LKDã€‘Linux Kernel Development (3rd Edition)</a></li>
<li><a href="https://kernel.taobao.org/2018/05/The-XArray-data-structure/">ã€é˜¿é‡Œäº‘æŠ€æœ¯åšå®¢ã€‘The Xarray Data Structure</a></li>
<li><a href="https://lwn.net/Articles/254856/">ã€LWNã€‘Some VFS address space operations changes</a></li>
</ul>
]]></content>
      <categories>
        <category>å­˜å‚¨</category>
        <category>IO</category>
      </categories>
      <tags>
        <tag>page cache</tag>
        <tag>buffer IO</tag>
        <tag>writeback</tag>
      </tags>
  </entry>
  <entry>
    <title>Breed ä»‹ç»ã€åˆ·å…¥å’Œä½¿ç”¨</title>
    <url>/posts/53d6c2d9.html</url>
    <content><![CDATA[<h2 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h2><p>Breed æ˜¯å›½å†…ä¸ªäºº <a href="https://github.com/hackpascal">hackpascal</a> å¼€å‘çš„é—­æº Bootloaderï¼Œä¹Ÿè¢«ç§°ä¸ºâ€œä¸æ­»é¸Ÿâ€</p>
<p>å› ä¸ºæœ‰äº›å®˜æ–¹å‡çº§å›ºä»¶è‡ªå¸¦ bootloaderï¼Œå¦‚æœä»å®˜æ–¹å›ºä»¶å‡çº§ï¼Œä¼šå¯¼è‡´ç°æœ‰ bootloader è¢«è¦†ç›–ã€‚è€Œå½“ Breed æ›´æ–°å›ºä»¶æ—¶ï¼Œå®ƒä¼šè‡ªåŠ¨åˆ é™¤å›ºä»¶é™„å¸¦çš„å¼•å¯¼åŠ è½½ç¨‹åºï¼Œå› æ­¤å¯ä»¥é˜²æ­¢ Breed è¢«è¦†ç›–</p>
<span id="more"></span>
<p>Breed æ‹¥æœ‰ä»¥ä¸‹ç‰¹æ€§ï¼š</p>
<ul>
<li>å®æ—¶åˆ·æœºè¿›åº¦ï¼Œè¿›åº¦æ¡èƒ½å‡†ç¡®åæ˜ åˆ·æœºè¿›åº¦</li>
<li>Web é¡µé¢å¿«é€Ÿå“åº”</li>
<li>æœ€å¤§å›ºä»¶å¤‡ä»½é€Ÿåº¦ï¼Œä¾ Flash è€Œå®šï¼Œä¸€èˆ¬èƒ½è¾¾åˆ° 1MB/s</li>
<li>å…æŒ‰å¤ä½é”®è¿›å…¥ Web åˆ·æœºæ¨¡å¼</li>
<li>Telnet åŠŸèƒ½ï¼Œå… TTL è¿›å…¥ Breed å‘½ä»¤æ§åˆ¶å°</li>
<li>å¤ä½é”®å®šä¹‰æµ‹è¯•åŠŸèƒ½</li>
<li>å›ºä»¶å¯åŠ¨å¤±è´¥è‡ªåŠ¨è¿›å…¥ Web åˆ·æœºæ¨¡å¼</li>
<li>å¯è‡ªå®šä¹‰ä½ç½®å’Œå¤§å°çš„ç¯å¢ƒå˜é‡å—</li>
</ul>
<p>ç”±äºæ˜¯é—­æºï¼Œæ— æ³•è¿›è¡ŒäºŒæ¬¡å¼€å‘ï¼Œæ‰€æœ‰æ”¯æŒçš„è®¾å¤‡å‡ç”± hackpascal ä¸€äººå®Œæˆã€‚åœ¨ 2020-10-09 åå·²ç»åœæ­¢ç‰ˆæœ¬æ›´æ–°ï¼Œä½† <a href="https://breed.hackpascal.net/">å®˜ç½‘</a> ç›®å‰ä»ç„¶å¼€æ”¾æ‰€æœ‰çš„ Breed ä¸‹è½½</p>
<h3 id="æ–‡ä»¶è¯´æ˜"><a href="#æ–‡ä»¶è¯´æ˜" class="headerlink" title="æ–‡ä»¶è¯´æ˜"></a>æ–‡ä»¶è¯´æ˜</h3><p>ä¸‹è¡¨ä¸º Breed çš„æ–‡ä»¶å¯¹åº”çš„è®¾å¤‡ä»‹ç»ï¼Œå‘å¸ƒåœ¨ <a href="https://www.right.com.cn/forum/thread-161906-1-1.html">æ©å±±è®ºå›</a> ä¸Šï¼Œåœ¨æ­¤å¤„åšä¸€ä¸ªå¤‡ä»½</p>
<table>
<thead>
<tr>
<th>æ–‡ä»¶å</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>BreedEnter.exe</td>
<td>Breed å¯åŠ¨ä¸­æ–­å·¥å…·ï¼Œå®ç°å…æŒ‰å¤ä½é”®è¿›å…¥ Web åˆ·æœºæ¨¡å¼</td>
</tr>
<tr>
<td>md5sum.txt</td>
<td>å½“å‰ç‰ˆæœ¬æ‰€æœ‰ Breed æ–‡ä»¶çš„ MD5 å€¼ï¼Œç”¨äºæ ¡éªŒæ–‡ä»¶çš„å®Œæ•´æ€§</td>
</tr>
<tr>
<td>breed-mt7620-reset1.bin</td>
<td>MT7620A / MT7620N å…¨é€šç”¨ï¼Œæ³¢ç‰¹ç‡ 57600ï¼Œå¤ä½é”® GPIO#1</td>
</tr>
<tr>
<td>breed-mt7620-reset2.bin</td>
<td>MT7620A / MT7620N å…¨é€šç”¨ï¼Œæ³¢ç‰¹ç‡ 57600ï¼Œå¤ä½é”® GPIO#2</td>
</tr>
<tr>
<td>breed-mt7620-reset11.bin</td>
<td>MT7620A / MT7620N å…¨é€šç”¨ï¼Œæ³¢ç‰¹ç‡ 57600ï¼Œå¤ä½é”® GPIO#11</td>
</tr>
<tr>
<td>breed-mt7620-reset12.bin</td>
<td>MT7620A / MT7620N å…¨é€šç”¨ï¼Œæ³¢ç‰¹ç‡ 57600ï¼Œå¤ä½é”® GPIO#12</td>
</tr>
<tr>
<td>breed-mt7620-reset13.bin</td>
<td>MT7620A / MT7620N å…¨é€šç”¨ï¼Œæ³¢ç‰¹ç‡ 57600ï¼Œå¤ä½é”® GPIO#13</td>
</tr>
<tr>
<td>breed-mt7620-reset26.bin</td>
<td>MT7620A / MT7620N å…¨é€šç”¨ï¼Œæ³¢ç‰¹ç‡ 57600ï¼Œå¤ä½é”® GPIO#26</td>
</tr>
<tr>
<td>breed-mt7620-reset30.bin</td>
<td>MT7620A / MT7620N å…¨é€šç”¨ï¼Œæ³¢ç‰¹ç‡ 57600ï¼Œå¤ä½é”® GPIO#30</td>
</tr>
<tr>
<td>breed-mt7620-rt-n14u.bin</td>
<td>MT7620A / MT7620N å…¨é€šç”¨ï¼Œæ³¢ç‰¹ç‡ 57600ï¼Œå¤ä½é”® GPIO#1ï¼ŒWPS é”® GPIO#2</td>
</tr>
<tr>
<td>breed-mt7620-whr-1166dhp.bin</td>
<td>MT7620A / MT7620N å…¨é€šç”¨ï¼Œæ³¢ç‰¹ç‡ 57600ï¼Œå¤ä½é”® GPIO#52ï¼ŒAOSS é”® GPIO#53</td>
</tr>
<tr>
<td>breed-mt7620-lenovo-y1.bin</td>
<td>è”æƒ³ Y1 (newifi mini) ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#11</td>
</tr>
<tr>
<td>breed-mt7620-lenovo-y1s.bin</td>
<td>è”æƒ³ Y1S (newifi) ä¸“ç”¨ï¼Œåƒå…†å£å¯ç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#11</td>
</tr>
<tr>
<td>breed-mt7620-zte-q7.bin</td>
<td>ä¸­å…´ ZTE Q7 ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 57600ï¼Œå¤ä½é”® GPIO#26</td>
</tr>
<tr>
<td>breed-mt7620-youku-yk1.bin</td>
<td>ä¼˜é…·è·¯ç”±å®ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 57600ï¼Œå¤ä½é”® GPIO#1</td>
</tr>
<tr>
<td>breed-mt7620-xiaomi-mini.bin</td>
<td>å°ç±³ Mini ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#30</td>
</tr>
<tr>
<td>breed-mt7620-fir302m.bin</td>
<td>æ–è®¯ FIR300M/302M ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 57600ï¼Œå¤ä½é”® GPIO#2</td>
</tr>
<tr>
<td>breed-mt7620-phicomm-psg1208.bin</td>
<td>æ–è®¯ PSG1208 (K1)/ PSG1218 (K2) ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 57600ï¼Œå¤ä½é”® GPIO#1</td>
</tr>
<tr>
<td>breed-mt7620-hiwifi-hc5761.bin</td>
<td>æè·¯ç”± æå£¹S (HC5661)/æè´° (HC5761) ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#12</td>
</tr>
<tr>
<td>breed-mt7620-hiwifi-hc5861.bin</td>
<td>æè·¯ç”± æå (HC5861) ä¸“ç”¨ï¼Œåƒå…†LANå¯ç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#12</td>
</tr>
<tr>
<td>breed-mt7620-oye-0001.bin</td>
<td>å“¦è€¶ Oye-0001 ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#1</td>
</tr>
<tr>
<td>breed-mt7620-airmobi-iplay2.bin</td>
<td>AirMobi iPlay2 ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 57600ï¼Œå¤ä½é”® GPIO#26</td>
</tr>
<tr>
<td>breed-mt7621-newifi-d1.bin</td>
<td>è”æƒ³ Newifi D1 ä¸“ç”¨ï¼ŒDDR3 å†…å­˜é€‚ç”¨ï¼Œé»˜è®¤ 256MB DDR AC æ—¶åºå‚æ•°ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#15ï¼ŒWPS é”® GPIO#18</td>
</tr>
<tr>
<td>breed-mt7621-newifi-d2.bin</td>
<td>è”æƒ³ Newifi D2 ä¸“ç”¨ï¼ŒDDR3 å†…å­˜é€‚ç”¨ï¼Œé»˜è®¤ 512MB DDR AC æ—¶åºå‚æ•°ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#3ï¼ŒWPS é”® GPIO#7</td>
</tr>
<tr>
<td>breed-mt7621-xunlei-timeplug.bin</td>
<td>è¿…é›·æ—¶å…‰æœº (æ—¶å…‰äº‘) ä¸“ç”¨ï¼ŒDDR3 å†…å­˜é€‚ç”¨ï¼Œé»˜è®¤ 256MB DDR AC æ—¶åºå‚æ•°ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#4</td>
</tr>
<tr>
<td>breed-mt7621-youku-l2.bin</td>
<td>ä¼˜é…·è·¯ç”±å® YK-L2 ä¸“ç”¨ï¼ŒDDR3 å†…å­˜é€‚ç”¨ï¼Œé»˜è®¤ 256MB DDR AC æ—¶åºå‚æ•°ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#18ï¼ŒWPS é”® GPIO#17</td>
</tr>
<tr>
<td>breed-mt7621-phicomm-k2p.bin</td>
<td>æ–è®¯ K2P ä¸“ç”¨ï¼ŒDDR3 å†…å­˜é€‚ç”¨ï¼Œé»˜è®¤ 512MB DDR AC æ—¶åºå‚æ•°ï¼Œæ³¢ç‰¹ç‡ 57600ï¼Œå¤ä½é”® GPIO#3</td>
</tr>
<tr>
<td>breed-mt7621-pbr-m1.bin</td>
<td>PandoraBox PBR-M1 ä¸“ç”¨ï¼ŒDDR3 å†…å­˜é€‚ç”¨ï¼Œé»˜è®¤ 512MB DDR AC æ—¶åºå‚æ•°ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#18</td>
</tr>
<tr>
<td>breed-mt7621-totolink-a3004ns.bin</td>
<td>TOTOLINK A3004NS ä¸“ç”¨ï¼ŒDDR3 å†…å­˜é€‚ç”¨ï¼Œé»˜è®¤ 256MB DDR AC æ—¶åºå‚æ•°ï¼Œæ³¢ç‰¹ç‡ 57600ï¼Œå¤ä½é”® GPIO#4ï¼ŒWPS é”® GPIO#3</td>
</tr>
<tr>
<td>breed-mt7621-xiaomi-r3g.bin</td>
<td>å°ç±³è·¯ç”±å™¨ 3G ä¸“ç”¨ï¼ŒNAND å¯åŠ¨ï¼ŒDDR3 å†…å­˜é€‚ç”¨ï¼Œé»˜è®¤ 256MB DDR AC æ—¶åºå‚æ•°ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#18</td>
</tr>
<tr>
<td>breed-mt7621-creativebox-v1.bin</td>
<td>CreativeBox v1 ä¸“ç”¨ï¼ŒDDR3 å†…å­˜é€‚ç”¨ï¼Œé»˜è®¤ 512MB DDR AC æ—¶åºå‚æ•°ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#18</td>
</tr>
<tr>
<td>breed-mt7621-hiwifi-hc5962.bin</td>
<td>æè·¯ç”±4/HC5962/B70 ä¸“ç”¨ï¼ŒNAND å¯åŠ¨ï¼ŒDDR3 å†…å­˜é€‚ç”¨ï¼Œé»˜è®¤ 256MB DDR AC æ—¶åºå‚æ•°ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#18</td>
</tr>
<tr>
<td>breed-mt7621-r6220.bin</td>
<td>Netgear R6220 ä¸“ç”¨ï¼ŒNAND å¯åŠ¨ï¼ŒDDR2 å†…å­˜é€‚ç”¨ï¼Œå›ºå®š 128MB DDR AC æ—¶åºå‚æ•°ï¼Œæ³¢ç‰¹ç‡ 57600ï¼Œå¤ä½é”® GPIO#14ï¼ŒWPS é”® GPIO#7ï¼ŒRFKILL é”® GPIO#8</td>
</tr>
<tr>
<td>breed-mt7621-wndr3700v5.bin</td>
<td>Netgear WNDR3700 v5 ä¸“ç”¨ï¼ŒDDR2 å†…å­˜é€‚ç”¨ï¼Œå›ºå®š 128MB DDR AC æ—¶åºå‚æ•°ï¼Œæ³¢ç‰¹ç‡ 57600ï¼Œå¤ä½é”® GPIO#14ï¼ŒWPS é”® GPIO#7ï¼ŒRFKILL é”® GPIO#8</td>
</tr>
<tr>
<td>breed-mt7621-gehua-ghl-r-001.bin</td>
<td>æ­Œå GHL-R-001 ä¸“ç”¨ï¼ŒDDR3 å†…å­˜é€‚ç”¨ï¼Œé»˜è®¤ 512MB DDR AC æ—¶åºå‚æ•°ï¼Œæ³¢ç‰¹ç‡ 57600ï¼Œå¤ä½é”® GPIO#18</td>
</tr>
<tr>
<td>breed-mt7621-jd-cloud-1.bin</td>
<td>äº¬ä¸œäº‘è·¯ç”±å® RE-SP-01B ä¸“ç”¨ï¼ŒDDR3 å†…å­˜é€‚ç”¨ï¼Œé»˜è®¤ 512MB DDR AC æ—¶åºå‚æ•°ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#18</td>
</tr>
<tr>
<td>breed-mt7628-hiwifi-hc5661a.bin</td>
<td>æè·¯ç”± æå£¹S (HC5661A) ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#38</td>
</tr>
<tr>
<td>breed-mt7628-oye-0006.bin</td>
<td>å“¦è€¶ OYE-0006 ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#38</td>
</tr>
<tr>
<td>breed-mt7688-reset38.bin</td>
<td>MT7628AN/KN å…¨é€šç”¨ï¼Œæ³¢ç‰¹ç‡ 57600ï¼Œå¤ä½é”® GPIO#38</td>
</tr>
<tr>
<td>breed-mt7688-wrtnode2r.bin</td>
<td>MT7628AN/KN å…¨é€šç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#5</td>
</tr>
<tr>
<td>breed-rt3050-buffalo-wcr-hp-gn.bin (ä¸å†æ›´æ–°)</td>
<td>Buffalo WCR-HP-GN ä¸“ç”¨ï¼ŒSPI å¯åŠ¨ï¼Œæ³¢ç‰¹ç‡ 57600ï¼Œå¤ä½é”® GPIO#10ï¼ŒWPS é”® GPIO#0</td>
</tr>
<tr>
<td>breed-rt3050-di-524m-b1.bin (ä¸å†æ›´æ–°)</td>
<td>D-LINK DI-624M B1 ä¸“ç”¨ï¼ŒSPI å¯åŠ¨ï¼Œæ³¢ç‰¹ç‡ 57600ï¼Œå¤ä½é”® GPIO#10</td>
</tr>
<tr>
<td>breed-rt305x-nor-reset0.bin (ä¸å†æ›´æ–°)</td>
<td>RT305X é€šç”¨ï¼ŒNOR å¯åŠ¨ï¼Œæ³¢ç‰¹ç‡ 57600ï¼Œå¤ä½é”® GPIO#0</td>
</tr>
<tr>
<td>breed-rt305x-nor-reset10.bin (ä¸å†æ›´æ–°)</td>
<td>RT305X é€šç”¨ï¼ŒNOR å¯åŠ¨ï¼Œæ³¢ç‰¹ç‡ 57600ï¼Œå¤ä½é”® GPIO#10</td>
</tr>
<tr>
<td>breed-rt3052-dir-605-b1.bin (ä¸å†æ›´æ–°)</td>
<td>D-LINK DIR-605 B1 ä¸“ç”¨ï¼ŒNOR å¯åŠ¨ï¼Œæ³¢ç‰¹ç‡ 57600ï¼Œå¤ä½é”® GPIO#10ï¼ŒWPS é”® GPIO#0</td>
</tr>
<tr>
<td>breed-rt3052-hg255d.bin (ä¸å†æ›´æ–°)</td>
<td>åä¸º HG255D ä¸“ç”¨ï¼ŒNOR å¯åŠ¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#4ï¼ŒWPS é”® GPIO#10</td>
</tr>
<tr>
<td>breed-rt5350-airmobi-iplay.bin (ä¸å†æ›´æ–°)</td>
<td>AirMobi iPlay ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 57600ï¼Œå¤ä½é”® GPIO#12</td>
</tr>
<tr>
<td>breed-rt5350-hame-a5.bin (ä¸å†æ›´æ–°)</td>
<td>åç¾ A5 ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 57600ï¼Œå¤ä½é”® GPIO#0</td>
</tr>
<tr>
<td>breed-rt5350-zm-10.bin (ä¸å†æ›´æ–°)</td>
<td>ä¸­æ²ƒ ZM-10 ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 57600ï¼Œå¤ä½é”® GPIO#10</td>
</tr>
<tr>
<td>breed-ar7161-dir-825-b1.bin (ä¸å†æ›´æ–°)</td>
<td>D-LINK DIR-825 B1 ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#3ï¼ŒWPS é”® GPIO#8</td>
</tr>
<tr>
<td>breed-ar724x.bin (ä¸å†æ›´æ–°)</td>
<td>AR724X é€šç”¨ï¼Œç™¾å…†æœ‰çº¿ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#11ï¼ŒQSS é”® GPIO#12</td>
</tr>
<tr>
<td>breed-ar724x-reset11.bin (ä¸å†æ›´æ–°)</td>
<td>AR724X é€šç”¨ï¼Œç™¾å…†æœ‰çº¿ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#11</td>
</tr>
<tr>
<td>breed-ar724x-reset12.bin (ä¸å†æ›´æ–°)</td>
<td>AR724X é€šç”¨ï¼Œç™¾å…†æœ‰çº¿ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#12</td>
</tr>
<tr>
<td>breed-ar7240-wnr1000v2.bin (ä¸å†æ›´æ–°)</td>
<td>Netgear WNR1000 v2 ä¸“ç”¨ï¼Œç™¾å…†æœ‰çº¿ï¼Œæ³¢ç‰¹ç‡ 115200</td>
</tr>
<tr>
<td>breed-ar7242-wr2543nd.bin (ä¸å†æ›´æ–°)</td>
<td>TP-LINK WR2543ND ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#11ï¼ŒQSS é”® GPIO#12</td>
</tr>
<tr>
<td>breed-ar7242-aruba-ap93.bin (ä¸å†æ›´æ–°)</td>
<td>Aruba-AP93 ä¸“ç”¨ï¼Œåƒå…†æœ‰çº¿ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#11ï¼ŒWPS é”® GPIO#12</td>
</tr>
<tr>
<td>breed-ar913x.bin (ä¸å†æ›´æ–°)</td>
<td>AR913X é€šç”¨ï¼Œç™¾å…†æœ‰çº¿ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#7ï¼ŒWPS é”® GPIO#3</td>
</tr>
<tr>
<td>breed-ar9132-wr1043ndv1.bin (ä¸å†æ›´æ–°)</td>
<td>TP-LINK WR1043ND v1 ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#7ï¼ŒWPS é”® GPIO#3</td>
</tr>
<tr>
<td>breed-ar9331.bin (ä¸å†æ›´æ–°)</td>
<td>AR9331 é€šç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#11</td>
</tr>
<tr>
<td>breed-ar9331-mr12u.bin (ä¸å†æ›´æ–°)</td>
<td>TP-LINK MR12U ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#11</td>
</tr>
<tr>
<td>breed-ar9331-pisen.bin (ä¸å†æ›´æ–°)</td>
<td>å“èƒœäº‘è·¯ç”± (äº‘åº§æ˜“å…… WMM003N/æ— çº¿éŸ³ä¹è·¯ç”± WPR001N) ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#12</td>
</tr>
<tr>
<td>breed-ar9331-wr710n.bin (ä¸å†æ›´æ–°)</td>
<td>TP-LINK WR710N/WR720N v3 ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#11</td>
</tr>
<tr>
<td>breed-ar9331-hiwifi-hc6361.bin (ä¸å†æ›´æ–°)</td>
<td>æè·¯ç”± æå£¹ (HC6361) ä¸“ç”¨ï¼Œä»…æ”¯æŒ TP ç±»å›ºä»¶ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#11</td>
</tr>
<tr>
<td>breed-ar9341.bin (ä¸å†æ›´æ–°)</td>
<td>AR9341 é€šç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#17</td>
</tr>
<tr>
<td>breed-ar9341-wnr2000v4.bin (ä¸å†æ›´æ–°)</td>
<td>Netgear WNR2000 v4 ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#4</td>
</tr>
<tr>
<td>breed-ar9341-pisen-wmp002n.bin (ä¸å†æ›´æ–°)</td>
<td>å“èƒœäº‘è¿½å‰§ WMP002N ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#17</td>
</tr>
<tr>
<td>breed-ar9341-wr800n.bin (ä¸å†æ›´æ–°)</td>
<td>TP-LINK WR800N ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#18</td>
</tr>
<tr>
<td>breed-ar9342-wr1041nv2.bin (ä¸å†æ›´æ–°)</td>
<td>TP-LINK WR1042N v2 ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#14</td>
</tr>
<tr>
<td>breed-ar9342-huawei-ws322.bin (ä¸å†æ›´æ–°)</td>
<td>åä¸º WS322 ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#0ï¼ŒWPS é”® GPIO#16</td>
</tr>
<tr>
<td>breed-ar9344.bin (ä¸å†æ›´æ–°)</td>
<td>AR9344 ç™¾å…†ç‰ˆï¼Œé€šç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#16</td>
</tr>
<tr>
<td>breed-ar9344-ar8327n.bin (ä¸å†æ›´æ–°)</td>
<td>AR9344 + AR8327N åƒå…†ç‰ˆï¼Œé€šç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#16</td>
</tr>
<tr>
<td>breed-ar9344-wdr3320v2.bin (ä¸å†æ›´æ–°)</td>
<td>TP-LINK WDR3320  v2 ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#16</td>
</tr>
<tr>
<td>breed-ar9344-wr941nv6.bin (ä¸å†æ›´æ–°)</td>
<td>TP-LINK WR941N v6 ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#12</td>
</tr>
<tr>
<td>breed-ar9344-mw4530r.bin (ä¸å†æ›´æ–°)</td>
<td>æ°´æ˜Ÿ MW4530R ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#17ï¼ŒQSS é”® GPIO#16</td>
</tr>
<tr>
<td>breed-ar9344-wndr4300-spi.bin (ä¸å†æ›´æ–°)</td>
<td>Netgear WNDR4300/WNDR3700 v4 ä¸“ç”¨ï¼ŒSPI å¯åŠ¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#21ï¼ŒQSS é”® GPIO#12</td>
</tr>
<tr>
<td>breed-ar9344-wndr4300-spi-recovery.bin (ä¸å†æ›´æ–°)</td>
<td>Netgear WNDR4300/WNDR3700 v4 ä¸“ç”¨ï¼ŒSPI å¯åŠ¨ï¼Œä»…ç”¨äºæ¢å¤ç›®çš„ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#21ï¼ŒQSS é”® GPIO#12</td>
</tr>
<tr>
<td>breed-ar9344-belair20e11.bin (ä¸å†æ›´æ–°)</td>
<td>BelAir20E-11 ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#17ï¼ŒWPS é”® GPIO#12</td>
</tr>
<tr>
<td>breed-ar9344-sgr-w500-n85b-v2.bin</td>
<td>å›½äººé€šä¿¡ GRENTECH SGR-W500-N85b v2 ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œæ”¯æŒ RTL8211Eï¼Œå¤ä½é”® GPIO#3</td>
</tr>
<tr>
<td>breed-qca953x.bin</td>
<td>QCA9531/QCA9533ï¼Œé€šç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#12</td>
</tr>
<tr>
<td>breed-qca953x-letv-lba-047-ch.bin</td>
<td>ä¹è§†è·¯ç”±ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#17</td>
</tr>
<tr>
<td>breed-qca9558-wr941nv7.bin</td>
<td>TP-LINK WR941N v7 ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#17</td>
</tr>
<tr>
<td>breed-qca9558-ar8236.bin</td>
<td>QCA9558 + AR8236 ç™¾å…†ç‰ˆï¼Œé€šç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#16</td>
</tr>
<tr>
<td>breed-qca9558-ar8327n.bin</td>
<td>QCA9558 + AR8327N åƒå…†ç‰ˆï¼Œé€šç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#16</td>
</tr>
<tr>
<td>breed-qca9558-wr2041nv2.bin</td>
<td>TP-LINK WR2041N v2 ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#17</td>
</tr>
<tr>
<td>breed-qca9558-wr1043ndv2.bin</td>
<td>TP-LINK WR1043ND v2 ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#16</td>
</tr>
<tr>
<td>breed-qca9558-dw33d.bin</td>
<td>å¤§éº¦ DW33D ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#17</td>
</tr>
<tr>
<td>breed-qca956x-uart_rx18_tx20-reset1.bin</td>
<td>QCA956X é€šç”¨ï¼Œç™¾å…†/åƒå…†è‡ªé€‚åº”ï¼Œæ³¢ç‰¹ç‡ 115200ï¼ŒUART RX GPIO#18ï¼ŒTX GPIO#20ï¼Œå¤ä½é”® GPIO#1</td>
</tr>
<tr>
<td>breed-qca956x-uart_rx18_tx20-reset2.bin</td>
<td>QCA956X é€šç”¨ï¼Œç™¾å…†/åƒå…†è‡ªé€‚åº”ï¼Œæ³¢ç‰¹ç‡ 115200ï¼ŒUART RX GPIO#18ï¼ŒTX GPIO#20ï¼Œå¤ä½é”® GPIO#2</td>
</tr>
<tr>
<td>breed-qca956x-uart_rx18_tx22-reset1.bin</td>
<td>QCA956X é€šç”¨ï¼Œç™¾å…†/åƒå…†è‡ªé€‚åº”ï¼Œæ³¢ç‰¹ç‡ 115200ï¼ŒUART RX GPIO#18ï¼ŒTX GPIO#22ï¼Œå¤ä½é”® GPIO#1</td>
</tr>
<tr>
<td>breed-qca956x-uart_rx18_tx22-reset2.bin</td>
<td>QCA956X é€šç”¨ï¼Œç™¾å…†/åƒå…†è‡ªé€‚åº”ï¼Œæ³¢ç‰¹ç‡ 115200ï¼ŒUART RX GPIO#18ï¼ŒTX GPIO#22ï¼Œå¤ä½é”® GPIO#2</td>
</tr>
<tr>
<td>breed-qca956x-uart_rx19_tx20-reset1.bin</td>
<td>QCA956X é€šç”¨ï¼Œç™¾å…†/åƒå…†è‡ªé€‚åº”ï¼Œæ³¢ç‰¹ç‡ 115200ï¼ŒUART RX GPIO#19ï¼ŒTX GPIO#20ï¼Œå¤ä½é”® GPIO#1</td>
</tr>
<tr>
<td>breed-qca956x-uart_rx19_tx20-reset2.bin</td>
<td>QCA956X é€šç”¨ï¼Œç™¾å…†/åƒå…†è‡ªé€‚åº”ï¼Œæ³¢ç‰¹ç‡ 115200ï¼ŒUART RX GPIO#19ï¼ŒTX GPIO#20ï¼Œå¤ä½é”® GPIO#2</td>
</tr>
<tr>
<td>breed-qca956x-uart_rx19_tx20-reset1.bin</td>
<td>QCA956X é€šç”¨ï¼Œç™¾å…†/åƒå…†è‡ªé€‚åº”ï¼Œæ³¢ç‰¹ç‡ 115200ï¼ŒUART RX GPIO#19ï¼ŒTX GPIO#22ï¼Œå¤ä½é”® GPIO#1</td>
</tr>
<tr>
<td>breed-qca956x-uart_rx19_tx22-reset2.bin</td>
<td>QCA956X é€šç”¨ï¼Œç™¾å…†/åƒå…†è‡ªé€‚åº”ï¼Œæ³¢ç‰¹ç‡ 115200ï¼ŒUART RX GPIO#19ï¼ŒTX GPIO#22ï¼Œå¤ä½é”® GPIO#2</td>
</tr>
<tr>
<td>breed-qca956x-uart_rx20_tx22-reset1.bin</td>
<td>QCA956X é€šç”¨ï¼Œç™¾å…†/åƒå…†è‡ªé€‚åº”ï¼Œæ³¢ç‰¹ç‡ 115200ï¼ŒUART RX GPIO#20ï¼ŒTX GPIO#22ï¼Œå¤ä½é”® GPIO#1</td>
</tr>
<tr>
<td>breed-qca956x-uart_rx20_tx22-reset2.bin</td>
<td>QCA956X é€šç”¨ï¼Œç™¾å…†/åƒå…†è‡ªé€‚åº”ï¼Œæ³¢ç‰¹ç‡ 115200ï¼ŒUART RX GPIO#20ï¼ŒTX GPIO#22ï¼Œå¤ä½é”® GPIO#2</td>
</tr>
<tr>
<td>breed-qca956x-reset2.bin</td>
<td>QCA956X ç™¾å…†ç‰ˆï¼Œé€šç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#2</td>
</tr>
<tr>
<td>breed-qca9561-wdr6500v2.bin (ä¸å†æ›´æ–°)</td>
<td>TP-LINK WDR6500 v2 ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#1</td>
</tr>
<tr>
<td>breed-qca9563-wndr4500v3.bin</td>
<td>Netgear WNDR4500 v3 ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#2ï¼ŒWPS é”® GPIO#1</td>
</tr>
<tr>
<td>breed-qca9563-phicomm-k2t.bin</td>
<td>æ–è®¯ K2T ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#2</td>
</tr>
<tr>
<td>breed-qca9563-rosinson-wr818.bin</td>
<td>ROSINSON WR818 ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#2</td>
</tr>
<tr>
<td>breed-qca9563-jhr-848q.bin</td>
<td>JHR-848Q ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#2</td>
</tr>
<tr>
<td>breed-qca9563-dir-859-a.bin</td>
<td>D-Link DIR-859 A1/A2 ä¸“ç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#2</td>
</tr>
<tr>
<td>breed-tp9343.bin</td>
<td>TP9343ï¼Œé€šç”¨ï¼Œæ³¢ç‰¹ç‡ 115200ï¼Œå¤ä½é”® GPIO#1ï¼ŒWPS é”® GPIO#1</td>
</tr>
</tbody></table>
<p>æ³¨ï¼šä¸“ç”¨ç‰ˆèƒ½å¤Ÿç‚¹äº®æ‰€æœ‰ LED</p>
<p>ä»¥ä¸‹æ˜¯å¯ä»¥æ”¯æŒè‡ªå®šä¹‰å¤ä½é”® GPIO çš„ç‰¹åˆ«ç‰ˆ</p>
<table>
<thead>
<tr>
<th>æ–‡ä»¶å</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>breed-ar7161-blank.bin (ä¸å†æ›´æ–°)</td>
<td>AR7161 ä¸“ç”¨ï¼Œæ”¯æŒ AR8035 IP1001 MV88E1116 BCM5481 åƒå…† PHY</td>
</tr>
<tr>
<td>breed-ar913x-blank.bin (ä¸å†æ›´æ–°)</td>
<td>AR913X ä¸“ç”¨ï¼Œä»…æ”¯æŒ 88E6060 ç™¾å…†äº¤æ¢æœº</td>
</tr>
<tr>
<td>breed-ar724x-blank.bin (ä¸å†æ›´æ–°)</td>
<td>AR724X ä¸“ç”¨ï¼Œæ”¯æŒå†…ç½®ç™¾å…†äº¤æ¢æœºå’Œ AR8021 åƒå…† PHY</td>
</tr>
<tr>
<td>breed-ar9331-blank.bin (ä¸å†æ›´æ–°)</td>
<td>AR9331 ä¸“ç”¨ï¼Œä»…æ”¯æŒå†…ç½®ç™¾å…†äº¤æ¢æœº</td>
</tr>
<tr>
<td>breed-ar934x-blank.bin (ä¸å†æ›´æ–°)</td>
<td>AR934X ä¸“ç”¨ï¼Œæ”¯æŒå†…ç½®ç™¾å…†äº¤æ¢æœºå’Œ  AR8327(N) åƒå…†äº¤æ¢æœºã€AR8035 RTL8211E åƒå…† PHYã€RTL8201 ç™¾å…† PHY</td>
</tr>
<tr>
<td>breed-mt7620-blank.bin</td>
<td>MT7620 ä¸“ç”¨ï¼Œä»…æ”¯æŒå†…ç½®ç™¾å…†äº¤æ¢æœº</td>
</tr>
<tr>
<td>breed-mt76x8-blank.bin</td>
<td>MT7628/MT7688 ä¸“ç”¨ï¼Œä»…æ”¯æŒå†…ç½®ç™¾å…†äº¤æ¢æœº</td>
</tr>
<tr>
<td>breed-rt305x-nor-blank.bin (ä¸å†æ›´æ–°)</td>
<td>RT305X ä¸“ç”¨ï¼Œä» NOR é—ªå­˜å¯åŠ¨ï¼Œä»…æ”¯æŒå†…ç½®ç™¾å…†äº¤æ¢æœº</td>
</tr>
<tr>
<td>breed-rt305x-spi-blank.bin (ä¸å†æ›´æ–°)</td>
<td>RT305X ä¸“ç”¨ï¼Œä» SPI é—ªå­˜å¯åŠ¨ï¼Œä»…æ”¯æŒå†…ç½®ç™¾å…†äº¤æ¢æœº</td>
</tr>
<tr>
<td>breed-rt5350-blank.bin (ä¸å†æ›´æ–°)</td>
<td>RT5350 ä¸“ç”¨ï¼Œä»…æ”¯æŒå†…ç½®ç™¾å…†äº¤æ¢æœº</td>
</tr>
</tbody></table>
<h2 id="åˆ·å…¥-Breed"><a href="#åˆ·å…¥-Breed" class="headerlink" title="åˆ·å…¥ Breed"></a>åˆ·å…¥ Breed</h2><p>Breed çš„åˆ·å…¥å’Œå›ºä»¶åˆ·å…¥æµç¨‹åŸºæœ¬ä¸€è‡´ï¼š</p>
<ol>
<li>è·å–åŸå‚å›ºä»¶çš„ SSH ç™»å½•æƒé™ï¼ˆå¯èƒ½æ˜¯é€šè¿‡åŸå‚å›ºä»¶æ¼æ´ç­‰æ–¹å¼ï¼‰</li>
<li>åœ¨åŸå‚å›ºä»¶ä¸Šåˆ©ç”¨ <code>cat /proc/mtd</code> è·å– ROM åˆ†åŒºçš„å¸ƒå±€</li>
<li>[å¯é€‰] å¤‡ä»½åŸæœ‰çš„æ‰€æœ‰ ROM åˆ†åŒºæ•°æ®ï¼Œä¸»è¦ç›®çš„æ˜¯ä¸ºäº†æ¢å¤åŸå‚å›ºä»¶</li>
<li>åˆ©ç”¨ <code>mtd</code> ç­‰å‘½ä»¤ç›´æ¥å¯¹ Bootloader æ‰€åœ¨çš„ ROM åŒºåŸŸè¿›è¡Œå†™å…¥é•œåƒ</li>
<li>é‡å¯è®¾å¤‡</li>
</ol>
<p>åˆ·å…¥ Breed åï¼Œè€å¿ƒç­‰å¾…è®¾å¤‡é‡å¯ï¼Œé€šå¸¸å¯ä»¥é€šè¿‡ 192.168.1.1 è¿™ä¸ªåœ°å€æ¥è¿›å…¥ Breed çš„ Web ç®¡ç†ç•Œé¢</p>
<p><img data-src="/posts/53d6c2d9/Breed-WEB.png" alt="Breed çš„ Web ç®¡ç†ç•Œé¢"></p>
<h2 id="é€šè¿‡-Breed-åˆ·æœº"><a href="#é€šè¿‡-Breed-åˆ·æœº" class="headerlink" title="é€šè¿‡ Breed åˆ·æœº"></a>é€šè¿‡ Breed åˆ·æœº</h2><p>é€šè¿‡ Breed åˆ·æœºå°±å¾ˆæ–¹ä¾¿äº†ï¼Œç›´æ¥åœ¨ <a href="http://192.168.1.1/upgrade.html">å›ºä»¶æ›´æ–°</a> ç•Œé¢ï¼Œå‹¾é€‰å›ºä»¶ï¼Œå¹¶ä¸Šä¼ å¯¹åº”çš„å›ºä»¶ï¼Œå¹¶å‹¾é€‰æ­£ç¡®çš„é—ªå­˜å¸ƒå±€åï¼Œç‚¹å‡»ä¸Šä¼ ï¼Œç­‰å¾…è®¾å¤‡é‡å¯å³å¯</p>
<p><img data-src="/posts/53d6c2d9/Breed-upgrade.png" alt="Breed è¿›è¡Œå›ºä»¶æ›´æ–°"></p>
<h2 id="å…¶ä»–åŠŸèƒ½"><a href="#å…¶ä»–åŠŸèƒ½" class="headerlink" title="å…¶ä»–åŠŸèƒ½"></a>å…¶ä»–åŠŸèƒ½</h2><p>é™¤å» Web ç•Œé¢åˆ·æœºï¼ŒBreed è¿˜æ”¯æŒä¸€äº›å…¶ä»–çš„åŠŸèƒ½ï¼ŒåŒ…æ‹¬å›ºä»¶å¤‡ä»½ã€è¶…é¢‘ç­‰ï¼Œæ›´å¤šçš„ä½¿ç”¨æ–¹å¼æ¨èå‚è€ƒç½‘ä¸Šçš„å…¶ä»–èµ„æ–™</p>
<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul>
<li><a href="https://www.right.com.cn/forum/thread-161906-1-1.html">ã€æ©å±±è®ºå›ã€‘Breed</a></li>
<li><a href="https://www.right.com.cn/forum/thread-154561-1-1.html">ã€æ©å±±è®ºå›ã€‘U-Boot åˆ·æœº</a></li>
<li><a href="https://www.right.com.cn/forum/thread-690605-1-1.html">ã€æ©å±±è®ºå›ã€‘å°ç±³è·¯ç”±å™¨ MINI åˆ· Breed åŠ Pandavan æ•™ç¨‹</a></li>
<li><a href="https://www.right.com.cn/forum/thread-257423-1-1.html">ã€æ©å±±è®ºå›ã€‘å°ç±³è·¯ç”±å™¨ 3G åˆ· Breed åŠè€æ¯›å­ Padavan å›ºä»¶æ•™ç¨‹</a></li>
</ul>
]]></content>
      <categories>
        <category>è·¯ç”±å™¨</category>
      </categories>
      <tags>
        <tag>Breed</tag>
        <tag>BootLoader</tag>
      </tags>
  </entry>
  <entry>
    <title>page cache å›å†™æœºåˆ¶</title>
    <url>/posts/646202b9.html</url>
    <content><![CDATA[<p>å½“å‰å†…å®¹åŸºäº Linux Kernel <a href="https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/tag/?h=v5.4.121">v5.4.121</a></p>
<h2 id="writeback-å›å†™"><a href="#writeback-å›å†™" class="headerlink" title="writeback å›å†™"></a>writeback å›å†™</h2><p>åœ¨ <a href="/posts/9ba60726">page cache ç®€ä»‹</a> æœ‰è¿‡ä»‹ç»</p>
<p>buffer IO é€šè¿‡ page cache è¿›è¡Œç¼“å­˜ï¼Œå‡å°‘å¯¹åº•å±‚å­˜å‚¨è®¾å¤‡çš„ç›´æ¥è¯»å†™ï¼ŒåŒæ—¶èƒ½å¤Ÿæé«˜æ•´ä½“æ€§èƒ½</p>
<p>å†™å…¥åˆ° page cache çš„æ•°æ®ä¸ä¼šç«‹åˆ»å†™å…¥åç«¯è®¾å¤‡ï¼Œè€Œæ˜¯æ ‡è®°ä¸ºâ€œè„â€ï¼Œå¹¶è¢«åŠ å…¥åˆ°è„é¡µé“¾è¡¨ï¼Œåç»­ç”±å†…æ ¸ä¸­çš„å›å†™è¿›ç¨‹å‘¨æœŸæ€§çš„å°†è„é¡µå†™å›åˆ°åº•å±‚å­˜å‚¨è®¾å¤‡</p>
<p>ä¸‹é¢ä¸»è¦åˆ†æ page cache å›å†™æœºåˆ¶çš„ç­–ç•¥å’Œå®ç°</p>
<span id="more"></span>
<h2 id="ç›¸å…³ç»“æ„ä½“"><a href="#ç›¸å…³ç»“æ„ä½“" class="headerlink" title="ç›¸å…³ç»“æ„ä½“"></a>ç›¸å…³ç»“æ„ä½“</h2><h3 id="åº•å±‚è®¾å¤‡ä¿¡æ¯"><a href="#åº•å±‚è®¾å¤‡ä¿¡æ¯" class="headerlink" title="åº•å±‚è®¾å¤‡ä¿¡æ¯"></a>åº•å±‚è®¾å¤‡ä¿¡æ¯</h3><p>åœ¨ <code>include/linux/backing-dev-defs.h</code> ä¸­å®šä¹‰äº† <code>backing_dev_info</code> ç»“æ„ä½“ï¼Œä¸»è¦ç”¨ä¸è®°å½•åº•å±‚çš„è®¾å¤‡ä¿¡æ¯</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">backing_dev_info</span> &#123;</span></span><br><span class="line">	u64 id;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rb_node</span> <span class="title">rb_node</span>;</span> <span class="comment">/* keyed by -&gt;id */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">bdi_list</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> ra_pages;	<span class="comment">/* max readahead in PAGE_SIZE units */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> io_pages;	<span class="comment">/* max allowed IO size */</span></span><br><span class="line">	congested_fn *congested_fn; <span class="comment">/* Function pointer if device is md/dm */</span></span><br><span class="line">	<span class="keyword">void</span> *congested_data;	<span class="comment">/* Pointer to aux data for congested func */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// é€šå¸¸ä¸º &quot;block&quot;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *name;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kref</span> <span class="title">refcnt</span>;</span>	<span class="comment">/* Reference counter for the structure */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> capabilities; <span class="comment">/* Device capabilities */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> min_ratio;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> max_ratio, max_prop_frac;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Sum of avg_write_bw of wbs with dirty inodes.  &gt; 0 if there are</span></span><br><span class="line"><span class="comment">	 * any dirty wbs, which is depended upon by bdi_has_dirty().</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">atomic_long_t</span> tot_write_bandwidth;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">bdi_writeback</span> <span class="title">wb</span>;</span>  <span class="comment">/* the root writeback info for this bdi */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">wb_list</span>;</span> <span class="comment">/* list of all wbs */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_CGROUP_WRITEBACK</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">radix_tree_root</span> <span class="title">cgwb_tree</span>;</span> <span class="comment">/* radix tree of active cgroup wbs */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rb_root</span> <span class="title">cgwb_congested_tree</span>;</span> <span class="comment">/* their congested states */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">cgwb_release_mutex</span>;</span>  <span class="comment">/* protect shutdown of wb structs */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rw_semaphore</span> <span class="title">wb_switch_rwsem</span>;</span> <span class="comment">/* no cgwb switch while syncing */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">bdi_writeback_congested</span> *<span class="title">wb_congested</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">wait_queue_head_t</span> wb_waitq;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// bdi_class è®¾å¤‡</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">dev</span>;</span></span><br><span class="line">	<span class="comment">// ä¸»è®¾å¤‡å·:æ¬¡è®¾å¤‡å·</span></span><br><span class="line">	<span class="keyword">char</span> dev_name[<span class="number">64</span>];</span><br><span class="line">	<span class="comment">// å®é™…çš„åº•å±‚è®¾å¤‡</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">owner</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">timer_list</span> <span class="title">laptop_mode_wb_timer</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_DEBUG_FS</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> *<span class="title">debug_dir</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="åˆå§‹åŒ–"><a href="#åˆå§‹åŒ–" class="headerlink" title="åˆå§‹åŒ–"></a>åˆå§‹åŒ–</h4><p>è¯¥ç»“æ„ä½“åªä¼šç”± <code>mm/backing-dev.c</code> ä¸­çš„ <code>bdi_alloc_node</code> å‡½æ•°æ¥ç”³è¯·å†…å­˜ç©ºé—´å¹¶è°ƒç”¨ <code>bdi_init</code> åˆå§‹åŒ–</p>
<h4 id="éƒ¨åˆ†å­—æ®µè¯´æ˜"><a href="#éƒ¨åˆ†å­—æ®µè¯´æ˜" class="headerlink" title="éƒ¨åˆ†å­—æ®µè¯´æ˜"></a>éƒ¨åˆ†å­—æ®µè¯´æ˜</h4><ol>
<li><p><code>name</code> å­—æ®µ</p>
<p> <img data-src="/posts/646202b9/bdi_name.png" alt="name å­—æ®µ"></p>
<p> åœ¨ <code>block/blk-core.c</code> ä¸­ <code>blk_alloc_queue_node</code> ä¼šè°ƒç”¨ <code>bdi_alloc_node</code> æ¥åˆå§‹åŒ–è¯¥ç»“æ„ä½“ï¼Œå…¶ä¸­ <code>name</code> å­—æ®µèµ‹å€¼ä¸º <code>&quot;block&quot;</code></p>
</li>
<li><p><code>dev</code> å­—æ®µ</p>
<p> åœ¨ <code>mm/backing-dev.c</code> çš„ <code>bdi_register_va</code> ä¼šè°ƒç”¨ <code>device_create</code> åˆ›å»ºä¸€ä¸ª <code>bdi_class</code> ç±»å‹çš„è®¾å¤‡ï¼Œå¹¶èµ‹å€¼ç»™ <code>dev</code> å­—æ®µ</p>
</li>
<li><p><code>dev_name</code> å­—æ®µ</p>
<p> åœ¨ <code>mm/backing-dev.c</code> çš„ <code>bdi_register_va</code> è¿˜ä¼šå¯¹ <code>dev_name</code> è¿›è¡Œèµ‹å€¼</p>
<p> <img data-src="/posts/646202b9/bdi_dev_name.png" alt="dev_name å­—æ®µ"></p>
<p> æ ¹æ®è°ƒç”¨æ ˆæº¯æºå¯ä»¥å‘ç°ï¼Œ<code>mm/backing-dev.c</code> çš„ <code>bdi_register_owner</code> å°† <code>fmt</code> å’Œ <code>args</code> ä¼ é€’åˆ° <code>bdi_register_va</code>ï¼Œæœ€ç»ˆä¼šå°†ä¸»è®¾å¤‡å·å’Œæ¬¡è®¾å¤‡å·æ‹¼æ¥ç»„åˆåè¿›è¡Œèµ‹å€¼</p>
</li>
<li><p><code>owner</code> å­—æ®µ</p>
<p> åœ¨ <code>mm/backing-dev.c</code> çš„ <code>bdi_register_owner</code> è¿˜ä¼šå¯¹ <code>owner</code> è¿›è¡Œèµ‹å€¼</p>
<p> <img data-src="/posts/646202b9/bdi_owner.png" alt="owner å­—æ®µ"></p>
<p> å®é™…èµ‹å€¼çš„ä¸º <code>disk</code> å¯¹åº”çš„ <code>dev</code>ï¼Œé€šè¿‡ <code>disk_to_dev</code> å®è½¬æ¢å¾—åˆ°</p>
</li>
</ol>
<h3 id="è®¾å¤‡å›å†™ç®¡ç†"><a href="#è®¾å¤‡å›å†™ç®¡ç†" class="headerlink" title="è®¾å¤‡å›å†™ç®¡ç†"></a>è®¾å¤‡å›å†™ç®¡ç†</h3><p>åœ¨ <code>include/linux/backing-dev-defs.h</code> ä¸­å®šä¹‰äº† <code>bdi_writeback</code> ç»“æ„ä½“ï¼Œç”¨äºç®¡ç†ä¸€ä¸ªå—è®¾å¤‡çš„å›å†™ï¼ŒåŒæ—¶æ”¯æŒ <code>cgroup</code> è¿›è¡Œé™åˆ¶</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Each wb (bdi_writeback) can perform writeback operations, is measured</span></span><br><span class="line"><span class="comment"> * and throttled, independently.  Without cgroup writeback, each bdi</span></span><br><span class="line"><span class="comment"> * (bdi_writeback) is served by its embedded bdi-&gt;wb.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * On the default hierarchy, blkcg implicitly enables memcg.  This allows</span></span><br><span class="line"><span class="comment"> * using memcg&#x27;s page ownership for attributing writeback IOs, and every</span></span><br><span class="line"><span class="comment"> * memcg - blkcg combination can be served by its own wb by assigning a</span></span><br><span class="line"><span class="comment"> * dedicated wb to each memcg, which enables isolation across different</span></span><br><span class="line"><span class="comment"> * cgroups and propagation of IO back pressure down from the IO layer upto</span></span><br><span class="line"><span class="comment"> * the tasks which are generating the dirty pages to be written back.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * A cgroup wb is indexed on its bdi by the ID of the associated memcg,</span></span><br><span class="line"><span class="comment"> * refcounted with the number of inodes attached to it, and pins the memcg</span></span><br><span class="line"><span class="comment"> * and the corresponding blkcg.  As the corresponding blkcg for a memcg may</span></span><br><span class="line"><span class="comment"> * change as blkcg is disabled and enabled higher up in the hierarchy, a wb</span></span><br><span class="line"><span class="comment"> * is tested for blkcg after lookup and removed from index on mismatch so</span></span><br><span class="line"><span class="comment"> * that a new wb for the combination can be created.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bdi_writeback</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">backing_dev_info</span> *<span class="title">bdi</span>;</span>	<span class="comment">/* our parent bdi */</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> state;		<span class="comment">/* Always use atomic bitops on this */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> last_old_flush;	<span class="comment">/* last old data flush */</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">b_dirty</span>;</span>	<span class="comment">/* dirty inodes */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">b_io</span>;</span>		<span class="comment">/* parked for writeback */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">b_more_io</span>;</span>	<span class="comment">/* parked for more writeback */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">b_dirty_time</span>;</span>	<span class="comment">/* time stamps are dirty */</span></span><br><span class="line">	<span class="keyword">spinlock_t</span> list_lock;		<span class="comment">/* protects the b_* lists */</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">percpu_counter</span> <span class="title">stat</span>[<span class="title">NR_WB_STAT_ITEMS</span>];</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">bdi_writeback_congested</span> *<span class="title">congested</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> bw_time_stamp;	<span class="comment">/* last time write bw is updated */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> dirtied_stamp;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> written_stamp;	<span class="comment">/* pages written at bw_time_stamp */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> write_bandwidth;	<span class="comment">/* the estimated write bandwidth */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> avg_write_bandwidth; <span class="comment">/* further smoothed write bw, &gt; 0 */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * The base dirty throttle rate, re-calculated on every 200ms.</span></span><br><span class="line"><span class="comment">	 * All the bdi tasks&#x27; dirty rate will be curbed under it.</span></span><br><span class="line"><span class="comment">	 * @dirty_ratelimit tracks the estimated @balanced_dirty_ratelimit</span></span><br><span class="line"><span class="comment">	 * in small steps and is much more smooth/stable than the latter.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> dirty_ratelimit;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> balanced_dirty_ratelimit;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fprop_local_percpu</span> <span class="title">completions</span>;</span></span><br><span class="line">	<span class="keyword">int</span> dirty_exceeded;</span><br><span class="line">	<span class="class"><span class="keyword">enum</span> <span class="title">wb_reason</span> <span class="title">start_all_reason</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">spinlock_t</span> work_lock;		<span class="comment">/* protects work_list &amp; dwork scheduling */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">work_list</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">delayed_work</span> <span class="title">dwork</span>;</span>	<span class="comment">/* work item used for writeback */</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> dirty_sleep;	<span class="comment">/* last wait */</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">bdi_node</span>;</span>	<span class="comment">/* anchored at bdi-&gt;wb_list */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_CGROUP_WRITEBACK</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">percpu_ref</span> <span class="title">refcnt</span>;</span>	<span class="comment">/* used only for !root wb&#x27;s */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fprop_local_percpu</span> <span class="title">memcg_completions</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">cgroup_subsys_state</span> *<span class="title">memcg_css</span>;</span> <span class="comment">/* the associated memcg */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">cgroup_subsys_state</span> *<span class="title">blkcg_css</span>;</span> <span class="comment">/* and blkcg */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">memcg_node</span>;</span>	<span class="comment">/* anchored at memcg-&gt;cgwb_list */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">blkcg_node</span>;</span>	<span class="comment">/* anchored at blkcg-&gt;cgwb_list */</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">work_struct</span> <span class="title">release_work</span>;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span> <span class="title">rcu</span>;</span></span><br><span class="line">	&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="åˆå§‹åŒ–-1"><a href="#åˆå§‹åŒ–-1" class="headerlink" title="åˆå§‹åŒ–"></a>åˆå§‹åŒ–</h4><p>è¯¥ç»“æ„ä½“ç”± <code>mm/backing-dev.c</code> ä¸­çš„ <code>wb_init</code> å‡½æ•°åˆå§‹åŒ–</p>
<pre class="mermaid">  graph TD;
  bdi_init --> cgwb_bdi_init --> wb_init</pre>

<h4 id="éƒ¨åˆ†å­—æ®µè¯´æ˜-1"><a href="#éƒ¨åˆ†å­—æ®µè¯´æ˜-1" class="headerlink" title="éƒ¨åˆ†å­—æ®µè¯´æ˜"></a>éƒ¨åˆ†å­—æ®µè¯´æ˜</h4><ol>
<li><p><code>b_dirty</code> å­—æ®µ</p>
<p> æš‚å­˜æ‰€æœ‰çš„è„ inode çš„é“¾è¡¨</p>
</li>
<li><p><code>b_io</code> å­—æ®µ</p>
<p> æš‚å­˜å³å°†å›å†™çš„ inode çš„é“¾è¡¨</p>
</li>
<li><p><code>b_more_io</code> å­—æ®µ</p>
<p> æš‚å­˜ç”±äºä¸€æ¬¡å›å†™æ•°é‡é™åˆ¶åŸå› å¯¼è‡´çš„ç­‰å¾…ä¸‹æ¬¡å›å†™çš„ inode é“¾è¡¨</p>
</li>
<li><p><code>b_dirty_time</code> å­—æ®µ</p>
<p> æš‚å­˜ä»…ä»…æ˜¯æ—¶é—´æˆ³æ›´æ–°è€Œè¢«è‡³è„çš„ inode çš„é“¾è¡¨</p>
</li>
<li><p><code>list_lock</code> å­—æ®µ</p>
<p> ä¸ºäº†ä¿æŠ¤ä¸Šè¿° 4 ä¸ª <code>b_*</code> åˆ—è¡¨çš„è‡ªæ—‹é”</p>
</li>
<li><p><code>dwork</code> å­—æ®µ</p>
<p> ç”¨äº page cache å›å†™æœºåˆ¶çš„ <code>work</code> å…³é”®ç»“æ„ä½“</p>
</li>
<li><p><code>work_list</code> å­—æ®µ</p>
<p> æš‚å­˜æ‰€æœ‰éœ€è¦å›å†™çš„ä»»åŠ¡çš„é“¾è¡¨</p>
</li>
<li><p><code>work_lock</code> å­—æ®µ</p>
<p> ä¸ºäº†ä¿æŠ¤ <code>work_list</code> ä»¥åŠ <code>dwork</code> è°ƒåº¦çš„è‡ªæ—‹é”</p>
</li>
</ol>
<h3 id="å›å†™ä»»åŠ¡"><a href="#å›å†™ä»»åŠ¡" class="headerlink" title="å›å†™ä»»åŠ¡"></a>å›å†™ä»»åŠ¡</h3><p>åœ¨ <code>fs/fs-writeback.c</code> ä¸­å®šä¹‰äº† <code>wb_writeback_work</code> ç»“æ„ä½“ï¼Œç”¨äºæè¿°ä¸€æ¬¡å›å†™ä»»åŠ¡çš„ç›¸å…³å‚æ•°</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Passed into wb_writeback(), essentially a subset of writeback_control</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">wb_writeback_work</span> &#123;</span></span><br><span class="line">	<span class="comment">// æœ¬æ¬¡å›å†™çš„é¡µæ•°é™åˆ¶</span></span><br><span class="line">	<span class="keyword">long</span> nr_pages;</span><br><span class="line">	<span class="comment">// å›å†™çš„æ–‡ä»¶ç³»ç»Ÿçš„è¶…çº§å—</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">super_block</span> *<span class="title">sb</span>;</span></span><br><span class="line">	<span class="comment">// å›å†™çš„æ¨¡å¼</span></span><br><span class="line">	<span class="class"><span class="keyword">enum</span> <span class="title">writeback_sync_modes</span> <span class="title">sync_mode</span>;</span></span><br><span class="line">	<span class="comment">// tag-and-write æœºåˆ¶æ ‡è®°</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> tagged_writepages:<span class="number">1</span>;</span><br><span class="line">	<span class="comment">// å®šæœŸå›å†™æ ‡è®°</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> for_kupdate:<span class="number">1</span>;</span><br><span class="line">	<span class="comment">// ç»§ç»­ä¸Šæ¬¡å¾ªç¯å›å†™æ ‡è®°</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> range_cyclic:<span class="number">1</span>;</span><br><span class="line">	<span class="comment">// é˜ˆå€¼å›å†™æ ‡è®°</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> for_background:<span class="number">1</span>;</span><br><span class="line">	<span class="comment">// sync ç³»ç»Ÿè°ƒç”¨æ ‡è®°</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> for_sync:<span class="number">1</span>;	<span class="comment">/* sync(2) WB_SYNC_ALL writeback */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> auto_free:<span class="number">1</span>;	<span class="comment">/* free on completion */</span></span><br><span class="line">	<span class="class"><span class="keyword">enum</span> <span class="title">wb_reason</span> <span class="title">reason</span>;</span>		<span class="comment">/* why was writeback initiated? */</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span>		<span class="comment">/* pending work list */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">wb_completion</span> *<span class="title">done</span>;</span>	<span class="comment">/* set if the caller waits */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>åç»­é€šè¿‡ <code>include/linux/writeback.h</code> ä¸­çš„ <code>writeback_control</code> ç»“æ„ä½“å°è£…ï¼Œä¼ é€’ç»™åº•å±‚çš„ <code>writepages</code> å‡½æ•°</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * A control structure which tells the writeback code what to do.  These are</span></span><br><span class="line"><span class="comment"> * always on the stack, and hence need no locking.  They are always initialised</span></span><br><span class="line"><span class="comment"> * in a manner such that unspecified fields are set to zero.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">writeback_control</span> &#123;</span></span><br><span class="line">	<span class="keyword">long</span> nr_to_write;		<span class="comment">/* Write this many pages, and decrement</span></span><br><span class="line"><span class="comment">					   this for each page written */</span></span><br><span class="line">	<span class="keyword">long</span> pages_skipped;		<span class="comment">/* Pages which were not written */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * For a_ops-&gt;writepages(): if start or end are non-zero then this is</span></span><br><span class="line"><span class="comment">	 * a hint that the filesystem need only write out the pages inside that</span></span><br><span class="line"><span class="comment">	 * byterange.  The byte at `end&#x27; is included in the writeout request.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">loff_t</span> range_start;</span><br><span class="line">	<span class="keyword">loff_t</span> range_end;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">enum</span> <span class="title">writeback_sync_modes</span> <span class="title">sync_mode</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">unsigned</span> for_kupdate:<span class="number">1</span>;		<span class="comment">/* A kupdate writeback */</span></span><br><span class="line">	<span class="keyword">unsigned</span> for_background:<span class="number">1</span>;	<span class="comment">/* A background writeback */</span></span><br><span class="line">	<span class="keyword">unsigned</span> tagged_writepages:<span class="number">1</span>;	<span class="comment">/* tag-and-write to avoid livelock */</span></span><br><span class="line">	<span class="keyword">unsigned</span> for_reclaim:<span class="number">1</span>;		<span class="comment">/* Invoked from the page allocator */</span></span><br><span class="line">	<span class="keyword">unsigned</span> range_cyclic:<span class="number">1</span>;	<span class="comment">/* range_start is cyclic */</span></span><br><span class="line">	<span class="keyword">unsigned</span> for_sync:<span class="number">1</span>;		<span class="comment">/* sync(2) WB_SYNC_ALL writeback */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * When writeback IOs are bounced through async layers, only the</span></span><br><span class="line"><span class="comment">	 * initial synchronous phase should be accounted towards inode</span></span><br><span class="line"><span class="comment">	 * cgroup ownership arbitration to avoid confusion.  Later stages</span></span><br><span class="line"><span class="comment">	 * can set the following flag to disable the accounting.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> no_cgroup_owner:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">unsigned</span> punt_to_cgroup:<span class="number">1</span>;	<span class="comment">/* cgrp punting, see __REQ_CGROUP_PUNT */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_CGROUP_WRITEBACK</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">bdi_writeback</span> *<span class="title">wb</span>;</span>	<span class="comment">/* wb this writeback is issued under */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *<span class="title">inode</span>;</span>		<span class="comment">/* inode being written out */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* foreign inode detection, see wbc_detach_inode() */</span></span><br><span class="line">	<span class="keyword">int</span> wb_id;			<span class="comment">/* current wb id */</span></span><br><span class="line">	<span class="keyword">int</span> wb_lcand_id;		<span class="comment">/* last foreign candidate wb id */</span></span><br><span class="line">	<span class="keyword">int</span> wb_tcand_id;		<span class="comment">/* this foreign candidate wb id */</span></span><br><span class="line">	<span class="keyword">size_t</span> wb_bytes;		<span class="comment">/* bytes written by current wb */</span></span><br><span class="line">	<span class="keyword">size_t</span> wb_lcand_bytes;		<span class="comment">/* bytes written by last candidate */</span></span><br><span class="line">	<span class="keyword">size_t</span> wb_tcand_bytes;		<span class="comment">/* bytes written by this candidate */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="éƒ¨åˆ†å­—æ®µè¯´æ˜-2"><a href="#éƒ¨åˆ†å­—æ®µè¯´æ˜-2" class="headerlink" title="éƒ¨åˆ†å­—æ®µè¯´æ˜"></a>éƒ¨åˆ†å­—æ®µè¯´æ˜</h4><ol>
<li><p><code>sync_mode</code> å­—æ®µ</p>
<p> <code>WB_SYNC_NONE</code>ï¼šç»å¤§éƒ¨åˆ†å›å†™ä»»åŠ¡çš„é…ç½®ï¼Œä¸ä¼šç­‰å¾…å›å†™çœŸæ­£è½ç›˜ï¼Œä¸‹å‘å†™å‘½ä»¤åå°±è¿”å›</p>
<p> <code>WB_SYNC_ALL</code>ï¼š<code>sync</code> ç³»ç»Ÿè°ƒç”¨æ—¶é…ç½®ï¼Œå¿…é¡»ç­‰å¾…å›è°ƒå‡½æ•°æ‰§è¡Œå®Œæˆï¼Œå†™çš„æ•°æ®çœŸæ­£è½ç›˜ä¹‹åæ‰ä¼šè¿”å›</p>
</li>
<li><p><code>tagged_writepages</code> å­—æ®µ</p>
<p> å€¼ä¸º 1 è¡¨ç¤ºå¼€å¯ <code>tag-and-write</code> æœºåˆ¶ç”¨äºé¿å…æ´»é”ã€‚è¯¥æœºåˆ¶è¯¦æƒ…å‚è€ƒ <a href="#tag-and-write">åç»­å°èŠ‚</a></p>
</li>
<li><p><code>for_kupdate</code> å­—æ®µ</p>
<p> å€¼ä¸º 1 è¡¨ç¤ºå½“å‰ä»»åŠ¡æ˜¯å®šæœŸå›å†™ä»»åŠ¡ï¼Œç”¨äºå›å†™å·²ç»è‡³è„è¶…è¿‡æŒ‡å®šæ—¶é—´ï¼ˆå†…æ ¸ä¸­å½“å‰é…ç½®ä¸º 30sï¼‰çš„è„é¡µã€‚å®šæœŸå›å†™è¯¦æƒ…å‚è€ƒ <a href="#%E5%AE%9A%E6%9C%9F%E5%9B%9E%E5%86%99">åç»­å°èŠ‚</a></p>
</li>
<li><p><code>range_cyclic</code> å­—æ®µ</p>
<p> å€¼ä¸º 1 è¡¨ç¤ºå½“å‰ä»»åŠ¡çš„å›å†™èŒƒå›´ä¸ºæ•´ä¸ª <code>inode</code>ï¼Œå¹¶ä¸”ä»ä¸Šæ¬¡å®Œæˆçš„ä½ç½®ä½œä¸ºèµ·å§‹ä½ç½®è¿›è¡Œå¾ªç¯å›å†™ã€‚å€¼ä¸º 0 åˆ™æ ¹æ® <code>struct writeback_control wbc</code> çš„ <code>range_start</code> ä»¥åŠ <code>range_end</code> ä½œä¸ºå›å†™çš„èŒƒå›´ã€‚<code>range_cyclic</code> çš„è¯¦æƒ…å‚è€ƒ <a href="#range_cyclic">åç»­å°èŠ‚</a></p>
</li>
<li><p><code>for_background</code> å­—æ®µ</p>
<p> å€¼ä¸º 1 è¡¨ç¤ºå½“å‰ä»»åŠ¡æ˜¯é˜ˆå€¼å›å†™ä»»åŠ¡ï¼Œå½“è„é¡µæ¯”ä¾‹è¶…è¿‡é˜ˆå€¼åæ‰ä¼šè§¦å‘ã€‚é˜ˆå€¼å›å†™è¯¦æƒ…å‚è€ƒ <a href="#%E9%98%88%E5%80%BC%E5%9B%9E%E5%86%99">åç»­å°èŠ‚</a></p>
</li>
<li><p><code>for_sync</code> å­—æ®µ</p>
<p> å€¼ä¸º 1 è¡¨ç¤ºå½“å‰ä»»åŠ¡æ˜¯é˜ˆå€¼å›å†™ä»»åŠ¡ <code>sync</code> ç³»ç»Ÿè°ƒç”¨æ‰‹åŠ¨è§¦å‘çš„å›å†™ä»»åŠ¡ã€‚<code>sync</code> ç³»ç»Ÿè°ƒç”¨è¯¦æƒ…å‚è€ƒ <a href="#sync">åç»­å°èŠ‚</a></p>
</li>
</ol>
<h2 id="å›å†™çº¿ç¨‹"><a href="#å›å†™çº¿ç¨‹" class="headerlink" title="å›å†™çº¿ç¨‹"></a>å›å†™çº¿ç¨‹</h2><p>å‰é¢è¯´è¿‡ <code>bdi_writeback</code> ç»“æ„ä½“ä¸­ <code>struct delayed_work dwork</code> å°±æ˜¯å…³é”®çš„è´Ÿè´£ page cache å›å†™å·¥ä½œçš„ç»“æ„ä½“</p>
<h3 id="åˆå§‹åŒ–-2"><a href="#åˆå§‹åŒ–-2" class="headerlink" title="åˆå§‹åŒ–"></a>åˆå§‹åŒ–</h3><p><code>wb_init</code> å‡½æ•°ä¼šå¯¹ <code>wb-&gt;dwork</code> èµ‹å€¼ï¼Œæ³¨å†Œå®é™…çš„å·¥ä½œå‡½æ•° <code>wb_workfn</code></p>
<p>ç”±äºè¿™æ˜¯ä¸ª <code>delayed_work</code>ï¼Œæ³¨å†Œçš„å·¥ä½œå‡½æ•°ä¸ä¼šç«‹å³æ‰§è¡Œï¼Œéœ€è¦åç»­åˆ©ç”¨ <code>mod_delayed_work</code> æ¥ä¿®æ”¹ <code>delayed_work</code> å†…ç½®çš„å®šæ—¶å™¨æ—¶é—´æ¥å”¤é†’</p>
<p><img data-src="/posts/646202b9/wb_init.png" alt="wb_init è°ƒç”¨å›¾"></p>
<p>(P.S. å›¾ç‰‡ä¸­å‡½æ•°å¼€å¤´ä¸º <code>cg</code> ä»£è¡¨å’Œ <code>cgroup</code> ç›¸å…³ï¼ŒåŒä¸€å±‚çº§å¤šä¸ªåŒåå‡½æ•°å’Œå®å®šä¹‰çš„ç¼–è¯‘æ§åˆ¶æœ‰å…³)</p>
<p>æ ¹æ®å‡½æ•°è°ƒç”¨å›¾ï¼Œå¤§è‡´åˆ†æå¯çŸ¥ï¼Œå½“è®¾å¤‡ç”³è¯· <code>queue</code> æ—¶ä¼šåˆå§‹åŒ– <code>backing_dev_info</code> ç»“æ„ä½“å’Œ <code>bdi_writeback</code> ç»“æ„ä½“ï¼Œä»¥åŠåˆå§‹åŒ–å›å†™çº¿ç¨‹</p>
<h3 id="ç«‹å³å”¤é†’"><a href="#ç«‹å³å”¤é†’" class="headerlink" title="ç«‹å³å”¤é†’"></a>ç«‹å³å”¤é†’</h3><p>è™½ç„¶ <code>dwork</code> æ˜¯ä¸ª <code>delayed_work</code>ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥åœ¨è°ƒç”¨ <code>mod_delayed_work</code> å°†å»¶æ—¶è®¾ç½®ä¸º 0ï¼Œæ¥ç«‹å³å”¤é†’å›å†™çº¿ç¨‹</p>
<p><img data-src="/posts/646202b9/dwork_callers.png" alt="dwork è°ƒç”¨å›¾"></p>
<h4 id="wb-wakeup"><a href="#wb-wakeup" class="headerlink" title="wb_wakeup"></a><code>wb_wakeup</code></h4><p><code>wb_wakeup</code> å°±æ˜¯ä¿®æ”¹å»¶æ—¶ä¸º 0ï¼Œç›´æ¥å”¤é†’å›å†™çº¿ç¨‹</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// fs/fs-writeback.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">wb_wakeup</span><span class="params">(struct bdi_writeback *wb)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	spin_lock_bh(&amp;wb-&gt;work_lock);</span><br><span class="line">	<span class="keyword">if</span> (test_bit(WB_registered, &amp;wb-&gt;state))</span><br><span class="line">		mod_delayed_work(bdi_wq, &amp;wb-&gt;dwork, <span class="number">0</span>);</span><br><span class="line">	spin_unlock_bh(&amp;wb-&gt;work_lock);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="wb-queue-work"><a href="#wb-queue-work" class="headerlink" title="wb_queue_work"></a><code>wb_queue_work</code></h4><p><code>wb_queue_work</code> å°†ä¸€ä¸ªå›å†™ä»»åŠ¡æ’å…¥åˆ°é˜Ÿåˆ—å°¾éƒ¨ï¼Œç„¶åä¿®æ”¹å»¶æ—¶ä¸º 0ï¼Œç«‹å³å”¤é†’å›å†™çº¿ç¨‹</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// fs/fs-writeback.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">wb_queue_work</span><span class="params">(struct bdi_writeback *wb,</span></span></span><br><span class="line"><span class="params"><span class="function">			  struct wb_writeback_work *work)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	trace_writeback_queue(wb, work);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (work-&gt;done)</span><br><span class="line">		atomic_inc(&amp;work-&gt;done-&gt;cnt);</span><br><span class="line"></span><br><span class="line">	spin_lock_bh(&amp;wb-&gt;work_lock);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (test_bit(WB_registered, &amp;wb-&gt;state)) &#123;</span><br><span class="line">		list_add_tail(&amp;work-&gt;<span class="built_in">list</span>, &amp;wb-&gt;work_list);</span><br><span class="line">		mod_delayed_work(bdi_wq, &amp;wb-&gt;dwork, <span class="number">0</span>);</span><br><span class="line">	&#125; <span class="keyword">else</span></span><br><span class="line">		finish_writeback_work(wb, work);</span><br><span class="line"></span><br><span class="line">	spin_unlock_bh(&amp;wb-&gt;work_lock);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="å®šæ—¶å”¤é†’"><a href="#å®šæ—¶å”¤é†’" class="headerlink" title="å®šæ—¶å”¤é†’"></a>å®šæ—¶å”¤é†’</h3><p>å®šæ—¶å”¤é†’ä¸»è¦æ˜¯ç”± <code>wb_wakeup_delayed</code> æ¥å®ç°çš„ï¼Œè€Œæ—¶é—´é—´éš”åœ¨ <code>mm/page-writeback.c</code> è¿›è¡Œäº†å®šä¹‰</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// mm/page-writeback.c</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The interval between `kupdate&#x27;-style writebacks</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> dirty_writeback_interval = <span class="number">5</span> * <span class="number">100</span>; <span class="comment">/* centiseconds */</span></span><br><span class="line"></span><br><span class="line">EXPORT_SYMBOL_GPL(dirty_writeback_interval);</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// mm/backing-dev.c</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * This function is used when the first inode for this wb is marked dirty. It</span></span><br><span class="line"><span class="comment"> * wakes-up the corresponding bdi thread which should then take care of the</span></span><br><span class="line"><span class="comment"> * periodic background write-out of dirty inodes. Since the write-out would</span></span><br><span class="line"><span class="comment"> * starts only &#x27;dirty_writeback_interval&#x27; centisecs from now anyway, we just</span></span><br><span class="line"><span class="comment"> * set up a timer which wakes the bdi thread up later.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Note, we wouldn&#x27;t bother setting up the timer, but this function is on the</span></span><br><span class="line"><span class="comment"> * fast-path (used by &#x27;__mark_inode_dirty()&#x27;), so we save few context switches</span></span><br><span class="line"><span class="comment"> * by delaying the wake-up.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * We have to be careful not to postpone flush work if it is scheduled for</span></span><br><span class="line"><span class="comment"> * earlier. Thus we use queue_delayed_work().</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">wb_wakeup_delayed</span><span class="params">(struct bdi_writeback *wb)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> timeout;</span><br><span class="line"></span><br><span class="line">	timeout = msecs_to_jiffies(dirty_writeback_interval * <span class="number">10</span>);</span><br><span class="line">	spin_lock_bh(&amp;wb-&gt;work_lock);</span><br><span class="line">	<span class="keyword">if</span> (test_bit(WB_registered, &amp;wb-&gt;state))</span><br><span class="line">		queue_delayed_work(bdi_wq, &amp;wb-&gt;dwork, timeout);</span><br><span class="line">	spin_unlock_bh(&amp;wb-&gt;work_lock);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>wb_wakeup_delayed</code> ä½¿ç”¨ 5s ä½œä¸ºæ—¶é—´é—´éš”ï¼Œå½“è°ƒç”¨ <code>wb_wakeup_delayed</code> åï¼Œå›å†™çº¿ç¨‹ä¼šåœ¨ 5s åè¢«å”¤é†’</p>
<p><img data-src="/posts/646202b9/wb_wakeup_delayed.png" alt="wb_wakeup_delayed è°ƒç”¨å›¾"></p>
<p>å®šæ—¶å”¤é†’åªä¼šåœ¨ä¸¤ç§æƒ…å½¢ä¸‹è¢«è°ƒç”¨ï¼š</p>
<ul>
<li><code>__mark_inode_dirty</code>ï¼šå½“ç»™ä¸€ä¸ª <code>inode</code> æ ‡è®°ä¸ºè„æ—¶ï¼Œå¦‚æœè„çš„ä¸ä»…ä»…æ˜¯æ—¶é—´æˆ³ï¼Œè€Œä¸”å½“å‰çš„ <code>b_dirty</code> é“¾è¡¨æ˜¯ç©ºçš„ï¼Œä¹Ÿå°±æ˜¯è¯´ç¬¬ä¸€æ¬¡å°†è„é¡µæŒ‚åœ¨ <code>b_dirty</code> é“¾è¡¨æ—¶ï¼Œå¼€å¯å®šæ—¶å”¤é†’</li>
<li><code>wb_workfn</code>ï¼šå½“å›å†™çº¿ç¨‹å¤„ç†å®Œ <code>work_list</code> ä¸Šçš„æ‰€æœ‰ä»»åŠ¡åï¼Œå¦‚æœä»æœ‰è„ <code>inode</code> åœ¨ <code>b_&#123;dirty|io|more_io&#125;</code> ä¸Šæ—¶ï¼Œå¼€å¯å®šæ—¶å”¤é†’</li>
</ul>
<p>ç®€å•çš„è®²ï¼Œå°±æ˜¯åªè¦å­˜åœ¨è„ <code>inode</code> åœ¨ <code>b_&#123;dirty|io|more_io&#125;</code> ä¸Šæ—¶ï¼Œå†…æ ¸çš„å›å†™çº¿ç¨‹æ¯ 5s å†…è‚¯å®šä¼šè¢«å”¤é†’ä¸€æ¬¡</p>
<h3 id="é‡Šæ”¾é”€æ¯"><a href="#é‡Šæ”¾é”€æ¯" class="headerlink" title="é‡Šæ”¾é”€æ¯"></a>é‡Šæ”¾é”€æ¯</h3><p><img data-src="/posts/646202b9/release_bdi.png" alt="release_bdi è°ƒç”¨å›¾"></p>
<p>å½“éœ€è¦å¯¹æ•´ä¸ª <code>backing_dev_info</code> ç»“æ„é‡Šæ”¾æ—¶ï¼Œä¹Ÿä¼šç«‹å³å”¤é†’å†…æ ¸å›å†™çº¿ç¨‹ï¼Œå¹¶ä¸”ä¼šä¸‹åˆ·ç°æœ‰çš„æ‰€æœ‰å·¥ä½œ</p>
<pre class="mermaid">  graph TD;
  release_bdi --> bdi_unregister --> wb_shutdown
  release_bdi ---> wb_exit</pre>

<h2 id="ç»†èŠ‚åˆ†æ"><a href="#ç»†èŠ‚åˆ†æ" class="headerlink" title="ç»†èŠ‚åˆ†æ"></a>ç»†èŠ‚åˆ†æ</h2><h3 id="tag-and-write"><a href="#tag-and-write" class="headerlink" title="tag-and-write"></a><code>tag-and-write</code></h3><p>è¯¥æœºåˆ¶ä¼šåœ¨ <code>write_pages</code> æ—¶å…ˆå¿«é€Ÿå¯¹ä¸‹åˆ·èŒƒå›´å†…çš„è„é¡µè¿›è¡Œæ ‡è®°ï¼Œåç»­åªå¯¹æ ‡è®°è¿‡çš„è„é¡µè¿›è¡Œä¸‹åˆ·</p>
<p>é¦–å…ˆå›å†™ä»»åŠ¡çš„å‚æ•°ä¼šé€šè¿‡ <code>fs/fs-writeback.c</code> çš„ <code>writeback_sb_inodes</code> å‡½æ•°ä¼ é€’ç»™ <code>struct writeback_control wbc</code></p>
<p>åç»­åœ¨ <code>mm/page-writeback.c</code> ä¸­ <code>write_cache_pages</code> å°±ä¼šæ ¹æ® <code>wbc</code> çš„ <code>tagged_writepages</code> å­—æ®µè¿›è¡Œåˆ¤æ–­ï¼Œé…ç½®ä¸åŒçš„ <code>tag</code>ï¼Œä»¥åŠæ˜¯å¦éœ€è¦å¿«é€Ÿéå†è„é¡µå¹¶æ ‡è®°</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * write_cache_pages - walk the list of dirty pages of the given address space and write all of them.</span></span><br><span class="line"><span class="comment"> * @mapping: address space structure to write</span></span><br><span class="line"><span class="comment"> * @wbc: subtract the number of written pages from *@wbc-&gt;nr_to_write</span></span><br><span class="line"><span class="comment"> * @writepage: function called for each page</span></span><br><span class="line"><span class="comment"> * @data: data passed to writepage function</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * If a page is already under I/O, write_cache_pages() skips it, even</span></span><br><span class="line"><span class="comment"> * if it&#x27;s dirty.  This is desirable behaviour for memory-cleaning writeback,</span></span><br><span class="line"><span class="comment"> * but it is INCORRECT for data-integrity system calls such as fsync().  fsync()</span></span><br><span class="line"><span class="comment"> * and msync() need to guarantee that all the data which was dirty at the time</span></span><br><span class="line"><span class="comment"> * the call was made get new I/O started against them.  If wbc-&gt;sync_mode is</span></span><br><span class="line"><span class="comment"> * WB_SYNC_ALL then we were called for data integrity and we must wait for</span></span><br><span class="line"><span class="comment"> * existing IO to complete.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * To avoid livelocks (when other process dirties new pages), we first tag</span></span><br><span class="line"><span class="comment"> * pages which should be written back with TOWRITE tag and only then start</span></span><br><span class="line"><span class="comment"> * writing them. For data-integrity sync we have to be careful so that we do</span></span><br><span class="line"><span class="comment"> * not miss some pages (e.g., because some other process has cleared TOWRITE</span></span><br><span class="line"><span class="comment"> * tag we set). The rule we follow is that TOWRITE tag can be cleared only</span></span><br><span class="line"><span class="comment"> * by the process clearing the DIRTY tag (and submitting the page for IO).</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * To avoid deadlocks between range_cyclic writeback and callers that hold</span></span><br><span class="line"><span class="comment"> * pages in PageWriteback to aggregate IO until write_cache_pages() returns,</span></span><br><span class="line"><span class="comment"> * we do not loop back to the start of the file. Doing so causes a page</span></span><br><span class="line"><span class="comment"> * lock/page writeback access order inversion - we should only ever lock</span></span><br><span class="line"><span class="comment"> * multiple pages in ascending page-&gt;index order, and looping back to the start</span></span><br><span class="line"><span class="comment"> * of the file violates that rule and causes deadlocks.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Return: %0 on success, negative error code otherwise</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">write_cache_pages</span><span class="params">(struct address_space *mapping,</span></span></span><br><span class="line"><span class="params"><span class="function">		      struct writeback_control *wbc, <span class="keyword">writepage_t</span> writepage,</span></span></span><br><span class="line"><span class="params"><span class="function">		      <span class="keyword">void</span> *data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">int</span> done = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">int</span> error;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pagevec</span> <span class="title">pvec</span>;</span></span><br><span class="line">	<span class="keyword">int</span> nr_pages;</span><br><span class="line">	<span class="function"><span class="keyword">pgoff_t</span> <span class="title">uninitialized_var</span><span class="params">(writeback_index)</span></span>;</span><br><span class="line">	<span class="keyword">pgoff_t</span> index;</span><br><span class="line">	<span class="keyword">pgoff_t</span> end;		<span class="comment">/* Inclusive */</span></span><br><span class="line">	<span class="keyword">pgoff_t</span> done_index;</span><br><span class="line">	<span class="keyword">int</span> range_whole = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">xa_mark_t</span> tag;</span><br><span class="line"></span><br><span class="line">	pagevec_init(&amp;pvec);</span><br><span class="line">	<span class="keyword">if</span> (wbc-&gt;range_cyclic) &#123;</span><br><span class="line">		writeback_index = mapping-&gt;writeback_index; <span class="comment">/* prev offset */</span></span><br><span class="line">		index = writeback_index;</span><br><span class="line">		end = <span class="number">-1</span>;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		index = wbc-&gt;range_start &gt;&gt; PAGE_SHIFT;</span><br><span class="line">		end = wbc-&gt;range_end &gt;&gt; PAGE_SHIFT;</span><br><span class="line">		<span class="keyword">if</span> (wbc-&gt;range_start == <span class="number">0</span> &amp;&amp; wbc-&gt;range_end == LLONG_MAX)</span><br><span class="line">			range_whole = <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (wbc-&gt;sync_mode == WB_SYNC_ALL || wbc-&gt;tagged_writepages)</span><br><span class="line">		tag = PAGECACHE_TAG_TOWRITE;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		tag = PAGECACHE_TAG_DIRTY;</span><br><span class="line">	<span class="keyword">if</span> (wbc-&gt;sync_mode == WB_SYNC_ALL || wbc-&gt;tagged_writepages)</span><br><span class="line">		tag_pages_for_writeback(mapping, index, end);</span><br><span class="line">	done_index = index;</span><br><span class="line">	<span class="keyword">while</span> (!done &amp;&amp; (index &lt;= end)) &#123;</span><br><span class="line">		<span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">		nr_pages = pagevec_lookup_range_tag(&amp;pvec, mapping, &amp;index, end,</span><br><span class="line">				tag);</span><br><span class="line">		<span class="keyword">if</span> (nr_pages == <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; nr_pages; i++) &#123;</span><br><span class="line">			<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span> =</span> pvec.pages[i];</span><br><span class="line"></span><br><span class="line">			done_index = page-&gt;index;</span><br><span class="line"></span><br><span class="line">			lock_page(page);</span><br><span class="line"></span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * Page truncated or invalidated. We can freely skip it</span></span><br><span class="line"><span class="comment">			 * then, even for data integrity operations: the page</span></span><br><span class="line"><span class="comment">			 * has disappeared concurrently, so there could be no</span></span><br><span class="line"><span class="comment">			 * real expectation of this data interity operation</span></span><br><span class="line"><span class="comment">			 * even if there is now a new, dirty page at the same</span></span><br><span class="line"><span class="comment">			 * pagecache address.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			<span class="keyword">if</span> (unlikely(page-&gt;mapping != mapping)) &#123;</span><br><span class="line">continue_unlock:</span><br><span class="line">				unlock_page(page);</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (!PageDirty(page)) &#123;</span><br><span class="line">				<span class="comment">/* someone wrote it for us */</span></span><br><span class="line">				<span class="keyword">goto</span> continue_unlock;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (PageWriteback(page)) &#123;</span><br><span class="line">				<span class="keyword">if</span> (wbc-&gt;sync_mode != WB_SYNC_NONE)</span><br><span class="line">					wait_on_page_writeback(page);</span><br><span class="line">				<span class="keyword">else</span></span><br><span class="line">					<span class="keyword">goto</span> continue_unlock;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			BUG_ON(PageWriteback(page));</span><br><span class="line">			<span class="keyword">if</span> (!clear_page_dirty_for_io(page))</span><br><span class="line">				<span class="keyword">goto</span> continue_unlock;</span><br><span class="line"></span><br><span class="line">			trace_wbc_writepage(wbc, inode_to_bdi(mapping-&gt;host));</span><br><span class="line">			error = (*writepage)(page, wbc, data);</span><br><span class="line">			<span class="keyword">if</span> (unlikely(error)) &#123;</span><br><span class="line">				<span class="comment">/*</span></span><br><span class="line"><span class="comment">				 * Handle errors according to the type of</span></span><br><span class="line"><span class="comment">				 * writeback. There&#x27;s no need to continue for</span></span><br><span class="line"><span class="comment">				 * background writeback. Just push done_index</span></span><br><span class="line"><span class="comment">				 * past this page so media errors won&#x27;t choke</span></span><br><span class="line"><span class="comment">				 * writeout for the entire file. For integrity</span></span><br><span class="line"><span class="comment">				 * writeback, we must process the entire dirty</span></span><br><span class="line"><span class="comment">				 * set regardless of errors because the fs may</span></span><br><span class="line"><span class="comment">				 * still have state to clear for each page. In</span></span><br><span class="line"><span class="comment">				 * that case we continue processing and return</span></span><br><span class="line"><span class="comment">				 * the first error.</span></span><br><span class="line"><span class="comment">				 */</span></span><br><span class="line">				<span class="keyword">if</span> (error == AOP_WRITEPAGE_ACTIVATE) &#123;</span><br><span class="line">					unlock_page(page);</span><br><span class="line">					error = <span class="number">0</span>;</span><br><span class="line">				&#125; <span class="keyword">else</span> <span class="keyword">if</span> (wbc-&gt;sync_mode != WB_SYNC_ALL) &#123;</span><br><span class="line">					ret = error;</span><br><span class="line">					done_index = page-&gt;index + <span class="number">1</span>;</span><br><span class="line">					done = <span class="number">1</span>;</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span> (!ret)</span><br><span class="line">					ret = error;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * We stop writing back only if we are not doing</span></span><br><span class="line"><span class="comment">			 * integrity sync. In case of integrity sync we have to</span></span><br><span class="line"><span class="comment">			 * keep going until we have written all the pages</span></span><br><span class="line"><span class="comment">			 * we tagged for writeback prior to entering this loop.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			<span class="keyword">if</span> (--wbc-&gt;nr_to_write &lt;= <span class="number">0</span> &amp;&amp;</span><br><span class="line">			    wbc-&gt;sync_mode == WB_SYNC_NONE) &#123;</span><br><span class="line">				done = <span class="number">1</span>;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		pagevec_release(&amp;pvec);</span><br><span class="line">		cond_resched();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * If we hit the last page and there is more work to be done: wrap</span></span><br><span class="line"><span class="comment">	 * back the index back to the start of the file for the next</span></span><br><span class="line"><span class="comment">	 * time we are called.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (wbc-&gt;range_cyclic &amp;&amp; !done)</span><br><span class="line">		done_index = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span> (wbc-&gt;range_cyclic || (range_whole &amp;&amp; wbc-&gt;nr_to_write &gt; <span class="number">0</span>))</span><br><span class="line">		mapping-&gt;writeback_index = done_index;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(write_cache_pages);</span><br></pre></td></tr></table></figure>

<p>åœ¨ <code>fs/fs-writeback.c</code> ä¸­ <code>writeback_chunk_size</code> é‡Œé¢çš„æ³¨é‡Šä¹Ÿå¯¹è¿™ä¸ªæµç¨‹è¿›è¡Œäº†æè¿°</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">long</span> <span class="title">writeback_chunk_size</span><span class="params">(struct bdi_writeback *wb,</span></span></span><br><span class="line"><span class="params"><span class="function">				 struct wb_writeback_work *work)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">long</span> pages;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * WB_SYNC_ALL mode does livelock avoidance by syncing dirty</span></span><br><span class="line"><span class="comment">	 * inodes/pages in one big loop. Setting wbc.nr_to_write=LONG_MAX</span></span><br><span class="line"><span class="comment">	 * here avoids calling into writeback_inodes_wb() more than once.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * The intended call sequence for WB_SYNC_ALL writeback is:</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 *      wb_writeback()</span></span><br><span class="line"><span class="comment">	 *          writeback_sb_inodes()       &lt;== called only once</span></span><br><span class="line"><span class="comment">	 *              write_cache_pages()     &lt;== called once for each inode</span></span><br><span class="line"><span class="comment">	 *                   (quickly) tag currently dirty pages</span></span><br><span class="line"><span class="comment">	 *                   (maybe slowly) sync all tagged pages</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (work-&gt;sync_mode == WB_SYNC_ALL || work-&gt;tagged_writepages)</span><br><span class="line">		pages = LONG_MAX;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		pages = min(wb-&gt;avg_write_bandwidth / <span class="number">2</span>,</span><br><span class="line">			    global_wb_domain.dirty_limit / DIRTY_SCOPE);</span><br><span class="line">		pages = min(pages, work-&gt;nr_pages);</span><br><span class="line">		pages = round_down(pages + MIN_WRITEBACK_PAGES,</span><br><span class="line">				   MIN_WRITEBACK_PAGES);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> pages;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="range-cyclic"><a href="#range-cyclic" class="headerlink" title="range_cyclic"></a><code>range_cyclic</code></h3><p><code>range_cyclic</code> æ—©åœ¨å†…æ ¸çš„ v2.6.18-rc1 ç‰ˆæœ¬å°±å·²ç»å®ç°ï¼Œå¯ä»¥å‚è€ƒ <a href="https://github.com/torvalds/linux/commit/111ebb6e6f7bd7de6d722c5848e95621f43700d9">111ebb6</a> çš„æäº¤ä¿¡æ¯è¾…åŠ©ç†è§£</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[PATCH] writeback: fix range handling</span><br><span class="line">When a writeback_control&#x27;s `start&#x27; and `end&#x27; fields are used to</span><br><span class="line">indicate a one-byte-range starting at file offset zero, the required</span><br><span class="line">values of .start=0,.end=0 mean that the -&gt;writepages() implementation</span><br><span class="line">has no way of telling that it is being asked to perform a range</span><br><span class="line">request.  Because we&#x27;re currently overloading (start == 0 &amp;&amp; end == 0)</span><br><span class="line">to mean &quot;this is not a write-a-range request&quot;.</span><br><span class="line"></span><br><span class="line">To make all this sane, the patch changes range of writeback_control.</span><br><span class="line"></span><br><span class="line">So caller does: If it is calling -&gt;writepages() to write pages, it</span><br><span class="line">sets range (range_start/end or range_cyclic) always.</span><br><span class="line"></span><br><span class="line">And if range_cyclic is true, -&gt;writepages() thinks the range is</span><br><span class="line">cyclic, otherwise it just uses range_start and range_end.</span><br><span class="line"></span><br><span class="line">This patch does,</span><br><span class="line"></span><br><span class="line">    - Add LLONG_MAX, LLONG_MIN, ULLONG_MAX to include/linux/kernel.h</span><br><span class="line">      -1 is usually ok for range_end (type is long long). But, if someone did,</span><br><span class="line"></span><br><span class="line">		range_end += val;		range_end is &quot;val - 1&quot;</span><br><span class="line">		u64val = range_end &gt;&gt; bits;	u64val is &quot;~(0ULL)&quot;</span><br><span class="line"></span><br><span class="line">      or something, they are wrong. So, this adds LLONG_MAX to avoid nasty</span><br><span class="line">      things, and uses LLONG_MAX for range_end.</span><br><span class="line"></span><br><span class="line">    - All callers of -&gt;writepages() sets range_start/end or range_cyclic.</span><br><span class="line"></span><br><span class="line">    - Fix updates of -&gt;writeback_index. It seems already bit strange.</span><br><span class="line">      If it starts at 0 and ended by check of nr_to_write, this last</span><br><span class="line">      index may reduce chance to scan end of file.  So, this updates</span><br><span class="line">      -&gt;writeback_index only if range_cyclic is true or whole-file is</span><br><span class="line">      scanned.</span><br><span class="line"></span><br><span class="line">Signed-off-by: OGAWA Hirofumi &lt;hirofumi@mail.parknet.co.jp&gt;</span><br><span class="line">Cc: Nathan Scott &lt;nathans@sgi.com&gt;</span><br><span class="line">Cc: Anton Altaparmakov &lt;aia21@cantab.net&gt;</span><br><span class="line">Cc: Steven French &lt;sfrench@us.ibm.com&gt;</span><br><span class="line">Cc: &quot;Vladimir V. Saveliev&quot; &lt;vs@namesys.com&gt;</span><br><span class="line">Signed-off-by: Andrew Morton &lt;akpm@osdl.org&gt;</span><br><span class="line">Signed-off-by: Linus Torvalds &lt;torvalds@osdl.org&gt;</span><br></pre></td></tr></table></figure>

<p><code>range_cyclic</code> å’Œ <code>range_start/end</code> äº’æ–¥</p>
<ul>
<li>å½“å¼€å¯ <code>range_cyclic</code> å°†æ— è§† <code>range_start/end</code> çš„å€¼</li>
<li>å¦åˆ™åº•å±‚ <code>writepages</code> å‡½æ•°åˆ™ä½¿ç”¨ <code>range_start/end</code> ä½œä¸ºå†™çš„èŒƒå›´</li>
</ul>
<pre class="mermaid">  graph TD;
  do_writepages --> writepages("mapping->a_ops->writepages()")
  do_writepages --> generic_writepages --> write_cache_pages</pre>

<p>ç»“åˆå®é™…ä»£ç ï¼Œåœ¨ <code>mm/page-writeback.c</code> çš„ <code>write_cache_pages</code> å‡½æ•°ä¸­æœ‰ä»¥ä¸‹ç‰‡æ®µ</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (wbc-&gt;range_cyclic) &#123;</span><br><span class="line">	writeback_index = mapping-&gt;writeback_index; <span class="comment">/* prev offset */</span></span><br><span class="line">	index = writeback_index;</span><br><span class="line">	end = <span class="number">-1</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	index = wbc-&gt;range_start &gt;&gt; PAGE_SHIFT;</span><br><span class="line">	end = wbc-&gt;range_end &gt;&gt; PAGE_SHIFT;</span><br><span class="line">	<span class="keyword">if</span> (wbc-&gt;range_start == <span class="number">0</span> &amp;&amp; wbc-&gt;range_end == LLONG_MAX)</span><br><span class="line">		range_whole = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ­¤å¤„çœç•¥éƒ¨åˆ†ä»£ç </span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * If we hit the last page and there is more work to be done: wrap</span></span><br><span class="line"><span class="comment"> * back the index back to the start of the file for the next</span></span><br><span class="line"><span class="comment"> * time we are called.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (wbc-&gt;range_cyclic &amp;&amp; !done)</span><br><span class="line">	done_index = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span> (wbc-&gt;range_cyclic || (range_whole &amp;&amp; wbc-&gt;nr_to_write &gt; <span class="number">0</span>))</span><br><span class="line">	mapping-&gt;writeback_index = done_index;</span><br></pre></td></tr></table></figure>

<p><code>range_cyclic</code> å¼€å¯åä¼šä½¿ç”¨ <code>mapping-&gt;writeback_index</code> ä½œä¸ºæœ¬æ¬¡å›å†™çš„èµ·å§‹åœ°å€ï¼Œå¹¶ä¼šåœ¨å®Œæˆæœ¬æ¬¡å›å†™æµç¨‹ï¼ˆå›å†™é¡µæ•°é™åˆ¶æˆ–è€…åˆ°è¾¾æ–‡ä»¶æœ«å°¾ï¼‰åæ›´æ–° <code>mapping-&gt;writeback_index</code></p>
<h3 id="å®šæœŸå›å†™"><a href="#å®šæœŸå›å†™" class="headerlink" title="å®šæœŸå›å†™"></a>å®šæœŸå›å†™</h3><p>å®šæœŸå›å†™çš„ä»»åŠ¡å£°æ˜åœ¨ <code>fs/fs-writeback.c</code> çš„ <code>wb_check_old_data_flush</code> å‡½æ•°ä¸­ï¼Œè€Œè¿™ä¸ªå‡½æ•°åˆ™æ˜¯è¢« <code>wb_workfn</code> è°ƒç”¨</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">long</span> <span class="title">wb_check_old_data_flush</span><span class="params">(struct bdi_writeback *wb)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> expired;</span><br><span class="line">	<span class="keyword">long</span> nr_pages;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * When set to zero, disable periodic writeback</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (!dirty_writeback_interval)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	expired = wb-&gt;last_old_flush +</span><br><span class="line">			msecs_to_jiffies(dirty_writeback_interval * <span class="number">10</span>);</span><br><span class="line">	<span class="keyword">if</span> (time_before(jiffies, expired))</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	wb-&gt;last_old_flush = jiffies;</span><br><span class="line">	nr_pages = get_nr_dirty_pages();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (nr_pages) &#123;</span><br><span class="line">		<span class="comment">// å®šæœŸå›å†™</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">wb_writeback_work</span> <span class="title">work</span> =</span> &#123;</span><br><span class="line">			.nr_pages	= nr_pages,</span><br><span class="line">			.sync_mode	= WB_SYNC_NONE,</span><br><span class="line">			.for_kupdate	= <span class="number">1</span>,</span><br><span class="line">			.range_cyclic	= <span class="number">1</span>,</span><br><span class="line">			.reason		= WB_REASON_PERIODIC,</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> wb_writeback(wb, &amp;work);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<pre class="mermaid">  graph TD;
  wb_wakeup -.-> wb_workfn -->|é€šå¸¸æƒ…å†µ| wb_do_writeback --> wb_check_old_data_flush</pre>

<p>é¦–å…ˆè¦ä¿è¯å½“å‰æ—¶é—´åœ¨ä¸Šæ¬¡å®šæœŸå›å†™çš„ 5s ï¼ˆå’Œå®šæœŸå”¤é†’çš„æ—¶é—´é—´éš”ä¸€è‡´ï¼‰åï¼Œå¹¶ä¸”å½“å‰å­˜åœ¨è„é¡µï¼Œæ‰ä¼šç”Ÿæˆä¸€æ¬¡å®šæœŸå›å†™çš„ä»»åŠ¡ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯ 5s å†…æœ€å¤šè§¦å‘ä¸€æ¬¡å®šæœŸå›å†™</p>
<p>ç”Ÿæˆçš„å›å†™ä»»åŠ¡äº¤ç»™ <code>fs/fs-writeback.c</code> çš„ <code>wb_writeback</code> å‡½æ•°å¤„ç†</p>
<p>å¹¶ä¸”å®šæœŸå›å†™å±äºä¸€ç§åå°å›å†™ï¼Œä¼˜å…ˆçº§è¾ƒä½ï¼Œåªæœ‰åœ¨ <code>wb-&gt;work_list</code> ä¸ºç©ºæ—¶æ‰ä¼šæ‰§è¡Œ</p>
<p><code>wb_writeback</code> æ‰§è¡Œå®šæœŸå›å†™æ—¶åªä¼šé€‰æ‹©åœ¨è‡³è„æ—¶é—´åœ¨å½“å‰æ—¶é—´ 30s ä¹‹å‰çš„ <code>inode</code> çš„æ‰€æœ‰è„é¡µè¿›è¡Œå›å†™</p>
<h3 id="é˜ˆå€¼å›å†™"><a href="#é˜ˆå€¼å›å†™" class="headerlink" title="é˜ˆå€¼å›å†™"></a>é˜ˆå€¼å›å†™</h3><p>é’ˆå¯¹è„é¡µç‡å†…æ ¸ä¸­æœ‰ä¸¤ä¸ªé˜ˆå€¼ï¼Œ10% å’Œ 20%</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// mm/page-writeback.c</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Start background writeback (via writeback threads) at this percentage</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">int</span> dirty_background_ratio = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The generator of dirty data starts writeback at this percentage</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">int</span> vm_dirty_ratio = <span class="number">20</span>;</span><br></pre></td></tr></table></figure>

<ol>
<li><p>bg_thresh åå°é˜ˆå€¼</p>
<p> å½“è„é¡µç‡è¾¾åˆ° 10% æ—¶ä¼šä»¥åå°çš„æ–¹å¼è¿›è¡Œå›å†™</p>
 <pre class="mermaid">      graph TD;
   generic_perform_write --> balance_dirty_pages_ratelimited --> balance_dirty_pages --> wb_start_background_writeback --> wb_wakeup
   wb_wakeup -.-> wb_workfn -->|é€šå¸¸æƒ…å†µ| wb_do_writeback -->|wb_over_bg_thresh| wb_check_background_flush</pre>

<p> å½“ç”¨æˆ· <code>write</code> è°ƒç”¨ä½¿ç”¨ <code>generic_perform_write</code> æ¥å†™ page cache æ—¶ï¼Œä¼šè°ƒç”¨ <code>balance_dirty_pages_ratelimited</code> æ¥æ£€æŸ¥è„é¡µç‡ï¼Œå½“è„é¡µç‡è¶…è¿‡ 10% å°±ä¼šè°ƒç”¨ <code>balance_dirty_pages</code> æ¥å”¤é†’ <code>wb_workfn</code> æ¥è¿›è¡Œä¸‹åˆ·è„é¡µï¼Œæ­¤æ—¶å¹¶ä¸ä¼šé˜»å¡å½“å‰çš„ <code>write</code> è¿‡ç¨‹</p>
</li>
<li><p>thresh å‰å°é˜ˆå€¼</p>
<p> è€Œå½“è„é¡µç‡è¾¾åˆ° 20% ä¹‹ååˆ™ä¼šè§¦å‘å‰å°å›å†™ï¼Œæ­¤æ—¶çš„å‡½æ•°è°ƒç”¨å’Œé€»è¾‘å’Œä¸Šé¢åŸºæœ¬ä¸€è‡´ï¼Œä¸åŒç‚¹åœ¨äºå½“è„é¡µç‡è¶…è¿‡ 20% åä¼šåœ¨ <code>balance_dirty_pages</code> çš„å¾ªç¯ä¸­æ— æ³•è·³å‡ºï¼Œå› æ­¤çº¿ç¨‹ä¼šé˜»å¡ï¼Œç›´åˆ°è„é¡µç‡é™ä½è‡³ 20% ä»¥ä¸‹ï¼Œè·³å‡ºå¾ªç¯ï¼Œå¯ç”¨åå°å›å†™</p>
</li>
</ol>
<h2 id="æ‰‹åŠ¨è§¦å‘å›å†™"><a href="#æ‰‹åŠ¨è§¦å‘å›å†™" class="headerlink" title="æ‰‹åŠ¨è§¦å‘å›å†™"></a>æ‰‹åŠ¨è§¦å‘å›å†™</h2><h3 id="sync"><a href="#sync" class="headerlink" title="sync"></a><code>sync</code></h3><p><code>sync</code> ç³»ç»Ÿè°ƒç”¨ä¼šåŒæ­¥æ‰€æœ‰çš„ page cache</p>
<p>åœ¨ <code>bash</code> ä¸Šç›´æ¥è¾“å…¥ <code>sync</code> å‘½ä»¤å°±ä¼šè§¦å‘ <code>sync</code> ç³»ç»Ÿè°ƒç”¨</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// fs/sync.c</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Sync everything. We start by waking flusher threads so that most of</span></span><br><span class="line"><span class="comment"> * writeback runs on all devices in parallel. Then we sync all inodes reliably</span></span><br><span class="line"><span class="comment"> * which effectively also waits for all flusher threads to finish doing</span></span><br><span class="line"><span class="comment"> * writeback. At this point all data is on disk so metadata should be stable</span></span><br><span class="line"><span class="comment"> * and we tell filesystems to sync their metadata via -&gt;sync_fs() calls.</span></span><br><span class="line"><span class="comment"> * Finally, we writeout all block devices because some filesystems (e.g. ext2)</span></span><br><span class="line"><span class="comment"> * just write metadata (such as inodes or bitmaps) to block device page cache</span></span><br><span class="line"><span class="comment"> * and do not sync it on their own in -&gt;sync_fs().</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ksys_sync</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> nowait = <span class="number">0</span>, wait = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// å”¤é†’æ‰€æœ‰ bdi çš„å›å†™çº¿ç¨‹</span></span><br><span class="line">	wakeup_flusher_threads(WB_REASON_SYNC);</span><br><span class="line">	<span class="comment">// ä¸‹å‘æ‰€æœ‰ inode çš„å›å†™ä»»åŠ¡</span></span><br><span class="line">	iterate_supers(sync_inodes_one_sb, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="comment">// è°ƒç”¨ sync_fs() åŒæ­¥æ–‡ä»¶ç³»ç»Ÿçš„å…ƒæ•°æ®</span></span><br><span class="line">	iterate_supers(sync_fs_one_sb, &amp;nowait);</span><br><span class="line">	iterate_supers(sync_fs_one_sb, &amp;wait);</span><br><span class="line">	<span class="comment">// å›å†™å—è®¾å¤‡çš„ page cache</span></span><br><span class="line">	iterate_bdevs(fdatawrite_one_bdev, <span class="literal">NULL</span>);</span><br><span class="line">	iterate_bdevs(fdatawait_one_bdev, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">if</span> (unlikely(laptop_mode))</span><br><span class="line">		laptop_sync_completion();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">SYSCALL_DEFINE0(sync)</span><br><span class="line">&#123;</span><br><span class="line">	ksys_sync();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>é¦–å…ˆï¼Œå”¤é†’æ‰€æœ‰è®¾å¤‡çš„å›å†™çº¿ç¨‹çº¿ç¨‹ï¼Œè¿™æ ·å¤§éƒ¨åˆ†çš„å›å†™åœ¨æ‰€æœ‰è®¾å¤‡ä¸Šå¹¶è¡Œè¿è¡Œ</li>
<li>å¹¶ç«‹åˆ»ç”Ÿæˆä¸€ä¸ªä¸‹åˆ·è®¾å¤‡ä¸Šæ‰€æœ‰ inode çš„å›å†™ä»»åŠ¡ï¼Œå¹¶ç­‰å¾…å®Œæˆ</li>
<li>ç„¶åæ–‡ä»¶ç³»ç»Ÿé€šè¿‡æ³¨å†Œçš„ <code>sync_fs()</code> è°ƒç”¨æ¥åŒæ­¥ä»–ä»¬çš„å…ƒæ•°æ®</li>
<li>æœ€åï¼Œå›å†™æ‰€æœ‰çš„å—è®¾å¤‡çš„ page cache<ul>
<li>å› ä¸ºæœ‰äº›æ–‡ä»¶ç³»ç»Ÿï¼ˆä¾‹å¦‚ <code>ext2</code>ï¼‰ä¼šå°†å…ƒæ•°æ®ï¼ˆå¦‚ <code>inodes</code> æˆ– <code>bitmaps</code>ï¼‰å†™å…¥å—è®¾å¤‡ page cacheï¼Œè€Œä¸æ˜¯åœ¨ <code>sync_fs()</code> ä¸­è‡ªè¡ŒåŒæ­¥</li>
</ul>
</li>
</ul>
<h3 id="fsync-å’Œ-fdatasync"><a href="#fsync-å’Œ-fdatasync" class="headerlink" title="fsync å’Œ fdatasync"></a><code>fsync</code> å’Œ <code>fdatasync</code></h3><p><code>fsync</code> å’Œ <code>fdatasync</code> ç³»ç»Ÿè°ƒç”¨åˆ™å¯ä»¥æ›´åŠ ç»†ç²’åº¦çš„ä¸‹åˆ·è„é¡µï¼Œä»–ä»¬çš„ä¸‹åˆ·å¯¹è±¡æ˜¯ä¸€ä¸ªæ–‡ä»¶</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// fs/sync.c</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * vfs_fsync_range - helper to sync a range of data &amp; metadata to disk</span></span><br><span class="line"><span class="comment"> * @file:		file to sync</span></span><br><span class="line"><span class="comment"> * @start:		offset in bytes of the beginning of data range to sync</span></span><br><span class="line"><span class="comment"> * @end:		offset in bytes of the end of data range (inclusive)</span></span><br><span class="line"><span class="comment"> * @datasync:		perform only datasync</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Write back data in range @start..@end and metadata for @file to disk.  If</span></span><br><span class="line"><span class="comment"> * @datasync is set only metadata needed to access modified file data is</span></span><br><span class="line"><span class="comment"> * written.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">vfs_fsync_range</span><span class="params">(struct file *file, <span class="keyword">loff_t</span> start, <span class="keyword">loff_t</span> end, <span class="keyword">int</span> datasync)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *<span class="title">inode</span> =</span> file-&gt;f_mapping-&gt;host;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!file-&gt;f_op-&gt;fsync)</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line">	<span class="keyword">if</span> (!datasync &amp;&amp; (inode-&gt;i_state &amp; I_DIRTY_TIME))</span><br><span class="line">		mark_inode_dirty_sync(inode);</span><br><span class="line">	<span class="keyword">return</span> file-&gt;f_op-&gt;fsync(file, start, end, datasync);</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(vfs_fsync_range);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * vfs_fsync - perform a fsync or fdatasync on a file</span></span><br><span class="line"><span class="comment"> * @file:		file to sync</span></span><br><span class="line"><span class="comment"> * @datasync:		only perform a fdatasync operation</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Write back data and metadata for @file to disk.  If @datasync is</span></span><br><span class="line"><span class="comment"> * set only metadata needed to access modified file data is written.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">vfs_fsync</span><span class="params">(struct file *file, <span class="keyword">int</span> datasync)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> vfs_fsync_range(file, <span class="number">0</span>, LLONG_MAX, datasync);</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(vfs_fsync);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">do_fsync</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> fd, <span class="keyword">int</span> datasync)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fd</span> <span class="title">f</span> =</span> fdget(fd);</span><br><span class="line">	<span class="keyword">int</span> ret = -EBADF;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (f.file) &#123;</span><br><span class="line">		ret = vfs_fsync(f.file, datasync);</span><br><span class="line">		fdput(f);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">SYSCALL_DEFINE1(fsync, <span class="keyword">unsigned</span> <span class="keyword">int</span>, fd)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> do_fsync(fd, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">SYSCALL_DEFINE1(fdatasync, <span class="keyword">unsigned</span> <span class="keyword">int</span>, fd)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> do_fsync(fd, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>fsync</code> å’Œ <code>fdatasync</code> ä¼šè°ƒç”¨æ–‡ä»¶ç³»ç»Ÿæ³¨å†Œçš„ <code>f_op-&gt;fsync()</code> å‡½æ•°è¿›è¡Œè„é¡µçš„ä¸‹åˆ·ã€‚å¾ˆå¤šæ–‡ä»¶ç³»ç»Ÿä¼šä½¿ç”¨æˆ–è€…å‚è€ƒé€šç”¨çš„ <code>generic_file_fsync</code> æ¥å®ç°ï¼Œè¿™é‡Œé’ˆå¯¹ <code>__generic_file_fsync</code> è¿›è¡Œåˆ†æ</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// fs/libfs.c</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * __generic_file_fsync - generic fsync implementation for simple filesystems</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @file:	file to synchronize</span></span><br><span class="line"><span class="comment"> * @start:	start offset in bytes</span></span><br><span class="line"><span class="comment"> * @end:	end offset in bytes (inclusive)</span></span><br><span class="line"><span class="comment"> * @datasync:	only synchronize essential metadata if true</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This is a generic implementation of the fsync method for simple</span></span><br><span class="line"><span class="comment"> * filesystems which track all non-inode metadata in the buffers list</span></span><br><span class="line"><span class="comment"> * hanging off the address_space structure.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">int</span> __generic_file_fsync(struct file *file, <span class="keyword">loff_t</span> start, <span class="keyword">loff_t</span> end,</span><br><span class="line">				 <span class="keyword">int</span> datasync)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *<span class="title">inode</span> =</span> file-&gt;f_mapping-&gt;host;</span><br><span class="line">	<span class="keyword">int</span> err;</span><br><span class="line">	<span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">	err = file_write_and_wait_range(file, start, end);</span><br><span class="line">	<span class="keyword">if</span> (err)</span><br><span class="line">		<span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">	inode_lock(inode);</span><br><span class="line">	ret = sync_mapping_buffers(inode-&gt;i_mapping);</span><br><span class="line">	<span class="keyword">if</span> (!(inode-&gt;i_state &amp; I_DIRTY_ALL))</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line">	<span class="keyword">if</span> (datasync &amp;&amp; !(inode-&gt;i_state &amp; I_DIRTY_DATASYNC))</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">	err = sync_inode_metadata(inode, <span class="number">1</span>);</span><br><span class="line">	<span class="keyword">if</span> (ret == <span class="number">0</span>)</span><br><span class="line">		ret = err;</span><br><span class="line"></span><br><span class="line">out:</span><br><span class="line">	inode_unlock(inode);</span><br><span class="line">	<span class="comment">/* check and advance again to catch errors after syncing out buffers */</span></span><br><span class="line">	err = file_check_and_advance_wb_err(file);</span><br><span class="line">	<span class="keyword">if</span> (ret == <span class="number">0</span>)</span><br><span class="line">		ret = err;</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(__generic_file_fsync);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * generic_file_fsync - generic fsync implementation for simple filesystems</span></span><br><span class="line"><span class="comment"> *			with flush</span></span><br><span class="line"><span class="comment"> * @file:	file to synchronize</span></span><br><span class="line"><span class="comment"> * @start:	start offset in bytes</span></span><br><span class="line"><span class="comment"> * @end:	end offset in bytes (inclusive)</span></span><br><span class="line"><span class="comment"> * @datasync:	only synchronize essential metadata if true</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">generic_file_fsync</span><span class="params">(struct file *file, <span class="keyword">loff_t</span> start, <span class="keyword">loff_t</span> end,</span></span></span><br><span class="line"><span class="params"><span class="function">		       <span class="keyword">int</span> datasync)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *<span class="title">inode</span> =</span> file-&gt;f_mapping-&gt;host;</span><br><span class="line">	<span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line">	err = __generic_file_fsync(file, start, end, datasync);</span><br><span class="line">	<span class="keyword">if</span> (err)</span><br><span class="line">		<span class="keyword">return</span> err;</span><br><span class="line">	<span class="keyword">return</span> blkdev_issue_flush(inode-&gt;i_sb-&gt;s_bdev, GFP_KERNEL, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(generic_file_fsync);</span><br></pre></td></tr></table></figure>

<p>æ— è®º <code>fsync</code> è¿˜æ˜¯ <code>fdatasync</code> éƒ½ä¼šè°ƒç”¨ <code>file_write_and_wait_range</code> ä¸‹åˆ· page cache ä¸­çš„è„é¡µã€‚è€Œåœ¨ indoe æœ¬èº«å…ƒæ•°æ®åªæ˜¯æ—¶é—´æˆ³æ˜¯è„æ—¶ï¼Œ<code>fdatasync</code> å°±ä¼šè·³è¿‡ <code>sync_inode_metadata</code>ï¼Œä¸å°†å…ƒæ•°æ®ä¸€èµ·ä¸‹åˆ·åˆ°åº•å±‚è®¾å¤‡ä¸Šï¼›<code>fsync</code> åˆ™ä¸ä¼šè·³è¿‡å…ƒæ•°æ®çš„ä¸‹åˆ·ã€‚</p>
<p>å› æ­¤ <code>fsync</code> è‡³å°‘éœ€è¦ä¸¤æ¬¡ IO å†™æ“ä½œï¼Œå¼€é”€æ¯” <code>fdatasync</code> æ›´å¤§</p>
<h3 id="open-æ—¶å¸¦æœ‰-O-SYNC"><a href="#open-æ—¶å¸¦æœ‰-O-SYNC" class="headerlink" title="open æ—¶å¸¦æœ‰ O_SYNC"></a><code>open</code> æ—¶å¸¦æœ‰ <code>O_SYNC</code></h3><p>å¦‚æœåœ¨æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶æ—¶å¸¦äº† <code>O_SYNC</code> æ ‡è®°ï¼Œåˆ™ä¼šåœ¨å†™å…¥ page cache åï¼Œå†æ¬¡è°ƒç”¨ <code>vfs_fsync_range</code> å°†æ•°æ®ä¸‹åˆ·åˆ°åº•å±‚è®¾å¤‡ä¸Š</p>
<pre class="mermaid">  graph LR;
  writeç³»ç»Ÿè°ƒç”¨ --> ksys_write --> vfs_write --> __vfs_write -->|ext4,f2fsç­‰æ–‡ä»¶ç³»ç»Ÿ| new_sync_write</pre>

<p>åœ¨ <code>ext4</code>ã€<code>f2fs</code> ç­‰æ–‡ä»¶ç³»ç»Ÿ <code>write</code> ç³»ç»Ÿè°ƒç”¨ä¼šä½¿ç”¨ <code>new_sync_write</code> æ¥è°ƒç”¨å®é™…æ–‡ä»¶ç³»ç»Ÿæ³¨å†Œçš„ <code>read_iter</code> å‡½æ•°</p>
<p>è€Œ <code>new_sync_write</code> è°ƒç”¨å…ˆè°ƒç”¨ <code>iocb_flags</code> å°†ç”¨æˆ·é…ç½®çš„ <code>O_SYNC</code> è¿›è¡Œè§£æï¼Œä¸º <code>struct kiocb</code> çš„ <code>ki_flags</code> å­—æ®µç”Ÿæˆæ ‡è®°</p>
<pre class="mermaid">  graph TD;
  new_sync_write --> init_sync_kiocb --> iocb_flags
  new_sync_write --> iov_iter_init
  new_sync_write --> call_write_iter</pre>

<p>å’Œä¹‹å‰ä¸€æ ·ï¼Œå¤§å¤šæ•°æ–‡ä»¶ç³»ç»Ÿä¼šç›´æ¥ä½¿ç”¨æˆ–è€…å‚è€ƒé€šç”¨çš„ <code>generic_file_write_iter</code> æ¥å®ç° <code>read_iter</code> å‡½æ•°ï¼Œè¿™é‡Œé’ˆå¯¹ <code>generic_file_write_iter</code> è¿›è¡Œåˆ†æ</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// mm/filemap.c</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * generic_file_write_iter - write data to a file</span></span><br><span class="line"><span class="comment"> * @iocb:	IO state structure</span></span><br><span class="line"><span class="comment"> * @from:	iov_iter with data to write</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This is a wrapper around __generic_file_write_iter() to be used by most</span></span><br><span class="line"><span class="comment"> * filesystems. It takes care of syncing the file in case of O_SYNC file</span></span><br><span class="line"><span class="comment"> * and acquires i_mutex as needed.</span></span><br><span class="line"><span class="comment"> * Return:</span></span><br><span class="line"><span class="comment"> * * negative error code if no data has been written at all of</span></span><br><span class="line"><span class="comment"> *   vfs_fsync_range() failed for a synchronous write</span></span><br><span class="line"><span class="comment"> * * number of bytes written, even for truncated writes</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">generic_file_write_iter</span><span class="params">(struct kiocb *iocb, struct iov_iter *from)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">file</span> =</span> iocb-&gt;ki_filp;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *<span class="title">inode</span> =</span> file-&gt;f_mapping-&gt;host;</span><br><span class="line">	<span class="keyword">ssize_t</span> ret;</span><br><span class="line"></span><br><span class="line">	inode_lock(inode);</span><br><span class="line">	ret = generic_write_checks(iocb, from);</span><br><span class="line">	<span class="keyword">if</span> (ret &gt; <span class="number">0</span>)</span><br><span class="line">		ret = __generic_file_write_iter(iocb, from);</span><br><span class="line">	inode_unlock(inode);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (ret &gt; <span class="number">0</span>)</span><br><span class="line">		ret = generic_write_sync(iocb, ret);</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(generic_file_write_iter);</span><br></pre></td></tr></table></figure>

<p>åœ¨ <code>__generic_file_write_iter</code> å®Œæˆä¹‹åï¼Œå®é™…çš„æ•°æ®å·²ç»è¢«å†™å…¥ page cacheï¼Œä¹‹åä¼šè°ƒç”¨ <code>generic_write_sync</code> ä¼šå°†åˆšåˆšå†™å…¥ page cache çš„æ•°æ®é€šè¿‡ <code>vfs_fsync_range</code> ä¸‹åˆ·åˆ°åº•å±‚è®¾å¤‡ä¸Š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// include/linux/fs.h</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Sync the bytes written if this was a synchronous write.  Expect ki_pos</span></span><br><span class="line"><span class="comment"> * to already be updated for the write, and will return either the amount</span></span><br><span class="line"><span class="comment"> * of bytes passed in, or an error if syncing the file failed.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">ssize_t</span> <span class="title">generic_write_sync</span><span class="params">(struct kiocb *iocb, <span class="keyword">ssize_t</span> count)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (iocb-&gt;ki_flags &amp; IOCB_DSYNC) &#123;</span><br><span class="line">		<span class="keyword">int</span> ret = vfs_fsync_range(iocb-&gt;ki_filp,</span><br><span class="line">				iocb-&gt;ki_pos - count, iocb-&gt;ki_pos - <span class="number">1</span>,</span><br><span class="line">				(iocb-&gt;ki_flags &amp; IOCB_SYNC) ? <span class="number">0</span> : <span class="number">1</span>);</span><br><span class="line">		<span class="keyword">if</span> (ret)</span><br><span class="line">			<span class="keyword">return</span> ret;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>å­˜å‚¨</category>
        <category>IO</category>
      </categories>
      <tags>
        <tag>page cache</tag>
        <tag>buffer IO</tag>
        <tag>writeback</tag>
      </tags>
  </entry>
  <entry>
    <title>OpenWrt ç®€ä»‹å’Œå®‰è£…</title>
    <url>/posts/8507aaa1.html</url>
    <content><![CDATA[<h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><h3 id="æ¥æº"><a href="#æ¥æº" class="headerlink" title="æ¥æº"></a>æ¥æº</h3><p>2002 å¹´åº• Linksys å…¬å¸æ¨å‡º WRT-54Gï¼Œé‡‡ç”¨äº† Linux å–ä»£äº†åŸæ¥çš„ vXworks ç³»ç»Ÿã€‚è¿«äº Linux çš„å¼€æºåè®®è¦æ±‚ï¼ŒLinksys å¼€æºäº†è·¯ç”±å™¨çš„å›ºä»¶ä»£ç ï¼Œåç»­é€æ¸å‘å±•æˆäº† OpenWrt è¿™æ ·ä¸€ä¸ªé¡¹ç›®</p>
<span id="more"></span>
<h3 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h3><p>OpenWrt æ˜¯ä¸€ä¸ªé’ˆå¯¹åµŒå…¥å¼è®¾å¤‡ï¼ˆé€šå¸¸æ˜¯è·¯ç”±å™¨æˆ–è€…è½¯è·¯ç”±ï¼‰çš„ Linux æ“ä½œç³»ç»Ÿé¡¹ç›®ï¼Œæä¾›äº†å…·æœ‰è½¯ä»¶åŒ…ç®¡ç†åŠŸèƒ½çš„å®Œå…¨å¯å†™çš„æ–‡ä»¶ç³»ç»Ÿï¼Œå› æ­¤æ‹¥æœ‰äº†å®Œå…¨å®šåˆ¶çš„èƒ½åŠ›ï¼Œå¯ä»¥æ¦¨å¹²è®¾å¤‡çš„å…¨éƒ¨æ€§èƒ½</p>
<h2 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h2><p>åˆæ¬¡å®‰è£…æ¨èåœ¨ <a href="https://openwrt.org/toh/start">æ”¯æŒè®¾å¤‡åˆ—è¡¨</a> ä¸­æ‰¾åˆ°å¯¹åº”è®¾å¤‡æ‰€åœ¨çš„ <a href="https://openwrt.org/toh/start?datasrt=%5Edevice%20page">è®¾å¤‡ä¸“å±é¡µé¢</a>ï¼Œç„¶åæ ¹æ®é¡µé¢ä»‹ç»è¿›è¡Œå®‰è£…</p>
<h3 id="ä¸€èˆ¬å®‰è£…æµç¨‹"><a href="#ä¸€èˆ¬å®‰è£…æµç¨‹" class="headerlink" title="ä¸€èˆ¬å®‰è£…æµç¨‹"></a>ä¸€èˆ¬å®‰è£…æµç¨‹</h3><p>é€šå¸¸çš„å®‰è£…æ­¥éª¤ä¸»è¦é€šè¿‡ä»¥ä¸‹æµç¨‹ï¼š</p>
<ol>
<li>è·å–åŸå‚å›ºä»¶çš„ SSH ç™»å½•æƒé™ï¼ˆå¯èƒ½æ˜¯é€šè¿‡åŸå‚å›ºä»¶æ¼æ´ç­‰æ–¹å¼ï¼‰</li>
<li>åœ¨åŸå‚å›ºä»¶ä¸Šåˆ©ç”¨ <code>cat /proc/mtd</code> è·å– ROM åˆ†åŒºçš„å¸ƒå±€</li>
<li>[å¯é€‰] å¤‡ä»½åŸæœ‰çš„æ‰€æœ‰ ROM åˆ†åŒºæ•°æ®</li>
<li>åˆ©ç”¨ <code>mtd</code> ç­‰å‘½ä»¤ç›´æ¥å¯¹ç›¸åº”çš„ ROM åŒºåŸŸè¿›è¡Œå†™å…¥é•œåƒ<ul>
<li>[å¯é€‰] bootloader é•œåƒï¼ˆè®¾å¤‡è¿è¡Œçš„æƒ…å†µä¸‹ï¼Œä¸ªäººæ›´å€¾å‘äºåˆ·å…¥ <a href="/posts/53d6c2d9.html">Breed</a>ï¼‰</li>
<li>kernel é•œåƒ</li>
<li>rootfs é•œåƒ</li>
</ul>
</li>
<li>é‡å¯è®¾å¤‡</li>
</ol>
<h3 id="å›ºä»¶æœç´¢ä¸‹è½½"><a href="#å›ºä»¶æœç´¢ä¸‹è½½" class="headerlink" title="å›ºä»¶æœç´¢ä¸‹è½½"></a>å›ºä»¶æœç´¢ä¸‹è½½</h3><p>å®˜ç½‘ä¹Ÿå¯¹è€æ‰‹æä¾›äº†å¿«æ·çš„ <a href="https://firmware-selector.openwrt.org/">å›ºä»¶æœç´¢</a> é¡µé¢ï¼Œèƒ½å¤Ÿæ›´åŠ å¿«æ·çš„æ‰¾åˆ° ROM é•œåƒçš„ä¸‹è½½ç•Œé¢</p>
<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul>
<li><a href="https://zh.wikipedia.org/wiki/OpenWrt">ã€ç»´åŸºç™¾ç§‘ã€‘OpenWrt</a></li>
<li><a href="https://openwrt.org/">ã€OpenWrtã€‘å®˜ç½‘</a></li>
<li><a href="https://openwrt.org/toh/start">ã€OpenWrtã€‘æ”¯æŒè®¾å¤‡åˆ—è¡¨</a></li>
<li><a href="https://firmware-selector.openwrt.org/">ã€OpenWrtã€‘å›ºä»¶æœç´¢</a></li>
</ul>
]]></content>
      <categories>
        <category>è·¯ç”±å™¨</category>
      </categories>
      <tags>
        <tag>OpenWrt</tag>
      </tags>
  </entry>
  <entry>
    <title>OpenWrt æ‰‹åŠ¨ç¼–è¯‘ ipk</title>
    <url>/posts/96a1807.html</url>
    <content><![CDATA[<h2 id="ipk-æ–‡ä»¶"><a href="#ipk-æ–‡ä»¶" class="headerlink" title=".ipk æ–‡ä»¶"></a><code>.ipk</code> æ–‡ä»¶</h2><p><code>.ipk</code> æ–‡ä»¶æ˜¯å¯ä»¥é€šè¿‡ OpenWrt çš„åŒ…ç®¡ç†è½¯ä»¶ <code>opkg</code> ç›´æ¥å®‰è£…ï¼Œå¥½æ¯” <code>.deb</code> æ–‡ä»¶ä¸ <code>apt</code> çš„å…³ç³»ã€‚è™½ç„¶å®˜æ–¹çš„è½¯ä»¶ä»“åº“å·²ç»å¾ˆä¸°å¯Œäº†ï¼Œä½†æ˜¯æœ‰æ—¶ä»ç„¶éœ€è¦ä»æºç ç¼–è¯‘ä¸€äº›ç¬¬ä¸‰æ–¹çš„è½¯ä»¶ä½¿ç”¨ï¼Œä¾‹å¦‚é”æ·è®¤è¯ç­‰</p>
<p>ä½†æ˜¯ç”±äºè·¯ç”±å™¨å¹³å°é€šå¸¸ä¸å¸¸ç”¨çš„æœåŠ¡å™¨æˆ–è€…ä¸ªäºº PC çš„å¤„ç†å™¨æ¶æ„ä¸åŒï¼Œå¹¶ä¸”è·¯ç”±å™¨çš„å¤„ç†å™¨æœ¬èº«æ€§èƒ½è¾ƒå¼±ï¼Œå‡ ä¹ä¸å¯èƒ½ç›´æ¥åœ¨è·¯ç”±å™¨ä¸Šè¿›è¡Œç¼–è¯‘ç”Ÿæˆ <code>.ipk</code> æ–‡ä»¶ï¼Œå› æ­¤éœ€è¦äº¤å‰ç¼–è¯‘æ¥å®ç°</p>
<span id="more"></span>
<p>è€Œå®˜æ–¹çš„ <a href="https://github.com/openwrt/openwrt">OpenWrt</a> ä»“åº“å°±æä¾›äº†ä¸€ä¸ªæ–¹ä¾¿ä½¿ç”¨çš„äº¤å‰ç¼–è¯‘ç¯å¢ƒ</p>
<h2 id="ç¼–è¯‘å‡†å¤‡"><a href="#ç¼–è¯‘å‡†å¤‡" class="headerlink" title="ç¼–è¯‘å‡†å¤‡"></a>ç¼–è¯‘å‡†å¤‡</h2><p>ä»¥ Debian / Ubuntu ä¸ºä¾‹ï¼Œå‚è€ƒ <a href="https://openwrt.org/docs/guide-developer/toolchain/install-buildsystem">å®˜ç½‘ç»™å‡ºçš„è¦æ±‚</a>ï¼Œå¯ä»¥é€šè¿‡ä¸‹é¢å‘½ä»¤æ¥è¿›è¡Œå®‰è£…ä¾èµ–åŒ…</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt update</span><br><span class="line">sudo apt install build-essential ccache ecj fastjar file g++ gawk \</span><br><span class="line">gettext git java-propose-classpath libelf-dev libncurses5-dev \</span><br><span class="line">libncursesw5-dev libssl-dev python python2.7-dev python3 unzip wget \</span><br><span class="line">python3-distutils python3-setuptools python3-dev rsync subversion \</span><br><span class="line">swig time xsltproc zlib1g-dev</span><br></pre></td></tr></table></figure>

<p>å®‰è£…/æ›´æ–°å¥½è¿™äº›ä¾èµ–ä¹‹åï¼Œå°±å¯ä»¥é€šè¿‡ <code>git</code> æ‹‰å– OpenWrt ä»“åº“äº†</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://git.openwrt.org/openwrt/openwrt.git</span><br></pre></td></tr></table></figure>

<p>é€šå¸¸ç”±äºä»“åº“è¾ƒå¤§ä»¥åŠç½‘é€Ÿé—®é¢˜ï¼Œå¯èƒ½ä¼šéœ€è¦å¾ˆä¹…ï¼Œå…¶å®å¯ä»¥é€šè¿‡ <code>--depth</code> æ¥é™åˆ¶æ‹‰å–çš„ä»“åº“æ·±åº¦ï¼Œæˆ–è€…é€šè¿‡é•œåƒç«™æ¥åŠ é€Ÿæ‹‰å–ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ä¸¤è€…åŒæ—¶é‡‡ç”¨</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://git.openwrt.org/openwrt/openwrt.git --depth=1</span><br><span class="line">git <span class="built_in">clone</span> https://git.openwrt.org.cnpmjs.org/openwrt/openwrt.git</span><br><span class="line">git <span class="built_in">clone</span> https://git.openwrt.org.cnpmjs.org/openwrt/openwrt.git --depth=1</span><br></pre></td></tr></table></figure>

<h2 id="ç¼–è¯‘-ipk-æ–‡ä»¶"><a href="#ç¼–è¯‘-ipk-æ–‡ä»¶" class="headerlink" title="ç¼–è¯‘ .ipk æ–‡ä»¶"></a>ç¼–è¯‘ <code>.ipk</code> æ–‡ä»¶</h2><h3 id="æ›´æ–°-feeds"><a href="#æ›´æ–°-feeds" class="headerlink" title="æ›´æ–° feeds"></a>æ›´æ–° feeds</h3><p>è¿›å…¥ openwrt ä»“åº“åï¼Œé¦–å…ˆéœ€è¦æ›´æ–°è½¯ä»¶åŒ…åˆ—è¡¨ <code>feeds</code>ï¼Œå®ƒæ˜¯åœ¨ OpenWrt ä¸­å…±ç”¨ä½ç½®çš„åŒ…çš„é›†åˆã€‚è¿è¡Œä»¥ä¸‹å‘½ä»¤å³å¯æ›´æ–°å†…ç½®è½¯ä»¶åŒ…åˆ—è¡¨å¹¶é“¾æ¥åˆ°ç¼–è¯‘å·¥å…·ä¸­ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> openwrt/</span><br><span class="line">./scripts/feeds update</span><br><span class="line">./scripts/feeds install</span><br></pre></td></tr></table></figure>

<h3 id="é…ç½®å¹³å°"><a href="#é…ç½®å¹³å°" class="headerlink" title="é…ç½®å¹³å°"></a>é…ç½®å¹³å°</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">make menuconfig</span><br></pre></td></tr></table></figure>

<p>é€šå¸¸ä½¿ç”¨å›¾å½¢åŒ–èœå•ç•Œé¢æ¥è¿›è¡Œé…ç½®ç¼–è¯‘é€‰é¡¹ï¼Œä¾æ¬¡é…ç½®å¤„ç†å™¨æ¶æ„ã€å…·ä½“çš„å¤„ç†å™¨å‹å·ä»¥åŠè®¾å¤‡</p>
<p>ä»¥å°ç±³ mini è·¯ç”±å™¨ä¸ºä¾‹ï¼Œåº”è¯¥å°†ä»–ä»¬é…ç½®æˆå¦‚ä¸‹å›¾æ‰€ç¤º</p>
<p><img data-src="/posts/96a1807/Target-Config.png" alt="å¹³å°é…ç½®"></p>
<h3 id="è·å–äº¤å‰ç¼–è¯‘é“¾"><a href="#è·å–äº¤å‰ç¼–è¯‘é“¾" class="headerlink" title="è·å–äº¤å‰ç¼–è¯‘é“¾"></a>è·å–äº¤å‰ç¼–è¯‘é“¾</h3><p>è¿™ä¸€æ­¥å°±æ˜¯è·å–å¯¹åº”è®¾å¤‡äº¤å‰ç¼–è¯‘æ‰€éœ€çš„ç¼–è¯‘é“¾</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">make tools/install V=s -j$(grep processor /proc/cpuinfo | wc -l)</span><br><span class="line">make toolchain/install V=s -j$(grep processor /proc/cpuinfo | wc -l)</span><br></pre></td></tr></table></figure>

<ul>
<li><code>V=s</code> å¯ä»¥æ˜¾ç¤º <code>make</code> è¿‡ç¨‹ä¸­çš„æ‰€æœ‰è¾“å‡ºï¼Œæ–¹ä¾¿å®šä½å½“å‰æ˜¯å¦å¡åœ¨äº†æŸä¸€æ­¥éª¤ä¸Š</li>
<li><code>-j$(grep processor /proc/cpuinfo | wc -l)</code> åˆ™æ˜¯æ ¹æ®æœºå™¨çš„ CPU æ•°é‡æ¥è¿›è¡Œå¤šçº¿ç¨‹ç¼–è¯‘</li>
</ul>
<h3 id="æ·»åŠ éœ€è¦ç¼–è¯‘çš„ç¬¬ä¸‰æ–¹è½¯ä»¶åŒ…"><a href="#æ·»åŠ éœ€è¦ç¼–è¯‘çš„ç¬¬ä¸‰æ–¹è½¯ä»¶åŒ…" class="headerlink" title="æ·»åŠ éœ€è¦ç¼–è¯‘çš„ç¬¬ä¸‰æ–¹è½¯ä»¶åŒ…"></a>æ·»åŠ éœ€è¦ç¼–è¯‘çš„ç¬¬ä¸‰æ–¹è½¯ä»¶åŒ…</h3><p>å¯ä»¥å…ˆæœç´¢æœ‰æ²¡æœ‰å·²ç»é…ç½®å¥½çš„å«æœ‰ <code>Makefile</code> çš„ä»“åº“ï¼Œæœ‰äº†é€‚é…è¿‡çš„ <code>Makefile</code> æ–‡ä»¶å°±å¯ä»¥å¾ˆæ–¹ä¾¿çš„æ¥ç¼–è¯‘æºç ç”Ÿæˆ <code>.ipk</code> æ–‡ä»¶äº†</p>
<p>ä»¥ <code>minieap</code> ä¸ºä¾‹ï¼Œ<a href="https://github.com/BoringCat/minieap-openwrt">github</a> ä¸Šæœ‰å·²ç»å®Œæˆçš„ä»“åº“ï¼Œä¾æ¬¡å¯ä»¥ç›´æ¥æ‹‰å–æ¥ç¼–è¯‘</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/BoringCat/minieap-openwrt.git package/minieap</span><br></pre></td></tr></table></figure>

<p>åœ¨æ‹‰å–å®Œæˆä»“åº“åï¼Œå°±å¯ä»¥å†æ¬¡é…ç½®ç¼–è¯‘é€‰é¡¹ï¼Œå°†éœ€è¦ç¼–è¯‘æˆ <code>.ipk</code> çš„åŠŸèƒ½é…ç½®æˆæ¨¡å—ç¼–è¯‘ï¼Œä¹Ÿå°±æ˜¯æ ‡è®°æˆ <code>M</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">make menuconfig</span><br></pre></td></tr></table></figure>

<p>å¯¹äº <code>minieap</code> æ¥è¯´ï¼Œåœ¨ <code>Network</code> æ‰¾åˆ°å¯¹åº”é€‰é¡¹å¹¶é…ç½®æˆ <code>M</code> å³å¯ï¼Œå¦‚ä¸‹å›¾</p>
<p><img data-src="/posts/96a1807/MiniEAP-Config.png" alt="MiniEAP é…ç½®"></p>
<p>é…ç½®å®Œæˆåå°±å¯ä»¥è¿›è¡Œç¼–è¯‘äº†ï¼Œç¼–è¯‘å‘½ä»¤ä¹Ÿå¾ˆç®€å•ï¼Œä»¥ <code>minieap</code> ä¸ºä¾‹å¦‚ä¸‹æ‰€ç¤º</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">make package/minieap/compile V=s -j$(grep processor /proc/cpuinfo | wc -l)</span><br></pre></td></tr></table></figure>

<p>ç¼–è¯‘å®Œæˆåï¼Œ<code>.ipk</code> æ–‡ä»¶ä¼šç”Ÿæˆåœ¨  <code>./bin/packages/&lt;YourArchitecture&gt;/base</code> ç›®å½•ä¸‹ï¼Œå°†å…¶æ‹·è´åˆ°è·¯ç”±å™¨ä¸Šå°±å¯ä»¥é€šè¿‡ <code>opkg</code> è¿›è¡Œå®‰è£…ä½¿ç”¨äº†</p>
<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul>
<li><a href="https://openwrt.org/docs/guide-developer/toolchain/install-buildsystem">ã€OpenWrtã€‘ç¼–è¯‘ç³»ç»Ÿå‡†å¤‡</a></li>
<li><a href="https://openwrt-nctu.gitbook.io/project/openwrt-compile-env/openwrt-sdk-and-ipk-format">ã€Gitbookã€‘å»ºç«‹ç¼–è¯‘ç¯å¢ƒ</a></li>
<li><a href="https://github.com/openwrt/openwrt">ã€GitHubã€‘OpenWrt</a></li>
<li><a href="https://github.com/KyleRicardo/MentoHUST-OpenWrt-ipk">ã€GitHubã€‘MentoHUST-OpenWrt-ipk</a></li>
<li><a href="https://github.com/BoringCat/minieap-openwrt">ã€GitHubã€‘minieap-openwrt</a></li>
</ul>
]]></content>
      <categories>
        <category>è·¯ç”±å™¨</category>
      </categories>
      <tags>
        <tag>OpenWrt</tag>
        <tag>äº¤å‰ç¼–è¯‘</tag>
        <tag>ipk</tag>
      </tags>
  </entry>
  <entry>
    <title>OpenWrt é…ç½®ä½¿ç”¨</title>
    <url>/posts/51140c4a.html</url>
    <content><![CDATA[<h2 id="Web-ç•Œé¢"><a href="#Web-ç•Œé¢" class="headerlink" title="Web ç•Œé¢"></a>Web ç•Œé¢</h2><p>ä¸€èˆ¬ OpenWrt å®‰è£…å¥½ä¹‹åä¼šå·²ç»é»˜å¯ç”¨äº† Web ç®¡ç†ç•Œé¢ï¼ˆLuCIï¼‰ï¼Œé»˜è®¤åœ°å€æ˜¯ <code>192.168.1.1</code>ï¼Œé»˜è®¤è´¦å·æ˜¯ <code>root</code>ï¼Œæ— å¯†ç ï¼Œç›´æ¥ç‚¹å‡»ç™»å½•å³å¯è¿›å…¥</p>
<span id="more"></span>
<h3 id="æ±‰åŒ–"><a href="#æ±‰åŒ–" class="headerlink" title="æ±‰åŒ–"></a>æ±‰åŒ–</h3><p>é»˜è®¤ç•Œé¢æ˜¯è‹±æ–‡çš„ï¼Œå¯ä»¥åœ¨ <a href="http://192.168.1.1/cgi-bin/luci/admin/system/opkg">ç³»ç»Ÿ-è½¯ä»¶</a> ä¸­æœç´¢ä¸­æ–‡åŒ…å®‰è£…è¿›è¡Œæ±‰åŒ–</p>
<ul>
<li>ç‚¹å‡» <code>UPDATE LIST...</code> è€å¿ƒç­‰å¾…è½¯ä»¶åŒ…çš„æ›´æ–°</li>
<li>ç„¶ååœ¨ <code>Filter:</code> ä¸‹çš„è¾“å…¥æ¡†ä¸­è¾“å…¥ <code>luci-i18n-base-zh-cn</code>ï¼Œåœ¨ç­›é€‰å‡ºæ¥çš„ç»“æœä¸­ç‚¹å‡» <code>INSTALL...</code>ï¼Œå®‰è£…å‹¾ä¸Š <code>Overwrite files from other package(s)</code>ï¼Œç„¶åç‚¹å‡» <code>INSTALL</code>ï¼Œè€å¿ƒç­‰å¾…å®‰è£…å®Œæˆä¹‹ååˆ·æ–°ç½‘é¡µï¼ˆCtrl+F5ï¼‰å¯ä»¥çœ‹è§å¤§éƒ¨åˆ†ç•Œé¢å·²ç»æ±‰åŒ–äº†</li>
<li>åŒç†å®‰è£… <code>luci-i18n-opkg-zh-cn</code> åŒ…ç”¨äº <a href="http://192.168.1.1/cgi-bin/luci/admin/system/opkg">ç³»ç»Ÿ-è½¯ä»¶</a> ç•Œé¢çš„æ±‰åŒ–</li>
<li>åŒç†å®‰è£… <code>luci-i18n-firewall-zh-cn</code> åŒ…ç”¨äº <a href="http://192.168.1.1/cgi-bin/luci/admin/network/firewall">ç½‘ç»œ-é˜²ç«å¢™</a> ç•Œé¢çš„æ±‰åŒ–</li>
</ul>
<h3 id="root-å¯†ç "><a href="#root-å¯†ç " class="headerlink" title="root å¯†ç "></a>root å¯†ç </h3><p>è¿›å…¥ç®¡ç†ç•Œé¢åè¿›å…¥ <a href="http://192.168.1.1/cgi-bin/luci/admin/system/admin/password">ç³»ç»Ÿ-ç®¡ç†-å¯†ç </a> ç•Œé¢ä¿®æ”¹è·¯ç”±å™¨å¯†ç ï¼ŒåŒæ—¶ä¹Ÿæ˜¯ç³»ç»Ÿçš„ root è´¦å·çš„å¯†ç </p>
<h3 id="ssh"><a href="#ssh" class="headerlink" title="ssh"></a>ssh</h3><p>ç„¶ååœ¨ <a href="http://192.168.1.1/cgi-bin/luci/admin/system/admin/dropbear">ç³»ç»Ÿ-ç®¡ç†-ssh</a> å¯ä»¥é…ç½® ssh ç™»å½•ï¼Œå‚è€ƒé…ç½®å¦‚ä¸‹</p>
<ul>
<li>æ¥å£ï¼šä¸æŒ‡å®š â†’ å†…ç½‘ä»¥åŠå¤–ç½‘éƒ½å¯ä»¥ ssh ç™»å½•</li>
<li>ç«¯å£ï¼š22 â†’ ssh é»˜è®¤ç«¯å£ï¼Œä¸åšä¿®æ”¹</li>
<li>å¯†ç éªŒè¯ï¼šä¸å‹¾é€‰ â†’ æ¨èä½¿ç”¨ ssh ç™»å½•</li>
<li>å…è®¸ root ç”¨æˆ·å‡­å¯†ç ç™»å½•ï¼šä¸å‹¾é€‰ â†’ æ¨èä½¿ç”¨ ssh ç™»å½•</li>
<li>ç½‘å…³ç«¯å£ï¼šæ ¹æ®éœ€è¦å‹¾é€‰</li>
</ul>
<p>æŒ‰ç…§ä¸Šé¢é…ç½®å®Œæˆåå°†åªèƒ½é€šè¿‡ ssh å¯†é’¥è¿›è¡Œç™»å½•ï¼Œæ‰€ä»¥è¿˜å¾—åœ¨ <a href="http://192.168.1.1/cgi-bin/luci/admin/system/admin/sshkeys">ç³»ç»Ÿ-ç®¡ç†-sshå¯†é’¥</a> æ·»åŠ è®¾å¤‡çš„å…¬é’¥</p>
<h3 id="å‡çº§-LuCI"><a href="#å‡çº§-LuCI" class="headerlink" title="å‡çº§ LuCI"></a>å‡çº§ LuCI</h3><p>ssh ç™»å…¥è·¯ç”±å™¨åæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æ›´æ–°è½¯ä»¶æº</span></span><br><span class="line">opkg update</span><br><span class="line"><span class="comment"># luci-compat åŒ…æœ‰æ—¶å¯ä»¥å¸®åŠ©è§£å†³ä¸€äº›å…¼å®¹æ€§é—®é¢˜ï¼Œæ¨èä¸€åŒå®‰è£…</span></span><br><span class="line">opkg install luci luci-base luci-compat</span><br></pre></td></tr></table></figure>

<h3 id="ç¾åŒ–"><a href="#ç¾åŒ–" class="headerlink" title="ç¾åŒ–"></a>ç¾åŒ–</h3><p>åŸå§‹çš„ <code>bootstrap</code> ä¸»é¢˜ä¸ªäººä¸å¤ªå–œæ¬¢ï¼Œåœ¨ç©ºé—´è¶³å¤Ÿçš„æƒ…å†µä¸‹æˆ‘ä¸ªäººé¢å¤–å®‰è£…äº† <code>material</code>ï¼Œä¸»é¢˜çš„åˆ‡æ¢åœ¨ <a href="http://192.168.1.1/cgi-bin/luci/admin/system/system">ç³»ç»Ÿ-ç³»ç»Ÿ-è¯­è¨€å’Œç•Œé¢</a> ä¸­</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">opkg update</span><br><span class="line">opkg install luci-theme-material</span><br></pre></td></tr></table></figure>

<h2 id="é”æ·è®¤è¯"><a href="#é”æ·è®¤è¯" class="headerlink" title="é”æ·è®¤è¯"></a>é”æ·è®¤è¯</h2><p>å¾ˆå¤šå­¦æ ¡æ ¡å›­ç½‘é€šå¸¸é‡‡ç”¨é”æ·è®¤è¯ï¼Œå¹¶ä¸”é™åˆ¶äº†ç”¨æˆ·è´¦å·çš„ç™»é™†æ•°é‡ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨è·¯ç”±å™¨ä¸Šè¿›è¡Œé”æ·è®¤è¯æ¥æ¥å…¥æ ¡å›­ç½‘ï¼Œä¹‹åè¿æ¥è·¯ç”±å™¨çš„æ‰€æœ‰è®¾å¤‡éƒ½ä¼šç›´æ¥æ¥å…¥æ ¡å›­ç½‘è€Œä¸éœ€è¦è®¤è¯äº†</p>
<h3 id="MentoHUST"><a href="#MentoHUST" class="headerlink" title="MentoHUST"></a>MentoHUST</h3><p><a href="http://byhh.hust.edu.cn/cgi-bin/bbsnewtcon?board=NetResource&file=M.1230774282.A">MentoHUST</a> æ˜¯åä¸­ç§‘æŠ€å¤§å­¦çš„ <a href="http://byhh.hust.edu.cn/cgi-bin/bbsqry?userid=HustMoon">HustMoon</a> æœ€åˆåœ¨æ ¡å†… BBS ç™½äº‘é»„é¹¤ä¸Šå‘å¸ƒçš„ä¸€æ¬¾å¯ä»¥åœ¨ Linux ç³»ç»Ÿä¸Šè¿›è¡Œé”æ·è®¤è¯çš„è½¯ä»¶ã€‚ä¸è¿‡ <a href="https://code.google.com/archive/p/mentohust/">åŸå§‹é¡¹ç›®</a> å·²ç»å½’æ¡£ï¼Œä¸åœ¨å¼€å‘ï¼ŒGitHub ä¸Šæœ‰åŠ å…¥ v4 æ”¯æŒçš„ <a href="https://github.com/hyrathb/mentohust">æ–°é¡¹ç›®</a></p>
<p>è€Œåœ¨ OpenWrt å¯ä»¥é€šè¿‡ GitHub ä¸Šçš„ä¸¤ä¸ªé¡¹ç›®æ‰‹åŠ¨ç¼–è¯‘ <code>.ipk</code> æ–‡ä»¶ï¼Œç„¶å <code>opkg install xxx.ipk</code> è¿›è¡Œå®‰è£…å³å¯</p>
<ul>
<li>é€šè¿‡ <a href="https://github.com/KyleRicardo/MentoHUST-OpenWrt-ipk">MentoHUST-OpenWrt-ipk</a> OpenWrt é¡¹ç›®å¯ä»¥ç”Ÿæˆ  <code>mentohust</code> çš„äºŒè¿›åˆ¶æ–‡ä»¶</li>
<li>é€šè¿‡ <a href="https://github.com/BoringCat/luci-app-mentohust">OpenWrt/LEDE LuCI for MentoHUST</a> é¡¹ç›®å¯ä»¥ç”Ÿæˆ MentoHUST çš„ LuCI æ§åˆ¶ç•Œé¢</li>
</ul>
<p>æ‰‹åŠ¨ç¼–è¯‘ <code>ipk</code> æ–‡ä»¶çš„è¿‡ç¨‹å¯ä»¥å‚è€ƒ <a href="/posts/96a1807.html">è¿™é‡Œ</a></p>
<h3 id="MiniEAP"><a href="#MiniEAP" class="headerlink" title="MiniEAP"></a>MiniEAP</h3><p><a href="https://github.com/updateing/minieap">MiniEAP</a> æ˜¯ä¸€ä¸ªå®ç°äº†æ ‡å‡† EAP-MD5-Challenge ç®—æ³•çš„ EAP å®¢æˆ·ç«¯ï¼Œæ”¯æŒé€šè¿‡æ’ä»¶æ¥ä¿®æ”¹æ ‡å‡†æ•°æ®åŒ…ä»¥é€šè¿‡ç‰¹æ®ŠæœåŠ¡ç«¯çš„è®¤è¯ã€‚åŒæ—¶å«æœ‰æ”¯æŒé”æ· v3 (v4) ç®—æ³•çš„æ’ä»¶ï¼Œå¯ä»¥ç”¨æ¥è¿›è¡Œé”æ·è®¤è¯</p>
<p>è€Œåœ¨ OpenWrt å¯ä»¥é€šè¿‡ GitHub ä¸Šçš„ä¸¤ä¸ªé¡¹ç›®æ‰‹åŠ¨ç¼–è¯‘ <code>.ipk</code> æ–‡ä»¶ï¼Œç„¶å <code>opkg install xxx.ipk</code> è¿›è¡Œå®‰è£…å³å¯</p>
<ul>
<li>é€šè¿‡ <a href="https://github.com/BoringCat/minieap-openwrt">minieap-openwrt</a> é¡¹ç›®å¯ä»¥ç”Ÿæˆ <code>minieap</code> çš„äºŒè¿›åˆ¶æ–‡ä»¶</li>
<li>é€šè¿‡ <a href="https://github.com/BoringCat/luci-app-minieap">OpenWrt/LEDE LuCI for minieap</a> é¡¹ç›®å¯ä»¥ç”Ÿæˆ MiniEAP çš„ LuCI æ§åˆ¶ç•Œé¢</li>
</ul>
<h2 id="é˜²ç«å¢™"><a href="#é˜²ç«å¢™" class="headerlink" title="é˜²ç«å¢™"></a>é˜²ç«å¢™</h2><p>é˜²ç«å¢™è§„åˆ™çš„è¯¦ç»†é…ç½®å¯ä»¥å‚è€ƒ <a href="https://openwrt.org/docs/guide-user/firewall/firewall_configuration#rules">å®˜æ–¹çš„ä»‹ç»</a> ä»¥åŠéƒ¨åˆ† <a href="https://openwrt.org/zh-cn/doc/uci/firewall#%E4%B8%BE%E4%BE%8B">ä¾‹å­</a></p>
<h3 id="å¼€æ”¾ç«¯å£"><a href="#å¼€æ”¾ç«¯å£" class="headerlink" title="å¼€æ”¾ç«¯å£"></a>å¼€æ”¾ç«¯å£</h3><p>ä»¥å¼€æ”¾ 80 ç«¯å£ï¼Œç”¨äºå¤–ç½‘ç›´æ¥è®¿é—® Web ç•Œé¢ä¸ºä¾‹ï¼š</p>
<ol>
<li><p>é¦–å…ˆè¦åœ¨ <a href="http://192.168.1.1/cgi-bin/luci/admin/network/firewall/rules">ç½‘ç»œ-é˜²ç«å¢™-é€šä¿¡è§„åˆ™</a> ç‚¹å‡»æ–°å¢ï¼Œè¿›è¡Œå¦‚ä¸‹é…ç½®</p>
<p> <img data-src="/posts/51140c4a/Allow-LuCI-WAN.png" alt="å¼€æ”¾ 80 ç«¯å£"></p>
<ul>
<li>åç§°ï¼šå¯ä»¥éšæ„è®¾ç½®</li>
<li>åè®®ï¼šæ ¹æ®éœ€è¦è¿›è¡Œé€‰æ‹©å³å¯</li>
<li>æºåŒºåŸŸï¼šé€‰æ‹© WAN è¡¨ç¤ºæ˜¯ä»å¤–ç½‘è¿›è¡Œè®¿é—®</li>
<li>æºåœ°å€ä»¥åŠæºç«¯å£ï¼šä¸»è¦ç”¨äºé™åˆ¶æ¥è®¿çš„è®¾å¤‡ï¼Œå¯ä»¥æ ¹æ®éœ€è¦è¿›è¡Œé…ç½®</li>
<li>ç›®æ ‡åŒºåŸŸï¼šé€‰æ‹© <code>è®¾å¤‡</code> ä»£è¡¨è¿™æ˜¯ä¸€ä¸ªå…¥ç«™çš„è§„åˆ™</li>
<li>ç›®æ ‡åœ°å€ï¼šå› ä¸ºæ˜¯è®¿é—®è®¾å¤‡ï¼Œæ­¤æ—¶ä¸éœ€è¦é…ç½®</li>
<li>ç›®æ ‡ç«¯å£ï¼šWeb çš„é»˜è®¤ç«¯å£æ˜¯ 80</li>
<li>æ“ä½œï¼šå¼€æ”¾ç«¯å£ï¼Œå½“ç„¶æ˜¯é€‰æ‹©æ¥å—</li>
</ul>
</li>
<li><p>ç„¶ååœ¨ <a href="http://192.168.1.1/cgi-bin/luci/admin/status/iptables">çŠ¶æ€-é˜²ç«å¢™</a> æ ¹æ®éœ€è¦å¯¹ IPv4ã€IPv6 é˜²ç«å¢™è¿›è¡Œé‡å¯å³å¯</p>
</li>
</ol>
<p>å¦‚æœè¿™æ—¶å¤–ç½‘è¿˜æ˜¯ä¸èƒ½è®¿é—® LuCI çš„ Web ç•Œé¢ï¼Œå¯ä»¥å°è¯•è·¯ç”±å™¨é‡å¯ï¼Œç¡®è®¤è·¯ç”±å™¨çš„ IP æ˜¯å¦èƒ½å¤Ÿ ping é€šï¼Œä»¥åŠç¡®è®¤ 80 ç«¯å£æœ‰æ²¡æœ‰è¢«è¿è¥å•†å°ç¦</p>
<h3 id="ç«¯å£è½¬å‘"><a href="#ç«¯å£è½¬å‘" class="headerlink" title="ç«¯å£è½¬å‘"></a>ç«¯å£è½¬å‘</h3><p>ä»¥å°† Windows çš„è¿œç¨‹è¿æ¥çš„ç«¯å£ 3389 ä¸ºä¾‹ï¼š</p>
<ol>
<li><p>é¦–å…ˆè¦åœ¨ <a href="http://192.168.1.1/cgi-bin/luci/admin/network/firewall/forwards">ç½‘ç»œ-é˜²ç«å¢™-ç«¯å£è½¬å‘</a> ç‚¹å‡»æ–°å¢ï¼Œè¿›è¡Œå¦‚ä¸‹é…ç½®</p>
<p> <img data-src="/posts/51140c4a/Win-Remote.png" alt="ç«¯å£è½¬å‘"></p>
<ul>
<li>åç§°ï¼šå¯ä»¥éšæ„è®¾ç½®</li>
<li>åè®®ï¼šæ ¹æ®éœ€è¦è¿›è¡Œé€‰æ‹©å³å¯</li>
<li>æºåŒºåŸŸï¼šé€‰æ‹© WAN è¡¨ç¤ºæ˜¯ä»å¤–ç½‘è¿›è¡Œè®¿é—®</li>
<li>å¤–éƒ¨ç«¯å£ï¼šè¿™é‡Œé…ç½®æˆ 13389</li>
<li>ç›®æ ‡åŒºåŸŸï¼šé€‰æ‹© <code>LAN</code></li>
<li>å†…éƒ¨ IP åœ°å€ï¼šé…ç½®æˆå†…ç½‘éœ€è¦è¿œç¨‹è¿æ¥çš„ä¸»æœº</li>
<li>å†…éƒ¨ç«¯å£ï¼šè¿œç¨‹è¿æ¥çš„é»˜è®¤ç«¯å£æ˜¯ 3389</li>
</ul>
</li>
<li><p>ç„¶ååœ¨ <a href="http://192.168.1.1/cgi-bin/luci/admin/status/iptables">çŠ¶æ€-é˜²ç«å¢™</a> æ ¹æ®éœ€è¦å¯¹ IPv4ã€IPv6 é˜²ç«å¢™è¿›è¡Œé‡å¯å³å¯</p>
</li>
</ol>
<p>åç»­å°±å¯ä»¥é€šè¿‡è®¿é—®è·¯ç”±å™¨ <code>WAN_IP:13389</code> æ¥è¿œç¨‹è¿æ¥å†…ç½‘çš„ Windows ä¸»æœºäº†</p>
<h2 id="IPv6"><a href="#IPv6" class="headerlink" title="IPv6"></a>IPv6</h2><p>åœ¨æ ¡å›­ç½‘ç¯å¢ƒä¸‹å‘ç° WAN å£é»˜è®¤èƒ½è‡ªåŠ¨è·å–åˆ° IPv6 åœ°å€ï¼ˆä½†æ˜¯ /128 çš„åœ°å€ï¼‰ï¼Œå¹¶ä¸”åœ¨è·¯ç”±å™¨ä¸Šæµ‹è¯•ä¹Ÿèƒ½æ­£å¸¸è®¿é—® IPv6 ç½‘ç«™ï¼Œä½†æ˜¯å±€åŸŸç½‘å†…çš„è®¾å¤‡ä¸èƒ½æ­£å¸¸è®¿é—® IPv6 ç½‘ç«™ï¼Œäºæ˜¯é€‰æ‹© NAT6 çš„æ–¹å¼æ¥è§£å†³</p>
<p>å‚è€ƒ <a href="https://openwrt.org/docs/guide-user/network/ipv6/ipv6.nat6">å®˜ç½‘çš„ NAT6 æ–‡æ¡£</a>ï¼Œéœ€è¦åœ¨è·¯ç”±å™¨å†…ä¾æ¬¡è¿›è¡Œå¦‚ä¸‹é…ç½®ï¼š</p>
<ol>
<li><p>å®‰è£… kmod-ipt-nat6 åŒ…</p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Install packages</span></span><br><span class="line">opkg update</span><br><span class="line">opkg install kmod-ipt-nat6</span><br></pre></td></tr></table></figure></li>
<li><p>é…ç½® IPv6 ULA å‰ç¼€ï¼Œä½¿å¾—å†…ç½‘è®¾å¤‡é»˜è®¤ä½¿ç”¨ IPv6</p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Using IPv6 by default</span></span><br><span class="line">NET_ULA=<span class="string">&quot;<span class="subst">$(uci get network.globals.ula_prefix)</span>&quot;</span></span><br><span class="line">uci <span class="built_in">set</span> network.globals.ula_prefix=<span class="string">&quot;d<span class="variable">$&#123;NET_ULA:1&#125;</span>&quot;</span></span><br><span class="line"><span class="comment"># é»˜è®¤ network.lan.ip6assign é…ç½®å¯èƒ½æœ‰è¯¯ï¼Œéœ€è¦æ ¹æ® ula_prefix é‡æ–°é…ç½®</span></span><br><span class="line">IP6_ASSIGN=<span class="string">&quot;<span class="subst">$(echo $&#123;NET_ULA&#125; | grep -E &#x27;(\d+)</span>$&#x27; -o)&quot;</span></span><br><span class="line">uci <span class="built_in">set</span> network.lan.ip6assign=<span class="string">&quot;<span class="variable">$&#123;IP6_ASSIGN&#125;</span>&quot;</span></span><br><span class="line">uci commit network</span><br><span class="line">/etc/init.d/network restart</span><br></pre></td></tr></table></figure></li>
<li><p>é…ç½®é»˜è®¤ IPv6 è·¯ç”±</p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Announcing default IPv6 route</span></span><br><span class="line">uci <span class="built_in">set</span> dhcp.lan.ra_default=<span class="string">&quot;1&quot;</span></span><br><span class="line">uci commit dhcp</span><br><span class="line">/etc/init.d/odhcpd restart</span><br></pre></td></tr></table></figure></li>
<li><p>é…ç½®é˜²ç«å¢™</p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Configure firewall</span></span><br><span class="line">uci <span class="built_in">set</span> $(uci show firewall | sed -n -e <span class="string">&quot;/\.name=&#x27;wan&#x27;$/s//.masq6=&#x27;1&#x27;/p&quot;</span> | sed -n -e <span class="string">&quot;1p&quot;</span>)</span><br><span class="line">uci <span class="built_in">set</span> $(uci show firewall | sed -n -e <span class="string">&quot;/\.name=&#x27;Allow-ICMPv6-Forward&#x27;$/s//.enabled=&#x27;0&#x27;/p&quot;</span> | sed -n -e <span class="string">&quot;1p&quot;</span>)</span><br><span class="line">uci commit firewall</span><br></pre></td></tr></table></figure>

 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Configure firewall</span></span><br><span class="line">cat &lt;&lt; <span class="string">&quot;EOF&quot;</span> &gt; /etc/firewall.nat6</span><br><span class="line"><span class="comment"># NAT6 + masquerading firewall script</span></span><br><span class="line"><span class="comment"># https://github.com/akatrevorjay/openwrt-masq6</span></span><br><span class="line"><span class="comment"># trevorj &lt;github@trevor.joynson.io&gt;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># You can configure in /etc/config/firewall per zone:</span></span><br><span class="line"><span class="comment"># * IPv4 masquerading</span></span><br><span class="line"><span class="comment">#     option masq 1</span></span><br><span class="line"><span class="comment"># * IPv6 masquerading</span></span><br><span class="line"><span class="comment">#     option masq6 1</span></span><br><span class="line"><span class="comment"># * IPv6 privacy extensions</span></span><br><span class="line"><span class="comment">#     option masq6_privacy 1</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> -e -o pipefail</span><br><span class="line"></span><br><span class="line">. /lib/functions.sh</span><br><span class="line">. /lib/<span class="built_in">functions</span>/network.sh</span><br><span class="line">. /usr/share/libubox/jshn.sh</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">log</span></span>() &#123;</span><br><span class="line">    logger -t nat6 -s <span class="string">&quot;<span class="variable">$&#123;@&#125;</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">get_ula_prefix</span></span>() &#123;</span><br><span class="line">    uci get network.globals.ula_prefix</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">validate_ula_prefix</span></span>() &#123;</span><br><span class="line">    <span class="built_in">local</span> ula_prefix=<span class="string">&quot;<span class="variable">$&#123;1&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">if</span> [ $(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;ula_prefix&#125;</span>&quot;</span> | grep -c -E -e <span class="string">&quot;^([0-9a-fA-F]&#123;4&#125;):([0-9a-fA-F]&#123;0,4&#125;):&quot;</span>) -ne 1 ] ; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">log</span> <span class="string">&quot;Fatal error: IPv6 ULA ula_prefix=\&quot;<span class="variable">$&#123;ula_prefix&#125;</span>\&quot; seems invalid. Please verify that a ula_prefix is set and valid.&quot;</span></span><br><span class="line">        <span class="built_in">return</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">ip6t</span></span>() &#123;</span><br><span class="line">    ip6tables <span class="string">&quot;<span class="variable">$&#123;@&#125;</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">ip6t_add</span></span>() &#123;</span><br><span class="line">    <span class="keyword">if</span> ! ip6t -C <span class="string">&quot;<span class="variable">$&#123;@&#125;</span>&quot;</span> &amp;&gt; /dev/null; <span class="keyword">then</span></span><br><span class="line">        ip6t -I <span class="string">&quot;<span class="variable">$&#123;@&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">nat6_init</span></span>() &#123;</span><br><span class="line">    iptables-save -t nat \</span><br><span class="line">    | sed -e <span class="string">&quot;</span></span><br><span class="line"><span class="string">        /\sMASQUERADE$/d</span></span><br><span class="line"><span class="string">        /\s[DS]NAT\s/d</span></span><br><span class="line"><span class="string">        /\s--match-set\s\S*/s//\06/</span></span><br><span class="line"><span class="string">        /,BROADCAST\s/s// /&quot;</span> \</span><br><span class="line">    | ip6tables-restore -T nat</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">masq6_network</span></span>() &#123;</span><br><span class="line">    <span class="comment"># $&#123;config&#125; contains the ID of the current section</span></span><br><span class="line">    <span class="built_in">local</span> network_name=<span class="string">&quot;<span class="variable">$&#123;1&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">local</span> device</span><br><span class="line">    network_get_device device <span class="string">&quot;<span class="variable">$&#123;network_name&#125;</span>&quot;</span> || <span class="built_in">return</span> 0</span><br><span class="line"></span><br><span class="line">    <span class="built_in">local</span> done_net_dev</span><br><span class="line">    <span class="keyword">for</span> done_net_dev <span class="keyword">in</span> <span class="variable">$&#123;DONE_NETWORK_DEVICES&#125;</span>; <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$&#123;done_net_dev&#125;</span>&quot;</span> = <span class="string">&quot;<span class="variable">$&#123;device&#125;</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">log</span> <span class="string">&quot;Already configured device=\&quot;<span class="variable">$&#123;device&#125;</span>\&quot;, so leaving as is.&quot;</span></span><br><span class="line">            <span class="built_in">return</span> 0</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">log</span> <span class="string">&quot;Found device=\&quot;<span class="variable">$&#123;device&#125;</span>\&quot; for network_name=\&quot;<span class="variable">$&#123;network_name&#125;</span>\&quot;.&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$&#123;zone_masq6_privacy&#125;</span>&quot;</span> -eq 1 ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">log</span> <span class="string">&quot;Enabling IPv6 temporary addresses for device=\&quot;<span class="variable">$&#123;device&#125;</span>\&quot;.&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">log</span> <span class="string">&quot;Accepting router advertisements on <span class="variable">$&#123;device&#125;</span> even if forwarding is enabled (required for temporary addresses)&quot;</span></span><br><span class="line">        <span class="built_in">echo</span> 2 &gt; <span class="string">&quot;/proc/sys/net/ipv6/conf/<span class="variable">$&#123;device&#125;</span>/accept_ra&quot;</span> \</span><br><span class="line">        || <span class="built_in">log</span> <span class="string">&quot;Error: Failed to change router advertisements accept policy on <span class="variable">$&#123;device&#125;</span> (required for temporary addresses)&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">log</span> <span class="string">&quot;Using temporary addresses for outgoing connections on interface <span class="variable">$&#123;device&#125;</span>&quot;</span></span><br><span class="line">        <span class="built_in">echo</span> 2 &gt; <span class="string">&quot;/proc/sys/net/ipv6/conf/<span class="variable">$&#123;device&#125;</span>/use_tempaddr&quot;</span> \</span><br><span class="line">        || <span class="built_in">log</span> <span class="string">&quot;Error: Failed to enable temporary addresses for outgoing connections on interface <span class="variable">$&#123;device&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    append DONE_NETWORK_DEVICES <span class="string">&quot;<span class="variable">$&#123;device&#125;</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">handle_zone</span></span>() &#123;</span><br><span class="line">    <span class="comment"># $&#123;config&#125; contains the ID of the current section</span></span><br><span class="line">    <span class="built_in">local</span> config=<span class="string">&quot;<span class="variable">$&#123;1&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">local</span> zone_name</span><br><span class="line">    config_get zone_name <span class="string">&quot;<span class="variable">$&#123;config&#125;</span>&quot;</span> name</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Enable masquerading via NAT6</span></span><br><span class="line">    <span class="built_in">local</span> zone_masq6</span><br><span class="line">    config_get_bool zone_masq6 <span class="string">&quot;<span class="variable">$&#123;config&#125;</span>&quot;</span> masq6 0</span><br><span class="line"></span><br><span class="line">    <span class="built_in">log</span> <span class="string">&quot;Firewall config=\&quot;<span class="variable">$&#123;config&#125;</span>\&quot; zone=\&quot;<span class="variable">$&#123;zone_name&#125;</span>\&quot; zone_masq6=\&quot;<span class="variable">$&#123;zone_masq6&#125;</span>\&quot;.&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$&#123;zone_masq6&#125;</span>&quot;</span> -eq 0 ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">return</span> 0</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># IPv6 privacy extensions: Use temporary addrs for outgoing connections?</span></span><br><span class="line">    <span class="built_in">local</span> zone_masq6_privacy</span><br><span class="line">    config_get_bool zone_masq6_privacy <span class="string">&quot;<span class="variable">$&#123;config&#125;</span>&quot;</span> masq6_privacy 1</span><br><span class="line"></span><br><span class="line">    <span class="built_in">log</span> <span class="string">&quot;Found firewall zone_name=\&quot;<span class="variable">$&#123;zone_name&#125;</span>\&quot; with zone_masq6=\&quot;<span class="variable">$&#123;zone_masq6&#125;</span>\&quot; zone_masq6_privacy=\&quot;<span class="variable">$&#123;zone_masq6_privacy&#125;</span>\&quot;.&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">log</span> <span class="string">&quot;Setting up masquerading nat6 for zone_name=\&quot;<span class="variable">$&#123;zone_name&#125;</span>\&quot; with zone_masq6_privacy=\&quot;<span class="variable">$&#123;zone_masq6_privacy&#125;</span>\&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">local</span> ula_prefix=<span class="string">&quot;<span class="subst">$(get_ula_prefix)</span>&quot;</span></span><br><span class="line">    validate_ula_prefix <span class="string">&quot;<span class="variable">$&#123;ula_prefix&#125;</span>&quot;</span> || <span class="built_in">return</span> 1</span><br><span class="line"></span><br><span class="line">    <span class="built_in">local</span> postrouting_chain=<span class="string">&quot;zone_<span class="variable">$&#123;zone_name&#125;</span>_postrouting&quot;</span></span><br><span class="line">    <span class="built_in">log</span> <span class="string">&quot;Ensuring ip6tables chain=\&quot;<span class="variable">$&#123;postrouting_chain&#125;</span>\&quot; contains our MASQUERADE.&quot;</span></span><br><span class="line">    ip6t_add <span class="string">&quot;<span class="variable">$&#123;postrouting_chain&#125;</span>&quot;</span> -t nat \</span><br><span class="line">        -m comment --comment <span class="string">&quot;!fw3&quot;</span> -j MASQUERADE</span><br><span class="line"></span><br><span class="line">    <span class="built_in">local</span> input_chain=<span class="string">&quot;zone_<span class="variable">$&#123;zone_name&#125;</span>_input&quot;</span></span><br><span class="line">    <span class="built_in">log</span> <span class="string">&quot;Ensuring ip6tables chain=\&quot;<span class="variable">$&#123;input_chain&#125;</span>\&quot; contains our permissive DNAT rule.&quot;</span></span><br><span class="line">    ip6t_add <span class="string">&quot;<span class="variable">$&#123;input_chain&#125;</span>&quot;</span> -t filter -m conntrack --ctstate DNAT \</span><br><span class="line">        -m comment --comment <span class="string">&quot;!fw3: Accept port forwards&quot;</span> -j ACCEPT</span><br><span class="line"></span><br><span class="line">    <span class="built_in">local</span> forward_chain=<span class="string">&quot;zone_<span class="variable">$&#123;zone_name&#125;</span>_forward&quot;</span></span><br><span class="line">    <span class="built_in">log</span> <span class="string">&quot;Ensuring ip6tables chain=\&quot;<span class="variable">$&#123;forward_chain&#125;</span>\&quot; contains our permissive DNAT rule.&quot;</span></span><br><span class="line">    ip6t_add <span class="string">&quot;<span class="variable">$&#123;forward_chain&#125;</span>&quot;</span> -t filter -m conntrack --ctstate DNAT \</span><br><span class="line">        -m comment --comment <span class="string">&quot;!fw3: Accept port forwards&quot;</span> -j ACCEPT</span><br><span class="line"></span><br><span class="line">    <span class="built_in">local</span> DONE_NETWORK_DEVICES=<span class="string">&quot;&quot;</span></span><br><span class="line">    config_list_foreach <span class="string">&quot;<span class="variable">$&#123;config&#125;</span>&quot;</span> network masq6_network</span><br><span class="line"></span><br><span class="line">    <span class="built_in">log</span> <span class="string">&quot;Done setting up nat6 for zone=\&quot;<span class="variable">$&#123;zone_name&#125;</span>\&quot; on devices: <span class="variable">$&#123;DONE_NETWORK_DEVICES&#125;</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">main</span></span>() &#123;</span><br><span class="line">    nat6_init</span><br><span class="line">    config_load firewall</span><br><span class="line">    config_foreach handle_zone zone</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">main <span class="string">&quot;<span class="variable">$&#123;@&#125;</span>&quot;</span></span><br><span class="line">EOF</span><br><span class="line">cat &lt;&lt; <span class="string">&quot;EOF&quot;</span> &gt;&gt; /etc/sysupgrade.conf</span><br><span class="line">/etc/firewall.nat6</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p> ç»è¿‡æ­¤æ­¥éª¤åä¼šç”Ÿæˆä¸€ä¸ª <code>/etc/firewall.nat6</code> è„šæœ¬ï¼Œå¹¶ä¸”åŠ å…¥äº† <code>/etc/sysupgrade.conf</code>ï¼Œä¿è¯ç³»ç»Ÿå‡çº§åä¹Ÿä¸ä¼šä¸¢å¤±è¯¥è„šæœ¬</p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Configure firewall</span></span><br><span class="line">uci -q delete firewall.nat6</span><br><span class="line">uci <span class="built_in">set</span> firewall.nat6=<span class="string">&quot;include&quot;</span></span><br><span class="line">uci <span class="built_in">set</span> firewall.nat6.path=<span class="string">&quot;/etc/firewall.nat6&quot;</span></span><br><span class="line">uci <span class="built_in">set</span> firewall.nat6.reload=<span class="string">&quot;1&quot;</span></span><br><span class="line">uci commit firewall</span><br><span class="line">/etc/init.d/firewall restart</span><br></pre></td></tr></table></figure>

 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Configure firewall</span></span><br><span class="line">uci <span class="built_in">set</span> firewall.@zone[1].masq6=<span class="string">&quot;1&quot;</span></span><br><span class="line">uci <span class="built_in">set</span> firewall.@zone[1].masq6_privacy=<span class="string">&quot;1&quot;</span></span><br><span class="line">uci commit firewall</span><br><span class="line">/etc/init.d/firewall restart</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="USB"><a href="#USB" class="headerlink" title="USB"></a>USB</h2><p>å¾ˆå¤šè·¯ç”±å™¨æœ‰ USB ç«¯å£ï¼Œé€šè¿‡æ’å…¥ U ç›˜æˆ–è€…æ¥å…¥ç£ç›˜ã€SSD ç­‰è®¾å¤‡å¯ä»¥æ‹“å±•å­˜å‚¨ç©ºé—´ï¼Œè¿™æ ·å°±å¯ä»¥å®‰è£…æ›´å¤šçš„æ’ä»¶ï¼Œæˆ–è€…æ­å»ºä¸€ä¸ªç®€å•çš„ FTPã€SMB æœåŠ¡å™¨ç”¨äºå…±äº«æ•°æ®</p>
<h3 id="å®‰è£…-USB-é©±åŠ¨"><a href="#å®‰è£…-USB-é©±åŠ¨" class="headerlink" title="å®‰è£… USB é©±åŠ¨"></a>å®‰è£… USB é©±åŠ¨</h3><p>ä¾æ¬¡æ‰§è¡Œä»¥ä¸‹å‘½ä»¤è¿›è¡Œé©±åŠ¨åŸºæœ¬åŒ…çš„å®‰è£…</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">opkg update</span><br><span class="line">opkg install kmod-usb-core</span><br><span class="line">insmod usbcore</span><br><span class="line">opkg install kmod-usb-storage</span><br></pre></td></tr></table></figure>

<p>å¦‚æœè®¾å¤‡æ˜¯ USB 2.0</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">opkg install kmod-usb2</span><br><span class="line">insmod ehci-hcd</span><br></pre></td></tr></table></figure>

<p>å¦‚æœè®¾å¤‡æ˜¯ USB 3.0</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">opkg install kmod-usb3</span><br><span class="line">insmod xhci-hcd</span><br></pre></td></tr></table></figure>

<p>é€šå¸¸ç§»åŠ¨ç¡¬ç›˜æˆ–è€…ç§»åŠ¨ SSD è¿˜éœ€è¦å®‰è£… UAS/UASP æ”¯æŒ</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">opkg install kmod-usb-storage-uas</span><br></pre></td></tr></table></figure>

<p>ç„¶åçƒ­æ’æ‹”å­˜å‚¨è®¾å¤‡ï¼Œé€šå¸¸å°±èƒ½åœ¨ <code>/dev</code> ç›®å½•ä¸‹çœ‹è§ <code>sda</code> è®¾å¤‡äº†</p>
<h3 id="è‡ªåŠ¨æŒ‚è½½"><a href="#è‡ªåŠ¨æŒ‚è½½" class="headerlink" title="è‡ªåŠ¨æŒ‚è½½"></a>è‡ªåŠ¨æŒ‚è½½</h3><ul>
<li><p>å®‰è£…å—è®¾å¤‡å·¥å…·åŒ…</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">opkg install block-mount</span><br></pre></td></tr></table></figure></li>
<li><p>åˆ†åŒº</p>
<p>ä¸ªäººå·²ç»æå‰å°†å­˜å‚¨è®¾å¤‡åˆ’åˆ†äº†ä¸¤ä¸ªåˆ†åŒºï¼Œä¸€ä¸ªåˆ†åŒºè¾ƒå°(sda5)ç”¨äºåç»­çš„ <a href="#extroot">Extroot</a>ï¼Œå‰©ä½™çš„ç©ºé—´(sda6)å…¨ç”¨äºå­˜å‚¨ä¸ªäººæ•°æ®</p>
</li>
<li><p>åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿ</p>
<p>æ¨èç§»åŠ¨ç£ç›˜ç”¨ ext4 æ–‡ä»¶ç³»ç»Ÿï¼Œè€Œç§»åŠ¨ SSD æ¨èä½¿ç”¨ f2fs æ–‡ä»¶ç³»ç»Ÿ</p>
<p>åˆ†åŒºå’Œåˆ›å»ºæ–‡ä»¶ç³»ç»Ÿå¯ä»¥å‚è€ƒ <a href="https://openwrt.org/docs/guide-user/storage/usb-drives#create_a_partition_on_the_usb_disk">å®˜ç½‘çš„æŒ‡å¯¼</a></p>
</li>
<li><p>é…ç½®æŒ‚è½½</p>
<p>é…ç½®æŒ‚è½½å¯ä»¥é€šè¿‡ç›´æ¥åœ¨ç½‘é¡µç«¯çš„ <a href="http://192.168.1.1/cgi-bin/luci/admin/system/mounts">ç³»ç»Ÿ-æŒ‚è½½ç‚¹</a> è¿›è¡Œæ‰‹åŠ¨é…ç½®ï¼Œæ¯”è¾ƒç›´è§‚ï¼Œå¦‚å›¾æ‰€ç¤ºï¼š</p>
<p><img data-src="/posts/51140c4a/Mount-sda6.png" alt="æŒ‚è½½è®¾å¤‡"></p>
<ul>
<li>å·²å¯ç”¨ï¼šå‹¾é€‰</li>
<li>UUIDï¼šæ¨èä½¿ç”¨ UUID æ¥è¿›è¡ŒæŒ‚è½½</li>
<li>æŒ‚è½½ç‚¹ï¼šä¹Ÿå°±æ˜¯æŒ‚è½½çš„ä½ç½®ï¼Œé€šå¸¸åœ¨ <code>/mnt</code> ç›®å½•ä¸‹æ–°å»ºä¸€ä¸ªæ–‡ä»¶å¤¹</li>
</ul>
</li>
</ul>
<h3 id="Extroot"><a href="#Extroot" class="headerlink" title="Extroot"></a>Extroot</h3><p>æœ‰æ—¶å€™å®‰è£…å¤ªå¤šåŒ…ä¼šå¯¼è‡´æœ¬åœ°ç©ºé—´ä¸è¶³ï¼Œæ­¤æ—¶å¯ä»¥é€šè¿‡å°†åŒ…å®‰è£…åœ¨ USB è®¾å¤‡ä¸Šï¼Œä¹Ÿå¯ä»¥é€šè¿‡ Extroot çš„æ–¹å¼å°† USB è®¾å¤‡çš„ç©ºé—´ç›´æ¥é…ç½®æˆ <code>overlay</code> åˆ†åŒºï¼Œåè€…æ›´ä¸ºæ¨è</p>
<ol>
<li><p>ä¿®æ”¹ <code>fstab</code>ï¼Œå°†åŸæœ¬æŒ‚è½½çš„ <code>overlay</code> è®¾å¤‡æŒ‚è½½åˆ°æ–°çš„ç›®å½• <code>/rwm</code></p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">DEVICE=<span class="string">&quot;<span class="subst">$(sed -n -e <span class="string">&quot;/\s\/overlay\s.*$/s///p&quot;</span> /etc/mtab)</span>&quot;</span></span><br><span class="line">uci -q delete fstab.rwm</span><br><span class="line">uci <span class="built_in">set</span> fstab.rwm=<span class="string">&quot;mount&quot;</span></span><br><span class="line">uci <span class="built_in">set</span> fstab.rwm.device=<span class="string">&quot;<span class="variable">$&#123;DEVICE&#125;</span>&quot;</span></span><br><span class="line">uci <span class="built_in">set</span> fstab.rwm.target=<span class="string">&quot;/rwm&quot;</span></span><br><span class="line">uci commit fstab</span><br></pre></td></tr></table></figure></li>
<li><p>ä¿®æ”¹ <code>fstab</code>ï¼Œé…ç½® USB è®¾å¤‡æŒ‚è½½æˆ <code>overlay</code> åˆ†åŒº</p>
<p> å…¶ä¸­éƒ¨åˆ†éƒ¨åˆ†æ“ä½œåœ¨ <a href="#%E8%87%AA%E5%8A%A8%E6%8C%82%E8%BD%BD">ä¸ŠèŠ‚</a> å·²ç»æ‰§è¡Œè¿‡ï¼Œå¯ä»¥ç•¥å»</p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹åˆ†åŒºä¿¡æ¯</span></span><br><span class="line"><span class="comment"># block info</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¡®å®šåˆ†åŒºå¹¶åˆ¶ä½œæ–‡ä»¶ç³»ç»Ÿ</span></span><br><span class="line">DEVICE=<span class="string">&quot;/dev/sda5&quot;</span></span><br><span class="line"><span class="comment"># mkfs.ext4 $&#123;DEVICE&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">eval</span> $(block info <span class="variable">$&#123;DEVICE&#125;</span> | grep -o -e <span class="string">&quot;UUID=\S*&quot;</span>)</span><br><span class="line">uci -q delete fstab.overlay</span><br><span class="line">uci <span class="built_in">set</span> fstab.overlay=<span class="string">&quot;mount&quot;</span></span><br><span class="line">uci <span class="built_in">set</span> fstab.overlay.uuid=<span class="string">&quot;<span class="variable">$&#123;UUID&#125;</span>&quot;</span></span><br><span class="line">uci <span class="built_in">set</span> fstab.overlay.target=<span class="string">&quot;/overlay&quot;</span></span><br><span class="line">uci commit fstab</span><br></pre></td></tr></table></figure></li>
<li><p>å°†åŸæœ¬ <code>overlay</code> åˆ†åŒºæ•°æ®å¤åˆ¶åˆ° USB è®¾å¤‡ä¸Šï¼Œé‡å¯è®¾å¤‡</p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mkdir -p /tmp/cproot</span><br><span class="line">mount --<span class="built_in">bind</span> /overlay /tmp/cproot</span><br><span class="line">mount <span class="variable">$&#123;DEVICE&#125;</span> /mnt</span><br><span class="line">tar -C /tmp/cproot -cvf - . | tar -C /mnt -xf -</span><br><span class="line">umount /tmp/cproot /mnt</span><br><span class="line">reboot</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="FTP"><a href="#FTP" class="headerlink" title="FTP"></a>FTP</h2><p>é…ç½®å¥½ USB åï¼Œå°±å¯ä»¥é…ç½® FTP æ¥å…±äº« USB è®¾å¤‡</p>
<ol>
<li><p>é¦–å…ˆå®‰è£… vsftpd åŒ…</p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">opkg install vsftpd</span><br></pre></td></tr></table></figure></li>
<li><p>ä¿®æ”¹é…ç½®æ–‡ä»¶ <code>/etc/vsftpd.conf</code>ï¼Œè¿™é‡Œç»™å‡ºä¸ªäººçš„é…ç½®ï¼Œå¯ä»¥å‚è€ƒ</p>
 <figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="attr">background</span>=<span class="literal">YES</span></span><br><span class="line"><span class="attr">listen</span>=<span class="literal">YES</span></span><br><span class="line"><span class="attr">anonymous_enable</span>=<span class="literal">NO</span></span><br><span class="line"><span class="attr">local_enable</span>=<span class="literal">YES</span></span><br><span class="line"><span class="attr">write_enable</span>=<span class="literal">YES</span></span><br><span class="line"><span class="attr">local_umask</span>=<span class="number">022</span></span><br><span class="line"><span class="attr">check_shell</span>=<span class="literal">NO</span></span><br><span class="line"><span class="comment">#dirmessage_enable=YES</span></span><br><span class="line"><span class="comment">#ftpd_banner=Welcome to MINI FTP service.</span></span><br><span class="line"><span class="attr">session_support</span>=<span class="literal">NO</span></span><br><span class="line"><span class="comment">#syslog_enable=YES</span></span><br><span class="line"><span class="comment">#userlist_enable=YES</span></span><br><span class="line"><span class="comment">#userlist_deny=NO</span></span><br><span class="line"><span class="comment">#userlist_file=/etc/vsftpd/vsftpd.users</span></span><br><span class="line"><span class="comment">#xferlog_enable=YES</span></span><br><span class="line"><span class="comment">#xferlog_file=/var/log/vsftpd.log</span></span><br><span class="line"><span class="comment">#xferlog_std_format=YES</span></span><br><span class="line"><span class="comment">###</span></span><br><span class="line"><span class="comment">### TLS/SSL options</span></span><br><span class="line"><span class="comment">### example key generation: openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout /etc/vsftpd/vsftpd_privkey.pem -out /etc</span></span><br><span class="line"><span class="comment">#ssl_enable=YES</span></span><br><span class="line"><span class="comment">#allow_anon_ssl=NO</span></span><br><span class="line"><span class="comment">#force_local_data_ssl=NO</span></span><br><span class="line"><span class="comment">#force_local_logins_ssl=NO</span></span><br><span class="line"><span class="comment">#ssl_tlsv1=YES</span></span><br><span class="line"><span class="comment">#ssl_sslv2=NO</span></span><br><span class="line"><span class="comment">#ssl_sslv3=NO</span></span><br><span class="line"><span class="comment">#rsa_cert_file=/etc/vsftpd/vsftpd_cert.pem</span></span><br><span class="line"><span class="comment">#rsa_private_key_file=/etc/vsftpd/vsftpd_privkey.pem</span></span><br><span class="line"><span class="comment"># å…±äº«çš„ç›®å½•ä½ç½®</span></span><br><span class="line"><span class="attr">local_root</span>=/mnt/ext4</span><br><span class="line"><span class="attr">pasv_enable</span>=<span class="literal">YES</span></span><br><span class="line"><span class="attr">pasv_min_port</span>=<span class="number">10090</span></span><br><span class="line"><span class="attr">pasv_max_port</span>=<span class="number">10100</span></span><br></pre></td></tr></table></figure></li>
<li><p>ç„¶åå‚è€ƒä¹‹å‰çš„ <a href="#%E5%BC%80%E6%94%BE%E7%AB%AF%E5%8F%A3">å¼€æ”¾ç«¯å£</a>ï¼Œæ‰“å¼€ 20ã€21ã€10090-10100 ç«¯å£å°±å¯ä»¥åœ¨å¤–ç½‘è®¿é—® FTP æœåŠ¡å™¨äº†</p>
<p> <img data-src="/posts/51140c4a/Allow-FTP-WAN.png" alt="å¼€æ”¾ FTP ç«¯å£"></p>
</li>
<li><p>ä¹‹åé‡å¯ <code>vsftpd</code> æœåŠ¡å³å¯ä½¿ç”¨</p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/etc/init.d/vsftpd restart</span><br></pre></td></tr></table></figure></li>
</ol>
<p>P.S. è¿æ¥ ftp æœåŠ¡å™¨çš„è´¦å·å¯†ç å°±æ˜¯è·¯ç”±å™¨çš„ root è´¦å·å¯†ç </p>
<h2 id="SMB"><a href="#SMB" class="headerlink" title="SMB"></a>SMB</h2><p>ä½¿ç”¨ Samba æ¥å…±äº«çš„è®¾å¤‡å¯ä»¥åœ¨ Windows çš„æ–‡ä»¶èµ„æºç®¡ç†å™¨ä¸­æŒ‚è½½ï¼Œä½¿ç”¨èµ·æ¥å’Œæœ¬åœ°ç£ç›˜ä¸€æ ·ï¼ˆåœ¨å±€åŸŸç½‘å†…ï¼‰</p>
<ol>
<li><p>å®‰è£… samba4-server ä»¥åŠ LuCI ç®¡ç†ç•Œé¢</p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">opkg install samba4-server</span><br><span class="line">opkg install luci-app-samba4 luci-i18n-samba4-zh-cn</span><br></pre></td></tr></table></figure></li>
<li><p>åœ¨ç½‘é¡µç«¯çš„ <a href="http://10.17.33.240/cgi-bin/luci/admin/services/samba4">æœåŠ¡-ç½‘ç»œå…±äº«</a> ä¸­è¿›è¡Œé…ç½®ï¼Œä¸ªäººé…ç½®å¦‚ä¸‹ï¼Œå¯ä»¥å‚è€ƒ</p>
<p> <img data-src="/posts/51140c4a/Samba.png" alt="Samba é…ç½®"></p>
</li>
<li><p>ä¹‹åé‡å¯ <code>samba4</code> æœåŠ¡å³å¯ä½¿ç”¨</p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/etc/init.d/samba4 restart</span><br></pre></td></tr></table></figure></li>
</ol>
<p>P.S. è¿æ¥ Samba æœåŠ¡å™¨çš„è´¦å·å¯†ç ä¹Ÿæ˜¯è·¯ç”±å™¨çš„ root è´¦å·å¯†ç </p>
<h2 id="BT-ä¸‹è½½"><a href="#BT-ä¸‹è½½" class="headerlink" title="BT ä¸‹è½½"></a>BT ä¸‹è½½</h2><p>transmission æ˜¯ä¸€ä¸ªè½»é‡çº§è·¨å¹³å°çš„ BT ä¸‹è½½å®¢æˆ·ç«¯</p>
<ol>
<li><p>å®‰è£… transmission</p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">opkg install transmission-daemon</span><br><span class="line">opkg install transmission-cli</span><br><span class="line">opkg install transmission-web</span><br><span class="line">opkg install transmission-remote</span><br><span class="line">opkg install luci-app-transmission luci-i18n-transmission-zh-cn</span><br></pre></td></tr></table></figure></li>
<li><p>ç›´æ¥ä¿®æ”¹ <code>/etc/config/transmission</code>ï¼Œæˆ–è€…åœ¨ç½‘é¡µç«¯çš„ <a href="http://10.17.33.240/cgi-bin/luci/admin/services/transmission">æœåŠ¡-Transmission</a> è¿›è¡Œé…ç½®ï¼Œä¸‹é¢ç»™å‡ºä¸ªäººé…ç½®ï¼Œå¯ä»¥å‚è€ƒ</p>
<p> <img data-src="/posts/51140c4a/Transmission.png" alt="Transmission é…ç½®"></p>
 <figure class="highlight ini"><table><tr><td class="code"><pre><span class="line">config transmission</span><br><span class="line">    option config_overwrite &#x27;1&#x27;</span><br><span class="line">    option mem_percentage &#x27;50&#x27;</span><br><span class="line">    option nice &#x27;10&#x27;</span><br><span class="line">    option alt_speed_enabled &#x27;false&#x27;</span><br><span class="line">    option alt_speed_time_enabled &#x27;false&#x27;</span><br><span class="line">    option bind_address_ipv4 &#x27;0.0.0.0&#x27;</span><br><span class="line">    option bind_address_ipv6 &#x27;::&#x27;</span><br><span class="line">    option blocklist_enabled &#x27;false&#x27;</span><br><span class="line">    option cache_size_mb &#x27;2&#x27;</span><br><span class="line">    option dht_enabled &#x27;true&#x27;</span><br><span class="line">    option download_queue_enabled &#x27;true&#x27;</span><br><span class="line">    option download_queue_size &#x27;4&#x27;</span><br><span class="line">    option encryption &#x27;1&#x27;</span><br><span class="line">    option idle_seeding_limit_enabled &#x27;false&#x27;</span><br><span class="line">    option lazy_bitfield_enabled &#x27;true&#x27;</span><br><span class="line">    option lpd_enabled &#x27;false&#x27;</span><br><span class="line">    option message_level &#x27;1&#x27;</span><br><span class="line">    option peer_limit_global &#x27;240&#x27;</span><br><span class="line">    option peer_limit_per_torrent &#x27;60&#x27;</span><br><span class="line">    option peer_port &#x27;51413&#x27;</span><br><span class="line">    option peer_port_random_on_start &#x27;false&#x27;</span><br><span class="line">    option peer_socket_tos &#x27;default&#x27;</span><br><span class="line">    option pex_enabled &#x27;true&#x27;</span><br><span class="line">    option port_forwarding_enabled &#x27;true&#x27;</span><br><span class="line">    option preallocation &#x27;1&#x27;</span><br><span class="line">    option queue_stalled_enabled &#x27;true&#x27;</span><br><span class="line">    option queue_stalled_minutes &#x27;30&#x27;</span><br><span class="line">    option ratio_limit &#x27;2.0000&#x27;</span><br><span class="line">    option rename_partial_files &#x27;true&#x27;</span><br><span class="line">    option rpc_bind_address &#x27;0.0.0.0&#x27;</span><br><span class="line">    option rpc_enabled &#x27;true&#x27;</span><br><span class="line">    option rpc_host_whitelist_enabled &#x27;false&#x27;</span><br><span class="line">    option rpc_port &#x27;9091&#x27;</span><br><span class="line">    option rpc_url &#x27;/transmission/&#x27;</span><br><span class="line">    option rpc_whitelist_enabled &#x27;false&#x27;</span><br><span class="line">    option scrape_paused_torrents_enabled &#x27;true&#x27;</span><br><span class="line">    option script_torrent_done_enabled &#x27;false&#x27;</span><br><span class="line">    option seed_queue_enabled &#x27;false&#x27;</span><br><span class="line">    option speed_limit_down_enabled &#x27;false&#x27;</span><br><span class="line">    option speed_limit_up_enabled &#x27;false&#x27;</span><br><span class="line">    option start_added_torrents &#x27;true&#x27;</span><br><span class="line">    option umask &#x27;18&#x27;</span><br><span class="line">    option utp_enabled &#x27;true&#x27;</span><br><span class="line">    option scrape_paused_torrents &#x27;true&#x27;</span><br><span class="line">    option watch_dir_enabled &#x27;false&#x27;</span><br><span class="line">    option enabled &#x27;1&#x27;</span><br><span class="line">    option user &#x27;root&#x27;</span><br><span class="line">    option group &#x27;root&#x27;</span><br><span class="line">    option upload_slots_per_torrent &#x27;10&#x27;</span><br><span class="line">    option download_dir &#x27;/mnt/ext4/transmission&#x27;</span><br><span class="line">    option incomplete_dir_enabled &#x27;true&#x27;</span><br><span class="line">    option incomplete_dir &#x27;/mnt/ext4/transmission/incomplete&#x27;</span><br><span class="line">    option trash_original_torrent_files &#x27;true&#x27;</span><br><span class="line">    option rpc_authentication_required &#x27;true&#x27;</span><br><span class="line">    option rpc_username &#x27;rpc_username&#x27;</span><br><span class="line">    option rpc_password &#x27;rpc_password&#x27;</span><br><span class="line">    option ratio_limit_enabled &#x27;true&#x27;</span><br><span class="line">    option config_dir &#x27;/etc/transmission&#x27;</span><br></pre></td></tr></table></figure></li>
<li><p>ä¹‹åé‡å¯ <code>transmission</code> æœåŠ¡å³å¯ä½¿ç”¨</p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/etc/init.d/transmission restart</span><br></pre></td></tr></table></figure></li>
</ol>
<p>è¿æ¥çš„è´¦å·å¯†ç ä¸ºè‡ªè¡Œé…ç½®çš„ <code>RPC</code> è¿æ¥çš„è´¦å·å¯†ç </p>
<p>é»˜è®¤çš„ <a href="http://192.168.1.1:9091/transmission/web/">Web ç•Œé¢</a> æ¯”è¾ƒç®€é™‹ï¼Œå¹¶ä¸”ä¸èƒ½é…ç½® trackerï¼Œä¸ªäººæ¨èä½¿ç”¨ <a href="https://github.com/transmission-remote-gui/transgui">transgui</a> æ¥ <code>RPC</code> è¿æ¥ä½¿ç”¨</p>
<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul>
<li><a href="https://openwrt.org/docs/guide-user/luci/luci.essentials">ã€OpenWrtã€‘LuCI</a></li>
<li><a href="https://blog.csdn.net/weixin_43274097/article/details/107197717">ã€CSDNã€‘luci.cbi æŠ¥é”™</a></li>
<li><a href="https://github.com/kuoruan/luci-app-v2ray/issues/42">ã€GitHubã€‘åº”ç”¨è®¾ç½®ç•Œé¢é”™è¯¯</a></li>
<li><a href="https://github.com/hyrathb/mentohust">ã€GitHubã€‘MentoHUST åŠ å…¥ v4 æ”¯æŒ</a></li>
<li><a href="https://github.com/KyleRicardo/MentoHUST-OpenWrt-ipk">ã€GitHubã€‘MentoHUST-OpenWrt-ipk</a></li>
<li><a href="https://github.com/BoringCat/luci-app-mentohust">ã€GitHubã€‘OpenWrt/LEDE LuCI for MentoHUST</a></li>
<li><a href="https://github.com/updateing/minieap">ã€GitHubã€‘MiniEAP</a></li>
<li><a href="https://github.com/BoringCat/minieap-openwrt">ã€GitHubã€‘minieap-openwrt</a></li>
<li><a href="https://github.com/BoringCat/luci-app-minieap">ã€GitHubã€‘OpenWrt/LEDE LuCI for minieap</a></li>
<li><a href="https://openwrt.org/docs/guide-user/firewall/firewall_configuration#rules">ã€OpenWrtã€‘firewall rules</a></li>
<li><a href="https://openwrt.org/zh-cn/doc/uci/firewall#%E4%B8%BE%E4%BE%8B">ã€OpenWrtã€‘é˜²ç«å¢™é…ç½®ä¸¾ä¾‹</a></li>
<li><a href="https://openwrt.org/docs/guide-user/network/ipv6/ipv6.nat6">ã€OpenWrtã€‘IPv6 NAT6 é…ç½®</a></li>
<li><a href="https://openwrt.org/docs/guide-user/network/ipv6/ipv6_extras#using_ipv6_by_default">ã€OpenWrtã€‘é»˜è®¤ä½¿ç”¨ IPv6</a></li>
<li><a href="https://openwrt.org/docs/guide-user/network/ipv6/ipv6_extras#announcing_default_ipv6_route">ã€OpenWrtã€‘é»˜è®¤ IPv6 è·¯ç”±</a></li>
<li><a href="https://openwrt.org/docs/guide-user/storage/usb-installing">ã€OpenWrtã€‘å®‰è£… USB é©±åŠ¨</a></li>
<li><a href="https://openwrt.org/docs/guide-user/storage/usb-drives">ã€OpenWrtã€‘ä½¿ç”¨ USB è®¾å¤‡</a></li>
<li><a href="https://openwrt.org/docs/guide-user/additional-software/extroot_configuration">ã€OpenWrtã€‘Extroot é…ç½®</a></li>
<li><a href="https://openwrt.org/docs/guide-user/services/nas/ftp.overview">ã€OpenWrtã€‘FTP</a></li>
<li><a href="https://openwrt.org/docs/guide-user/services/nas/samba">ã€OpenWrtã€‘Samba</a></li>
<li><a href="https://openwrt.org/docs/guide-user/services/downloading_and_filesharing/transmission">ã€OpenWrtã€‘transmission</a></li>
</ul>
]]></content>
      <categories>
        <category>è·¯ç”±å™¨</category>
      </categories>
      <tags>
        <tag>OpenWrt</tag>
        <tag>é”æ·</tag>
        <tag>IPv6</tag>
        <tag>NAS</tag>
      </tags>
  </entry>
</search>
